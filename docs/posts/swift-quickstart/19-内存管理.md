---
title: Swift å…¥é—¨ï¼ˆ19ï¼‰ï¼šå†…å­˜ç®¡ç†
date: 2025-09-14
categories: Swift
tags: [Swift, iOS, æ•™ç¨‹]
---

# Swift å…¥é—¨ï¼ˆ19ï¼‰ï¼šå†…å­˜ç®¡ç†

> Swift ä½¿ç”¨ **ARCï¼ˆAutomatic Reference Countingï¼‰** è‡ªåŠ¨ç®¡ç†å†…å­˜ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ä¸éœ€è¦æ‰‹åŠ¨é‡Šæ”¾å¯¹è±¡ã€‚ä½†ç†è§£å…¶å·¥ä½œåŸç†éå¸¸é‡è¦ï¼Œå°¤å…¶æ˜¯é¿å…å¾ªç¯å¼•ç”¨ã€‚

---

## 1. ARC çš„åŸºæœ¬åŸç†

- æ¯ä¸ªç±»å®ä¾‹éƒ½æœ‰ä¸€ä¸ª **å¼•ç”¨è®¡æ•°**ã€‚
- å½“å¼•ç”¨ +1 æ—¶ï¼Œå®ä¾‹ä¿ç•™ã€‚
- å½“å¼•ç”¨å˜ä¸º 0 æ—¶ï¼Œå®ä¾‹è¢«é”€æ¯ã€‚

```swift
class Person {
    let name: String
    init(name: String) { self.name = name }
    deinit { print("\(name) è¢«é”€æ¯") }
}

var p1: Person? = Person(name: "Tom")
p1 = nil // å¼•ç”¨è®¡æ•°å½’é›¶ï¼Œè§¦å‘ deinit
```

---

## 2. å¼ºå¼•ç”¨ï¼ˆStrong Referenceï¼‰

é»˜è®¤æƒ…å†µä¸‹ï¼Œå˜é‡ä¿å­˜å¯¹è±¡æ—¶ä¼šåˆ›å»ºä¸€ä¸ª **å¼ºå¼•ç”¨**ã€‚

```swift
class Dog {}
var d1: Dog? = Dog()
var d2 = d1 // d1, d2 éƒ½æ˜¯å¼ºå¼•ç”¨
```

---

## 3. å¾ªç¯å¼•ç”¨é—®é¢˜

å¦‚æœä¸¤ä¸ªå¯¹è±¡ç›¸äº’æŒæœ‰å¼ºå¼•ç”¨ï¼Œä¼šå¯¼è‡´ **å¾ªç¯å¼•ç”¨**ï¼Œå¯¹è±¡æ— æ³•é‡Šæ”¾ã€‚

```swift
class Teacher {
    var student: Student?
    deinit { print("Teacher deinit") }
}

class Student {
    var teacher: Teacher?
    deinit { print("Student deinit") }
}

var t: Teacher? = Teacher()
var s: Student? = Student()

t?.student = s
s?.teacher = t

t = nil
s = nil
// âŒ Teacher å’Œ Student éƒ½ä¸ä¼šé‡Šæ”¾
```

---

## 4. è§£å†³å¾ªç¯å¼•ç”¨

### 4.1 å¼±å¼•ç”¨ï¼ˆweakï¼‰

- ç”¨ `weak` ä¿®é¥°ï¼Œå¼•ç”¨ä¸ä¼šå¢åŠ è®¡æ•°ã€‚
- å¸¸ç”¨äº **å¯é€‰ç±»å‹**ï¼Œå¼•ç”¨å¯¹è±¡é”€æ¯åä¼šè‡ªåŠ¨è®¾ä¸º `nil`ã€‚

```swift
class Teacher {
    var student: Student?
    deinit { print("Teacher deinit") }
}

class Student {
    weak var teacher: Teacher? // ğŸ”‘ è§£å†³å¾ªç¯å¼•ç”¨
    deinit { print("Student deinit") }
}
```

---

### 4.2 æ— ä¸»å¼•ç”¨ï¼ˆunownedï¼‰

- ç”¨ `unowned` ä¿®é¥°ï¼Œä¸ä¼šå¢åŠ è®¡æ•°ã€‚
- **ä¸ä¼šè‡ªåŠ¨ç½® nil**ï¼Œé€‚åˆç”Ÿå‘½å‘¨æœŸä¸€è‡´çš„å¯¹è±¡ã€‚

```swift
class CreditCard {
    unowned let customer: Customer // æ°¸è¿œå­˜åœ¨
    init(customer: Customer) { self.customer = customer }
    deinit { print("Card deinit") }
}

class Customer {
    var card: CreditCard?
    deinit { print("Customer deinit") }
}

var c: Customer? = Customer()
c?.card = CreditCard(customer: c!)
c = nil // ä¸¤ä¸ªå¯¹è±¡éƒ½é‡Šæ”¾
```

---

## 5. é—­åŒ…æ•è·åˆ—è¡¨

é—­åŒ…ä¹Ÿå¯èƒ½å¯¼è‡´å¾ªç¯å¼•ç”¨ï¼Œéœ€è¦ç”¨ `[weak self]` æˆ– `[unowned self]`ã€‚

```swift
class ViewController {
    var name = "VC"
    var callback: (() -> Void)?

    func setup() {
        callback = { [weak self] in
            print(self?.name ?? "nil")
        }
    }

    deinit { print("VC deinit") }
}
```

---

## æ€»ç»“

- Swift ä½¿ç”¨ ARC è‡ªåŠ¨ç®¡ç†å†…å­˜ã€‚
- å¾ªç¯å¼•ç”¨æ˜¯ä¸»è¦é—®é¢˜ï¼Œéœ€è¦ `weak` æˆ– `unowned` è§£å†³ã€‚
- é—­åŒ…ä¸­æ•è· `self` æ—¶ï¼Œæ³¨æ„ä½¿ç”¨æ•è·åˆ—è¡¨ã€‚
