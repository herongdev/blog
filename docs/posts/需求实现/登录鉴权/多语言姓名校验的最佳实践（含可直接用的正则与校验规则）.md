---

title: å¤šè¯­è¨€å§“åæ ¡éªŒçš„æœ€ä½³å®è·µï¼ˆå«å¯ç›´æ¥ç”¨çš„æ­£åˆ™ä¸æ ¡éªŒè§„åˆ™ï¼‰
date: 2025-09-22
tags: \[i18n, è¡¨å•æ ¡éªŒ, æ­£åˆ™, å‰ç«¯, Ant Design Vue, Vue3]
-------------------------------------------------

## æ€»ç»“ç‰ˆï¼ˆå…ˆç»™ç»“è®ºï¼‰

- **ä¸è¦è¿‡åº¦æ”¶ç´§**ï¼šå…¨çƒå§“åå½¢æ€å¤šæ ·ï¼Œ**ç™½åå•è¿‡çª„**ä¼šä¼¤å®³ç”¨æˆ·ä½“éªŒã€‚
- **æ¨èåšæ³•**ï¼š**æœ€å°å¿…éœ€é™åˆ¶** + **é•¿åº¦ä¸å†…å®¹æ£€æŸ¥** + **è§„èŒƒåŒ–å¤„ç†** + **äººç±»å¯è¯»åé¦ˆ**ã€‚
- **å…è®¸å­—ç¬¦é›†åˆ**ï¼ˆæ¨èï¼‰ï¼š`Unicode å­—æ¯(\p{L}) + ç»„åˆéŸ³æ ‡(\p{M}) + ç©ºæ ¼ + è¿å­—ç¬¦(-) + æ’‡å·(' ä¸ â€™) + ç‚¹å·(.) + åœ†æ‹¬å·( )`ã€‚
- **ç¦æ­¢**ï¼šæ•°å­—ã€ä¸‹åˆ’çº¿ã€@/#ã€è¡¨æƒ…ç¬¦å·ã€æ§åˆ¶/ä¸å¯è§å­—ç¬¦ï¼ˆå¦‚é›¶å®½å­—ç¬¦ï¼‰ã€å¤šç©ºæ ¼/å¤šæ ‡ç‚¹è¿å†™ã€é¦–å°¾æ ‡ç‚¹/ç©ºæ ¼ã€‚
- **é•¿åº¦å»ºè®®**ï¼š`1 ~ 70` ä¸ª**å­—ç´ ï¼ˆgraphemeï¼‰**ï¼Œä¿è¯åƒâ€œğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦â€ç­‰ä¸ä¼šæ··å…¥ï¼›ä½†å¯¹æçŸ­åå­—ï¼ˆå¦‚â€œå†¯â€â€œÃ–â€ï¼‰è¦å…è®¸ã€‚
- **å­˜å‚¨**ï¼šä¿ç•™åŸå§‹è¾“å…¥ï¼ˆå®¡è®¡/å›æ˜¾ï¼‰ï¼ŒåŒæ—¶ä¿å­˜**è§„èŒƒåŒ–å‰¯æœ¬**ç”¨äºæ£€ç´¢/å»é‡ã€‚
- **å¯é€‰**ï¼šåç«¯åš**è„šæœ¬æ··ç”¨æ£€æµ‹**ï¼ˆé˜²é’“é±¼ï¼Œå¦‚æ‹‰ä¸ + è¥¿é‡Œå°”æ··ç”¨ï¼‰ï¼Œå¹¶è®°å½•**è¯­è¨€è„šæœ¬**ä»¥ä¾›é£æ§å‚è€ƒã€‚

---

## è®¾è®¡åŸåˆ™

1. **å›½é™…åŒ–å‹å¥½**ï¼šå§“åå¹¶éä»…â€œå­—æ¯+ç©ºæ ¼â€ï¼Œè¿˜ä¼šåŒ…å«**é‡éŸ³ç¬¦å·ã€è¿å­—ç¬¦ã€æ’‡å·ã€å¤å§“ã€æ‹¬æ³¨**ï¼ˆå¦‚ `(Jr.)`ï¼‰ã€‚
2. **å¯è®¿é—®æ€§**ï¼šå…è®¸ç”¨æˆ·ç²˜è´´å†…å®¹ï¼Œä½†**æ¸…ç†ä¸å¯è§å­—ç¬¦**ä¸å¤šä½™ç©ºç™½ã€‚
3. **å¯è§£é‡Šé”™è¯¯**ï¼šé”™è¯¯æç¤ºæ˜ç¡®æŒ‡å‡º**å…è®¸çš„å­—ç¬¦ä¸ä¿®å¤å»ºè®®**ã€‚
4. **å®‰å…¨æ€§**ï¼šé˜»æ–­æ§åˆ¶å­—ç¬¦ã€Emojiã€è„šæœ¬æ··æ·†ä¸é’“é±¼å­—ç¬¦ï¼ˆä¾‹å¦‚æ··å…¥ç›¸ä¼¼å½¢å­—æ¯ï¼‰ã€‚

---

## æ¨èçš„ä¸¤æ¡£æ ¡éªŒç­–ç•¥

### A æ¡£ï¼ˆä¸šåŠ¡æœ€å¸¸ç”¨ï¼Œå…¼é¡¾å®½å®¹ä¸å®‰å…¨ï¼‰

> é€‚ç”¨äºå¤§å¤šæ•°é¢å‘å…¬ä¼—çš„æ³¨å†Œ/èµ„æ–™ç¼–è¾‘è¡¨å•

**æ ¡éªŒç›®æ ‡**

- å…è®¸ï¼š`\p{L}` å­—æ¯ã€`\p{M}` ç»„åˆéŸ³æ ‡ã€ç©ºæ ¼ã€`- . ' â€™ ( )`
- ç¦æ­¢ï¼šæ•°å­—ã€ç¬¦å·ç±»ï¼ˆé™¤ä¸Šè¿°ï¼‰ã€æ§åˆ¶/ä¸å¯è§å­—ç¬¦ã€Emojiã€è¡Œåˆ†éš”ç¬¦ã€æ®µè½åˆ†éš”ç¬¦
- è§„åˆ™ï¼šä¸èƒ½**ä»¥ç©ºæ ¼/æ ‡ç‚¹å¼€å¤´æˆ–ç»“å°¾**ï¼›**ä¸­é—´ä¸å…è®¸è¿ç»­æ ‡ç‚¹/ç©ºæ ¼**ï¼›å¿…é¡»**è‡³å°‘åŒ…å«ä¸€ä¸ªå­—æ¯**

**æ­£åˆ™ï¼ˆæ•´ä¸²åŒ¹é…ï¼‰**

```ts
// å¤æ‚é€»è¾‘ï¼šå¤šè¯­è¨€å§“åâ€œæ¨èç‰ˆâ€æ­£åˆ™ï¼ˆæ•´ä¸²åŒ¹é…ï¼‰
const NAME_REGEX =
  /^(?=.{1,70}$)(?=.*\p{L})(?!.*\p{C})(?!.*[\p{Zl}\p{Zp}])(?![ .'â€™()\-.])(?!.*[ .'â€™()\-.]{2})[\p{L}\p{M} .'â€™()\-.]+(?<![ .'â€™()\-.])$/u;
```

**è¯´æ˜ï¼ˆç®€è¦ï¼‰**

- `(?=.{1,70}$)`ï¼šé•¿åº¦ 1\~70ï¼ˆä»¥**ä»£ç ç‚¹**ä¸ºç²’åº¦ï¼›å¦‚éœ€æ›´ä¸¥è°¨ç”¨â€œå­—ç´ æ®µâ€è®¡æ•°ï¼Œè§åæ–‡ï¼‰
- `(?=.*\p{L})`ï¼šè‡³å°‘å‡ºç°ä¸€ä¸ªå­—æ¯
- `(?!.*\p{C})`ï¼šæ‹’ç»æ§åˆ¶/ä¸å¯è§å­—ç¬¦ï¼ˆå«é›¶å®½å­—ç¬¦ã€BOM ç­‰ï¼‰
- `(?!.*[\p{Zl}\p{Zp}])`ï¼šæ‹’ç»è¡Œ/æ®µè½åˆ†éš”ç¬¦
- ç¦æ­¢é¦–å°¾æ ‡ç‚¹/ç©ºæ ¼ & ç¦æ­¢è¿ç»­æ ‡ç‚¹/ç©ºæ ¼
- å…è®¸é›†åˆï¼š`[\p{L}\p{M} .'â€™()\-.]`

> å¦‚æœä½ è¦**ä¸¥æ ¼åªå…è®¸æ™®é€šç©ºæ ¼ï¼ˆU+0020ï¼‰**ï¼Œè€Œä¸æ¥å—å…¶å®ƒç©ºç™½ï¼ˆä¸å« Tabã€å…¨è§’ç©ºæ ¼ç­‰ï¼‰ï¼Œå°†ä¸Šå¼ä¸­çš„ç©ºæ ¼ä¿ç•™ä¸ºå­—é¢ç©ºæ ¼å³å¯ï¼ˆä¸è¦ç”¨ `\s` æˆ– `\p{Zs}`ï¼‰ã€‚

### B æ¡£ï¼ˆæ›´å®½æ¾ï¼Œç”¨äºâ€œå¯¼å…¥/å½•å…¥â€åœºæ™¯ï¼Œä¹‹åäººå·¥å¤æ ¸ï¼‰

> é€‚åˆå†…éƒ¨å·¥å…·ã€æ‰¹é‡å¯¼å…¥ã€å†å²æ•°æ®è¿ç§»ç­‰ï¼Œå°½é‡**ä¸æ‹¦æˆª**ï¼Œä¸»è¦åšæ¸…æ´—

- æ”¾å®½é¦–å°¾ä¸è¿ç»­æ ‡ç‚¹é™åˆ¶ï¼Œä½†ä»**ç¦æ­¢ \p{C} æ§åˆ¶å­—ç¬¦ã€Emojiã€æ•°å­—**ç­‰æ˜æ˜¾å¼‚å¸¸ã€‚
- è¡¨å•ä¸æ‹¦æˆªï¼Œ**ä¿å­˜åæ‰«æ**å¹¶ç»™å‡ºâ€œå¾…äººå·¥ç¡®è®¤â€çš„æ ‡è®°ã€‚

---

## è¿›é˜¶ï¼šå­—ç´ é•¿åº¦ä¸è§„èŒƒåŒ–å»ºè®®

### 1) ä½¿ç”¨ `Intl.Segmenter` åš\*\*å­—ç´ ï¼ˆgraphemeï¼‰\*\*é•¿åº¦é™åˆ¶

```ts
// å¤æ‚é€»è¾‘ï¼šä»¥â€œå­—ç´ â€ç²’åº¦é™åˆ¶é•¿åº¦ï¼Œå¤„ç†ç»„åˆéŸ³æ ‡/åˆå­—æ›´å‡†ç¡®
function graphemeLength(str: string) {
  const seg = new Intl.Segmenter(undefined, { granularity: "grapheme" });
  let n = 0;
  for (const _ of seg.segment(str)) n++;
  return n;
}
function withinNameLength(str: string, min = 1, max = 70) {
  const len = graphemeLength(str);
  return len >= min && len <= max;
}
```

### 2) ç»Ÿä¸€**è§„èŒƒåŒ–**ï¼ˆå»ºè®® NFKCï¼‰+ æ¸…ç†

```ts
// å¤æ‚é€»è¾‘ï¼šè§„èŒƒåŒ– + æ¸…ç†ï¼ˆå­˜å‚¨å‰/æ¯”å¯¹å‰ï¼‰
// - ç»Ÿä¸€å…¨è§’/åŠè§’å½¢æ€ï¼ˆNFKCï¼‰
// - ç»Ÿä¸€æ’‡å·ä¸º ASCII '
// - åˆå¹¶è¿ç»­ç©ºæ ¼/æ ‡ç‚¹ä¸ºå•ä¸ª
// - å»æ‰é¦–å°¾ç©ºæ ¼/æ ‡ç‚¹
function normalizeName(raw: string) {
  let s = raw.normalize("NFKC");
  s = s.replace(/[â€™Ê»ËˆÊ¹`Â´]/g, "'"); // å„å¼æ’‡å·ç»Ÿä¸€ä¸º '
  s = s.replace(/\s+/g, " "); // å¤šç©ºæ ¼åˆå¹¶
  s = s.replace(/[ .\-']{2,}/g, (m) => m[0]); // è¿ç»­æ ‡ç‚¹å‹ç¼©ä¸º 1 ä¸ª
  s = s.replace(/^[ .\-']+|[ .\-']+$/g, ""); // å»é¦–å°¾æ ‡ç‚¹/ç©ºæ ¼
  // ç§»é™¤æ§åˆ¶/ä¸å¯è§å­—ç¬¦ï¼ˆå«é›¶å®½ï¼‰
  s = s.replace(/\p{C}/gu, "");
  return s;
}
```

> **å­˜å‚¨ç­–ç•¥**ï¼š**åŸæ–‡**ä¸**è§„èŒƒåŒ–ç»“æœ**éƒ½å­˜ï¼š
>
> - `name_raw`ï¼šåŸå§‹è¾“å…¥ï¼ˆå¯å›æ˜¾ã€å®¡è®¡ï¼‰
> - `name_norm`ï¼šè§„èŒƒåŒ–å‰¯æœ¬ï¼ˆæœç´¢/å”¯ä¸€æ€§åˆ¤æ–­/æ’åºï¼‰
>
>   - å”¯ä¸€æ€§ç”¨ `name_norm` + å›½å®¶/åœ°åŒº/ç”Ÿæ—¥ç­‰ç»„åˆæ›´é è°±ã€‚

---

## ä¸ Ant Design Vue çš„é›†æˆï¼ˆä»…æä¾›å¿…è¦ç‰‡æ®µï¼‰

### ç‰‡æ®µä¸€ï¼šæ–°å¢å·¥å…·å‡½æ•°ä¸æ­£åˆ™

```ts
// å¤æ‚é€»è¾‘ï¼šå§“åæ¨èæ­£åˆ™ï¼ˆAæ¡£ï¼‰
const NAME_REGEX =
  /^(?=.{1,70}$)(?=.*\p{L})(?!.*\p{C})(?!.*[\p{Zl}\p{Zp}])(?![ .'â€™()\-.])(?!.*[ .'â€™()\-.]{2})[\p{L}\p{M} .'â€™()\-.]+(?<![ .'â€™()\-.])$/u;

// å¤æ‚é€»è¾‘ï¼šè§„èŒƒåŒ–å·¥å…·
function normalizeName(raw: string) {
  let s = raw.normalize("NFKC");
  s = s
    .replace(/[â€™Ê»ËˆÊ¹`Â´]/g, "'")
    .replace(/\s+/g, " ")
    .replace(/[ .\-']{2,}/g, (m) => m[0])
    .replace(/^[ .\-']+|[ .\-']+$/g, "")
    .replace(/\p{C}/gu, "");
  return s;
}
```

### ç‰‡æ®µäºŒï¼šåœ¨æäº¤å‰åšè§„èŒƒåŒ–ï¼ˆä¸æ”¹å˜ä½ çš„å…¶å®ƒé€»è¾‘ï¼‰

```ts
// å¤æ‚é€»è¾‘ï¼šæäº¤å‰å¯¹å§“/åè¿›è¡Œè§„èŒƒåŒ–ï¼ˆä¸ªäººè´¦æˆ·ï¼‰
async function handleRegister() {
  try {
    if (!formData.agreed) {
      message.error(t("user.register.form.agree-terms"));
      return;
    }
    if (isPersonal.value) {
      formData.lastname = normalizeName(formData.lastname);
      formData.firstname = normalizeName(formData.firstname);
    }
    await userStore.register(buildPayload());
    message.success(t("user.register.form.register-success"));
    if (router.currentRoute.value?.query?.redirect) {
      router.push(
        decodeURIComponent(router.currentRoute.value.query.redirect as string)
      );
    } else {
      router.push("/");
    }
  } catch (err) {}
}
```

### ç‰‡æ®µä¸‰ï¼šä¸ºå§“/åè¿½åŠ  pattern è§„åˆ™ï¼ˆä½ çš„ `computedRules` ä¸ªäººåˆ†æ”¯å†…ï¼‰

```ts
// å¤æ‚é€»è¾‘ï¼šå§“/åä»…å…è®¸å¤šè¯­è¨€å­—æ¯ + ç©ºæ ¼/().-'
lastname: [
  req(t('user.register.form.lastname-required')),
  { pattern: NAME_REGEX, message: 'å§“ï¼šä»…å…è®¸å­—æ¯ä¸ ç©ºæ ¼ ( ) . - \'ï¼Œä¸”ä¸å¾—ä»¥æ ‡ç‚¹å¼€å¤´/ç»“å°¾', trigger: 'blur' },
],
firstname: [
  req(t('user.register.form.firstname-required')),
  { pattern: NAME_REGEX, message: 'åï¼šä»…å…è®¸å­—æ¯ä¸ ç©ºæ ¼ ( ) . - \'ï¼Œä¸”ä¸å¾—ä»¥æ ‡ç‚¹å¼€å¤´/ç»“å°¾', trigger: 'blur' },
],
```

---

## å¸¸è§é™·é˜±ä¸åº”å¯¹

- **Emoji/ç¬¦å·æ··å…¥**ï¼šç”¨æˆ·å¤åˆ¶æ¥æºä¸æ´ï¼›ç”¨ `\p{C}` æ’é™¤æ§åˆ¶å­—ç¬¦ï¼Œ**å¦å¤–**é€šè¿‡å…è®¸é›†åˆä»æºå¤´æ’é™¤ `\p{S}` ç¬¦å·ç±»ã€‚
- **è„šæœ¬æ··æ·†**ï¼š`Ğ°`(è¥¿é‡Œå°”) ä¸ `a`(æ‹‰ä¸) æ··ç”¨æ˜“é’“é±¼ï¼›é‡è¦ä¸šåŠ¡å¯åœ¨åç«¯åš**è„šæœ¬ä¸€è‡´æ€§æ£€æŸ¥**ï¼ˆå¦‚â€œä¸»è¦è„šæœ¬æ¯”ä¾‹ â‰¥ 80%â€ï¼‰ã€‚
- **é›¶å®½å­—ç¬¦**ï¼šZWJ/ZWNJ å¸¸ç”¨äºå°åº¦æ–‡å­—æ’ç‰ˆï¼Œä½†å§“åä¸­**é€šå¸¸ä¸è¦æ±‚**ï¼›è‹¥ç¡®æœ‰éœ€æ±‚ï¼Œæ”¾è¡Œç‰¹å®šèŒƒå›´å¹¶è®°å½•é£æ§ã€‚
- **æçŸ­/æé•¿**ï¼šå…è®¸ä¸€å­—åï¼›ä¸Šé™ä¸å®œå¤ªçŸ­ï¼ˆå»ºè®® 70 å­—ç´ ï¼‰ã€‚
- **å¤§å°å†™/é‡éŸ³**ï¼š**æ˜¾ç¤º**ä¿æŒç”¨æˆ·æ„å›¾ï¼›**æ£€ç´¢**ç”¨è§„èŒƒåŒ–ï¼ˆNFKC + å»é‡éŸ³å¯é€‰ï¼Œè§†éœ€æ±‚ï¼‰ã€‚

---

## ä½•æ—¶æ”¾å®½ä¸ä½•æ—¶ä»ä¸¥

- **æ³¨å†Œ/èµ„æ–™ç¼–è¾‘ï¼ˆé¢å‘ C ç«¯ï¼‰**ï¼šç”¨ **A æ¡£**ã€‚
- **æ‰¹é‡å¯¼å…¥/å†å²è¿ç§»**ï¼šç”¨ **B æ¡£**ï¼Œä¹‹åäººå·¥å¤æ ¸ã€‚
- **é«˜é£é™©åœºæ™¯ï¼ˆKYC/åˆè§„ï¼‰**ï¼šåœ¨ A æ¡£åŸºç¡€ä¸Šå¢åŠ **è„šæœ¬ä¸€è‡´æ€§**ã€**è„è¯/è¾±éª‚**ç­›æŸ¥ã€ä¸è¯ä»¶ OCR çš„**æ¨¡ç³Šæ¯”å¯¹**ã€‚

---

## å¯æ›¿ä»£ä¸å¢å¼º

- **åº“æ”¯æŒ**ï¼šè‹¥å¯ç”¨ ICU/Unorm ç­‰åç«¯åº“ï¼Œä¼˜å…ˆåœ¨åç«¯å®ç°ç»Ÿä¸€è§„èŒƒåŒ–ä¸è„šæœ¬æ£€æµ‹ã€‚
- **å¤šè¯­è¨€æç¤º**ï¼šæŒ‰ç•Œé¢è¯­è¨€æ˜¾ç¤ºæœ¬åœ°åŒ–é”™è¯¯ä¿¡æ¯ï¼›é”™è¯¯æ–‡æ¡ˆå†™æ¸…â€œå…è®¸çš„å­—ç¬¦é›†åˆâ€ã€‚
- **å¯è§†åŒ–çº é”™**ï¼šè¾“å…¥æ—¶**å³æ—¶è½»æç¤º**å¹¶ç»™å‡ºâ€œè‡ªåŠ¨ä¿®å¤ï¼ˆè§„èŒƒåŒ–ï¼‰â€çš„é¢„è§ˆã€‚

---

## ç»“è¯­

å§“åæ˜¯**æ–‡åŒ–ä¸ä¹¦å†™ç³»ç»Ÿçš„äº¤æ±‡ç‚¹**ã€‚æœ€ä½³å®è·µçš„å…³é”®ä¸åœ¨â€œæœ€ä¸¥çš„æ­£åˆ™â€ï¼Œè€Œåœ¨**åˆç†çš„å…è®¸é›†åˆ + è§„èŒƒåŒ– + å‹å¥½æç¤º + é£æ§å…œåº•**ã€‚ä¸Šé¢çš„ **A æ¡£è§„åˆ™**èƒ½åœ¨å…¨çƒåŒ–ä¸å®‰å…¨ä¹‹é—´å–å¾—è‰¯å¥½å¹³è¡¡ï¼Œå»ºè®®ä½œä¸ºä½ çš„é»˜è®¤å®ç°ã€‚

---

title: æ³¨å†Œç»„ä»¶ï¼ˆå·²æ”¯æŒå§“åä¸­ç‚¹â€œÂ·â€ä¸å…¬å¸åç¬¦å· & / ,ï¼‰
date: 2025-09-22
tags: \[Vue3, Ant Design Vue, è¡¨å•æ ¡éªŒ, i18n]

---

> å·²æŒ‰ä½ çš„è¦æ±‚ï¼š**å§“åå…è®¸ä¸­ç‚¹â€œÂ·â€**ï¼›**å…¬å¸åå¢åŠ å•ç‹¬è§„åˆ™**ï¼ˆæ”¾è¡Œ `& / ,` ç­‰ï¼‰ï¼Œå¹¶åœ¨æäº¤å‰åšå¯¹åº”è§„èŒƒåŒ–ã€‚

```vue
<template>
  <!-- æ¡Œé¢ç«¯ -->
  <div
    v-if="!isMobile"
    class="w-full h-full mx-[40px] lg:mx-0 rounded-[14px] p-10 flex flex-col gap-4 glass gradient-border user-auth overflow-y-auto scrollbar-none"
  >
    <slot name="header" />
    <HTabsHeader v-model:activeKey="activeKey" :items="items" />
    <a-form
      :model="formData"
      :rules="computedRules"
      :required-mark="false"
      layout="vertical"
      class="w-full overflow-y-auto scrollbar-none"
      style="margin: 24px 0"
    >
      <template v-if="isPersonal">
        <a-form-item
          :label="t('user.register.form.firstname')"
          name="firstname"
          required
        >
          <a-input class="form-control" v-model:value="formData.firstname" />
        </a-form-item>
        <a-form-item
          :label="t('user.register.form.lastname')"
          name="lastname"
          required
        >
          <a-input class="form-control" v-model:value="formData.lastname" />
        </a-form-item>
      </template>
      <template v-else>
        <a-form-item
          :label="t('user.register.form.company-name')"
          name="company_name"
          required
        >
          <a-input class="form-control" v-model:value="formData.company_name" />
        </a-form-item>
      </template>

      <a-form-item
        :label="
          isPersonal
            ? t('user.register.form.country-personal')
            : t('user.register.form.country-corporate')
        "
        name="country"
        required
      >
        <CountrySelector
          class="register-country-selector"
          size="xl"
          container-class="border border-[#1f2b49] hover:border-[#b68756]"
          v-model:countryEnName="formData.country"
          toggle-class="text-[#ddd]"
        />
      </a-form-item>

      <a-form-item :label="t('user.register.form.phone')" name="phone">
        <HPhoneInput
          wrap-class="w-full h-[48px] rounded-[10px] border border-[#1F2B49] px-3 py-[13px] hover:border-[#B68756]"
          toggle-class="text-[#DDD]"
          input-class="text-[#ddd]"
          size="xl"
          v-model="formData.phone"
          v-model:phoneCode="formData.area"
          :button-text="t('user.register.form.send-verification-code')"
        />
      </a-form-item>

      <a-form-item :label="t('user.register.form.email')" name="email" required>
        <a-input
          class="form-control"
          autocomplete="register-email"
          type="email"
          v-model:value="formData.email"
        />
      </a-form-item>

      <a-form-item
        :label="t('user.register.form.email-verification-code')"
        name="code"
        required
      >
        <MVerifyCodeInput
          v-model:value="formData.code"
          :verify-setting="customVerifyType"
          input-class="!text-[#ddd]"
        />
      </a-form-item>

      <a-form-item
        :label="t('user.register.form.password')"
        name="password"
        required
      >
        <MPasswordInput v-model:value="formData.password" />
      </a-form-item>

      <a-form-item
        v-if="!props.hideInviteCode"
        :label="t('user.register.form.invitation-code')"
        name="invitation_code"
      >
        <a-input
          class="form-control"
          v-model:value="formData.invitation_code"
        />
      </a-form-item>
      <a-form-item>
        <div class="mb-6 flex items-start gap-2">
          <input
            class="mt-1"
            type="checkbox"
            id="agreement"
            v-model="formData.agreed"
          />
          <i18n-t
            keypath="user.register.form.disclaimer"
            tag="p"
            class="text-[12px] leading-[20px] font-normal text-[#ddd]"
          >
            <RouterLink to="/agreements/customer" class="text-primary-500">
              {{ t("user.register.form.customer-agreement") }}
            </RouterLink>
          </i18n-t>
        </div>
      </a-form-item>
    </a-form>

    <a-button type="primary" size="large" block @click="handleRegister">
      {{ t("user.register.form.submit") }}
    </a-button>

    <div class="flex items-center justify-center mt-6 ink-14 font-normal">
      <span
        class="text-primary-500 cursor-pointer"
        @click="$emit('switch-to-login')"
      >
        {{ t("user.register.form.go-to-login") }}
      </span>
    </div>
  </div>
  <!-- ç§»åŠ¨ç«¯ -->
  <div
    v-else
    class="flex flex-col gap-4 w-full h-full p-10 glass user-auth overflow-y-auto hide-scrollbar"
  >
    <slot name="header" />
    <HTabsHeader v-model:activeKey="activeKey" :items="items" />
    <a-form
      :model="formData"
      :rules="computedRules"
      :required-mark="false"
      layout="vertical"
      class="w-full overflow-y-auto scrollbar-none"
      style="margin: 24px 0"
    >
      <template v-if="isPersonal">
        <a-form-item
          :label="t('user.register.form.lastname')"
          name="lastname"
          required
        >
          <a-input class="form-control" v-model:value="formData.lastname" />
        </a-form-item>
        <a-form-item
          :label="t('user.register.form.firstname')"
          name="firstname"
          required
        >
          <a-input class="form-control" v-model:value="formData.firstname" />
        </a-form-item>
      </template>
      <template v-else>
        <a-form-item
          :label="t('user.register.form.company-name')"
          name="company_name"
          required
        >
          <a-input class="form-control" v-model:value="formData.company_name" />
        </a-form-item>
      </template>

      <a-form-item
        :label="
          isPersonal
            ? t('user.register.form.country-personal')
            : t('user.register.form.country-corporate')
        "
        name="country"
        required
      >
        <CountrySelector
          class="register-country-selector"
          container-class="border border-[#1f2b49] hover:border-[#b68756]"
          size="xl"
          v-model:countryEnName="formData.country"
          toggle-class="text-[#ddd]"
        />
      </a-form-item>

      <a-form-item :label="t('user.register.form.phone')" name="phone">
        <HPhoneInput
          wrap-class="w-full h-[48px] rounded-[10px] border border-[#1F2B49] px-3 py-[13px] hover:border-[#B68756]"
          toggle-class="text-[#DDD]"
          input-class="text-[#ddd]"
          size="xl"
          v-model="formData.phone"
          v-model:phoneCode="formData.area"
          :button-text="t('user.register.form.send-verification-code')"
        />
      </a-form-item>

      <a-form-item :label="t('user.register.form.email')" name="email" required>
        <a-input
          class="form-control"
          type="email"
          v-model:value="formData.email"
        />
      </a-form-item>

      <a-form-item
        v-if="isPersonal"
        :label="t('user.register.form.email-verification-code')"
        name="code"
        required
      >
        <MVerifyCodeInput
          v-model:value="formData.code"
          :verify-setting="customVerifyType"
          input-class="!text-[#ddd]"
        />
      </a-form-item>

      <a-form-item
        :label="t('user.register.form.password')"
        name="password"
        required
      >
        <MPasswordInput v-model:value="formData.password" />
      </a-form-item>

      <a-form-item
        v-if="!props.hideInviteCode"
        :label="t('user.register.form.invitation-code')"
        name="invitation_code"
      >
        <a-input
          class="form-control"
          v-model:value="formData.invitation_code"
        />
      </a-form-item>
      <a-form-item>
        <div class="mb-6 flex items-start gap-2">
          <input
            class="mt-1"
            type="checkbox"
            id="agreement"
            v-model="formData.agreed"
          />
          <i18n-t
            keypath="user.register.form.disclaimer"
            tag="p"
            class="text-[12px] leading-[20px] font-normal text-[#ddd]"
          >
            <RouterLink to="/agreements/customer" class="text-primary-500">
              {{ t("user.register.form.customer-agreement") }}
            </RouterLink>
          </i18n-t>
        </div>
      </a-form-item>
    </a-form>

    <a-button type="primary" size="large" block @click="handleRegister">
      {{ t("user.register.form.submit") }}
    </a-button>

    <div class="flex items-center justify-center mt-6 ink-14 font-normal">
      <span
        class="text-primary-500 cursor-pointer"
        @click="$emit('switch-to-login')"
      >
        {{ t("user.register.form.go-to-login") }}
      </span>
    </div>
  </div>
</template>

<script setup lang="ts">
import { reactive, ref, computed, watch } from "vue";
import { useWindowSize } from "@vueuse/core";
import type { Rule } from "ant-design-vue/es/form";
import { message } from "ant-design-vue";
import { useI18n } from "vue-i18n";
import { useUserStore } from "@/store";
import {
  HPhoneInput,
  HTabsHeader,
  MVerifyCodeInput,
  MPasswordInput,
  CountrySelector,
} from "@/components";
import { RouterLink, useRouter } from "vue-router";
import type {
  RegisterPayload,
  PersonalAccountRegisterPayload,
  CorporateAccountRegisterPayload,
} from "@/api/auth/dto";

const router = useRouter();
const { t } = useI18n();

// å¤æ‚é€»è¾‘ï¼šå§“åâ€œæ¨èç‰ˆâ€æ­£åˆ™ï¼ˆæ”¾è¡Œä¸­ç‚¹ U+00B7ï¼‰
const NAME_REGEX =
  /^(?=.{1,70}$)(?=.*\p{L})(?!.*\p{C})(?!.*[\p{Zl}\p{Zp}])(?![ .'â€™()\-.Â·])(?!.*[ .'â€™()\-.Â·]{2})[\p{L}\p{M} .'â€™()\-.Â·]+(?<![ .'â€™()\-.Â·])$/u;

// å¤æ‚é€»è¾‘ï¼šå…¬å¸åæ­£åˆ™ï¼ˆæ›´å®½ï¼šæ”¾è¡Œ & / ,ï¼Œå¯å«æ•°å­—ï¼›é™åˆ¶é¦–å°¾ä¸è¿ç»­æ ‡ç‚¹ï¼‰
const COMPANY_NAME_REGEX =
  /^(?=.{1,120}$)(?!.*\p{C})(?!.*[\p{Zl}\p{Zp}])(?![ .,'â€™()\/&\-Â·])(?!.*[ .,'â€™()\/&\-Â·]{2})[\p{L}\p{M}\p{N} .,'â€™()\/&\-Â·]+(?<![ .,'â€™()\/&\-Â·])$/u;

// å¤æ‚é€»è¾‘ï¼šå°†å§“ååš NFKC è§„èŒƒåŒ– + æ¸…ç†ï¼ˆå«å…¨è§’â†’åŠè§’ã€å‹ç¼©ç©ºæ ¼/æ ‡ç‚¹ã€ç§»é™¤æ§åˆ¶ç¬¦ï¼‰
function normalizeName(raw: string) {
  let s = (raw ?? "").normalize("NFKC");
  // ç»Ÿä¸€æ’‡å·ä¸ç©ºæ ¼å½¢æ€
  s = s.replace(/[â€™Ê»ËˆÊ¹`Â´]/g, "'").replace(/\u3000/g, " ");
  // å¸¸è§â€œä¸­ç‚¹â€å˜ä½“ç»Ÿä¸€ä¸º U+00B7
  s = s.replace(/ãƒ»/g, "Â·");
  // å‹ç¼©ç©ºç™½ä¸æ ‡ç‚¹ã€å»é¦–å°¾
  s = s
    .replace(/\s+/g, " ")
    .replace(/[ .\-'\u00B7]{2,}/g, (m) => m[0])
    .replace(/^[ .\-'\u00B7]+|[ .\-'\u00B7]+$/g, "");
  // ç§»é™¤æ§åˆ¶/ä¸å¯è§å­—ç¬¦
  s = s.replace(/\p{C}/gu, "");
  return s;
}

// å¤æ‚é€»è¾‘ï¼šå…¬å¸åè§„èŒƒåŒ–ï¼ˆé¢å¤–ç»Ÿä¸€ä¸­è‹±æ ‡ç‚¹ &ï¼ï¼Œç­‰ä¸º ASCIIï¼‰
function normalizeCompanyName(raw: string) {
  let s = (raw ?? "").normalize("NFKC");
  s = s
    .replace(/\u3000/g, " ")
    .replace(/[â€™Ê»ËˆÊ¹`Â´]/g, "'")
    .replace(/ï¼Œ/g, ",")
    .replace(/ï¼/g, "/")
    .replace(/ï¼†/g, "&")
    .replace(/ï¼/g, ".")
    .replace(/ï¼/g, "-")
    .replace(/ï¼ˆ/g, "(")
    .replace(/ï¼‰/g, ")")
    .replace(/ãƒ»/g, "Â·");
  // å‹ç¼©ç©ºç™½ä¸æ ‡ç‚¹ï¼ˆå« & / , ä¸­ç‚¹ï¼‰
  s = s
    .replace(/\s+/g, " ")
    .replace(/[ .,'\/&\-\u00B7]{2,}/g, (m) => m[0])
    .replace(/^[ .,'\/&\-\u00B7]+|[ .,'\/&\-\u00B7]+$/g, "")
    .replace(/\p{C}/gu, "");
  return s;
}

// å¤æ‚é€»è¾‘ï¼šå§“/åè‡ªå®šä¹‰æ ¡éªŒ â€”â€” å…ˆè§„èŒƒåŒ–å†åˆ¤å®šï¼Œå¹¶å›å†™è¡¨å•å€¼
const nameValidator: Rule["validator"] = async (_rule, value) => {
  const normalized = normalizeName(value ?? "");
  if (!normalized) throw new Error(t("user.register.form.name-empty"));
  if (!NAME_REGEX.test(normalized))
    throw new Error(t("user.register.form.name-pattern"));
  return Promise.resolve();
};

// å¤æ‚é€»è¾‘ï¼šå…¬å¸åè‡ªå®šä¹‰æ ¡éªŒ â€”â€” å…è®¸ & / , ç­‰ï¼Œç¦æ­¢é¦–å°¾/è¿ç»­æ ‡ç‚¹
const companyNameValidator: Rule["validator"] = async (_rule, value) => {
  const normalized = normalizeCompanyName(value ?? "");
  if (!normalized)
    throw new Error(t("user.register.form.company-name-required"));
  if (!COMPANY_NAME_REGEX.test(normalized))
    throw new Error(t("user.register.form.company-name-pattern"));
  return Promise.resolve();
};

// æ£€æµ‹å±å¹•å°ºå¯¸ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºç§»åŠ¨ç«¯
const { width } = useWindowSize();
const isMobile = computed(() => width.value < 768);

// props: æ§åˆ¶é‚€è¯·ç æ˜¾ç¤ºä¸é¢„å¡«
const props = withDefaults(
  defineProps<{
    hideInviteCode?: boolean;
    presetInviteCode?: string | number | null;
    recommendPreset?: string | number | null;
    scopePreset?: string | number | null;
  }>(),
  { hideInviteCode: false, presetInviteCode: null }
);

// tabs
const items = ref([
  { key: "personalAccount", label: t("user.register.form.personal-account") },
  { key: "corporateAccount", label: t("user.register.form.corporate-account") },
]);
type ActiveKey = "personalAccount" | "corporateAccount";
const activeKey = ref<ActiveKey>("personalAccount");
const isPersonal = computed(() => activeKey.value === "personalAccount");

// form & rules
const formData = reactive({
  country: "",
  area: undefined as string | undefined,
  phone: "",
  email: "",
  password: "",
  confirmPassword: "",
  invitation_code: "",
  agreed: false,
  code: "",
  lastname: "",
  firstname: "",
  company_name: "",
});

// é¢„è®¾é‚€è¯·ç ï¼šæ”¯æŒç»„ä»¶å…ˆæ¸²æŸ“å props å˜åŒ–ã€‚ä»…åœ¨è¡¨å•å€¼ä¸ºç©ºæ—¶å†™å…¥ï¼Œé¿å…è¦†ç›–ç”¨æˆ·è¾“å…¥ã€‚
watch(
  () => props.presetInviteCode,
  (v) => {
    if (v != null && v !== "" && !formData.invitation_code) {
      formData.invitation_code = String(v);
    }
  },
  { immediate: true }
);

function req(msg: string): Rule {
  return { required: true, message: msg, trigger: "blur" };
}

const computedRules = computed<Record<string, Rule[]>>(() => {
  const base: Record<string, Rule[]> = {
    country: [req(t("user.register.form.select-country"))],
    email: [
      {
        type: "email",
        message: t("user.register.form.email-invalid"),
        trigger: "blur",
      },
    ],
    password: [req(t("user.register.form.password-required"))],
    confirmPassword: [req(t("user.register.form.confirm-password-required"))],
  };
  if (isPersonal.value) {
    return {
      ...base,
      // å¤æ‚é€»è¾‘ï¼šå§“/åä»…å…è®¸å­—æ¯ + ç©ºæ ¼ ( ) . - ' Â·ï¼Œç¦æ­¢é¦–å°¾/è¿ç»­æ ‡ç‚¹
      lastname: [
        req(t("user.register.form.lastname-required")),
        { validator: nameValidator, trigger: "blur" },
      ],
      firstname: [
        req(t("user.register.form.firstname-required")),
        { validator: nameValidator, trigger: "blur" },
      ],
      code: [req(t("user.register.form.code-required"))],
    };
  }
  return {
    ...base,
    // å¤æ‚é€»è¾‘ï¼šå…¬å¸åå…è®¸ & / , ç­‰ç¬¦å·ï¼Œç¦æ­¢é¦–å°¾/è¿ç»­æ ‡ç‚¹
    company_name: [
      req(t("user.register.form.company-name-required")),
      { validator: companyNameValidator, trigger: "blur" },
    ],
  };
});

const customVerifyType = computed(() => ({
  type: "email",
  settings: {
    apiUrl: "/api/pub/get_code",
    method: "POST" as const,
    params: {
      email: formData.email,
      type: "0" as const,
    },
  },
}));

// submit
const userStore = useUserStore();
function buildPayload():
  | PersonalAccountRegisterPayload
  | CorporateAccountRegisterPayload {
  const common: RegisterPayload = {
    code: formData.code,
    is_company: isPersonal.value ? 0 : 1,
    area: `+${formData.area}`,
    country: formData.country,
    email: formData.email,
    phone: `+${formData.area}${formData.phone}`,
    password: formData.password,
    invitation_code: formData.invitation_code
      ? Number(formData.invitation_code)
      : undefined,
    from_type: undefined,
  };
  if (props.recommendPreset) {
    (common as any).recommend = props.recommendPreset;
  }
  if (props.scopePreset) {
    (common as any).scope = props.scopePreset;
  }
  if (isPersonal.value) {
    return {
      ...common,
      lastname: formData.lastname,
      firstname: formData.firstname,
    };
  }
  return { ...common, company_name: formData.company_name };
}

async function handleRegister() {
  try {
    if (!formData.agreed) {
      message.error(t("user.register.form.agree-terms"));
      return;
    }
    if (isPersonal.value) {
      // å¤æ‚é€»è¾‘ï¼šæäº¤å‰äºŒæ¬¡è§„èŒƒåŒ–ï¼ˆä¸ blur æ—¶ä¸€è‡´ï¼‰
      formData.lastname = normalizeName(formData.lastname);
      formData.firstname = normalizeName(formData.firstname);
    } else {
      // å¤æ‚é€»è¾‘ï¼šä¼ä¸šè´¦å·æäº¤å‰è§„èŒƒåŒ–å…¬å¸å
      formData.company_name = normalizeCompanyName(formData.company_name);
    }
    await userStore.register(buildPayload());
    message.success(t("user.register.form.register-success"));
    if (router.currentRoute.value?.query?.redirect) {
      router.push(
        decodeURIComponent(router.currentRoute.value.query.redirect as string)
      );
    } else {
      router.push("/");
    }
  } catch (err) {}
}
</script>
```

**é¢å¤–æç¤ºï¼ˆi18n æ–‡æ¡ˆåˆ«å¿˜äº†è¡¥å……ï¼‰**ï¼š

- `user.register.form.name-pattern`ï¼š`ä»…å…è®¸å­—æ¯ä¸ ç©ºæ ¼ ( ) . - ' Â·ï¼Œä¸”ä¸å¾—ä»¥æ ‡ç‚¹å¼€å¤´/ç»“å°¾æˆ–è¿ç»­æ ‡ç‚¹/ç©ºæ ¼`
- `user.register.form.company-name-pattern`ï¼š`å…¬å¸åå¯å«å­—æ¯ã€æ•°å­—ä¸ ç©ºæ ¼ ( ) . - ' Â· ä»¥åŠ & / ,ï¼Œä¸å¾—ä»¥æ ‡ç‚¹å¼€å¤´/ç»“å°¾æˆ–è¿ç»­æ ‡ç‚¹/ç©ºæ ¼`
