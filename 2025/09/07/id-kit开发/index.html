<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>id-kit开发 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="一、插件命名 &amp; 目录结构插件名：uni-id-kit（简洁、易记、符合 uni 插件生态）  英文：UniIdKit 中文：一体设备 ID 工具包  目录（uni_modules 标准）： 12345678910111213141516171819uni_modules&#x2F;  uni-id-kit&#x2F;    package.json    module.json    utssdk&#x2F;">
<meta property="og:type" content="article">
<meta property="og:title" content="id-kit开发">
<meta property="og:url" content="https://herongdev.github.io/blog/2025/09/07/id-kit%E5%BC%80%E5%8F%91/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="一、插件命名 &amp; 目录结构插件名：uni-id-kit（简洁、易记、符合 uni 插件生态）  英文：UniIdKit 中文：一体设备 ID 工具包  目录（uni_modules 标准）： 12345678910111213141516171819uni_modules&#x2F;  uni-id-kit&#x2F;    package.json    module.json    utssdk&#x2F;">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-09-07T12:57:14.000Z">
<meta property="article:modified_time" content="2025-09-07T06:30:26.786Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://herongdev.github.io/blog"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-id-kit开发" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/07/id-kit%E5%BC%80%E5%8F%91/" class="article-date">
  <time class="dt-published" datetime="2025-09-07T12:57:14.000Z" itemprop="datePublished">2025-09-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      id-kit开发
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="一、插件命名-目录结构"><a href="#一、插件命名-目录结构" class="headerlink" title="一、插件命名 &amp; 目录结构"></a>一、插件命名 &amp; 目录结构</h1><p><strong>插件名</strong>：<code>uni-id-kit</code>（简洁、易记、符合 uni 插件生态）</p>
<ul>
<li>英文：<strong>UniIdKit</strong></li>
<li>中文：<strong>一体设备 ID 工具包</strong></li>
</ul>
<p><strong>目录（uni_modules 标准）</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">uni_modules/</span><br><span class="line">  uni-id-kit/</span><br><span class="line">    package.json</span><br><span class="line">    module.json</span><br><span class="line">    utssdk/</span><br><span class="line">      index.uts              # 聚合导出（按平台分发）</span><br><span class="line">      common/</span><br><span class="line">        types.uts            # 类型与常量定义（复用）</span><br><span class="line">        hash.uts             # SHA-256 工具（Web/Android 均可）</span><br><span class="line">        storage.uts          # 本地缓存工具（uni.storage封装）</span><br><span class="line">      web/</span><br><span class="line">        index.uts            # Web 实现（GUID、hash、缓存）</span><br><span class="line">      app-android/</span><br><span class="line">        index.uts            # Android 实现（AndroidID，OAID/AAID占位）</span><br><span class="line">        adapters/</span><br><span class="line">          android_id.uts     # ANDROID_ID</span><br><span class="line">          aaid.uts           # Google AAID（待接SDK）</span><br><span class="line">          oaid.uts           # MSA OAID  （待接SDK）</span><br><span class="line">          pseudo_id.uts      # 伪ID（可选）</span><br></pre></td></tr></table></figure>

<blockquote>
<p>iOS（IDFV）可稍后补：<code>app-ios/index.uts</code> + <code>adapters/idfv.uts</code>。<br>你让我们“先国内”，就先 <strong>Web→Android</strong>；Android 国内核心是 <strong>AndroidID&#x2F;OAID</strong>，海外补 <strong>AAID</strong>。</p>
</blockquote>
<hr>
<h1 id="二、API-设计（Promise-回调兼容）"><a href="#二、API-设计（Promise-回调兼容）" class="headerlink" title="二、API 设计（Promise + 回调兼容）"></a>二、API 设计（Promise + 回调兼容）</h1><blockquote>
<p>统一 Promise 风格，另兼容回调（可选）；返回结构“可读 + 可扩展”。</p>
</blockquote>
<h2 id="公开方法"><a href="#公开方法" class="headerlink" title="公开方法"></a>公开方法</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1) 隐私合规：注册/初始化（未同意时一律返回 available=false）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"><span class="attr">options</span>?: &#123;</span></span><br><span class="line"><span class="params">  showPrivacyDialog?: <span class="built_in">boolean</span>; // 需要时展示你自有的隐私弹窗</span></span><br><span class="line"><span class="params">&#125;</span>): <span class="title class_">Promise</span>&lt;&#123; <span class="attr">consent</span>: <span class="built_in">boolean</span> &#125;&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2) 配置哈希盐（建议服务端下发）；默认仅返回 hash</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3) 一次性获取所有可用的 ID（聚合）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"><span class="attr">options</span>?: &#123;</span></span><br><span class="line"><span class="params">  include?: <span class="built_in">Array</span>&lt;</span></span><br><span class="line"><span class="params">    | <span class="string">&quot;oaid&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;aaid&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;androidId&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;idfv&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;widevineId&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;pseudoId&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;imei&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;guid&quot;</span></span></span><br><span class="line"><span class="params">  &gt;;</span></span><br><span class="line"><span class="params">  exposeRaw?: <span class="built_in">boolean</span>; // 默认 <span class="literal">false</span>（仅返回hash），开启后返回原值 value</span></span><br><span class="line"><span class="params">  ttlMs?: <span class="built_in">number</span>; // 缓存有效期，默认 24h</span></span><br><span class="line"><span class="params">&#125;</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4) 返回“最合适”的一个（按优先级：国内默认 oaid &gt; androidId &gt; guid）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"><span class="attr">options</span>?: &#123;</span></span><br><span class="line"><span class="params">  prefer?: <span class="built_in">Array</span>&lt;<span class="string">&quot;oaid&quot;</span> | <span class="string">&quot;aaid&quot;</span> | <span class="string">&quot;androidId&quot;</span> | <span class="string">&quot;idfv&quot;</span> | <span class="string">&quot;guid&quot;</span>&gt;; // 可自定义优先级</span></span><br><span class="line"><span class="params">  exposeRaw?: <span class="built_in">boolean</span>;</span></span><br><span class="line"><span class="params">  ttlMs?: <span class="built_in">number</span>;</span></span><br><span class="line"><span class="params">&#125;</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5) 单项拉取（必要时）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br></pre></td></tr></table></figure>

<h2 id="返回类型（最佳实践）"><a href="#返回类型（最佳实践）" class="headerlink" title="返回类型（最佳实践）"></a>返回类型（最佳实践）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utssdk/common/types.uts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdValue</span> = &#123;</span><br><span class="line">  <span class="attr">value</span>?: <span class="built_in">string</span>; <span class="comment">// 原始值（exposeRaw=true 才返回）</span></span><br><span class="line">  <span class="attr">hash</span>?: <span class="built_in">string</span>; <span class="comment">// SHA-256(value + salt) 十六进制</span></span><br><span class="line">  <span class="attr">available</span>: <span class="built_in">boolean</span>; <span class="comment">// 是否获取成功</span></span><br><span class="line">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>; <span class="comment">// 是否受限（系统关闭广告跟踪等）</span></span><br><span class="line">  <span class="attr">source</span>: <span class="built_in">string</span>; <span class="comment">// oaid/aaid/androidId/idfv/guid/...</span></span><br><span class="line">  <span class="attr">message</span>?: <span class="built_in">string</span>; <span class="comment">// 失败或说明</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">  <span class="attr">oaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">aaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">androidId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">idfv</span>?: <span class="title class_">IdValue</span>; <span class="comment">// 预留给 iOS</span></span><br><span class="line">  <span class="attr">widevineId</span>?: <span class="title class_">IdValue</span>; <span class="comment">// 可选</span></span><br><span class="line">  <span class="attr">pseudoId</span>?: <span class="title class_">IdValue</span>; <span class="comment">// 可选</span></span><br><span class="line">  <span class="attr">imei</span>?: <span class="title class_">IdValue</span>; <span class="comment">// 不建议默认启用</span></span><br><span class="line">  <span class="attr">guid</span>?: <span class="title class_">IdValue</span>; <span class="comment">// H5/兜底</span></span><br><span class="line">  <span class="attr">best</span>?: <span class="built_in">string</span> | <span class="literal">null</span>; <span class="comment">// 最佳项的 key</span></span><br><span class="line">  <span class="attr">consent</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">ts</span>: <span class="built_in">number</span>; <span class="comment">// 生成时间戳</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="三、首版代码（可直接放进项目）"><a href="#三、首版代码（可直接放进项目）" class="headerlink" title="三、首版代码（可直接放进项目）"></a>三、首版代码（可直接放进项目）</h1><blockquote>
<p><strong>说明</strong>：以下代码为 <strong>可运行骨架</strong>。</p>
<ul>
<li>Web：已可直接返回 <code>guid</code>（localStorage&#x2F;uni.storage 持久化），并做 SHA-256。</li>
<li>Android：已可返回 <strong>AndroidID</strong>（无需额外权限），OAID&#x2F;AAID 先返回占位（后续你把 SDK 接上）。</li>
<li>聚合导出：<code>utssdk/index.uts</code> 会按平台引导到对应实现。</li>
</ul>
</blockquote>
<h2 id="1）uni-modules-uni-id-kit-module-json"><a href="#1）uni-modules-uni-id-kit-module-json" class="headerlink" title="1）uni_modules/uni-id-kit/module.json"></a>1）<code>uni_modules/uni-id-kit/module.json</code></h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uni-id-kit&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;displayName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UniIdKit - 一体设备ID工具包&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;聚合 OAID/AAID/AndroidID/GUID 等设备标识，合规&amp;哈希化输出&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;keywords&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;deviceid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;oaid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;aaid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;androidid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;guid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;uts&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;repository&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;engines&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;HBuilderX&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^3.8.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;uni_modules&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;platforms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;app-android&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;utssdk&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;kotlin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&gt;=1.7.0&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;web&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;utssdk&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="2）uni-modules-uni-id-kit-utssdk-common-types-uts"><a href="#2）uni-modules-uni-id-kit-utssdk-common-types-uts" class="headerlink" title="2）uni_modules/uni-id-kit/utssdk/common/types.uts"></a>2）<code>uni_modules/uni-id-kit/utssdk/common/types.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdValue</span> = &#123;</span><br><span class="line">  <span class="attr">value</span>?: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">hash</span>?: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">available</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">source</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">message</span>?: <span class="built_in">string</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">  <span class="attr">oaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">aaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">androidId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">idfv</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">widevineId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">pseudoId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">imei</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">guid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">best</span>?: <span class="built_in">string</span> | <span class="literal">null</span>;</span><br><span class="line">  <span class="attr">consent</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">ts</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="3）uni-modules-uni-id-kit-utssdk-common-hash-uts"><a href="#3）uni-modules-uni-id-kit-utssdk-common-hash-uts" class="headerlink" title="3）uni_modules/uni-id-kit/utssdk/common/hash.uts"></a>3）<code>uni_modules/uni-id-kit/utssdk/common/hash.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Web 有 crypto.subtle；Android 走 Java MessageDigest（见安卓实现）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sha256Hex</span>(<span class="params"><span class="attr">input</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// @ts-ignore</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">g</span>: <span class="built_in">any</span> = globalThis;</span><br><span class="line">  <span class="keyword">if</span> (g &amp;&amp; g.<span class="property">crypto</span> &amp;&amp; g.<span class="property">crypto</span>.<span class="property">subtle</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> enc = <span class="keyword">new</span> <span class="title class_">TextEncoder</span>().<span class="title function_">encode</span>(input);</span><br><span class="line">    <span class="keyword">const</span> buf = <span class="keyword">await</span> g.<span class="property">crypto</span>.<span class="property">subtle</span>.<span class="title function_">digest</span>(<span class="string">&quot;SHA-256&quot;</span>, enc);</span><br><span class="line">    <span class="keyword">const</span> arr = <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(buf));</span><br><span class="line">    <span class="keyword">return</span> arr.<span class="title function_">map</span>(<span class="function">(<span class="params">b</span>) =&gt;</span> b.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">2</span>, <span class="string">&quot;0&quot;</span>)).<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 无 WebCrypto 时，先退回原文（开发期），建议后续接原生或 JS 实现</span></span><br><span class="line">  <span class="keyword">return</span> input;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4）uni-modules-uni-id-kit-utssdk-common-storage-uts"><a href="#4）uni-modules-uni-id-kit-utssdk-common-storage-uts" class="headerlink" title="4）uni_modules/uni-id-kit/utssdk/common/storage.uts"></a>4）<code>uni_modules/uni-id-kit/utssdk/common/storage.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span></span>): <span class="built_in">string</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">return</span> uni.<span class="title function_">getStorageSync</span>(key) || <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">set</span>(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span>, <span class="attr">val</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    uni.<span class="title function_">setStorageSync</span>(key, val);</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5）uni-modules-uni-id-kit-utssdk-web-index-uts（Web-实现）"><a href="#5）uni-modules-uni-id-kit-utssdk-web-index-uts（Web-实现）" class="headerlink" title="5）uni_modules/uni-id-kit/utssdk/web/index.uts（Web 实现）"></a>5）<code>uni_modules/uni-id-kit/utssdk/web/index.uts</code>（Web 实现）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">IdCodesResult</span>, <span class="title class_">IdValue</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../common/types.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; sha256Hex &#125; <span class="keyword">from</span> <span class="string">&quot;../common/hash.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; get, set &#125; <span class="keyword">from</span> <span class="string">&quot;../common/storage.uts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _consent = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> _salt = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">uuid4</span>(<span class="params"></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&quot;</span>.<span class="title function_">replace</span>(<span class="regexp">/[xy]/g</span>, <span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> r = ((<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">16</span>) <span class="keyword">as</span> <span class="built_in">number</span>) | <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> v = c === <span class="string">&quot;x&quot;</span> ? r : (r &amp; <span class="number">0x3</span>) | <span class="number">0x8</span>;</span><br><span class="line">    <span class="keyword">return</span> v.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">build</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">source</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">value</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">msg</span>?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> available = !!value;</span><br><span class="line">  <span class="keyword">const</span> raw = exposeRaw ? value : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">const</span> hash = value ? <span class="keyword">await</span> <span class="title function_">sha256Hex</span>(value + _salt) : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">value</span>: raw, hash, available, limited, source, <span class="attr">message</span>: msg &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">_</span>: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span> = <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">UTSJSONObject</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// Web demo：默认视为已同意；你可以在这里弹你的隐私弹窗</span></span><br><span class="line">  _consent = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">consent</span>: _consent &#125; <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  _salt = salt || <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"><span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> guid = <span class="title function_">get</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!guid) &#123;</span><br><span class="line">    guid = <span class="string">`web:<span class="subst">$&#123;uuid4()&#125;</span>`</span>;</span><br><span class="line">    <span class="title function_">set</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>, guid);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;guid&quot;</span>, guid <span class="keyword">as</span> <span class="built_in">string</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// Web 没有 AndroidID</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="literal">undefined</span>,</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;Not supported on Web&quot;</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;oaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="string">&quot;Not supported on Web&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;aaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="string">&quot;Not supported on Web&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> include = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;include&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;aaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">res</span>: <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">    <span class="attr">consent</span>: _consent,</span><br><span class="line">    <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">  &#125; <span class="keyword">as</span> <span class="title class_">IdCodesResult</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!_consent) &#123;</span><br><span class="line">    res.<span class="property">guid</span> = &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;guid&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;consent=false&quot;</span> &#125;;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;guid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">guid</span> = <span class="keyword">await</span> <span class="title function_">getGuid</span>(exposeRaw);</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;androidId&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">androidId</span> = <span class="keyword">await</span> <span class="title function_">getAndroidId</span>();</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;oaid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">oaid</span> = <span class="keyword">await</span> <span class="title function_">getOAID</span>();</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;aaid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">aaid</span> = <span class="keyword">await</span> <span class="title function_">getAAID</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 国内默认优先级</span></span><br><span class="line">  <span class="keyword">const</span> order = [<span class="string">&quot;oaid&quot;</span>, <span class="string">&quot;androidId&quot;</span>, <span class="string">&quot;guid&quot;</span>];</span><br><span class="line">  res.<span class="property">best</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; order.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> k = order[i];</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">v</span>: <span class="title class_">IdValue</span> | <span class="literal">null</span> = (res <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[k] <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line">    <span class="keyword">if</span> (v &amp;&amp; v.<span class="property">available</span>) &#123;</span><br><span class="line">      res.<span class="property">best</span> = k;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> arr = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;prefer&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="keyword">const</span> r = <span class="keyword">await</span> <span class="title function_">getIdCodes</span>(&#123; <span class="attr">include</span>: arr <span class="keyword">as</span> <span class="built_in">any</span>, exposeRaw &#125; <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">if</span> (r.<span class="property">best</span>) &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">return</span> (r <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[r.<span class="property">best</span>] <span class="keyword">as</span> <span class="title class_">IdValue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;none&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;no id available&quot;</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6）uni-modules-uni-id-kit-utssdk-app-android-adapters-android-id-uts"><a href="#6）uni-modules-uni-id-kit-utssdk-app-android-adapters-android-id-uts" class="headerlink" title="6）uni_modules/uni-id-kit/utssdk/app-android/adapters/android_id.uts"></a>6）<code>uni_modules/uni-id-kit/utssdk/app-android/adapters/android_id.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ANDROID_ID，无需额外权限（相对稳定，但可能因某些ROM策略变化）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAndroidIdRaw</span>(<span class="params"></span>): <span class="built_in">string</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> ctx = plus.<span class="property">android</span>.<span class="title function_">runtimeMainActivity</span>();</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">SettingsSecure</span> = plus.<span class="property">android</span>.<span class="title function_">importClass</span>(</span><br><span class="line">      <span class="string">&quot;android.provider.Settings$Secure&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> contentResolver = ctx.<span class="title function_">getContentResolver</span>();</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> id = <span class="title class_">SettingsSecure</span>.<span class="title function_">getString</span>(</span><br><span class="line">      contentResolver,</span><br><span class="line">      <span class="string">&quot;android_id&quot;</span></span><br><span class="line">    ) <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line">    <span class="keyword">return</span> id ? <span class="string">`android:<span class="subst">$&#123;id&#125;</span>`</span> : <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7）uni-modules-uni-id-kit-utssdk-app-android-index-uts"><a href="#7）uni-modules-uni-id-kit-utssdk-app-android-index-uts" class="headerlink" title="7）uni_modules/uni-id-kit/utssdk/app-android/index.uts"></a>7）<code>uni_modules/uni-id-kit/utssdk/app-android/index.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">IdCodesResult</span>, <span class="title class_">IdValue</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../common/types.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; get, set &#125; <span class="keyword">from</span> <span class="string">&quot;../common/storage.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getAndroidIdRaw &#125; <span class="keyword">from</span> <span class="string">&quot;./adapters/android_id.uts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _consent = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> _salt = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Android 原生侧用 Java 的 MessageDigest 做 SHA-256 更稳，这里暂用 Web 版占位：</span></span><br><span class="line"><span class="comment">// 你也可以在此通过 plus.android.importClass 使用 java.security.MessageDigest 实现</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sha256Hex</span>(<span class="params"><span class="attr">input</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> input; <span class="comment">// <span class="doctag">TODO:</span> 接入原生 MessageDigest 后返回真 SHA-256</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">uuid4</span>(<span class="params"></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&quot;</span>.<span class="title function_">replace</span>(<span class="regexp">/[xy]/g</span>, <span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> r = ((<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">16</span>) <span class="keyword">as</span> <span class="built_in">number</span>) | <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> v = c === <span class="string">&quot;x&quot;</span> ? r : (r &amp; <span class="number">0x3</span>) | <span class="number">0x8</span>;</span><br><span class="line">    <span class="keyword">return</span> v.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">build</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">source</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">value</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">msg</span>?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> available = !!value;</span><br><span class="line">  <span class="keyword">const</span> raw = exposeRaw ? value : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">const</span> hash = value ? <span class="keyword">await</span> <span class="title function_">sha256Hex</span>(value + _salt) : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">value</span>: raw, hash, available, limited, source, <span class="attr">message</span>: msg &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">_</span>: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span> = <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">UTSJSONObject</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// 这里接入你的合规弹窗/SDK；同意前建议不采集</span></span><br><span class="line">  _consent = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">consent</span>: _consent &#125; <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  _salt = salt || <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> v = <span class="title function_">getAndroidIdRaw</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;androidId&quot;</span>, v || <span class="literal">undefined</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 预留：接入 Google Advertising ID（AAID）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// TODO：集成 com.google.android.gms:play-services-ads-identifier</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;aaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="string">&quot;AAID not integrated&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 预留：接入 MSA OAID（国内主流）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// TODO：接入 MSA/OAID SDK</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;oaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="string">&quot;OAID not integrated&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"><span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> guid = <span class="title function_">get</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!guid) &#123;</span><br><span class="line">    guid = <span class="string">`app:<span class="subst">$&#123;uuid4()&#125;</span>`</span>;</span><br><span class="line">    <span class="title function_">set</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>, guid);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;guid&quot;</span>, guid <span class="keyword">as</span> <span class="built_in">string</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> include = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;include&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;aaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">res</span>: <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">    <span class="attr">consent</span>: _consent,</span><br><span class="line">    <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">  &#125; <span class="keyword">as</span> <span class="title class_">IdCodesResult</span>;</span><br><span class="line">  <span class="keyword">if</span> (!_consent) &#123;</span><br><span class="line">    res.<span class="property">guid</span> = &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;guid&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;consent=false&quot;</span> &#125;;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;androidId&quot;</span>) &gt;= <span class="number">0</span>)</span><br><span class="line">    res.<span class="property">androidId</span> = <span class="keyword">await</span> <span class="title function_">getAndroidId</span>(exposeRaw);</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;oaid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">oaid</span> = <span class="keyword">await</span> <span class="title function_">getOAID</span>();</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;aaid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">aaid</span> = <span class="keyword">await</span> <span class="title function_">getAAID</span>();</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;guid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">guid</span> = <span class="keyword">await</span> <span class="title function_">getGuid</span>(exposeRaw);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 国内优先级：oaid &gt; androidId &gt; guid</span></span><br><span class="line">  <span class="keyword">const</span> order = [<span class="string">&quot;oaid&quot;</span>, <span class="string">&quot;androidId&quot;</span>, <span class="string">&quot;guid&quot;</span>];</span><br><span class="line">  res.<span class="property">best</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; order.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> k = order[i];</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">v</span>: <span class="title class_">IdValue</span> | <span class="literal">null</span> = (res <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[k] <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line">    <span class="keyword">if</span> (v &amp;&amp; v.<span class="property">available</span>) &#123;</span><br><span class="line">      res.<span class="property">best</span> = k;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> arr = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;prefer&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="keyword">const</span> r = <span class="keyword">await</span> <span class="title function_">getIdCodes</span>(&#123; <span class="attr">include</span>: arr <span class="keyword">as</span> <span class="built_in">any</span>, exposeRaw &#125; <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">if</span> (r.<span class="property">best</span>) &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">return</span> (r <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[r.<span class="property">best</span>] <span class="keyword">as</span> <span class="title class_">IdValue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;none&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;no id available&quot;</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8）uni-modules-uni-id-kit-utssdk-index-uts（聚合导出）"><a href="#8）uni-modules-uni-id-kit-utssdk-index-uts（聚合导出）" class="headerlink" title="8）uni_modules/uni-id-kit/utssdk/index.uts（聚合导出）"></a>8）<code>uni_modules/uni-id-kit/utssdk/index.uts</code>（聚合导出）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 平台分发：同名导出，业务方 import 一处即可</span></span><br><span class="line"><span class="comment">// #ifdef APP-ANDROID</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  register,</span><br><span class="line">  setSalt,</span><br><span class="line">  getIdCodes,</span><br><span class="line">  getBestId,</span><br><span class="line">  getOAID,</span><br><span class="line">  getAAID,</span><br><span class="line">  getAndroidId,</span><br><span class="line">  getGuid,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./app-android/index.uts&quot;</span>;</span><br><span class="line"><span class="comment">// #endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #ifdef H5</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  register,</span><br><span class="line">  setSalt,</span><br><span class="line">  getIdCodes,</span><br><span class="line">  getBestId,</span><br><span class="line">  getOAID,</span><br><span class="line">  getAAID,</span><br><span class="line">  getAndroidId,</span><br><span class="line">  getGuid,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./web/index.uts&quot;</span>;</span><br><span class="line"><span class="comment">// #endif</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="四、在页面中使用（uni-app-x）"><a href="#四、在页面中使用（uni-app-x）" class="headerlink" title="四、在页面中使用（uni-app x）"></a>四、在页面中使用（uni-app x）</h1><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/login/index.uvue (示例)</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  register,</span><br><span class="line">  setSalt,</span><br><span class="line">  getBestId,</span><br><span class="line">  getIdCodes,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;@/uni_modules/uni-id-kit/utssdk/index.uts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">onMounted</span>(<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">register</span>(); <span class="comment">// 视需求弹你的隐私协议</span></span><br><span class="line">  <span class="title function_">setSalt</span>(<span class="string">&quot;server-salt-xxx&quot;</span>); <span class="comment">// 建议从服务端下发</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> best = <span class="keyword">await</span> <span class="title function_">getBestId</span>(&#123; <span class="attr">exposeRaw</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">  <span class="comment">// 携带 best.hash 作为 x-device-id（或 getIdCodes 的 best 项）</span></span><br><span class="line">  <span class="keyword">const</span> dvc = best.<span class="property">hash</span> || best.<span class="property">value</span> || <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> uni.<span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">`<span class="subst">$&#123;baseUrl&#125;</span>/passkeys/login/options`</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    <span class="attr">header</span>: &#123; <span class="string">&quot;x-device-id&quot;</span>: dvc &#125;,</span><br><span class="line">    <span class="attr">data</span>: &#123;&#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="五、后续接入指引（Android-OAID-AAID）"><a href="#五、后续接入指引（Android-OAID-AAID）" class="headerlink" title="五、后续接入指引（Android OAID&#x2F;AAID）"></a>五、后续接入指引（Android OAID&#x2F;AAID）</h1><ul>
<li><strong>OAID</strong>：集成 <strong>MSA&#x2F;联运</strong> SDK（各大国产厂商支持），在 <code>app-android/adapters/oaid.uts</code> 中封装 <code>getOAIDRaw()</code>，在 <code>index.uts</code> 调 <code>await build(&#39;oaid&#39;, v, ...)</code>。</li>
<li><strong>AAID</strong>：添加 <code>com.google.android.gms:play-services-ads-identifier</code> 依赖，调用 <code>AdvertisingIdClient.getAdvertisingIdInfo(context)</code>。</li>
<li><strong>SHA-256</strong>：Android 侧推荐用 <code>java.security.MessageDigest</code>，性能更稳定；把 web 占位换掉。</li>
<li><strong>权限</strong>：AndroidID 不需要额外权限；IMEI&#x2F;MEID 需要 READ_PHONE_STATE（<strong>不推荐默认启用</strong>）。</li>
<li><strong>合规</strong>：未同意隐私协议前，一律返回 <code>available=false</code>；默认仅返回 <code>hash</code>，除非 <code>exposeRaw=true</code>。</li>
</ul>
<hr>
<p>如果你认可这个结构和 API，我可以继续把 <strong>Android 的 OAID&#x2F;AAID 具体适配代码</strong>补上（带依赖、打包参数、权限说明），以及 <strong>iOS 的 IDFV</strong> 版本。</p>
<h1 id="参考实现"><a href="#参考实现" class="headerlink" title="参考实现"></a>参考实现</h1><p>太好了，我把你这两个现成插件解包看过了，简单总结下各自实现，然后给一套“最佳实践”的统一 API 和落地改造方案（含可以直接替换的 UTS 代码片段）。</p>
<hr>
<h2 id="现有两个插件的实现差异（速览）"><a href="#现有两个插件的实现差异（速览）" class="headerlink" title="现有两个插件的实现差异（速览）"></a>现有两个插件的实现差异（速览）</h2><h3 id="1-android-deviceid（UTS，App-Android）"><a href="#1-android-deviceid（UTS，App-Android）" class="headerlink" title="1) android-deviceid（UTS，App-Android）"></a>1) <code>android-deviceid</code>（UTS，App-Android）</h3><ul>
<li><p><strong>用到的库</strong>：<code>com.github.gzuliyujiang.oaid</code>（常用 OAID SDK 聚合库），还打包了 3 个 AAR（<code>ads-identifier-*.aar</code>、<code>IDlibrary-release.aar</code>）。</p>
</li>
<li><p><strong>关键点</strong>：</p>
<ul>
<li>在 <code>register()</code> 里调用 <code>DeviceIdentifier.register(UTSAndroid.getUniActivity().getApplication())</code> 完成 <strong>OAID 初始化</strong>。</li>
<li>暴露了一个 <strong>监听器</strong>（<code>IDManger.OnIOAIDListener</code>），把厂商返回的 JSON 结果转成你定义的 <code>Device</code> 对象回调出去。</li>
</ul>
</li>
<li><p><strong>优点</strong>：能拿到 <strong>OAID</strong>，并且是较为标准的做法；兼容多厂商。</p>
</li>
<li><p><strong>需要补强</strong>：</p>
<ul>
<li><strong>统一 Promise API</strong>（目前是回调），方便在页面里用 <code>await</code>。</li>
<li><strong>AAID（Google 广告 ID）</strong>、<strong>AndroidID</strong> 的兜底与优先级策略。</li>
<li><strong>隐私合规</strong>（register 同意前不采集）、<strong>hash-only</strong> 输出（默认只回传哈希，原值可开关）。</li>
<li><strong>缓存</strong>（ttl），防止频繁拉取。</li>
<li>错误&#x2F;受限标记（例如用户关闭了广告跟踪）。</li>
</ul>
</li>
</ul>
<h3 id="2-zws-uniqueid（UTS，App-Android）"><a href="#2-zws-uniqueid（UTS，App-Android）" class="headerlink" title="2) zws-uniqueid（UTS，App-Android）"></a>2) <code>zws-uniqueid</code>（UTS，App-Android）</h3><ul>
<li><strong>实现</strong>：拼接 <code>Build.*</code> 信息做一段文本，MD5 后作为“唯一 ID”。</li>
<li><strong>优点</strong>：无需权限&#x2F;SDK，易用。</li>
<li><strong>问题</strong>：这是典型 <strong>PseudoID</strong>，<strong>同型号&#x2F;同批次设备可能相同</strong>，也可能因 ROM&#x2F;版本变更；不适合用来做<strong>设备唯一绑定</strong>或风控。</li>
<li><strong>建议</strong>：可以作为 <code>pseudoId</code> 字段的<strong>最末位兜底</strong>，不要当主标识。</li>
</ul>
<hr>
<h2 id="建议的统一方案（名字可用你之前认可的：uni-id-kit）"><a href="#建议的统一方案（名字可用你之前认可的：uni-id-kit）" class="headerlink" title="建议的统一方案（名字可用你之前认可的：uni-id-kit）"></a>建议的统一方案（名字可用你之前认可的：<strong><code>uni-id-kit</code></strong>）</h2><p><strong>目标</strong>：同一份 UTS 插件，覆盖 Web&#x2F;H5 与 App-Android；API 一致、返回结构一致、默认合规（hash-only），国内优先级 <code>OAID &gt; AndroidID &gt; GUID &gt; PseudoID</code>，海外可加 <code>AAID</code>。</p>
<h3 id="统一-API（Promise-风格）"><a href="#统一-API（Promise-风格）" class="headerlink" title="统一 API（Promise 风格）"></a>统一 API（Promise 风格）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册/合规：未同意前一律 available=false</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"><span class="attr">options</span>?: &#123;</span></span><br><span class="line"><span class="params">  showPrivacyDialog?: <span class="built_in">boolean</span>;</span></span><br><span class="line"><span class="params">&#125;</span>): <span class="title class_">Promise</span>&lt;&#123; <span class="attr">consent</span>: <span class="built_in">boolean</span> &#125;&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置哈希盐（建议服务端下发）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一次性获取所有（含可用性、受限说明、hash）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"><span class="attr">options</span>?: &#123;</span></span><br><span class="line"><span class="params">  include?: <span class="built_in">Array</span>&lt;<span class="string">&quot;oaid&quot;</span> | <span class="string">&quot;aaid&quot;</span> | <span class="string">&quot;androidId&quot;</span> | <span class="string">&quot;pseudoId&quot;</span> | <span class="string">&quot;guid&quot;</span>&gt;;</span></span><br><span class="line"><span class="params">  exposeRaw?: <span class="built_in">boolean</span>; // 默认 <span class="literal">false</span></span></span><br><span class="line"><span class="params">  ttlMs?: <span class="built_in">number</span>; // 默认 24h</span></span><br><span class="line"><span class="params">&#125;</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回“最合适”的一个（按优先级，可定制）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"><span class="attr">options</span>?: &#123;</span></span><br><span class="line"><span class="params">  prefer?: <span class="built_in">Array</span>&lt;<span class="string">&quot;oaid&quot;</span> | <span class="string">&quot;androidId&quot;</span> | <span class="string">&quot;guid&quot;</span> | <span class="string">&quot;pseudoId&quot;</span> | <span class="string">&quot;aaid&quot;</span>&gt;;</span></span><br><span class="line"><span class="params">  exposeRaw?: <span class="built_in">boolean</span>;</span></span><br><span class="line"><span class="params">  ttlMs?: <span class="built_in">number</span>;</span></span><br><span class="line"><span class="params">&#125;</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 单项</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br></pre></td></tr></table></figure>

<p><strong>统一返回结构</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">IdValue</span> = &#123;</span><br><span class="line">  <span class="attr">value</span>?: <span class="built_in">string</span>; <span class="comment">// exposeRaw=true 才返回</span></span><br><span class="line">  <span class="attr">hash</span>?: <span class="built_in">string</span>; <span class="comment">// SHA-256(value + salt)</span></span><br><span class="line">  <span class="attr">available</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>; <span class="comment">// 例如系统关闭广告跟踪</span></span><br><span class="line">  <span class="attr">source</span>: <span class="built_in">string</span>; <span class="comment">// oaid/aaid/androidId/pseudoId/guid</span></span><br><span class="line">  <span class="attr">message</span>?: <span class="built_in">string</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">  <span class="attr">oaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">aaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">androidId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">pseudoId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">guid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">best</span>?: <span class="built_in">string</span> | <span class="literal">null</span>;</span><br><span class="line">  <span class="attr">consent</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">ts</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="如何改造你现有的两个插件"><a href="#如何改造你现有的两个插件" class="headerlink" title="如何改造你现有的两个插件"></a>如何改造你现有的两个插件</h2><blockquote>
<p>下面给的都是 <strong>直接能塞进工程</strong> 的 UTS 代码。你可以新建一个 <code>uni_modules/uni-id-kit</code>，把这两个插件的“能力”合在一起；或者在你现有 <code>android-deviceid</code> 里重构导出，效果一致。</p>
</blockquote>
<h3 id="1-公共类型与工具（common-types-uts、common-storage-uts、common-hash-uts）"><a href="#1-公共类型与工具（common-types-uts、common-storage-uts、common-hash-uts）" class="headerlink" title="1) 公共类型与工具（common/types.uts、common/storage.uts、common/hash.uts）"></a>1) 公共类型与工具（<code>common/types.uts</code>、<code>common/storage.uts</code>、<code>common/hash.uts</code>）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// common/types.uts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdValue</span> = &#123;</span><br><span class="line">  <span class="attr">value</span>?: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">hash</span>?: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">available</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">source</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">message</span>?: <span class="built_in">string</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">  <span class="attr">oaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">aaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">androidId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">pseudoId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">guid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">best</span>?: <span class="built_in">string</span> | <span class="literal">null</span>;</span><br><span class="line">  <span class="attr">consent</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">ts</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// common/storage.uts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span></span>): <span class="built_in">string</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uni.<span class="title function_">getStorageSync</span>(key) || <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">set</span>(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span>, <span class="attr">val</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    uni.<span class="title function_">setStorageSync</span>(key, val);</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// common/hash.uts（Web 有 crypto.subtle；Android 建议换成 MessageDigest）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sha256Hex</span>(<span class="params"><span class="attr">input</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// @ts-ignore</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">g</span>: <span class="built_in">any</span> = globalThis;</span><br><span class="line">  <span class="keyword">if</span> (g &amp;&amp; g.<span class="property">crypto</span> &amp;&amp; g.<span class="property">crypto</span>.<span class="property">subtle</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> enc = <span class="keyword">new</span> <span class="title class_">TextEncoder</span>().<span class="title function_">encode</span>(input);</span><br><span class="line">    <span class="keyword">const</span> buf = <span class="keyword">await</span> g.<span class="property">crypto</span>.<span class="property">subtle</span>.<span class="title function_">digest</span>(<span class="string">&quot;SHA-256&quot;</span>, enc);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(buf))</span><br><span class="line">      .<span class="title function_">map</span>(<span class="function">(<span class="params">b</span>) =&gt;</span> b.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">2</span>, <span class="string">&quot;0&quot;</span>))</span><br><span class="line">      .<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> input; <span class="comment">// Android 再换成原生 MessageDigest（见下）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-Web-实现（先把-H5-跑起来：GUID-hash-缓存）"><a href="#2-Web-实现（先把-H5-跑起来：GUID-hash-缓存）" class="headerlink" title="2) Web 实现（先把 H5 跑起来：GUID + hash + 缓存）"></a>2) Web 实现（先把 H5 跑起来：GUID + hash + 缓存）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// web/index.uts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">IdCodesResult</span>, <span class="title class_">IdValue</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../common/types.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; sha256Hex &#125; <span class="keyword">from</span> <span class="string">&quot;../common/hash.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; get, set &#125; <span class="keyword">from</span> <span class="string">&quot;../common/storage.uts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _consent = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> _salt = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">uuid4</span>(<span class="params"></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&quot;</span>.<span class="title function_">replace</span>(<span class="regexp">/[xy]/g</span>, <span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> r = ((<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">16</span>) <span class="keyword">as</span> <span class="built_in">number</span>) | <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> v = c === <span class="string">&quot;x&quot;</span> ? r : (r &amp; <span class="number">0x3</span>) | <span class="number">0x8</span>;</span><br><span class="line">    <span class="keyword">return</span> v.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">build</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">source</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">value</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">msg</span>?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> available = !!value;</span><br><span class="line">  <span class="keyword">const</span> raw = exposeRaw ? value : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">const</span> hash = value ? <span class="keyword">await</span> <span class="title function_">sha256Hex</span>(value + _salt) : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">value</span>: raw, hash, available, limited, source, <span class="attr">message</span>: msg &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">_</span>: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span> = <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">UTSJSONObject</span>&gt; &#123;</span><br><span class="line">  _consent = <span class="literal">true</span>; <span class="comment">// 你可在这里弹你的隐私协议</span></span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">consent</span>: _consent &#125; <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  _salt = salt || <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"><span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> guid = <span class="title function_">get</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!guid) &#123;</span><br><span class="line">    guid = <span class="string">`web:<span class="subst">$&#123;uuid4()&#125;</span>`</span>;</span><br><span class="line">    <span class="title function_">set</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>, guid);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;guid&quot;</span>, guid <span class="keyword">as</span> <span class="built_in">string</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="literal">undefined</span>,</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;Not supported on Web&quot;</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;oaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="string">&quot;Not supported on Web&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;aaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="string">&quot;Not supported on Web&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> include = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;include&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">res</span>: <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">    <span class="attr">consent</span>: _consent,</span><br><span class="line">    <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">  &#125; <span class="keyword">as</span> <span class="title class_">IdCodesResult</span>;</span><br><span class="line">  <span class="keyword">if</span> (!_consent) &#123;</span><br><span class="line">    res.<span class="property">guid</span> = &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;guid&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;consent=false&quot;</span> &#125;;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;guid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">guid</span> = <span class="keyword">await</span> <span class="title function_">getGuid</span>(exposeRaw);</span><br><span class="line"></span><br><span class="line">  res.<span class="property">best</span> = res.<span class="property">guid</span>?.<span class="property">available</span> ? <span class="string">&quot;guid&quot;</span> : <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> r = <span class="keyword">await</span> <span class="title function_">getIdCodes</span>(options);</span><br><span class="line">  <span class="keyword">if</span> (r.<span class="property">best</span>) &#123;</span><br><span class="line">    <span class="comment">/* @ts-ignore */</span> <span class="keyword">return</span> (r <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[r.<span class="property">best</span>] <span class="keyword">as</span> <span class="title class_">IdValue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;none&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;no id available&quot;</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-Android-实现（融合你两个插件思路，Promise-化-兜底-可拓展）"><a href="#3-Android-实现（融合你两个插件思路，Promise-化-兜底-可拓展）" class="headerlink" title="3) Android 实现（融合你两个插件思路，Promise 化 + 兜底 + 可拓展）"></a>3) Android 实现（融合你两个插件思路，Promise 化 + 兜底 + 可拓展）</h3><ul>
<li><strong>AndroidID</strong>：直接取 <code>Settings.Secure.ANDROID_ID</code>（不需要权限）。</li>
<li><strong>OAID</strong>：沿用你 <code>android-deviceid</code> 的库，包装为 Promise；初始化要在 <code>register()</code> 里做。</li>
<li><strong>AAID</strong>：先留占位，后续加 <code>play-services-ads-identifier</code>。</li>
<li><strong>PseudoID</strong>：把 <code>zws-uniqueid</code> 的思路做成可选兜底，不当主标识。</li>
<li><strong>SHA-256</strong>：建议在 Android 侧用 <code>java.security.MessageDigest</code>，比 web 占位靠谱。</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app-android/adapters/android_id.uts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAndroidIdRaw</span>(<span class="params"></span>): <span class="built_in">string</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> ctx = plus.<span class="property">android</span>.<span class="title function_">runtimeMainActivity</span>();</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">SettingsSecure</span> = plus.<span class="property">android</span>.<span class="title function_">importClass</span>(</span><br><span class="line">      <span class="string">&quot;android.provider.Settings$Secure&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> contentResolver = ctx.<span class="title function_">getContentResolver</span>();</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> id = <span class="title class_">SettingsSecure</span>.<span class="title function_">getString</span>(</span><br><span class="line">      contentResolver,</span><br><span class="line">      <span class="string">&quot;android_id&quot;</span></span><br><span class="line">    ) <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line">    <span class="keyword">return</span> id ? <span class="string">`android:<span class="subst">$&#123;id&#125;</span>`</span> : <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app-android/adapters/pseudo_id.uts（把 zws 的实现收编为兜底项）</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Build</span> <span class="keyword">from</span> <span class="string">&quot;android.os.Build&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">MessageDigest</span> <span class="keyword">from</span> <span class="string">&quot;java.security.MessageDigest&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">BigInteger</span> <span class="keyword">from</span> <span class="string">&quot;java.math.BigInteger&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getPseudoIdRaw</span>(<span class="params"></span>): <span class="built_in">string</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> text =</span><br><span class="line">      <span class="title class_">Build</span>.<span class="property">BOARD</span> +</span><br><span class="line">      <span class="title class_">Build</span>.<span class="property">BRAND</span> +</span><br><span class="line">      <span class="title class_">Build</span>.<span class="property">DEVICE</span> +</span><br><span class="line">      <span class="title class_">Build</span>.<span class="property">DISPLAY</span> +</span><br><span class="line">      <span class="title class_">Build</span>.<span class="property">FINGERPRINT</span> +</span><br><span class="line">      <span class="string">&quot;uni-id-kit&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> md5s = <span class="title class_">MessageDigest</span>.<span class="title function_">getInstance</span>(<span class="string">&quot;MD5&quot;</span>).<span class="title function_">digest</span>(</span><br><span class="line">      (text <span class="keyword">as</span> <span class="built_in">any</span>).<span class="title function_">toString</span>().<span class="title function_">toByteArray</span>()</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BigInteger</span>(<span class="number">1</span>, md5s).<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app-android/index.uts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">IdCodesResult</span>, <span class="title class_">IdValue</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../common/types.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; get, set &#125; <span class="keyword">from</span> <span class="string">&quot;../common/storage.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getAndroidIdRaw &#125; <span class="keyword">from</span> <span class="string">&quot;./adapters/android_id.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getPseudoIdRaw &#125; <span class="keyword">from</span> <span class="string">&quot;./adapters/pseudo_id.uts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==== 引入你 android-deviceid 插件用到的 OAID 库 ====</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">DeviceIdentifier</span> <span class="keyword">from</span> <span class="string">&quot;com.github.gzuliyujiang.oaid.DeviceIdentifier&quot;</span>;</span><br><span class="line"><span class="comment">// 你现有的监听器写法是 IDManger.OnIOAIDListener + JSON 回调，这里改 Promise 风格：</span></span><br><span class="line"><span class="comment">// 如果库支持 IGetter 回调也可以（取决于版本），我这里按你包内的风格保留 register 初始化。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _consent = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> _salt = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 Android 的 MessageDigest 实现 SHA-256（优于 web 占位）</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sha256HexSync</span>(<span class="params"><span class="attr">input</span>: <span class="built_in">string</span></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">MessageDigest</span> = plus.<span class="property">android</span>.<span class="title function_">importClass</span>(</span><br><span class="line">      <span class="string">&quot;java.security.MessageDigest&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> md = <span class="title class_">MessageDigest</span>.<span class="title function_">getInstance</span>(<span class="string">&quot;SHA-256&quot;</span>);</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> bytes = (input <span class="keyword">as</span> <span class="built_in">any</span>).<span class="title function_">toString</span>().<span class="title function_">getBytes</span>();</span><br><span class="line">    <span class="keyword">const</span> out = md.<span class="title function_">digest</span>(bytes);</span><br><span class="line">    <span class="keyword">let</span> hex = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; out.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> b = (out[i] <span class="keyword">as</span> <span class="built_in">number</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">      hex += (b &lt; <span class="number">16</span> ? <span class="string">&quot;0&quot;</span> : <span class="string">&quot;&quot;</span>) + b.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hex;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> input;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">uuid4</span>(<span class="params"></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&quot;</span>.<span class="title function_">replace</span>(<span class="regexp">/[xy]/g</span>, <span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> r = ((<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">16</span>) <span class="keyword">as</span> <span class="built_in">number</span>) | <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> v = c === <span class="string">&quot;x&quot;</span> ? r : (r &amp; <span class="number">0x3</span>) | <span class="number">0x8</span>;</span><br><span class="line">    <span class="keyword">return</span> v.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">buildSync</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">source</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">value</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">msg</span>?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">IdValue</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> available = !!value;</span><br><span class="line">  <span class="keyword">const</span> raw = exposeRaw ? value : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">const</span> hash = value ? <span class="title function_">sha256HexSync</span>(value + _salt) : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">value</span>: raw, hash, available, limited, source, <span class="attr">message</span>: msg &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">_</span>: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span> = <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">UTSJSONObject</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="title class_">DeviceIdentifier</span>.<span class="title function_">register</span>(<span class="title class_">UTSAndroid</span>.<span class="title function_">getUniActivity</span>()!!.<span class="title function_">getApplication</span>()!!);</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line">  _consent = <span class="literal">true</span>; <span class="comment">// 这里接你的隐私弹窗</span></span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">consent</span>: _consent &#125; <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  _salt = salt || <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> v = <span class="title function_">getAndroidIdRaw</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">buildSync</span>(<span class="string">&quot;androidId&quot;</span>, v || <span class="literal">undefined</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"><span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> guid = <span class="title function_">get</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!guid) &#123;</span><br><span class="line">    guid = <span class="string">`app:<span class="subst">$&#123;uuid4()&#125;</span>`</span>;</span><br><span class="line">    <span class="title function_">set</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>, guid);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">buildSync</span>(<span class="string">&quot;guid&quot;</span>, guid <span class="keyword">as</span> <span class="built_in">string</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OAID：基于你现有库封装为 Promise（示例：如果库是同步 API 换成同步返回即可）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 你包里是通过监听器把结果 JSON 回调出来的；</span></span><br><span class="line">    <span class="comment">// 这里建议写一个同步/异步包装（示意）：</span></span><br><span class="line">    <span class="comment">// 假设库提供 DeviceIdentifier.getOAID(ctx) 或者 DeviceID.getOAID(...)</span></span><br><span class="line">    <span class="comment">// 如果仅有回调形式，就 new Promise 包一下。</span></span><br><span class="line">    <span class="comment">// 先占位为“未集成”，避免误用：</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">buildSync</span>(</span><br><span class="line">      <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">      <span class="literal">undefined</span>,</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">      <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;OAID not integrated to Promise wrapper&quot;</span></span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">buildSync</span>(<span class="string">&quot;oaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">false</span>, (e <span class="keyword">as</span> <span class="built_in">any</span>).<span class="title function_">toString</span>());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AAID：等你接 play-services-ads-identifier，这里先占位</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">buildSync</span>(<span class="string">&quot;aaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="string">&quot;AAID not integrated&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> include = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;include&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;pseudoId&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">res</span>: <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">    <span class="attr">consent</span>: _consent,</span><br><span class="line">    <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">  &#125; <span class="keyword">as</span> <span class="title class_">IdCodesResult</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!_consent) &#123;</span><br><span class="line">    res.<span class="property">guid</span> = &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;guid&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;consent=false&quot;</span> &#125;;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;oaid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">oaid</span> = <span class="keyword">await</span> <span class="title function_">getOAID</span>();</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;androidId&quot;</span>) &gt;= <span class="number">0</span>)</span><br><span class="line">    res.<span class="property">androidId</span> = <span class="keyword">await</span> <span class="title function_">getAndroidId</span>(exposeRaw);</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;guid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">guid</span> = <span class="keyword">await</span> <span class="title function_">getGuid</span>(exposeRaw);</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;pseudoId&quot;</span>) &gt;= <span class="number">0</span>)</span><br><span class="line">    res.<span class="property">pseudoId</span> = <span class="title function_">buildSync</span>(</span><br><span class="line">      <span class="string">&quot;pseudoId&quot;</span>,</span><br><span class="line">      <span class="title function_">getPseudoIdRaw</span>() || <span class="literal">undefined</span>,</span><br><span class="line">      exposeRaw</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 国内默认优先级：oaid &gt; androidId &gt; guid &gt; pseudoId</span></span><br><span class="line">  <span class="keyword">const</span> order = [<span class="string">&quot;oaid&quot;</span>, <span class="string">&quot;androidId&quot;</span>, <span class="string">&quot;guid&quot;</span>, <span class="string">&quot;pseudoId&quot;</span>];</span><br><span class="line">  res.<span class="property">best</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; order.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> k = order[i];</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">v</span>: <span class="title class_">IdValue</span> | <span class="literal">null</span> = (res <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[k] <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line">    <span class="keyword">if</span> (v &amp;&amp; v.<span class="property">available</span>) &#123;</span><br><span class="line">      res.<span class="property">best</span> = k;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> prefer = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;prefer&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;pseudoId&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="keyword">const</span> r = <span class="keyword">await</span> <span class="title function_">getIdCodes</span>(&#123; <span class="attr">include</span>: prefer <span class="keyword">as</span> <span class="built_in">any</span>, exposeRaw &#125; <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">if</span> (r.<span class="property">best</span>) &#123;</span><br><span class="line">    <span class="comment">/* @ts-ignore */</span> <span class="keyword">return</span> (r <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[r.<span class="property">best</span>] <span class="keyword">as</span> <span class="title class_">IdValue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;none&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;no id available&quot;</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-平台聚合导出（utssdk-index-uts）"><a href="#4-平台聚合导出（utssdk-index-uts）" class="headerlink" title="4) 平台聚合导出（utssdk/index.uts）"></a>4) 平台聚合导出（<code>utssdk/index.uts</code>）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// #ifdef APP-ANDROID</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  register,</span><br><span class="line">  setSalt,</span><br><span class="line">  getIdCodes,</span><br><span class="line">  getBestId,</span><br><span class="line">  getOAID,</span><br><span class="line">  getAAID,</span><br><span class="line">  getAndroidId,</span><br><span class="line">  getGuid,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./app-android/index.uts&quot;</span>;</span><br><span class="line"><span class="comment">// #endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #ifdef H5</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  register,</span><br><span class="line">  setSalt,</span><br><span class="line">  getIdCodes,</span><br><span class="line">  getBestId,</span><br><span class="line">  getOAID,</span><br><span class="line">  getAAID,</span><br><span class="line">  getAndroidId,</span><br><span class="line">  getGuid,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./web/index.uts&quot;</span>;</span><br><span class="line"><span class="comment">// #endif</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="要不要“调整现在的代码”？"><a href="#要不要“调整现在的代码”？" class="headerlink" title="要不要“调整现在的代码”？"></a>要不要“调整现在的代码”？</h2><p><strong>要的</strong>，但改动并不大，主要集中在 4 点：</p>
<ol>
<li><strong>Promise 化</strong>：把回调&#x2F;监听器的导出改为 Promise，页面里可以 <code>await</code>。</li>
<li><strong>统一返回结构</strong>：所有方法都返回 <code>IdValue/IdCodesResult</code>，好串联与埋点。</li>
<li><strong>合规默认 &amp; hash-only</strong>：提供 <code>register()</code> 和 <code>setSalt()</code>，未同意前不采集；默认只回 <code>hash</code>。</li>
<li><strong>兜底与优先级</strong>：在拿不到 OAID 时，<strong>自动回退</strong>到 <code>AndroidID</code>、<code>GUID</code>、<code>pseudoId</code>，并清晰标出 <code>limited</code>&#x2F;<code>message</code>。</li>
</ol>
<blockquote>
<p>你的 <code>android-deviceid</code> 插件可以直接把库继续用；我在上面的安卓实现里已经把“桥接位”留好了。<br><code>zws-uniqueid</code> 的算法我收编到 <code>pseudoId</code>，作为兜底，不再当主标识使用。</p>
</blockquote>
<hr>
<h2 id="下一步"><a href="#下一步" class="headerlink" title="下一步"></a>下一步</h2><ul>
<li>你确认用 <strong><code>uni-id-kit</code></strong> 的方案我就把 <strong>OAID Promise 包装</strong>（基于你现有 <code>DeviceIdentifier</code> 监听回调）也给你写上，并且给出 <strong>AAID 接入</strong>（<code>play-services-ads-identifier</code>）的 <code>gradle</code> 依赖与 UTS 调用示例。</li>
<li>如果需要，我也可以给 <strong>iOS（IDFV）</strong> 的 UTS 版本，一起并到这个套件里。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/07/id-kit%E5%BC%80%E5%8F%91/" data-id="cmf9bdhki000fqq4z0qazaxeo" data-title="id-kit开发" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2025/09/07/id-kit/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">id-kit</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/web%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/">web应用开发</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/web%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E5%89%8D%E7%AB%AF/">前端</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/401/" rel="tag">401</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AbortController/" rel="tag">AbortController</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Axios/" rel="tag">Axios</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fetch/" rel="tag">Fetch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GitHub-Pages/" rel="tag">GitHub Pages</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MSW/" rel="tag">MSW</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NexT/" rel="tag">NexT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenAPI/" rel="tag">OpenAPI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Passkeys/" rel="tag">Passkeys</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pinia/" rel="tag">Pinia</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TanStack-Query/" rel="tag">TanStack Query</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript/" rel="tag">TypeScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UTS-%E6%8F%92%E4%BB%B6/" rel="tag">UTS 插件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vite/" rel="tag">Vite</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue-3/" rel="tag">Vue 3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue-Router/" rel="tag">Vue Router</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue3/" rel="tag">Vue3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebAuthn/" rel="tag">WebAuthn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/composable/" rel="tag">composable</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rollup-plugin-visualizer/" rel="tag">rollup-plugin-visualizer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/store%E8%AF%B7%E6%B1%82/" rel="tag">store请求</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uni-app-x/" rel="tag">uni-app x</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%80%E9%94%AE%E7%9B%B4%E7%99%BB/" rel="tag">一键直登</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%8B%E8%BD%BD/" rel="tag">下载</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E7%B1%BB/" rel="tag">分类</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%9D%E5%A7%8B%E5%8C%96/" rel="tag">初始化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF/" rel="tag">前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E6%9E%B6%E6%9E%84/" rel="tag">前端架构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%AF%E4%BD%9C%E7%94%A8%E6%8E%A7%E5%88%B6/" rel="tag">副作用控制</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%9A%E5%AE%A2/" rel="tag">博客</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%A7%E5%8E%82%E5%AE%9E%E8%B7%B5/" rel="tag">大厂实践</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%89%93%E5%8C%85%E5%88%86%E6%9E%90/" rel="tag">打包分析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%AA%E7%99%BB%E5%BD%95%E6%8B%A6%E6%88%AA/" rel="tag">未登录拦截</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%9B%AE%E5%BD%95/" rel="tag">目录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95/" rel="tag">退出登录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%89%B4%E6%9D%83/" rel="tag">鉴权</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/401/" style="font-size: 10px;">401</a> <a href="/tags/AbortController/" style="font-size: 10px;">AbortController</a> <a href="/tags/Axios/" style="font-size: 20px;">Axios</a> <a href="/tags/Fetch/" style="font-size: 10px;">Fetch</a> <a href="/tags/GitHub-Pages/" style="font-size: 15px;">GitHub Pages</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/MSW/" style="font-size: 10px;">MSW</a> <a href="/tags/NexT/" style="font-size: 10px;">NexT</a> <a href="/tags/OpenAPI/" style="font-size: 10px;">OpenAPI</a> <a href="/tags/Passkeys/" style="font-size: 10px;">Passkeys</a> <a href="/tags/Pinia/" style="font-size: 20px;">Pinia</a> <a href="/tags/TanStack-Query/" style="font-size: 10px;">TanStack Query</a> <a href="/tags/TypeScript/" style="font-size: 20px;">TypeScript</a> <a href="/tags/UTS-%E6%8F%92%E4%BB%B6/" style="font-size: 10px;">UTS 插件</a> <a href="/tags/Vite/" style="font-size: 10px;">Vite</a> <a href="/tags/Vue-3/" style="font-size: 10px;">Vue 3</a> <a href="/tags/Vue-Router/" style="font-size: 10px;">Vue Router</a> <a href="/tags/Vue3/" style="font-size: 15px;">Vue3</a> <a href="/tags/WebAuthn/" style="font-size: 10px;">WebAuthn</a> <a href="/tags/composable/" style="font-size: 10px;">composable</a> <a href="/tags/rollup-plugin-visualizer/" style="font-size: 10px;">rollup-plugin-visualizer</a> <a href="/tags/store%E8%AF%B7%E6%B1%82/" style="font-size: 10px;">store请求</a> <a href="/tags/uni-app-x/" style="font-size: 10px;">uni-app x</a> <a href="/tags/%E4%B8%80%E9%94%AE%E7%9B%B4%E7%99%BB/" style="font-size: 10px;">一键直登</a> <a href="/tags/%E4%B8%8B%E8%BD%BD/" style="font-size: 10px;">下载</a> <a href="/tags/%E5%88%86%E7%B1%BB/" style="font-size: 10px;">分类</a> <a href="/tags/%E5%88%9D%E5%A7%8B%E5%8C%96/" style="font-size: 10px;">初始化</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 10px;">前端</a> <a href="/tags/%E5%89%8D%E7%AB%AF%E6%9E%B6%E6%9E%84/" style="font-size: 10px;">前端架构</a> <a href="/tags/%E5%89%AF%E4%BD%9C%E7%94%A8%E6%8E%A7%E5%88%B6/" style="font-size: 10px;">副作用控制</a> <a href="/tags/%E5%8D%9A%E5%AE%A2/" style="font-size: 10px;">博客</a> <a href="/tags/%E5%A4%A7%E5%8E%82%E5%AE%9E%E8%B7%B5/" style="font-size: 10px;">大厂实践</a> <a href="/tags/%E6%89%93%E5%8C%85%E5%88%86%E6%9E%90/" style="font-size: 10px;">打包分析</a> <a href="/tags/%E6%9C%AA%E7%99%BB%E5%BD%95%E6%8B%A6%E6%88%AA/" style="font-size: 10px;">未登录拦截</a> <a href="/tags/%E7%9B%AE%E5%BD%95/" style="font-size: 10px;">目录</a> <a href="/tags/%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95/" style="font-size: 10px;">退出登录</a> <a href="/tags/%E9%89%B4%E6%9D%83/" style="font-size: 10px;">鉴权</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/09/">September 2025</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/09/07/id-kit%E5%BC%80%E5%8F%91/">id-kit开发</a>
          </li>
        
          <li>
            <a href="/2025/09/07/id-kit/">id-kit</a>
          </li>
        
          <li>
            <a href="/2025/09/07/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2025/09/06/%E7%99%BB%E5%BD%95%E5%90%8E%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E5%8F%8C%E9%98%B6%E6%AE%B5%E5%90%AF%E5%8A%A8%EF%BC%88%E5%A2%9E%E9%87%8F%E4%BF%AE%E6%94%B9%EF%BC%89/">在 composable 里“公共初始化 + 登录后初始化”的双阶段启动（增量修改）</a>
          </li>
        
          <li>
            <a href="/2025/09/06/%E4%BD%93%E7%A7%AF%E5%88%86%E5%B8%83%E5%88%86%E6%9E%90%E5%9B%BE/">Vite + Vue3 打包后如何查看“体积分布分析图”</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>