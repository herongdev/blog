<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://herongdev.github.io/blog/page/3/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://herongdev.github.io/blog"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-web应用开发-前端-Web-应用如何做到实时消息通知" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/05/web%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91-%E5%89%8D%E7%AB%AF-Web-%E5%BA%94%E7%94%A8%E5%A6%82%E4%BD%95%E5%81%9A%E5%88%B0%E5%AE%9E%E6%97%B6%E6%B6%88%E6%81%AF%E9%80%9A%E7%9F%A5/" class="article-date">
  <time class="dt-published" datetime="2025-09-05T14:10:20.000Z" itemprop="datePublished">2025-09-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/05/web%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91-%E5%89%8D%E7%AB%AF-Web-%E5%BA%94%E7%94%A8%E5%A6%82%E4%BD%95%E5%81%9A%E5%88%B0%E5%AE%9E%E6%97%B6%E6%B6%88%E6%81%AF%E9%80%9A%E7%9F%A5/">web应用开发/前端/Web 应用如何做到实时消息通知</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <hr>
<p>title: Web 应用如何做到“实时消息通知”<br>date: 2025-09-05<br>categories: [Web 实时通讯, 架构设计]<br>tags: [WebSocket, SSE, Web Push, 长轮询, 消息队列, Redis, 可用性, 安全]<br>description: 面向前端&#x2F;全栈开发者，从选型到最小可行代码，教你在 Web 应用中实现稳定的实时消息通知。</p>
<hr>
<h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><p><strong>目标</strong>：在浏览器里第一时间看到来自服务端的新消息（聊天、新订单、系统告警等）。<br><strong>常见方案</strong>：</p>
<ul>
<li><strong>WebSocket</strong>：全双工、低延迟、最通用。</li>
<li><strong>SSE（Server-Sent Events）</strong>：服务端到客户端的单向推送，轻量、易用。</li>
<li><strong>长轮询（Long Polling）</strong>：兼容性最佳的兜底方案。</li>
<li><strong>Web Push（Service Worker）</strong>：浏览器级推送，页面不在前台也能收到（需用户同意）。</li>
</ul>
<p><strong>快速选型</strong>（简表）：</p>
<table>
<thead>
<tr>
<th>需求&#x2F;约束</th>
<th>推荐</th>
</tr>
</thead>
<tbody><tr>
<td>双向通信（聊天&#x2F;协作）</td>
<td><strong>WebSocket</strong></td>
</tr>
<tr>
<td>只下行推送、需超轻量</td>
<td><strong>SSE</strong></td>
</tr>
<tr>
<td>公司网络&#x2F;代理限制 WS</td>
<td><strong>SSE 或 长轮询</strong></td>
</tr>
<tr>
<td>需离线&#x2F;后台通知</td>
<td><strong>Web Push</strong></td>
</tr>
<tr>
<td>海量连接、水平扩展</td>
<td><strong>WS + Redis Pub&#x2F;Sub 或 MQ</strong></td>
</tr>
<tr>
<td>服务端易实现、兼容老后端</td>
<td><strong>长轮询</strong></td>
</tr>
</tbody></table>
<hr>
<h1 id="实现思路（一图流）"><a href="#实现思路（一图流）" class="headerlink" title="实现思路（一图流）"></a>实现思路（一图流）</h1><ol>
<li><strong>连接层</strong>：浏览器（WS&#x2F;SSE&#x2F;HTTP） ↔ 反向代理（Nginx&#x2F;Ingress） ↔ <strong>推送网关服务</strong></li>
<li><strong>消息路由层</strong>：<strong>Redis Pub&#x2F;Sub &#x2F; Kafka &#x2F; RabbitMQ</strong> 做 fan-out 与广播</li>
<li><strong>业务层</strong>：订单&#x2F;聊天&#x2F;告警服务把事件写入 <strong>消息总线</strong></li>
<li><strong>状态与可靠性</strong>：在线用户表、订阅关系、<strong>Ack&#x2F;重试&#x2F;幂等</strong>、<strong>断线重连</strong>、<strong>心跳</strong>、<strong>权限校验</strong></li>
</ol>
<hr>
<h1 id="分步实践"><a href="#分步实践" class="headerlink" title="分步实践"></a>分步实践</h1><h2 id="方案一：WebSocket（最通用）"><a href="#方案一：WebSocket（最通用）" class="headerlink" title="方案一：WebSocket（最通用）"></a>方案一：WebSocket（最通用）</h2><h3 id="最小可行后端（Node-js-ws）"><a href="#最小可行后端（Node-js-ws）" class="headerlink" title="最小可行后端（Node.js + ws）"></a>最小可行后端（Node.js + <code>ws</code>）</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：保存连接、鉴权、心跳、按用户分组转发</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">WebSocketServer</span> &#125; <span class="keyword">from</span> <span class="string">&quot;ws&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> jwt <span class="keyword">from</span> <span class="string">&quot;jsonwebtoken&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> wss = <span class="keyword">new</span> <span class="title class_">WebSocketServer</span>(&#123; <span class="attr">port</span>: <span class="number">8080</span> &#125;);</span><br><span class="line"><span class="keyword">const</span> clients = <span class="keyword">new</span> <span class="title class_">Map</span>(); <span class="comment">// userId -&gt; Set&lt;ws&gt;</span></span><br><span class="line"></span><br><span class="line">wss.<span class="title function_">on</span>(<span class="string">&quot;connection&quot;</span>, <span class="function">(<span class="params">ws, req</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 复杂逻辑：从 ?token= 解析并校验用户身份</span></span><br><span class="line">  <span class="keyword">const</span> token = <span class="keyword">new</span> <span class="title function_">URL</span>(req.<span class="property">url</span>, <span class="string">&quot;http://x&quot;</span>).<span class="property">searchParams</span>.<span class="title function_">get</span>(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">  <span class="keyword">let</span> userId = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    userId = jwt.<span class="title function_">verify</span>(token, process.<span class="property">env</span>.<span class="property">JWT_SECRET</span>).<span class="property">sub</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    ws.<span class="title function_">close</span>();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!clients.<span class="title function_">has</span>(userId)) clients.<span class="title function_">set</span>(userId, <span class="keyword">new</span> <span class="title class_">Set</span>());</span><br><span class="line">  clients.<span class="title function_">get</span>(userId).<span class="title function_">add</span>(ws);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 复杂逻辑：心跳保活，清理僵尸连接</span></span><br><span class="line">  ws.<span class="property">isAlive</span> = <span class="literal">true</span>;</span><br><span class="line">  ws.<span class="title function_">on</span>(<span class="string">&quot;pong&quot;</span>, <span class="function">() =&gt;</span> (ws.<span class="property">isAlive</span> = <span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line">  ws.<span class="title function_">on</span>(<span class="string">&quot;message&quot;</span>, <span class="function">(<span class="params">buf</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 这里可处理客户端上行，如已读回执/输入中状态</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  ws.<span class="title function_">on</span>(<span class="string">&quot;close&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    clients.<span class="title function_">get</span>(userId).<span class="title function_">delete</span>(ws);</span><br><span class="line">    <span class="keyword">if</span> (clients.<span class="title function_">get</span>(userId).<span class="property">size</span> === <span class="number">0</span>) clients.<span class="title function_">delete</span>(userId);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复杂逻辑：定时 ping</span></span><br><span class="line"><span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  wss.<span class="property">clients</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">ws</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!ws.<span class="property">isAlive</span>) <span class="keyword">return</span> ws.<span class="title function_">terminate</span>();</span><br><span class="line">    ws.<span class="property">isAlive</span> = <span class="literal">false</span>;</span><br><span class="line">    ws.<span class="title function_">ping</span>();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;, <span class="number">30000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例：向某用户推送</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">pushToUser</span>(<span class="params">userId, payload</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> set = clients.<span class="title function_">get</span>(userId);</span><br><span class="line">  <span class="keyword">if</span> (!set) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">const</span> msg = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(payload);</span><br><span class="line">  set.<span class="title function_">forEach</span>(<span class="function">(<span class="params">ws</span>) =&gt;</span> ws.<span class="property">readyState</span> === ws.<span class="property">OPEN</span> &amp;&amp; ws.<span class="title function_">send</span>(msg));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="前端最小连接封装（浏览器）"><a href="#前端最小连接封装（浏览器）" class="headerlink" title="前端最小连接封装（浏览器）"></a>前端最小连接封装（浏览器）</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：自动重连、指数退避、前台/后台状态感知</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createWsClient</span>(<span class="params">urlWithToken, onMsg</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> ws,</span><br><span class="line">    retry = <span class="number">0</span>,</span><br><span class="line">    timer;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">connect</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    ws = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(urlWithToken);</span><br><span class="line">    ws.<span class="property">onopen</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      retry = <span class="number">0</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    ws.<span class="property">onmessage</span> = <span class="function">(<span class="params">e</span>) =&gt;</span> <span class="title function_">onMsg</span>(<span class="title class_">JSON</span>.<span class="title function_">parse</span>(e.<span class="property">data</span>));</span><br><span class="line">    ws.<span class="property">onclose</span> = <span class="function">() =&gt;</span> <span class="title function_">scheduleReconnect</span>();</span><br><span class="line">    ws.<span class="property">onerror</span> = <span class="function">() =&gt;</span> ws.<span class="title function_">close</span>();</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">scheduleReconnect</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="built_in">clearTimeout</span>(timer);</span><br><span class="line">    <span class="keyword">const</span> delay = <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="number">30000</span>, <span class="number">1000</span> * <span class="number">2</span> ** retry++);</span><br><span class="line">    timer = <span class="built_in">setTimeout</span>(connect, delay);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 复杂逻辑：页面隐藏时减小重连频率</span></span><br><span class="line">  <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;visibilitychange&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">hidden</span> &amp;&amp; ws?.<span class="property">readyState</span> !== <span class="title class_">WebSocket</span>.<span class="property">OPEN</span>) &#123;</span><br><span class="line">      retry = <span class="title class_">Math</span>.<span class="title function_">max</span>(retry, <span class="number">4</span>); <span class="comment">// 慢一些</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">connect</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">clearTimeout</span>(timer);</span><br><span class="line">    ws?.<span class="title function_">close</span>();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Nginx-反代（启用-WS-协议升级）"><a href="#Nginx-反代（启用-WS-协议升级）" class="headerlink" title="Nginx 反代（启用 WS 协议升级）"></a>Nginx 反代（启用 WS 协议升级）</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 复杂逻辑：确保 upgrade 头转发</span></span><br><span class="line"><span class="section">location</span> /ws/ &#123;</span><br><span class="line">  <span class="attribute">proxy_pass</span> http://realtime:8080;</span><br><span class="line">  <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">  <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">  <span class="attribute">proxy_set_header</span> Connection <span class="string">&quot;upgrade&quot;</span>;</span><br><span class="line">  <span class="attribute">proxy_read_timeout</span> <span class="number">60s</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="方案二：SSE（Server-Sent-Events，轻量下行推送）"><a href="#方案二：SSE（Server-Sent-Events，轻量下行推送）" class="headerlink" title="方案二：SSE（Server-Sent Events，轻量下行推送）"></a>方案二：SSE（Server-Sent Events，轻量下行推送）</h2><h3 id="后端（Node-js-Express）"><a href="#后端（Node-js-Express）" class="headerlink" title="后端（Node.js + Express）"></a>后端（Node.js + Express）</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：SSE 连接池、心跳注释行、按用户推送</span></span><br><span class="line"><span class="keyword">import</span> express <span class="keyword">from</span> <span class="string">&quot;express&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> jwt <span class="keyword">from</span> <span class="string">&quot;jsonwebtoken&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"><span class="keyword">const</span> streams = <span class="keyword">new</span> <span class="title class_">Map</span>(); <span class="comment">// userId -&gt; res</span></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&quot;/sse&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> token = req.<span class="property">query</span>.<span class="property">token</span>;</span><br><span class="line">  <span class="keyword">let</span> userId;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    userId = jwt.<span class="title function_">verify</span>(token, process.<span class="property">env</span>.<span class="property">JWT_SECRET</span>).<span class="property">sub</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">sendStatus</span>(<span class="number">401</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  res.<span class="title function_">set</span>(&#123;</span><br><span class="line">    <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;text/event-stream&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Cache-Control&quot;</span>: <span class="string">&quot;no-cache&quot;</span>,</span><br><span class="line">    <span class="title class_">Connection</span>: <span class="string">&quot;keep-alive&quot;</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  res.<span class="title function_">flushHeaders</span>();</span><br><span class="line">  streams.<span class="title function_">set</span>(userId, res);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 复杂逻辑：心跳，防止中间设备断开</span></span><br><span class="line">  <span class="keyword">const</span> hb = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> res.<span class="title function_">write</span>(<span class="string">&quot;:hb\n\n&quot;</span>), <span class="number">25000</span>);</span><br><span class="line"></span><br><span class="line">  req.<span class="title function_">on</span>(<span class="string">&quot;close&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">clearInterval</span>(hb);</span><br><span class="line">    streams.<span class="title function_">delete</span>(userId);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">ssePush</span>(<span class="params">userId, data</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> res = streams.<span class="title function_">get</span>(userId);</span><br><span class="line">  <span class="keyword">if</span> (!res) <span class="keyword">return</span>;</span><br><span class="line">  res.<span class="title function_">write</span>(<span class="string">`data: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(data)&#125;</span>\n\n`</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">8081</span>);</span><br></pre></td></tr></table></figure>

<h3 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：SSE 自动重连由浏览器原生完成</span></span><br><span class="line"><span class="keyword">const</span> ev = <span class="keyword">new</span> <span class="title class_">EventSource</span>(<span class="string">`/sse?token=<span class="subst">$&#123;<span class="built_in">encodeURIComponent</span>(token)&#125;</span>`</span>);</span><br><span class="line">ev.<span class="property">onmessage</span> = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> payload = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(e.<span class="property">data</span>);</span><br><span class="line">  <span class="comment">// 渲染消息</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>何时用 SSE</strong>：仅需服务端 → 浏览器推送（如系统广播、价格&#x2F;进度更新），无需上行交互；在某些企业代理&#x2F;防火墙下比 WS 更稳定。</p>
<hr>
<h2 id="方案三：长轮询（兼容兜底）"><a href="#方案三：长轮询（兼容兜底）" class="headerlink" title="方案三：长轮询（兼容兜底）"></a>方案三：长轮询（兼容兜底）</h2><h3 id="后端（Koa-Express-任意）"><a href="#后端（Koa-Express-任意）" class="headerlink" title="后端（Koa&#x2F;Express 任意）"></a>后端（Koa&#x2F;Express 任意）</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：如果没有新消息就挂起请求，直到有消息或超时</span></span><br><span class="line"><span class="keyword">const</span> waiters = <span class="keyword">new</span> <span class="title class_">Map</span>(); <span class="comment">// userId -&gt; res[]</span></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&quot;/poll&quot;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> userId = <span class="title function_">auth</span>(req); <span class="comment">// 自行实现鉴权</span></span><br><span class="line">  (waiters.<span class="title function_">get</span>(userId) ?? waiters.<span class="title function_">set</span>(userId, []).<span class="title function_">get</span>(userId)).<span class="title function_">push</span>(res);</span><br><span class="line">  req.<span class="built_in">setTimeout</span>(<span class="number">65000</span>); <span class="comment">// 与前端超时一致</span></span><br><span class="line">  req.<span class="title function_">on</span>(<span class="string">&quot;close&quot;</span>, <span class="function">() =&gt;</span> <span class="title function_">cleanup</span>(userId, res));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">notify</span>(<span class="params">userId, payload</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> list = waiters.<span class="title function_">get</span>(userId) || [];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> res <span class="keyword">of</span> list) res.<span class="title function_">json</span>(payload);</span><br><span class="line">  waiters.<span class="title function_">set</span>(userId, []);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="前端-1"><a href="#前端-1" class="headerlink" title="前端"></a>前端</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：递归调用保持“长连接”效果</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">longPoll</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> r = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&quot;/poll&quot;</span>, &#123; <span class="attr">credentials</span>: <span class="string">&quot;include&quot;</span> &#125;);</span><br><span class="line">    <span class="keyword">if</span> (r.<span class="property">ok</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> data = <span class="keyword">await</span> r.<span class="title function_">json</span>();</span><br><span class="line">      <span class="comment">// 处理消息</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (_) &#123;</span><br><span class="line">    <span class="comment">/* 忽略网络错误 */</span></span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(longPoll, <span class="number">100</span>);</span><br><span class="line">  &#125; <span class="comment">// 轻微间隔</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">longPoll</span>();</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="方案四：Web-Push（离线-后台通知）"><a href="#方案四：Web-Push（离线-后台通知）" class="headerlink" title="方案四：Web Push（离线&#x2F;后台通知）"></a>方案四：Web Push（离线&#x2F;后台通知）</h2><blockquote>
<p>适合 <strong>提醒类</strong> 场景：即便用户没打开页面、浏览器在后台，仍可收到通知（需 HTTPS 与用户授权）。</p>
</blockquote>
<h3 id="前端注册-Service-Worker"><a href="#前端注册-Service-Worker" class="headerlink" title="前端注册 Service Worker"></a>前端注册 Service Worker</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：注册 SW 并申请通知权限，然后向后端上报订阅</span></span><br><span class="line"><span class="keyword">const</span> reg = <span class="keyword">await</span> navigator.<span class="property">serviceWorker</span>.<span class="title function_">register</span>(<span class="string">&quot;/sw.js&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> permission = <span class="keyword">await</span> <span class="title class_">Notification</span>.<span class="title function_">requestPermission</span>();</span><br><span class="line"><span class="keyword">if</span> (permission === <span class="string">&quot;granted&quot;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> sub = <span class="keyword">await</span> reg.<span class="property">pushManager</span>.<span class="title function_">subscribe</span>(&#123;</span><br><span class="line">    <span class="attr">userVisibleOnly</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">applicationServerKey</span>: <span class="string">&quot;&lt;VAPID_PUBLIC_KEY_BASE64URL&gt;&quot;</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&quot;/push/subscribe&quot;</span>, &#123; <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>, <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(sub) &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Service-Worker-接收"><a href="#Service-Worker-接收" class="headerlink" title="Service Worker 接收"></a>Service Worker 接收</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：展示系统级通知</span></span><br><span class="line">self.<span class="title function_">addEventListener</span>(<span class="string">&quot;push&quot;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> data = e.<span class="property">data</span>?.<span class="title function_">json</span>() ?? &#123;&#125;;</span><br><span class="line">  e.<span class="title function_">waitUntil</span>(</span><br><span class="line">    self.<span class="property">registration</span>.<span class="title function_">showNotification</span>(data.<span class="property">title</span> || <span class="string">&quot;通知&quot;</span>, &#123;</span><br><span class="line">      <span class="attr">body</span>: data.<span class="property">body</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="后端发送（Node-js-web-push）"><a href="#后端发送（Node-js-web-push）" class="headerlink" title="后端发送（Node.js + web-push）"></a>后端发送（Node.js + web-push）</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：使用 VAPID 签名向浏览器推送</span></span><br><span class="line"><span class="keyword">import</span> webpush <span class="keyword">from</span> <span class="string">&quot;web-push&quot;</span>;</span><br><span class="line">webpush.<span class="title function_">setVapidDetails</span>(</span><br><span class="line">  <span class="string">&quot;mailto:admin@example.com&quot;</span>,</span><br><span class="line">  <span class="variable constant_">VAPID_PUBLIC</span>,</span><br><span class="line">  <span class="variable constant_">VAPID_PRIVATE</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// subs 为持久化的订阅列表</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sendPush</span>(<span class="params">sub, payload</span>) &#123;</span><br><span class="line">  <span class="keyword">await</span> webpush.<span class="title function_">sendNotification</span>(sub, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(payload));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="可扩展与高可用"><a href="#可扩展与高可用" class="headerlink" title="可扩展与高可用"></a>可扩展与高可用</h1><ul>
<li><strong>水平扩展</strong>：WS&#x2F;SSE 多实例时，用 <strong>Redis Pub&#x2F;Sub</strong> 或 <strong>消息队列（Kafka&#x2F;RabbitMQ）</strong> 做广播&#x2F;定向投递。</li>
<li><strong>在线表&#x2F;路由</strong>：<code>userId -&gt; connectionIds</code>（内存 + Redis）。</li>
<li><strong>可靠性</strong>：业务消息落库 → 推送 → 客户端 <strong>Ack</strong> → 未 Ack 重试；<strong>消息去重键</strong> 防止重复渲染。</li>
<li><strong>断线重连</strong>：客户端带 <strong>上次 offset&#x2F;lastId</strong> 续传（SSE 原生有 <code>Last-Event-ID</code>）。</li>
<li><strong>背压控制</strong>：批量合并（coalesce）、节流；超大消息用链接拉取。</li>
<li><strong>监控告警</strong>：连接数、发送量、队列堆积、投递耗时、重试率、失败率。</li>
</ul>
<hr>
<h1 id="安全与合规"><a href="#安全与合规" class="headerlink" title="安全与合规"></a>安全与合规</h1><ul>
<li><strong>鉴权</strong>：连接时附带 <strong>短期 JWT</strong>，服务端校验与续期；不同通道（WS&#x2F;SSE&#x2F;HTTP）统一鉴权层。</li>
<li><strong>权限</strong>：服务端二次校验资源访问（不要把 topic 名称当权限）。</li>
<li><strong>限流</strong>：IP &#x2F; 用户 &#x2F; 通道维度限速；异常断开与重连风暴保护。</li>
<li><strong>加密</strong>：HTTPS&#x2F;WSS；敏感字段服务端脱敏。</li>
<li><strong>审计</strong>：关键通知落库，包含投递结果与阅读状态。</li>
</ul>
<hr>
<h1 id="最简“端到端”范例清单"><a href="#最简“端到端”范例清单" class="headerlink" title="最简“端到端”范例清单"></a>最简“端到端”范例清单</h1><blockquote>
<p>你可以基于此快速拼装生产可用的实时通知：</p>
</blockquote>
<ol>
<li><strong>连接层</strong>：WebSocket（上面 Node + <code>ws</code> 代码）</li>
<li><strong>消息总线</strong>：Redis（<code>PUBLISH notifications:user:123 &#123;...&#125;</code>）</li>
<li><strong>业务写入</strong>：订单服务下单成功 → 发布事件</li>
<li><strong>推送网关</strong>：订阅 Redis 通道 → <code>pushToUser(userId, payload)</code></li>
<li><strong>前端</strong>：<code>createWsClient</code> 接收 → 写入本地状态&#x2F;弹出提醒</li>
<li><strong>兜底</strong>：前端检测 WS 不可用则回退 SSE&#x2F;长轮询</li>
<li><strong>离线补充</strong>：允许用户开启 Web Push 作后台提醒</li>
</ol>
<hr>
<h1 id="常见坑与排错"><a href="#常见坑与排错" class="headerlink" title="常见坑与排错"></a>常见坑与排错</h1><ul>
<li><strong>公司代理挡 WS</strong>：优先尝试 <strong>SSE</strong>；Nginx&#x2F;Ingress 需正确配置 <code>Upgrade/Connection</code>。</li>
<li><strong>连接泄漏</strong>：记得 <strong>清理 close</strong> 事件、设置 <strong>心跳</strong>。</li>
<li><strong>消息乱序&#x2F;重复</strong>：加入 <strong>自增 offset &#x2F; 事件时间戳 &#x2F; 幂等键</strong>。</li>
<li><strong>大房间广播</strong>：用 <strong>频道广播 + 客户端过滤</strong> 或 <strong>服务端分片广播</strong>。</li>
<li><strong>移动网络切换</strong>：重连后用 <strong>lastId</strong> 请求增量补齐。</li>
</ul>
<hr>
<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><ul>
<li><strong>单点小流量</strong>：直接 <strong>SSE 或 WS</strong> 即可。</li>
<li><strong>中大型&#x2F;海量</strong>：<strong>WS + Redis&#x2F;MQ</strong>，加上 <strong>Ack&#x2F;重试&#x2F;幂等&#x2F;监控</strong>。</li>
<li><strong>提醒类</strong>：配上 <strong>Web Push</strong>，覆盖离线&#x2F;后台。</li>
</ul>
<p>需要我结合你现有技术栈（如 Next.js、Spring Boot、NestJS、Redis、Kafka）给出<strong>最小改造的落地方案</strong>和<strong>只改动的代码片段</strong>吗？我可以按你的项目结构直接贴可替换的文件&#x2F;增量修改。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/05/web%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91-%E5%89%8D%E7%AB%AF-Web-%E5%BA%94%E7%94%A8%E5%A6%82%E4%BD%95%E5%81%9A%E5%88%B0%E5%AE%9E%E6%97%B6%E6%B6%88%E6%81%AF%E9%80%9A%E7%9F%A5/" data-id="cmf9bdhkl000nqq4z8tyz6385" data-title="web应用开发/前端/Web 应用如何做到实时消息通知" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-requirement-realization-1" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/05/requirement-realization-1/" class="article-date">
  <time class="dt-published" datetime="2025-09-05T00:54:31.000Z" itemprop="datePublished">2025-09-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/05/requirement-realization-1/">已登录用户的“绑定通行密钥”最佳实践：把唯一标识安全传给后端（含前后端完整实现）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <hr>
<p>title: 已登录用户的“绑定通行密钥”最佳实践：把唯一标识安全传给后端（含前后端完整实现）<br>date: 2025-09-05<br>tags:</p>
<ul>
<li>Passkeys</li>
<li>WebAuthn</li>
<li>账号绑定</li>
<li>设备唯一</li>
</ul>
<hr>
<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>当<strong>用户已经登录（本地有 JWT&#x2F;token）<strong>时，常见需求是“<strong>再绑定一把通行密钥</strong>”（或在新设备上补绑）。本文给出一个</strong>稳妥的一次点击方案</strong>：</p>
<ul>
<li>前端：带上 <strong>Authorization: Bearer &lt;token&gt;</strong> 与 <strong>X-Device-Id（设备唯一码）</strong> 请求 <code>/passkeys/register/options</code>。</li>
<li>浏览器完成 <code>navigator.credentials.create(...)</code> 后，将结果 + <code>deviceIdentifier</code> 回传 <code>/passkeys/register/verify</code>。</li>
<li>后端：从 <strong>token 解析 userId</strong>，生成&#x2F;校验 challenge、<strong>入库凭证</strong>，并执行<strong>设备唯一绑定</strong>（<code>deviceId -&gt; userId</code>）。</li>
</ul>
<blockquote>
<p>关键点：<strong>不要尝试枚举本地是否已有凭证</strong>；隐私模型不允许。登录态下的“绑定”其实就是“已知用户的注册流程”。</p>
</blockquote>
<hr>
<h2 id="设计要点"><a href="#设计要点" class="headerlink" title="设计要点"></a>设计要点</h2><ul>
<li><strong>用户唯一标识</strong>：后端<strong>不靠前端传 userId</strong>，而是从 <strong>JWT</strong> 中解析（<code>sub</code>）→ 更安全。</li>
<li><strong>设备唯一</strong>：前端生成&#x2F;缓存 <code>deviceId</code>，通过 <code>X-Device-Id</code> 头传给后端；后端使用 <code>dvc:owner:$&#123;deviceId&#125;</code> 在 Redis 做“一致性绑定”。</li>
<li><strong>防重复注册</strong>：注册 options 中使用 <code>excludeCredentials</code>（由后端查询该用户已绑定的 credentialId）。</li>
<li><strong>风控与速率限制</strong>：对 <code>deviceId</code> 做限流（如 1h&#x2F;3 次），并在 verify 阶段二次校验。</li>
<li><strong>协议对齐</strong>：保持与登录&#x2F;JIT 注册完全相同的编码规范（字节字段统一 <strong>base64url</strong>）。</li>
</ul>
<hr>
<h2 id="前端实现（Web）"><a href="#前端实现（Web）" class="headerlink" title="前端实现（Web）"></a>前端实现（Web）</h2><blockquote>
<p>仅新增<strong>一个按钮事件</strong>用于“绑定通行密钥”。代码自包含；把 <code>BASE_URL</code> 改成你的后端地址即可。<br>复杂逻辑均在上一行写注释。</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 你的页面按钮 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn-bind-passkey&quot;</span>&gt;</span>绑定通行密钥<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">pre</span></span></span><br><span class="line"><span class="tag">  <span class="attr">id</span>=<span class="string">&quot;log&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">style</span>=<span class="string">&quot;background:#111;color:#9f9;padding:12px;white-space:pre-wrap&quot;</span></span></span><br><span class="line"><span class="tag">&gt;</span><span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// ========= 工具：设备ID与 base64url 转换 =========</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">getDeviceId</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> id = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&quot;device_id&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (!id) &#123;</span></span><br><span class="line"><span class="language-javascript">      id =</span></span><br><span class="line"><span class="language-javascript">        crypto?.<span class="property">randomUUID</span>?.() ||</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&quot;dev-&quot;</span> + <span class="title class_">Date</span>.<span class="title function_">now</span>() + <span class="string">&quot;-&quot;</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">slice</span>(<span class="number">2</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&quot;device_id&quot;</span>, id);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> id;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">b64urlToBuf</span>(<span class="params">b64url</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> pad = <span class="string">&quot;=&quot;</span>.<span class="title function_">repeat</span>((<span class="number">4</span> - (b64url.<span class="property">length</span> % <span class="number">4</span>)) % <span class="number">4</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> b64 = (b64url + pad).<span class="title function_">replace</span>(<span class="regexp">/-/g</span>, <span class="string">&quot;+&quot;</span>).<span class="title function_">replace</span>(<span class="regexp">/_/g</span>, <span class="string">&quot;/&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> bin = <span class="title function_">atob</span>(b64);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(bin.<span class="property">length</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> view = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(buf);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; bin.<span class="property">length</span>; i++) view[i] = bin.<span class="title function_">charCodeAt</span>(i);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> buf;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">bufToB64url</span>(<span class="params">buf</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> bytes = buf <span class="keyword">instanceof</span> <span class="title class_">ArrayBuffer</span> ? <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(buf) : buf;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> s = <span class="string">&quot;&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; bytes.<span class="property">length</span>; i++) s += <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(bytes[i]);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> <span class="title function_">btoa</span>(s).<span class="title function_">replace</span>(<span class="regexp">/\+/g</span>, <span class="string">&quot;-&quot;</span>).<span class="title function_">replace</span>(<span class="regexp">/\//g</span>, <span class="string">&quot;_&quot;</span>).<span class="title function_">replace</span>(<span class="regexp">/=+$/g</span>, <span class="string">&quot;&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 复杂：把 CreationOptions 中的 base64url → ArrayBuffer</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">toCreationOptions</span>(<span class="params">serverOpts</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> opts = <span class="title function_">structuredClone</span>(serverOpts);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (<span class="keyword">typeof</span> opts.<span class="property">challenge</span> === <span class="string">&quot;string&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">      opts.<span class="property">challenge</span> = <span class="title function_">b64urlToBuf</span>(opts.<span class="property">challenge</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (opts.<span class="property">user</span> &amp;&amp; <span class="keyword">typeof</span> opts.<span class="property">user</span>.<span class="property">id</span> === <span class="string">&quot;string&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">      opts.<span class="property">user</span>.<span class="property">id</span> = <span class="title function_">b64urlToBuf</span>(opts.<span class="property">user</span>.<span class="property">id</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(opts.<span class="property">excludeCredentials</span>)) &#123;</span></span><br><span class="line"><span class="language-javascript">      opts.<span class="property">excludeCredentials</span> = opts.<span class="property">excludeCredentials</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">c</span>) =&gt;</span> (&#123;</span></span><br><span class="line"><span class="language-javascript">        ...c,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">id</span>: <span class="title function_">b64urlToBuf</span>(c.<span class="property">id</span>),</span></span><br><span class="line"><span class="language-javascript">      &#125;));</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> opts;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 复杂：将 create() 结果打包为后端可校验的 JSON（统一 base64url）</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">packAttestation</span>(<span class="params">cred</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">id</span>: cred.<span class="property">id</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">rawId</span>: <span class="title function_">bufToB64url</span>(cred.<span class="property">rawId</span>),</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">type</span>: cred.<span class="property">type</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">response</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">clientDataJSON</span>: <span class="title function_">bufToB64url</span>(cred.<span class="property">response</span>.<span class="property">clientDataJSON</span>),</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">attestationObject</span>: <span class="title function_">bufToB64url</span>(cred.<span class="property">response</span>.<span class="property">attestationObject</span>),</span></span><br><span class="line"><span class="language-javascript">      &#125;,</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">clientExtensionResults</span>: cred.<span class="property">getClientExtensionResults</span>?.() || &#123;&#125;,</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 复杂：通用 POST，附带 token 与设备ID</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">postJSON</span>(<span class="params">url, body, token</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">fetch</span>(url, &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">credentials</span>: <span class="string">&quot;include&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">headers</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&quot;content-type&quot;</span>: <span class="string">&quot;application/json&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&quot;X-Device-Id&quot;</span>: <span class="title function_">getDeviceId</span>(), <span class="comment">// 设备唯一</span></span></span><br><span class="line"><span class="language-javascript">        ...(token ? &#123; <span class="title class_">Authorization</span>: <span class="string">`Bearer <span class="subst">$&#123;token&#125;</span>`</span> &#125; : &#123;&#125;), <span class="comment">// 已登录用户必带</span></span></span><br><span class="line"><span class="language-javascript">      &#125;,</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(body || &#123;&#125;),</span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (!res.<span class="property">ok</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`<span class="subst">$&#123;res.status&#125;</span> <span class="subst">$&#123;res.statusText&#125;</span>`</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> res.<span class="title function_">json</span>();</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// ========= 绑定入口：用户已登录（本地有 token） =========</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> <span class="variable constant_">BASE_URL</span> = <span class="string">&quot;&quot;</span>; <span class="comment">// 同源可留空；跨域改成你的后端地址</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">getToken</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 复杂：示例从 localStorage 取；实际按你的项目来源（Cookie/JWT 管理方案）</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(<span class="string">&quot;token&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">bindPasskey</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> <span class="title function_">log</span> = (<span class="params">m</span>) =&gt;</span></span><br><span class="line"><span class="language-javascript">      (<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&quot;log&quot;</span></span></span><br><span class="line"><span class="language-javascript">      ).<span class="property">textContent</span> += <span class="string">`[<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().toLocaleTimeString()&#125;</span>] <span class="subst">$&#123;m&#125;</span>\n`</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> token = <span class="title function_">getToken</span>();</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (!token) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">log</span>(<span class="string">&quot;未登录：请先登录再绑定&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">return</span>;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// 复杂：步骤1——向后端请求“注册（绑定）options”，后端将从 JWT 解析 userId</span></span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">log</span>(<span class="string">&quot;请求 /passkeys/register/options ...&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">postJSON</span>(</span></span><br><span class="line"><span class="language-javascript">        <span class="string">`<span class="subst">$&#123;BASE_URL&#125;</span>/passkeys/register/options`</span>,</span></span><br><span class="line"><span class="language-javascript">        &#123;&#125;,</span></span><br><span class="line"><span class="language-javascript">        token</span></span><br><span class="line"><span class="language-javascript">      );</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> serverOptions = data.<span class="property">options</span> || data; <span class="comment">// 兼容返回形态</span></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> publicKey = <span class="title function_">toCreationOptions</span>(serverOptions);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// 复杂：步骤2——发起浏览器创建凭据</span></span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">log</span>(<span class="string">&quot;调用 navigator.credentials.create ...&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> att = <span class="keyword">await</span> navigator.<span class="property">credentials</span>.<span class="title function_">create</span>(&#123; publicKey &#125;);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="comment">// 复杂：步骤3——打包 + 回传 verify，并带上 deviceIdentifier 以完成设备唯一绑定</span></span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">log</span>(<span class="string">&quot;提交 /passkeys/register/verify ...&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> verifyBody = &#123;</span></span><br><span class="line"><span class="language-javascript">        ...<span class="title function_">packAttestation</span>(att),</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">deviceIdentifier</span>: <span class="title function_">getDeviceId</span>(),</span></span><br><span class="line"><span class="language-javascript">      &#125;;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">const</span> verifyResp = <span class="keyword">await</span> <span class="title function_">postJSON</span>(</span></span><br><span class="line"><span class="language-javascript">        <span class="string">`<span class="subst">$&#123;BASE_URL&#125;</span>/passkeys/register/verify`</span>,</span></span><br><span class="line"><span class="language-javascript">        verifyBody,</span></span><br><span class="line"><span class="language-javascript">        token</span></span><br><span class="line"><span class="language-javascript">      );</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">log</span>(<span class="string">&quot;绑定完成 ✅ &quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(verifyResp));</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">alert</span>(<span class="string">&quot;通行密钥绑定成功&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125; <span class="keyword">catch</span> (e) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">console</span>.<span class="title function_">error</span>(e);</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">alert</span>(<span class="string">&quot;绑定失败：&quot;</span> + (e?.<span class="property">message</span> || e));</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 绑定按钮点击</span></span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">document</span></span></span><br><span class="line"><span class="language-javascript">    .<span class="title function_">getElementById</span>(<span class="string">&quot;btn-bind-passkey&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">    ?.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, bindPasskey);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>若你在 <strong>uni-app</strong>（H5）里使用，也可沿用同样逻辑；在 <strong>App（UTS 插件）</strong> 上只需把 <code>navigator.credentials.create</code> 替换为你的 <code>passkeys.createPasskey(optionsJson)</code> 即可，其余协议不变。</p>
</blockquote>
<hr>
<h2 id="后端实现（NestJS，仅给“增量-改动片段”）"><a href="#后端实现（NestJS，仅给“增量-改动片段”）" class="headerlink" title="后端实现（NestJS，仅给“增量&#x2F;改动片段”）"></a>后端实现（NestJS，仅给“增量&#x2F;改动片段”）</h2><blockquote>
<p>你的工程里已有 JIT 与登录接口。这里<strong>新增&#x2F;完善</strong>“<strong>已登录的注册（绑定）</strong>”两个端点，并对 Service 增强<strong>按 token 解析 user</strong> 与<strong>设备唯一</strong>。</p>
</blockquote>
<h3 id="1）Controller-片段"><a href="#1）Controller-片段" class="headerlink" title="1）Controller 片段"></a>1）Controller 片段</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂：新增“已登录绑定”端点；依赖 JWT 守卫把 user 注入 request.user</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Controller</span>, <span class="title class_">Post</span>, <span class="title class_">Req</span>, <span class="title class_">UseGuards</span>, <span class="title class_">Body</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AuthGuard</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/passport&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PasskeysService</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../../services/passkeys.service&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">&quot;passkeys&quot;</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">PasskeysController</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> <span class="attr">passkeysService</span>: <span class="title class_">PasskeysService</span></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 复杂：注册（绑定）options——登录态</span></span><br><span class="line">  <span class="meta">@UseGuards</span>(<span class="title class_">AuthGuard</span>(<span class="string">&quot;jwt&quot;</span>))</span><br><span class="line">  <span class="meta">@Post</span>(<span class="string">&quot;register/options&quot;</span>)</span><br><span class="line">  <span class="title function_">getBindOptions</span>(<span class="params"><span class="meta">@Req</span>() <span class="attr">req</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="comment">// 复杂：设备ID从 Header/Cookie/IP 提取，用于风控与后续绑定一致性</span></span><br><span class="line">    <span class="keyword">const</span> deviceIdentifier =</span><br><span class="line">      req.<span class="property">headers</span>[<span class="string">&quot;x-device-id&quot;</span>] || req.<span class="property">cookies</span>?.<span class="property">dvc</span> || <span class="string">`ip:<span class="subst">$&#123;req.ip&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">const</span> userId = req.<span class="property">user</span>?.<span class="property">sub</span>; <span class="comment">// 复杂：从 JWT 解析出的 userId</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">passkeysService</span>.<span class="title function_">issueRegistrationOptionsForUser</span>(</span><br><span class="line">      userId,</span><br><span class="line">      deviceIdentifier</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 复杂：注册（绑定）verify——登录态</span></span><br><span class="line">  <span class="meta">@UseGuards</span>(<span class="title class_">AuthGuard</span>(<span class="string">&quot;jwt&quot;</span>))</span><br><span class="line">  <span class="meta">@Post</span>(<span class="string">&quot;register/verify&quot;</span>)</span><br><span class="line">  <span class="title function_">verifyBind</span>(<span class="params"><span class="meta">@Req</span>() <span class="attr">req</span>: <span class="built_in">any</span>, <span class="meta">@Body</span>() <span class="attr">body</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> deviceIdentifier =</span><br><span class="line">      req.<span class="property">headers</span>[<span class="string">&quot;x-device-id&quot;</span>] ||</span><br><span class="line">      body.<span class="property">deviceIdentifier</span> ||</span><br><span class="line">      req.<span class="property">cookies</span>?.<span class="property">dvc</span> ||</span><br><span class="line">      <span class="string">`ip:<span class="subst">$&#123;req.ip&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">const</span> userId = req.<span class="property">user</span>?.<span class="property">sub</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">passkeysService</span>.<span class="title function_">verifyRegistrationForUser</span>(</span><br><span class="line">      userId,</span><br><span class="line">      body,</span><br><span class="line">      deviceIdentifier</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2）Service-片段"><a href="#2）Service-片段" class="headerlink" title="2）Service 片段"></a>2）Service 片段</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂：为“已登录绑定”增加两个方法</span></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">PasskeysService</span> &#123;</span><br><span class="line">  <span class="comment">// ... 省略已有依赖与构造</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 复杂：签发已登录用户的注册 options（含 excludeCredentials 与限流）</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">issueRegistrationOptionsForUser</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">userId</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">deviceIdentifier</span>?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!userId) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnauthorizedException</span>(<span class="string">&quot;未登录&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复杂：限流（1h/3次）</span></span><br><span class="line">    <span class="keyword">if</span> (deviceIdentifier) &#123;</span><br><span class="line">      <span class="keyword">const</span> rlKey = <span class="string">`rl:bind:<span class="subst">$&#123;deviceIdentifier&#125;</span>`</span>;</span><br><span class="line">      <span class="keyword">const</span> n = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">redisService</span>.<span class="title function_">incrementKey</span>(rlKey);</span><br><span class="line">      <span class="keyword">if</span> (n === <span class="number">1</span>) <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">redisService</span>.<span class="title function_">expireKey</span>(rlKey, <span class="number">3600</span>);</span><br><span class="line">      <span class="keyword">if</span> (n &gt; <span class="number">3</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadRequestException</span>(<span class="string">&quot;操作过于频繁，请稍后再试&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> rpId = <span class="variable language_">this</span>.<span class="property">configService</span>.<span class="property">get</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;RP_ID&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复杂：查询该用户已有凭证，构造 excludeCredentials 防重复注册</span></span><br><span class="line">    <span class="keyword">const</span> existing = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">staffService</span>.<span class="title function_">findManyCredentialsByUserId</span>(</span><br><span class="line">      userId</span><br><span class="line">    ); <span class="comment">// 需要你实现查询</span></span><br><span class="line">    <span class="keyword">const</span> exclude = (existing || []).<span class="title function_">map</span>(<span class="function">(<span class="params"><span class="attr">c</span>: <span class="built_in">any</span></span>) =&gt;</span> (&#123;</span><br><span class="line">      <span class="attr">id</span>: <span class="title class_">Buffer</span>.<span class="title function_">from</span>(c.<span class="property">credentialId</span>, <span class="string">&quot;base64url&quot;</span>),</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&quot;public-key&quot;</span> <span class="keyword">as</span> <span class="keyword">const</span>,</span><br><span class="line">    &#125;));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> options = <span class="keyword">await</span> <span class="title function_">generateRegistrationOptions</span>(&#123;</span><br><span class="line">      <span class="attr">rpName</span>: <span class="string">&quot;Your App&quot;</span>,</span><br><span class="line">      <span class="attr">rpID</span>: rpId,</span><br><span class="line">      <span class="comment">// 复杂：v11+ 要求 userID 为字节；这里直接用 UTF-8 Buffer</span></span><br><span class="line">      <span class="attr">userID</span>: <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="title class_">String</span>(userId), <span class="string">&quot;utf8&quot;</span>),</span><br><span class="line">      <span class="attr">userName</span>: <span class="title class_">String</span>(userId),</span><br><span class="line">      <span class="attr">attestationType</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">      <span class="comment">// 复杂：兼容性更好（ES256 + RS256）</span></span><br><span class="line">      <span class="attr">supportedAlgorithmIDs</span>: [-<span class="number">7</span>, -<span class="number">257</span>],</span><br><span class="line">      <span class="attr">authenticatorSelection</span>: &#123;</span><br><span class="line">        <span class="attr">residentKey</span>: <span class="string">&quot;required&quot;</span>, <span class="comment">// 复杂：要求可发现凭证，便于后续一键直登</span></span><br><span class="line">        <span class="attr">userVerification</span>: <span class="string">&quot;preferred&quot;</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">excludeCredentials</span>: exclude,</span><br><span class="line">      <span class="attr">extensions</span>: &#123; <span class="attr">credProps</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复杂：将 challenge(base64url) 与 user 绑定，TTL 5 分钟</span></span><br><span class="line">    <span class="keyword">const</span> ch =</span><br><span class="line">      <span class="keyword">typeof</span> options.<span class="property">challenge</span> === <span class="string">&quot;string&quot;</span></span><br><span class="line">        ? options.<span class="property">challenge</span></span><br><span class="line">        : <span class="title class_">Buffer</span>.<span class="title function_">from</span>(options.<span class="property">challenge</span>).<span class="title function_">toString</span>(<span class="string">&quot;base64url&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">redisService</span>.<span class="title function_">setWithTimeToLive</span>(</span><br><span class="line">      <span class="string">`webauthn:register:<span class="subst">$&#123;userId&#125;</span>`</span>,</span><br><span class="line">      ch,</span><br><span class="line">      <span class="number">300</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; options &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 复杂：校验 attestation + 入库 + 设备唯一绑定（不重新发 token，也可选择刷新）</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">verifyRegistrationForUser</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="attr">userId</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">requestBody</span>: <span class="built_in">any</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">deviceIdentifier</span>?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!userId) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnauthorizedException</span>(<span class="string">&quot;未登录&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> rpId = <span class="variable language_">this</span>.<span class="property">configService</span>.<span class="property">get</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;RP_ID&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> origin = <span class="variable language_">this</span>.<span class="property">configService</span>.<span class="property">get</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;ORIGIN&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> cachedChallenge = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">redisService</span>.<span class="title function_">getValue</span>(</span><br><span class="line">      <span class="string">`webauthn:register:<span class="subst">$&#123;userId&#125;</span>`</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (!cachedChallenge)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadRequestException</span>(<span class="string">&quot;注册挑战不存在或已过期&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> verification = <span class="keyword">await</span> <span class="title function_">verifyRegistrationResponse</span>(&#123;</span><br><span class="line">      <span class="attr">response</span>: requestBody,</span><br><span class="line">      <span class="attr">expectedRPID</span>: rpId,</span><br><span class="line">      <span class="attr">expectedOrigin</span>: origin,</span><br><span class="line">      <span class="attr">expectedChallenge</span>: cachedChallenge,</span><br><span class="line">      <span class="attr">requireUserVerification</span>: <span class="literal">true</span>, <span class="comment">// 复杂：绑定建议要求 UV</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!verification.<span class="property">verified</span> || !verification.<span class="property">registrationInfo</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnauthorizedException</span>(<span class="string">&quot;注册校验失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; credential &#125; = verification.<span class="property">registrationInfo</span>;</span><br><span class="line">    <span class="keyword">const</span> credentialIdB64url = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(credential.<span class="property">id</span>).<span class="title function_">toString</span>(<span class="string">&quot;base64url&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> publicKey = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(credential.<span class="property">publicKey</span>); <span class="comment">// 存二进制或 base64 皆可</span></span><br><span class="line">    <span class="keyword">const</span> counter = credential.<span class="property">counter</span> ?? <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复杂：入库（若同 credentialId 已存在且属同人，可忽略/幂等）</span></span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">staffService</span>.<span class="title function_">upsertCredential</span>(&#123;</span><br><span class="line">      userId,</span><br><span class="line">      <span class="attr">credentialId</span>: credentialIdB64url,</span><br><span class="line">      publicKey,</span><br><span class="line">      counter,</span><br><span class="line">      <span class="attr">transports</span>: credential.<span class="property">transports</span></span><br><span class="line">        ? <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(credential.<span class="property">transports</span>)</span><br><span class="line">        : <span class="literal">null</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复杂：设备唯一绑定（若存在 deviceId 且已被他人占用，则拒绝）</span></span><br><span class="line">    <span class="keyword">if</span> (deviceIdentifier) &#123;</span><br><span class="line">      <span class="keyword">const</span> key = <span class="string">`dvc:owner:<span class="subst">$&#123;deviceIdentifier&#125;</span>`</span>;</span><br><span class="line">      <span class="keyword">const</span> existed = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">redisService</span>.<span class="title function_">getValue</span>(key);</span><br><span class="line">      <span class="keyword">if</span> (existed &amp;&amp; existed !== <span class="title class_">String</span>(userId)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ForbiddenException</span>(<span class="string">&quot;此设备已绑定其他账号&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 绑定一年（或不设 TTL）</span></span><br><span class="line">      <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">redisService</span>.<span class="title function_">setWithTimeToLive</span>(key, <span class="title class_">String</span>(userId), <span class="number">31536000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">redisService</span>.<span class="title function_">deleteKey</span>(<span class="string">`webauthn:register:<span class="subst">$&#123;userId&#125;</span>`</span>);</span><br><span class="line">    <span class="comment">// 已登录状态下可不必重签 token；如需刷新可在此签新 JWT</span></span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">verified</span>: <span class="literal">true</span>, userId, <span class="attr">credentialId</span>: credentialIdB64url &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>你只需要实现（或补齐）<code>staffService.findManyCredentialsByUserId</code> 与 <code>upsertCredential</code> 两个数据存取方法；字段即你现有的 <code>credentialId/publicKey/counter/transports/userId</code>。</p>
</blockquote>
<hr>
<h2 id="时序对照（已登录绑定）"><a href="#时序对照（已登录绑定）" class="headerlink" title="时序对照（已登录绑定）"></a>时序对照（已登录绑定）</h2><ol>
<li>前端带 <strong>Authorization</strong> 与 <strong>X-Device-Id</strong> → <code>POST /passkeys/register/options</code></li>
<li>后端从 <strong>JWT</strong> 取 <code>userId</code>，构造 <strong>excludeCredentials</strong>，保存 <strong>challenge</strong></li>
<li>前端调用 <strong><code>navigator.credentials.create(&#123; publicKey &#125;)</code></strong></li>
<li>前端回传 <strong>attestation + deviceIdentifier</strong> → <code>/passkeys/register/verify</code></li>
<li>后端 <strong>verify + 入库 + 设备唯一绑定</strong> → 返回 <code>&#123; verified: true, userId &#125;</code></li>
</ol>
<hr>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><ul>
<li><p><strong>为什么不让前端直接传 userId？</strong><br>防止伪造。登录态下应以 <strong>Authorization</strong> 为准，由后端解析身份。</p>
</li>
<li><p><strong>若用户已绑定过此设备，再次点击绑定会怎样？</strong><br>由于 <code>excludeCredentials</code> 与 <code>dvc:owner:*</code> 绑定同时生效，<strong>不会重复写入</strong>；可返回幂等成功或提示“已绑定”。</p>
</li>
<li><p><strong>如何与一键直登&#x2F;JIT 流程共存？</strong></p>
<ul>
<li><strong>未登录</strong>：走 <code>/login/options</code> → 失败回退 <code>/register-or-login/*</code>。</li>
<li><strong>已登录</strong>：走本文 <code>/register/*</code>（绑定专用）。两套互不冲突。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><ul>
<li><strong>唯一标识传递</strong>：已登录场景下，把 <strong>用户身份交给 JWT</strong>，把 <strong>设备唯一交给 <code>X-Device-Id</code></strong>。</li>
<li><strong>绑定即注册</strong>：本质是“已知用户”的注册流程；用 <code>excludeCredentials</code> 防重复，用 Redis 绑定 <code>deviceId -&gt; userId</code>。</li>
<li><strong>最少交互</strong>：一次点击完成整个绑定，协议与登录&#x2F;JIT 完全一致，维护成本低。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/05/requirement-realization-1/" data-id="cmf9bdhki000gqq4z52sr6n9v" data-title="已登录用户的“绑定通行密钥”最佳实践：把唯一标识安全传给后端（含前后端完整实现）" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-requirement-realization" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/05/requirement-realization/" class="article-date">
  <time class="dt-published" datetime="2025-09-05T00:21:16.000Z" itemprop="datePublished">2025-09-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/05/requirement-realization/">Web 端一键通行密钥：点击按钮后“先登录，失败再注册”的完整实现</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <hr>
<p>title: Web 端一键通行密钥：点击按钮后“先登录，失败再注册”的完整实现<br>date: 2025-09-05<br>tags:</p>
<ul>
<li>Passkeys</li>
<li>WebAuthn</li>
<li>前端实战</li>
<li>一键直登</li>
</ul>
<hr>
<h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>本文给出 <strong>Web 端</strong> 的最小可用实现：<strong>点击一个按钮 → 优先尝试登录（可发现凭证）→ 若无可用凭证或用户取消，则自动走 JIT 注册并直接登录</strong>。<br>重点说明：“<strong>不能事先枚举本地是否存在凭据</strong>”（浏览器出于隐私不允许），正确姿势是<strong>拿到服务端的 options 再调用 WebAuthn</strong>，并对失败分支做平滑回退。</p>
<hr>
<h2 id="背景与原则"><a href="#背景与原则" class="headerlink" title="背景与原则"></a>背景与原则</h2><ul>
<li>浏览器不会暴露“本地是否已有你家 RP 的通行密钥”的枚举 API（防侧信道追踪）。</li>
<li>正确流程永远是：<strong>后端发 options（含 challenge）→ 前端发起 <code>get()</code>&#x2F;<code>create()</code> → 前端把回包交给后端 <code>verify</code></strong>。</li>
<li>若想“先感知再决定”，只能做<strong>能力探测</strong>（如 <code>isConditionalMediationAvailable()</code>、<code>isUserVerifyingPlatformAuthenticatorAvailable()</code>），但这<strong>不等于</strong>“确有凭据”。</li>
<li>因此，本实现直接：<strong>先请求登录 options</strong> → <code>navigator.credentials.get</code> → 失败则 <strong>请求注册 options</strong> → <code>navigator.credentials.create</code> → 验证成功后<strong>注册即登录</strong>。</li>
</ul>
<hr>
<h2 id="交互时序（简述）"><a href="#交互时序（简述）" class="headerlink" title="交互时序（简述）"></a>交互时序（简述）</h2><ol>
<li>用户点击「一键登录」按钮</li>
<li>前端 <code>POST /passkeys/login/options</code>（携带 <code>X-Device-Id</code>）</li>
<li>浏览器 <code>navigator.credentials.get(&#123; publicKey, mediation &#125;)</code></li>
<li>成功 → 回传 <code>/passkeys/login/verify</code> → <strong>登录完成</strong></li>
<li>失败（无匹配凭据&#x2F;取消等）→ <code>POST /passkeys/register-or-login/options</code></li>
<li><code>navigator.credentials.create(&#123; publicKey &#125;)</code></li>
<li>回传 <code>/passkeys/register-or-login/verify</code> → <strong>注册并登录完成</strong></li>
</ol>
<hr>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><blockquote>
<p>下面给出<strong>可直接粘贴落地</strong>的最小实现（HTML + JS）。<br>复杂逻辑的上一行均有中文注释。<br>假设你的后端路由与本文一致：</p>
<ul>
<li><code>/passkeys/login/options</code>、<code>/passkeys/login/verify</code></li>
<li><code>/passkeys/register-or-login/options</code>、<code>/passkeys/register-or-login/verify</code></li>
</ul>
</blockquote>
<h3 id="1）页面与按钮"><a href="#1）页面与按钮" class="headerlink" title="1）页面与按钮"></a>1）页面与按钮</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- index.html 片段：按钮与日志面板 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn-passkey&quot;</span>&gt;</span>一键通行密钥<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">pre</span></span></span><br><span class="line"><span class="tag">  <span class="attr">id</span>=<span class="string">&quot;log&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">style</span>=<span class="string">&quot;background:#111;color:#9f9;padding:12px;white-space:pre-wrap&quot;</span></span></span><br><span class="line"><span class="tag">&gt;</span><span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span> <span class="attr">src</span>=<span class="string">&quot;./passkeys-web.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2）前端模块：passkeys-web-js"><a href="#2）前端模块：passkeys-web-js" class="headerlink" title="2）前端模块：passkeys-web.js"></a>2）前端模块：<code>passkeys-web.js</code></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ======================= 基础工具 =======================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 复杂：生成稳定的设备ID（首访生成并持久化，用于设备→账号绑定与风控）</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getDeviceId</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> key = <span class="string">&quot;device_id&quot;</span>;</span><br><span class="line">  <span class="keyword">let</span> id = <span class="variable language_">localStorage</span>.<span class="title function_">getItem</span>(key);</span><br><span class="line">  <span class="keyword">if</span> (!id) &#123;</span><br><span class="line">    id =</span><br><span class="line">      crypto?.<span class="property">randomUUID</span>?.() ||</span><br><span class="line">      <span class="string">&quot;dev-&quot;</span> + <span class="title class_">Date</span>.<span class="title function_">now</span>() + <span class="string">&quot;-&quot;</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">slice</span>(<span class="number">2</span>);</span><br><span class="line">    <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(key, id);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复杂：base64url ↔ ArrayBuffer 转换，确保与后端统一</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">b64urlToBuf</span>(<span class="params">b64url</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> pad = <span class="string">&quot;=&quot;</span>.<span class="title function_">repeat</span>((<span class="number">4</span> - (b64url.<span class="property">length</span> % <span class="number">4</span>)) % <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">const</span> b64 = (b64url + pad).<span class="title function_">replace</span>(<span class="regexp">/-/g</span>, <span class="string">&quot;+&quot;</span>).<span class="title function_">replace</span>(<span class="regexp">/_/g</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> str = <span class="title function_">atob</span>(b64);</span><br><span class="line">  <span class="keyword">const</span> buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(str.<span class="property">length</span>);</span><br><span class="line">  <span class="keyword">const</span> view = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(buf);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; str.<span class="property">length</span>; i++) view[i] = str.<span class="title function_">charCodeAt</span>(i);</span><br><span class="line">  <span class="keyword">return</span> buf;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bufToB64url</span>(<span class="params">buf</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> bytes = buf <span class="keyword">instanceof</span> <span class="title class_">ArrayBuffer</span> ? <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(buf) : buf;</span><br><span class="line">  <span class="keyword">let</span> str = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; bytes.<span class="property">length</span>; i++) str += <span class="title class_">String</span>.<span class="title function_">fromCharCode</span>(bytes[i]);</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">btoa</span>(str).<span class="title function_">replace</span>(<span class="regexp">/\+/g</span>, <span class="string">&quot;-&quot;</span>).<span class="title function_">replace</span>(<span class="regexp">/\//g</span>, <span class="string">&quot;_&quot;</span>).<span class="title function_">replace</span>(<span class="regexp">/=+$/g</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复杂：把 AuthenticationOptions 中的 base64url 字段转 ArrayBuffer</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">toWebAuthnRequestOptions</span>(<span class="params">serverOpts</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> opts = <span class="title function_">structuredClone</span>(serverOpts);</span><br><span class="line">  <span class="comment">// challenge 需要转 ArrayBuffer</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> opts.<span class="property">challenge</span> === <span class="string">&quot;string&quot;</span>)</span><br><span class="line">    opts.<span class="property">challenge</span> = <span class="title function_">b64urlToBuf</span>(opts.<span class="property">challenge</span>);</span><br><span class="line">  <span class="comment">// allowCredentials 中的 id 也需要转 ArrayBuffer</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(opts.<span class="property">allowCredentials</span>)) &#123;</span><br><span class="line">    opts.<span class="property">allowCredentials</span> = opts.<span class="property">allowCredentials</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">c</span>) =&gt;</span> (&#123;</span><br><span class="line">      ...c,</span><br><span class="line">      <span class="attr">id</span>: <span class="keyword">typeof</span> c.<span class="property">id</span> === <span class="string">&quot;string&quot;</span> ? <span class="title function_">b64urlToBuf</span>(c.<span class="property">id</span>) : c.<span class="property">id</span>,</span><br><span class="line">    &#125;));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> opts;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复杂：把 RegistrationOptions 中的 base64url 字段转 ArrayBuffer/Uint8Array</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">toWebAuthnCreationOptions</span>(<span class="params">serverOpts</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> opts = <span class="title function_">structuredClone</span>(serverOpts);</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> opts.<span class="property">challenge</span> === <span class="string">&quot;string&quot;</span>)</span><br><span class="line">    opts.<span class="property">challenge</span> = <span class="title function_">b64urlToBuf</span>(opts.<span class="property">challenge</span>);</span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">user</span> &amp;&amp; <span class="keyword">typeof</span> opts.<span class="property">user</span>.<span class="property">id</span> === <span class="string">&quot;string&quot;</span>)</span><br><span class="line">    opts.<span class="property">user</span>.<span class="property">id</span> = <span class="title function_">b64urlToBuf</span>(opts.<span class="property">user</span>.<span class="property">id</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(opts.<span class="property">excludeCredentials</span>)) &#123;</span><br><span class="line">    opts.<span class="property">excludeCredentials</span> = opts.<span class="property">excludeCredentials</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">c</span>) =&gt;</span> (&#123;</span><br><span class="line">      ...c,</span><br><span class="line">      <span class="attr">id</span>: <span class="keyword">typeof</span> c.<span class="property">id</span> === <span class="string">&quot;string&quot;</span> ? <span class="title function_">b64urlToBuf</span>(c.<span class="property">id</span>) : c.<span class="property">id</span>,</span><br><span class="line">    &#125;));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> opts;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复杂：把 get() 结果打包成后端可验证的 JSON（按 WebAuthn 规范，全用 base64url）</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">packAssertion</span>(<span class="params">cred</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> resp = cred.<span class="property">response</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">id</span>: cred.<span class="property">id</span>,</span><br><span class="line">    <span class="attr">rawId</span>: <span class="title function_">bufToB64url</span>(cred.<span class="property">rawId</span>),</span><br><span class="line">    <span class="attr">type</span>: cred.<span class="property">type</span>,</span><br><span class="line">    <span class="attr">response</span>: &#123;</span><br><span class="line">      <span class="attr">clientDataJSON</span>: <span class="title function_">bufToB64url</span>(resp.<span class="property">clientDataJSON</span>),</span><br><span class="line">      <span class="attr">authenticatorData</span>: <span class="title function_">bufToB64url</span>(resp.<span class="property">authenticatorData</span>),</span><br><span class="line">      <span class="attr">signature</span>: <span class="title function_">bufToB64url</span>(resp.<span class="property">signature</span>),</span><br><span class="line">      <span class="attr">userHandle</span>: resp.<span class="property">userHandle</span> ? <span class="title function_">bufToB64url</span>(resp.<span class="property">userHandle</span>) : <span class="literal">null</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">clientExtensionResults</span>: cred.<span class="property">getClientExtensionResults</span>?.() || &#123;&#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复杂：把 create() 结果打包成后端可验证的 JSON（按 WebAuthn 规范，全用 base64url）</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">packAttestation</span>(<span class="params">cred</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> resp = cred.<span class="property">response</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">id</span>: cred.<span class="property">id</span>,</span><br><span class="line">    <span class="attr">rawId</span>: <span class="title function_">bufToB64url</span>(cred.<span class="property">rawId</span>),</span><br><span class="line">    <span class="attr">type</span>: cred.<span class="property">type</span>,</span><br><span class="line">    <span class="attr">response</span>: &#123;</span><br><span class="line">      <span class="attr">clientDataJSON</span>: <span class="title function_">bufToB64url</span>(resp.<span class="property">clientDataJSON</span>),</span><br><span class="line">      <span class="attr">attestationObject</span>: <span class="title function_">bufToB64url</span>(resp.<span class="property">attestationObject</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">clientExtensionResults</span>: cred.<span class="property">getClientExtensionResults</span>?.() || &#123;&#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复杂：通用 POST 封装，自动带上设备ID</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">postJSON</span>(<span class="params">url, body</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">fetch</span>(url, &#123;</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">      <span class="string">&quot;content-type&quot;</span>: <span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">      <span class="comment">// 设备ID写入 Header，便于后端风控/设备绑定。后端也可从 body 读取。</span></span><br><span class="line">      <span class="string">&quot;X-Device-Id&quot;</span>: <span class="title function_">getDeviceId</span>(),</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(body || &#123;&#125;),</span><br><span class="line">    <span class="attr">credentials</span>: <span class="string">&quot;include&quot;</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">if</span> (!res.<span class="property">ok</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`<span class="subst">$&#123;res.status&#125;</span> <span class="subst">$&#123;res.statusText&#125;</span>`</span>);</span><br><span class="line">  <span class="keyword">return</span> res.<span class="title function_">json</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复杂：检测“条件UI”与平台验证器可用性（仅做能力判断，不代表一定有凭据）</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">detectSupport</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> hasWebAuthn = <span class="string">&quot;PublicKeyCredential&quot;</span> <span class="keyword">in</span> <span class="variable language_">window</span>;</span><br><span class="line">  <span class="keyword">let</span> conditional = <span class="literal">false</span>,</span><br><span class="line">    uvpa = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    conditional =</span><br><span class="line">      !!(<span class="keyword">await</span> <span class="title class_">PublicKeyCredential</span>.<span class="property">isConditionalMediationAvailable</span>?.());</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    uvpa =</span><br><span class="line">      !!(<span class="keyword">await</span> <span class="title class_">PublicKeyCredential</span>.<span class="property">isUserVerifyingPlatformAuthenticatorAvailable</span>?.());</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; hasWebAuthn, conditional, uvpa &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ======================= 业务主流程 =======================</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 复杂：优先尝试登录（可发现凭证/或定向 allowCredentials）；失败则自动转注册并登录</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">oneTapPasskey</span>(<span class="params">baseUrl = <span class="string">&quot;&quot;</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">log</span> = (<span class="params">msg</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> pre = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;log&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pre) pre.<span class="property">textContent</span> += <span class="string">`[<span class="subst">$&#123;<span class="keyword">new</span> <span class="built_in">Date</span>().toLocaleTimeString()&#125;</span>] <span class="subst">$&#123;msg&#125;</span>\n`</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(msg);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> deviceId = <span class="title function_">getDeviceId</span>();</span><br><span class="line">  <span class="keyword">const</span> &#123; hasWebAuthn, conditional, uvpa &#125; = <span class="keyword">await</span> <span class="title function_">detectSupport</span>();</span><br><span class="line">  <span class="keyword">if</span> (!hasWebAuthn) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;当前环境不支持 WebAuthn&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">log</span>(<span class="string">`检测：conditional=<span class="subst">$&#123;conditional&#125;</span>, uvpa=<span class="subst">$&#123;uvpa&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// ========== 步骤A：请求“登录 options” ==========</span></span><br><span class="line">    <span class="title function_">log</span>(<span class="string">&quot;请求登录 options...&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> loginOptsResp = <span class="keyword">await</span> <span class="title function_">postJSON</span>(<span class="string">`<span class="subst">$&#123;baseUrl&#125;</span>/passkeys/login/options`</span>, &#123;</span><br><span class="line">      <span class="attr">deviceIdentifier</span>: deviceId,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> requestOptions = loginOptsResp.<span class="property">options</span> || loginOptsResp; <span class="comment">// 兼容你的返回结构</span></span><br><span class="line">    <span class="keyword">const</span> publicKey = <span class="title function_">toWebAuthnRequestOptions</span>(requestOptions);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复杂：若支持条件UI，则 mediation 设为 &#x27;conditional&#x27;；否则 &#x27;required&#x27;（需用户手势）</span></span><br><span class="line">    <span class="keyword">const</span> mediation = conditional ? <span class="string">&quot;conditional&quot;</span> : <span class="string">&quot;required&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 步骤B：发起 credentials.get ==========</span></span><br><span class="line">    <span class="title function_">log</span>(<span class="string">`调用 navigator.credentials.get (mediation=<span class="subst">$&#123;mediation&#125;</span>)...`</span>);</span><br><span class="line">    <span class="keyword">const</span> assertion = <span class="keyword">await</span> navigator.<span class="property">credentials</span>.<span class="title function_">get</span>(&#123; publicKey, mediation &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 步骤C：打包并回传后端校验 ==========</span></span><br><span class="line">    <span class="title function_">log</span>(<span class="string">&quot;提交登录 verify...&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> verifyBody = <span class="title function_">packAssertion</span>(assertion);</span><br><span class="line">    <span class="keyword">const</span> verifyResp = <span class="keyword">await</span> <span class="title function_">postJSON</span>(</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;baseUrl&#125;</span>/passkeys/login/verify`</span>,</span><br><span class="line">      verifyBody</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="title function_">log</span>(<span class="string">&quot;登录成功 ✅ &quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(verifyResp));</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">mode</span>: <span class="string">&quot;login&quot;</span>, <span class="attr">result</span>: verifyResp &#125;;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="comment">// 复杂：常见失败 1）用户取消 2）设备没有匹配凭据 3）options 过期</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&quot;登录失败，准备转注册：&quot;</span>, err);</span><br><span class="line">    <span class="comment">// ========== 步骤D：请求“一键注册 options” ==========</span></span><br><span class="line">    <span class="keyword">const</span> regOptsResp = <span class="keyword">await</span> <span class="title function_">postJSON</span>(</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;baseUrl&#125;</span>/passkeys/register-or-login/options`</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">deviceIdentifier</span>: deviceId,</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">const</span> &#123; userId, <span class="attr">options</span>: creationOptionsServer &#125; = regOptsResp.<span class="property">userId</span></span><br><span class="line">      ? regOptsResp</span><br><span class="line">      : &#123; <span class="attr">userId</span>: regOptsResp.<span class="property">userId</span>, <span class="attr">options</span>: regOptsResp.<span class="property">options</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> publicKey = <span class="title function_">toWebAuthnCreationOptions</span>(creationOptionsServer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 步骤E：发起 credentials.create（注册） ==========</span></span><br><span class="line">    <span class="title function_">log</span>(<span class="string">&quot;调用 navigator.credentials.create ...&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> attestation = <span class="keyword">await</span> navigator.<span class="property">credentials</span>.<span class="title function_">create</span>(&#123; publicKey &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== 步骤F：打包并回传后端，完成绑定+激活+登录 ==========</span></span><br><span class="line">    <span class="title function_">log</span>(<span class="string">&quot;提交注册 verify...&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> verifyBody = &#123;</span><br><span class="line">      ...<span class="title function_">packAttestation</span>(attestation),</span><br><span class="line">      userId, <span class="comment">// 复杂：JIT 返回的临时/访客 userId</span></span><br><span class="line">      <span class="attr">deviceIdentifier</span>: deviceId, <span class="comment">// 复杂：用于设备→账号唯一绑定</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> verifyResp = <span class="keyword">await</span> <span class="title function_">postJSON</span>(</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;baseUrl&#125;</span>/passkeys/register-or-login/verify`</span>,</span><br><span class="line">      verifyBody</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="title function_">log</span>(<span class="string">&quot;注册并登录成功 ✅ &quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(verifyResp));</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">mode</span>: <span class="string">&quot;register-then-login&quot;</span>, <span class="attr">result</span>: verifyResp &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ======================= 页面挂载：按钮点击即触发 =======================</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;btn-passkey&quot;</span>)?.<span class="title function_">addEventListener</span>(<span class="string">&quot;click&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 复杂：这里的 baseUrl 请改为你的后端地址；同源部署可留空</span></span><br><span class="line">  <span class="title function_">oneTapPasskey</span>(<span class="string">&quot;&quot;</span>).<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> pre = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;log&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (pre) pre.<span class="property">textContent</span> += <span class="string">`❌ <span class="subst">$&#123;e?.message || e&#125;</span>\n`</span>;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(e);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="与后端契约（对齐要点）"><a href="#与后端契约（对齐要点）" class="headerlink" title="与后端契约（对齐要点）"></a>与后端契约（对齐要点）</h2><ul>
<li><p><code>/passkeys/login/options</code></p>
<ul>
<li><strong>入参</strong>：<code>&#123; deviceIdentifier?: string &#125;</code>（Header 也可）</li>
<li><strong>返回</strong>：<code>&#123; options: PublicKeyCredentialRequestOptions &#125;</code>（<code>challenge</code>、<code>allowCredentials[].id</code> 为 <strong>base64url</strong> 字符串）</li>
</ul>
</li>
<li><p><code>/passkeys/login/verify</code></p>
<ul>
<li><strong>入参</strong>：上文 <code>packAssertion()</code> 的结果（所有字节字段 <strong>base64url</strong>）</li>
<li><strong>返回</strong>：<code>&#123; verified: true, token, userId &#125;</code></li>
</ul>
</li>
<li><p><code>/passkeys/register-or-login/options</code></p>
<ul>
<li><strong>入参</strong>：<code>&#123; deviceIdentifier?: string &#125;</code></li>
<li><strong>返回</strong>：<code>&#123; userId: string, options: PublicKeyCredentialCreationOptions &#125;</code>（<code>challenge</code>、<code>user.id</code>、<code>excludeCredentials[].id</code> 为 <strong>base64url</strong>）</li>
</ul>
</li>
<li><p><code>/passkeys/register-or-login/verify</code></p>
<ul>
<li><strong>入参</strong>：<code>packAttestation()</code> + <code>&#123; userId, deviceIdentifier &#125;</code></li>
<li><strong>返回</strong>：<code>&#123; verified: true, token, userId &#125;</code></li>
</ul>
</li>
</ul>
<blockquote>
<p>以上与您现有的 <code>PasskeysService</code> 设计完全兼容。你也可以在“已绑定设备”场景下返回 <code>allowCredentials</code>，以提升命中率（文中已说明）。</p>
</blockquote>
<hr>
<h2 id="常见问题（FAQ）"><a href="#常见问题（FAQ）" class="headerlink" title="常见问题（FAQ）"></a>常见问题（FAQ）</h2><ul>
<li><p><strong>能不能“先看一下本地有没有凭据”，有就登录、没有就不调后端？</strong><br>不能。浏览器不允许枚举凭据。你能做的只是能力探测与<strong>尝试调用</strong> <code>credentials.get</code>。而调用 <code>get/create</code> 都必须先有<strong>服务端下发的 options（含 challenge）</strong>。</p>
</li>
<li><p><strong>什么时候用条件 UI（conditional mediation）？</strong><br>页面加载即拿到 <code>login options</code> 后即可“无提示等候”；但为简化，这里在<strong>按钮点击</strong>后再调，用 <code>mediation=&#39;conditional&#39;</code>（若可用）+ <code>required</code> 作为兜底。</p>
</li>
<li><p><strong>后端 challenge 过期怎么办？</strong><br>统一设置较短 TTL（如 300s），一旦 <code>get/create</code> 抛出 <code>InvalidStateError/NotAllowedError</code>，前端直接重拉 options 再试。</p>
</li>
</ul>
<hr>
<h2 id="测试步骤"><a href="#测试步骤" class="headerlink" title="测试步骤"></a>测试步骤</h2><ol>
<li><strong>HTTPS 环境</strong>部署（本地可用 <code>localhost</code>）</li>
<li><strong>确保后端 RP_ID&#x2F;ORIGIN 正确</strong>、Redis 正常、四个路由可达</li>
<li>首次访问：点击按钮 → 预期走注册 → 后端 verify 成功后返回 token</li>
<li>再次访问：点击按钮 → 直接 <code>get()</code> 登录成功</li>
<li>Android&#x2F;Chrome 测试条件 UI：地址栏出现通行密钥提示；Safari 需同源 HTTPS</li>
</ol>
<hr>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><ul>
<li>“先判断本地是否有凭据”在浏览器上<strong>不可行</strong>；</li>
<li><strong>正确做法</strong>是<strong>每次先拿登录 options</strong>，用 <code>credentials.get</code> 尝试登录；</li>
<li><strong>失败则无缝切到注册</strong>（JIT 建号 + 可发现凭证 + 注册即登录）。</li>
<li>上文代码开箱即用，你只需要把 <code>baseUrl</code> 指向你的后端即可。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/05/requirement-realization/" data-id="cmf9bdhkk000jqq4zb2myecgd" data-title="Web 端一键通行密钥：点击按钮后“先登录，失败再注册”的完整实现" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-requirement-realization-2" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/05/requirement-realization-2/" class="article-date">
  <time class="dt-published" datetime="2025-09-05T00:00:00.000Z" itemprop="datePublished">2025-09-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/05/requirement-realization-2/">在你现有 uvue 登录页集成“一键通行密钥登录”（含回退注册），完整代码可直接替换</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p>把我们讨论的“<strong>先尝试通行密钥登录 → 失败自动回退到 JIT 注册并登录</strong>”接到你这份 <strong>uvue（uni-app x）页面</strong> 上，<strong>保留原有微信登录按钮</strong>，新增一个“通行密钥登录”按钮。<br>支持：</p>
<ul>
<li><strong>App 端（Android&#x2F;iOS）</strong>：走你自定义的 <strong>UTS 插件</strong> <code>@/uni_modules/pass-keys</code>（<code>getPasskey</code>&#x2F;<code>createPasskey</code>）。</li>
<li><strong>H5 端</strong>：走浏览器 WebAuthn（<code>navigator.credentials.get/create</code>）。</li>
<li><strong>设备唯一</strong>：用 <code>deviceIdentifier</code>（App 用 <code>plus.device.uuid</code>，H5 用本地生成）传后端，便于 <code>deviceId -&gt; userId</code> 绑定。</li>
</ul>
<blockquote>
<p>复杂逻辑均在代码<strong>上一行加中文注释</strong>。下面给出<strong>整文件覆盖式代码</strong>（符合你“Passkeys 项目优先给完整文件”的约定）。</p>
</blockquote>
<hr>
<h2 id="完整代码（直接替换你当前页面）"><a href="#完整代码（直接替换你当前页面）" class="headerlink" title="完整代码（直接替换你当前页面）"></a>完整代码（直接替换你当前页面）</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;view class=&quot;container&quot;&gt;</span><br><span class="line">    &lt;view class=&quot;header&quot;&gt;</span><br><span class="line">      &lt;text class=&quot;title&quot;&gt;欢迎使用商户平台&lt;/text&gt;</span><br><span class="line">    &lt;/view&gt;</span><br><span class="line"></span><br><span class="line">    &lt;view v-if=&quot;!baseUrl&quot; class=&quot;tip&quot;&gt;</span><br><span class="line">      &lt;text class=&quot;tip-text&quot;&gt;未配置后端地址，请先配置&lt;/text&gt;</span><br><span class="line">      &lt;button size=&quot;mini&quot; @tap=&quot;openConfig&quot;&gt;去配置&lt;/button&gt;</span><br><span class="line">    &lt;/view&gt;</span><br><span class="line"></span><br><span class="line">    &lt;view class=&quot;actions&quot;&gt;</span><br><span class="line">      &lt;button</span><br><span class="line">        type=&quot;primary&quot;</span><br><span class="line">        :disabled=&quot;!baseUrl || loading&quot;</span><br><span class="line">        @tap=&quot;onWeChatLogin&quot;</span><br><span class="line">      &gt;</span><br><span class="line">        &#123;&#123;</span><br><span class="line">          baseUrl</span><br><span class="line">            ? isWeChatInstalled</span><br><span class="line">              ? &quot;微信登录&quot;</span><br><span class="line">              : &quot;登录&quot;</span><br><span class="line">            : &quot;请先配置后端地址&quot;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      &lt;/button&gt;</span><br><span class="line"></span><br><span class="line">      &lt;!-- 新增：通行密钥一键登录（失败自动回退注册并登录） --&gt;</span><br><span class="line">      &lt;button</span><br><span class="line">        style=&quot;margin-top:12rpx&quot;</span><br><span class="line">        :disabled=&quot;!baseUrl || loading&quot;</span><br><span class="line">        @tap=&quot;onPasskeyLogin&quot;</span><br><span class="line">      &gt;</span><br><span class="line">        &#123;&#123; loading ? &quot;处理中...&quot; : &quot;通行密钥登录&quot; &#125;&#125;</span><br><span class="line">      &lt;/button&gt;</span><br><span class="line">    &lt;/view&gt;</span><br><span class="line"></span><br><span class="line">    &lt;view v-if=&quot;loading&quot; class=&quot;loading-mask&quot;&gt;</span><br><span class="line">      &lt;view class=&quot;loading-box&quot;&gt;&lt;text&gt;处理中...&lt;/text&gt;&lt;/view&gt;</span><br><span class="line">    &lt;/view&gt;</span><br><span class="line"></span><br><span class="line">    &lt;view v-if=&quot;showConfig&quot; class=&quot;modal-mask&quot; @tap=&quot;closeConfig&quot;&gt;</span><br><span class="line">      &lt;view class=&quot;modal&quot; @tap.stop&gt;</span><br><span class="line">        &lt;text class=&quot;modal-title&quot;&gt;配置后端地址&lt;/text&gt;</span><br><span class="line">        &lt;input</span><br><span class="line">          class=&quot;modal-input&quot;</span><br><span class="line">          type=&quot;text&quot;</span><br><span class="line">          v-model=&quot;configInput&quot;</span><br><span class="line">          placeholder=&quot;例如：https://api.example.com&quot;</span><br><span class="line">        /&gt;</span><br><span class="line">        &lt;view class=&quot;modal-actions&quot;&gt;</span><br><span class="line">          &lt;button size=&quot;mini&quot; @tap=&quot;closeConfig&quot;&gt;取消&lt;/button&gt;</span><br><span class="line">          &lt;button type=&quot;primary&quot; size=&quot;mini&quot; @tap=&quot;saveConfig&quot;&gt;保存&lt;/button&gt;</span><br><span class="line">        &lt;/view&gt;</span><br><span class="line">      &lt;/view&gt;</span><br><span class="line">    &lt;/view&gt;</span><br><span class="line">  &lt;/view&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">// #ifdef APP-PLUS</span><br><span class="line">// 复杂逻辑：App 端引入你的 UTS 插件（Android/iOS 调平台原生 Credential/AuthenticationServices）</span><br><span class="line">import * as passkeys from &quot;@/uni_modules/pass-keys&quot;;</span><br><span class="line">// #endif</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      baseUrl: &quot;&quot;,</span><br><span class="line">      loading: false,</span><br><span class="line">      isWeChatInstalled: true,</span><br><span class="line">      showConfig: false,</span><br><span class="line">      configInput: &quot;&quot;,</span><br><span class="line">      // 复杂逻辑：设备唯一标识；App=plus.device.uuid；H5=本地生成并持久化</span><br><span class="line">      deviceId: &quot;&quot;,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  onLoad() &#123;</span><br><span class="line">    this.baseUrl = uni.getStorageSync(&quot;BASE_URL&quot;) || &quot;&quot;;</span><br><span class="line">    // 复杂逻辑：初始化设备ID（用于 deviceId -&gt; userId 绑定与风控）</span><br><span class="line">    // #ifdef APP-PLUS</span><br><span class="line">    this.deviceId =</span><br><span class="line">      plus &amp;&amp; plus.device &amp;&amp; plus.device.uuid</span><br><span class="line">        ? plus.device.uuid</span><br><span class="line">        : &quot;app-&quot; + Date.now();</span><br><span class="line">    // #endif</span><br><span class="line">    // #ifdef H5</span><br><span class="line">    const key = &quot;DEVICE_ID&quot;;</span><br><span class="line">    this.deviceId = localStorage.getItem(key);</span><br><span class="line">    if (!this.deviceId) &#123;</span><br><span class="line">      this.deviceId =</span><br><span class="line">        crypto?.randomUUID?.() ||</span><br><span class="line">        &quot;web-&quot; + Date.now() + &quot;-&quot; + Math.random().toString(16).slice(2);</span><br><span class="line">      localStorage.setItem(key, this.deviceId);</span><br><span class="line">    &#125;</span><br><span class="line">    // #endif</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    openConfig() &#123;</span><br><span class="line">      this.configInput = this.baseUrl;</span><br><span class="line">      this.showConfig = true;</span><br><span class="line">    &#125;,</span><br><span class="line">    closeConfig() &#123;</span><br><span class="line">      this.showConfig = false;</span><br><span class="line">    &#125;,</span><br><span class="line">    saveConfig() &#123;</span><br><span class="line">      this.baseUrl = (this.configInput || &quot;&quot;).trim();</span><br><span class="line">      uni.setStorageSync(&quot;BASE_URL&quot;, this.baseUrl);</span><br><span class="line">      this.showConfig = false;</span><br><span class="line">      uni.showToast(&#123; title: &quot;已保存&quot;, icon: &quot;success&quot; &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    // 复杂逻辑：统一 POST 封装；把 deviceIdentifier 一并传给后端（也可由 Header 传）</span><br><span class="line">    async post(path, body) &#123;</span><br><span class="line">      return await new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">        uni.request(&#123;</span><br><span class="line">          url: `$&#123;this.baseUrl&#125;$&#123;path&#125;`,</span><br><span class="line">          method: &quot;POST&quot;,</span><br><span class="line">          data: &#123; deviceIdentifier: this.deviceId, ...(body || &#123;&#125;) &#125;,</span><br><span class="line">          dataType: &quot;json&quot;,</span><br><span class="line">          header: &#123; &quot;content-type&quot;: &quot;application/json&quot; &#125;,</span><br><span class="line">          success: (res) =&gt; resolve(res.data),</span><br><span class="line">          fail: reject,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    // 保留原有：微信登录</span><br><span class="line">    async onWeChatLogin() &#123;</span><br><span class="line">      if (!this.baseUrl) return;</span><br><span class="line">      this.loading = true;</span><br><span class="line">      try &#123;</span><br><span class="line">        let code = &quot;&quot;;</span><br><span class="line">        // 小程序端获取 code</span><br><span class="line">        // #ifdef MP-WEIXIN</span><br><span class="line">        const res = await new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">          uni.login(&#123; provider: &quot;weixin&quot;, success: resolve, fail: reject &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">        code = res.code || &quot;&quot;;</span><br><span class="line">        // #endif</span><br><span class="line"></span><br><span class="line">        // 其他端未集成微信登录，给出提示</span><br><span class="line">        // #ifndef MP-WEIXIN</span><br><span class="line">        throw new Error(&quot;当前平台未集成微信登录&quot;);</span><br><span class="line">        // #endif</span><br><span class="line"></span><br><span class="line">        if (!code) throw new Error(&quot;获取登录凭证失败&quot;);</span><br><span class="line">        const data = await this.post(&quot;/admin/wechat/login&quot;, &#123; code &#125;);</span><br><span class="line">        if (</span><br><span class="line">          data &amp;&amp;</span><br><span class="line">          data.success === true &amp;&amp;</span><br><span class="line">          data.userInfo &amp;&amp;</span><br><span class="line">          data.userInfo.approved === true &amp;&amp;</span><br><span class="line">          data.userInfo.token</span><br><span class="line">        ) &#123;</span><br><span class="line">          uni.setStorageSync(&quot;TOKEN&quot;, data.userInfo.token);</span><br><span class="line">          uni.showToast(&#123; title: &quot;登录成功&quot;, icon: &quot;success&quot; &#125;);</span><br><span class="line">          setTimeout(() =&gt; &#123;</span><br><span class="line">            uni.reLaunch(&#123; url: &quot;/pages/index/index&quot; &#125;);</span><br><span class="line">          &#125;, 600);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          throw new Error(data?.message || &quot;登录失败&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; catch (e) &#123;</span><br><span class="line">        uni.showToast(&#123; title: e?.message || String(e), icon: &quot;none&quot; &#125;);</span><br><span class="line">      &#125; finally &#123;</span><br><span class="line">        this.loading = false;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    // ================== 通行密钥一键登录入口（失败回退注册） ==================</span><br><span class="line">    async onPasskeyLogin() &#123;</span><br><span class="line">      if (!this.baseUrl) return;</span><br><span class="line">      this.loading = true;</span><br><span class="line">      try &#123;</span><br><span class="line">        // 复杂逻辑：步骤A——请求登录 options（无用户名直登；后端可按设备ID定向返回 allowCredentials）</span><br><span class="line">        const resp = await this.post(&quot;/passkeys/login/options&quot;, &#123;&#125;);</span><br><span class="line">        const options = resp.options || resp;</span><br><span class="line"></span><br><span class="line">        // #ifdef APP-PLUS</span><br><span class="line">        // 复杂逻辑：App 端调用 UTS 插件进行“使用通行密钥”</span><br><span class="line">        const requestOptionsJson = JSON.stringify(options);</span><br><span class="line">        const authRespJson = await passkeys.getPasskey(requestOptionsJson, &#123;</span><br><span class="line">          conditional: true,</span><br><span class="line">        &#125;);</span><br><span class="line">        const verifyBody = JSON.parse(authRespJson);</span><br><span class="line">        // #endif</span><br><span class="line"></span><br><span class="line">        // #ifdef H5</span><br><span class="line">        // 复杂逻辑：H5 端使用 WebAuthn —— 将 base64url 字段转 ArrayBuffer</span><br><span class="line">        const publicKey = this.toWebAuthnRequestOptions(options);</span><br><span class="line">        // 复杂逻辑：若支持条件UI，mediation=&#x27;conditional&#x27;，否则 &#x27;required&#x27;（需用户手势）</span><br><span class="line">        const mediation = (await this.isConditionalUI())</span><br><span class="line">          ? &quot;conditional&quot;</span><br><span class="line">          : &quot;required&quot;;</span><br><span class="line">        const assertion = await navigator.credentials.get(&#123;</span><br><span class="line">          publicKey,</span><br><span class="line">          mediation,</span><br><span class="line">        &#125;);</span><br><span class="line">        const verifyBody = this.packAssertion(assertion);</span><br><span class="line">        // #endif</span><br><span class="line"></span><br><span class="line">        // 复杂逻辑：步骤B——提交登录 verify</span><br><span class="line">        const verify = await this.post(&quot;/passkeys/login/verify&quot;, verifyBody);</span><br><span class="line">        this.onLoginSucceed(verify);</span><br><span class="line">      &#125; catch (e) &#123;</span><br><span class="line">        // 复杂逻辑：登录失败（无凭据/取消/过期）→ 步骤C——回退到 JIT 注册</span><br><span class="line">        try &#123;</span><br><span class="line">          const jit = await this.post(</span><br><span class="line">            &quot;/passkeys/register-or-login/options&quot;,</span><br><span class="line">            &#123;&#125;</span><br><span class="line">          );</span><br><span class="line">          const userId = jit.userId || jit?.user?.id;</span><br><span class="line">          const creationOptions = jit.options || jit;</span><br><span class="line"></span><br><span class="line">          // #ifdef APP-PLUS</span><br><span class="line">          // 复杂逻辑：App 端调用 UTS 插件“创建通行密钥”</span><br><span class="line">          const creationOptionsJson = JSON.stringify(creationOptions);</span><br><span class="line">          const regRespJson = await passkeys.createPasskey(creationOptionsJson);</span><br><span class="line">          const verifyRegBody = &#123;</span><br><span class="line">            ...JSON.parse(regRespJson),</span><br><span class="line">            userId,</span><br><span class="line">            deviceIdentifier: this.deviceId,</span><br><span class="line">          &#125;;</span><br><span class="line">          // #endif</span><br><span class="line"></span><br><span class="line">          // #ifdef H5</span><br><span class="line">          // 复杂逻辑：H5 端 WebAuthn —— 转换 base64url → ArrayBuffer，发起 create</span><br><span class="line">          const publicKey = this.toWebAuthnCreationOptions(creationOptions);</span><br><span class="line">          const attestation = await navigator.credentials.create(&#123; publicKey &#125;);</span><br><span class="line">          const verifyRegBody = &#123;</span><br><span class="line">            ...this.packAttestation(attestation),</span><br><span class="line">            userId,</span><br><span class="line">            deviceIdentifier: this.deviceId,</span><br><span class="line">          &#125;;</span><br><span class="line">          // #endif</span><br><span class="line"></span><br><span class="line">          // 复杂逻辑：步骤D——提交注册 verify（完成入库+设备唯一绑定+签发会话）</span><br><span class="line">          const verify = await this.post(</span><br><span class="line">            &quot;/passkeys/register-or-login/verify&quot;,</span><br><span class="line">            verifyRegBody</span><br><span class="line">          );</span><br><span class="line">          this.onLoginSucceed(verify, true);</span><br><span class="line">        &#125; catch (e2) &#123;</span><br><span class="line">          uni.showToast(&#123; title: e2?.message || String(e2), icon: &quot;none&quot; &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; finally &#123;</span><br><span class="line">        this.loading = false;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    // 复杂逻辑：登录/注册成功后的统一处理（落 token + 跳转）</span><br><span class="line">    onLoginSucceed(verify, isRegister = false) &#123;</span><br><span class="line">      if (verify?.verified) &#123;</span><br><span class="line">        if (verify.token) &#123;</span><br><span class="line">          uni.setStorageSync(&quot;TOKEN&quot;, verify.token);</span><br><span class="line">        &#125;</span><br><span class="line">        uni.showToast(&#123;</span><br><span class="line">          title: isRegister ? &quot;已注册并登录&quot; : &quot;登录成功&quot;,</span><br><span class="line">          icon: &quot;success&quot;,</span><br><span class="line">        &#125;);</span><br><span class="line">        setTimeout(() =&gt; &#123;</span><br><span class="line">          uni.reLaunch(&#123; url: &quot;/pages/index/index&quot; &#125;);</span><br><span class="line">        &#125;, 600);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        throw new Error(&quot;校验失败&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    // ================== H5 专用辅助：WebAuthn 转换与打包 ==================</span><br><span class="line">    // #ifdef H5</span><br><span class="line">    // 复杂逻辑：检测是否支持条件UI</span><br><span class="line">    async isConditionalUI() &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">        return !!(await PublicKeyCredential.isConditionalMediationAvailable?.());</span><br><span class="line">      &#125; catch &#123;</span><br><span class="line">        return false;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    // 复杂逻辑：base64url → ArrayBuffer</span><br><span class="line">    b64urlToBuf(b64url) &#123;</span><br><span class="line">      const pad = &quot;=&quot;.repeat((4 - (b64url.length % 4)) % 4);</span><br><span class="line">      const b64 = (b64url + pad).replace(/-/g, &quot;+&quot;).replace(/_/g, &quot;/&quot;);</span><br><span class="line">      const bin = atob(b64);</span><br><span class="line">      const buf = new ArrayBuffer(bin.length);</span><br><span class="line">      const view = new Uint8Array(buf);</span><br><span class="line">      for (let i = 0; i &lt; bin.length; i++) view[i] = bin.charCodeAt(i);</span><br><span class="line">      return buf;</span><br><span class="line">    &#125;,</span><br><span class="line">    // 复杂逻辑：ArrayBuffer/Uint8Array → base64url</span><br><span class="line">    bufToB64url(buf) &#123;</span><br><span class="line">      const b = buf instanceof ArrayBuffer ? new Uint8Array(buf) : buf;</span><br><span class="line">      let s = &quot;&quot;;</span><br><span class="line">      for (let i = 0; i &lt; b.length; i++) s += String.fromCharCode(b[i]);</span><br><span class="line">      return btoa(s)</span><br><span class="line">        .replace(/\+/g, &quot;-&quot;)</span><br><span class="line">        .replace(/\//g, &quot;_&quot;)</span><br><span class="line">        .replace(/=+$/g, &quot;&quot;);</span><br><span class="line">    &#125;,</span><br><span class="line">    // 复杂逻辑：将登录 options（服务端 base64url）转为 WebAuthn 可用结构</span><br><span class="line">    toWebAuthnRequestOptions(serverOpts) &#123;</span><br><span class="line">      const opts = JSON.parse(JSON.stringify(serverOpts));</span><br><span class="line">      if (typeof opts.challenge === &quot;string&quot;)</span><br><span class="line">        opts.challenge = this.b64urlToBuf(opts.challenge);</span><br><span class="line">      if (Array.isArray(opts.allowCredentials)) &#123;</span><br><span class="line">        opts.allowCredentials = opts.allowCredentials.map((c) =&gt; (&#123;</span><br><span class="line">          ...c,</span><br><span class="line">          id: typeof c.id === &quot;string&quot; ? this.b64urlToBuf(c.id) : c.id,</span><br><span class="line">        &#125;));</span><br><span class="line">      &#125;</span><br><span class="line">      return opts;</span><br><span class="line">    &#125;,</span><br><span class="line">    // 复杂逻辑：将注册 options 转为 WebAuthn 可用结构</span><br><span class="line">    toWebAuthnCreationOptions(serverOpts) &#123;</span><br><span class="line">      const opts = JSON.parse(JSON.stringify(serverOpts));</span><br><span class="line">      if (typeof opts.challenge === &quot;string&quot;)</span><br><span class="line">        opts.challenge = this.b64urlToBuf(opts.challenge);</span><br><span class="line">      if (opts.user &amp;&amp; typeof opts.user.id === &quot;string&quot;)</span><br><span class="line">        opts.user.id = this.b64urlToBuf(opts.user.id);</span><br><span class="line">      if (Array.isArray(opts.excludeCredentials)) &#123;</span><br><span class="line">        opts.excludeCredentials = opts.excludeCredentials.map((c) =&gt; (&#123;</span><br><span class="line">          ...c,</span><br><span class="line">          id: typeof c.id === &quot;string&quot; ? this.b64urlToBuf(c.id) : c.id,</span><br><span class="line">        &#125;));</span><br><span class="line">      &#125;</span><br><span class="line">      return opts;</span><br><span class="line">    &#125;,</span><br><span class="line">    // 复杂逻辑：将 get() 结果打包为后端可校验的 JSON（统一 base64url）</span><br><span class="line">    packAssertion(cred) &#123;</span><br><span class="line">      const resp = cred.response;</span><br><span class="line">      return &#123;</span><br><span class="line">        id: cred.id,</span><br><span class="line">        rawId: this.bufToB64url(cred.rawId),</span><br><span class="line">        type: cred.type,</span><br><span class="line">        response: &#123;</span><br><span class="line">          clientDataJSON: this.bufToB64url(resp.clientDataJSON),</span><br><span class="line">          authenticatorData: this.bufToB64url(resp.authenticatorData),</span><br><span class="line">          signature: this.bufToB64url(resp.signature),</span><br><span class="line">          userHandle: resp.userHandle</span><br><span class="line">            ? this.bufToB64url(resp.userHandle)</span><br><span class="line">            : null,</span><br><span class="line">        &#125;,</span><br><span class="line">        clientExtensionResults: cred.getClientExtensionResults?.() || &#123;&#125;,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    // 复杂逻辑：将 create() 结果打包为后端可校验的 JSON（统一 base64url）</span><br><span class="line">    packAttestation(cred) &#123;</span><br><span class="line">      const resp = cred.response;</span><br><span class="line">      return &#123;</span><br><span class="line">        id: cred.id,</span><br><span class="line">        rawId: this.bufToB64url(cred.rawId),</span><br><span class="line">        type: cred.type,</span><br><span class="line">        response: &#123;</span><br><span class="line">          clientDataJSON: this.bufToB64url(resp.clientDataJSON),</span><br><span class="line">          attestationObject: this.bufToB64url(resp.attestationObject),</span><br><span class="line">        &#125;,</span><br><span class="line">        clientExtensionResults: cred.getClientExtensionResults?.() || &#123;&#125;,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">    // #endif</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line">.container &#123;</span><br><span class="line">  padding: 24rpx;</span><br><span class="line">&#125;</span><br><span class="line">.header &#123;</span><br><span class="line">  margin-top: 40rpx;</span><br><span class="line">  margin-bottom: 24rpx;</span><br><span class="line">&#125;</span><br><span class="line">.title &#123;</span><br><span class="line">  font-size: 36rpx;</span><br><span class="line">  font-weight: 600;</span><br><span class="line">  text-align: center;</span><br><span class="line">&#125;</span><br><span class="line">.tip &#123;</span><br><span class="line">  display: flex;</span><br><span class="line">  align-items: center;</span><br><span class="line">  gap: 16rpx;</span><br><span class="line">  padding: 16rpx;</span><br><span class="line">  margin: 12rpx 0;</span><br><span class="line">  border: 1px solid #ffc107;</span><br><span class="line">  background: #fff8e1;</span><br><span class="line">  border-radius: 12rpx;</span><br><span class="line">&#125;</span><br><span class="line">.tip-text &#123;</span><br><span class="line">  color: #8d6e63;</span><br><span class="line">  font-size: 26rpx;</span><br><span class="line">&#125;</span><br><span class="line">.actions &#123;</span><br><span class="line">  margin-top: 24rpx;</span><br><span class="line">  display: flex;</span><br><span class="line">  flex-direction: column;</span><br><span class="line">&#125;</span><br><span class="line">.loading-mask &#123;</span><br><span class="line">  position: fixed;</span><br><span class="line">  left: 0;</span><br><span class="line">  right: 0;</span><br><span class="line">  top: 0;</span><br><span class="line">  bottom: 0;</span><br><span class="line">  background: rgba(0, 0, 0, 0.2);</span><br><span class="line">  display: flex;</span><br><span class="line">  align-items: center;</span><br><span class="line">  justify-content: center;</span><br><span class="line">&#125;</span><br><span class="line">.loading-box &#123;</span><br><span class="line">  padding: 20rpx;</span><br><span class="line">  background: #fff;</span><br><span class="line">  border-radius: 12rpx;</span><br><span class="line">&#125;</span><br><span class="line">.modal-mask &#123;</span><br><span class="line">  position: fixed;</span><br><span class="line">  left: 0;</span><br><span class="line">  right: 0;</span><br><span class="line">  top: 0;</span><br><span class="line">  bottom: 0;</span><br><span class="line">  background: rgba(0, 0, 0, 0.4);</span><br><span class="line">  display: flex;</span><br><span class="line">  align-items: center;</span><br><span class="line">  justify-content: center;</span><br><span class="line">&#125;</span><br><span class="line">.modal &#123;</span><br><span class="line">  width: 80%;</span><br><span class="line">  background: #fff;</span><br><span class="line">  border-radius: 16rpx;</span><br><span class="line">  padding: 24rpx;</span><br><span class="line">&#125;</span><br><span class="line">.modal-title &#123;</span><br><span class="line">  font-size: 30rpx;</span><br><span class="line">  font-weight: 600;</span><br><span class="line">&#125;</span><br><span class="line">.modal-input &#123;</span><br><span class="line">  border: 1px solid #eee;</span><br><span class="line">  margin: 16rpx 0;</span><br><span class="line">  padding: 12rpx;</span><br><span class="line">  border-radius: 8rpx;</span><br><span class="line">&#125;</span><br><span class="line">.modal-actions &#123;</span><br><span class="line">  display: flex;</span><br><span class="line">  justify-content: flex-end;</span><br><span class="line">  gap: 12rpx;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="说明与对接要点"><a href="#说明与对接要点" class="headerlink" title="说明与对接要点"></a>说明与对接要点</h2><ul>
<li><p><strong>后端路由</strong>保持为：</p>
<ul>
<li><code>/passkeys/login/options</code> → 返回 <code>PublicKeyCredentialRequestOptions</code>（<code>challenge</code>&#x2F;<code>allowCredentials[].id</code> 为 <strong>base64url</strong>）。</li>
<li><code>/passkeys/login/verify</code> → 接收 <code>packAssertion</code> 结果。</li>
<li><code>/passkeys/register-or-login/options</code> → 返回 <code>&#123; userId, options &#125;</code>（注册用，<code>challenge</code>&#x2F;<code>user.id</code> 为 <strong>base64url</strong>）。</li>
<li><code>/passkeys/register-or-login/verify</code> → 接收 <code>packAttestation</code> + <code>&#123; userId, deviceIdentifier &#125;</code>。</li>
</ul>
</li>
<li><p><strong>设备唯一</strong>：页面已在所有请求体中带上 <code>deviceIdentifier</code>（<code>this.deviceId</code>），你的服务端即可写入&#x2F;校验 <code>dvc:owner:*</code>。</p>
</li>
<li><p><strong>H5 前置条件</strong>：需 HTTPS 或 <code>localhost</code>；Safari&#x2F;移动端有平台限制。</p>
</li>
<li><p><strong>App 端</strong>：确保 <code>@/uni_modules/pass-keys</code> 已实现 <code>getPasskey</code>&#x2F;<code>createPasskey</code> 且返回 <strong>JSON 字符串</strong>（与我们前面约定一致）。</p>
</li>
</ul>
<p>需要我把 <strong>“已登录场景的绑定按钮”</strong> 也加到这个页面吗（即 <code>/passkeys/register/options|verify</code>，走绑定而非 JIT）？如果要，加哪个位置，我按你“只给改动段”的规范再补。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/05/requirement-realization-2/" data-id="cmf9bdhkj000hqq4z3ry49zrq" data-title="在你现有 uvue 登录页集成“一键通行密钥登录”（含回退注册），完整代码可直接替换" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Passkeys/" rel="tag">Passkeys</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/UTS-%E6%8F%92%E4%BB%B6/" rel="tag">UTS 插件</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WebAuthn/" rel="tag">WebAuthn</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/uni-app-x/" rel="tag">uni-app x</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%B8%80%E9%94%AE%E7%9B%B4%E7%99%BB/" rel="tag">一键直登</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-web应用开发/前端/passkeys-通行密钥-登录-注册一体化方案" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/04/web%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E5%89%8D%E7%AB%AF/passkeys-%E9%80%9A%E8%A1%8C%E5%AF%86%E9%92%A5-%E7%99%BB%E5%BD%95-%E6%B3%A8%E5%86%8C%E4%B8%80%E4%BD%93%E5%8C%96%E6%96%B9%E6%A1%88/" class="article-date">
  <time class="dt-published" datetime="2025-09-04T23:29:49.000Z" itemprop="datePublished">2025-09-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/">web应用开发</a>►<a class="article-category-link" href="/categories/web%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E5%89%8D%E7%AB%AF/">前端</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/04/web%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E5%89%8D%E7%AB%AF/passkeys-%E9%80%9A%E8%A1%8C%E5%AF%86%E9%92%A5-%E7%99%BB%E5%BD%95-%E6%B3%A8%E5%86%8C%E4%B8%80%E4%BD%93%E5%8C%96%E6%96%B9%E6%A1%88/">passkeys 通行密钥 登录+注册一体化方案</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>结论先说：<strong>可以把“登录+注册”做成一体化体验</strong>。</p>
<p>主流做法是 <strong>“先尝试登录（可发现凭证）→ 如果用户或设备上没有可用通行密钥，再走 JIT 注册并在验证成功后直接登录”</strong>。</p>
<p>原因是 WebAuthn 天生是“<strong>两步握手</strong>”：<br><strong>options</strong>（服务端签发挑战）→ <strong>客户端做凭证仪式</strong> → <strong>verify</strong>（服务端校验）。<br>所以无论登录还是注册，都至少要走这一来一回；想“完全无交互”是不可能的。但你可以把 <strong>登录与注册的分支逻辑</strong> 封装好，让前端只调用 1~2 次 API 就完成。</p>
<p>你的代码里已经有这个形态了：</p>
<ul>
<li><code>/passkeys/login/options|verify</code>：<strong>无用户名直登</strong>（allowCredentials 留空 → 可发现凭证）</li>
<li><code>/passkeys/register-or-login/options|verify</code>：<strong>JIT 建号 + 设备唯一 + 注册即登录</strong></li>
</ul>
<p>这就是一体化的正确方向。下面给你<strong>微调点</strong>，让体验更顺滑，并回答“是否必须先绑定”的顾虑。</p>
<h2 id="推荐落地流程（与大厂一致的用户体验）"><a href="#推荐落地流程（与大厂一致的用户体验）" class="headerlink" title="推荐落地流程（与大厂一致的用户体验）"></a>推荐落地流程（与大厂一致的用户体验）</h2><ol>
<li><p><strong>进入应用 → 前端先调用</strong> <code>/passkeys/login/options</code>（不传 allowCredentials）。</p>
<ul>
<li>Android&#x2F;iOS 原生会列出与 <strong>RP ID</strong> 匹配的“可发现凭证”(resident key)。</li>
<li>若用户设备上已有你的 RP 的通行密钥 → 用户点一下即返回 <strong>assertion</strong> → 你后端 <code>verifyAuthentication</code> → <strong>直接登录</strong>。</li>
</ul>
</li>
<li><p><strong>若返回“没有可用凭证&#x2F;用户取消&#x2F;NotFound”</strong>：前端<strong>立即</strong>调用 <code>/passkeys/register-or-login/options</code>（带上 <code>deviceIdentifier</code>）。</p>
<ul>
<li>后端 <strong>JIT 建号</strong>（或使用你已有的访客&#x2F;待激活账号策略），签发 <strong>registration options</strong>（residentKey&#x3D;required）。</li>
<li>前端发起注册仪式 → 拿到 <strong>attestation</strong> 回 <code>/register-or-login/verify</code>。</li>
<li>服务端 <strong>校验 + 入库 + 绑定设备(可选) + 激活账号 + 签发 JWT</strong> → <strong>注册即登录</strong>。</li>
</ul>
</li>
</ol>
<blockquote>
<p>是否必须先“绑定再登录”？<br><strong>不必须。<strong>对已存在通行密钥的用户，第一步就能登录；对新设备&#x2F;新用户，第二步完成</strong>注册+登录</strong>。<br>“设备唯一绑定”是<strong>风控策略</strong>（特别适合你的“仅内部员工”场景），不是通行密钥的强制要求。</p>
</blockquote>
<h2 id="只给需要修改-新增的代码（复杂逻辑上一行有注释）"><a href="#只给需要修改-新增的代码（复杂逻辑上一行有注释）" class="headerlink" title="只给需要修改&#x2F;新增的代码（复杂逻辑上一行有注释）"></a>只给需要修改&#x2F;新增的代码（复杂逻辑上一行有注释）</h2><h3 id="A-PasskeysService-issueAuthenticationOptions：若发现设备已绑定账号，则定向登录（加速成功率）"><a href="#A-PasskeysService-issueAuthenticationOptions：若发现设备已绑定账号，则定向登录（加速成功率）" class="headerlink" title="A) PasskeysService.issueAuthenticationOptions：若发现设备已绑定账号，则定向登录（加速成功率）"></a>A) <code>PasskeysService.issueAuthenticationOptions</code>：若发现设备已绑定账号，则<strong>定向登录</strong>（加速成功率）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：若 deviceIdentifier 已绑定 userId，则定向下发 allowCredentials（命中率更高，更快）</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">issueAuthenticationOptions</span>(<span class="params">&#123; deviceIdentifier &#125;: &#123; deviceIdentifier?: <span class="built_in">string</span> &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> relyingPartyId = <span class="variable language_">this</span>.<span class="property">configService</span>.<span class="property">get</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&#x27;RP_ID&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 可选的速率限制（60s/5次）</span></span><br><span class="line">  <span class="keyword">if</span> (deviceIdentifier) &#123;</span><br><span class="line">    <span class="keyword">const</span> rlKey = <span class="string">`rl:authpub:<span class="subst">$&#123;deviceIdentifier&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">const</span> c = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">redisService</span>.<span class="title function_">incrementKey</span>(rlKey);</span><br><span class="line">    <span class="keyword">if</span> (c === <span class="number">1</span>) <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">redisService</span>.<span class="title function_">expireKey</span>(rlKey, <span class="number">60</span>);</span><br><span class="line">    <span class="keyword">if</span> (c &gt; <span class="number">5</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadRequestException</span>(<span class="string">&#x27;请求过于频繁，请稍后重试&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">allowCredentials</span>: &#123; <span class="attr">id</span>: <span class="title class_">Buffer</span>; <span class="attr">type</span>: <span class="string">&#x27;public-key&#x27;</span> &#125;[] | <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">preferUserId</span>: <span class="built_in">string</span> | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (deviceIdentifier) &#123;</span><br><span class="line">    <span class="comment">// 复杂逻辑：如果该设备已绑定过账号，优先走“定向登录”</span></span><br><span class="line">    preferUserId = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">redisService</span>.<span class="title function_">getValue</span>(<span class="string">`dvc:owner:<span class="subst">$&#123;deviceIdentifier&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">if</span> (preferUserId) &#123;</span><br><span class="line">      <span class="comment">// 复杂逻辑：查询该用户的所有凭证，拼出 allowCredentials（按你的持久层接口调整）</span></span><br><span class="line">      <span class="keyword">const</span> creds = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">staffService</span>.<span class="title function_">findManyCredentialsByUserId</span>(preferUserId);</span><br><span class="line">      allowCredentials = (creds || []).<span class="title function_">map</span>(<span class="function">(<span class="params"><span class="attr">c</span>: <span class="built_in">any</span></span>) =&gt;</span> (&#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="title class_">Buffer</span>.<span class="title function_">from</span>(c.<span class="property">credentialId</span>, <span class="string">&#x27;base64url&#x27;</span>),</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;public-key&#x27;</span> <span class="keyword">as</span> <span class="keyword">const</span>,</span><br><span class="line">      &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> opts = <span class="keyword">await</span> <span class="title function_">generateAuthenticationOptions</span>(&#123;</span><br><span class="line">    <span class="attr">rpID</span>: relyingPartyId,</span><br><span class="line">    <span class="attr">userVerification</span>: <span class="string">&#x27;preferred&#x27;</span>,</span><br><span class="line">    <span class="comment">// 复杂逻辑：存在 allowCredentials → 定向登录；否则留空 = 可发现凭证</span></span><br><span class="line">    allowCredentials,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 复杂逻辑：挑战转为 base64url，分别按“userId”或“challenge”做校验键</span></span><br><span class="line">  <span class="keyword">const</span> ch = <span class="keyword">typeof</span> opts.<span class="property">challenge</span> === <span class="string">&#x27;string&#x27;</span></span><br><span class="line">    ? opts.<span class="property">challenge</span></span><br><span class="line">    : <span class="title class_">Buffer</span>.<span class="title function_">from</span>(opts.<span class="property">challenge</span>).<span class="title function_">toString</span>(<span class="string">&#x27;base64url&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (preferUserId) &#123;</span><br><span class="line">    <span class="comment">// 定向登录：按 userId 存</span></span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">redisService</span>.<span class="title function_">setWithTimeToLive</span>(<span class="string">`webauthn:auth:<span class="subst">$&#123;preferUserId&#125;</span>`</span>, ch, <span class="number">300</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 无用户名直登：按 challenge 存</span></span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">redisService</span>.<span class="title function_">setWithTimeToLive</span>(<span class="string">`webauthn:auth:ch:<span class="subst">$&#123;ch&#125;</span>`</span>, <span class="string">&#x27;1&#x27;</span>, <span class="number">300</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 兼容前端：无需改协议，仍返回纯 AuthenticationOptions</span></span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">options</span>: opts &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>说明：</p>
<ul>
<li>这段逻辑<strong>不改变你的路由与前端协议</strong>，仅在“已绑定设备”的情况下给出 <code>allowCredentials</code>，成功率会更高，且仍保留“可发现凭证”的默认路径。</li>
<li><code>findManyCredentialsByUserId</code> 请在你的 <code>AdminStaffService</code> 或凭据仓库里补一个简单查询（只要返回 <code>credentialId</code> 列表即可）。</li>
</ul>
</blockquote>
<hr>
<h3 id="B-前端（你刚写的-页面）登录按钮增加“失败回退到注册”的兜底（只给改动段）"><a href="#B-前端（你刚写的-页面）登录按钮增加“失败回退到注册”的兜底（只给改动段）" class="headerlink" title="B) 前端（你刚写的 &lt;script setup&gt; 页面）登录按钮增加“失败回退到注册”的兜底（只给改动段）"></a>B) 前端（你刚写的 <code>&lt;script setup&gt;</code> 页面）<strong>登录按钮</strong>增加“失败回退到注册”的兜底（只给改动段）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：登录失败时自动回退到 JIT 注册（注册成功即登录）</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">onLogin</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="title function_">appendLog</span>(<span class="string">&quot;请求登录 options...&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> &#123; options &#125; = <span class="keyword">await</span> <span class="title function_">post</span>(<span class="string">&quot;/passkeys/login/options&quot;</span>, &#123;</span><br><span class="line">      <span class="attr">deviceIdentifier</span>: deviceId.<span class="property">value</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> requestOptionsJson = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(options);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复杂逻辑：先尝试登录（Android 支持 conditional UI；iOS 忽略该参数）</span></span><br><span class="line">    <span class="keyword">const</span> authRespJson = <span class="keyword">await</span> passkeys.<span class="title function_">getPasskey</span>(requestOptionsJson, &#123;</span><br><span class="line">      <span class="attr">conditional</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">appendLog</span>(<span class="string">&quot;登录响应返回，提交后端 verify...&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> verify = <span class="keyword">await</span> <span class="title function_">post</span>(</span><br><span class="line">      <span class="string">&quot;/passkeys/login/verify&quot;</span>,</span><br><span class="line">      <span class="title class_">JSON</span>.<span class="title function_">parse</span>(authRespJson)</span><br><span class="line">    );</span><br><span class="line">    <span class="title function_">appendLog</span>(<span class="string">&quot;登录完成：&quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(verify));</span><br><span class="line">    uni.<span class="title function_">showToast</span>(&#123; <span class="attr">title</span>: <span class="string">&quot;登录成功&quot;</span>, <span class="attr">icon</span>: <span class="string">&quot;success&quot;</span> &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (<span class="attr">e</span>: <span class="built_in">any</span>) &#123;</span><br><span class="line">    <span class="title function_">appendLog</span>(<span class="string">&quot;未找到可用通行密钥或用户取消，转入一键注册...&quot;</span>);</span><br><span class="line">    <span class="comment">// ===== 回退到 JIT 注册 =====</span></span><br><span class="line">    <span class="keyword">const</span> &#123; userId, options &#125; = <span class="keyword">await</span> <span class="title function_">post</span>(</span><br><span class="line">      <span class="string">&quot;/passkeys/register-or-login/options&quot;</span>,</span><br><span class="line">      deviceId.<span class="property">value</span> ? &#123; <span class="attr">deviceIdentifier</span>: deviceId.<span class="property">value</span> &#125; : &#123;&#125;</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">const</span> creationOptionsJson = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(options);</span><br><span class="line">    <span class="keyword">const</span> regRespJson = <span class="keyword">await</span> passkeys.<span class="title function_">createPasskey</span>(creationOptionsJson);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">appendLog</span>(<span class="string">&quot;注册响应返回，提交后端 verify...&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> verify = <span class="keyword">await</span> <span class="title function_">post</span>(<span class="string">&quot;/passkeys/register-or-login/verify&quot;</span>, &#123;</span><br><span class="line">      ...<span class="title class_">JSON</span>.<span class="title function_">parse</span>(regRespJson),</span><br><span class="line">      userId,</span><br><span class="line">      <span class="attr">deviceIdentifier</span>: deviceId.<span class="property">value</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="title function_">appendLog</span>(<span class="string">&quot;注册并登录完成：&quot;</span> + <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(verify));</span><br><span class="line">    uni.<span class="title function_">showToast</span>(&#123; <span class="attr">title</span>: <span class="string">&quot;已注册并登录&quot;</span>, <span class="attr">icon</span>: <span class="string">&quot;success&quot;</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="C-小修小补（可选但建议）"><a href="#C-小修小补（可选但建议）" class="headerlink" title="C) 小修小补（可选但建议）"></a>C) 小修小补（可选但建议）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 注册 options：建议同时允许 ES256 与 RS256，兼容性更好</span></span><br><span class="line"><span class="attr">supportedAlgorithmIDs</span>: [-<span class="number">7</span>, -<span class="number">257</span>],  <span class="comment">// ES256 + RS256</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 注册时强制 residentKey=required 已很好；登录时建议 UV 至少 preferred（你已这么做）</span></span><br><span class="line"><span class="comment">// 可对内网/高敏环境将 requireUserVerification 提升为 true</span></span><br><span class="line"><span class="attr">requireUserVerification</span>: <span class="literal">true</span>, <span class="comment">// 在 verify* 中按需要切换</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="关键答疑"><a href="#关键答疑" class="headerlink" title="关键答疑"></a>关键答疑</h2><ul>
<li><p><strong>“能不能只请求一次后端就完成登录？”</strong><br>不行。WebAuthn 必须由服务器先发“带签名挑战”的 <strong>options</strong>，客户端拿到后<strong>本地安全硬件</strong>完成签名&#x2F;生成数据，再发给服务器 <strong>verify</strong>。这是设计使然，无法省略。</p>
</li>
<li><p><strong>“新用户是否必须先走‘绑定’页面？”</strong><br>不必须。你现在的 JIT 路线就是“<strong>注册即登录</strong>”。首次访问：登录失败 → 自动发起注册 → 验证成功后立刻签发会话即可。后续访问就直接“可发现凭证”一键登录了。</p>
</li>
<li><p><strong>“设备唯一绑定是必须的吗？”</strong><br>不是 WebAuthn 的硬性要求，但对<strong>内部员工场景非常有用</strong>（合规+风控）。你已经在 JIT 验证里写了 <code>dvc:owner:*</code> 的校验与写入，这就够了。</p>
</li>
</ul>
<hr>
<p>如果你愿意，我可以<strong>补一个 <code>findManyCredentialsByUserId</code> 的最小实现</strong>（Prisma&#x2F;TypeORM 任一版）或把你的 <code>PasskeysController</code> 的“登录按钮”分支写成更干净的状态机。你说一声，我按你的“只给改动段”规范继续补。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/04/web%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E5%89%8D%E7%AB%AF/passkeys-%E9%80%9A%E8%A1%8C%E5%AF%86%E9%92%A5-%E7%99%BB%E5%BD%95-%E6%B3%A8%E5%86%8C%E4%B8%80%E4%BD%93%E5%8C%96%E6%96%B9%E6%A1%88/" data-id="cmf9bdhl80036qq4z7fut9yk0" data-title="passkeys 通行密钥 登录+注册一体化方案" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-使用-hexo-在-github-部署个人博客" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/04/%E4%BD%BF%E7%94%A8-hexo-%E5%9C%A8-github-%E9%83%A8%E7%BD%B2%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/" class="article-date">
  <time class="dt-published" datetime="2025-09-04T18:04:44.000Z" itemprop="datePublished">2025-09-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/04/%E4%BD%BF%E7%94%A8-hexo-%E5%9C%A8-github-%E9%83%A8%E7%BD%B2%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/">使用 hexo 在 github 部署个人博客</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="整体实现思路"><a href="#整体实现思路" class="headerlink" title="整体实现思路"></a>整体实现思路</h1><ul>
<li><strong>写作方式</strong>：本地写 Markdown（VSCode&#x2F;Typora），利用 Hexo 生成静态文件。</li>
<li><strong>站点能力</strong>：front-matter 实现<strong>分类&#x2F;标签</strong>；装 <code>hexo-generator-searchdb</code> 提供<strong>本地搜索</strong>（纯静态，无后端）。</li>
<li><strong>部署方式</strong>：用 <strong>GitHub Actions</strong> 在每次 <code>push main</code> 时自动构建，把 <code>public/</code> 发布到 <strong><code>gh-pages</code></strong> 分支；<strong>Pages</strong> 指向该分支即可上线。</li>
<li><strong>路径模式</strong>：你当前是<strong>项目页</strong>（仓库名不是 <code>&lt;用户名&gt;.github.io</code>），所以站点路径是 <code>https://&lt;用户名&gt;.github.io/&lt;仓库名&gt;/</code>，Hexo 里必须设置 <code>url</code> 和 <code>root</code>。</li>
</ul>
<hr>
<h1 id="分步实现过程"><a href="#分步实现过程" class="headerlink" title="分步实现过程"></a>分步实现过程</h1><h2 id="1）环境与初始化（已有可跳过）"><a href="#1）环境与初始化（已有可跳过）" class="headerlink" title="1）环境与初始化（已有可跳过）"></a>1）环境与初始化（已有可跳过）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">npm i -g hexo-cli</span><br><span class="line">hexo init blog &amp;&amp; <span class="built_in">cd</span> blog</span><br><span class="line">npm i</span><br><span class="line">hexo s   <span class="comment"># 本地预览 http://localhost:4000</span></span><br></pre></td></tr></table></figure>

<h2 id="2）启用主题与“分类-标签-搜索”"><a href="#2）启用主题与“分类-标签-搜索”" class="headerlink" title="2）启用主题与“分类&#x2F;标签&#x2F;搜索”"></a>2）启用主题与“分类&#x2F;标签&#x2F;搜索”</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 NexT（已安装可跳过）</span></span><br><span class="line">npm i hexo-theme-next</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成分类与标签页面</span></span><br><span class="line">hexo new page categories</span><br><span class="line">hexo new page tags</span><br></pre></td></tr></table></figure>

<p>在两个索引页文件顶部加 front-matter（<strong>只需新增这几行</strong>）：</p>
<figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: 分类</span><br><span class="line"><span class="section">type: categories</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure>

<figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: 标签</span><br><span class="line"><span class="section">type: tags</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure>

<p>安装本地搜索索引插件（<strong>一次性</strong>）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i hexo-generator-searchdb --save</span><br></pre></td></tr></table></figure>

<p><strong>站点配置 <code>_config.yml</code> 里新增（或确认存在）</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 复杂：生成 search.json，供主题读取（静态搜索，无后端）</span></span><br><span class="line"><span class="attr">search:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">search.json</span></span><br><span class="line">  <span class="attr">field:</span> <span class="string">post</span></span><br><span class="line">  <span class="attr">content:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><strong>主题配置 <code>themes/next/_config.yml</code> 里开启</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 复杂：在 NexT 主题中开启本地搜索</span></span><br><span class="line"><span class="attr">local_search:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h2 id="3）Hexo-站点路径设置（项目页必改）"><a href="#3）Hexo-站点路径设置（项目页必改）" class="headerlink" title="3）Hexo 站点路径设置（项目页必改）"></a>3）Hexo 站点路径设置（项目页必改）</h2><p>打开根目录的 <strong><code>_config.yml</code></strong>，<strong>只改这两行</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 复杂：GitHub Project Pages 部署在 /blog/ 子路径（用你的用户名和仓库名）</span></span><br><span class="line"><span class="attr">url:</span> <span class="string">https://&lt;你的GitHub名&gt;.github.io/&lt;你的仓库名&gt;</span></span><br><span class="line"><span class="attr">root:</span> <span class="string">/&lt;你的仓库名&gt;/</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>你当前仓库是 <code>herongxhr-netizen/blog</code>，因此应为：<br><code>url: https://herongxhr-netizen.github.io/blog</code> &gt; <code>root: /blog/</code></p>
</blockquote>
<h2 id="4）把项目推到-GitHub（已有仓库可跳过初始化）"><a href="#4）把项目推到-GitHub（已有仓库可跳过初始化）" class="headerlink" title="4）把项目推到 GitHub（已有仓库可跳过初始化）"></a>4）把项目推到 GitHub（已有仓库可跳过初始化）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">&quot;init blog&quot;</span></span><br><span class="line">git branch -M master</span><br><span class="line">git remote add origin https://github.com/&lt;你的GitHub名&gt;/&lt;你的仓库名&gt;.git</span><br><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure>

<h2 id="5）创建自动部署（GitHub-Actions）"><a href="#5）创建自动部署（GitHub-Actions）" class="headerlink" title="5）创建自动部署（GitHub Actions）"></a>5）创建自动部署（GitHub Actions）</h2><p>在仓库中新建文件 <strong><code>.github/workflows/deploy.yml</code></strong>，内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 复杂：构建 Hexo 并把生成的 public/ 发布到 gh-pages</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">Deploy</span> <span class="string">Hexo</span> <span class="string">to</span> <span class="string">GitHub</span> <span class="string">Pages</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="comment"># 注意检查这个分支是否存在，另外还要注意master|main 两种默认主分支</span></span><br><span class="line">    <span class="attr">branches:</span> [<span class="string">master</span>]</span><br><span class="line"><span class="attr">permissions:</span></span><br><span class="line">  <span class="attr">contents:</span> <span class="string">write</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build-deploy:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/setup-node@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">node-version:</span> <span class="number">20</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">npm</span> <span class="string">i</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">npx</span> <span class="string">hexo</span> <span class="string">clean</span> <span class="string">&amp;&amp;</span> <span class="string">npx</span> <span class="string">hexo</span> <span class="string">g</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">peaceiris/actions-gh-pages@v3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">github_token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">publish_dir:</span> <span class="string">./public</span></span><br><span class="line">          <span class="attr">publish_branch:</span> <span class="string">gh-pages</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>作用：每次推送到 <code>master</code>，自动构建 Hexo 并把 <code>public/</code> 发布到 <code>gh-pages</code> 分支。</p>
</blockquote>
<h2 id="6）打开-GitHub-Pages（指向-gh-pages）"><a href="#6）打开-GitHub-Pages（指向-gh-pages）" class="headerlink" title="6）打开 GitHub Pages（指向 gh-pages）"></a>6）打开 GitHub Pages（指向 <code>gh-pages</code>）</h2><p>仓库 → <strong>Settings → Pages</strong>：</p>
<ul>
<li><strong>Source</strong> 选 <strong>Deploy from a branch</strong></li>
<li><strong>Branch</strong> 选 <strong><code>gh-pages</code></strong>，<strong>Folder</strong> 选 <strong><code>/(root)</code></strong> → Save<br>访问：<code>https://&lt;你的GitHub名&gt;.github.io/&lt;你的仓库名&gt;/</code></li>
</ul>
<h2 id="7）写第一篇-后续文章（固定节奏）"><a href="#7）写第一篇-后续文章（固定节奏）" class="headerlink" title="7）写第一篇&#x2F;后续文章（固定节奏）"></a>7）写第一篇&#x2F;后续文章（固定节奏）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hexo new post <span class="string">&quot;我的第一篇文章&quot;</span></span><br><span class="line"><span class="comment"># 编辑 source/_posts/我的第一篇文章.md，增加分类/标签 front-matter</span></span><br><span class="line">hexo s                 <span class="comment"># 本地预览确认</span></span><br><span class="line">git add . &amp;&amp; git commit -m <span class="string">&quot;post: 第一篇&quot;</span> &amp;&amp; git push</span><br><span class="line"><span class="comment"># -&gt; Actions 自动构建 -&gt; Pages 自动更新</span></span><br></pre></td></tr></table></figure>

<h2 id="故障排查（按频率排序）"><a href="#故障排查（按频率排序）" class="headerlink" title="故障排查（按频率排序）"></a>故障排查（按频率排序）</h2><ol>
<li><p><strong>页面样式丢失或 404</strong></p>
<ul>
<li>九成是 <code>_config.yml</code> 的 <code>url/root</code> 不匹配“项目页子路径”。</li>
<li>修复：按上面的两行改好 → <code>git push</code> 触发重建。</li>
</ul>
</li>
<li><p><strong>推送成功但没自动发布</strong></p>
<ul>
<li>检查 <strong>Actions</strong> 是否执行、是否报“权限不足”。</li>
<li>修复：打开 <strong>Read and write permissions</strong> 或在 workflow 增加 <code>permissions: contents: write</code>。</li>
</ul>
</li>
<li><p><strong>Pages 仍显示旧内容</strong></p>
<ul>
<li>浏览器缓存或 GitHub Pages 缓存未刷新。</li>
<li>修复：改动任意文件再推一次，或等几分钟刷新。</li>
</ul>
</li>
<li><p><strong>找不到搜索框&#x2F;搜索无结果</strong></p>
<ul>
<li>主题未开启 <code>local_search.enable</code> 或站点未生成 <code>search.json</code>。</li>
<li>修复：确认两处配置；本地 <code>hexo clean &amp;&amp; hexo g</code> 看 <code>public/search.json</code> 是否存在。</li>
</ul>
</li>
<li><p><strong>想改成“用户页”根路径</strong></p>
<ul>
<li><p>把仓库改名为 <code>&lt;你的GitHub名&gt;.github.io</code>；</p>
</li>
<li><p><code>_config.yml</code> 改为：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 复杂：用户页部署在根路径</span></span><br><span class="line"><span class="attr">url:</span> <span class="string">https://&lt;你的GitHub名&gt;.github.io</span></span><br><span class="line"><span class="attr">root:</span> <span class="string">/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Pages 的 Source 仍选 <code>gh-pages</code>。</p>
</li>
</ul>
</li>
</ol>
<hr>
<p>需要的话，把你当前 <code>themes/next/_config.yml</code> 里想开的功能（目录、代码复制、文章 TOC、暗色主题）告诉我；我会<strong>只列需要修改的那几行</strong>，并在复杂行上面加注释。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/04/%E4%BD%BF%E7%94%A8-hexo-%E5%9C%A8-github-%E9%83%A8%E7%BD%B2%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/" data-id="cmf9bdhkq0010qq4zey254sm7" data-title="使用 hexo 在 github 部署个人博客" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/GitHub-Pages/" rel="tag">GitHub Pages</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8D%9A%E5%AE%A2/" rel="tag">博客</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-hexo博客分类分目录组织" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/04/hexo%E5%8D%9A%E5%AE%A2%E5%88%86%E7%B1%BB%E5%88%86%E7%9B%AE%E5%BD%95%E7%BB%84%E7%BB%87/" class="article-date">
  <time class="dt-published" datetime="2025-09-04T00:00:00.000Z" itemprop="datePublished">2025-09-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/web%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/">web应用开发</a>►<a class="article-category-link" href="/categories/web%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E5%89%8D%E7%AB%AF/">前端</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/04/hexo%E5%8D%9A%E5%AE%A2%E5%88%86%E7%B1%BB%E5%88%86%E7%9B%AE%E5%BD%95%E7%BB%84%E7%BB%87/">Hexo 千篇文章的“分目录存储 + 目录树导航”实战（含 URL、分类、脚手架）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>目标：当文章<strong>成千上万</strong>时，既能在磁盘上<strong>分目录管理</strong>，又能在站点里以**目录树（分类层级）**浏览，并让 <strong>URL 跟随分类层级</strong>，同时保持 GitHub Project Pages 的子路径（<code>/blog/</code>）不乱。</p>
</blockquote>
<h2 id="1-屏跑通"><a href="#1-屏跑通" class="headerlink" title="1 屏跑通"></a>1 屏跑通</h2><ol>
<li><strong>物理分目录</strong>：<code>source/_posts/</code> 下建多级子目录；<code>hexo new post 路径/标题</code> 可直接写入对应子目录。</li>
<li><strong>URL 跟随分类层级</strong>：把 <code>permalink</code> 改成 <code>:categories/:title/</code>，并在每篇文章的 front-matter 写层级 <code>categories: [父, 子]</code>。</li>
<li><strong>目录树页面</strong>：确认有 <code>source/categories/index.md</code>（<code>type: categories</code>），NexT 会按层级展示。</li>
<li><strong>脚手架（scaffolds）</strong>：为高频目录建模板，一键新建时自动带好层级分类。</li>
<li><strong>GitHub Pages 子路径</strong>：你是项目页 → 继续保持 <code>url: https://&lt;你&gt;.github.io/&lt;仓库名&gt;</code> 与 <code>root: /&lt;仓库名&gt;/</code>。</li>
</ol>
<hr>
<h2 id="一、物理分目录（递归扫描，直接可用）"><a href="#一、物理分目录（递归扫描，直接可用）" class="headerlink" title="一、物理分目录（递归扫描，直接可用）"></a>一、物理分目录（递归扫描，直接可用）</h2><p>Hexo 会<strong>递归</strong>读取 <code>source/_posts/</code> 的子目录，所以可以放心分层管理。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 _posts 下建立层级目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="built_in">source</span>/_posts/GIS/GeoServer</span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="built_in">source</span>/_posts/前端/NextJS</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建文章时直接带路径（两种都行）</span></span><br><span class="line">hexo new post GIS/GeoServer/切片入门</span><br><span class="line">hexo new <span class="string">&quot;GIS/GeoServer/缓存与预热&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 复杂：建议开启“同名资源文件夹”，让每篇文章的图片等资产跟随文章文件夹</span></span><br><span class="line"><span class="comment"># _config.yml（站点根配置）只需改这一行</span></span><br><span class="line"><span class="attr">post_asset_folder:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>开启后，<code>hexo new post GIS/GeoServer/切片入门</code> 会生成<br><code>source/_posts/GIS/GeoServer/切片入门.md</code> 与 <code>source/_posts/GIS/GeoServer/切片入门/</code>（放图）。</p>
</blockquote>
<h2 id="二、URL-页面跟“分类层级”走（而不是物理目录名）"><a href="#二、URL-页面跟“分类层级”走（而不是物理目录名）" class="headerlink" title="二、URL &amp; 页面跟“分类层级”走（而不是物理目录名）"></a>二、URL &amp; 页面跟“分类层级”走（而不是物理目录名）</h2><p><strong>关键点</strong>：页面导航与 URL 建议依赖 <strong>front-matter 的 categories</strong>，而不是物理目录。<br>这样<strong>更可控</strong>（物理目录可随时重构、不影响 URL）。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 复杂：让文章链接包含“分类层级”</span></span><br><span class="line"><span class="comment"># _config.yml（站点根配置）</span></span><br><span class="line"><span class="attr">permalink:</span> <span class="string">:categories/:title/</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>你在 GitHub Project Pages（项目页），<strong>继续保持子路径</strong>（别动就对了）：</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 复杂：站点部署在 /blog/ 子路径下</span></span><br><span class="line"><span class="attr">url:</span> <span class="string">https://herongxhr-netizen.github.io/blog</span></span><br><span class="line"><span class="attr">root:</span> <span class="string">/blog/</span></span><br></pre></td></tr></table></figure>

<p>在每篇文章顶部写<strong>层级分类</strong>（数组顺序即层级）：</p>
<figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: 切片入门</span><br><span class="line">date: 2025-09-04</span><br><span class="line"><span class="section"># 复杂：层级分类会生成 /GIS/GeoServer/ 的目录层级与 URL</span></span><br><span class="line">categories: [GIS, GeoServer]</span><br><span class="line">tags: [GeoServer, 切片, 缓存]</span><br><span class="line"><span class="section"># （可选）若想自定义更友好的英文链接</span></span><br><span class="line"><span class="section"># slug: geoserver-tiling-intro</span></span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<h2 id="三、目录树页面与导航菜单"><a href="#三、目录树页面与导航菜单" class="headerlink" title="三、目录树页面与导航菜单"></a>三、目录树页面与导航菜单</h2><p>确认你已有分类页与标签页（否则先创建）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hexo new page categories</span><br><span class="line">hexo new page tags</span><br></pre></td></tr></table></figure>

<p>编辑索引页 front-matter（<strong>只需这几行</strong>）：</p>
<figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: 分类</span><br><span class="line"><span class="section">type: categories</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure>

<figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: 标签</span><br><span class="line"><span class="section">type: tags</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure>

<p>在 NexT 主题菜单里露出入口（<code>themes/next/_config.yml</code>）：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 复杂：在菜单里显示分类/标签</span></span><br><span class="line"><span class="attr">menu:</span></span><br><span class="line">  <span class="attr">home:</span> <span class="string">/</span></span><br><span class="line">  <span class="attr">categories:</span> <span class="string">/categories/</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">/tags/</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="四、批量高效新建：自定义脚手架（scaffolds）"><a href="#四、批量高效新建：自定义脚手架（scaffolds）" class="headerlink" title="四、批量高效新建：自定义脚手架（scaffolds）"></a>四、批量高效新建：自定义脚手架（scaffolds）</h2><p>为高频目录做脚手架，自动带上层级分类与常用字段。</p>
<p><strong>示例 1：GIS 系列脚手架</strong><br>创建 <code>scaffolds/gis.md</code>：</p>
<figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: &#123; &#123; title &#125; &#125;</span><br><span class="line">date: &#123; &#123; date &#125; &#125;</span><br><span class="line"><span class="section"># 复杂：预置层级分类，后续文章自动套用</span></span><br><span class="line">categories: [GIS, GeoServer]</span><br><span class="line"><span class="section">tags:</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure>

<p>使用（指定脚手架名）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 复杂：--s 指定使用自定义脚手架 &quot;gis&quot;</span></span><br><span class="line">hexo new --s gis <span class="string">&quot;瓦片缓存策略&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>示例 2：NextJS 系列脚手架</strong><br><code>scaffolds/nextjs.md</code>：</p>
<figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: &#123; &#123; title &#125; &#125;</span><br><span class="line">date: &#123; &#123; date &#125; &#125;</span><br><span class="line">categories: [前端, NextJS]</span><br><span class="line"><span class="section">tags:</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure>

<p>使用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo new --s nextjs <span class="string">&quot;App Router 与 RBAC&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>贴士（可选）：在 <code>package.json</code> 里加脚本别名，敲更短：</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;new:gis&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hexo new --s gis&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;new:next&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hexo new --s nextjs&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>使用：<code>npm run new:gis &quot;OpenLayers 点聚合最佳实践&quot;</code></p>
<hr>
<h2 id="五、目录结构示例（仅供参考）"><a href="#五、目录结构示例（仅供参考）" class="headerlink" title="五、目录结构示例（仅供参考）"></a>五、目录结构示例（仅供参考）</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">source/_posts/</span><br><span class="line">├─ GIS/</span><br><span class="line">│  └─ GeoServer/</span><br><span class="line">│     ├─ 切片入门.md</span><br><span class="line">│     ├─ 切片入门/         # 文章同名资源文件夹（图片等）</span><br><span class="line">│     └─ 缓存与预热.md</span><br><span class="line">└─ 前端/</span><br><span class="line">   └─ NextJS/</span><br><span class="line">      └─ App Router 与 RBAC.md</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>：物理目录<strong>不会</strong>自动变成 URL；URL 由 <code>permalink</code> + 文章的 <code>categories</code> 决定。</p>
</blockquote>
<hr>
<h2 id="六、搜索与站点生成（与你现有配置兼容）"><a href="#六、搜索与站点生成（与你现有配置兼容）" class="headerlink" title="六、搜索与站点生成（与你现有配置兼容）"></a>六、搜索与站点生成（与你现有配置兼容）</h2><p>你已使用 <code>hexo-generator-searchdb</code>（本地搜索），与分目录&#x2F;层级分类<strong>无冲突</strong>，无需额外改动。<br>每次发文后按旧流程即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hexo clean &amp;&amp; hexo g &amp;&amp; hexo s</span><br><span class="line"><span class="comment"># 自动部署（GitHub Actions）仍是：git add . &amp;&amp; git commit &amp;&amp; git push</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="七、常见坑位（快速定位）"><a href="#七、常见坑位（快速定位）" class="headerlink" title="七、常见坑位（快速定位）"></a>七、常见坑位（快速定位）</h2><ul>
<li><p><strong>页面 404 &#x2F; 样式丢失</strong>：<code>_config.yml</code> 的 <code>url/root</code> 未按<strong>项目页子路径</strong>设置（应为 <code>/blog/</code>）。</p>
</li>
<li><p><strong>URL 没有层级</strong>：缺少 <code>permalink: :categories/:title/</code> 或文章没写 <code>categories: [父, 子]</code>。</p>
</li>
<li><p><strong>分类页不展示树</strong>：<code>source/categories/index.md</code> 的 <code>type</code> 不是 <code>categories</code>；或主题菜单未加入口。</p>
</li>
<li><p><strong>物理目录改变但 URL 想保持不变</strong>：别动 front-matter 的 <code>categories</code>，URL 就不会变。</p>
</li>
<li><p><strong>想迁移到“用户页”（根路径）</strong>：把仓库改名为 <code>&lt;用户名&gt;.github.io</code>，并把</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 复杂：用户页改为根路径部署</span></span><br><span class="line"><span class="attr">url:</span> <span class="string">https://&lt;用户名&gt;.github.io</span></span><br><span class="line"><span class="attr">root:</span> <span class="string">/</span></span><br></pre></td></tr></table></figure>

<p>重新部署即可。</p>
</li>
</ul>
<hr>
<h2 id="复盘清单（照这个一项项核对）"><a href="#复盘清单（照这个一项项核对）" class="headerlink" title="复盘清单（照这个一项项核对）"></a>复盘清单（照这个一项项核对）</h2><ul>
<li><p><input disabled="" type="checkbox"> 
<code>_config.yml</code> 已设置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">permalink:</span> <span class="string">:categories/:title/</span></span><br><span class="line"><span class="attr">url:</span> <span class="string">https://herongxhr-netizen.github.io/blog</span></span><br><span class="line"><span class="attr">root:</span> <span class="string">/blog/</span></span><br><span class="line"><span class="attr">post_asset_folder:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><input disabled="" type="checkbox"> 
文章 front-matter 用层级分类（<code>[父, 子]</code>）。</p>
</li>
<li><p><input disabled="" type="checkbox"> 
有 <code>source/categories/index.md</code> 与 <code>type: categories</code>。</p>
</li>
<li><p><input disabled="" type="checkbox"> 
NexT 菜单里有 <code>/categories/</code> 与 <code>/tags/</code>。</p>
</li>
<li><p><input disabled="" type="checkbox"> 
脚手架按需要创建（<code>scaffolds/*.md</code>），新建时用 <code>hexo new --s &lt;脚手架&gt; &quot;标题&quot;</code>。</p>
</li>
</ul>
<hr>
<h3 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h3><p><strong>Q：必须物理分目录吗？</strong><br>A：不是必须，但<strong>强烈建议</strong>。这样 Git 与编辑器里都更可管理；而 URL&#x2F;导航交给分类层级来控制，二者解耦。</p>
<p><strong>Q：以后想批量重构目录怎么办？</strong><br>A：直接移动文件夹即可；只要 front-matter 的 <code>categories</code> 不改，URL 不会变（避免 SEO 损失）。</p>
<p><strong>Q：图片怎么引用？</strong><br>A：启用 <code>post_asset_folder: true</code> 后，文章内用相对路径（如 <code>![](切片入门/示意图.png)</code>）即可。</p>
<hr>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/04/hexo%E5%8D%9A%E5%AE%A2%E5%88%86%E7%B1%BB%E5%88%86%E7%9B%AE%E5%BD%95%E7%BB%84%E7%BB%87/" data-id="cmf9bdhke000aqq4z03dp1fcw" data-title="Hexo 千篇文章的“分目录存储 + 目录树导航”实战（含 URL、分类、脚手架）" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/GitHub-Pages/" rel="tag">GitHub Pages</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NexT/" rel="tag">NexT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%88%86%E7%B1%BB/" rel="tag">分类</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%9B%AE%E5%BD%95/" rel="tag">目录</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/web%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/">web应用开发</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/web%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E5%89%8D%E7%AB%AF/">前端</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/401/" rel="tag">401</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AbortController/" rel="tag">AbortController</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Axios/" rel="tag">Axios</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fetch/" rel="tag">Fetch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GitHub-Pages/" rel="tag">GitHub Pages</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MSW/" rel="tag">MSW</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NexT/" rel="tag">NexT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenAPI/" rel="tag">OpenAPI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Passkeys/" rel="tag">Passkeys</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pinia/" rel="tag">Pinia</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TanStack-Query/" rel="tag">TanStack Query</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript/" rel="tag">TypeScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UTS-%E6%8F%92%E4%BB%B6/" rel="tag">UTS 插件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vite/" rel="tag">Vite</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue-3/" rel="tag">Vue 3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue-Router/" rel="tag">Vue Router</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue3/" rel="tag">Vue3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebAuthn/" rel="tag">WebAuthn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/composable/" rel="tag">composable</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rollup-plugin-visualizer/" rel="tag">rollup-plugin-visualizer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/store%E8%AF%B7%E6%B1%82/" rel="tag">store请求</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uni-app-x/" rel="tag">uni-app x</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%80%E9%94%AE%E7%9B%B4%E7%99%BB/" rel="tag">一键直登</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%8B%E8%BD%BD/" rel="tag">下载</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E7%B1%BB/" rel="tag">分类</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%9D%E5%A7%8B%E5%8C%96/" rel="tag">初始化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF/" rel="tag">前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E6%9E%B6%E6%9E%84/" rel="tag">前端架构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%AF%E4%BD%9C%E7%94%A8%E6%8E%A7%E5%88%B6/" rel="tag">副作用控制</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%9A%E5%AE%A2/" rel="tag">博客</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%A7%E5%8E%82%E5%AE%9E%E8%B7%B5/" rel="tag">大厂实践</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%89%93%E5%8C%85%E5%88%86%E6%9E%90/" rel="tag">打包分析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%AA%E7%99%BB%E5%BD%95%E6%8B%A6%E6%88%AA/" rel="tag">未登录拦截</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%9B%AE%E5%BD%95/" rel="tag">目录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95/" rel="tag">退出登录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%89%B4%E6%9D%83/" rel="tag">鉴权</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/401/" style="font-size: 10px;">401</a> <a href="/tags/AbortController/" style="font-size: 10px;">AbortController</a> <a href="/tags/Axios/" style="font-size: 20px;">Axios</a> <a href="/tags/Fetch/" style="font-size: 10px;">Fetch</a> <a href="/tags/GitHub-Pages/" style="font-size: 15px;">GitHub Pages</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/MSW/" style="font-size: 10px;">MSW</a> <a href="/tags/NexT/" style="font-size: 10px;">NexT</a> <a href="/tags/OpenAPI/" style="font-size: 10px;">OpenAPI</a> <a href="/tags/Passkeys/" style="font-size: 10px;">Passkeys</a> <a href="/tags/Pinia/" style="font-size: 20px;">Pinia</a> <a href="/tags/TanStack-Query/" style="font-size: 10px;">TanStack Query</a> <a href="/tags/TypeScript/" style="font-size: 20px;">TypeScript</a> <a href="/tags/UTS-%E6%8F%92%E4%BB%B6/" style="font-size: 10px;">UTS 插件</a> <a href="/tags/Vite/" style="font-size: 10px;">Vite</a> <a href="/tags/Vue-3/" style="font-size: 10px;">Vue 3</a> <a href="/tags/Vue-Router/" style="font-size: 10px;">Vue Router</a> <a href="/tags/Vue3/" style="font-size: 15px;">Vue3</a> <a href="/tags/WebAuthn/" style="font-size: 10px;">WebAuthn</a> <a href="/tags/composable/" style="font-size: 10px;">composable</a> <a href="/tags/rollup-plugin-visualizer/" style="font-size: 10px;">rollup-plugin-visualizer</a> <a href="/tags/store%E8%AF%B7%E6%B1%82/" style="font-size: 10px;">store请求</a> <a href="/tags/uni-app-x/" style="font-size: 10px;">uni-app x</a> <a href="/tags/%E4%B8%80%E9%94%AE%E7%9B%B4%E7%99%BB/" style="font-size: 10px;">一键直登</a> <a href="/tags/%E4%B8%8B%E8%BD%BD/" style="font-size: 10px;">下载</a> <a href="/tags/%E5%88%86%E7%B1%BB/" style="font-size: 10px;">分类</a> <a href="/tags/%E5%88%9D%E5%A7%8B%E5%8C%96/" style="font-size: 10px;">初始化</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 10px;">前端</a> <a href="/tags/%E5%89%8D%E7%AB%AF%E6%9E%B6%E6%9E%84/" style="font-size: 10px;">前端架构</a> <a href="/tags/%E5%89%AF%E4%BD%9C%E7%94%A8%E6%8E%A7%E5%88%B6/" style="font-size: 10px;">副作用控制</a> <a href="/tags/%E5%8D%9A%E5%AE%A2/" style="font-size: 10px;">博客</a> <a href="/tags/%E5%A4%A7%E5%8E%82%E5%AE%9E%E8%B7%B5/" style="font-size: 10px;">大厂实践</a> <a href="/tags/%E6%89%93%E5%8C%85%E5%88%86%E6%9E%90/" style="font-size: 10px;">打包分析</a> <a href="/tags/%E6%9C%AA%E7%99%BB%E5%BD%95%E6%8B%A6%E6%88%AA/" style="font-size: 10px;">未登录拦截</a> <a href="/tags/%E7%9B%AE%E5%BD%95/" style="font-size: 10px;">目录</a> <a href="/tags/%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95/" style="font-size: 10px;">退出登录</a> <a href="/tags/%E9%89%B4%E6%9D%83/" style="font-size: 10px;">鉴权</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/09/">September 2025</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/09/07/id-kit%E5%BC%80%E5%8F%91/">id-kit开发</a>
          </li>
        
          <li>
            <a href="/2025/09/07/id-kit/">id-kit</a>
          </li>
        
          <li>
            <a href="/2025/09/07/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2025/09/06/%E7%99%BB%E5%BD%95%E5%90%8E%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E5%8F%8C%E9%98%B6%E6%AE%B5%E5%90%AF%E5%8A%A8%EF%BC%88%E5%A2%9E%E9%87%8F%E4%BF%AE%E6%94%B9%EF%BC%89/">在 composable 里“公共初始化 + 登录后初始化”的双阶段启动（增量修改）</a>
          </li>
        
          <li>
            <a href="/2025/09/06/%E4%BD%93%E7%A7%AF%E5%88%86%E5%B8%83%E5%88%86%E6%9E%90%E5%9B%BE/">Vite + Vue3 打包后如何查看“体积分布分析图”</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>