<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://herongdev.github.io/blog/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://herongdev.github.io/blog"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-id-kit开发" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/07/id-kit%E5%BC%80%E5%8F%91/" class="article-date">
  <time class="dt-published" datetime="2025-09-07T12:57:14.000Z" itemprop="datePublished">2025-09-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/07/id-kit%E5%BC%80%E5%8F%91/">id-kit开发</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="一、插件命名-目录结构"><a href="#一、插件命名-目录结构" class="headerlink" title="一、插件命名 &amp; 目录结构"></a>一、插件命名 &amp; 目录结构</h1><p><strong>插件名</strong>：<code>uni-id-kit</code>（简洁、易记、符合 uni 插件生态）</p>
<ul>
<li>英文：<strong>UniIdKit</strong></li>
<li>中文：<strong>一体设备 ID 工具包</strong></li>
</ul>
<p><strong>目录（uni_modules 标准）</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">uni_modules/</span><br><span class="line">  uni-id-kit/</span><br><span class="line">    package.json</span><br><span class="line">    module.json</span><br><span class="line">    utssdk/</span><br><span class="line">      index.uts              # 聚合导出（按平台分发）</span><br><span class="line">      common/</span><br><span class="line">        types.uts            # 类型与常量定义（复用）</span><br><span class="line">        hash.uts             # SHA-256 工具（Web/Android 均可）</span><br><span class="line">        storage.uts          # 本地缓存工具（uni.storage封装）</span><br><span class="line">      web/</span><br><span class="line">        index.uts            # Web 实现（GUID、hash、缓存）</span><br><span class="line">      app-android/</span><br><span class="line">        index.uts            # Android 实现（AndroidID，OAID/AAID占位）</span><br><span class="line">        adapters/</span><br><span class="line">          android_id.uts     # ANDROID_ID</span><br><span class="line">          aaid.uts           # Google AAID（待接SDK）</span><br><span class="line">          oaid.uts           # MSA OAID  （待接SDK）</span><br><span class="line">          pseudo_id.uts      # 伪ID（可选）</span><br></pre></td></tr></table></figure>

<blockquote>
<p>iOS（IDFV）可稍后补：<code>app-ios/index.uts</code> + <code>adapters/idfv.uts</code>。<br>你让我们“先国内”，就先 <strong>Web→Android</strong>；Android 国内核心是 <strong>AndroidID&#x2F;OAID</strong>，海外补 <strong>AAID</strong>。</p>
</blockquote>
<hr>
<h1 id="二、API-设计（Promise-回调兼容）"><a href="#二、API-设计（Promise-回调兼容）" class="headerlink" title="二、API 设计（Promise + 回调兼容）"></a>二、API 设计（Promise + 回调兼容）</h1><blockquote>
<p>统一 Promise 风格，另兼容回调（可选）；返回结构“可读 + 可扩展”。</p>
</blockquote>
<h2 id="公开方法"><a href="#公开方法" class="headerlink" title="公开方法"></a>公开方法</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1) 隐私合规：注册/初始化（未同意时一律返回 available=false）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"><span class="attr">options</span>?: &#123;</span></span><br><span class="line"><span class="params">  showPrivacyDialog?: <span class="built_in">boolean</span>; // 需要时展示你自有的隐私弹窗</span></span><br><span class="line"><span class="params">&#125;</span>): <span class="title class_">Promise</span>&lt;&#123; <span class="attr">consent</span>: <span class="built_in">boolean</span> &#125;&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2) 配置哈希盐（建议服务端下发）；默认仅返回 hash</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3) 一次性获取所有可用的 ID（聚合）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"><span class="attr">options</span>?: &#123;</span></span><br><span class="line"><span class="params">  include?: <span class="built_in">Array</span>&lt;</span></span><br><span class="line"><span class="params">    | <span class="string">&quot;oaid&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;aaid&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;androidId&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;idfv&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;widevineId&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;pseudoId&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;imei&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;guid&quot;</span></span></span><br><span class="line"><span class="params">  &gt;;</span></span><br><span class="line"><span class="params">  exposeRaw?: <span class="built_in">boolean</span>; // 默认 <span class="literal">false</span>（仅返回hash），开启后返回原值 value</span></span><br><span class="line"><span class="params">  ttlMs?: <span class="built_in">number</span>; // 缓存有效期，默认 24h</span></span><br><span class="line"><span class="params">&#125;</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4) 返回“最合适”的一个（按优先级：国内默认 oaid &gt; androidId &gt; guid）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"><span class="attr">options</span>?: &#123;</span></span><br><span class="line"><span class="params">  prefer?: <span class="built_in">Array</span>&lt;<span class="string">&quot;oaid&quot;</span> | <span class="string">&quot;aaid&quot;</span> | <span class="string">&quot;androidId&quot;</span> | <span class="string">&quot;idfv&quot;</span> | <span class="string">&quot;guid&quot;</span>&gt;; // 可自定义优先级</span></span><br><span class="line"><span class="params">  exposeRaw?: <span class="built_in">boolean</span>;</span></span><br><span class="line"><span class="params">  ttlMs?: <span class="built_in">number</span>;</span></span><br><span class="line"><span class="params">&#125;</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5) 单项拉取（必要时）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br></pre></td></tr></table></figure>

<h2 id="返回类型（最佳实践）"><a href="#返回类型（最佳实践）" class="headerlink" title="返回类型（最佳实践）"></a>返回类型（最佳实践）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utssdk/common/types.uts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdValue</span> = &#123;</span><br><span class="line">  <span class="attr">value</span>?: <span class="built_in">string</span>; <span class="comment">// 原始值（exposeRaw=true 才返回）</span></span><br><span class="line">  <span class="attr">hash</span>?: <span class="built_in">string</span>; <span class="comment">// SHA-256(value + salt) 十六进制</span></span><br><span class="line">  <span class="attr">available</span>: <span class="built_in">boolean</span>; <span class="comment">// 是否获取成功</span></span><br><span class="line">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>; <span class="comment">// 是否受限（系统关闭广告跟踪等）</span></span><br><span class="line">  <span class="attr">source</span>: <span class="built_in">string</span>; <span class="comment">// oaid/aaid/androidId/idfv/guid/...</span></span><br><span class="line">  <span class="attr">message</span>?: <span class="built_in">string</span>; <span class="comment">// 失败或说明</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">  <span class="attr">oaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">aaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">androidId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">idfv</span>?: <span class="title class_">IdValue</span>; <span class="comment">// 预留给 iOS</span></span><br><span class="line">  <span class="attr">widevineId</span>?: <span class="title class_">IdValue</span>; <span class="comment">// 可选</span></span><br><span class="line">  <span class="attr">pseudoId</span>?: <span class="title class_">IdValue</span>; <span class="comment">// 可选</span></span><br><span class="line">  <span class="attr">imei</span>?: <span class="title class_">IdValue</span>; <span class="comment">// 不建议默认启用</span></span><br><span class="line">  <span class="attr">guid</span>?: <span class="title class_">IdValue</span>; <span class="comment">// H5/兜底</span></span><br><span class="line">  <span class="attr">best</span>?: <span class="built_in">string</span> | <span class="literal">null</span>; <span class="comment">// 最佳项的 key</span></span><br><span class="line">  <span class="attr">consent</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">ts</span>: <span class="built_in">number</span>; <span class="comment">// 生成时间戳</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="三、首版代码（可直接放进项目）"><a href="#三、首版代码（可直接放进项目）" class="headerlink" title="三、首版代码（可直接放进项目）"></a>三、首版代码（可直接放进项目）</h1><blockquote>
<p><strong>说明</strong>：以下代码为 <strong>可运行骨架</strong>。</p>
<ul>
<li>Web：已可直接返回 <code>guid</code>（localStorage&#x2F;uni.storage 持久化），并做 SHA-256。</li>
<li>Android：已可返回 <strong>AndroidID</strong>（无需额外权限），OAID&#x2F;AAID 先返回占位（后续你把 SDK 接上）。</li>
<li>聚合导出：<code>utssdk/index.uts</code> 会按平台引导到对应实现。</li>
</ul>
</blockquote>
<h2 id="1）uni-modules-uni-id-kit-module-json"><a href="#1）uni-modules-uni-id-kit-module-json" class="headerlink" title="1）uni_modules/uni-id-kit/module.json"></a>1）<code>uni_modules/uni-id-kit/module.json</code></h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uni-id-kit&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;displayName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UniIdKit - 一体设备ID工具包&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;聚合 OAID/AAID/AndroidID/GUID 等设备标识，合规&amp;哈希化输出&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;keywords&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;deviceid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;oaid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;aaid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;androidid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;guid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;uts&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;repository&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;engines&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;HBuilderX&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^3.8.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;uni_modules&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;platforms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;app-android&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;utssdk&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;kotlin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&gt;=1.7.0&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;web&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;utssdk&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="2）uni-modules-uni-id-kit-utssdk-common-types-uts"><a href="#2）uni-modules-uni-id-kit-utssdk-common-types-uts" class="headerlink" title="2）uni_modules/uni-id-kit/utssdk/common/types.uts"></a>2）<code>uni_modules/uni-id-kit/utssdk/common/types.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdValue</span> = &#123;</span><br><span class="line">  <span class="attr">value</span>?: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">hash</span>?: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">available</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">source</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">message</span>?: <span class="built_in">string</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">  <span class="attr">oaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">aaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">androidId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">idfv</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">widevineId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">pseudoId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">imei</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">guid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">best</span>?: <span class="built_in">string</span> | <span class="literal">null</span>;</span><br><span class="line">  <span class="attr">consent</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">ts</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="3）uni-modules-uni-id-kit-utssdk-common-hash-uts"><a href="#3）uni-modules-uni-id-kit-utssdk-common-hash-uts" class="headerlink" title="3）uni_modules/uni-id-kit/utssdk/common/hash.uts"></a>3）<code>uni_modules/uni-id-kit/utssdk/common/hash.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Web 有 crypto.subtle；Android 走 Java MessageDigest（见安卓实现）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sha256Hex</span>(<span class="params"><span class="attr">input</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// @ts-ignore</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">g</span>: <span class="built_in">any</span> = globalThis;</span><br><span class="line">  <span class="keyword">if</span> (g &amp;&amp; g.<span class="property">crypto</span> &amp;&amp; g.<span class="property">crypto</span>.<span class="property">subtle</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> enc = <span class="keyword">new</span> <span class="title class_">TextEncoder</span>().<span class="title function_">encode</span>(input);</span><br><span class="line">    <span class="keyword">const</span> buf = <span class="keyword">await</span> g.<span class="property">crypto</span>.<span class="property">subtle</span>.<span class="title function_">digest</span>(<span class="string">&quot;SHA-256&quot;</span>, enc);</span><br><span class="line">    <span class="keyword">const</span> arr = <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(buf));</span><br><span class="line">    <span class="keyword">return</span> arr.<span class="title function_">map</span>(<span class="function">(<span class="params">b</span>) =&gt;</span> b.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">2</span>, <span class="string">&quot;0&quot;</span>)).<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 无 WebCrypto 时，先退回原文（开发期），建议后续接原生或 JS 实现</span></span><br><span class="line">  <span class="keyword">return</span> input;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4）uni-modules-uni-id-kit-utssdk-common-storage-uts"><a href="#4）uni-modules-uni-id-kit-utssdk-common-storage-uts" class="headerlink" title="4）uni_modules/uni-id-kit/utssdk/common/storage.uts"></a>4）<code>uni_modules/uni-id-kit/utssdk/common/storage.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span></span>): <span class="built_in">string</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">return</span> uni.<span class="title function_">getStorageSync</span>(key) || <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">set</span>(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span>, <span class="attr">val</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    uni.<span class="title function_">setStorageSync</span>(key, val);</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5）uni-modules-uni-id-kit-utssdk-web-index-uts（Web-实现）"><a href="#5）uni-modules-uni-id-kit-utssdk-web-index-uts（Web-实现）" class="headerlink" title="5）uni_modules/uni-id-kit/utssdk/web/index.uts（Web 实现）"></a>5）<code>uni_modules/uni-id-kit/utssdk/web/index.uts</code>（Web 实现）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">IdCodesResult</span>, <span class="title class_">IdValue</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../common/types.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; sha256Hex &#125; <span class="keyword">from</span> <span class="string">&quot;../common/hash.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; get, set &#125; <span class="keyword">from</span> <span class="string">&quot;../common/storage.uts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _consent = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> _salt = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">uuid4</span>(<span class="params"></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&quot;</span>.<span class="title function_">replace</span>(<span class="regexp">/[xy]/g</span>, <span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> r = ((<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">16</span>) <span class="keyword">as</span> <span class="built_in">number</span>) | <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> v = c === <span class="string">&quot;x&quot;</span> ? r : (r &amp; <span class="number">0x3</span>) | <span class="number">0x8</span>;</span><br><span class="line">    <span class="keyword">return</span> v.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">build</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">source</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">value</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">msg</span>?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> available = !!value;</span><br><span class="line">  <span class="keyword">const</span> raw = exposeRaw ? value : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">const</span> hash = value ? <span class="keyword">await</span> <span class="title function_">sha256Hex</span>(value + _salt) : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">value</span>: raw, hash, available, limited, source, <span class="attr">message</span>: msg &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">_</span>: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span> = <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">UTSJSONObject</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// Web demo：默认视为已同意；你可以在这里弹你的隐私弹窗</span></span><br><span class="line">  _consent = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">consent</span>: _consent &#125; <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  _salt = salt || <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"><span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> guid = <span class="title function_">get</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!guid) &#123;</span><br><span class="line">    guid = <span class="string">`web:<span class="subst">$&#123;uuid4()&#125;</span>`</span>;</span><br><span class="line">    <span class="title function_">set</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>, guid);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;guid&quot;</span>, guid <span class="keyword">as</span> <span class="built_in">string</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// Web 没有 AndroidID</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="literal">undefined</span>,</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;Not supported on Web&quot;</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;oaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="string">&quot;Not supported on Web&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;aaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="string">&quot;Not supported on Web&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> include = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;include&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;aaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">res</span>: <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">    <span class="attr">consent</span>: _consent,</span><br><span class="line">    <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">  &#125; <span class="keyword">as</span> <span class="title class_">IdCodesResult</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!_consent) &#123;</span><br><span class="line">    res.<span class="property">guid</span> = &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;guid&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;consent=false&quot;</span> &#125;;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;guid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">guid</span> = <span class="keyword">await</span> <span class="title function_">getGuid</span>(exposeRaw);</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;androidId&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">androidId</span> = <span class="keyword">await</span> <span class="title function_">getAndroidId</span>();</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;oaid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">oaid</span> = <span class="keyword">await</span> <span class="title function_">getOAID</span>();</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;aaid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">aaid</span> = <span class="keyword">await</span> <span class="title function_">getAAID</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 国内默认优先级</span></span><br><span class="line">  <span class="keyword">const</span> order = [<span class="string">&quot;oaid&quot;</span>, <span class="string">&quot;androidId&quot;</span>, <span class="string">&quot;guid&quot;</span>];</span><br><span class="line">  res.<span class="property">best</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; order.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> k = order[i];</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">v</span>: <span class="title class_">IdValue</span> | <span class="literal">null</span> = (res <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[k] <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line">    <span class="keyword">if</span> (v &amp;&amp; v.<span class="property">available</span>) &#123;</span><br><span class="line">      res.<span class="property">best</span> = k;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> arr = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;prefer&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="keyword">const</span> r = <span class="keyword">await</span> <span class="title function_">getIdCodes</span>(&#123; <span class="attr">include</span>: arr <span class="keyword">as</span> <span class="built_in">any</span>, exposeRaw &#125; <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">if</span> (r.<span class="property">best</span>) &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">return</span> (r <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[r.<span class="property">best</span>] <span class="keyword">as</span> <span class="title class_">IdValue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;none&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;no id available&quot;</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6）uni-modules-uni-id-kit-utssdk-app-android-adapters-android-id-uts"><a href="#6）uni-modules-uni-id-kit-utssdk-app-android-adapters-android-id-uts" class="headerlink" title="6）uni_modules/uni-id-kit/utssdk/app-android/adapters/android_id.uts"></a>6）<code>uni_modules/uni-id-kit/utssdk/app-android/adapters/android_id.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ANDROID_ID，无需额外权限（相对稳定，但可能因某些ROM策略变化）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAndroidIdRaw</span>(<span class="params"></span>): <span class="built_in">string</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> ctx = plus.<span class="property">android</span>.<span class="title function_">runtimeMainActivity</span>();</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">SettingsSecure</span> = plus.<span class="property">android</span>.<span class="title function_">importClass</span>(</span><br><span class="line">      <span class="string">&quot;android.provider.Settings$Secure&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> contentResolver = ctx.<span class="title function_">getContentResolver</span>();</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> id = <span class="title class_">SettingsSecure</span>.<span class="title function_">getString</span>(</span><br><span class="line">      contentResolver,</span><br><span class="line">      <span class="string">&quot;android_id&quot;</span></span><br><span class="line">    ) <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line">    <span class="keyword">return</span> id ? <span class="string">`android:<span class="subst">$&#123;id&#125;</span>`</span> : <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7）uni-modules-uni-id-kit-utssdk-app-android-index-uts"><a href="#7）uni-modules-uni-id-kit-utssdk-app-android-index-uts" class="headerlink" title="7）uni_modules/uni-id-kit/utssdk/app-android/index.uts"></a>7）<code>uni_modules/uni-id-kit/utssdk/app-android/index.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">IdCodesResult</span>, <span class="title class_">IdValue</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../common/types.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; get, set &#125; <span class="keyword">from</span> <span class="string">&quot;../common/storage.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getAndroidIdRaw &#125; <span class="keyword">from</span> <span class="string">&quot;./adapters/android_id.uts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _consent = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> _salt = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Android 原生侧用 Java 的 MessageDigest 做 SHA-256 更稳，这里暂用 Web 版占位：</span></span><br><span class="line"><span class="comment">// 你也可以在此通过 plus.android.importClass 使用 java.security.MessageDigest 实现</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sha256Hex</span>(<span class="params"><span class="attr">input</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> input; <span class="comment">// <span class="doctag">TODO:</span> 接入原生 MessageDigest 后返回真 SHA-256</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">uuid4</span>(<span class="params"></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&quot;</span>.<span class="title function_">replace</span>(<span class="regexp">/[xy]/g</span>, <span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> r = ((<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">16</span>) <span class="keyword">as</span> <span class="built_in">number</span>) | <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> v = c === <span class="string">&quot;x&quot;</span> ? r : (r &amp; <span class="number">0x3</span>) | <span class="number">0x8</span>;</span><br><span class="line">    <span class="keyword">return</span> v.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">build</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">source</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">value</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">msg</span>?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> available = !!value;</span><br><span class="line">  <span class="keyword">const</span> raw = exposeRaw ? value : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">const</span> hash = value ? <span class="keyword">await</span> <span class="title function_">sha256Hex</span>(value + _salt) : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">value</span>: raw, hash, available, limited, source, <span class="attr">message</span>: msg &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">_</span>: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span> = <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">UTSJSONObject</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// 这里接入你的合规弹窗/SDK；同意前建议不采集</span></span><br><span class="line">  _consent = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">consent</span>: _consent &#125; <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  _salt = salt || <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> v = <span class="title function_">getAndroidIdRaw</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;androidId&quot;</span>, v || <span class="literal">undefined</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 预留：接入 Google Advertising ID（AAID）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// TODO：集成 com.google.android.gms:play-services-ads-identifier</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;aaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="string">&quot;AAID not integrated&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 预留：接入 MSA OAID（国内主流）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// TODO：接入 MSA/OAID SDK</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;oaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="string">&quot;OAID not integrated&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"><span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> guid = <span class="title function_">get</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!guid) &#123;</span><br><span class="line">    guid = <span class="string">`app:<span class="subst">$&#123;uuid4()&#125;</span>`</span>;</span><br><span class="line">    <span class="title function_">set</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>, guid);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;guid&quot;</span>, guid <span class="keyword">as</span> <span class="built_in">string</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> include = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;include&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;aaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">res</span>: <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">    <span class="attr">consent</span>: _consent,</span><br><span class="line">    <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">  &#125; <span class="keyword">as</span> <span class="title class_">IdCodesResult</span>;</span><br><span class="line">  <span class="keyword">if</span> (!_consent) &#123;</span><br><span class="line">    res.<span class="property">guid</span> = &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;guid&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;consent=false&quot;</span> &#125;;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;androidId&quot;</span>) &gt;= <span class="number">0</span>)</span><br><span class="line">    res.<span class="property">androidId</span> = <span class="keyword">await</span> <span class="title function_">getAndroidId</span>(exposeRaw);</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;oaid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">oaid</span> = <span class="keyword">await</span> <span class="title function_">getOAID</span>();</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;aaid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">aaid</span> = <span class="keyword">await</span> <span class="title function_">getAAID</span>();</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;guid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">guid</span> = <span class="keyword">await</span> <span class="title function_">getGuid</span>(exposeRaw);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 国内优先级：oaid &gt; androidId &gt; guid</span></span><br><span class="line">  <span class="keyword">const</span> order = [<span class="string">&quot;oaid&quot;</span>, <span class="string">&quot;androidId&quot;</span>, <span class="string">&quot;guid&quot;</span>];</span><br><span class="line">  res.<span class="property">best</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; order.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> k = order[i];</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">v</span>: <span class="title class_">IdValue</span> | <span class="literal">null</span> = (res <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[k] <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line">    <span class="keyword">if</span> (v &amp;&amp; v.<span class="property">available</span>) &#123;</span><br><span class="line">      res.<span class="property">best</span> = k;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> arr = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;prefer&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="keyword">const</span> r = <span class="keyword">await</span> <span class="title function_">getIdCodes</span>(&#123; <span class="attr">include</span>: arr <span class="keyword">as</span> <span class="built_in">any</span>, exposeRaw &#125; <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">if</span> (r.<span class="property">best</span>) &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">return</span> (r <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[r.<span class="property">best</span>] <span class="keyword">as</span> <span class="title class_">IdValue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;none&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;no id available&quot;</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8）uni-modules-uni-id-kit-utssdk-index-uts（聚合导出）"><a href="#8）uni-modules-uni-id-kit-utssdk-index-uts（聚合导出）" class="headerlink" title="8）uni_modules/uni-id-kit/utssdk/index.uts（聚合导出）"></a>8）<code>uni_modules/uni-id-kit/utssdk/index.uts</code>（聚合导出）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 平台分发：同名导出，业务方 import 一处即可</span></span><br><span class="line"><span class="comment">// #ifdef APP-ANDROID</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  register,</span><br><span class="line">  setSalt,</span><br><span class="line">  getIdCodes,</span><br><span class="line">  getBestId,</span><br><span class="line">  getOAID,</span><br><span class="line">  getAAID,</span><br><span class="line">  getAndroidId,</span><br><span class="line">  getGuid,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./app-android/index.uts&quot;</span>;</span><br><span class="line"><span class="comment">// #endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #ifdef H5</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  register,</span><br><span class="line">  setSalt,</span><br><span class="line">  getIdCodes,</span><br><span class="line">  getBestId,</span><br><span class="line">  getOAID,</span><br><span class="line">  getAAID,</span><br><span class="line">  getAndroidId,</span><br><span class="line">  getGuid,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./web/index.uts&quot;</span>;</span><br><span class="line"><span class="comment">// #endif</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="四、在页面中使用（uni-app-x）"><a href="#四、在页面中使用（uni-app-x）" class="headerlink" title="四、在页面中使用（uni-app x）"></a>四、在页面中使用（uni-app x）</h1><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/login/index.uvue (示例)</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  register,</span><br><span class="line">  setSalt,</span><br><span class="line">  getBestId,</span><br><span class="line">  getIdCodes,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;@/uni_modules/uni-id-kit/utssdk/index.uts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">onMounted</span>(<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">register</span>(); <span class="comment">// 视需求弹你的隐私协议</span></span><br><span class="line">  <span class="title function_">setSalt</span>(<span class="string">&quot;server-salt-xxx&quot;</span>); <span class="comment">// 建议从服务端下发</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> best = <span class="keyword">await</span> <span class="title function_">getBestId</span>(&#123; <span class="attr">exposeRaw</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">  <span class="comment">// 携带 best.hash 作为 x-device-id（或 getIdCodes 的 best 项）</span></span><br><span class="line">  <span class="keyword">const</span> dvc = best.<span class="property">hash</span> || best.<span class="property">value</span> || <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> uni.<span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">`<span class="subst">$&#123;baseUrl&#125;</span>/passkeys/login/options`</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    <span class="attr">header</span>: &#123; <span class="string">&quot;x-device-id&quot;</span>: dvc &#125;,</span><br><span class="line">    <span class="attr">data</span>: &#123;&#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="五、后续接入指引（Android-OAID-AAID）"><a href="#五、后续接入指引（Android-OAID-AAID）" class="headerlink" title="五、后续接入指引（Android OAID&#x2F;AAID）"></a>五、后续接入指引（Android OAID&#x2F;AAID）</h1><ul>
<li><strong>OAID</strong>：集成 <strong>MSA&#x2F;联运</strong> SDK（各大国产厂商支持），在 <code>app-android/adapters/oaid.uts</code> 中封装 <code>getOAIDRaw()</code>，在 <code>index.uts</code> 调 <code>await build(&#39;oaid&#39;, v, ...)</code>。</li>
<li><strong>AAID</strong>：添加 <code>com.google.android.gms:play-services-ads-identifier</code> 依赖，调用 <code>AdvertisingIdClient.getAdvertisingIdInfo(context)</code>。</li>
<li><strong>SHA-256</strong>：Android 侧推荐用 <code>java.security.MessageDigest</code>，性能更稳定；把 web 占位换掉。</li>
<li><strong>权限</strong>：AndroidID 不需要额外权限；IMEI&#x2F;MEID 需要 READ_PHONE_STATE（<strong>不推荐默认启用</strong>）。</li>
<li><strong>合规</strong>：未同意隐私协议前，一律返回 <code>available=false</code>；默认仅返回 <code>hash</code>，除非 <code>exposeRaw=true</code>。</li>
</ul>
<hr>
<p>如果你认可这个结构和 API，我可以继续把 <strong>Android 的 OAID&#x2F;AAID 具体适配代码</strong>补上（带依赖、打包参数、权限说明），以及 <strong>iOS 的 IDFV</strong> 版本。</p>
<h1 id="参考实现"><a href="#参考实现" class="headerlink" title="参考实现"></a>参考实现</h1><p>太好了，我把你这两个现成插件解包看过了，简单总结下各自实现，然后给一套“最佳实践”的统一 API 和落地改造方案（含可以直接替换的 UTS 代码片段）。</p>
<hr>
<h2 id="现有两个插件的实现差异（速览）"><a href="#现有两个插件的实现差异（速览）" class="headerlink" title="现有两个插件的实现差异（速览）"></a>现有两个插件的实现差异（速览）</h2><h3 id="1-android-deviceid（UTS，App-Android）"><a href="#1-android-deviceid（UTS，App-Android）" class="headerlink" title="1) android-deviceid（UTS，App-Android）"></a>1) <code>android-deviceid</code>（UTS，App-Android）</h3><ul>
<li><p><strong>用到的库</strong>：<code>com.github.gzuliyujiang.oaid</code>（常用 OAID SDK 聚合库），还打包了 3 个 AAR（<code>ads-identifier-*.aar</code>、<code>IDlibrary-release.aar</code>）。</p>
</li>
<li><p><strong>关键点</strong>：</p>
<ul>
<li>在 <code>register()</code> 里调用 <code>DeviceIdentifier.register(UTSAndroid.getUniActivity().getApplication())</code> 完成 <strong>OAID 初始化</strong>。</li>
<li>暴露了一个 <strong>监听器</strong>（<code>IDManger.OnIOAIDListener</code>），把厂商返回的 JSON 结果转成你定义的 <code>Device</code> 对象回调出去。</li>
</ul>
</li>
<li><p><strong>优点</strong>：能拿到 <strong>OAID</strong>，并且是较为标准的做法；兼容多厂商。</p>
</li>
<li><p><strong>需要补强</strong>：</p>
<ul>
<li><strong>统一 Promise API</strong>（目前是回调），方便在页面里用 <code>await</code>。</li>
<li><strong>AAID（Google 广告 ID）</strong>、<strong>AndroidID</strong> 的兜底与优先级策略。</li>
<li><strong>隐私合规</strong>（register 同意前不采集）、<strong>hash-only</strong> 输出（默认只回传哈希，原值可开关）。</li>
<li><strong>缓存</strong>（ttl），防止频繁拉取。</li>
<li>错误&#x2F;受限标记（例如用户关闭了广告跟踪）。</li>
</ul>
</li>
</ul>
<h3 id="2-zws-uniqueid（UTS，App-Android）"><a href="#2-zws-uniqueid（UTS，App-Android）" class="headerlink" title="2) zws-uniqueid（UTS，App-Android）"></a>2) <code>zws-uniqueid</code>（UTS，App-Android）</h3><ul>
<li><strong>实现</strong>：拼接 <code>Build.*</code> 信息做一段文本，MD5 后作为“唯一 ID”。</li>
<li><strong>优点</strong>：无需权限&#x2F;SDK，易用。</li>
<li><strong>问题</strong>：这是典型 <strong>PseudoID</strong>，<strong>同型号&#x2F;同批次设备可能相同</strong>，也可能因 ROM&#x2F;版本变更；不适合用来做<strong>设备唯一绑定</strong>或风控。</li>
<li><strong>建议</strong>：可以作为 <code>pseudoId</code> 字段的<strong>最末位兜底</strong>，不要当主标识。</li>
</ul>
<hr>
<h2 id="建议的统一方案（名字可用你之前认可的：uni-id-kit）"><a href="#建议的统一方案（名字可用你之前认可的：uni-id-kit）" class="headerlink" title="建议的统一方案（名字可用你之前认可的：uni-id-kit）"></a>建议的统一方案（名字可用你之前认可的：<strong><code>uni-id-kit</code></strong>）</h2><p><strong>目标</strong>：同一份 UTS 插件，覆盖 Web&#x2F;H5 与 App-Android；API 一致、返回结构一致、默认合规（hash-only），国内优先级 <code>OAID &gt; AndroidID &gt; GUID &gt; PseudoID</code>，海外可加 <code>AAID</code>。</p>
<h3 id="统一-API（Promise-风格）"><a href="#统一-API（Promise-风格）" class="headerlink" title="统一 API（Promise 风格）"></a>统一 API（Promise 风格）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册/合规：未同意前一律 available=false</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"><span class="attr">options</span>?: &#123;</span></span><br><span class="line"><span class="params">  showPrivacyDialog?: <span class="built_in">boolean</span>;</span></span><br><span class="line"><span class="params">&#125;</span>): <span class="title class_">Promise</span>&lt;&#123; <span class="attr">consent</span>: <span class="built_in">boolean</span> &#125;&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置哈希盐（建议服务端下发）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一次性获取所有（含可用性、受限说明、hash）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"><span class="attr">options</span>?: &#123;</span></span><br><span class="line"><span class="params">  include?: <span class="built_in">Array</span>&lt;<span class="string">&quot;oaid&quot;</span> | <span class="string">&quot;aaid&quot;</span> | <span class="string">&quot;androidId&quot;</span> | <span class="string">&quot;pseudoId&quot;</span> | <span class="string">&quot;guid&quot;</span>&gt;;</span></span><br><span class="line"><span class="params">  exposeRaw?: <span class="built_in">boolean</span>; // 默认 <span class="literal">false</span></span></span><br><span class="line"><span class="params">  ttlMs?: <span class="built_in">number</span>; // 默认 24h</span></span><br><span class="line"><span class="params">&#125;</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回“最合适”的一个（按优先级，可定制）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"><span class="attr">options</span>?: &#123;</span></span><br><span class="line"><span class="params">  prefer?: <span class="built_in">Array</span>&lt;<span class="string">&quot;oaid&quot;</span> | <span class="string">&quot;androidId&quot;</span> | <span class="string">&quot;guid&quot;</span> | <span class="string">&quot;pseudoId&quot;</span> | <span class="string">&quot;aaid&quot;</span>&gt;;</span></span><br><span class="line"><span class="params">  exposeRaw?: <span class="built_in">boolean</span>;</span></span><br><span class="line"><span class="params">  ttlMs?: <span class="built_in">number</span>;</span></span><br><span class="line"><span class="params">&#125;</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 单项</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br></pre></td></tr></table></figure>

<p><strong>统一返回结构</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">IdValue</span> = &#123;</span><br><span class="line">  <span class="attr">value</span>?: <span class="built_in">string</span>; <span class="comment">// exposeRaw=true 才返回</span></span><br><span class="line">  <span class="attr">hash</span>?: <span class="built_in">string</span>; <span class="comment">// SHA-256(value + salt)</span></span><br><span class="line">  <span class="attr">available</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>; <span class="comment">// 例如系统关闭广告跟踪</span></span><br><span class="line">  <span class="attr">source</span>: <span class="built_in">string</span>; <span class="comment">// oaid/aaid/androidId/pseudoId/guid</span></span><br><span class="line">  <span class="attr">message</span>?: <span class="built_in">string</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">  <span class="attr">oaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">aaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">androidId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">pseudoId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">guid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">best</span>?: <span class="built_in">string</span> | <span class="literal">null</span>;</span><br><span class="line">  <span class="attr">consent</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">ts</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="如何改造你现有的两个插件"><a href="#如何改造你现有的两个插件" class="headerlink" title="如何改造你现有的两个插件"></a>如何改造你现有的两个插件</h2><blockquote>
<p>下面给的都是 <strong>直接能塞进工程</strong> 的 UTS 代码。你可以新建一个 <code>uni_modules/uni-id-kit</code>，把这两个插件的“能力”合在一起；或者在你现有 <code>android-deviceid</code> 里重构导出，效果一致。</p>
</blockquote>
<h3 id="1-公共类型与工具（common-types-uts、common-storage-uts、common-hash-uts）"><a href="#1-公共类型与工具（common-types-uts、common-storage-uts、common-hash-uts）" class="headerlink" title="1) 公共类型与工具（common/types.uts、common/storage.uts、common/hash.uts）"></a>1) 公共类型与工具（<code>common/types.uts</code>、<code>common/storage.uts</code>、<code>common/hash.uts</code>）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// common/types.uts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdValue</span> = &#123;</span><br><span class="line">  <span class="attr">value</span>?: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">hash</span>?: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">available</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">source</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">message</span>?: <span class="built_in">string</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">  <span class="attr">oaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">aaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">androidId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">pseudoId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">guid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">best</span>?: <span class="built_in">string</span> | <span class="literal">null</span>;</span><br><span class="line">  <span class="attr">consent</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">ts</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// common/storage.uts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span></span>): <span class="built_in">string</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uni.<span class="title function_">getStorageSync</span>(key) || <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">set</span>(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span>, <span class="attr">val</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    uni.<span class="title function_">setStorageSync</span>(key, val);</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// common/hash.uts（Web 有 crypto.subtle；Android 建议换成 MessageDigest）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sha256Hex</span>(<span class="params"><span class="attr">input</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// @ts-ignore</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">g</span>: <span class="built_in">any</span> = globalThis;</span><br><span class="line">  <span class="keyword">if</span> (g &amp;&amp; g.<span class="property">crypto</span> &amp;&amp; g.<span class="property">crypto</span>.<span class="property">subtle</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> enc = <span class="keyword">new</span> <span class="title class_">TextEncoder</span>().<span class="title function_">encode</span>(input);</span><br><span class="line">    <span class="keyword">const</span> buf = <span class="keyword">await</span> g.<span class="property">crypto</span>.<span class="property">subtle</span>.<span class="title function_">digest</span>(<span class="string">&quot;SHA-256&quot;</span>, enc);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(buf))</span><br><span class="line">      .<span class="title function_">map</span>(<span class="function">(<span class="params">b</span>) =&gt;</span> b.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">2</span>, <span class="string">&quot;0&quot;</span>))</span><br><span class="line">      .<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> input; <span class="comment">// Android 再换成原生 MessageDigest（见下）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-Web-实现（先把-H5-跑起来：GUID-hash-缓存）"><a href="#2-Web-实现（先把-H5-跑起来：GUID-hash-缓存）" class="headerlink" title="2) Web 实现（先把 H5 跑起来：GUID + hash + 缓存）"></a>2) Web 实现（先把 H5 跑起来：GUID + hash + 缓存）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// web/index.uts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">IdCodesResult</span>, <span class="title class_">IdValue</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../common/types.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; sha256Hex &#125; <span class="keyword">from</span> <span class="string">&quot;../common/hash.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; get, set &#125; <span class="keyword">from</span> <span class="string">&quot;../common/storage.uts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _consent = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> _salt = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">uuid4</span>(<span class="params"></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&quot;</span>.<span class="title function_">replace</span>(<span class="regexp">/[xy]/g</span>, <span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> r = ((<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">16</span>) <span class="keyword">as</span> <span class="built_in">number</span>) | <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> v = c === <span class="string">&quot;x&quot;</span> ? r : (r &amp; <span class="number">0x3</span>) | <span class="number">0x8</span>;</span><br><span class="line">    <span class="keyword">return</span> v.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">build</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">source</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">value</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">msg</span>?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> available = !!value;</span><br><span class="line">  <span class="keyword">const</span> raw = exposeRaw ? value : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">const</span> hash = value ? <span class="keyword">await</span> <span class="title function_">sha256Hex</span>(value + _salt) : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">value</span>: raw, hash, available, limited, source, <span class="attr">message</span>: msg &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">_</span>: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span> = <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">UTSJSONObject</span>&gt; &#123;</span><br><span class="line">  _consent = <span class="literal">true</span>; <span class="comment">// 你可在这里弹你的隐私协议</span></span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">consent</span>: _consent &#125; <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  _salt = salt || <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"><span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> guid = <span class="title function_">get</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!guid) &#123;</span><br><span class="line">    guid = <span class="string">`web:<span class="subst">$&#123;uuid4()&#125;</span>`</span>;</span><br><span class="line">    <span class="title function_">set</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>, guid);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;guid&quot;</span>, guid <span class="keyword">as</span> <span class="built_in">string</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="literal">undefined</span>,</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;Not supported on Web&quot;</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;oaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="string">&quot;Not supported on Web&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;aaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="string">&quot;Not supported on Web&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> include = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;include&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">res</span>: <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">    <span class="attr">consent</span>: _consent,</span><br><span class="line">    <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">  &#125; <span class="keyword">as</span> <span class="title class_">IdCodesResult</span>;</span><br><span class="line">  <span class="keyword">if</span> (!_consent) &#123;</span><br><span class="line">    res.<span class="property">guid</span> = &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;guid&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;consent=false&quot;</span> &#125;;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;guid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">guid</span> = <span class="keyword">await</span> <span class="title function_">getGuid</span>(exposeRaw);</span><br><span class="line"></span><br><span class="line">  res.<span class="property">best</span> = res.<span class="property">guid</span>?.<span class="property">available</span> ? <span class="string">&quot;guid&quot;</span> : <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> r = <span class="keyword">await</span> <span class="title function_">getIdCodes</span>(options);</span><br><span class="line">  <span class="keyword">if</span> (r.<span class="property">best</span>) &#123;</span><br><span class="line">    <span class="comment">/* @ts-ignore */</span> <span class="keyword">return</span> (r <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[r.<span class="property">best</span>] <span class="keyword">as</span> <span class="title class_">IdValue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;none&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;no id available&quot;</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-Android-实现（融合你两个插件思路，Promise-化-兜底-可拓展）"><a href="#3-Android-实现（融合你两个插件思路，Promise-化-兜底-可拓展）" class="headerlink" title="3) Android 实现（融合你两个插件思路，Promise 化 + 兜底 + 可拓展）"></a>3) Android 实现（融合你两个插件思路，Promise 化 + 兜底 + 可拓展）</h3><ul>
<li><strong>AndroidID</strong>：直接取 <code>Settings.Secure.ANDROID_ID</code>（不需要权限）。</li>
<li><strong>OAID</strong>：沿用你 <code>android-deviceid</code> 的库，包装为 Promise；初始化要在 <code>register()</code> 里做。</li>
<li><strong>AAID</strong>：先留占位，后续加 <code>play-services-ads-identifier</code>。</li>
<li><strong>PseudoID</strong>：把 <code>zws-uniqueid</code> 的思路做成可选兜底，不当主标识。</li>
<li><strong>SHA-256</strong>：建议在 Android 侧用 <code>java.security.MessageDigest</code>，比 web 占位靠谱。</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app-android/adapters/android_id.uts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAndroidIdRaw</span>(<span class="params"></span>): <span class="built_in">string</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> ctx = plus.<span class="property">android</span>.<span class="title function_">runtimeMainActivity</span>();</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">SettingsSecure</span> = plus.<span class="property">android</span>.<span class="title function_">importClass</span>(</span><br><span class="line">      <span class="string">&quot;android.provider.Settings$Secure&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> contentResolver = ctx.<span class="title function_">getContentResolver</span>();</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> id = <span class="title class_">SettingsSecure</span>.<span class="title function_">getString</span>(</span><br><span class="line">      contentResolver,</span><br><span class="line">      <span class="string">&quot;android_id&quot;</span></span><br><span class="line">    ) <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line">    <span class="keyword">return</span> id ? <span class="string">`android:<span class="subst">$&#123;id&#125;</span>`</span> : <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app-android/adapters/pseudo_id.uts（把 zws 的实现收编为兜底项）</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Build</span> <span class="keyword">from</span> <span class="string">&quot;android.os.Build&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">MessageDigest</span> <span class="keyword">from</span> <span class="string">&quot;java.security.MessageDigest&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">BigInteger</span> <span class="keyword">from</span> <span class="string">&quot;java.math.BigInteger&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getPseudoIdRaw</span>(<span class="params"></span>): <span class="built_in">string</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> text =</span><br><span class="line">      <span class="title class_">Build</span>.<span class="property">BOARD</span> +</span><br><span class="line">      <span class="title class_">Build</span>.<span class="property">BRAND</span> +</span><br><span class="line">      <span class="title class_">Build</span>.<span class="property">DEVICE</span> +</span><br><span class="line">      <span class="title class_">Build</span>.<span class="property">DISPLAY</span> +</span><br><span class="line">      <span class="title class_">Build</span>.<span class="property">FINGERPRINT</span> +</span><br><span class="line">      <span class="string">&quot;uni-id-kit&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> md5s = <span class="title class_">MessageDigest</span>.<span class="title function_">getInstance</span>(<span class="string">&quot;MD5&quot;</span>).<span class="title function_">digest</span>(</span><br><span class="line">      (text <span class="keyword">as</span> <span class="built_in">any</span>).<span class="title function_">toString</span>().<span class="title function_">toByteArray</span>()</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BigInteger</span>(<span class="number">1</span>, md5s).<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app-android/index.uts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">IdCodesResult</span>, <span class="title class_">IdValue</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../common/types.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; get, set &#125; <span class="keyword">from</span> <span class="string">&quot;../common/storage.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getAndroidIdRaw &#125; <span class="keyword">from</span> <span class="string">&quot;./adapters/android_id.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getPseudoIdRaw &#125; <span class="keyword">from</span> <span class="string">&quot;./adapters/pseudo_id.uts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==== 引入你 android-deviceid 插件用到的 OAID 库 ====</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">DeviceIdentifier</span> <span class="keyword">from</span> <span class="string">&quot;com.github.gzuliyujiang.oaid.DeviceIdentifier&quot;</span>;</span><br><span class="line"><span class="comment">// 你现有的监听器写法是 IDManger.OnIOAIDListener + JSON 回调，这里改 Promise 风格：</span></span><br><span class="line"><span class="comment">// 如果库支持 IGetter 回调也可以（取决于版本），我这里按你包内的风格保留 register 初始化。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _consent = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> _salt = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 Android 的 MessageDigest 实现 SHA-256（优于 web 占位）</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sha256HexSync</span>(<span class="params"><span class="attr">input</span>: <span class="built_in">string</span></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">MessageDigest</span> = plus.<span class="property">android</span>.<span class="title function_">importClass</span>(</span><br><span class="line">      <span class="string">&quot;java.security.MessageDigest&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> md = <span class="title class_">MessageDigest</span>.<span class="title function_">getInstance</span>(<span class="string">&quot;SHA-256&quot;</span>);</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> bytes = (input <span class="keyword">as</span> <span class="built_in">any</span>).<span class="title function_">toString</span>().<span class="title function_">getBytes</span>();</span><br><span class="line">    <span class="keyword">const</span> out = md.<span class="title function_">digest</span>(bytes);</span><br><span class="line">    <span class="keyword">let</span> hex = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; out.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> b = (out[i] <span class="keyword">as</span> <span class="built_in">number</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">      hex += (b &lt; <span class="number">16</span> ? <span class="string">&quot;0&quot;</span> : <span class="string">&quot;&quot;</span>) + b.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hex;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> input;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">uuid4</span>(<span class="params"></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&quot;</span>.<span class="title function_">replace</span>(<span class="regexp">/[xy]/g</span>, <span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> r = ((<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">16</span>) <span class="keyword">as</span> <span class="built_in">number</span>) | <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> v = c === <span class="string">&quot;x&quot;</span> ? r : (r &amp; <span class="number">0x3</span>) | <span class="number">0x8</span>;</span><br><span class="line">    <span class="keyword">return</span> v.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">buildSync</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">source</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">value</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">msg</span>?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">IdValue</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> available = !!value;</span><br><span class="line">  <span class="keyword">const</span> raw = exposeRaw ? value : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">const</span> hash = value ? <span class="title function_">sha256HexSync</span>(value + _salt) : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">value</span>: raw, hash, available, limited, source, <span class="attr">message</span>: msg &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">_</span>: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span> = <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">UTSJSONObject</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="title class_">DeviceIdentifier</span>.<span class="title function_">register</span>(<span class="title class_">UTSAndroid</span>.<span class="title function_">getUniActivity</span>()!!.<span class="title function_">getApplication</span>()!!);</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line">  _consent = <span class="literal">true</span>; <span class="comment">// 这里接你的隐私弹窗</span></span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">consent</span>: _consent &#125; <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  _salt = salt || <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> v = <span class="title function_">getAndroidIdRaw</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">buildSync</span>(<span class="string">&quot;androidId&quot;</span>, v || <span class="literal">undefined</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"><span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> guid = <span class="title function_">get</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!guid) &#123;</span><br><span class="line">    guid = <span class="string">`app:<span class="subst">$&#123;uuid4()&#125;</span>`</span>;</span><br><span class="line">    <span class="title function_">set</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>, guid);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">buildSync</span>(<span class="string">&quot;guid&quot;</span>, guid <span class="keyword">as</span> <span class="built_in">string</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OAID：基于你现有库封装为 Promise（示例：如果库是同步 API 换成同步返回即可）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 你包里是通过监听器把结果 JSON 回调出来的；</span></span><br><span class="line">    <span class="comment">// 这里建议写一个同步/异步包装（示意）：</span></span><br><span class="line">    <span class="comment">// 假设库提供 DeviceIdentifier.getOAID(ctx) 或者 DeviceID.getOAID(...)</span></span><br><span class="line">    <span class="comment">// 如果仅有回调形式，就 new Promise 包一下。</span></span><br><span class="line">    <span class="comment">// 先占位为“未集成”，避免误用：</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">buildSync</span>(</span><br><span class="line">      <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">      <span class="literal">undefined</span>,</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">      <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;OAID not integrated to Promise wrapper&quot;</span></span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">buildSync</span>(<span class="string">&quot;oaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">false</span>, (e <span class="keyword">as</span> <span class="built_in">any</span>).<span class="title function_">toString</span>());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AAID：等你接 play-services-ads-identifier，这里先占位</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">buildSync</span>(<span class="string">&quot;aaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="string">&quot;AAID not integrated&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> include = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;include&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;pseudoId&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">res</span>: <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">    <span class="attr">consent</span>: _consent,</span><br><span class="line">    <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">  &#125; <span class="keyword">as</span> <span class="title class_">IdCodesResult</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!_consent) &#123;</span><br><span class="line">    res.<span class="property">guid</span> = &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;guid&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;consent=false&quot;</span> &#125;;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;oaid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">oaid</span> = <span class="keyword">await</span> <span class="title function_">getOAID</span>();</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;androidId&quot;</span>) &gt;= <span class="number">0</span>)</span><br><span class="line">    res.<span class="property">androidId</span> = <span class="keyword">await</span> <span class="title function_">getAndroidId</span>(exposeRaw);</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;guid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">guid</span> = <span class="keyword">await</span> <span class="title function_">getGuid</span>(exposeRaw);</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;pseudoId&quot;</span>) &gt;= <span class="number">0</span>)</span><br><span class="line">    res.<span class="property">pseudoId</span> = <span class="title function_">buildSync</span>(</span><br><span class="line">      <span class="string">&quot;pseudoId&quot;</span>,</span><br><span class="line">      <span class="title function_">getPseudoIdRaw</span>() || <span class="literal">undefined</span>,</span><br><span class="line">      exposeRaw</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 国内默认优先级：oaid &gt; androidId &gt; guid &gt; pseudoId</span></span><br><span class="line">  <span class="keyword">const</span> order = [<span class="string">&quot;oaid&quot;</span>, <span class="string">&quot;androidId&quot;</span>, <span class="string">&quot;guid&quot;</span>, <span class="string">&quot;pseudoId&quot;</span>];</span><br><span class="line">  res.<span class="property">best</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; order.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> k = order[i];</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">v</span>: <span class="title class_">IdValue</span> | <span class="literal">null</span> = (res <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[k] <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line">    <span class="keyword">if</span> (v &amp;&amp; v.<span class="property">available</span>) &#123;</span><br><span class="line">      res.<span class="property">best</span> = k;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> prefer = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;prefer&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;pseudoId&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="keyword">const</span> r = <span class="keyword">await</span> <span class="title function_">getIdCodes</span>(&#123; <span class="attr">include</span>: prefer <span class="keyword">as</span> <span class="built_in">any</span>, exposeRaw &#125; <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">if</span> (r.<span class="property">best</span>) &#123;</span><br><span class="line">    <span class="comment">/* @ts-ignore */</span> <span class="keyword">return</span> (r <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[r.<span class="property">best</span>] <span class="keyword">as</span> <span class="title class_">IdValue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;none&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;no id available&quot;</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-平台聚合导出（utssdk-index-uts）"><a href="#4-平台聚合导出（utssdk-index-uts）" class="headerlink" title="4) 平台聚合导出（utssdk/index.uts）"></a>4) 平台聚合导出（<code>utssdk/index.uts</code>）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// #ifdef APP-ANDROID</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  register,</span><br><span class="line">  setSalt,</span><br><span class="line">  getIdCodes,</span><br><span class="line">  getBestId,</span><br><span class="line">  getOAID,</span><br><span class="line">  getAAID,</span><br><span class="line">  getAndroidId,</span><br><span class="line">  getGuid,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./app-android/index.uts&quot;</span>;</span><br><span class="line"><span class="comment">// #endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #ifdef H5</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  register,</span><br><span class="line">  setSalt,</span><br><span class="line">  getIdCodes,</span><br><span class="line">  getBestId,</span><br><span class="line">  getOAID,</span><br><span class="line">  getAAID,</span><br><span class="line">  getAndroidId,</span><br><span class="line">  getGuid,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./web/index.uts&quot;</span>;</span><br><span class="line"><span class="comment">// #endif</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="要不要“调整现在的代码”？"><a href="#要不要“调整现在的代码”？" class="headerlink" title="要不要“调整现在的代码”？"></a>要不要“调整现在的代码”？</h2><p><strong>要的</strong>，但改动并不大，主要集中在 4 点：</p>
<ol>
<li><strong>Promise 化</strong>：把回调&#x2F;监听器的导出改为 Promise，页面里可以 <code>await</code>。</li>
<li><strong>统一返回结构</strong>：所有方法都返回 <code>IdValue/IdCodesResult</code>，好串联与埋点。</li>
<li><strong>合规默认 &amp; hash-only</strong>：提供 <code>register()</code> 和 <code>setSalt()</code>，未同意前不采集；默认只回 <code>hash</code>。</li>
<li><strong>兜底与优先级</strong>：在拿不到 OAID 时，<strong>自动回退</strong>到 <code>AndroidID</code>、<code>GUID</code>、<code>pseudoId</code>，并清晰标出 <code>limited</code>&#x2F;<code>message</code>。</li>
</ol>
<blockquote>
<p>你的 <code>android-deviceid</code> 插件可以直接把库继续用；我在上面的安卓实现里已经把“桥接位”留好了。<br><code>zws-uniqueid</code> 的算法我收编到 <code>pseudoId</code>，作为兜底，不再当主标识使用。</p>
</blockquote>
<hr>
<h2 id="下一步"><a href="#下一步" class="headerlink" title="下一步"></a>下一步</h2><ul>
<li>你确认用 <strong><code>uni-id-kit</code></strong> 的方案我就把 <strong>OAID Promise 包装</strong>（基于你现有 <code>DeviceIdentifier</code> 监听回调）也给你写上，并且给出 <strong>AAID 接入</strong>（<code>play-services-ads-identifier</code>）的 <code>gradle</code> 依赖与 UTS 调用示例。</li>
<li>如果需要，我也可以给 <strong>iOS（IDFV）</strong> 的 UTS 版本，一起并到这个套件里。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/07/id-kit%E5%BC%80%E5%8F%91/" data-id="cmf9bdhki000fqq4z0qazaxeo" data-title="id-kit开发" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-id-kit" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/07/id-kit/" class="article-date">
  <time class="dt-published" datetime="2025-09-07T12:35:03.000Z" itemprop="datePublished">2025-09-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/07/id-kit/">id-kit</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>棒～这个方向很实用。按你的节奏来：<strong>先取名 → 再讲实现思路 → 之后我们再一步步落地</strong>。</p>
<hr>
<h2 id="先取个名字（我给你几个风格不同的备选）"><a href="#先取个名字（我给你几个风格不同的备选）" class="headerlink" title="先取个名字（我给你几个风格不同的备选）"></a>先取个名字（我给你几个风格不同的备选）</h2><p><strong>强推：<code>UniIdKit</code>（中文：一体设备 ID 工具包）</strong></p>
<ul>
<li>简洁、易记、和 uni-app 生态贴合（Uni 前缀）。</li>
<li>“Kit” 体现工具集合的定位（OAID&#x2F;AAID&#x2F;AndroidID&#x2F;GUID…聚合）。</li>
</ul>
<p>其它好选项（任选其一也行）：</p>
<ul>
<li><code>UniDeviceID</code>（直白、上手即懂）</li>
<li><code>IdFusion</code> &#x2F; 中文：ID 融合（强调多源融合）</li>
<li><code>OmniIdKit</code> &#x2F; 中文：全域 ID 工具包（强调覆盖广泛）</li>
<li><code>SignalID</code> &#x2F; 中文：设备信标（更“概念化”，偏品牌感）</li>
</ul>
<blockquote>
<p>没有特别诉求的话，我后续以 <strong><code>UniIdKit</code></strong> 为默认名继续讲实现与代码。</p>
</blockquote>
<hr>
<h2 id="实现思路（先把“大图”画清楚）"><a href="#实现思路（先把“大图”画清楚）" class="headerlink" title="实现思路（先把“大图”画清楚）"></a>实现思路（先把“大图”画清楚）</h2><h3 id="1-目标与边界"><a href="#1-目标与边界" class="headerlink" title="1) 目标与边界"></a>1) 目标与边界</h3><ul>
<li><p><strong>平台覆盖</strong>：Android（App-Plus 原生）、iOS（可选：IDFV）、H5（本地持久 GUID）。</p>
</li>
<li><p><strong>能力聚合</strong>：OAID、AAID、AndroidID、（可选）IMEI&#x2F;MEID、WidevineID、PseudoID、GUID。</p>
</li>
<li><p><strong>合规优先</strong>：</p>
<ul>
<li>默认<strong>不采集强隐私</strong>（如 IMEI），需<strong>显式同意</strong>与<strong>动态权限</strong>才允许。</li>
<li>提供<strong>哈希化输出</strong>（SHA-256）选项，避免直传原始标识。</li>
<li>尊重系统&#x2F;用户“广告追踪限制”（AAID&#x2F;OAID 可能返回空或受限标志）。</li>
</ul>
</li>
</ul>
<h3 id="2-能力分层（便于维护与扩展）"><a href="#2-能力分层（便于维护与扩展）" class="headerlink" title="2) 能力分层（便于维护与扩展）"></a>2) 能力分层（便于维护与扩展）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">UniIdKit（JS/TS 封装与 API ）</span><br><span class="line"> ├─ ConsentManager（隐私同意、选项管理、状态缓存）</span><br><span class="line"> ├─ CacheLayer（本地缓存：uni.storage / iOS Keychain / Android MMKV）</span><br><span class="line"> ├─ Aggregator（聚合各 Adapter 的结果、去重、优先级策略、哈希化）</span><br><span class="line"> └─ Adapters</span><br><span class="line">     ├─ Android:</span><br><span class="line">     │   ├─ OAIDAdapter（MSA SDK）</span><br><span class="line">     │   ├─ AAIDAdapter（Google Play 服务）</span><br><span class="line">     │   ├─ AndroidIdAdapter（SSAID）</span><br><span class="line">     │   ├─ WidevineIdAdapter（DRM ID，有些机型/ROM可能不可用）</span><br><span class="line">     │   ├─ PseudoIdAdapter（Build 信息拼接的伪 ID，稳定性一般）</span><br><span class="line">     │   └─ IMEI/MEIDAdapter（需权限；默认关闭）</span><br><span class="line">     ├─ iOS:</span><br><span class="line">     │   └─ IDFVAdapter（IdentifierForVendor）</span><br><span class="line">     └─ H5:</span><br><span class="line">         └─ GuidAdapter（首访生成 UUID，localStorage/IndexedDB/Cookie 持久化）</span><br></pre></td></tr></table></figure>

<h3 id="3-API-设计（兼容回调，也提供-Promise-风格）"><a href="#3-API-设计（兼容回调，也提供-Promise-风格）" class="headerlink" title="3) API 设计（兼容回调，也提供 Promise 风格）"></a>3) API 设计（兼容回调，也提供 Promise 风格）</h3><p>与 Ba-IdCode 的 API 兼容，但<strong>统一返回结构</strong>、并补充 Promise 版本：</p>
<ul>
<li><code>register(options?)</code>：完成 SDK 初始化&#x2F;权限请求&#x2F;合规弹窗接入（<strong>只有用户同意后才能继续</strong>）。</li>
<li><code>getIdCodes(options?)</code>：一次性返回所有可用标识（含哈希&#x2F;明文二选一），并标出可用性&#x2F;限制信息。</li>
<li><code>getOAID()</code> &#x2F; <code>getAAID()</code> &#x2F; <code>getAndroidId()</code> &#x2F; <code>getGuid()</code>：单项拉取。</li>
<li><code>getBestId(options?)</code>：按优先级策略返回“一个最合适的设备标识”（例如：<code>OAID &gt; AAID &gt; AndroidID &gt; IDFV &gt; GUID</code>）。</li>
<li><code>setSalt(salt: string)</code>：设置服务端协商的哈希盐（建议）；前端仅输出 hash 以降低风险。</li>
</ul>
<p><strong>统一返回结构（示例）</strong>：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">IdValue</span> = &#123;</span><br><span class="line">  <span class="attr">value</span>?: <span class="built_in">string</span>; <span class="comment">// 原始值（默认可关闭）</span></span><br><span class="line">  <span class="attr">hash</span>?: <span class="built_in">string</span>; <span class="comment">// SHA-256(value + salt) 的十六进制</span></span><br><span class="line">  <span class="attr">available</span>: <span class="built_in">boolean</span>; <span class="comment">// 是否成功获取</span></span><br><span class="line">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>; <span class="comment">// 是否受限制（如关闭广告标识、受 ROM 策略限制）</span></span><br><span class="line">  <span class="attr">source</span>?: <span class="built_in">string</span>; <span class="comment">// 具体来源：oaid/aaid/androidId/idfv/guid/...</span></span><br><span class="line">  <span class="attr">message</span>?: <span class="built_in">string</span>; <span class="comment">// 失败/限制说明</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">  <span class="attr">oaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">aaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">androidId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">idfv</span>?: <span class="title class_">IdValue</span>; <span class="comment">// iOS</span></span><br><span class="line">  <span class="attr">widevineId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">pseudoId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">imei</span>?: <span class="title class_">IdValue</span>; <span class="comment">// 默认不返回，需开启 &amp; 权限通过</span></span><br><span class="line">  <span class="attr">guid</span>?: <span class="title class_">IdValue</span>; <span class="comment">// H5/兜底</span></span><br><span class="line">  <span class="attr">ts</span>: <span class="built_in">number</span>; <span class="comment">// 时间戳</span></span><br><span class="line">  <span class="attr">consent</span>: <span class="built_in">boolean</span>; <span class="comment">// 是否已取得用户隐私同意</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>调用风格</strong>：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回调</span></span><br><span class="line">idKit.<span class="title function_">getIdCodes</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">/* ... */</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Promise（推荐）</span></span><br><span class="line"><span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">UniIdKit</span>.<span class="title function_">getIdCodes</span>(&#123;</span><br><span class="line">  <span class="attr">hashOnly</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">include</span>: [<span class="string">&quot;oaid&quot;</span>, <span class="string">&quot;aaid&quot;</span>, <span class="string">&quot;androidId&quot;</span>, <span class="string">&quot;guid&quot;</span>],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="4-平台实现要点"><a href="#4-平台实现要点" class="headerlink" title="4) 平台实现要点"></a>4) 平台实现要点</h3><ul>
<li><p><strong>Android</strong>：</p>
<ul>
<li>OAID：集成 <strong>MSA (移动安全联盟) SDK</strong> 或厂商合规通道（插件市场常用做法）。</li>
<li>AAID：Google Play 服务 <code>AdvertisingIdClient</code>（需处理“限制广告跟踪”返回）。</li>
<li>AndroidID：<code>Settings.Secure.ANDROID_ID</code>。</li>
<li>IMEI&#x2F;MEID：<code>READ_PHONE_STATE</code> 动态权限 + Play 政策；<strong>默认关闭</strong>、强提醒不建议依赖。</li>
<li>缓存：优先使用 MMKV&#x2F;SharedPreferences，配合有效期（如 24 小时）避免频繁拉取。</li>
</ul>
</li>
<li><p><strong>iOS</strong>：</p>
<ul>
<li>IDFV：<code>UIDevice.current.identifierForVendor</code>；卸载所有同一 Vendor 应用后可能变。</li>
<li>不建议用 IDFA（需要 ATT 授权且涉广告用途，与你目标不匹配）。</li>
</ul>
</li>
<li><p><strong>H5</strong>：</p>
<ul>
<li>生成 <code>uuid</code>，持久化在 <code>localStorage</code> + <code>cookie</code> 双存；被清理会变，属于“弱设备 ID”。</li>
<li>返回 <code>guid</code> 字段；可选加“服务端长 Cookie dvc&#x3D;xxx”作为辅助。</li>
</ul>
</li>
</ul>
<h3 id="5-合规与配置"><a href="#5-合规与配置" class="headerlink" title="5) 合规与配置"></a>5) 合规与配置</h3><ul>
<li>插件默认只返回 <strong>hash</strong>；要返回原值需显式 <code>exposeRaw: true</code>。</li>
<li>提供 <code>register()</code> 用于展示你的隐私弹窗（或与现有弹窗 SDK 对接），<strong>未同意</strong>则所有采集接口返回 <code>available=false</code>。</li>
<li>允许配置 <code>include/exclude</code> 字段（避免不必要的请求&#x2F;权限）。</li>
<li>提供 <code>fallback: &#39;guid&#39; | &#39;none&#39;</code> 选项控制 H5 的兜底行为。</li>
</ul>
<hr>
<h2 id="3-先给你一份可直接用的-JS-封装（跨端-可渐进增强）"><a href="#3-先给你一份可直接用的-JS-封装（跨端-可渐进增强）" class="headerlink" title="3) 先给你一份可直接用的 JS 封装（跨端 &amp; 可渐进增强）"></a>3) 先给你一份可直接用的 JS 封装（跨端 &amp; 可渐进增强）</h2><blockquote>
<p>先从 JS 层开始（不依赖原生插件也可工作），App 端等你绑定好原生插件后，再把 <code>native</code> 分支接上即可。</p>
</blockquote>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/utils/uni-id-kit.ts  —— 先做纯JS壳子，后续接原生</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">uuid4</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&quot;</span>.<span class="title function_">replace</span>(<span class="regexp">/[xy]/g</span>, <span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> r = (<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">16</span>) | <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> v = c === <span class="string">&quot;x&quot;</span> ? r : (r &amp; <span class="number">0x3</span>) | <span class="number">0x8</span>;</span><br><span class="line">    <span class="keyword">return</span> v.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sha256Hex</span>(<span class="params"><span class="attr">msg</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">window</span> !== <span class="string">&quot;undefined&quot;</span> &amp;&amp; <span class="variable language_">window</span>.<span class="property">crypto</span>?.<span class="property">subtle</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> enc = <span class="keyword">new</span> <span class="title class_">TextEncoder</span>().<span class="title function_">encode</span>(msg);</span><br><span class="line">    <span class="keyword">const</span> buf = <span class="keyword">await</span> <span class="variable language_">window</span>.<span class="property">crypto</span>.<span class="property">subtle</span>.<span class="title function_">digest</span>(<span class="string">&quot;SHA-256&quot;</span>, enc);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(buf))</span><br><span class="line">      .<span class="title function_">map</span>(<span class="function">(<span class="params">b</span>) =&gt;</span> b.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">2</span>, <span class="string">&quot;0&quot;</span>))</span><br><span class="line">      .<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 非 H5（App 小程序）用简易实现或交给原生</span></span><br><span class="line">  <span class="comment">// 这里先用最简单的占位：直接返回 msg（上线前请接真 SHA-256，如 plus.crypto / 原生）</span></span><br><span class="line">  <span class="keyword">return</span> msg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">GetIdOptions</span> = &#123;</span><br><span class="line">  <span class="attr">include</span>?: <span class="title class_">Array</span>&lt;</span><br><span class="line">    | <span class="string">&quot;oaid&quot;</span></span><br><span class="line">    | <span class="string">&quot;aaid&quot;</span></span><br><span class="line">    | <span class="string">&quot;androidId&quot;</span></span><br><span class="line">    | <span class="string">&quot;idfv&quot;</span></span><br><span class="line">    | <span class="string">&quot;widevineId&quot;</span></span><br><span class="line">    | <span class="string">&quot;pseudoId&quot;</span></span><br><span class="line">    | <span class="string">&quot;imei&quot;</span></span><br><span class="line">    | <span class="string">&quot;guid&quot;</span></span><br><span class="line">  &gt;;</span><br><span class="line">  <span class="attr">exposeRaw</span>?: <span class="built_in">boolean</span>; <span class="comment">// 默认 false，默认仅返回 hash</span></span><br><span class="line">  <span class="attr">salt</span>?: <span class="built_in">string</span>; <span class="comment">// 建议传服务端下发的盐</span></span><br><span class="line">  <span class="attr">fallback</span>?: <span class="string">&quot;guid&quot;</span> | <span class="string">&quot;none&quot;</span>;</span><br><span class="line">  <span class="attr">ttlMs</span>?: <span class="built_in">number</span>; <span class="comment">// 缓存有效期，默认 1 天</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _consent = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> _salt = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">_cache</span>: &#123; <span class="attr">ts</span>: <span class="built_in">number</span>; <span class="attr">data</span>: <span class="built_in">any</span> &#125; | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">UniIdKit</span> = &#123;</span><br><span class="line">  <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    _salt = salt || <span class="string">&quot;&quot;</span>;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">register</span>(): <span class="title class_">Promise</span>&lt;&#123; <span class="attr">consent</span>: <span class="built_in">boolean</span> &#125;&gt; &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 这里接你的隐私弹窗或第三方隐私 SDK</span></span><br><span class="line">    _consent = <span class="literal">true</span>; <span class="comment">// 演示先直接同意</span></span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">consent</span>: _consent &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">getIdCodes</span>(<span class="params"><span class="attr">opts</span>: <span class="title class_">GetIdOptions</span> = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> include = opts.<span class="property">include</span> || [</span><br><span class="line">      <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">      <span class="string">&quot;aaid&quot;</span>,</span><br><span class="line">      <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">      <span class="string">&quot;idfv&quot;</span>,</span><br><span class="line">      <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">    ]; <span class="comment">// 先常用</span></span><br><span class="line">    <span class="keyword">const</span> ttl = opts.<span class="property">ttlMs</span> ?? <span class="number">24</span> * <span class="number">3600</span> * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 简单缓存</span></span><br><span class="line">    <span class="keyword">if</span> (_cache &amp;&amp; <span class="title class_">Date</span>.<span class="title function_">now</span>() - _cache.<span class="property">ts</span> &lt; ttl) &#123;</span><br><span class="line">      <span class="keyword">return</span> _cache.<span class="property">data</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">data</span>: <span class="built_in">any</span> = &#123; <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(), <span class="attr">consent</span>: _consent &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// App 原生插件（占位），后续把 requireNativePlugin 接上</span></span><br><span class="line">    <span class="keyword">let</span> <span class="attr">native</span>: <span class="built_in">any</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// @ts-ignore</span></span><br><span class="line">      native = uni.<span class="property">requireNativePlugin</span> &amp;&amp; uni.<span class="title function_">requireNativePlugin</span>(<span class="string">&quot;Uni-IdKit&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 工具：组装返回（含 hash）</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">build</span> = <span class="keyword">async</span> (<span class="params"></span></span><br><span class="line"><span class="params">      <span class="attr">source</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">      <span class="attr">value</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">      <span class="attr">limited</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">      <span class="attr">msg</span>?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params">    </span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> available = !!value;</span><br><span class="line">      <span class="keyword">const</span> raw = opts.<span class="property">exposeRaw</span> ? value : <span class="literal">undefined</span>;</span><br><span class="line">      <span class="keyword">const</span> hash = value ? <span class="keyword">await</span> <span class="title function_">sha256Hex</span>(value + (_salt || <span class="string">&quot;&quot;</span>)) : <span class="literal">undefined</span>;</span><br><span class="line">      <span class="keyword">return</span> &#123; <span class="attr">value</span>: raw, hash, available, limited, source, <span class="attr">message</span>: msg &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Android / iOS / H5 分支（先写 H5 + 纯 JS 兜底，原生等你接上）</span></span><br><span class="line">    <span class="keyword">const</span> isH5 =</span><br><span class="line">      <span class="keyword">typeof</span> <span class="variable language_">window</span> !== <span class="string">&quot;undefined&quot;</span> &amp;&amp; <span class="keyword">typeof</span> <span class="variable language_">document</span> !== <span class="string">&quot;undefined&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// OAID / AAID / AndroidID / IDFV —— 占位：若未接原生，返回不可用</span></span><br><span class="line">    <span class="keyword">if</span> (include.<span class="title function_">includes</span>(<span class="string">&quot;oaid&quot;</span>))</span><br><span class="line">      data.<span class="property">oaid</span> = <span class="keyword">await</span> <span class="title function_">build</span>(</span><br><span class="line">        <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">        native?.<span class="property">getOAID</span> ? <span class="keyword">await</span> native.<span class="title function_">getOAID</span>() : <span class="literal">undefined</span></span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">if</span> (include.<span class="title function_">includes</span>(<span class="string">&quot;aaid&quot;</span>))</span><br><span class="line">      data.<span class="property">aaid</span> = <span class="keyword">await</span> <span class="title function_">build</span>(</span><br><span class="line">        <span class="string">&quot;aaid&quot;</span>,</span><br><span class="line">        native?.<span class="property">getAAID</span> ? <span class="keyword">await</span> native.<span class="title function_">getAAID</span>() : <span class="literal">undefined</span></span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">if</span> (include.<span class="title function_">includes</span>(<span class="string">&quot;androidId&quot;</span>))</span><br><span class="line">      data.<span class="property">androidId</span> = <span class="keyword">await</span> <span class="title function_">build</span>(</span><br><span class="line">        <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">        native?.<span class="property">getAndroidID</span> ? <span class="keyword">await</span> native.<span class="title function_">getAndroidID</span>() : <span class="literal">undefined</span></span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">if</span> (include.<span class="title function_">includes</span>(<span class="string">&quot;idfv&quot;</span>))</span><br><span class="line">      data.<span class="property">idfv</span> = <span class="keyword">await</span> <span class="title function_">build</span>(</span><br><span class="line">        <span class="string">&quot;idfv&quot;</span>,</span><br><span class="line">        native?.<span class="property">getIDFV</span> ? <span class="keyword">await</span> native.<span class="title function_">getIDFV</span>() : <span class="literal">undefined</span></span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">if</span> (include.<span class="title function_">includes</span>(<span class="string">&quot;widevineId&quot;</span>))</span><br><span class="line">      data.<span class="property">widevineId</span> = <span class="keyword">await</span> <span class="title function_">build</span>(</span><br><span class="line">        <span class="string">&quot;widevineId&quot;</span>,</span><br><span class="line">        native?.<span class="property">getWidevineID</span> ? <span class="keyword">await</span> native.<span class="title function_">getWidevineID</span>() : <span class="literal">undefined</span></span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">if</span> (include.<span class="title function_">includes</span>(<span class="string">&quot;pseudoId&quot;</span>))</span><br><span class="line">      data.<span class="property">pseudoId</span> = <span class="keyword">await</span> <span class="title function_">build</span>(</span><br><span class="line">        <span class="string">&quot;pseudoId&quot;</span>,</span><br><span class="line">        native?.<span class="property">getPseudoID</span> ? <span class="keyword">await</span> native.<span class="title function_">getPseudoID</span>() : <span class="literal">undefined</span></span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">if</span> (include.<span class="title function_">includes</span>(<span class="string">&quot;imei&quot;</span>))</span><br><span class="line">      data.<span class="property">imei</span> = <span class="keyword">await</span> <span class="title function_">build</span>(</span><br><span class="line">        <span class="string">&quot;imei&quot;</span>,</span><br><span class="line">        native?.<span class="property">getIMEI</span> ? <span class="keyword">await</span> native.<span class="title function_">getIMEI</span>() : <span class="literal">undefined</span></span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// H5 / 兜底 GUID</span></span><br><span class="line">    <span class="keyword">if</span> (include.<span class="title function_">includes</span>(<span class="string">&quot;guid&quot;</span>)) &#123;</span><br><span class="line">      <span class="keyword">let</span> guid = uni.<span class="title function_">getStorageSync</span>(<span class="string">&quot;UNI_ID_KIT_GUID&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (!guid) &#123;</span><br><span class="line">        guid = <span class="string">`web:<span class="subst">$&#123;uuid4()&#125;</span>`</span>;</span><br><span class="line">        uni.<span class="title function_">setStorageSync</span>(<span class="string">&quot;UNI_ID_KIT_GUID&quot;</span>, guid);</span><br><span class="line">      &#125;</span><br><span class="line">      data.<span class="property">guid</span> = <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;guid&quot;</span>, guid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果要求有“最佳 ID”</span></span><br><span class="line">    data.<span class="property">best</span> = (<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> order = [<span class="string">&quot;oaid&quot;</span>, <span class="string">&quot;aaid&quot;</span>, <span class="string">&quot;androidId&quot;</span>, <span class="string">&quot;idfv&quot;</span>, <span class="string">&quot;guid&quot;</span>];</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> k <span class="keyword">of</span> order) &#123;</span><br><span class="line">        <span class="keyword">if</span> (data[k]?.<span class="property">available</span>) <span class="keyword">return</span> k;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;)();</span><br><span class="line"></span><br><span class="line">    _cache = &#123; <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(), data &#125;;</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">getBestId</span>(<span class="params"><span class="attr">opts</span>: <span class="title class_">GetIdOptions</span> = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">getIdCodes</span>(opts);</span><br><span class="line">    <span class="keyword">const</span> key = res.<span class="property">best</span>;</span><br><span class="line">    <span class="keyword">return</span> key ? res[key] : &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;none&quot;</span> &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这份 JS 壳子<strong>现在就能在 H5 返回一个稳定的 GUID</strong>；等你把 Android&#x2F;iOS 原生侧接上 <code>Uni-IdKit</code> 插件，就能自动获得 OAID&#x2F;AAID&#x2F;AndroidID&#x2F;IDFV 等真实值，API 不变。</p>
</blockquote>
<hr>
<h2 id="下一步怎么干？"><a href="#下一步怎么干？" class="headerlink" title="下一步怎么干？"></a>下一步怎么干？</h2><ol>
<li><p><strong>确定名字</strong>（默认我用 <code>UniIdKit</code> 继续）。</p>
</li>
<li><p>我给你 <strong>Android 原生插件最小实现骨架（Kotlin）</strong>：</p>
<ul>
<li>暴露 <code>getOAID/getAAID/getAndroidID/...</code> 方法；</li>
<li>可先不接 MSA&#x2F;AAID，返回占位，跑通桥接；</li>
<li>再逐个接入 MSA SDK、Google Play Advertising ID。</li>
</ul>
</li>
<li><p>同步给 <strong>iOS 原生插件（Swift）</strong> 获取 IDFV；</p>
</li>
<li><p>最后在你的登录流程里，把 <code>const dvc = await UniIdKit.getBestId(&#123; hashOnly: true &#125;)</code> 接上，作为 <code>x-device-id</code> 传后端。</p>
</li>
</ol>
<p>要不要我直接开始贴 <strong>Android 插件骨架（可云打包）</strong>？你点个头我就开写。</p>
<p>太好了，我们就按 <strong>UTS 插件</strong>来落地。下面我先给出<strong>项目结构 &amp; API 设计（最佳实践版）</strong>，然后直接给你<strong>可运行的首版代码骨架</strong>（先支持 Web；Android 提供可运行的基础实现 + OAID&#x2F;AAID 预留点），后续你把 MSA&#x2F;GP 的 SDK 接上即可。</p>
<hr>
<h1 id="一、插件命名-目录结构"><a href="#一、插件命名-目录结构" class="headerlink" title="一、插件命名 &amp; 目录结构"></a>一、插件命名 &amp; 目录结构</h1><p><strong>插件名</strong>：<code>uni-id-kit</code>（简洁、易记、符合 uni 插件生态）</p>
<ul>
<li>英文：<strong>UniIdKit</strong></li>
<li>中文：<strong>一体设备 ID 工具包</strong></li>
</ul>
<p><strong>目录（uni_modules 标准）</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">uni_modules/</span><br><span class="line">  uni-id-kit/</span><br><span class="line">    package.json</span><br><span class="line">    module.json</span><br><span class="line">    utssdk/</span><br><span class="line">      index.uts              # 聚合导出（按平台分发）</span><br><span class="line">      common/</span><br><span class="line">        types.uts            # 类型与常量定义（复用）</span><br><span class="line">        hash.uts             # SHA-256 工具（Web/Android 均可）</span><br><span class="line">        storage.uts          # 本地缓存工具（uni.storage封装）</span><br><span class="line">      web/</span><br><span class="line">        index.uts            # Web 实现（GUID、hash、缓存）</span><br><span class="line">      app-android/</span><br><span class="line">        index.uts            # Android 实现（AndroidID，OAID/AAID占位）</span><br><span class="line">        adapters/</span><br><span class="line">          android_id.uts     # ANDROID_ID</span><br><span class="line">          aaid.uts           # Google AAID（待接SDK）</span><br><span class="line">          oaid.uts           # MSA OAID  （待接SDK）</span><br><span class="line">          pseudo_id.uts      # 伪ID（可选）</span><br></pre></td></tr></table></figure>

<blockquote>
<p>iOS（IDFV）可稍后补：<code>app-ios/index.uts</code> + <code>adapters/idfv.uts</code>。<br>你让我们“先国内”，就先 <strong>Web→Android</strong>；Android 国内核心是 <strong>AndroidID&#x2F;OAID</strong>，海外补 <strong>AAID</strong>。</p>
</blockquote>
<hr>
<h1 id="二、API-设计（Promise-回调兼容）"><a href="#二、API-设计（Promise-回调兼容）" class="headerlink" title="二、API 设计（Promise + 回调兼容）"></a>二、API 设计（Promise + 回调兼容）</h1><blockquote>
<p>统一 Promise 风格，另兼容回调（可选）；返回结构“可读 + 可扩展”。</p>
</blockquote>
<h2 id="公开方法"><a href="#公开方法" class="headerlink" title="公开方法"></a>公开方法</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1) 隐私合规：注册/初始化（未同意时一律返回 available=false）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"><span class="attr">options</span>?: &#123;</span></span><br><span class="line"><span class="params">  showPrivacyDialog?: <span class="built_in">boolean</span>; // 需要时展示你自有的隐私弹窗</span></span><br><span class="line"><span class="params">&#125;</span>): <span class="title class_">Promise</span>&lt;&#123; <span class="attr">consent</span>: <span class="built_in">boolean</span> &#125;&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2) 配置哈希盐（建议服务端下发）；默认仅返回 hash</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3) 一次性获取所有可用的 ID（聚合）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"><span class="attr">options</span>?: &#123;</span></span><br><span class="line"><span class="params">  include?: <span class="built_in">Array</span>&lt;</span></span><br><span class="line"><span class="params">    | <span class="string">&quot;oaid&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;aaid&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;androidId&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;idfv&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;widevineId&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;pseudoId&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;imei&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;guid&quot;</span></span></span><br><span class="line"><span class="params">  &gt;;</span></span><br><span class="line"><span class="params">  exposeRaw?: <span class="built_in">boolean</span>; // 默认 <span class="literal">false</span>（仅返回hash），开启后返回原值 value</span></span><br><span class="line"><span class="params">  ttlMs?: <span class="built_in">number</span>; // 缓存有效期，默认 24h</span></span><br><span class="line"><span class="params">&#125;</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4) 返回“最合适”的一个（按优先级：国内默认 oaid &gt; androidId &gt; guid）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"><span class="attr">options</span>?: &#123;</span></span><br><span class="line"><span class="params">  prefer?: <span class="built_in">Array</span>&lt;<span class="string">&quot;oaid&quot;</span> | <span class="string">&quot;aaid&quot;</span> | <span class="string">&quot;androidId&quot;</span> | <span class="string">&quot;idfv&quot;</span> | <span class="string">&quot;guid&quot;</span>&gt;; // 可自定义优先级</span></span><br><span class="line"><span class="params">  exposeRaw?: <span class="built_in">boolean</span>;</span></span><br><span class="line"><span class="params">  ttlMs?: <span class="built_in">number</span>;</span></span><br><span class="line"><span class="params">&#125;</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5) 单项拉取（必要时）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br></pre></td></tr></table></figure>

<h2 id="返回类型（最佳实践）"><a href="#返回类型（最佳实践）" class="headerlink" title="返回类型（最佳实践）"></a>返回类型（最佳实践）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utssdk/common/types.uts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdValue</span> = &#123;</span><br><span class="line">  <span class="attr">value</span>?: <span class="built_in">string</span>; <span class="comment">// 原始值（exposeRaw=true 才返回）</span></span><br><span class="line">  <span class="attr">hash</span>?: <span class="built_in">string</span>; <span class="comment">// SHA-256(value + salt) 十六进制</span></span><br><span class="line">  <span class="attr">available</span>: <span class="built_in">boolean</span>; <span class="comment">// 是否获取成功</span></span><br><span class="line">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>; <span class="comment">// 是否受限（系统关闭广告跟踪等）</span></span><br><span class="line">  <span class="attr">source</span>: <span class="built_in">string</span>; <span class="comment">// oaid/aaid/androidId/idfv/guid/...</span></span><br><span class="line">  <span class="attr">message</span>?: <span class="built_in">string</span>; <span class="comment">// 失败或说明</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">  <span class="attr">oaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">aaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">androidId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">idfv</span>?: <span class="title class_">IdValue</span>; <span class="comment">// 预留给 iOS</span></span><br><span class="line">  <span class="attr">widevineId</span>?: <span class="title class_">IdValue</span>; <span class="comment">// 可选</span></span><br><span class="line">  <span class="attr">pseudoId</span>?: <span class="title class_">IdValue</span>; <span class="comment">// 可选</span></span><br><span class="line">  <span class="attr">imei</span>?: <span class="title class_">IdValue</span>; <span class="comment">// 不建议默认启用</span></span><br><span class="line">  <span class="attr">guid</span>?: <span class="title class_">IdValue</span>; <span class="comment">// H5/兜底</span></span><br><span class="line">  <span class="attr">best</span>?: <span class="built_in">string</span> | <span class="literal">null</span>; <span class="comment">// 最佳项的 key</span></span><br><span class="line">  <span class="attr">consent</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">ts</span>: <span class="built_in">number</span>; <span class="comment">// 生成时间戳</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="三、首版代码（可直接放进项目）"><a href="#三、首版代码（可直接放进项目）" class="headerlink" title="三、首版代码（可直接放进项目）"></a>三、首版代码（可直接放进项目）</h1><blockquote>
<p><strong>说明</strong>：以下代码为 <strong>可运行骨架</strong>。</p>
<ul>
<li>Web：已可直接返回 <code>guid</code>（localStorage&#x2F;uni.storage 持久化），并做 SHA-256。</li>
<li>Android：已可返回 <strong>AndroidID</strong>（无需额外权限），OAID&#x2F;AAID 先返回占位（后续你把 SDK 接上）。</li>
<li>聚合导出：<code>utssdk/index.uts</code> 会按平台引导到对应实现。</li>
</ul>
</blockquote>
<h2 id="1）uni-modules-uni-id-kit-module-json"><a href="#1）uni-modules-uni-id-kit-module-json" class="headerlink" title="1）uni_modules/uni-id-kit/module.json"></a>1）<code>uni_modules/uni-id-kit/module.json</code></h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uni-id-kit&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;displayName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UniIdKit - 一体设备ID工具包&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;聚合 OAID/AAID/AndroidID/GUID 等设备标识，合规&amp;哈希化输出&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;keywords&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;deviceid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;oaid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;aaid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;androidid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;guid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;uts&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;repository&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;engines&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;HBuilderX&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^3.8.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;uni_modules&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;platforms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;app-android&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;utssdk&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;kotlin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&gt;=1.7.0&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;web&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;utssdk&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="2）uni-modules-uni-id-kit-utssdk-common-types-uts"><a href="#2）uni-modules-uni-id-kit-utssdk-common-types-uts" class="headerlink" title="2）uni_modules/uni-id-kit/utssdk/common/types.uts"></a>2）<code>uni_modules/uni-id-kit/utssdk/common/types.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdValue</span> = &#123;</span><br><span class="line">  <span class="attr">value</span>?: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">hash</span>?: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">available</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">source</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">message</span>?: <span class="built_in">string</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">  <span class="attr">oaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">aaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">androidId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">idfv</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">widevineId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">pseudoId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">imei</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">guid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">best</span>?: <span class="built_in">string</span> | <span class="literal">null</span>;</span><br><span class="line">  <span class="attr">consent</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">ts</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="3）uni-modules-uni-id-kit-utssdk-common-hash-uts"><a href="#3）uni-modules-uni-id-kit-utssdk-common-hash-uts" class="headerlink" title="3）uni_modules/uni-id-kit/utssdk/common/hash.uts"></a>3）<code>uni_modules/uni-id-kit/utssdk/common/hash.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Web 有 crypto.subtle；Android 走 Java MessageDigest（见安卓实现）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sha256Hex</span>(<span class="params"><span class="attr">input</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// @ts-ignore</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">g</span>: <span class="built_in">any</span> = globalThis;</span><br><span class="line">  <span class="keyword">if</span> (g &amp;&amp; g.<span class="property">crypto</span> &amp;&amp; g.<span class="property">crypto</span>.<span class="property">subtle</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> enc = <span class="keyword">new</span> <span class="title class_">TextEncoder</span>().<span class="title function_">encode</span>(input);</span><br><span class="line">    <span class="keyword">const</span> buf = <span class="keyword">await</span> g.<span class="property">crypto</span>.<span class="property">subtle</span>.<span class="title function_">digest</span>(<span class="string">&quot;SHA-256&quot;</span>, enc);</span><br><span class="line">    <span class="keyword">const</span> arr = <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(buf));</span><br><span class="line">    <span class="keyword">return</span> arr.<span class="title function_">map</span>(<span class="function">(<span class="params">b</span>) =&gt;</span> b.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">2</span>, <span class="string">&quot;0&quot;</span>)).<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 无 WebCrypto 时，先退回原文（开发期），建议后续接原生或 JS 实现</span></span><br><span class="line">  <span class="keyword">return</span> input;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4）uni-modules-uni-id-kit-utssdk-common-storage-uts"><a href="#4）uni-modules-uni-id-kit-utssdk-common-storage-uts" class="headerlink" title="4）uni_modules/uni-id-kit/utssdk/common/storage.uts"></a>4）<code>uni_modules/uni-id-kit/utssdk/common/storage.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span></span>): <span class="built_in">string</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">return</span> uni.<span class="title function_">getStorageSync</span>(key) || <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">set</span>(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span>, <span class="attr">val</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    uni.<span class="title function_">setStorageSync</span>(key, val);</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5）uni-modules-uni-id-kit-utssdk-web-index-uts（Web-实现）"><a href="#5）uni-modules-uni-id-kit-utssdk-web-index-uts（Web-实现）" class="headerlink" title="5）uni_modules/uni-id-kit/utssdk/web/index.uts（Web 实现）"></a>5）<code>uni_modules/uni-id-kit/utssdk/web/index.uts</code>（Web 实现）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">IdCodesResult</span>, <span class="title class_">IdValue</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../common/types.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; sha256Hex &#125; <span class="keyword">from</span> <span class="string">&quot;../common/hash.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; get, set &#125; <span class="keyword">from</span> <span class="string">&quot;../common/storage.uts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _consent = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> _salt = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">uuid4</span>(<span class="params"></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&quot;</span>.<span class="title function_">replace</span>(<span class="regexp">/[xy]/g</span>, <span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> r = ((<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">16</span>) <span class="keyword">as</span> <span class="built_in">number</span>) | <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> v = c === <span class="string">&quot;x&quot;</span> ? r : (r &amp; <span class="number">0x3</span>) | <span class="number">0x8</span>;</span><br><span class="line">    <span class="keyword">return</span> v.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">build</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">source</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">value</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">msg</span>?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> available = !!value;</span><br><span class="line">  <span class="keyword">const</span> raw = exposeRaw ? value : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">const</span> hash = value ? <span class="keyword">await</span> <span class="title function_">sha256Hex</span>(value + _salt) : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">value</span>: raw, hash, available, limited, source, <span class="attr">message</span>: msg &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">_</span>: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span> = <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">UTSJSONObject</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// Web demo：默认视为已同意；你可以在这里弹你的隐私弹窗</span></span><br><span class="line">  _consent = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">consent</span>: _consent &#125; <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  _salt = salt || <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"><span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> guid = <span class="title function_">get</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!guid) &#123;</span><br><span class="line">    guid = <span class="string">`web:<span class="subst">$&#123;uuid4()&#125;</span>`</span>;</span><br><span class="line">    <span class="title function_">set</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>, guid);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;guid&quot;</span>, guid <span class="keyword">as</span> <span class="built_in">string</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// Web 没有 AndroidID</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="literal">undefined</span>,</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;Not supported on Web&quot;</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;oaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="string">&quot;Not supported on Web&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;aaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="string">&quot;Not supported on Web&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> include = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;include&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;aaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">res</span>: <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">    <span class="attr">consent</span>: _consent,</span><br><span class="line">    <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">  &#125; <span class="keyword">as</span> <span class="title class_">IdCodesResult</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!_consent) &#123;</span><br><span class="line">    res.<span class="property">guid</span> = &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;guid&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;consent=false&quot;</span> &#125;;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;guid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">guid</span> = <span class="keyword">await</span> <span class="title function_">getGuid</span>(exposeRaw);</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;androidId&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">androidId</span> = <span class="keyword">await</span> <span class="title function_">getAndroidId</span>();</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;oaid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">oaid</span> = <span class="keyword">await</span> <span class="title function_">getOAID</span>();</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;aaid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">aaid</span> = <span class="keyword">await</span> <span class="title function_">getAAID</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 国内默认优先级</span></span><br><span class="line">  <span class="keyword">const</span> order = [<span class="string">&quot;oaid&quot;</span>, <span class="string">&quot;androidId&quot;</span>, <span class="string">&quot;guid&quot;</span>];</span><br><span class="line">  res.<span class="property">best</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; order.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> k = order[i];</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">v</span>: <span class="title class_">IdValue</span> | <span class="literal">null</span> = (res <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[k] <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line">    <span class="keyword">if</span> (v &amp;&amp; v.<span class="property">available</span>) &#123;</span><br><span class="line">      res.<span class="property">best</span> = k;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> arr = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;prefer&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="keyword">const</span> r = <span class="keyword">await</span> <span class="title function_">getIdCodes</span>(&#123; <span class="attr">include</span>: arr <span class="keyword">as</span> <span class="built_in">any</span>, exposeRaw &#125; <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">if</span> (r.<span class="property">best</span>) &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">return</span> (r <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[r.<span class="property">best</span>] <span class="keyword">as</span> <span class="title class_">IdValue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;none&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;no id available&quot;</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6）uni-modules-uni-id-kit-utssdk-app-android-adapters-android-id-uts"><a href="#6）uni-modules-uni-id-kit-utssdk-app-android-adapters-android-id-uts" class="headerlink" title="6）uni_modules/uni-id-kit/utssdk/app-android/adapters/android_id.uts"></a>6）<code>uni_modules/uni-id-kit/utssdk/app-android/adapters/android_id.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ANDROID_ID，无需额外权限（相对稳定，但可能因某些ROM策略变化）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAndroidIdRaw</span>(<span class="params"></span>): <span class="built_in">string</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> ctx = plus.<span class="property">android</span>.<span class="title function_">runtimeMainActivity</span>();</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">SettingsSecure</span> = plus.<span class="property">android</span>.<span class="title function_">importClass</span>(</span><br><span class="line">      <span class="string">&quot;android.provider.Settings$Secure&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> contentResolver = ctx.<span class="title function_">getContentResolver</span>();</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> id = <span class="title class_">SettingsSecure</span>.<span class="title function_">getString</span>(</span><br><span class="line">      contentResolver,</span><br><span class="line">      <span class="string">&quot;android_id&quot;</span></span><br><span class="line">    ) <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line">    <span class="keyword">return</span> id ? <span class="string">`android:<span class="subst">$&#123;id&#125;</span>`</span> : <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7）uni-modules-uni-id-kit-utssdk-app-android-index-uts"><a href="#7）uni-modules-uni-id-kit-utssdk-app-android-index-uts" class="headerlink" title="7）uni_modules/uni-id-kit/utssdk/app-android/index.uts"></a>7）<code>uni_modules/uni-id-kit/utssdk/app-android/index.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">IdCodesResult</span>, <span class="title class_">IdValue</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../common/types.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; get, set &#125; <span class="keyword">from</span> <span class="string">&quot;../common/storage.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getAndroidIdRaw &#125; <span class="keyword">from</span> <span class="string">&quot;./adapters/android_id.uts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _consent = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> _salt = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Android 原生侧用 Java 的 MessageDigest 做 SHA-256 更稳，这里暂用 Web 版占位：</span></span><br><span class="line"><span class="comment">// 你也可以在此通过 plus.android.importClass 使用 java.security.MessageDigest 实现</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sha256Hex</span>(<span class="params"><span class="attr">input</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> input; <span class="comment">// <span class="doctag">TODO:</span> 接入原生 MessageDigest 后返回真 SHA-256</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">uuid4</span>(<span class="params"></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&quot;</span>.<span class="title function_">replace</span>(<span class="regexp">/[xy]/g</span>, <span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> r = ((<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">16</span>) <span class="keyword">as</span> <span class="built_in">number</span>) | <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> v = c === <span class="string">&quot;x&quot;</span> ? r : (r &amp; <span class="number">0x3</span>) | <span class="number">0x8</span>;</span><br><span class="line">    <span class="keyword">return</span> v.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">build</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">source</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">value</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">msg</span>?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> available = !!value;</span><br><span class="line">  <span class="keyword">const</span> raw = exposeRaw ? value : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">const</span> hash = value ? <span class="keyword">await</span> <span class="title function_">sha256Hex</span>(value + _salt) : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">value</span>: raw, hash, available, limited, source, <span class="attr">message</span>: msg &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">_</span>: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span> = <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">UTSJSONObject</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// 这里接入你的合规弹窗/SDK；同意前建议不采集</span></span><br><span class="line">  _consent = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">consent</span>: _consent &#125; <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  _salt = salt || <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> v = <span class="title function_">getAndroidIdRaw</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;androidId&quot;</span>, v || <span class="literal">undefined</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 预留：接入 Google Advertising ID（AAID）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// TODO：集成 com.google.android.gms:play-services-ads-identifier</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;aaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="string">&quot;AAID not integrated&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 预留：接入 MSA OAID（国内主流）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// TODO：接入 MSA/OAID SDK</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;oaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="string">&quot;OAID not integrated&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"><span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> guid = <span class="title function_">get</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!guid) &#123;</span><br><span class="line">    guid = <span class="string">`app:<span class="subst">$&#123;uuid4()&#125;</span>`</span>;</span><br><span class="line">    <span class="title function_">set</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>, guid);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;guid&quot;</span>, guid <span class="keyword">as</span> <span class="built_in">string</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> include = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;include&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;aaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">res</span>: <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">    <span class="attr">consent</span>: _consent,</span><br><span class="line">    <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">  &#125; <span class="keyword">as</span> <span class="title class_">IdCodesResult</span>;</span><br><span class="line">  <span class="keyword">if</span> (!_consent) &#123;</span><br><span class="line">    res.<span class="property">guid</span> = &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;guid&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;consent=false&quot;</span> &#125;;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;androidId&quot;</span>) &gt;= <span class="number">0</span>)</span><br><span class="line">    res.<span class="property">androidId</span> = <span class="keyword">await</span> <span class="title function_">getAndroidId</span>(exposeRaw);</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;oaid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">oaid</span> = <span class="keyword">await</span> <span class="title function_">getOAID</span>();</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;aaid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">aaid</span> = <span class="keyword">await</span> <span class="title function_">getAAID</span>();</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;guid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">guid</span> = <span class="keyword">await</span> <span class="title function_">getGuid</span>(exposeRaw);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 国内优先级：oaid &gt; androidId &gt; guid</span></span><br><span class="line">  <span class="keyword">const</span> order = [<span class="string">&quot;oaid&quot;</span>, <span class="string">&quot;androidId&quot;</span>, <span class="string">&quot;guid&quot;</span>];</span><br><span class="line">  res.<span class="property">best</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; order.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> k = order[i];</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">v</span>: <span class="title class_">IdValue</span> | <span class="literal">null</span> = (res <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[k] <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line">    <span class="keyword">if</span> (v &amp;&amp; v.<span class="property">available</span>) &#123;</span><br><span class="line">      res.<span class="property">best</span> = k;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> arr = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;prefer&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="keyword">const</span> r = <span class="keyword">await</span> <span class="title function_">getIdCodes</span>(&#123; <span class="attr">include</span>: arr <span class="keyword">as</span> <span class="built_in">any</span>, exposeRaw &#125; <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">if</span> (r.<span class="property">best</span>) &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">return</span> (r <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[r.<span class="property">best</span>] <span class="keyword">as</span> <span class="title class_">IdValue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;none&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;no id available&quot;</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8）uni-modules-uni-id-kit-utssdk-index-uts（聚合导出）"><a href="#8）uni-modules-uni-id-kit-utssdk-index-uts（聚合导出）" class="headerlink" title="8）uni_modules/uni-id-kit/utssdk/index.uts（聚合导出）"></a>8）<code>uni_modules/uni-id-kit/utssdk/index.uts</code>（聚合导出）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 平台分发：同名导出，业务方 import 一处即可</span></span><br><span class="line"><span class="comment">// #ifdef APP-ANDROID</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  register,</span><br><span class="line">  setSalt,</span><br><span class="line">  getIdCodes,</span><br><span class="line">  getBestId,</span><br><span class="line">  getOAID,</span><br><span class="line">  getAAID,</span><br><span class="line">  getAndroidId,</span><br><span class="line">  getGuid,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./app-android/index.uts&quot;</span>;</span><br><span class="line"><span class="comment">// #endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #ifdef H5</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  register,</span><br><span class="line">  setSalt,</span><br><span class="line">  getIdCodes,</span><br><span class="line">  getBestId,</span><br><span class="line">  getOAID,</span><br><span class="line">  getAAID,</span><br><span class="line">  getAndroidId,</span><br><span class="line">  getGuid,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./web/index.uts&quot;</span>;</span><br><span class="line"><span class="comment">// #endif</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="四、在页面中使用（uni-app-x）"><a href="#四、在页面中使用（uni-app-x）" class="headerlink" title="四、在页面中使用（uni-app x）"></a>四、在页面中使用（uni-app x）</h1><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/login/index.uvue (示例)</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  register,</span><br><span class="line">  setSalt,</span><br><span class="line">  getBestId,</span><br><span class="line">  getIdCodes,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;@/uni_modules/uni-id-kit/utssdk/index.uts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">onMounted</span>(<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">register</span>(); <span class="comment">// 视需求弹你的隐私协议</span></span><br><span class="line">  <span class="title function_">setSalt</span>(<span class="string">&quot;server-salt-xxx&quot;</span>); <span class="comment">// 建议从服务端下发</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> best = <span class="keyword">await</span> <span class="title function_">getBestId</span>(&#123; <span class="attr">exposeRaw</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">  <span class="comment">// 携带 best.hash 作为 x-device-id（或 getIdCodes 的 best 项）</span></span><br><span class="line">  <span class="keyword">const</span> dvc = best.<span class="property">hash</span> || best.<span class="property">value</span> || <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> uni.<span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">`<span class="subst">$&#123;baseUrl&#125;</span>/passkeys/login/options`</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    <span class="attr">header</span>: &#123; <span class="string">&quot;x-device-id&quot;</span>: dvc &#125;,</span><br><span class="line">    <span class="attr">data</span>: &#123;&#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="五、后续接入指引（Android-OAID-AAID）"><a href="#五、后续接入指引（Android-OAID-AAID）" class="headerlink" title="五、后续接入指引（Android OAID&#x2F;AAID）"></a>五、后续接入指引（Android OAID&#x2F;AAID）</h1><ul>
<li><strong>OAID</strong>：集成 <strong>MSA&#x2F;联运</strong> SDK（各大国产厂商支持），在 <code>app-android/adapters/oaid.uts</code> 中封装 <code>getOAIDRaw()</code>，在 <code>index.uts</code> 调 <code>await build(&#39;oaid&#39;, v, ...)</code>。</li>
<li><strong>AAID</strong>：添加 <code>com.google.android.gms:play-services-ads-identifier</code> 依赖，调用 <code>AdvertisingIdClient.getAdvertisingIdInfo(context)</code>。</li>
<li><strong>SHA-256</strong>：Android 侧推荐用 <code>java.security.MessageDigest</code>，性能更稳定；把 web 占位换掉。</li>
<li><strong>权限</strong>：AndroidID 不需要额外权限；IMEI&#x2F;MEID 需要 READ_PHONE_STATE（<strong>不推荐默认启用</strong>）。</li>
<li><strong>合规</strong>：未同意隐私协议前，一律返回 <code>available=false</code>；默认仅返回 <code>hash</code>，除非 <code>exposeRaw=true</code>。</li>
</ul>
<hr>
<p>如果你认可这个结构和 API，我可以继续把 <strong>Android 的 OAID&#x2F;AAID 具体适配代码</strong>补上（带依赖、打包参数、权限说明），以及 <strong>iOS 的 IDFV</strong> 版本。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/07/id-kit/" data-id="cmf9bdhkf000bqq4zgs33gypp" data-title="id-kit" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-hello-world" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/07/hello-world/" class="article-date">
  <time class="dt-published" datetime="2025-09-07T06:30:26.785Z" itemprop="datePublished">2025-09-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/07/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/07/hello-world/" data-id="cmf9bdhkd0009qq4zatjf9py9" data-title="Hello World" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-登录后初始化的双阶段启动（增量修改）" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/06/%E7%99%BB%E5%BD%95%E5%90%8E%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E5%8F%8C%E9%98%B6%E6%AE%B5%E5%90%AF%E5%8A%A8%EF%BC%88%E5%A2%9E%E9%87%8F%E4%BF%AE%E6%94%B9%EF%BC%89/" class="article-date">
  <time class="dt-published" datetime="2025-09-06T18:30:01.000Z" itemprop="datePublished">2025-09-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/06/%E7%99%BB%E5%BD%95%E5%90%8E%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E5%8F%8C%E9%98%B6%E6%AE%B5%E5%90%AF%E5%8A%A8%EF%BC%88%E5%A2%9E%E9%87%8F%E4%BF%AE%E6%94%B9%EF%BC%89/">在 composable 里“公共初始化 + 登录后初始化”的双阶段启动（增量修改）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ul>
<li>把<strong>不需要登录</strong>的请求抽成“公共初始化（public bootstrap）”，在应用进入时就触发（只触发一次）。</li>
<li>把<strong>需要登录</strong>且<strong>命中鉴权路由</strong>时才需要的数据，保留在你现有的 <code>watch</code> 分支里，但也确保只跑一次。</li>
<li>用<strong>模块级 once 标记</strong>避免多组件重复调用；必要时可加 <code>online</code> 事件进行弱网重试（可选）。</li>
</ul>
<hr>
<h2 id="需要调整的代码（仅片段）"><a href="#需要调整的代码（仅片段）" class="headerlink" title="需要调整的代码（仅片段）"></a>需要调整的代码（仅片段）</h2><blockquote>
<p>放在你这个 composable 文件里，<strong>按位置插入</strong>即可；复杂逻辑我已在上一行加中文注释。</p>
</blockquote>
<h3 id="1）导入（在文件顶部补充）"><a href="#1）导入（在文件顶部补充）" class="headerlink" title="1）导入（在文件顶部补充）"></a>1）导入（在文件顶部补充）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：公私两段初始化需要生命周期/事件</span></span><br><span class="line"><span class="keyword">import</span> &#123; watch, onMounted &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2）模块级-once-标记（在文件顶部、export-function-useAppBootstrap-外面）"><a href="#2）模块级-once-标记（在文件顶部、export-function-useAppBootstrap-外面）" class="headerlink" title="2）模块级 once 标记（在文件顶部、export function useAppBootstrap 外面）"></a>2）模块级 once 标记（在文件顶部、<code>export function useAppBootstrap</code> 外面）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：模块级“只执行一次”标记，防止多组件重复初始化</span></span><br><span class="line"><span class="keyword">let</span> __BOOT_PUBLIC_ONCE__ = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> __BOOT_PRIVATE_ONCE__ = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3）在-useAppBootstrap-内部新增“公共初始化”方法与调用（建议贴在你定义完各个-store-之后）"><a href="#3）在-useAppBootstrap-内部新增“公共初始化”方法与调用（建议贴在你定义完各个-store-之后）" class="headerlink" title="3）在 useAppBootstrap 内部新增“公共初始化”方法与调用（建议贴在你定义完各个 store 之后）"></a>3）在 <code>useAppBootstrap</code> 内部新增“公共初始化”方法与调用（建议贴在你定义完各个 store 之后）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：公共初始化——无需登录的数据，进入站点即预取，且只执行一次</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">bootstrapPublic</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (__BOOT_PUBLIC_ONCE__) <span class="keyword">return</span>;</span><br><span class="line">  __BOOT_PUBLIC_ONCE__ = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">    <span class="comment">// ⬇️ 把“无需 token 的初始化”放这里；按你项目实际取舍</span></span><br><span class="line">    country.<span class="title function_">init</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">    exchange.<span class="title function_">init</span>(&#123; <span class="attr">keyword</span>: <span class="string">&quot;&quot;</span> &#125;).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">    marketCalendar.<span class="title function_">init</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">    <span class="comment">// 如果 server.init() 不依赖用户态，也可放到公共初始化</span></span><br><span class="line">    server.<span class="title function_">init</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">    <span class="comment">// …你还有其它完全公开的数据，也可加进来</span></span><br><span class="line">  ]);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：进入应用即触发公共初始化（SSR/CSR 兼容性考虑，放到 onMounted 最稳妥）</span></span><br><span class="line"><span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">bootstrapPublic</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="4）给你原来的-watch-回调加“私有初始化只跑一次”的保护"><a href="#4）给你原来的-watch-回调加“私有初始化只跑一次”的保护" class="headerlink" title="4）给你原来的 watch 回调加“私有初始化只跑一次”的保护"></a>4）给你原来的 <code>watch</code> 回调加“私有初始化只跑一次”的保护</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：仅在“已登录 &amp;&amp; 路由需要鉴权 &amp;&amp; 未跑过私有初始化”时执行</span></span><br><span class="line"><span class="keyword">if</span> (ok &amp;&amp; need &amp;&amp; !__BOOT_PRIVATE_ONCE__) &#123;</span><br><span class="line">  __BOOT_PRIVATE_ONCE__ = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">    user.<span class="title function_">fetchUserInfo</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">    account.<span class="title function_">init</span>(&#123; <span class="attr">withCategory</span>: <span class="literal">true</span>, <span class="attr">withExternal</span>: <span class="literal">true</span> &#125;).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">    leverage.<span class="title function_">init</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">    accountCurrency.<span class="title function_">init</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">    externalServer.<span class="title function_">init</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">    payChannel.<span class="title function_">init</span>(&#123; <span class="attr">opt_type</span>: <span class="string">&quot;deposit&quot;</span> &#125;).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">    verifyStore.<span class="title function_">initVerifyInfo</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">    inviteStore.<span class="title function_">getInviteGroupOptions</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">    <span class="comment">// ⚠️ server.init()/country/exchange/marketCalendar 已在公共初始化里跑过的可移除，避免重复</span></span><br><span class="line">  ]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="可选增强"><a href="#可选增强" class="headerlink" title="可选增强"></a>可选增强</h2><h3 id="A-弱网场景“上线即补跑”"><a href="#A-弱网场景“上线即补跑”" class="headerlink" title="A. 弱网场景“上线即补跑”"></a>A. 弱网场景“上线即补跑”</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：若用户初次进入时离线，恢复网络后自动补跑公共初始化（最多触发一次）</span></span><br><span class="line"><span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handler</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">bootstrapPublic</span>();</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;online&quot;</span>, handler, &#123; <span class="attr">once</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="B-Store-级幂等（示例片段，放到各自的-Pinia-store-里）"><a href="#B-Store-级幂等（示例片段，放到各自的-Pinia-store-里）" class="headerlink" title="B. Store 级幂等（示例片段，放到各自的 Pinia store 里）"></a>B. Store 级幂等（示例片段，放到各自的 Pinia store 里）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：在每个 init() 入口加幂等保护，彻底避免重复请求</span></span><br><span class="line"><span class="keyword">if</span> ((<span class="variable language_">this</span> <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">_inited</span>) <span class="keyword">return</span>;</span><br><span class="line">(<span class="variable language_">this</span> <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">_inited</span> = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><ul>
<li>公共数据：<code>onMounted</code> 里 <strong>立刻预取一次</strong>，全站可复用。</li>
<li>私有数据：沿用你的 <code>watch</code>，但加一次性保护，避免路由&#x2F;状态抖动造成的重复请求。</li>
<li>若存在弱网：监听 <code>online</code> 事件，<strong>一次性</strong>补跑公共初始化即可。</li>
</ul>
<hr>
<p>title: useAppBootstrap 放在哪？给你一份可直接复制的完整文件（含用法）<br>date: 2025-09-06<br>tags:</p>
<ul>
<li>Vue3</li>
<li>Vite</li>
<li>Pinia</li>
<li>composable<br>categories:</li>
<li>前端工程化</li>
</ul>
<hr>
<h2 id="位置推荐"><a href="#位置推荐" class="headerlink" title="位置推荐"></a>位置推荐</h2><p>把文件放到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src/composables/useAppBootstrap.ts</span><br></pre></td></tr></table></figure>

<p>理由：可复用的启动逻辑属于“组合式函数（composable）”，与业务无关的初始化也方便在这里统一管理。</p>
<hr>
<h2 id="完整代码（可直接替换-src-composables-useAppBootstrap-ts）"><a href="#完整代码（可直接替换-src-composables-useAppBootstrap-ts）" class="headerlink" title="完整代码（可直接替换 src/composables/useAppBootstrap.ts）"></a>完整代码（可直接替换 <code>src/composables/useAppBootstrap.ts</code>）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/composables/useAppBootstrap.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; onMounted, watch &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useRouter &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  useAuthStore,</span><br><span class="line">  useUserStore,</span><br><span class="line">  useAccountStore,</span><br><span class="line">  useServerStore,</span><br><span class="line">  useLeverageStore,</span><br><span class="line">  useAccountCurrencyStore,</span><br><span class="line">  useCountryStore,</span><br><span class="line">  useExchangeStore,</span><br><span class="line">  useExternalServerStore,</span><br><span class="line">  useMarketCalendarStore,</span><br><span class="line">  usePayChannelStore,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;@/store&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useVerifyStore &#125; <span class="keyword">from</span> <span class="string">&quot;@/store/verify&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useInviteStore &#125; <span class="keyword">from</span> <span class="string">&quot;@/store/invite&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复杂逻辑：模块级“只执行一次”标记，避免多组件/多次进入页面重复请求</span></span><br><span class="line"><span class="keyword">let</span> __BOOT_PUBLIC_ONCE__ = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> __BOOT_PRIVATE_ONCE__ = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">useAppBootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> router = <span class="title function_">useRouter</span>();</span><br><span class="line">  <span class="keyword">const</span> auth = <span class="title function_">useAuthStore</span>();</span><br><span class="line">  <span class="keyword">const</span> user = <span class="title function_">useUserStore</span>();</span><br><span class="line">  <span class="keyword">const</span> account = <span class="title function_">useAccountStore</span>();</span><br><span class="line">  <span class="keyword">const</span> server = <span class="title function_">useServerStore</span>();</span><br><span class="line">  <span class="keyword">const</span> leverage = <span class="title function_">useLeverageStore</span>();</span><br><span class="line">  <span class="keyword">const</span> accountCurrency = <span class="title function_">useAccountCurrencyStore</span>();</span><br><span class="line">  <span class="keyword">const</span> country = <span class="title function_">useCountryStore</span>();</span><br><span class="line">  <span class="keyword">const</span> exchange = <span class="title function_">useExchangeStore</span>();</span><br><span class="line">  <span class="keyword">const</span> externalServer = <span class="title function_">useExternalServerStore</span>();</span><br><span class="line">  <span class="keyword">const</span> marketCalendar = <span class="title function_">useMarketCalendarStore</span>();</span><br><span class="line">  <span class="keyword">const</span> payChannel = <span class="title function_">usePayChannelStore</span>();</span><br><span class="line">  <span class="keyword">const</span> verifyStore = <span class="title function_">useVerifyStore</span>();</span><br><span class="line">  <span class="keyword">const</span> inviteStore = <span class="title function_">useInviteStore</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 复杂逻辑：公共初始化——无需登录可获取的数据，进入站点即预取，且只执行一次</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">bootstrapPublic</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (__BOOT_PUBLIC_ONCE__) <span class="keyword">return</span>;</span><br><span class="line">    __BOOT_PUBLIC_ONCE__ = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">      <span class="comment">// ⬇️ 放“无需 token”的初始化</span></span><br><span class="line">      country.<span class="title function_">init</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">      exchange.<span class="title function_">init</span>(&#123; <span class="attr">keyword</span>: <span class="string">&quot;&quot;</span> &#125;).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">      marketCalendar.<span class="title function_">init</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">      server.<span class="title function_">init</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">      <span class="comment">// 如有其它公开数据，也可加在这里</span></span><br><span class="line">    ]);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 复杂逻辑：进入应用即触发公共初始化；若首次访问时离线，恢复网络后补跑一次（仅一次）</span></span><br><span class="line">  <span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">bootstrapPublic</span>();</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handler</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="title function_">bootstrapPublic</span>();</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;online&quot;</span>, handler, &#123; <span class="attr">once</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 复杂逻辑：仅在“已登录 &amp;&amp; 目标路由需要鉴权 &amp;&amp; 未跑过私有初始化”时执行一次性私有初始化</span></span><br><span class="line">  <span class="title function_">watch</span>(</span><br><span class="line">    [</span><br><span class="line">      <span class="function">() =&gt;</span> auth.<span class="property">isAuthenticated</span>,</span><br><span class="line">      <span class="function">() =&gt;</span> router.<span class="property">currentRoute</span>.<span class="property">value</span>.<span class="property">meta</span>?.<span class="property">requiresAuth</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="title function_">async</span> ([ok, need]) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (ok &amp;&amp; need &amp;&amp; !__BOOT_PRIVATE_ONCE__) &#123;</span><br><span class="line">        __BOOT_PRIVATE_ONCE__ = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">          user.<span class="title function_">fetchUserInfo</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">          account</span><br><span class="line">            .<span class="title function_">init</span>(&#123; <span class="attr">withCategory</span>: <span class="literal">true</span>, <span class="attr">withExternal</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">            .<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">          leverage.<span class="title function_">init</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">          accountCurrency.<span class="title function_">init</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">          externalServer.<span class="title function_">init</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">          payChannel.<span class="title function_">init</span>(&#123; <span class="attr">opt_type</span>: <span class="string">&quot;deposit&quot;</span> &#125;).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">          verifyStore.<span class="title function_">initVerifyInfo</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">          inviteStore.<span class="title function_">getInviteGroupOptions</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">          <span class="comment">// ⚠️ 已在公共初始化中完成的 server/country/exchange/marketCalendar 无需重复</span></span><br><span class="line">        ]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="attr">immediate</span>: <span class="literal">true</span> &#125;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// （可选）测试/登出时重置标记</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">__resetBootstrapFlagsForTestOnly</span>(<span class="params"></span>) &#123;</span><br><span class="line">  __BOOT_PUBLIC_ONCE__ = <span class="literal">false</span>;</span><br><span class="line">  __BOOT_PRIVATE_ONCE__ = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="如何使用（最小改动）"><a href="#如何使用（最小改动）" class="headerlink" title="如何使用（最小改动）"></a>如何使用（最小改动）</h2><blockquote>
<p>你<strong>不需要</strong>在每个页面手动调用，只需在 <strong>App.vue</strong> 顶层调用一次即可。</p>
</blockquote>
<p>在 <code>src/App.vue</code> 的 <code>&lt;script setup&gt;</code> 里加入一行（<strong>增量修改</strong>）：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：顶层调用一次，注册 watch + onMounted，即可全局生效</span></span><br><span class="line"><span class="keyword">import</span> &#123; useAppBootstrap &#125; <span class="keyword">from</span> <span class="string">&quot;@/composables/useAppBootstrap&quot;</span>;</span><br><span class="line"><span class="title function_">useAppBootstrap</span>();</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果你的项目还没在 <code>main.ts</code> 里安装 Pinia&#x2F;Router，请确认已安装（一般你已经有了）：</p>
</blockquote>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 仅供核对：main.ts 应该已包含这些</span></span><br><span class="line"><span class="comment">// import &#123; createApp &#125; from &#x27;vue&#x27;</span></span><br><span class="line"><span class="comment">// import &#123; createPinia &#125; from &#x27;pinia&#x27;</span></span><br><span class="line"><span class="comment">// import router from &#x27;./router&#x27;</span></span><br><span class="line"><span class="comment">// import App from &#x27;./App.vue&#x27;</span></span><br><span class="line"><span class="comment">// createApp(App).use(createPinia()).use(router).mount(&#x27;#app&#x27;)</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h2><ul>
<li>文件放在：<code>src/composables/useAppBootstrap.ts</code>。</li>
<li>在 <code>App.vue</code> 顶层调用一次 <code>useAppBootstrap()</code> 即全局生效。</li>
<li>公共初始化：站点进入即跑；私有初始化：登录且命中鉴权路由时只跑一次。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/06/%E7%99%BB%E5%BD%95%E5%90%8E%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E5%8F%8C%E9%98%B6%E6%AE%B5%E5%90%AF%E5%8A%A8%EF%BC%88%E5%A2%9E%E9%87%8F%E4%BF%AE%E6%94%B9%EF%BC%89/" data-id="cmf9bdhks0015qq4z8sct0uyb" data-title="在 composable 里“公共初始化 + 登录后初始化”的双阶段启动（增量修改）" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Pinia/" rel="tag">Pinia</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vue3/" rel="tag">Vue3</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/composable/" rel="tag">composable</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%88%9D%E5%A7%8B%E5%8C%96/" rel="tag">初始化</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-体积分布分析图" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/06/%E4%BD%93%E7%A7%AF%E5%88%86%E5%B8%83%E5%88%86%E6%9E%90%E5%9B%BE/" class="article-date">
  <time class="dt-published" datetime="2025-09-06T16:59:20.000Z" itemprop="datePublished">2025-09-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/06/%E4%BD%93%E7%A7%AF%E5%88%86%E5%B8%83%E5%88%86%E6%9E%90%E5%9B%BE/">Vite + Vue3 打包后如何查看“体积分布分析图”</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h2><p>想在 <strong>Vite + Vue3</strong> 打包后看到类似 Webpack Bundle Analyzer 的交互式“依赖体积分布图”，最简单稳妥的方法是接入 <code>rollup-plugin-visualizer</code>。本文给出<strong>最小改动</strong>方案：按需启用分析模式、构建、自动打开 <code>stats.html</code>。</p>
<hr>
<h2 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h2><ul>
<li>使用 Rollup 可视化插件（Vite 打包底层是 Rollup）。</li>
<li>仅在“分析模式”挂载插件，避免影响日常构建速度。</li>
<li>构建完成自动生成并打开 <code>stats.html</code>（Treemap&#x2F;Sunburst 可选）。</li>
<li>可选：开启 <code>sourcemap</code> 便于二次分析。</li>
</ul>
<hr>
<h2 id="分步操作"><a href="#分步操作" class="headerlink" title="分步操作"></a>分步操作</h2><h3 id="1）安装依赖"><a href="#1）安装依赖" class="headerlink" title="1）安装依赖"></a>1）安装依赖</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 任选包管理器</span></span><br><span class="line">pnpm add -D rollup-plugin-visualizer</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">npm i -D rollup-plugin-visualizer</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">yarn add -D rollup-plugin-visualizer</span><br></pre></td></tr></table></figure>

<h3 id="2）修改-vite-config-ts（只给需要改的片段）"><a href="#2）修改-vite-config-ts（只给需要改的片段）" class="headerlink" title="2）修改 vite.config.ts（只给需要改的片段）"></a>2）修改 <code>vite.config.ts</code>（只给需要改的片段）</h3><blockquote>
<p>说明：以下片段为<strong>增量修改</strong>，请在你的 <code>vite.config.ts</code> 里按位置插入即可。</p>
</blockquote>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ① 顶部新增一行：导入可视化插件</span></span><br><span class="line"><span class="keyword">import</span> &#123; visualizer &#125; <span class="keyword">from</span> <span class="string">&quot;rollup-plugin-visualizer&quot;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ② 在 defineConfig 回调里按需启用（若你当前不是回调形式，可改为回调：defineConfig((&#123; mode &#125;) =&gt; (&#123; ... &#125;))）</span></span><br><span class="line"><span class="keyword">const</span> enableAnalyze = process.<span class="property">env</span>.<span class="property">ANALYZE</span> === <span class="string">&quot;true&quot;</span> || mode === <span class="string">&quot;analyze&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复杂逻辑：仅在分析模式下挂载插件，避免常规构建受影响</span></span><br><span class="line">enableAnalyze &amp;&amp;</span><br><span class="line">  plugins.<span class="title function_">push</span>(</span><br><span class="line">    <span class="title function_">visualizer</span>(&#123;</span><br><span class="line">      <span class="comment">// 复杂逻辑：输出 treemap 到项目根目录，并在构建结束自动打开</span></span><br><span class="line">      <span class="attr">filename</span>: <span class="string">&quot;stats.html&quot;</span>,</span><br><span class="line">      <span class="attr">template</span>: <span class="string">&quot;treemap&quot;</span>, <span class="comment">// 可选：&#x27;treemap&#x27; | &#x27;sunburst&#x27; | &#x27;network&#x27;</span></span><br><span class="line">      <span class="attr">open</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">gzipSize</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">brotliSize</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ③（可选）为了配合二次分析或排查问题，开启源码映射</span></span><br><span class="line"><span class="attr">build</span>: &#123;</span><br><span class="line">  <span class="comment">// 复杂逻辑：仅在分析模式下开启 sourcemap（若你已有 build 配置，请合并到其中）</span></span><br><span class="line">  <span class="attr">sourcemap</span>: enableAnalyze;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>小贴士：若你的 <code>plugins</code> 是直接字面量数组，改成先声明 <code>const plugins = [vue(/*...*/)]</code> 再 <code>.push(...)</code>，最后 <code>return &#123; plugins &#125;</code>。不想改结构也行：<code>plugins: [vue(), enableAnalyze &amp;&amp; visualizer(&#123;...&#125;)].filter(Boolean)</code>。</p>
</blockquote>
<h3 id="3）新增构建脚本（二选一）"><a href="#3）新增构建脚本（二选一）" class="headerlink" title="3）新增构建脚本（二选一）"></a>3）新增构建脚本（二选一）</h3><p><strong>方案 A（推荐，跨平台零依赖）：用 <code>--mode analyze</code> 触发</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vite build&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;build:analyze&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vite build --mode analyze&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>方案 B：用环境变量触发（类 Unix 系统方便）</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vite build&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// 复杂逻辑：通过环境变量开启分析模式；Windows 可用 cross-env 做兼容</span></span><br><span class="line">    <span class="attr">&quot;build:analyze&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ANALYZE=true vite build&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 触发分析构建（使用你选择的方案）</span></span><br><span class="line">pnpm run build:analyze</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建完成后会自动打开 stats.html</span></span><br><span class="line"><span class="comment"># 若未自动打开，可手动在项目根目录双击/用浏览器打开 stats.html</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="进阶玩法（可选）"><a href="#进阶玩法（可选）" class="headerlink" title="进阶玩法（可选）"></a>进阶玩法（可选）</h2><h3 id="A-自定义输出位置-图表类型"><a href="#A-自定义输出位置-图表类型" class="headerlink" title="A. 自定义输出位置&#x2F;图表类型"></a>A. 自定义输出位置&#x2F;图表类型</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：将报告输出到 dist 目录下并改为 sunburst 风格</span></span><br><span class="line"><span class="title function_">visualizer</span>(&#123;</span><br><span class="line">  <span class="attr">filename</span>: <span class="string">&quot;dist/bundle-report.html&quot;</span>,</span><br><span class="line">  <span class="attr">template</span>: <span class="string">&quot;sunburst&quot;</span>,</span><br><span class="line">  <span class="attr">open</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="B-快速“拆包”以便观察效果"><a href="#B-快速“拆包”以便观察效果" class="headerlink" title="B. 快速“拆包”以便观察效果"></a>B. 快速“拆包”以便观察效果</h3><blockquote>
<p>仅示例，按你实际依赖调整：</p>
</blockquote>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：演示常见手动分包，便于在图里更清晰地区分</span></span><br><span class="line"><span class="attr">build</span>: &#123;</span><br><span class="line">  <span class="attr">rollupOptions</span>: &#123;</span><br><span class="line">    <span class="attr">output</span>: &#123;</span><br><span class="line">      <span class="attr">manualChunks</span>: &#123;</span><br><span class="line">        <span class="attr">vue</span>: [<span class="string">&#x27;vue&#x27;</span>, <span class="string">&#x27;vue-router&#x27;</span>, <span class="string">&#x27;pinia&#x27;</span>],</span><br><span class="line">        <span class="comment">// 如果你用到 Ant Design Vue / ECharts / AntV 等，可分别拆</span></span><br><span class="line">        <span class="comment">// antdv: [&#x27;ant-design-vue&#x27;],</span></span><br><span class="line">        <span class="comment">// echarts: [&#x27;echarts&#x27;],</span></span><br><span class="line">        <span class="comment">// antv: [&#x27;@antv/g2&#x27;, &#x27;@antv/g2plot&#x27;],</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="C-二次分析（Source-Map）"><a href="#C-二次分析（Source-Map）" class="headerlink" title="C. 二次分析（Source Map）"></a>C. 二次分析（Source Map）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可选：安装 source-map-explorer 做“按文件”体积分析</span></span><br><span class="line">pnpm add -D source-map-explorer</span><br><span class="line"><span class="comment"># 构建（确保 sourcemap 已开启）</span></span><br><span class="line">pnpm run build:analyze</span><br><span class="line"><span class="comment"># 生成 HTML 报告（路径按你的 dist 实际文件调整）</span></span><br><span class="line">npx source-map-explorer <span class="string">&quot;dist/assets/*.js&quot;</span> --html dist/sme.html</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><ul>
<li><p><strong>stats.html 是空白&#x2F;打不开？</strong><br>多半是构建被缓存或浏览器拦截了本地文件。先清理 <code>dist</code> 再构建；或换个浏览器打开，必要时关闭浏览器的本地文件限制。</p>
</li>
<li><p><strong>报告没自动打开？</strong><br>CI&#x2F;无头环境不会自动打开。把 <code>open: false</code>，直接到输出目录找报告 HTML 即可。</p>
</li>
<li><p><strong>Windows 下 <code>ANALYZE=true</code> 不生效？</strong><br>用方案 A（<code>--mode analyze</code>），或安装 <code>cross-env</code>：<br><code>cross-env ANALYZE=true vite build</code>。</p>
</li>
<li><p><strong>体积异常大但定位不到模块？</strong><br>开启 <code>sourcemap</code> 后再看 <code>stats.html</code>；若仍不清晰，配合 <code>source-map-explorer</code> 交叉验证。</p>
</li>
</ul>
<hr>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><ul>
<li>装一个 <code>rollup-plugin-visualizer</code>，按需启用分析模式，构建即得可交互分析图。</li>
<li>报告默认 <code>stats.html</code>，Treemap&#x2F;Sunburst 随选。</li>
<li>需要更深入排查时，打开 <code>sourcemap</code> + <code>source-map-explorer</code> 双管齐下。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/06/%E4%BD%93%E7%A7%AF%E5%88%86%E5%B8%83%E5%88%86%E6%9E%90%E5%9B%BE/" data-id="cmf9bdhko000vqq4z4ay9fmsn" data-title="Vite + Vue3 打包后如何查看“体积分布分析图”" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vite/" rel="tag">Vite</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vue3/" rel="tag">Vue3</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rollup-plugin-visualizer/" rel="tag">rollup-plugin-visualizer</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%89%93%E5%8C%85%E5%88%86%E6%9E%90/" rel="tag">打包分析</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Axios-鉴权最佳实践：prefix-useAuth-显式开关（含最小改动补丁）" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/06/Axios-%E9%89%B4%E6%9D%83%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%EF%BC%9Aprefix-useAuth-%E6%98%BE%E5%BC%8F%E5%BC%80%E5%85%B3%EF%BC%88%E5%90%AB%E6%9C%80%E5%B0%8F%E6%94%B9%E5%8A%A8%E8%A1%A5%E4%B8%81%EF%BC%89/" class="article-date">
  <time class="dt-published" datetime="2025-09-06T16:20:26.000Z" itemprop="datePublished">2025-09-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/06/Axios-%E9%89%B4%E6%9D%83%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%EF%BC%9Aprefix-useAuth-%E6%98%BE%E5%BC%8F%E5%BC%80%E5%85%B3%EF%BC%88%E5%90%AB%E6%9C%80%E5%B0%8F%E6%94%B9%E5%8A%A8%E8%A1%A5%E4%B8%81%EF%BC%89/">Axios 鉴权最佳实践：prefix + useAuth 显式开关（含最小改动补丁）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">title:</span> <span class="string">Axios</span> <span class="string">鉴权最佳实践：prefix</span> <span class="string">+</span> <span class="string">useAuth</span> <span class="string">显式开关（含最小改动补丁）</span></span><br><span class="line"><span class="attr">date:</span> <span class="number">2025-09-06</span></span><br><span class="line"><span class="attr">tags:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Axios</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Vue3</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">TypeScript</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Interceptor</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Auth</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="comment">## 目标</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">保留按前缀（如</span> <span class="string">`/api/pub`）**自动放行**的白名单机制；</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">支持**逐请求显式关闭鉴权**（即便该接口不在白名单里）；</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">避免与</span> <span class="string">Axios</span> <span class="string">自带的</span> <span class="string">`config.auth`（Basic</span> <span class="string">Auth）混淆；</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">兼容历史</span> <span class="string">`(req</span> <span class="string">as</span> <span class="string">any).auth`</span> <span class="string">写法，**渐进迁移**到</span> <span class="string">`useAuth`。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 方案总览</span></span><br><span class="line"><span class="number">1</span><span class="string">.</span> <span class="string">**类型扩展**：给</span> <span class="string">`AxiosRequestConfig`</span> <span class="string">增加</span> <span class="string">`useAuth?:</span> <span class="string">boolean`。</span></span><br><span class="line"><span class="number">2</span><span class="string">.</span> <span class="string">**对象式入口透传**：`http.call(&#123;...</span> <span class="string">useAuth</span> <span class="string">&#125;)`</span> <span class="string">直达拦截器。</span></span><br><span class="line"><span class="number">3</span><span class="string">.</span> <span class="string">**拦截器优先级**：优先读</span> <span class="string">`useAuth`</span> <span class="string">→</span> <span class="string">回退老的</span> <span class="string">`auth`</span> <span class="string">→</span> <span class="string">再按前缀与实例默认值判定。</span></span><br><span class="line"><span class="number">4</span><span class="string">.</span> <span class="string">**显式移除头**：当不需要鉴权时，从请求头里**删除**</span> <span class="string">`Authorization`，避免误带默认</span> <span class="string">token。</span></span><br><span class="line"><span class="number">5</span><span class="string">.</span> <span class="string">**调用方式**：`http.get/post(...,</span> &#123; <span class="string">useAuth:false</span> &#125;<span class="string">)`</span> <span class="string">或</span> <span class="string">`http.call(&#123;</span> <span class="string">useAuth:false</span> <span class="string">&#125;)`。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="comment">## 关键改动（最小补丁）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 1) 扩展 Axios 配置</span></span><br><span class="line"><span class="string">&gt;</span> <span class="string">避免与</span> <span class="string">Basic</span> <span class="string">Auth</span> <span class="string">的</span> <span class="string">`config.auth`</span> <span class="string">冲突，用单独的</span> <span class="string">`useAuth`。</span></span><br><span class="line"></span><br><span class="line"><span class="string">```ts</span></span><br><span class="line"><span class="string">//</span> <span class="string">src/types/http/axios.d.ts</span></span><br><span class="line"><span class="string">declare</span> <span class="string">module</span> <span class="string">&#x27;axios&#x27;</span> &#123;</span><br><span class="line">  <span class="string">export</span> <span class="string">interface</span> <span class="string">AxiosRequestConfig</span> &#123;</span><br><span class="line">    <span class="string">/**</span> <span class="string">覆盖实例默认鉴权：true=强制带token；false=强制不带token</span> <span class="string">*/</span></span><br><span class="line">    <span class="string">useAuth?:</span> <span class="string">boolean</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-对象式入口支持-useAuth"><a href="#2-对象式入口支持-useAuth" class="headerlink" title="2) 对象式入口支持 useAuth"></a>2) 对象式入口支持 <code>useAuth</code></h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/lib/http/types.ts（RequestOptions 中新增）</span></span><br><span class="line"><span class="attr">useAuth</span>?: <span class="built_in">boolean</span></span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/lib/http/call.ts（buildAxiosConfigFromOptions 末尾透传）</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_">typeof</span> (options <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">useAuth</span> === <span class="string">&quot;boolean&quot;</span>) &#123;</span><br><span class="line">  (cfg <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">useAuth</span> = (options <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">useAuth</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-请求拦截器：判定与显式移除头"><a href="#3-请求拦截器：判定与显式移除头" class="headerlink" title="3) 请求拦截器：判定与显式移除头"></a>3) 请求拦截器：判定与显式移除头</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/lib/http/client.ts（拦截器内替换判定片段）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1) 优先 useAuth，回退旧的 auth</span></span><br><span class="line"><span class="keyword">const</span> explicitAuth =</span><br><span class="line">  <span class="title function_">typeof</span> (req <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">useAuth</span> === <span class="string">&quot;boolean&quot;</span></span><br><span class="line">    ? (req <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">useAuth</span></span><br><span class="line">    : <span class="title function_">typeof</span> (req <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">auth</span> === <span class="string">&quot;boolean&quot;</span></span><br><span class="line">    ? (req <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">auth</span></span><br><span class="line">    : <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> needAuth = explicitAuth ?? (authDefault &amp;&amp; !isPublicByPrefix);</span><br><span class="line"><span class="keyword">const</span> accToken = storage.<span class="title function_">get</span>(<span class="variable constant_">ACCESS_TOKEN</span>);</span><br><span class="line"><span class="keyword">const</span> tokenType = storage.<span class="title function_">get</span>(<span class="variable constant_">TOKEN_TYPE</span>) || <span class="string">&quot;Bearer&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2) 不需要鉴权：显式移除 Authorization，避免误带默认头</span></span><br><span class="line"><span class="keyword">if</span> (!needAuth) &#123;</span><br><span class="line">  <span class="keyword">const</span> h = (req.<span class="property">headers</span> || &#123;&#125;) <span class="keyword">as</span> <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt;;</span><br><span class="line">  <span class="keyword">delete</span> h.<span class="property">Authorization</span>;</span><br><span class="line">  <span class="keyword">delete</span> h.<span class="property">authorization</span>;</span><br><span class="line">  req.<span class="property">headers</span> = h;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// 需要鉴权但无 token：中断</span></span><br><span class="line">  <span class="keyword">if</span> (!accToken) &#123;</span><br><span class="line">    abortController.<span class="title function_">abort</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;UNAUTHENTICATED&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 需要鉴权且有 token：注入</span></span><br><span class="line">  req.<span class="property">headers</span> = &#123; ...req.<span class="property">headers</span>, <span class="title class_">Authorization</span>: <span class="string">`<span class="subst">$&#123;tokenType&#125;</span> <span class="subst">$&#123;accToken&#125;</span>`</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="调用方式示例"><a href="#调用方式示例" class="headerlink" title="调用方式示例"></a>调用方式示例</h2><h3 id="A-传统-axios-三参（推荐）"><a href="#A-传统-axios-三参（推荐）" class="headerlink" title="A) 传统 axios 三参（推荐）"></a>A) 传统 axios 三参（推荐）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 公开接口（不走 /api/pub，但也不需要 token）</span></span><br><span class="line"><span class="keyword">await</span> http.<span class="title function_">get</span>(<span class="string">&quot;/api/third/get_login_credential_code&quot;</span>, &#123; <span class="attr">useAuth</span>: <span class="literal">false</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// POST 且不带 token</span></span><br><span class="line"><span class="keyword">await</span> http.<span class="title function_">post</span>(<span class="string">&quot;/api/third/login_by_credential&quot;</span>, payload, &#123; <span class="attr">useAuth</span>: <span class="literal">false</span> &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="B-对象式入口"><a href="#B-对象式入口" class="headerlink" title="B) 对象式入口"></a>B) 对象式入口</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> http.<span class="title function_">call</span>(&#123;</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&quot;/api/third/get_login_credential_code&quot;</span>,</span><br><span class="line">  <span class="attr">method</span>: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">  <span class="attr">useAuth</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> http.<span class="title function_">call</span>(&#123;</span><br><span class="line">  <span class="attr">url</span>: <span class="string">&quot;/api/third/login_by_credential&quot;</span>,</span><br><span class="line">  <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">  <span class="attr">data</span>: payload,</span><br><span class="line">  <span class="attr">useAuth</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="兼容与迁移"><a href="#兼容与迁移" class="headerlink" title="兼容与迁移"></a>兼容与迁移</h2><ul>
<li>旧代码里的 <code>(req as any).auth = false</code> 仍可用（拦截器已回退支持），但<strong>建议逐步统一到 <code>useAuth</code></strong>。</li>
<li>仍保留 <code>publicPrefixes</code>（如 <code>/api/pub</code>）自动放行；<code>useAuth:false</code> 仅在<strong>个别不走白名单的公开接口</strong>上使用。</li>
</ul>
<hr>
<h2 id="常见坑"><a href="#常见坑" class="headerlink" title="常见坑"></a>常见坑</h2><ul>
<li><strong>不要</strong>再用 <code>config.auth = false</code>：那是 Basic Auth，类型不对、语义也不对。</li>
<li>如果调用过 <code>http.setAuthToken</code> 写了默认头，<strong>不显式移除</strong>就会误带 token；本方案在拦截器中已处理。</li>
<li>确保 <code>tsconfig.json</code> 的 <code>include</code> 覆盖到 <code>src/types</code>，让编辑器识别 <code>useAuth</code> 类型。</li>
</ul>
<hr>
<h2 id="验收清单"><a href="#验收清单" class="headerlink" title="验收清单"></a>验收清单</h2><ul>
<li><input disabled="" type="checkbox"> <code>src/types/http/axios.d.ts</code> 已生效（编辑器能识别 <code>useAuth</code>）。</li>
<li><input disabled="" type="checkbox"> <code>http.call</code> 能接收 <code>useAuth</code> 并透传到拦截器。</li>
<li><input disabled="" type="checkbox"> 拦截器在 <code>useAuth:false</code> 时<strong>不发送 Authorization</strong>；在需要鉴权但无 token 时<strong>立即中断</strong>。</li>
<li><input disabled="" type="checkbox"> 现网公开接口（不在 <code>/api/pub</code>）能通过 <code>&#123; useAuth:false &#125;</code> 正常调用。</li>
</ul>
<blockquote>
<p>结论：这套改动<strong>小而稳</strong>，语义清晰、类型安全，满足“前缀白名单 + 逐请求显式关闭鉴权”的企业级最佳实践。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">::contentReference[oaicite:0]&#123;index=0&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/06/Axios-%E9%89%B4%E6%9D%83%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%EF%BC%9Aprefix-useAuth-%E6%98%BE%E5%BC%8F%E5%BC%80%E5%85%B3%EF%BC%88%E5%90%AB%E6%9C%80%E5%B0%8F%E6%94%B9%E5%8A%A8%E8%A1%A5%E4%B8%81%EF%BC%89/" data-id="cmf9bdhk10003qq4z6a4rae0y" data-title="Axios 鉴权最佳实践：prefix + useAuth 显式开关（含最小改动补丁）" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-一个-downloadFile-就够了：直链与鉴权下载自动切换（Vue-TS）" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/06/%E4%B8%80%E4%B8%AA-downloadFile-%E5%B0%B1%E5%A4%9F%E4%BA%86%EF%BC%9A%E7%9B%B4%E9%93%BE%E4%B8%8E%E9%89%B4%E6%9D%83%E4%B8%8B%E8%BD%BD%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2%EF%BC%88Vue-TS%EF%BC%89/" class="article-date">
  <time class="dt-published" datetime="2025-09-06T15:13:25.000Z" itemprop="datePublished">2025-09-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/06/%E4%B8%80%E4%B8%AA-downloadFile-%E5%B0%B1%E5%A4%9F%E4%BA%86%EF%BC%9A%E7%9B%B4%E9%93%BE%E4%B8%8E%E9%89%B4%E6%9D%83%E4%B8%8B%E8%BD%BD%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2%EF%BC%88Vue-TS%EF%BC%89/">一个 downloadFile 就够了：直链与鉴权下载自动切换（Vue/TS）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="需求背景"><a href="#需求背景" class="headerlink" title="需求背景"></a>需求背景</h2><ul>
<li>有的文件<strong>公开直链</strong>，直接点就能下；</li>
<li>有的需要<strong>携带 Cookie&#x2F;Token、自定义 Header 或用 POST</strong> 才能拿到二进制流；</li>
<li>我们希望<strong>一个函数</strong>即可应对两类场景，并自动选择最优策略。</li>
</ul>
<h2 id="设计要点"><a href="#设计要点" class="headerlink" title="设计要点"></a>设计要点</h2><ul>
<li><strong>优先直链（a.click）</strong>：不加 header&#x2F;body&#x2F;credentials 时，直接跳转下载；</li>
<li><strong>按需请求（fetch→Blob）</strong>：当需要鉴权&#x2F;自定义 Header&#x2F;POST，先拿 Blob，再用 Object URL 触发下载；</li>
<li><strong>文件名解析</strong>：未显式传 <code>fileName</code> 时，尝试从 <code>Content-Disposition</code> 读取；</li>
<li><strong>内存友好</strong>：使用 Object URL 并及时 <code>URL.revokeObjectURL</code>。</li>
</ul>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">DownloadOptions</span> = <span class="title class_">Omit</span>&lt;<span class="title class_">RequestInit</span>, <span class="string">&quot;signal&quot;</span>&gt; &amp; &#123;</span><br><span class="line">  <span class="attr">fileName</span>?: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">forceRequest</span>?: <span class="built_in">boolean</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_pickNameFromContentDisposition</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">cd</span>: <span class="built_in">string</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="built_in">string</span> | <span class="literal">undefined</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!cd) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">const</span> star = cd.<span class="title function_">match</span>(<span class="regexp">/filename\*=(?:UTF-8&#x27;&#x27;)?([^;]+)/i</span>);</span><br><span class="line">  <span class="keyword">const</span> norm = cd.<span class="title function_">match</span>(<span class="regexp">/filename=([^;]+)/i</span>);</span><br><span class="line">  <span class="keyword">const</span> raw = (star?.[<span class="number">1</span>] ?? norm?.[<span class="number">1</span>])?.<span class="title function_">trim</span>().<span class="title function_">replace</span>(<span class="regexp">/^[&quot;&#x27;]|[&quot;&#x27;]$/g</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> raw ? <span class="built_in">decodeURIComponent</span>(raw) : <span class="literal">undefined</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> raw;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">downloadFile</span>(<span class="params"><span class="attr">url</span>: <span class="built_in">string</span>, <span class="attr">options</span>: <span class="title class_">DownloadOptions</span> = &#123;&#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; fileName, forceRequest, ...req &#125; = options;</span><br><span class="line">  <span class="keyword">const</span> needRequest =</span><br><span class="line">    !!forceRequest ||</span><br><span class="line">    (req.<span class="property">method</span> &amp;&amp; req.<span class="property">method</span>.<span class="title function_">toUpperCase</span>() !== <span class="string">&quot;GET&quot;</span>) ||</span><br><span class="line">    !!req.<span class="property">headers</span> ||</span><br><span class="line">    !!req.<span class="property">body</span> ||</span><br><span class="line">    !!req.<span class="property">credentials</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!needRequest) &#123;</span><br><span class="line">    <span class="keyword">const</span> a = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">    a.<span class="property">href</span> = url;</span><br><span class="line">    <span class="keyword">if</span> (fileName) a.<span class="property">download</span> = fileName; <span class="comment">// 跨域直链可能被忽略</span></span><br><span class="line">    a.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&quot;none&quot;</span>;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(a);</span><br><span class="line">    a.<span class="title function_">click</span>();</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">removeChild</span>(a);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">fetch</span>(url, req);</span><br><span class="line">  <span class="keyword">if</span> (!res.<span class="property">ok</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`Download failed: <span class="subst">$&#123;res.status&#125;</span> <span class="subst">$&#123;res.statusText&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> name =</span><br><span class="line">    fileName ??</span><br><span class="line">    <span class="title function_">_pickNameFromContentDisposition</span>(res.<span class="property">headers</span>.<span class="title function_">get</span>(<span class="string">&quot;content-disposition&quot;</span>));</span><br><span class="line">  <span class="keyword">const</span> blob = <span class="keyword">await</span> res.<span class="title function_">blob</span>();</span><br><span class="line">  <span class="keyword">const</span> href = <span class="variable constant_">URL</span>.<span class="title function_">createObjectURL</span>(blob);</span><br><span class="line">  <span class="keyword">const</span> a = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">  a.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&quot;none&quot;</span>;</span><br><span class="line">  a.<span class="property">href</span> = href;</span><br><span class="line">  <span class="keyword">if</span> (name) a.<span class="property">download</span> = name;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(a);</span><br><span class="line">  a.<span class="title function_">click</span>();</span><br><span class="line">  <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">removeChild</span>(a);</span><br><span class="line">  <span class="variable constant_">URL</span>.<span class="title function_">revokeObjectURL</span>(href);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><h3 id="直链（公开资源）"><a href="#直链（公开资源）" class="headerlink" title="直链（公开资源）"></a>直链（公开资源）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="title function_">downloadFile</span>(<span class="string">&quot;https://cdn.example.com/file.pdf&quot;</span>, &#123;</span><br><span class="line">  <span class="attr">fileName</span>: <span class="string">&quot;文档.pdf&quot;</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="携带-Cookie-Token"><a href="#携带-Cookie-Token" class="headerlink" title="携带 Cookie&#x2F;Token"></a>携带 Cookie&#x2F;Token</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="title function_">downloadFile</span>(<span class="string">&quot;/api/report/export&quot;</span>, &#123;</span><br><span class="line">  <span class="attr">credentials</span>: <span class="string">&quot;include&quot;</span>,</span><br><span class="line">  <span class="attr">headers</span>: &#123; <span class="title class_">Authorization</span>: <span class="string">&quot;Bearer xxx&quot;</span> &#125;,</span><br><span class="line">  <span class="attr">fileName</span>: <span class="string">&quot;报表.xlsx&quot;</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="POST-导出"><a href="#POST-导出" class="headerlink" title="POST 导出"></a>POST 导出</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="title function_">downloadFile</span>(<span class="string">&quot;/api/export&quot;</span>, &#123;</span><br><span class="line">  <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">  <span class="attr">headers</span>: &#123; <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span>, <span class="title class_">Authorization</span>: <span class="string">&quot;Bearer xxx&quot;</span> &#125;,</span><br><span class="line">  <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123; <span class="attr">range</span>: <span class="string">&quot;2025-01-01~2025-09-01&quot;</span> &#125;),</span><br><span class="line">  <span class="attr">fileName</span>: <span class="string">&quot;导出.csv&quot;</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ul>
<li><strong>跨域直链</strong>时，浏览器可能<strong>忽略 <code>download</code> 文件名</strong>，以服务器或默认名为准；</li>
<li>如需强制走请求分支，可传 <code>forceRequest: true</code>；</li>
<li>服务器若返回 <code>Content-Disposition</code>，无需传 <code>fileName</code> 也能自动命名；</li>
<li>大文件下载建议结合服务端分片&#x2F;断点续传方案（本函数仅负责触发下载）。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/06/%E4%B8%80%E4%B8%AA-downloadFile-%E5%B0%B1%E5%A4%9F%E4%BA%86%EF%BC%9A%E7%9B%B4%E9%93%BE%E4%B8%8E%E9%89%B4%E6%9D%83%E4%B8%8B%E8%BD%BD%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2%EF%BC%88Vue-TS%EF%BC%89/" data-id="cmf9bdhkm000qqq4zchvp15wq" data-title="一个 downloadFile 就够了：直链与鉴权下载自动切换（Vue/TS）" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Fetch/" rel="tag">Fetch</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TypeScript/" rel="tag">TypeScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%B8%8B%E8%BD%BD/" rel="tag">下载</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF/" rel="tag">前端</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Vue-3-最小可用示例：分页-无限滚动（-tanstack-vue-query）" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/06/Vue-3-%E6%9C%80%E5%B0%8F%E5%8F%AF%E7%94%A8%E7%A4%BA%E4%BE%8B%EF%BC%9A%E5%88%86%E9%A1%B5-%E6%97%A0%E9%99%90%E6%BB%9A%E5%8A%A8%EF%BC%88-tanstack-vue-query%EF%BC%89/" class="article-date">
  <time class="dt-published" datetime="2025-09-06T14:49:38.000Z" itemprop="datePublished">2025-09-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/06/Vue-3-%E6%9C%80%E5%B0%8F%E5%8F%AF%E7%94%A8%E7%A4%BA%E4%BE%8B%EF%BC%9A%E5%88%86%E9%A1%B5-%E6%97%A0%E9%99%90%E6%BB%9A%E5%8A%A8%EF%BC%88-tanstack-vue-query%EF%BC%89/">Vue 3 最小可用示例：分页 &amp; 无限滚动（@tanstack/vue-query）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <hr>
<p>title: Vue 3 最小可用示例：分页 &amp; 无限滚动（@tanstack&#x2F;vue-query）<br>date: 2025-09-06<br>tags:</p>
<ul>
<li>Vue3</li>
<li>TanStack Vue Query</li>
<li>分页</li>
<li>无限滚动</li>
</ul>
<hr>
<h2 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h2><p>已安装并在 <code>main.ts</code> 里注册了 <code>@tanstack/vue-query</code>（你之前那步已经完成）。下面示例直接复用你的 <code>http.call</code> 封装。</p>
<hr>
<h2 id="一、页码分页（page-pageSize）"><a href="#一、页码分页（page-pageSize）" class="headerlink" title="一、页码分页（page&#x2F;pageSize）"></a>一、页码分页（page&#x2F;pageSize）</h2><h3 id="1-组合式函数：usePagedItems-ts"><a href="#1-组合式函数：usePagedItems-ts" class="headerlink" title="1) 组合式函数：usePagedItems.ts"></a>1) 组合式函数：<code>usePagedItems.ts</code></h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/features/demo/usePagedItems.ts</span></span><br><span class="line"><span class="string">&quot;use client&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useQuery &#125; <span class="keyword">from</span> <span class="string">&quot;@tanstack/vue-query&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; http &#125; <span class="keyword">from</span> <span class="string">&quot;@/lib/http&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复杂逻辑上一行注释：后端返回 PageResp 结构（list/total/page/pageSize）</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Item</span> = &#123; <span class="attr">id</span>: <span class="built_in">string</span>; <span class="attr">title</span>: <span class="built_in">string</span> &#125;;</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">PageResp</span>&lt;T&gt; = &#123; <span class="attr">list</span>: T[]; <span class="attr">total</span>: <span class="built_in">number</span>; <span class="attr">page</span>: <span class="built_in">number</span>; <span class="attr">pageSize</span>: <span class="built_in">number</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复杂逻辑上一行注释：拉取某页数据的纯函数，便于测试与复用</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchPage</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">page</span>: <span class="built_in">number</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">pageSize</span>: <span class="built_in">number</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">PageResp</span>&lt;<span class="title class_">Item</span>&gt;&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> http.<span class="property">call</span>&lt;<span class="title class_">PageResp</span>&lt;<span class="title class_">Item</span>&gt;&gt;(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&quot;/api/items&quot;</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">    <span class="attr">params</span>: &#123; page, pageSize &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">usePagedItems</span>(<span class="params">initialPageSize = <span class="number">20</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> page = <span class="title function_">ref</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">const</span> pageSize = <span class="title function_">ref</span>(initialPageSize);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> query = <span class="title function_">useQuery</span>(&#123;</span><br><span class="line">    <span class="comment">// 复杂逻辑上一行注释：将页码作为 queryKey 的一部分，命中不同页的缓存</span></span><br><span class="line">    <span class="attr">queryKey</span>: <span class="function">() =&gt;</span> [<span class="string">&quot;items&quot;</span>, page.<span class="property">value</span>, pageSize.<span class="property">value</span>],</span><br><span class="line">    <span class="comment">// 复杂逻辑上一行注释：当 page 或 pageSize 改变时，自动按新 key 请求/复用缓存</span></span><br><span class="line">    <span class="attr">queryFn</span>: <span class="function">() =&gt;</span> <span class="title function_">fetchPage</span>(page.<span class="property">value</span>, pageSize.<span class="property">value</span>),</span><br><span class="line">    <span class="attr">staleTime</span>: <span class="number">60_000</span>,</span><br><span class="line">    <span class="attr">keepPreviousData</span>: <span class="literal">true</span>, <span class="comment">// 复杂逻辑上一行注释：翻页时保留上一页数据，避免闪烁</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 复杂逻辑上一行注释：对外暴露翻页方法</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">next</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    page.<span class="property">value</span> += <span class="number">1</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">prev</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    page.<span class="property">value</span> = <span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">1</span>, page.<span class="property">value</span> - <span class="number">1</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">setPage</span> = (<span class="params"><span class="attr">p</span>: <span class="built_in">number</span></span>) =&gt; &#123;</span><br><span class="line">    page.<span class="property">value</span> = <span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">1</span>, p);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123; page, pageSize, ...query, next, prev, setPage &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-组件示例：PagedList-vue"><a href="#2-组件示例：PagedList-vue" class="headerlink" title="2) 组件示例：PagedList.vue"></a>2) 组件示例：<code>PagedList.vue</code></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- src/views/PagedList.vue --&gt;</span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; usePagedItems &#125; from &quot;@/features/demo/usePagedItems&quot;;</span><br><span class="line"></span><br><span class="line">const &#123; data, isFetching, error, page, next, prev &#125; = usePagedItems(10);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;p-4 space-y-3&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;flex items-center gap-2&quot;&gt;</span><br><span class="line">      &lt;button class=&quot;border px-3 py-1 rounded&quot; @click=&quot;prev&quot;&gt;上一页&lt;/button&gt;</span><br><span class="line">      &lt;span&gt;第 &#123;&#123; page &#125;&#125; 页&lt;/span&gt;</span><br><span class="line">      &lt;button class=&quot;border px-3 py-1 rounded&quot; @click=&quot;next&quot;&gt;下一页&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div v-if=&quot;isFetching&quot;&gt;加载中...&lt;/div&gt;</span><br><span class="line">    &lt;div v-else-if=&quot;error&quot; class=&quot;text-red-600&quot;&gt;</span><br><span class="line">      出错：&#123;&#123; (error as any)?.message &#125;&#125;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;ul v-else class=&quot;list-disc pl-5&quot;&gt;</span><br><span class="line">      &lt;li v-for=&quot;it in data?.list ?? []&quot; :key=&quot;it.id&quot;&gt;&#123;&#123; it.title &#125;&#125;&lt;/li&gt;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="二、无限滚动（cursor-nextCursor）"><a href="#二、无限滚动（cursor-nextCursor）" class="headerlink" title="二、无限滚动（cursor&#x2F;nextCursor）"></a>二、无限滚动（cursor&#x2F;nextCursor）</h2><h3 id="1-组合式函数：useInfiniteItems-ts"><a href="#1-组合式函数：useInfiniteItems-ts" class="headerlink" title="1) 组合式函数：useInfiniteItems.ts"></a>1) 组合式函数：<code>useInfiniteItems.ts</code></h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/features/demo/useInfiniteItems.ts</span></span><br><span class="line"><span class="string">&quot;use client&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; computed &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useInfiniteQuery &#125; <span class="keyword">from</span> <span class="string">&quot;@tanstack/vue-query&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; http &#125; <span class="keyword">from</span> <span class="string">&quot;@/lib/http&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Item</span> = &#123; <span class="attr">id</span>: <span class="built_in">string</span>; <span class="attr">title</span>: <span class="built_in">string</span> &#125;;</span><br><span class="line"><span class="comment">// 复杂逻辑上一行注释：后端返回游标结构（items + nextCursor），没有更多时 nextCursor 为空/undefined</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">CursorResp</span>&lt;T&gt; = &#123; <span class="attr">items</span>: T[]; <span class="attr">nextCursor</span>?: <span class="built_in">string</span> | <span class="literal">null</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchByCursor</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">cursor</span>: <span class="built_in">string</span> | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">limit</span>: <span class="built_in">number</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">CursorResp</span>&lt;<span class="title class_">Item</span>&gt;&gt; &#123;</span><br><span class="line">  <span class="comment">// 复杂逻辑上一行注释：第一页用 null/空串，后续带上 nextCursor</span></span><br><span class="line">  <span class="keyword">return</span> http.<span class="property">call</span>&lt;<span class="title class_">CursorResp</span>&lt;<span class="title class_">Item</span>&gt;&gt;(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">&quot;/api/items/cursor&quot;</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">    <span class="attr">params</span>: &#123; cursor, limit &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">useInfiniteItems</span>(<span class="params">limit = <span class="number">20</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> q = <span class="title function_">useInfiniteQuery</span>(&#123;</span><br><span class="line">    <span class="attr">queryKey</span>: [<span class="string">&quot;items-infinite&quot;</span>, limit],</span><br><span class="line">    <span class="comment">// 复杂逻辑上一行注释：pageParam 是上一次 getNextPageParam 返回的值；第一页由 initialPageParam 提供</span></span><br><span class="line">    <span class="attr">queryFn</span>: <span class="function">(<span class="params">&#123; pageParam &#125;</span>) =&gt;</span> <span class="title function_">fetchByCursor</span>(pageParam ?? <span class="literal">null</span>, limit),</span><br><span class="line">    <span class="attr">initialPageParam</span>: <span class="literal">null</span> <span class="keyword">as</span> <span class="built_in">string</span> | <span class="literal">null</span>,</span><br><span class="line">    <span class="comment">// 复杂逻辑上一行注释：从返回值中取下一页的游标；无则表示到底</span></span><br><span class="line">    <span class="attr">getNextPageParam</span>: <span class="function">(<span class="params">lastPage</span>) =&gt;</span> lastPage.<span class="property">nextCursor</span> ?? <span class="literal">undefined</span>,</span><br><span class="line">    <span class="attr">staleTime</span>: <span class="number">60_000</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 复杂逻辑上一行注释：将多页的 items 扁平合并，便于组件直接渲染</span></span><br><span class="line">  <span class="keyword">const</span> flatItems = <span class="title function_">computed</span>(</span><br><span class="line">    <span class="function">() =&gt;</span> q.<span class="property">data</span>.<span class="property">value</span>?.<span class="property">pages</span>.<span class="title function_">flatMap</span>(<span class="function">(<span class="params">p</span>) =&gt;</span> p.<span class="property">items</span>) ?? []</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123; ...q, flatItems &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-组件示例（IntersectionObserver-自动触底加载）：InfiniteList-vue"><a href="#2-组件示例（IntersectionObserver-自动触底加载）：InfiniteList-vue" class="headerlink" title="2) 组件示例（IntersectionObserver 自动触底加载）：InfiniteList.vue"></a>2) 组件示例（IntersectionObserver 自动触底加载）：<code>InfiniteList.vue</code></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- src/views/InfiniteList.vue --&gt;</span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref, onMounted, onBeforeUnmount &#125; from &quot;vue&quot;;</span><br><span class="line">import &#123; useInfiniteItems &#125; from &quot;@/features/demo/useInfiniteItems&quot;;</span><br><span class="line"></span><br><span class="line">const &#123; flatItems, isFetchingNextPage, hasNextPage, fetchNextPage, error &#125; =</span><br><span class="line">  useInfiniteItems(15);</span><br><span class="line"></span><br><span class="line">const sentinel = ref&lt;HTMLDivElement | null&gt;(null);</span><br><span class="line">let observer: IntersectionObserver | null = null;</span><br><span class="line"></span><br><span class="line">onMounted(() =&gt; &#123;</span><br><span class="line">  // 复杂逻辑上一行注释：使用 IntersectionObserver 观察“页尾哨兵”，进入视口即加载下一页</span><br><span class="line">  observer = new IntersectionObserver(</span><br><span class="line">    (entries) =&gt; &#123;</span><br><span class="line">      const e = entries[0];</span><br><span class="line">      if (e.isIntersecting &amp;&amp; hasNextPage.value &amp;&amp; !isFetchingNextPage.value) &#123;</span><br><span class="line">        fetchNextPage();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; root: null, rootMargin: &quot;0px&quot;, threshold: 0.1 &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  if (sentinel.value) observer.observe(sentinel.value);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">onBeforeUnmount(() =&gt; &#123;</span><br><span class="line">  if (observer &amp;&amp; sentinel.value) observer.unobserve(sentinel.value);</span><br><span class="line">  observer = null;</span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;p-4 space-y-3&quot;&gt;</span><br><span class="line">    &lt;div v-if=&quot;error&quot; class=&quot;text-red-600&quot;&gt;</span><br><span class="line">      出错：&#123;&#123; (error as any)?.message &#125;&#125;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;ul class=&quot;space-y-2&quot;&gt;</span><br><span class="line">      &lt;li v-for=&quot;it in flatItems&quot; :key=&quot;it.id&quot; class=&quot;border rounded p-2&quot;&gt;</span><br><span class="line">        &#123;&#123; it.title &#125;&#125;</span><br><span class="line">      &lt;/li&gt;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 复杂逻辑上一行注释：页尾“哨兵”元素，用于触发下一页加载 --&gt;</span><br><span class="line">    &lt;div</span><br><span class="line">      ref=&quot;sentinel&quot;</span><br><span class="line">      class=&quot;h-8 flex items-center justify-center text-gray-500&quot;</span><br><span class="line">    &gt;</span><br><span class="line">      &lt;span v-if=&quot;isFetchingNextPage&quot;&gt;加载更多...&lt;/span&gt;</span><br><span class="line">      &lt;span v-else-if=&quot;!hasNextPage&quot;&gt;没有更多了&lt;/span&gt;</span><br><span class="line">      &lt;span v-else&gt;下拉加载&lt;/span&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 兜底：手动加载更多按钮（可选） --&gt;</span><br><span class="line">    &lt;div class=&quot;text-center&quot;&gt;</span><br><span class="line">      &lt;button</span><br><span class="line">        class=&quot;mt-2 border px-3 py-1 rounded&quot;</span><br><span class="line">        :disabled=&quot;!hasNextPage || isFetchingNextPage&quot;</span><br><span class="line">        @click=&quot;fetchNextPage()&quot;</span><br><span class="line">      &gt;</span><br><span class="line">        &#123;&#123;</span><br><span class="line">          isFetchingNextPage</span><br><span class="line">            ? &quot;加载中…&quot;</span><br><span class="line">            : hasNextPage</span><br><span class="line">            ? &quot;加载更多&quot;</span><br><span class="line">            : &quot;没有更多了&quot;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      &lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="关键点与小贴士"><a href="#关键点与小贴士" class="headerlink" title="关键点与小贴士"></a>关键点与小贴士</h2><ul>
<li><strong>keepPreviousData</strong>：页码分页时避免闪屏；无限滚动用 <code>useInfiniteQuery</code> 不需要它。</li>
<li><strong>queryKey 设计</strong>：把影响结果的入参（如 <code>page/pageSize</code>、<code>limit/filters</code>）放进 key，缓存才可命中。</li>
<li><strong>getNextPageParam</strong>：返回 <code>undefined</code> 代表“没有下一页”；返回游标字符串（或对象）将作为下一次 <code>pageParam</code> 传入。</li>
<li><strong>触底加载</strong>：<code>IntersectionObserver</code> 比 <code>scroll</code> 事件更稳、成本更低；确保有合理的 <code>rootMargin/threshold</code>。</li>
<li><strong>错误重试</strong>：默认会自动重试 2 次（取决于你的全局设置）。对幂等读接口通常是安全的。</li>
</ul>
<p>需要我把这两个 Demo 接到你现有的某个真实接口（比如你“价格趋势”或“攻略列表”）上，我可以直接给<strong>最小改动的代码片段</strong>。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/06/Vue-3-%E6%9C%80%E5%B0%8F%E5%8F%AF%E7%94%A8%E7%A4%BA%E4%BE%8B%EF%BC%9A%E5%88%86%E9%A1%B5-%E6%97%A0%E9%99%90%E6%BB%9A%E5%8A%A8%EF%BC%88-tanstack-vue-query%EF%BC%89/" data-id="cmf9bdhk80005qq4z7v1egktw" data-title="Vue 3 最小可用示例：分页 &amp; 无限滚动（@tanstack/vue-query）" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-最小可用的-TanStack-Query-集成（Next-js-14-·-App-Router-·-TS）" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/06/%E6%9C%80%E5%B0%8F%E5%8F%AF%E7%94%A8%E7%9A%84-TanStack-Query-%E9%9B%86%E6%88%90%EF%BC%88Next-js-14-%C2%B7-App-Router-%C2%B7-TS%EF%BC%89/" class="article-date">
  <time class="dt-published" datetime="2025-09-06T14:41:39.000Z" itemprop="datePublished">2025-09-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/06/%E6%9C%80%E5%B0%8F%E5%8F%AF%E7%94%A8%E7%9A%84-TanStack-Query-%E9%9B%86%E6%88%90%EF%BC%88Next-js-14-%C2%B7-App-Router-%C2%B7-TS%EF%BC%89/">最小可用的 TanStack Query 集成（Next.js 14 · App Router · TS）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <hr>
<p>title: 最小可用的 TanStack Query 集成（Next.js 14 · App Router · TS）<br>date: 2025-09-06<br>tags:</p>
<ul>
<li>TanStack Query</li>
<li>React Query</li>
<li>Next.js 14</li>
<li>TypeScript</li>
</ul>
<hr>
<h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p>在<strong>不改动你现有 http 封装</strong>（<code>http.call</code> + <code>api/modules/price.ts</code>）前提下，最小成本接入 TanStack Query，用于价格趋势这类“读多写少”的数据获取与缓存。</p>
<hr>
<h2 id="步骤总览"><a href="#步骤总览" class="headerlink" title="步骤总览"></a>步骤总览</h2><ol>
<li>安装依赖</li>
<li>新增 <code>QueryProvider</code> 并在 <code>app/layout.tsx</code> 注入</li>
<li>写一个最小的 <code>usePriceTrend</code> 查询 Hook</li>
<li>在一个客户端组件里调用展示</li>
</ol>
<blockquote>
<p>说明：只给<strong>新增&#x2F;变更</strong>的文件内容；复杂逻辑在上一行加注释。</p>
</blockquote>
<hr>
<h2 id="1-安装"><a href="#1-安装" class="headerlink" title="1) 安装"></a>1) 安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pnpm add @tanstack/react-query</span><br><span class="line"><span class="comment"># 可选：开发工具</span></span><br><span class="line">pnpm add -D @tanstack/react-query-devtools</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-Provider：在全局注入-QueryClient"><a href="#2-Provider：在全局注入-QueryClient" class="headerlink" title="2) Provider：在全局注入 QueryClient"></a>2) Provider：在全局注入 QueryClient</h2><p><strong>新增：<code>src/lib/query/QueryProvider.tsx</code></strong></p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;use client&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PropsWithChildren</span>, useState &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">QueryClient</span>, <span class="title class_">QueryClientProvider</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@tanstack/react-query&quot;</span>;</span><br><span class="line"><span class="comment">// 可选：开发时打开</span></span><br><span class="line"><span class="comment">// import &#123; ReactQueryDevtools &#125; from &#x27;@tanstack/react-query-devtools&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">QueryProvider</span>(<span class="params">&#123; children &#125;: <span class="title class_">PropsWithChildren</span></span>) &#123;</span><br><span class="line">  <span class="comment">// 复杂逻辑上一行注释：用 useState 确保在客户端持久化一个 QueryClient 单例</span></span><br><span class="line">  <span class="keyword">const</span> [client] = <span class="title function_">useState</span>(</span><br><span class="line">    <span class="function">() =&gt;</span></span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">QueryClient</span>(&#123;</span><br><span class="line">        <span class="attr">defaultOptions</span>: &#123;</span><br><span class="line">          <span class="attr">queries</span>: &#123;</span><br><span class="line">            <span class="comment">// 复杂逻辑上一行注释：避免频繁重复请求，数据 5 分钟内视为新鲜</span></span><br><span class="line">            <span class="attr">staleTime</span>: <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000</span>,</span><br><span class="line">            <span class="comment">// 复杂逻辑上一行注释：失败最多重试 2 次，指数退避</span></span><br><span class="line">            <span class="attr">retry</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">refetchOnWindowFocus</span>: <span class="literal">false</span>,</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">QueryClientProvider</span> <span class="attr">client</span>=<span class="string">&#123;client&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;children&#125;</span></span><br><span class="line"><span class="language-xml">      &#123;/* <span class="tag">&lt;<span class="name">ReactQueryDevtools</span> <span class="attr">initialIsOpen</span>=<span class="string">&#123;false&#125;</span> /&gt;</span> */&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">QueryClientProvider</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>修改：<code>src/app/layout.tsx</code>（只贴需要插入的代码）</strong></p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ➊ 新增这一行</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">QueryProvider</span> <span class="keyword">from</span> <span class="string">&quot;@/lib/query/QueryProvider&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... 省略你的现有代码</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">RootLayout</span>(<span class="params">&#123;</span></span><br><span class="line"><span class="params">  children,</span></span><br><span class="line"><span class="params">&#125;: &#123;</span></span><br><span class="line"><span class="params">  children: React.ReactNode;</span></span><br><span class="line"><span class="params">&#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh-CN&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;/* ➋ 用 Provider 包裹全局 */&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">QueryProvider</span>&gt;</span>&#123;children&#125;<span class="tag">&lt;/<span class="name">QueryProvider</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-查询-Hook：封装价格趋势获取"><a href="#3-查询-Hook：封装价格趋势获取" class="headerlink" title="3) 查询 Hook：封装价格趋势获取"></a>3) 查询 Hook：封装价格趋势获取</h2><p><strong>新增：<code>src/features/price-trend/queries.ts</code></strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;use client&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; useQuery &#125; <span class="keyword">from</span> <span class="string">&quot;@tanstack/react-query&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; priceApi &#125; <span class="keyword">from</span> <span class="string">&quot;@/api/modules/price&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复杂逻辑上一行注释：以业务语义定义查询 Hook，统一 queryKey 与调用的 API 函数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">usePriceTrend</span>(<span class="params"><span class="attr">gameId</span>: <span class="built_in">string</span>, <span class="attr">stores</span>: <span class="built_in">string</span>[]</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">useQuery</span>(&#123;</span><br><span class="line">    <span class="comment">// 复杂逻辑上一行注释：queryKey 决定缓存命中；包含关键入参</span></span><br><span class="line">    <span class="attr">queryKey</span>: [<span class="string">&quot;priceTrend&quot;</span>, gameId, stores],</span><br><span class="line">    <span class="comment">// 复杂逻辑上一行注释：交给领域 API，返回 Promise&lt;any&gt;</span></span><br><span class="line">    <span class="attr">queryFn</span>: <span class="function">() =&gt;</span> priceApi.<span class="title function_">getTrend</span>(&#123; gameId, stores &#125;),</span><br><span class="line">    <span class="comment">// 复杂逻辑上一行注释：没有必要参数时不发起请求</span></span><br><span class="line">    <span class="attr">enabled</span>: <span class="title class_">Boolean</span>(gameId) &amp;&amp; stores.<span class="property">length</span> &gt; <span class="number">0</span>,</span><br><span class="line">    <span class="comment">// 可选：覆盖全局默认值</span></span><br><span class="line">    <span class="attr">staleTime</span>: <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000</span>,</span><br><span class="line">    <span class="attr">gcTime</span>: <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>你之前已经有 <code>priceApi.getTrend</code>，这里直接复用即可。</p>
</blockquote>
<hr>
<h2 id="4-页面示例：客户端组件中使用"><a href="#4-页面示例：客户端组件中使用" class="headerlink" title="4) 页面示例：客户端组件中使用"></a>4) 页面示例：客户端组件中使用</h2><p><strong>新增：<code>src/app/price-trend-demo/page.tsx</code>（最小可跑 Demo 页）</strong></p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;use client&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; useState &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; usePriceTrend &#125; <span class="keyword">from</span> <span class="string">&quot;@/features/price-trend/queries&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">PriceTrendDemoPage</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [gameId, setGameId] = <span class="title function_">useState</span>(<span class="string">&quot;wukong&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> [stores, setStores] = useState&lt;<span class="built_in">string</span>[]&gt;([<span class="string">&quot;Steam&quot;</span>, <span class="string">&quot;Epic&quot;</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; data, isLoading, error, refetch &#125; = <span class="title function_">usePriceTrend</span>(gameId, stores);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;p-4 space-y-3&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;flex gap-2 items-center&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">value</span>=<span class="string">&#123;gameId&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onChange</span>=<span class="string">&#123;(e)</span> =&gt;</span> setGameId(e.target.value)&#125;</span></span><br><span class="line"><span class="language-xml">          placeholder=&quot;gameId&quot;</span></span><br><span class="line"><span class="language-xml">          className=&quot;border px-2 py-1 rounded&quot;</span></span><br><span class="line"><span class="language-xml">        /&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          // <span class="attr">复杂逻辑上一行注释</span>：<span class="attr">演示手动刷新</span>（<span class="attr">一般可不需要</span>，<span class="attr">TanStack</span> <span class="attr">会按策略自动刷新</span>）</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> refetch()&#125;</span></span><br><span class="line"><span class="language-xml">          className=&quot;px-3 py-1 rounded border&quot;</span></span><br><span class="line"><span class="language-xml">        &gt;</span></span><br><span class="line"><span class="language-xml">          Refresh</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      &#123;isLoading &amp;&amp; <span class="tag">&lt;<span class="name">div</span>&gt;</span>加载中...<span class="tag">&lt;/<span class="name">div</span>&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">      &#123;error &amp;&amp; (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;text-red-600&quot;</span>&gt;</span>出错了：&#123;(error as any)?.message&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      )&#125;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">pre</span> <span class="attr">className</span>=<span class="string">&quot;bg-gray-100 p-3 rounded text-sm overflow-auto&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;JSON.stringify(data, null, 2)&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>想接上图表时，把 <code>data</code> 交给你的图表组件即可；后续可以把 <code>stores</code> 做成可搜索多选，与你主页筛选一致。</p>
</blockquote>
<hr>
<h2 id="可选：SSR-预取（以后再加）"><a href="#可选：SSR-预取（以后再加）" class="headerlink" title="可选：SSR 预取（以后再加）"></a>可选：SSR 预取（以后再加）</h2><p>最小集成里我们<strong>不做 SSR</strong>，直接用客户端渲染即可；若将来需要 SSR&#x2F;Hydration，可用 <code>@tanstack/react-query</code> 的 <code>dehydrate/hydrate</code> 在 Server Component 里预取数据、在 Client 端复水。等你需要时我再给“最小 SSR 版本”的差异补丁即可。</p>
<p>下面给你<strong>Vue 3 最小可用示例</strong>（基于 <code>@tanstack/vue-query</code>，不改你的 http 封装与 <code>priceApi</code>）。只包含<strong>必要的新文件&#x2F;改动</strong>；复杂逻辑已在上一行加注释。</p>
<hr>
<h3 id="1-安装-1"><a href="#1-安装-1" class="headerlink" title="1) 安装"></a>1) 安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pnpm add @tanstack/vue-query</span><br><span class="line"><span class="comment"># 可选：开发工具</span></span><br><span class="line">pnpm add -D @tanstack/vue-query-devtools</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="2-全局注册-Vue-Query-插件"><a href="#2-全局注册-Vue-Query-插件" class="headerlink" title="2) 全局注册 Vue Query 插件"></a>2) 全局注册 Vue Query 插件</h3><p><strong>新增：<code>src/plugins/vue-query.ts</code></strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑上一行注释：创建全局 QueryClient，设定默认缓存/重试策略</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">QueryClient</span>,</span><br><span class="line">  <span class="title class_">VueQueryPlugin</span>,</span><br><span class="line">  <span class="keyword">type</span> <span class="title class_">VueQueryPluginOptions</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;@tanstack/vue-query&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> queryClient = <span class="keyword">new</span> <span class="title class_">QueryClient</span>(&#123;</span><br><span class="line">  <span class="attr">defaultOptions</span>: &#123;</span><br><span class="line">    <span class="attr">queries</span>: &#123;</span><br><span class="line">      <span class="comment">// 复杂逻辑上一行注释：5 分钟内视为新鲜，避免频繁请求</span></span><br><span class="line">      <span class="attr">staleTime</span>: <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000</span>,</span><br><span class="line">      <span class="comment">// 复杂逻辑上一行注释：失败自动重试 2 次，指数退避</span></span><br><span class="line">      <span class="attr">retry</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="comment">// 聚焦窗口时不强制刷新（按需可改为 true）</span></span><br><span class="line">      <span class="attr">refetchOnWindowFocus</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">installVueQuery</span>(<span class="params"><span class="attr">app</span>: <span class="keyword">import</span>(<span class="string">&quot;vue&quot;</span>).<span class="title class_">App</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">options</span>: <span class="title class_">VueQueryPluginOptions</span> = &#123; queryClient &#125;;</span><br><span class="line">  app.<span class="title function_">use</span>(<span class="title class_">VueQueryPlugin</span>, options);</span><br><span class="line">  <span class="comment">// 可选：开发工具</span></span><br><span class="line">  <span class="comment">// if (import.meta.env.DEV) &#123;</span></span><br><span class="line">  <span class="comment">//   const &#123; VueQueryDevtools &#125; = await import(&#x27;@tanstack/vue-query-devtools&#x27;)</span></span><br><span class="line">  <span class="comment">//   app.use(VueQueryDevtools, &#123; initialIsOpen: false &#125;)</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>修改：<code>src/main.ts</code>（只贴需要新增的行）</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&quot;./App.vue&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// + 新增：注册 Vue Query 插件</span></span><br><span class="line"><span class="keyword">import</span> &#123; installVueQuery &#125; <span class="keyword">from</span> <span class="string">&quot;@/plugins/vue-query&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(<span class="title class_">App</span>);</span><br><span class="line"><span class="title function_">installVueQuery</span>(app);</span><br><span class="line">app.<span class="title function_">mount</span>(<span class="string">&quot;#app&quot;</span>);</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3-查询-Hook（Composable）"><a href="#3-查询-Hook（Composable）" class="headerlink" title="3) 查询 Hook（Composable）"></a>3) 查询 Hook（Composable）</h3><p><strong>新增：<code>src/features/price-trend/usePriceTrend.ts</code></strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑上一行注释：以业务语义封装 useQuery，统一 queryKey 与调用的 API</span></span><br><span class="line"><span class="keyword">import</span> &#123; useQuery &#125; <span class="keyword">from</span> <span class="string">&quot;@tanstack/vue-query&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; priceApi &#125; <span class="keyword">from</span> <span class="string">&quot;@/api/modules/price&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">usePriceTrend</span>(<span class="params"><span class="attr">gameId</span>: <span class="built_in">string</span>, <span class="attr">stores</span>: <span class="built_in">string</span>[]</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">useQuery</span>(&#123;</span><br><span class="line">    <span class="comment">// 复杂逻辑上一行注释：queryKey 决定缓存命中；包含关键入参</span></span><br><span class="line">    <span class="attr">queryKey</span>: [<span class="string">&quot;priceTrend&quot;</span>, gameId, stores],</span><br><span class="line">    <span class="comment">// 复杂逻辑上一行注释：交给领域 API，返回 Promise</span></span><br><span class="line">    <span class="attr">queryFn</span>: <span class="function">() =&gt;</span> priceApi.<span class="title function_">getTrend</span>(&#123; gameId, stores &#125;),</span><br><span class="line">    <span class="comment">// 复杂逻辑上一行注释：参数不全时不发起请求</span></span><br><span class="line">    <span class="attr">enabled</span>: <span class="title class_">Boolean</span>(gameId) &amp;&amp; stores.<span class="property">length</span> &gt; <span class="number">0</span>,</span><br><span class="line">    <span class="comment">// 可选：覆盖默认策略</span></span><br><span class="line">    <span class="attr">staleTime</span>: <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000</span>,</span><br><span class="line">    <span class="attr">gcTime</span>: <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里直接复用你已有的 <code>priceApi.getTrend</code>（基于 <code>http.call</code>）。</p>
</blockquote>
<hr>
<h3 id="4-最小页面示例（组件中使用）"><a href="#4-最小页面示例（组件中使用）" class="headerlink" title="4) 最小页面示例（组件中使用）"></a>4) 最小页面示例（组件中使用）</h3><p><strong>新增：<code>src/views/PriceTrendDemo.vue</code></strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref &#125; from &quot;vue&quot;;</span><br><span class="line">import &#123; usePriceTrend &#125; from &quot;@/features/price-trend/usePriceTrend&quot;;</span><br><span class="line"></span><br><span class="line">const gameId = ref(&quot;wukong&quot;);</span><br><span class="line">const stores = ref&lt;string[]&gt;([&quot;Steam&quot;, &quot;Epic&quot;]);</span><br><span class="line"></span><br><span class="line">const &#123; data, isLoading, error, refetch &#125; = usePriceTrend(</span><br><span class="line">  gameId.value,</span><br><span class="line">  stores.value</span><br><span class="line">);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;p-4 space-y-3&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;flex gap-2 items-center&quot;&gt;</span><br><span class="line">      &lt;input</span><br><span class="line">        v-model=&quot;gameId&quot;</span><br><span class="line">        placeholder=&quot;gameId&quot;</span><br><span class="line">        class=&quot;border px-2 py-1 rounded&quot;</span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;button class=&quot;px-3 py-1 rounded border&quot; @click=&quot;refetch()&quot;&gt;</span><br><span class="line">        Refresh</span><br><span class="line">      &lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;div v-if=&quot;isLoading&quot;&gt;加载中...&lt;/div&gt;</span><br><span class="line">    &lt;div v-else-if=&quot;error&quot; class=&quot;text-red-600&quot;&gt;</span><br><span class="line">      出错了：&#123;&#123; (error as any)?.message &#125;&#125;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;pre class=&quot;bg-gray-100 p-3 rounded text-sm overflow-auto&quot;</span><br><span class="line">      &gt;&#123;&#123; JSON.stringify(data ?? null, null, 2) &#125;&#125;</span><br><span class="line">    &lt;/pre&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>路由按你的项目来：例如在 <code>vue-router</code> 里把该组件挂到 <code>/price-trend-demo</code>。</p>
</blockquote>
<hr>
<h4 id="可选：当-gameId-stores-在页面中会变更时"><a href="#可选：当-gameId-stores-在页面中会变更时" class="headerlink" title="可选：当 gameId/stores 在页面中会变更时"></a>可选：当 <code>gameId/stores</code> 在页面中会变更时</h4><p>把 <code>usePriceTrend(gameId.value, stores.value)</code> 改成<strong>侦听式</strong>：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; data, isLoading, error, refetch &#125; = <span class="title function_">usePriceTrend</span>(</span><br><span class="line">  <span class="comment">// 复杂逻辑上一行注释：传入原始值即可；依赖变化时 useQuery 会按 key 缓存/重取</span></span><br><span class="line">  gameId.<span class="property">value</span>,</span><br><span class="line">  stores.<span class="property">value</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>若你希望<strong>自动</strong>随着 <code>gameId/stores</code> 的变更而刷新，可在外层 <code>watch([gameId, stores], refetch)</code>；不过通常让 <code>queryKey</code> 变化即可自动生效（会根据 key 命中缓存或重新请求）。</p>
<hr>
<h3 id="5-与你现有封装的关系"><a href="#5-与你现有封装的关系" class="headerlink" title="5) 与你现有封装的关系"></a>5) 与你现有封装的关系</h3><ul>
<li><strong>无需修改</strong> <code>http.call</code> &#x2F; <code>client.ts</code> &#x2F; <code>cancel.ts</code>；Vue Query 只是把“请求何时发起、如何缓存&#x2F;重试&#x2F;并发合并”的<strong>状态机</strong>托管出去。</li>
<li>其他简单页面仍可直接用 <code>http.get/post</code> 或 <code>http.call</code>。把 <strong>“读多写少、复用度高”的接口</strong>（比如价格趋势、列表）逐步迁到 Vue Query 即可，<strong>按需引入</strong>、零破坏。</li>
</ul>
<p>如果你需要 <strong>SSR（Nuxt 3）</strong> 的最小示例或 <strong>分页&#x2F;无限滚动</strong> 的 Query 示例，我也可以在此基础上给出只含必要代码的增量补丁。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/06/%E6%9C%80%E5%B0%8F%E5%8F%AF%E7%94%A8%E7%9A%84-TanStack-Query-%E9%9B%86%E6%88%90%EF%BC%88Next-js-14-%C2%B7-App-Router-%C2%B7-TS%EF%BC%89/" data-id="cmf9bdhkr0012qq4z3nz46t6k" data-title="最小可用的 TanStack Query 集成（Next.js 14 · App Router · TS）" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-「请求层大重构」——从散乱到企业级：类型、目录与演进路线" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/06/%E3%80%8C%E8%AF%B7%E6%B1%82%E5%B1%82%E5%A4%A7%E9%87%8D%E6%9E%84%E3%80%8D%E2%80%94%E2%80%94%E4%BB%8E%E6%95%A3%E4%B9%B1%E5%88%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%EF%BC%9A%E7%B1%BB%E5%9E%8B%E3%80%81%E7%9B%AE%E5%BD%95%E4%B8%8E%E6%BC%94%E8%BF%9B%E8%B7%AF%E7%BA%BF/" class="article-date">
  <time class="dt-published" datetime="2025-09-06T11:58:07.000Z" itemprop="datePublished">2025-09-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/06/%E3%80%8C%E8%AF%B7%E6%B1%82%E5%B1%82%E5%A4%A7%E9%87%8D%E6%9E%84%E3%80%8D%E2%80%94%E2%80%94%E4%BB%8E%E6%95%A3%E4%B9%B1%E5%88%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%EF%BC%9A%E7%B1%BB%E5%9E%8B%E3%80%81%E7%9B%AE%E5%BD%95%E4%B8%8E%E6%BC%94%E8%BF%9B%E8%B7%AF%E7%BA%BF/">「请求层大重构」——从散乱到企业级：类型、目录与演进路线</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="目标与判断"><a href="#目标与判断" class="headerlink" title="目标与判断"></a>目标与判断</h2><p>你的现状：页面里混着 <code>api.d.ts / axios.d.ts / common.ts</code> 等类型与封装，随着“对象入参 + 零破坏兼容”推进，类型边界和目录粘在一起，开始“乱”。</p>
<p><strong>结论（大厂常用做法）</strong>：保持 <code>axios</code> 原语义不覆写，新增对象式入口（如 <code>http.call</code>）；<strong>类型集中管理</strong>、<strong>代码生成</strong> 与 <strong>运行时校验</strong> 组合；请求层<strong>分三层</strong>（core&#x2F;http、api&#x2F;generated、api&#x2F;modules），再用<strong>查询层</strong>（TanStack Query&#x2F;Vue Query）管理缓存与重试；本地与集成测试统一用 <strong>MSW</strong> 拦截网络层。这些都是一线公司里稳定落地的模式。(<a target="_blank" rel="noopener" href="https://axios-http.com/docs/interceptors?utm_source=chatgpt.com" title="Interceptors | Axios Docs">axios-http.com</a>, <a target="_blank" rel="noopener" href="https://orval.dev/?utm_source=chatgpt.com" title="orval - Restful client generator">orval.dev</a>, <a target="_blank" rel="noopener" href="https://github.com/ferdikoomen/openapi-typescript-codegen/wiki?utm_source=chatgpt.com" title="Home · ferdikoomen&#x2F;openapi-typescript-codegen Wiki">GitHub</a>, <a target="_blank" rel="noopener" href="https://tanstack.com/query/docs?utm_source=chatgpt.com" title="TanStack Query">tanstack.com</a>, <a target="_blank" rel="noopener" href="https://mswjs.io/docs/?utm_source=chatgpt.com" title="Introduction - Mock Service Worker">mswjs.io</a>)</p>
<hr>
<h2 id="推荐目录（企业级分层）"><a href="#推荐目录（企业级分层）" class="headerlink" title="推荐目录（企业级分层）"></a>推荐目录（企业级分层）</h2><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">src/</span><br><span class="line">  lib/</span><br><span class="line">    http/                      # Core 请求层（只做“通用能力”）</span><br><span class="line">      client.ts                # axios 实例与拦截器（不覆写 axios.request）</span><br><span class="line">      call.ts                  # 新增对象式入口：http.call(options)</span><br><span class="line">      interceptors.ts          # 拦截器拆分：auth、retry、logging</span><br><span class="line">      cancel.ts                # 取消池/AbortController 管理</span><br><span class="line">      types.ts                 # RequestOptions、HttpError、CodeResponse 等</span><br><span class="line">      index.ts                 # 统一导出 http 实例与类型</span><br><span class="line">  api/</span><br><span class="line">    __generated__/             # OpenAPI 代码生成产物（只读）</span><br><span class="line">      client.ts</span><br><span class="line">      schemas.ts               # 可选：导出 Zod/类型</span><br><span class="line">      README.md</span><br><span class="line">    modules/                   # 领域 API（手写，薄封装）</span><br><span class="line">      user.ts</span><br><span class="line">      order.ts</span><br><span class="line">      price.ts</span><br><span class="line">  features/                    # 业务功能（视框架而定：React/Vue）</span><br><span class="line">    price-trend/</span><br><span class="line">      queries.ts               # TanStack Query/Vue Query 的 hooks</span><br><span class="line">      components/...</span><br><span class="line">  types/</span><br><span class="line">    http/                      # 类型声明集中地（仅 .d.ts）</span><br><span class="line">      axios.d.ts               # module augmentation：扩展 AxiosInstance（如 .call）</span><br><span class="line">      api.d.ts                 # 全局响应范式、工具类型</span><br><span class="line">    common.ts                  # 与请求无关的通用类型</span><br><span class="line">tests/</span><br><span class="line">  msw/</span><br><span class="line">    server.ts                  # MSW 服务端/浏览器初始化</span><br><span class="line">    handlers/                  # 接口级别的 mock 处理器</span><br></pre></td></tr></table></figure>

<ul>
<li><code>lib/http</code> 只做“通用能力”（超时、重试、鉴权、取消、日志、错误规约），<strong>不写任何“业务 URL”</strong>；这能保证“可替换&#x2F;可迁移”。拦截器是 axios 官方推荐扩展点。(<a target="_blank" rel="noopener" href="https://axios-http.com/docs/interceptors?utm_source=chatgpt.com" title="Interceptors | Axios Docs">axios-http.com</a>)</li>
<li><code>api/__generated__</code> 用 OpenAPI&#x2F;Swagger <strong>生成</strong>强类型客户端，避免手写 drift；常见工具：<strong>orval</strong>、<strong>openapi-typescript-codegen</strong>、OpenAPI Generator。(<a target="_blank" rel="noopener" href="https://orval.dev/?utm_source=chatgpt.com" title="orval - Restful client generator">orval.dev</a>, <a target="_blank" rel="noopener" href="https://github.com/ferdikoomen/openapi-typescript-codegen/wiki?utm_source=chatgpt.com" title="Home · ferdikoomen&#x2F;openapi-typescript-codegen Wiki">GitHub</a>, <a target="_blank" rel="noopener" href="https://openapi-generator.tech/docs/generators/typescript/?utm_source=chatgpt.com" title="Documentation for the typescript Generator">openapi-generator.tech</a>)</li>
<li><code>api/modules</code> 是“轻薄门面层”：把生成代码或 <code>http.call</code> 包一层，落地<strong>统一的错误&#x2F;返回范式</strong>，方便埋点与切面。</li>
<li><code>features/*/queries.ts</code> 将请求函数交给 <strong>TanStack Query&#x2F;Vue Query</strong> 管理缓存、并发、重试、失效、SSR 等。(<a target="_blank" rel="noopener" href="https://tanstack.com/query/latest/docs?utm_source=chatgpt.com" title="Overview | TanStack Query React Docs">tanstack.com</a>)</li>
<li><code>tests/msw</code> 用 <strong>MSW</strong> 在浏览器&#x2F;Node 统一拦截 HTTP，保证本地&#x2F;CI 可重复。(<a target="_blank" rel="noopener" href="https://mswjs.io/docs/?utm_source=chatgpt.com" title="Introduction - Mock Service Worker">mswjs.io</a>)</li>
</ul>
<hr>
<h2 id="类型与声明管理：收口与增量"><a href="#类型与声明管理：收口与增量" class="headerlink" title="类型与声明管理：收口与增量"></a>类型与声明管理：收口与增量</h2><h3 id="1-d-ts-只放声明，不放实现"><a href="#1-d-ts-只放声明，不放实现" class="headerlink" title="1) .d.ts 只放声明，不放实现"></a>1) <code>.d.ts</code> <strong>只放声明，不放实现</strong></h3><ul>
<li><p>将你现有的 <code>api.d.ts / axios.d.ts</code> <strong>合并&#x2F;去重</strong>后放到 <code>src/types/http/</code> 下，职责清晰：</p>
<ul>
<li><code>axios.d.ts</code>：<strong>module augmentation</strong>（扩展 <code>AxiosInstance</code>，如新增 <code>call&lt;T&gt;()</code> 签名，不改原生 <code>get/post</code>）。TypeScript 官方建议通过声明合并做到“对第三方库的扩展”。(<a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/declaration-merging.html?utm_source=chatgpt.com" title="Documentation - Declaration Merging">typescriptlang.org</a>, <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/52637028/how-can-i-use-typescripts-declaration-merging-with-an-interface-imported-from-a?utm_source=chatgpt.com" title="How can I use Typescript&#39;s declaration merging with an ...">Stack Overflow</a>, <a target="_blank" rel="noopener" href="https://futurestud.io/tutorials/typescript-module-augmentation-overwrites-declarations-instead-of-merging-them?utm_source=chatgpt.com" title="TypeScript — Module Augmentation Overwrites Declarations ...">futurestud.io</a>)</li>
<li><code>api.d.ts</code>：与后端约定的响应外层、错误码、工具类型（如 <code>CodeResponse&lt;T&gt;</code>、<code>PageResp&lt;T&gt;</code>）。</li>
</ul>
</li>
<li><p><code>common.ts</code> 只保留<strong>与请求无关</strong>的通用类型&#x2F;常量，避免耦合。</p>
</li>
</ul>
<blockquote>
<p><strong>示例（module augmentation）</strong>：将 <code>.call</code> 加入 <code>AxiosInstance</code>（放 <code>src/types/http/axios.d.ts</code>）</p>
</blockquote>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在同名模块作用域内“声明合并”，不会改动运行时代码</span></span><br><span class="line"><span class="keyword">declare</span> <span class="variable language_">module</span> <span class="string">&quot;axios&quot;</span> &#123;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">AxiosInstance</span> &#123;</span><br><span class="line">    <span class="comment">// 简化：对象式入口</span></span><br><span class="line">    call&lt;T = <span class="built_in">any</span>, P = <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt;&gt;(<span class="attr">options</span>: &#123;</span><br><span class="line">      <span class="attr">url</span>: <span class="built_in">string</span>;</span><br><span class="line">      <span class="attr">method</span>?: <span class="keyword">import</span>(<span class="string">&quot;axios&quot;</span>).<span class="property">Method</span>;</span><br><span class="line">      <span class="attr">params</span>?: P;</span><br><span class="line">      <span class="attr">data</span>?: <span class="built_in">unknown</span>;</span><br><span class="line">      <span class="attr">requestConfig</span>?: <span class="keyword">import</span>(<span class="string">&quot;axios&quot;</span>).<span class="property">AxiosRequestConfig</span>;</span><br><span class="line">      <span class="attr">contentType</span>?: <span class="string">&quot;json&quot;</span> | <span class="string">&quot;urlencoded&quot;</span> | <span class="string">&quot;formdata&quot;</span>;</span><br><span class="line">    &#125;): <span class="title class_">Promise</span>&lt;T&gt;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-运行时校验（可选但推荐）"><a href="#2-运行时校验（可选但推荐）" class="headerlink" title="2) 运行时校验（可选但推荐）"></a>2) <strong>运行时校验（可选但推荐）</strong></h3><ul>
<li>对关键接口采用 <strong>Zod</strong>&#x2F;生成器产出的 schema，做“入站&#x2F;出站”校验，尽早暴露协议漂移。(<a target="_blank" rel="noopener" href="https://zod.dev/?utm_source=chatgpt.com" title="Zod: Intro">Zod</a>)</li>
<li>如果你用 <strong>Zodios</strong>，可直接以 Zod 定义端点 → 生成强类型 axios 客户端。(<a target="_blank" rel="noopener" href="https://www.zodios.org/?utm_source=chatgpt.com" title="Zodios | Zodios">zodios.org</a>, <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/%40zodios/axios?activeTab=readme&utm_source=chatgpt.com" title="zodios&#x2F;axios">npm</a>)</li>
</ul>
<hr>
<h2 id="代码生成：把“类型维护成本”降到最低"><a href="#代码生成：把“类型维护成本”降到最低" class="headerlink" title="代码生成：把“类型维护成本”降到最低"></a>代码生成：把“类型维护成本”降到最低</h2><ul>
<li><strong>orval</strong>：从 OpenAPI 生成 TS 客户端，内置 React&#x2F;Vue Query 集成、缓存与 MSW mock 模板，工程化最佳。(<a target="_blank" rel="noopener" href="https://orval.dev/?utm_source=chatgpt.com" title="orval - Restful client generator">orval.dev</a>, <a target="_blank" rel="noopener" href="https://github.com/orval-labs/orval?utm_source=chatgpt.com" title="orval-labs&#x2F;orval">GitHub</a>, <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/orval?utm_source=chatgpt.com" title="orval">npm</a>)</li>
<li><strong>openapi-typescript-codegen</strong>：轻量、纯客户端生成，适合你已有 Query 层。(<a target="_blank" rel="noopener" href="https://github.com/ferdikoomen/openapi-typescript-codegen?utm_source=chatgpt.com" title="ferdikoomen&#x2F;openapi-typescript-codegen">GitHub</a>)</li>
</ul>
<blockquote>
<p>建议：把生成产物放进 <code>src/api/__generated__</code>，并<strong>加入 lint&#x2F;tsc</strong>，但<strong>排除 format</strong>（防止误改）。CI 里加“变更即失败”的 diff 检查，确保版本与后端规范同步。</p>
</blockquote>
<hr>
<h2 id="Core-HTTP-的“硬规范”"><a href="#Core-HTTP-的“硬规范”" class="headerlink" title="Core HTTP 的“硬规范”"></a>Core HTTP 的“硬规范”</h2><ol>
<li><p><strong>不覆写</strong> <code>axios.request</code>，新增 <code>http.call(options)</code>，保持 <code>http.get/post/...</code> 零破坏兼容（你已走在正确路线上）。</p>
</li>
<li><p><strong>拦截器</strong>：鉴权（注入 <code>Authorization</code>）、401 统一处理、取消池、日志&#x2F;链路 ID、错误归一化。(<a target="_blank" rel="noopener" href="https://axios-http.com/docs/interceptors?utm_source=chatgpt.com" title="Interceptors | Axios Docs">axios-http.com</a>)</p>
</li>
<li><p><strong>FormData 正确处理</strong>：</p>
<ul>
<li><strong>不要手动设置</strong> <code>Content-Type: multipart/form-data</code>，让浏览器带 boundary；否则容易 4xx&#x2F;网络错误。(<a target="_blank" rel="noopener" href="https://axios-http.com/docs/multipart?utm_source=chatgpt.com" title="Multipart Bodies | Axios Docs">axios-http.com</a>, <a target="_blank" rel="noopener" href="https://github.com/axios/axios/issues/5067?utm_source=chatgpt.com" title="Content type changed from multipart&#x2F;form-data to ...">GitHub</a>)</li>
</ul>
</li>
<li><p><strong>错误范式</strong>：将 <code>AxiosError</code> → 统一 <code>HttpError</code>（含 <code>status</code>、<code>code</code>、<code>message</code>、<code>traceId</code>、<code>isNetworkError</code>）。</p>
</li>
<li><p><strong>请求命名与埋点</strong>：在 <code>requestConfig</code> 中允许 <code>opName</code>、<code>skipAuth</code>、<code>retry</code> 等自定义键，统一日志与灰度。</p>
</li>
</ol>
<hr>
<h2 id="查询层（React-Vue）：“把副作用交给专业工具”"><a href="#查询层（React-Vue）：“把副作用交给专业工具”" class="headerlink" title="查询层（React&#x2F;Vue）：“把副作用交给专业工具”"></a>查询层（React&#x2F;Vue）：“把副作用交给专业工具”</h2><ul>
<li>用 <strong>TanStack Query &#x2F; Vue Query</strong> 管理缓存、并发去重、后台刷新、窗口聚焦重刷、错误边界、SSR&#x2F;Hydration、离线等硬问题；你的 <code>http.call</code> &#x2F; 生成客户端只需提供 <strong>纯函数</strong> 即可。(<a target="_blank" rel="noopener" href="https://tanstack.com/query/v5/docs/react/guides/queries?utm_source=chatgpt.com" title="TanStack Query React Docs">tanstack.com</a>)</li>
<li>典型封装（以 React 为例）：</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// features/price-trend/queries.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; useQuery &#125; <span class="keyword">from</span> <span class="string">&quot;@tanstack/react-query&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; priceApi &#125; <span class="keyword">from</span> <span class="string">&quot;@/api/modules/price&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">useGamePriceTrend</span> = (<span class="params"><span class="attr">gameId</span>: <span class="built_in">string</span>, <span class="attr">stores</span>: <span class="built_in">string</span>[]</span>) =&gt;</span><br><span class="line">  <span class="title function_">useQuery</span>(&#123;</span><br><span class="line">    <span class="attr">queryKey</span>: [<span class="string">&quot;priceTrend&quot;</span>, gameId, stores],</span><br><span class="line">    <span class="comment">// 复杂逻辑上一行注释：调用领域 API，返回 Promise，交由 Query 管理缓存与失败重试</span></span><br><span class="line">    <span class="attr">queryFn</span>: <span class="function">() =&gt;</span> priceApi.<span class="title function_">getTrend</span>(&#123; gameId, stores &#125;),</span><br><span class="line">    <span class="attr">staleTime</span>: <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000</span>,</span><br><span class="line">    <span class="attr">gcTime</span>: <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>,</span><br><span class="line">    <span class="attr">retry</span>: <span class="number">2</span>,</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>TanStack 官方定位就是“声明式异步&#x2F;服务端状态管理”，在大厂广泛使用。(<a target="_blank" rel="noopener" href="https://tanstack.com/query/latest/docs?utm_source=chatgpt.com" title="Overview | TanStack Query React Docs">tanstack.com</a>)</p>
</blockquote>
<hr>
<h2 id="Mock-与测试：MSW-打通本地与-CI"><a href="#Mock-与测试：MSW-打通本地与-CI" class="headerlink" title="Mock 与测试：MSW 打通本地与 CI"></a>Mock 与测试：MSW 打通本地与 CI</h2><ul>
<li><strong>MSW</strong> 在浏览器&#x2F;Node 拦截真实网络层，mock 定义可复用到 Storybook&#x2F;E2E&#x2F;单元测试，减少“环境不可用”的波动。(<a target="_blank" rel="noopener" href="https://mswjs.io/docs/?utm_source=chatgpt.com" title="Introduction - Mock Service Worker">mswjs.io</a>)</li>
<li>放到 <code>tests/msw/handlers</code>，与 <code>api/modules</code> 一一对应；生成器也能产出 mock 模板（如 orval）。(<a target="_blank" rel="noopener" href="https://github.com/orval-labs/orval?utm_source=chatgpt.com" title="orval-labs&#x2F;orval">GitHub</a>)</li>
</ul>
<hr>
<h2 id="迁移策略（零停机）"><a href="#迁移策略（零停机）" class="headerlink" title="迁移策略（零停机）"></a>迁移策略（零停机）</h2><ol>
<li><strong>先落地 core&#x2F;http 与 <code>http.call</code></strong>（不动 <code>get/post</code>）。</li>
<li><strong>挑 1 ～ 2 个模块</strong>迁移到 <code>api/modules</code>（使用 <code>http.call</code> 或 <code>__generated__</code> 客户端），沉淀错误与重试策略。</li>
<li><strong>接入 TanStack&#x2F;Vue Query</strong> 的“易变接口”（价格趋势、榜单、列表）以验证缓存收益。</li>
<li>稳定后再逐步 <strong>把老的页面直连 http 的代码迁到 modules</strong>；期间保留 <code>api.d.ts</code> 的兼容类型，避免一次性爆炸式改动。</li>
<li>接入 <strong>MSW</strong> 保障端到端可测。</li>
</ol>
<hr>
<h2 id="你现有文件的落位建议"><a href="#你现有文件的落位建议" class="headerlink" title="你现有文件的落位建议"></a>你现有文件的落位建议</h2><ul>
<li><code>/mnt/data/api.d.ts</code> → <code>src/types/http/api.d.ts</code>（保留响应范式与工具类型，去掉与 axios 的交叉声明）</li>
<li><code>/mnt/data/axios.d.ts</code> → <code>src/types/http/axios.d.ts</code>（<strong>只做 module augmentation</strong>：为 <code>AxiosInstance</code> 增加 <code>.call</code> 的签名，不定义实现）</li>
<li><code>/mnt/data/common.ts</code> → <code>src/types/common.ts</code>（与请求无关的类型保留在此；若有请求相关的工具类型，迁到 <code>lib/http/types.ts</code>）</li>
</ul>
<hr>
<h2 id="最小代码约定（只列关键片段）"><a href="#最小代码约定（只列关键片段）" class="headerlink" title="最小代码约定（只列关键片段）"></a>最小代码约定（只列关键片段）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib/http/call.ts</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">AxiosRequestConfig</span>, <span class="title class_">Method</span> &#125; <span class="keyword">from</span> <span class="string">&quot;axios&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">&quot;./client&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; toFormData, toUrlencoded &#125; <span class="keyword">from</span> <span class="string">&quot;./utils&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">RequestContentType</span> = <span class="string">&quot;json&quot;</span> | <span class="string">&quot;urlencoded&quot;</span> | <span class="string">&quot;formdata&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">RequestOptions</span>&lt;P = <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt;&gt; &#123;</span><br><span class="line">  <span class="attr">url</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">method</span>?: <span class="title class_">Method</span>;</span><br><span class="line">  <span class="attr">params</span>?: P;</span><br><span class="line">  <span class="attr">data</span>?: <span class="built_in">unknown</span>;</span><br><span class="line">  <span class="attr">requestConfig</span>?: <span class="title class_">AxiosRequestConfig</span>;</span><br><span class="line">  <span class="attr">contentType</span>?: <span class="title class_">RequestContentType</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> call&lt;T, P = <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt;&gt;(</span><br><span class="line">  <span class="attr">opt</span>: <span class="title class_">RequestOptions</span>&lt;P&gt;</span><br><span class="line">): <span class="title class_">Promise</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    url,</span><br><span class="line">    method = <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">    params,</span><br><span class="line">    data,</span><br><span class="line">    requestConfig,</span><br><span class="line">    contentType = <span class="string">&quot;json&quot;</span>,</span><br><span class="line">  &#125; = opt;</span><br><span class="line">  <span class="keyword">if</span> (!url) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Missing url&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">cfg</span>: <span class="title class_">AxiosRequestConfig</span> = &#123; ...(requestConfig || &#123;&#125;), url, method &#125;;</span><br><span class="line">  <span class="keyword">if</span> (method === <span class="string">&quot;GET&quot;</span> || method === <span class="string">&quot;HEAD&quot;</span>) &#123;</span><br><span class="line">    cfg.<span class="property">params</span> = params ?? requestConfig?.<span class="property">params</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 复杂逻辑上一行注释：统一 body 选择并按 contentType 组织</span></span><br><span class="line">    <span class="keyword">const</span> body = data ?? params ?? requestConfig?.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">if</span> (contentType === <span class="string">&quot;formdata&quot;</span>)</span><br><span class="line">      cfg.<span class="property">data</span> = body <span class="keyword">instanceof</span> <span class="title class_">FormData</span> ? body : <span class="title function_">toFormData</span>(body <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (contentType === <span class="string">&quot;urlencoded&quot;</span>)</span><br><span class="line">      cfg.<span class="property">data</span> =</span><br><span class="line">        body <span class="keyword">instanceof</span> <span class="title class_">URLSearchParams</span></span><br><span class="line">          ? body</span><br><span class="line">          : <span class="title function_">toUrlencoded</span>((body ?? &#123;&#125;) <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">    <span class="keyword">else</span> cfg.<span class="property">data</span> = body;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> http.<span class="title function_">request</span>(cfg) <span class="keyword">as</span> <span class="title class_">Promise</span>&lt;T&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>client.ts</code> 里注册拦截器与取消池；<code>index.ts</code> 里 <code>export &#123; http &#125;</code> 与 <code>export &#123; call &#125;</code>；FormData 时<strong>别手动设置</strong> <code>Content-Type</code>，让浏览器带 boundary（官方文档有说明，也有 issue 讨论）。(<a target="_blank" rel="noopener" href="https://axios-http.com/docs/multipart?utm_source=chatgpt.com" title="Multipart Bodies | Axios Docs">axios-http.com</a>, <a target="_blank" rel="noopener" href="https://github.com/axios/axios/issues/5067?utm_source=chatgpt.com" title="Content type changed from multipart&#x2F;form-data to ...">GitHub</a>)</p>
</blockquote>
<hr>
<h2 id="校验清单（落地前检查）"><a href="#校验清单（落地前检查）" class="headerlink" title="校验清单（落地前检查）"></a>校验清单（落地前检查）</h2><ul>
<li><input disabled="" type="checkbox"> <strong>不覆写</strong> <code>axios.request</code>；保留 <code>http.get/post/...</code></li>
<li><input disabled="" type="checkbox"> <code>.d.ts</code> <strong>只放声明</strong>；<code>axios.d.ts</code> 仅做 module augmentation</li>
<li><input disabled="" type="checkbox"> <code>http.call</code> <strong>对象式入口</strong>可用；FormData 不手设 <code>Content-Type</code></li>
<li><input disabled="" type="checkbox"> 统一 <code>HttpError</code>；401&#x2F;取消池&#x2F;日志在拦截器层</li>
<li><input disabled="" type="checkbox"> 关键接口用 <strong>Zod</strong> 校验或生成器 schema</li>
<li><input disabled="" type="checkbox"> 接入 <strong>TanStack&#x2F;Vue Query</strong> 管理缓存与重试</li>
<li><input disabled="" type="checkbox"> <strong>MSW</strong> 拦截器与 handlers 就位；本地&#x2F;CI 可跑通</li>
</ul>
<hr>
<h2 id="参考与延伸"><a href="#参考与延伸" class="headerlink" title="参考与延伸"></a>参考与延伸</h2><ul>
<li>Axios 拦截器官方文档（拦截请求&#x2F;响应的标准扩展点）。(<a target="_blank" rel="noopener" href="https://axios-http.com/docs/interceptors?utm_source=chatgpt.com" title="Interceptors | Axios Docs">axios-http.com</a>)</li>
<li>Axios Multipart&#x2F;FormData 说明（自动序列化；不要手动 <code>Content-Type</code>）。(<a target="_blank" rel="noopener" href="https://axios-http.com/docs/multipart?utm_source=chatgpt.com" title="Multipart Bodies | Axios Docs">axios-http.com</a>)</li>
<li>不要手动设置 FormData 的 <code>Content-Type</code>（社区&#x2F;issue 共识）。(<a target="_blank" rel="noopener" href="https://github.com/axios/axios/issues/5067?utm_source=chatgpt.com" title="Content type changed from multipart&#x2F;form-data to ...">GitHub</a>, <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/75742226/cant-set-content-type-header-for-axios-with-formdata?utm_source=chatgpt.com" title="Can&#39;t set Content-Type header for axios with FormData">Stack Overflow</a>)</li>
<li>TypeScript <strong>声明合并 &#x2F; 模块增强</strong>（官方手册）。(<a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/declaration-merging.html?utm_source=chatgpt.com" title="Documentation - Declaration Merging">typescriptlang.org</a>)</li>
<li>Orval（OpenAPI → TS 客户端、Query、MSW mock 一体化）。(<a target="_blank" rel="noopener" href="https://orval.dev/?utm_source=chatgpt.com" title="orval - Restful client generator">orval.dev</a>, <a target="_blank" rel="noopener" href="https://github.com/orval-labs/orval?utm_source=chatgpt.com" title="orval-labs&#x2F;orval">GitHub</a>)</li>
<li>openapi-typescript-codegen（轻量生成 TS 客户端）。(<a target="_blank" rel="noopener" href="https://github.com/ferdikoomen/openapi-typescript-codegen?utm_source=chatgpt.com" title="ferdikoomen&#x2F;openapi-typescript-codegen">GitHub</a>)</li>
<li>TanStack Query（React&#x2F;Vue 的服务端状态&#x2F;数据获取）。(<a target="_blank" rel="noopener" href="https://tanstack.com/query/docs?utm_source=chatgpt.com" title="TanStack Query">tanstack.com</a>)</li>
<li>MSW（浏览器&#x2F;Node 的网络层 API Mock）。(<a target="_blank" rel="noopener" href="https://mswjs.io/docs/?utm_source=chatgpt.com" title="Introduction - Mock Service Worker">mswjs.io</a>)</li>
</ul>
<hr>
<p>如果你愿意，我可以把你现有的 <code>api.d.ts / axios.d.ts / common.ts</code> <strong>逐条清点</strong>并给出<strong>迁移 diff</strong>（仅贴需要修改的片段，复杂处在上一行加注释），直接落到上面的目录结构里。</p>
<p>下面给你一套<strong>可直接落地</strong>的企业级请求层目录与<strong>所有涉及文件的完整代码</strong>（不使用 Hexo）。<br>特点：不覆盖 <code>axios.request</code>、保留 <code>http.get/post/...</code> 零破坏；新增对象式入口 <code>http.call(options)</code>；类型集中在 <code>.d.ts</code> 与 <code>types.ts</code>；复杂逻辑行已在上一行加中文注释。</p>
<hr>
<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">src/</span><br><span class="line">  lib/</span><br><span class="line">    http/</span><br><span class="line">      client.ts</span><br><span class="line">      call.ts</span><br><span class="line">      types.ts</span><br><span class="line">      utils.ts</span><br><span class="line">      index.ts</span><br><span class="line">  api/</span><br><span class="line">    modules/</span><br><span class="line">      user.ts</span><br><span class="line">      price.ts</span><br><span class="line">  types/</span><br><span class="line">    http/</span><br><span class="line">      axios.d.ts</span><br><span class="line">      api.d.ts</span><br><span class="line">    common.ts</span><br><span class="line">  tests/</span><br><span class="line">    msw/</span><br><span class="line">      server.ts</span><br><span class="line">      handlers/</span><br><span class="line">        price.ts</span><br></pre></td></tr></table></figure>

<blockquote>
<p>说明：<code>api/__generated__</code>（OpenAPI 代码生成）在此略去，你可以后续接入 orval&#x2F;openapi-typescript-codegen；当前示例定位为手写模块层。</p>
</blockquote>
<hr>
<h2 id="src-lib-http-types-ts"><a href="#src-lib-http-types-ts" class="headerlink" title="src&#x2F;lib&#x2F;http&#x2F;types.ts"></a>src&#x2F;lib&#x2F;http&#x2F;types.ts</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123;</span><br><span class="line">  <span class="title class_">AxiosInstance</span>,</span><br><span class="line">  <span class="title class_">AxiosRequestConfig</span>,</span><br><span class="line">  <span class="title class_">Method</span>,</span><br><span class="line">  <span class="title class_">AxiosResponse</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;axios&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 请求体类型枚举 */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">RequestContentType</span> = <span class="string">&quot;json&quot;</span> | <span class="string">&quot;urlencoded&quot;</span> | <span class="string">&quot;formdata&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 对象式入参：与 axios 原生保持解耦 */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">RequestOptions</span>&lt;P = <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt;&gt; &#123;</span><br><span class="line">  <span class="attr">url</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">method</span>?: <span class="title class_">Method</span>;</span><br><span class="line">  <span class="comment">/** GET/HEAD 下作为查询串；非 GET/HEAD 下作为 body 的回退来源 */</span></span><br><span class="line">  <span class="attr">params</span>?: P;</span><br><span class="line">  <span class="comment">/** 非 GET/HEAD 的首选请求体 */</span></span><br><span class="line">  <span class="attr">data</span>?: <span class="built_in">unknown</span>;</span><br><span class="line">  <span class="comment">/** 附加的 axios 配置（headers/timeout/signal 等） */</span></span><br><span class="line">  <span class="attr">requestConfig</span>?: <span class="title class_">AxiosRequestConfig</span>;</span><br><span class="line">  <span class="attr">contentType</span>?: <span class="title class_">RequestContentType</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 统一的错误对象，可在拦截器里规约 */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">HttpError</span> <span class="keyword">extends</span> <span class="title class_">Error</span> &#123;</span><br><span class="line">  <span class="attr">status</span>?: <span class="built_in">number</span>;</span><br><span class="line">  <span class="attr">code</span>?: <span class="built_in">number</span> | <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">data</span>?: <span class="built_in">unknown</span>;</span><br><span class="line">  <span class="attr">traceId</span>?: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">isNetworkError</span>?: <span class="built_in">boolean</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 统一的响应解析器签名：返回 undefined 表示“跳过，让后续解析器或原始响应继续处理” */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">ResponseParser</span>&lt;T = <span class="built_in">any</span>, R = <span class="title class_">AxiosResponse</span>&lt;<span class="built_in">any</span>&gt;&gt; = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="attr">resp</span>: R</span></span></span><br><span class="line"><span class="params"><span class="function"></span>) =&gt;</span> T | <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 为 http 实例扩展的方法（实现见 client.ts / call.ts） */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">HttpInstance</span> <span class="keyword">extends</span> <span class="title class_">AxiosInstance</span> &#123;</span><br><span class="line">  call&lt;T = <span class="built_in">any</span>, P = <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt;&gt;(</span><br><span class="line">    <span class="attr">options</span>: <span class="title class_">RequestOptions</span>&lt;P&gt;</span><br><span class="line">  ): <span class="title class_">Promise</span>&lt;T&gt;;</span><br><span class="line">  <span class="title function_">cancelAll</span>(): <span class="built_in">void</span>;</span><br><span class="line">  <span class="title function_">setAuthToken</span>(<span class="attr">token</span>?: <span class="built_in">string</span> | <span class="literal">null</span>, <span class="attr">type</span>?: <span class="built_in">string</span>): <span class="built_in">void</span>;</span><br><span class="line">  <span class="title function_">setGlobalParser</span>(<span class="attr">parsers</span>: <span class="title class_">ResponseParser</span>&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;[]): <span class="built_in">void</span>;</span><br><span class="line">  <span class="title function_">setAuthorization</span>(<span class="attr">token</span>: <span class="built_in">string</span>, <span class="attr">expires</span>: <span class="built_in">number</span> | <span class="title class_">Date</span>, <span class="attr">name</span>?: <span class="built_in">string</span>): <span class="built_in">void</span>;</span><br><span class="line">  <span class="title function_">removeAuthorization</span>(<span class="attr">name</span>?: <span class="built_in">string</span>): <span class="built_in">void</span>;</span><br><span class="line">  <span class="title function_">checkAuthorization</span>(<span class="attr">name</span>?: <span class="built_in">string</span>): <span class="built_in">boolean</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="src-lib-http-utils-ts"><a href="#src-lib-http-utils-ts" class="headerlink" title="src&#x2F;lib&#x2F;http&#x2F;utils.ts"></a>src&#x2F;lib&#x2F;http&#x2F;utils.ts</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 将对象转为 FormData；数组按 key[] 追加；对象值 JSON.stringify */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">toFormData</span>(<span class="params"><span class="attr">params</span>?: <span class="title class_">Record</span>&lt;<span class="built_in">string</span> | <span class="built_in">number</span>, <span class="built_in">unknown</span>&gt;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> formData = <span class="keyword">new</span> <span class="title class_">FormData</span>();</span><br><span class="line">  <span class="keyword">if</span> (!params) <span class="keyword">return</span> formData;</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">entries</span>(params).<span class="title function_">forEach</span>(<span class="function">(<span class="params">[k, v]</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(v)) &#123;</span><br><span class="line">      v.<span class="title function_">forEach</span>(<span class="function">(<span class="params">val</span>) =&gt;</span></span><br><span class="line">        formData.<span class="title function_">append</span>(</span><br><span class="line">          <span class="string">`<span class="subst">$&#123;k&#125;</span>[]`</span>,</span><br><span class="line">          <span class="keyword">typeof</span> val === <span class="string">&quot;object&quot;</span> ? <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(val) : <span class="title class_">String</span>(val)</span><br><span class="line">        )</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> v === <span class="string">&quot;object&quot;</span> &amp;&amp; v !== <span class="literal">null</span>) &#123;</span><br><span class="line">      formData.<span class="title function_">append</span>(k, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(v));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (v !== <span class="literal">null</span> &amp;&amp; v !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      formData.<span class="title function_">append</span>(k, <span class="title class_">String</span>(v));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> formData;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 将对象转为 application/x-www-form-urlencoded（支持嵌套/数组） */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">toUrlencoded</span>(<span class="params"><span class="attr">params</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span> | <span class="built_in">number</span>, <span class="built_in">unknown</span>&gt;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> urlencoded = <span class="keyword">new</span> <span class="title class_">URLSearchParams</span>();</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">walk</span>(<span class="params"><span class="attr">obj</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span> | <span class="built_in">number</span>, <span class="built_in">unknown</span>&gt;, parent = <span class="string">&quot;&quot;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> [k, v] <span class="keyword">of</span> <span class="title class_">Object</span>.<span class="title function_">entries</span>(obj)) &#123;</span><br><span class="line">      <span class="keyword">const</span> key = parent ? <span class="string">`<span class="subst">$&#123;parent&#125;</span>[<span class="subst">$&#123;k&#125;</span>]`</span> : k;</span><br><span class="line">      <span class="keyword">if</span> (v === <span class="literal">null</span> || v === <span class="literal">undefined</span>) <span class="keyword">continue</span>;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(v)) &#123;</span><br><span class="line">        v.<span class="title function_">forEach</span>(<span class="function">(<span class="params">item</span>) =&gt;</span></span><br><span class="line">          urlencoded.<span class="title function_">append</span>(</span><br><span class="line">            <span class="string">`<span class="subst">$&#123;key&#125;</span>[]`</span>,</span><br><span class="line">            <span class="keyword">typeof</span> item === <span class="string">&quot;object&quot;</span> ? <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(item) : <span class="title class_">String</span>(item)</span><br><span class="line">          )</span><br><span class="line">        );</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> v === <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line">        <span class="title function_">walk</span>(v <span class="keyword">as</span> <span class="title class_">Record</span>&lt;<span class="built_in">string</span> | <span class="built_in">number</span>, <span class="built_in">unknown</span>&gt;, key);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        urlencoded.<span class="title function_">append</span>(key, <span class="title class_">String</span>(v));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">walk</span>(params);</span><br><span class="line">  <span class="keyword">return</span> urlencoded;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="src-lib-http-call-ts"><a href="#src-lib-http-call-ts" class="headerlink" title="src&#x2F;lib&#x2F;http&#x2F;call.ts"></a>src&#x2F;lib&#x2F;http&#x2F;call.ts</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">AxiosRequestConfig</span> &#125; <span class="keyword">from</span> <span class="string">&quot;axios&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> qs <span class="keyword">from</span> <span class="string">&quot;qs&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">RequestOptions</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./types&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; toFormData, toUrlencoded &#125; <span class="keyword">from</span> <span class="string">&quot;./utils&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 复杂逻辑上一行注释：根据 contentType 组织 body 并设置 headers/paramsSerializer */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">buildAxiosConfigFromOptions</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>: <span class="title class_">RequestOptions</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">AxiosRequestConfig</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    url,</span><br><span class="line">    method = <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">    params,</span><br><span class="line">    data,</span><br><span class="line">    requestConfig,</span><br><span class="line">    contentType = <span class="string">&quot;json&quot;</span>,</span><br><span class="line">  &#125; = options;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!url) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Missing url&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">cfg</span>: <span class="title class_">AxiosRequestConfig</span> = &#123;</span><br><span class="line">    ...(requestConfig || &#123;&#125;),</span><br><span class="line">    url,</span><br><span class="line">    method,</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">      <span class="comment">// 默认 Content-Type，稍后允许外部覆盖；formdata 会主动删除以让浏览器自动带 boundary</span></span><br><span class="line">      <span class="string">&quot;Content-Type&quot;</span>:</span><br><span class="line">        contentType === <span class="string">&quot;urlencoded&quot;</span></span><br><span class="line">          ? <span class="string">&quot;application/x-www-form-urlencoded&quot;</span></span><br><span class="line">          : <span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">      ...(requestConfig?.<span class="property">headers</span> || &#123;&#125;),</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (method === <span class="string">&quot;GET&quot;</span> || method === <span class="string">&quot;HEAD&quot;</span>) &#123;</span><br><span class="line">    cfg.<span class="property">params</span> = params ?? requestConfig?.<span class="property">params</span>;</span><br><span class="line">    <span class="comment">// 复杂逻辑上一行注释：数组无索引、跳过 null</span></span><br><span class="line">    cfg.<span class="property">paramsSerializer</span> = <span class="function">(<span class="params">d</span>) =&gt;</span></span><br><span class="line">      qs.<span class="title function_">stringify</span>(d, &#123; <span class="attr">indices</span>: <span class="literal">false</span>, <span class="attr">skipNulls</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 复杂逻辑上一行注释：优先 data，回退 params（兼容旧思路）</span></span><br><span class="line">    <span class="keyword">const</span> body = data ?? params ?? requestConfig?.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">if</span> (contentType === <span class="string">&quot;formdata&quot;</span>) &#123;</span><br><span class="line">      <span class="comment">// 复杂逻辑上一行注释：FormData 让浏览器自动带 boundary，需移除手动设置的 Content-Type</span></span><br><span class="line">      <span class="keyword">if</span> (cfg.<span class="property">headers</span>) <span class="title function_">delete</span> (cfg.<span class="property">headers</span> <span class="keyword">as</span> <span class="built_in">any</span>)[<span class="string">&quot;Content-Type&quot;</span>];</span><br><span class="line">      cfg.<span class="property">data</span> = body <span class="keyword">instanceof</span> <span class="title class_">FormData</span> ? body : <span class="title function_">toFormData</span>(body <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (contentType === <span class="string">&quot;urlencoded&quot;</span>) &#123;</span><br><span class="line">      cfg.<span class="property">data</span> =</span><br><span class="line">        body <span class="keyword">instanceof</span> <span class="title class_">URLSearchParams</span></span><br><span class="line">          ? body</span><br><span class="line">          : <span class="title function_">toUrlencoded</span>((body ?? &#123;&#125;) <span class="keyword">as</span> <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt;);</span><br><span class="line">      cfg.<span class="property">headers</span> = &#123;</span><br><span class="line">        ...cfg.<span class="property">headers</span>,</span><br><span class="line">        <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      cfg.<span class="property">data</span> = body;</span><br><span class="line">      cfg.<span class="property">headers</span> = &#123; ...cfg.<span class="property">headers</span>, <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span> &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> cfg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="src-lib-http-client-ts"><a href="#src-lib-http-client-ts" class="headerlink" title="src&#x2F;lib&#x2F;http&#x2F;client.ts"></a>src&#x2F;lib&#x2F;http&#x2F;client.ts</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&quot;axios&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Cookie</span> <span class="keyword">from</span> <span class="string">&quot;js-cookie&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> storage <span class="keyword">from</span> <span class="string">&quot;store&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">AxiosInstance</span>, <span class="title class_">AxiosRequestConfig</span>, <span class="title class_">AxiosResponse</span> &#125; <span class="keyword">from</span> <span class="string">&quot;axios&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">HttpInstance</span>, <span class="title class_">ResponseParser</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./types&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; buildAxiosConfigFromOptions &#125; <span class="keyword">from</span> <span class="string">&quot;./call&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">STORAGE_KEYS</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@/constants&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">LOGIN_ROUTE</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@/router/constants&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; <span class="variable constant_">ACCESS_TOKEN</span>, <span class="variable constant_">TOKEN_TYPE</span> &#125; = <span class="variable constant_">STORAGE_KEYS</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** —— 取消池：统一管理所有请求的 AbortController —— */</span></span><br><span class="line"><span class="keyword">const</span> abortPool = <span class="keyword">new</span> <span class="title class_">Set</span>&lt;<span class="title class_">AbortController</span>&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 对外暴露：集中取消所有未决请求（如退出登录时） */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">cancelAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">  abortPool.<span class="title function_">forEach</span>(<span class="function">(<span class="params">c</span>) =&gt;</span> c.<span class="title function_">abort</span>());</span><br><span class="line">  abortPool.<span class="title function_">clear</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 创建 axios 实例并安装拦截器 */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createAxiosHttp</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">config</span>: <span class="title class_">AxiosRequestConfig</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">opts</span>: &#123;</span></span><br><span class="line"><span class="params">    authDefault?: <span class="built_in">boolean</span>;</span></span><br><span class="line"><span class="params">    publicPrefixes?: <span class="built_in">string</span>[];</span></span><br><span class="line"><span class="params">  &#125; = &#123;&#125;</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">HttpInstance</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> authDefault = opts.<span class="property">authDefault</span> ?? <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">const</span> publicPrefixes = opts.<span class="property">publicPrefixes</span> ?? [<span class="string">&quot;/api/pub&quot;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> _axios = axios.<span class="title function_">create</span>(config) <span class="keyword">as</span> <span class="title class_">AxiosInstance</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// —— 业务增强：全局解析器（按顺序尝试，返回 undefined 表示跳过） ——</span></span><br><span class="line">  (_axios <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">setGlobalParser</span> = <span class="function">(<span class="params"><span class="attr">parsers</span>: <span class="title class_">ResponseParser</span>&lt;<span class="built_in">any</span>, <span class="built_in">any</span>&gt;[]</span>) =&gt;</span> &#123;</span><br><span class="line">    _axios.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(</span><br><span class="line">      <span class="function">(<span class="params"><span class="attr">resp</span>: <span class="title class_">AxiosResponse</span></span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> p <span class="keyword">of</span> parsers) &#123;</span><br><span class="line">          <span class="keyword">const</span> r = <span class="title function_">p</span>(resp);</span><br><span class="line">          <span class="keyword">if</span> (r !== <span class="literal">undefined</span>) <span class="keyword">return</span> r;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (err?.<span class="property">response</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> <span class="attr">e</span>: <span class="built_in">any</span> = <span class="keyword">new</span> <span class="title class_">Error</span>(err.<span class="property">response</span>.<span class="property">statusText</span>);</span><br><span class="line">          e.<span class="property">status</span> = err.<span class="property">response</span>.<span class="property">status</span>;</span><br><span class="line">          e.<span class="property">code</span> = err.<span class="property">response</span>.<span class="property">data</span>?.<span class="property">code</span>;</span><br><span class="line">          e.<span class="property">data</span> = err.<span class="property">response</span>.<span class="property">data</span>;</span><br><span class="line">          <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 网络层错误（超时/断网/跨域）</span></span><br><span class="line">        <span class="keyword">const</span> <span class="attr">e</span>: <span class="built_in">any</span> = <span class="keyword">new</span> <span class="title class_">Error</span>(err?.<span class="property">message</span> || <span class="string">&quot;Network Error&quot;</span>);</span><br><span class="line">        e.<span class="property">isNetworkError</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// —— cookie 鉴权工具方法（部分场景需要，同你原实现保持一致） ——</span></span><br><span class="line">  (_axios <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">setAuthorization</span> = <span class="function">(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="attr">token</span>: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="attr">expires</span>: <span class="built_in">number</span> | <span class="title class_">Date</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="attr">name</span>?: <span class="built_in">string</span></span></span></span><br><span class="line"><span class="params"><span class="function">  </span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">Cookie</span>.<span class="title function_">set</span>(name ?? _axios.<span class="property">defaults</span>.<span class="property">xsrfCookieName</span>!, token, &#123; expires &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  (_axios <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">removeAuthorization</span> = <span class="function">(<span class="params"><span class="attr">name</span>?: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">Cookie</span>.<span class="title function_">remove</span>(name ?? _axios.<span class="property">defaults</span>.<span class="property">xsrfCookieName</span>!);</span><br><span class="line">  &#125;;</span><br><span class="line">  (_axios <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">checkAuthorization</span> = <span class="function">(<span class="params"><span class="attr">name</span>?: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Boolean</span>(<span class="title class_">Cookie</span>.<span class="title function_">get</span>(name ?? _axios.<span class="property">defaults</span>.<span class="property">xsrfCookieName</span>!));</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// —— 请求拦截器：统一接入取消池/授权头/公开前缀 ——</span></span><br><span class="line">  _axios.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(<span class="function">(<span class="params">req</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 复杂逻辑上一行注释：桥接外部 signal 与内部 AbortController，并加入取消池</span></span><br><span class="line">    <span class="keyword">const</span> abortController = <span class="keyword">new</span> <span class="title class_">AbortController</span>();</span><br><span class="line">    <span class="keyword">if</span> ((req <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">signal</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> ext = (req <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">signal</span> <span class="keyword">as</span> <span class="title class_">AbortSignal</span>;</span><br><span class="line">      <span class="keyword">if</span> (ext.<span class="property">aborted</span>) abortController.<span class="title function_">abort</span>();</span><br><span class="line">      <span class="keyword">else</span> ext.<span class="property">addEventListener</span>?.(<span class="string">&quot;abort&quot;</span>, <span class="function">() =&gt;</span> abortController.<span class="title function_">abort</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    (req <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">signal</span> = abortController.<span class="property">signal</span>;</span><br><span class="line">    abortPool.<span class="title function_">add</span>(abortController);</span><br><span class="line">    <span class="comment">// 复杂逻辑上一行注释：把 controller 暂存在 config 上，响应阶段释放</span></span><br><span class="line">    (req <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">__abortController</span> = abortController;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复杂逻辑上一行注释：根据前缀与开关决定是否附加 Authorization</span></span><br><span class="line">    <span class="keyword">const</span> url = req.<span class="property">url</span> || <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> isPublicByPrefix = publicPrefixes.<span class="title function_">some</span>(<span class="function">(<span class="params">p</span>) =&gt;</span> url.<span class="title function_">startsWith</span>(p));</span><br><span class="line">    <span class="comment">// 优先使用 req.auth(boolean)；否则用实例默认值 + 前缀约定</span></span><br><span class="line">    <span class="keyword">const</span> explicitAuth =</span><br><span class="line">      <span class="title function_">typeof</span> (req <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">auth</span> === <span class="string">&quot;boolean&quot;</span> ? (req <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">auth</span> : <span class="literal">undefined</span>;</span><br><span class="line">    <span class="keyword">const</span> needAuth = explicitAuth ?? (authDefault &amp;&amp; !isPublicByPrefix);</span><br><span class="line">    <span class="keyword">const</span> accToken = storage.<span class="title function_">get</span>(<span class="variable constant_">ACCESS_TOKEN</span>);</span><br><span class="line">    <span class="keyword">const</span> tokenType = storage.<span class="title function_">get</span>(<span class="variable constant_">TOKEN_TYPE</span>) || <span class="string">&quot;Bearer&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (needAuth &amp;&amp; !accToken) &#123;</span><br><span class="line">      ((req <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">__abortController</span> <span class="keyword">as</span> <span class="title class_">AbortController</span> | <span class="literal">undefined</span>)?.<span class="title function_">abort</span>();</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;UNAUTHENTICATED&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (needAuth &amp;&amp; accToken) &#123;</span><br><span class="line">      req.<span class="property">headers</span> = &#123;</span><br><span class="line">        ...req.<span class="property">headers</span>,</span><br><span class="line">        <span class="title class_">Authorization</span>: <span class="string">`<span class="subst">$&#123;tokenType&#125;</span> <span class="subst">$&#123;accToken&#125;</span>`</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> req;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// —— 响应拦截器：释放取消控制器；401 统一处理 ——</span></span><br><span class="line">  _axios.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(</span><br><span class="line">    <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> abortController = (res.<span class="property">config</span> <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">__abortController</span> <span class="keyword">as</span></span><br><span class="line">        | <span class="title class_">AbortController</span></span><br><span class="line">        | <span class="literal">undefined</span>;</span><br><span class="line">      <span class="keyword">if</span> (abortController) abortPool.<span class="title function_">delete</span>(abortController);</span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err?.<span class="property">response</span>?.<span class="property">status</span> === <span class="number">401</span>) &#123;</span><br><span class="line">        storage.<span class="title function_">remove</span>(<span class="variable constant_">ACCESS_TOKEN</span>);</span><br><span class="line">        storage.<span class="title function_">remove</span>(<span class="variable constant_">TOKEN_TYPE</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">pathname</span> !== <span class="variable constant_">LOGIN_ROUTE</span>.<span class="property">path</span>) &#123;</span><br><span class="line">          <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">replace</span>(<span class="variable constant_">LOGIN_ROUTE</span>.<span class="property">path</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> abortController = (err?.<span class="property">config</span> <span class="keyword">as</span> <span class="built_in">any</span>)?.<span class="property">__abortController</span> <span class="keyword">as</span></span><br><span class="line">        | <span class="title class_">AbortController</span></span><br><span class="line">        | <span class="literal">undefined</span>;</span><br><span class="line">      <span class="keyword">if</span> (abortController) abortPool.<span class="title function_">delete</span>(abortController);</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(err);</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// —— 实例级取消 ——</span></span><br><span class="line">  (_axios <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">cancelAll</span> = cancelAll;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// —— 实例级鉴权头设置（与本地存储联动） ——</span></span><br><span class="line">  (_axios <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">setAuthToken</span> = <span class="function">(<span class="params"><span class="attr">token</span>?: <span class="built_in">string</span> | <span class="literal">null</span>, <span class="keyword">type</span> = <span class="string">&quot;Bearer&quot;</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (token) &#123;</span><br><span class="line">      _axios.<span class="property">defaults</span>.<span class="property">headers</span>.<span class="property">common</span>.<span class="property">Authorization</span> = <span class="string">`<span class="subst">$&#123;<span class="keyword">type</span>&#125;</span> <span class="subst">$&#123;token&#125;</span>`</span>;</span><br><span class="line">      storage.<span class="title function_">set</span>(<span class="variable constant_">ACCESS_TOKEN</span>, token);</span><br><span class="line">      storage.<span class="title function_">set</span>(<span class="variable constant_">TOKEN_TYPE</span>, <span class="keyword">type</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">delete</span> _axios.<span class="property">defaults</span>.<span class="property">headers</span>.<span class="property">common</span>.<span class="property">Authorization</span>;</span><br><span class="line">      storage.<span class="title function_">remove</span>(<span class="variable constant_">ACCESS_TOKEN</span>);</span><br><span class="line">      storage.<span class="title function_">remove</span>(<span class="variable constant_">TOKEN_TYPE</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// —— 新增对象式入口：http.call(options) ——</span></span><br><span class="line">  (_axios <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">call</span> = <span class="keyword">async</span> <span class="keyword">function</span> &lt;T = <span class="built_in">any</span>&gt;(</span><br><span class="line">    <span class="attr">options</span>: <span class="title class_">Parameters</span>&lt;<span class="keyword">typeof</span> buildAxiosConfigFromOptions&gt;[<span class="number">0</span>]</span><br><span class="line">  ): <span class="title class_">Promise</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> cfg = <span class="title function_">buildAxiosConfigFromOptions</span>(options);</span><br><span class="line">    <span class="keyword">return</span> _axios.<span class="title function_">request</span>(cfg) <span class="keyword">as</span> <span class="title class_">Promise</span>&lt;T&gt;;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> _axios <span class="keyword">as</span> <span class="built_in">unknown</span> <span class="keyword">as</span> <span class="title class_">HttpInstance</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> http = <span class="title function_">createAxiosHttp</span>(</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">timeout</span>: <span class="number">10000</span>,</span><br><span class="line">    <span class="attr">baseURL</span>: <span class="keyword">import</span>.<span class="property">meta</span>.<span class="property">env</span>.<span class="property">VITE_API_URL</span> <span class="keyword">as</span> <span class="built_in">string</span>,</span><br><span class="line">    <span class="attr">withCredentials</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">xsrfCookieName</span>: <span class="string">&quot;Authorization&quot;</span>,</span><br><span class="line">    <span class="attr">xsrfHeaderName</span>: <span class="string">&quot;Authorization&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">authDefault</span>: <span class="literal">true</span>, <span class="attr">publicPrefixes</span>: [<span class="string">&quot;/api/pub&quot;</span>] &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> http;</span><br><span class="line"><span class="keyword">export</span> &#123; cancelAll &#125;;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="src-lib-http-index-ts"><a href="#src-lib-http-index-ts" class="headerlink" title="src&#x2F;lib&#x2F;http&#x2F;index.ts"></a>src&#x2F;lib&#x2F;http&#x2F;index.ts</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> &#123; <span class="keyword">default</span> <span class="keyword">as</span> http, cancelAll &#125; <span class="keyword">from</span> <span class="string">&quot;./client&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> * <span class="keyword">from</span> <span class="string">&quot;./types&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> * <span class="keyword">from</span> <span class="string">&quot;./utils&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> * <span class="keyword">from</span> <span class="string">&quot;./call&quot;</span>;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="src-api-modules-user-ts"><a href="#src-api-modules-user-ts" class="headerlink" title="src&#x2F;api&#x2F;modules&#x2F;user.ts"></a>src&#x2F;api&#x2F;modules&#x2F;user.ts</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; http &#125; <span class="keyword">from</span> <span class="string">&quot;@/lib/http&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">RequestOptions</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@/lib/http/types&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 复杂逻辑上一行注释：领域 API 薄封装，避免页面直接感知 URL/方法/解析细节 */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> userApi = &#123;</span><br><span class="line">  <span class="title function_">getProfile</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> http.<span class="property">get</span>&lt;&#123; <span class="attr">id</span>: <span class="built_in">string</span>; <span class="attr">name</span>: <span class="built_in">string</span>; <span class="attr">roles</span>: <span class="built_in">string</span>[] &#125;&gt;(</span><br><span class="line">      <span class="string">&quot;/api/user/profile&quot;</span></span><br><span class="line">    );</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="title function_">updateProfile</span>(<span class="params"><span class="attr">input</span>: &#123; name?: <span class="built_in">string</span> &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> http.<span class="property">call</span>&lt;<span class="built_in">void</span>&gt;(&#123;</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&quot;/api/user/profile&quot;</span>,</span><br><span class="line">      <span class="attr">method</span>: <span class="string">&quot;PUT&quot;</span>,</span><br><span class="line">      <span class="attr">data</span>: input,</span><br><span class="line">      <span class="attr">contentType</span>: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** 演示：URLSearchParams */</span></span><br><span class="line">  <span class="title function_">search</span>(<span class="params"><span class="attr">params</span>: &#123; keyword?: <span class="built_in">string</span>; page?: <span class="built_in">number</span> &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">options</span>: <span class="title class_">RequestOptions</span>&lt;<span class="keyword">typeof</span> params&gt; = &#123;</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&quot;/api/user/search&quot;</span>,</span><br><span class="line">      <span class="attr">method</span>: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">      params,</span><br><span class="line">      <span class="attr">requestConfig</span>: &#123; <span class="attr">timeout</span>: <span class="number">8000</span> &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> http.<span class="property">call</span>&lt;&#123; <span class="attr">list</span>: <span class="built_in">any</span>[]; <span class="attr">total</span>: <span class="built_in">number</span> &#125;&gt;(options);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="src-api-modules-price-ts"><a href="#src-api-modules-price-ts" class="headerlink" title="src&#x2F;api&#x2F;modules&#x2F;price.ts"></a>src&#x2F;api&#x2F;modules&#x2F;price.ts</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; http &#125; <span class="keyword">from</span> <span class="string">&quot;@/lib/http&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 复杂逻辑上一行注释：后端采用 CodeResponse 外包裹，交由全局解析器转换 */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> priceApi = &#123;</span><br><span class="line">  <span class="title function_">getTrend</span>(<span class="params"><span class="attr">input</span>: &#123; gameId: <span class="built_in">string</span>; stores: <span class="built_in">string</span>[] &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> http.<span class="property">call</span>&lt;<span class="title class_">Array</span>&lt;&#123; <span class="attr">store</span>: <span class="built_in">string</span>; <span class="attr">date</span>: <span class="built_in">string</span>; <span class="attr">price</span>: <span class="built_in">number</span> &#125;&gt;&gt;(&#123;</span><br><span class="line">      <span class="attr">url</span>: <span class="string">&quot;/api/price/trend&quot;</span>,</span><br><span class="line">      <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">      <span class="attr">data</span>: input,</span><br><span class="line">      <span class="attr">contentType</span>: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">      <span class="attr">requestConfig</span>: &#123; <span class="attr">timeout</span>: <span class="number">15000</span> &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="src-types-http-axios-d-ts"><a href="#src-types-http-axios-d-ts" class="headerlink" title="src&#x2F;types&#x2F;http&#x2F;axios.d.ts"></a>src&#x2F;types&#x2F;http&#x2F;axios.d.ts</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明合并：扩展 AxiosInstance，而不改动运行时代码</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">AxiosRequestConfig</span> &#125; <span class="keyword">from</span> <span class="string">&quot;axios&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="variable language_">module</span> <span class="string">&quot;axios&quot;</span> &#123;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">AxiosInstance</span> &#123;</span><br><span class="line">    call&lt;T = <span class="built_in">any</span>, P = <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">any</span>&gt;&gt;(<span class="attr">options</span>: &#123;</span><br><span class="line">      <span class="attr">url</span>: <span class="built_in">string</span>;</span><br><span class="line">      <span class="attr">method</span>?: <span class="title class_">Method</span>;</span><br><span class="line">      <span class="attr">params</span>?: P;</span><br><span class="line">      <span class="attr">data</span>?: <span class="built_in">unknown</span>;</span><br><span class="line">      <span class="attr">requestConfig</span>?: <span class="title class_">AxiosRequestConfig</span>;</span><br><span class="line">      <span class="attr">contentType</span>?: <span class="string">&quot;json&quot;</span> | <span class="string">&quot;urlencoded&quot;</span> | <span class="string">&quot;formdata&quot;</span>;</span><br><span class="line">    &#125;): <span class="title class_">Promise</span>&lt;T&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">cancelAll</span>(): <span class="built_in">void</span>;</span><br><span class="line">    <span class="title function_">setAuthToken</span>(<span class="attr">token</span>?: <span class="built_in">string</span> | <span class="literal">null</span>, <span class="attr">type</span>?: <span class="built_in">string</span>): <span class="built_in">void</span>;</span><br><span class="line">    <span class="title function_">setGlobalParser</span>(<span class="attr">parsers</span>: <span class="title class_">Array</span>&lt;<span class="function">(<span class="params"><span class="attr">resp</span>: <span class="built_in">any</span></span>) =&gt;</span> <span class="built_in">any</span> | <span class="literal">undefined</span>&gt;): <span class="built_in">void</span>;</span><br><span class="line">    <span class="title function_">setAuthorization</span>(</span><br><span class="line">      <span class="attr">token</span>: <span class="built_in">string</span>,</span><br><span class="line">      <span class="attr">expires</span>: <span class="built_in">number</span> | <span class="title class_">Date</span>,</span><br><span class="line">      <span class="attr">name</span>?: <span class="built_in">string</span></span><br><span class="line">    ): <span class="built_in">void</span>;</span><br><span class="line">    <span class="title function_">removeAuthorization</span>(<span class="attr">name</span>?: <span class="built_in">string</span>): <span class="built_in">void</span>;</span><br><span class="line">    <span class="title function_">checkAuthorization</span>(<span class="attr">name</span>?: <span class="built_in">string</span>): <span class="built_in">boolean</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="src-types-http-api-d-ts"><a href="#src-types-http-api-d-ts" class="headerlink" title="src&#x2F;types&#x2F;http&#x2F;api.d.ts"></a>src&#x2F;types&#x2F;http&#x2F;api.d.ts</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 与后端约定的通用响应外壳</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">CodeResponse</span>&lt;T = <span class="built_in">any</span>&gt; &#123;</span><br><span class="line">  <span class="attr">code</span>: <span class="built_in">number</span>;</span><br><span class="line">  <span class="attr">data</span>: T;</span><br><span class="line">  <span class="attr">message</span>?: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 常见分页返回</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">PageResp</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="attr">list</span>: T[];</span><br><span class="line">  <span class="attr">total</span>: <span class="built_in">number</span>;</span><br><span class="line">  <span class="attr">page</span>: <span class="built_in">number</span>;</span><br><span class="line">  <span class="attr">pageSize</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析器（如果你希望有全局类型）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">ResponseParser</span>&lt;T = <span class="built_in">any</span>, R = <span class="built_in">any</span>&gt; = <span class="function">(<span class="params"><span class="attr">resp</span>: R</span>) =&gt;</span> T | <span class="literal">undefined</span>;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="src-types-common-ts"><a href="#src-types-common-ts" class="headerlink" title="src&#x2F;types&#x2F;common.ts"></a>src&#x2F;types&#x2F;common.ts</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 放与请求无关的通用类型</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="variable constant_">ID</span> = <span class="built_in">string</span> | <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">Dict</span>&lt;T = <span class="built_in">any</span>&gt; &#123;</span><br><span class="line">  [<span class="attr">key</span>: <span class="built_in">string</span>]: T;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="（可选）全局解析器：将-CodeResponse-解开"><a href="#（可选）全局解析器：将-CodeResponse-解开" class="headerlink" title="（可选）全局解析器：将 CodeResponse 解开"></a>（可选）全局解析器：将 CodeResponse<T> 解开</h2><blockquote>
<p>你可以把它放到任意初始化位置（如 <code>src/app.ts</code> 或 <code>src/main.ts</code>）并在启动时挂载。</p>
</blockquote>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/app.setup-http.ts</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">AxiosResponse</span> &#125; <span class="keyword">from</span> <span class="string">&quot;axios&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; http &#125; <span class="keyword">from</span> <span class="string">&quot;@/lib/http&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">LOGIN_ROUTE</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@/router/constants&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> storage <span class="keyword">from</span> <span class="string">&quot;store&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">STORAGE_KEYS</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@/constants&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">CodeResponse</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@/types/http/api&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; <span class="variable constant_">ACCESS_TOKEN</span>, <span class="variable constant_">TOKEN_TYPE</span> &#125; = <span class="variable constant_">STORAGE_KEYS</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 复杂逻辑上一行注释：仅处理符合 CodeResponse 形状的响应，其他透传 */</span></span><br><span class="line"><span class="keyword">function</span> isCodeResp&lt;T&gt;(<span class="attr">d</span>: <span class="built_in">unknown</span>): d is <span class="title class_">CodeResponse</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    !!d &amp;&amp; <span class="keyword">typeof</span> d === <span class="string">&quot;object&quot;</span> &amp;&amp; <span class="string">&quot;code&quot;</span> <span class="title function_">in</span> (d <span class="keyword">as</span> <span class="built_in">any</span>) &amp;&amp; <span class="string">&quot;data&quot;</span> <span class="title function_">in</span> (d <span class="keyword">as</span> <span class="built_in">any</span>)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> codeResponseParser = &lt;T, R = <span class="title class_">CodeResponse</span>&lt;T&gt;&gt;(</span><br><span class="line">  <span class="attr">res</span>: <span class="title class_">AxiosResponse</span>&lt;R&gt;</span><br><span class="line">): T | <span class="function"><span class="params">undefined</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> payload = res.<span class="property">data</span> <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line">  <span class="keyword">if</span> (!isCodeResp&lt;T&gt;(payload)) <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">const</span> &#123; code, data, message = <span class="string">&quot;&quot;</span> &#125; = payload;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (code === <span class="number">401</span>) &#123;</span><br><span class="line">    storage.<span class="title function_">remove</span>(<span class="variable constant_">ACCESS_TOKEN</span>);</span><br><span class="line">    storage.<span class="title function_">remove</span>(<span class="variable constant_">TOKEN_TYPE</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">pathname</span> !== <span class="variable constant_">LOGIN_ROUTE</span>.<span class="property">path</span>) &#123;</span><br><span class="line">      <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">replace</span>(<span class="variable constant_">LOGIN_ROUTE</span>.<span class="property">path</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;未授权，请重新登录&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (code === <span class="number">200</span>) <span class="keyword">return</span> (data ?? <span class="literal">null</span>) <span class="keyword">as</span> T;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(message || <span class="string">&quot;后端错误&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动时挂载</span></span><br><span class="line">http.<span class="title function_">setGlobalParser</span>([codeResponseParser]);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="tests-msw-server-ts"><a href="#tests-msw-server-ts" class="headerlink" title="tests&#x2F;msw&#x2F;server.ts"></a>tests&#x2F;msw&#x2F;server.ts</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; setupServer &#125; <span class="keyword">from</span> <span class="string">&quot;msw/node&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; handlers &#125; <span class="keyword">from</span> <span class="string">&quot;./handlers/price&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> server = <span class="title function_">setupServer</span>(...handlers);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在测试框架的 setup 中调用：</span></span><br><span class="line"><span class="comment">// beforeAll(() =&gt; server.listen(&#123; onUnhandledRequest: &#x27;warn&#x27; &#125;))</span></span><br><span class="line"><span class="comment">// afterEach(() =&gt; server.resetHandlers())</span></span><br><span class="line"><span class="comment">// afterAll(() =&gt; server.close())</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="tests-msw-handlers-price-ts"><a href="#tests-msw-handlers-price-ts" class="headerlink" title="tests&#x2F;msw&#x2F;handlers&#x2F;price.ts"></a>tests&#x2F;msw&#x2F;handlers&#x2F;price.ts</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; http, <span class="title class_">HttpResponse</span> &#125; <span class="keyword">from</span> <span class="string">&quot;msw&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例：与你的 priceApi.getTrend 匹配</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> handlers = [</span><br><span class="line">  http.<span class="title function_">post</span>(<span class="string">&quot;/api/price/trend&quot;</span>, <span class="title function_">async</span> (&#123; request &#125;) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> body = (<span class="keyword">await</span> request.<span class="title function_">json</span>()) <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line">    <span class="comment">// 复杂逻辑上一行注释：模拟后端的 CodeResponse 外壳</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">HttpResponse</span>.<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">code</span>: <span class="number">200</span>,</span><br><span class="line">      <span class="attr">data</span>: [</span><br><span class="line">        &#123; <span class="attr">store</span>: <span class="string">&quot;Steam&quot;</span>, <span class="attr">date</span>: <span class="string">&quot;2025-09-01&quot;</span>, <span class="attr">price</span>: <span class="number">199</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">store</span>: <span class="string">&quot;Epic&quot;</span>, <span class="attr">date</span>: <span class="string">&quot;2025-09-01&quot;</span>, <span class="attr">price</span>: <span class="number">189</span> &#125;,</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;ok&quot;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;),</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="使用要点"><a href="#使用要点" class="headerlink" title="使用要点"></a>使用要点</h1><ul>
<li>老代码：<code>http.get/post/...</code> <strong>完全不受影响</strong>。</li>
<li>新写法：<code>http.call(&#123; url, method, data/params, contentType, requestConfig &#125;)</code> 更可读&#x2F;可扩展。</li>
<li><code>FormData</code> 场景不要手设 <code>Content-Type</code>，已在实现里处理。</li>
<li>推荐在应用初始化处挂载 <code>codeResponseParser</code>，让模块层拿到的就是“已解壳”的数据。</li>
</ul>
<p>如果你要把你现有的 <code>api.d.ts / axios.d.ts / common.ts</code> 内容<strong>原封不动</strong>迁入以上文件名，也可以把原定义贴出来，我帮你对齐&#x2F;去重并完善类型冲突的 diff。</p>
<p>下面把你要的 <strong><code>cancel.ts</code> 完整代码</strong>给出，并说明如何在 <code>client.ts</code> 接入；最后把 “FormData 自动带 boundary，需移除手动设置的 Content-Type” 的含义讲清楚。</p>
<hr>
<h2 id="1-src-lib-http-cancel-ts（完整代码）"><a href="#1-src-lib-http-cancel-ts（完整代码）" class="headerlink" title="1) src/lib/http/cancel.ts（完整代码）"></a>1) <code>src/lib/http/cancel.ts</code>（完整代码）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/lib/http/cancel.ts</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 维护一个全局取消池，用于集中取消所有尚未完成的请求。</span></span><br><span class="line"><span class="comment"> * 注意：只存放“活跃中的” AbortController；请求结束后要及时释放。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> abortPool = <span class="keyword">new</span> <span class="title class_">Set</span>&lt;<span class="title class_">AbortController</span>&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 复杂逻辑上一行注释：把外部 signal（若有）与内部 controller 绑定，外部取消时联动内部取消 */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">linkExternalSignal</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">external</span>?: <span class="title class_">AbortSignal</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">controller</span>?: <span class="title class_">AbortController</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!external || !controller) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (external.<span class="property">aborted</span>) &#123;</span><br><span class="line">    <span class="comment">// 外部已取消则立即同步内部取消</span></span><br><span class="line">    controller.<span class="title function_">abort</span>();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 外部后续取消时，触发内部取消</span></span><br><span class="line">  external.<span class="title function_">addEventListener</span>(<span class="string">&quot;abort&quot;</span>, <span class="function">() =&gt;</span> controller.<span class="title function_">abort</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建一个“已纳入取消池管理”的 AbortController。</span></span><br><span class="line"><span class="comment"> * - 会自动与外部 signal（如果传入）联动；</span></span><br><span class="line"><span class="comment"> * - 会自动加入全局 abortPool，方便统一取消；</span></span><br><span class="line"><span class="comment"> * - 调用方需在请求完成/失败时调用 releaseController 释放。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">makeTrackedController</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">externalSignal</span>?: <span class="title class_">AbortSignal</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">AbortController</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> controller = <span class="keyword">new</span> <span class="title class_">AbortController</span>();</span><br><span class="line">  <span class="title function_">linkExternalSignal</span>(externalSignal, controller);</span><br><span class="line">  abortPool.<span class="title function_">add</span>(controller);</span><br><span class="line">  <span class="keyword">return</span> controller;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 将 controller 从取消池释放（请求完成/失败时务必调用，避免内存泄漏） */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">releaseController</span>(<span class="params"><span class="attr">controller</span>?: <span class="title class_">AbortController</span></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (controller) abortPool.<span class="title function_">delete</span>(controller);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 退出登录或全局重置时：集中取消所有未决请求 */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">cancelAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">  abortPool.<span class="title function_">forEach</span>(<span class="function">(<span class="params">c</span>) =&gt;</span> c.<span class="title function_">abort</span>());</span><br><span class="line">  abortPool.<span class="title function_">clear</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="2-在-client-ts-中的最小改动"><a href="#2-在-client-ts-中的最小改动" class="headerlink" title="2) 在 client.ts 中的最小改动"></a>2) 在 <code>client.ts</code> 中的<strong>最小改动</strong></h2><blockquote>
<p>按你的偏好，这里<strong>只给需要改的片段</strong>，并在复杂逻辑上一行加注释。</p>
</blockquote>
<p><strong>2.1 顶部引入：</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// + 新增</span></span><br><span class="line"><span class="keyword">import</span> &#123; makeTrackedController, releaseController, cancelAll &#125; <span class="keyword">from</span> <span class="string">&quot;./cancel&quot;</span>;</span><br></pre></td></tr></table></figure>

<p><strong>2.2 删除原本在 client.ts 里的这两段：</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// - 删除</span></span><br><span class="line"><span class="keyword">const</span> abortPool = <span class="keyword">new</span> <span class="title class_">Set</span>&lt;<span class="title class_">AbortController</span>&gt;();</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">cancelAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">/* ...原实现... */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2.3 请求拦截器里替换创建&#x2F;管理 controller 的逻辑：</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// —— 将外部 signal 与内部 AbortController 关联，并纳入统一取消池 ——</span></span><br><span class="line"><span class="keyword">const</span> abortController = <span class="title function_">makeTrackedController</span>(</span><br><span class="line">  (req <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">signal</span> <span class="keyword">as</span> <span class="title class_">AbortSignal</span> | <span class="literal">undefined</span></span><br><span class="line">);</span><br><span class="line">(req <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">signal</span> = abortController.<span class="property">signal</span>;</span><br><span class="line">(req <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">__abortController</span> = abortController;</span><br></pre></td></tr></table></figure>

<p><strong>2.4 响应与异常分支里释放 controller：</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// —— 请求完成：释放与该请求关联的 AbortController ——</span></span><br><span class="line"><span class="title function_">releaseController</span>(</span><br><span class="line">  (res.<span class="property">config</span> <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">__abortController</span> <span class="keyword">as</span> <span class="title class_">AbortController</span> | <span class="literal">undefined</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// —— 异常完成：同样需要释放 AbortController ——</span></span><br><span class="line"><span class="title function_">releaseController</span>(</span><br><span class="line">  (err?.<span class="property">config</span> <span class="keyword">as</span> <span class="built_in">any</span>)?.<span class="property">__abortController</span> <span class="keyword">as</span> <span class="title class_">AbortController</span> | <span class="literal">undefined</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><strong>2.5 保持对外暴露实例方法：</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实例级的取消功能依然可用</span></span><br><span class="line">(_axios <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">cancelAll</span> = cancelAll;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样，取消逻辑就从 <code>client.ts</code> 拆分到了独立的 <code>cancel.ts</code>，便于复用与测试；<code>client.ts</code> 里只保留“如何在拦截器中使用”的胶水代码。</p>
</blockquote>
<hr>
<h2 id="3-“FormData-自动带-boundary，需移除手动设置的-Content-Type”-是啥意思？"><a href="#3-“FormData-自动带-boundary，需移除手动设置的-Content-Type”-是啥意思？" class="headerlink" title="3) “FormData 自动带 boundary，需移除手动设置的 Content-Type” 是啥意思？"></a>3) “FormData 自动带 boundary，需移除手动设置的 Content-Type” 是啥意思？</h2><ul>
<li><p>当你在<strong>浏览器环境</strong>用 <code>FormData</code> 作为请求体时，真正发请求的是浏览器（或者 fetch&#x2F;XHR），它会自动把请求头 <code>Content-Type</code> 设置成：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryXyz...</span><br></pre></td></tr></table></figure>

<p>这里的 <code>boundary</code> 是一段<strong>分隔符</strong>，用来把每个字段&#x2F;文件的二进制块分割开。<strong>这个 boundary 是浏览器动态生成的</strong>。</p>
</li>
<li><p><strong>如果你手动把 <code>Content-Type</code> 固定写成 <code>multipart/form-data</code></strong>（没有 <code>boundary=...</code>），服务端收到的内容就<strong>无法正确分段解析</strong>，经常出现 400&#x2F;422 或 “Unexpected end of form &#x2F; Missing boundary” 之类错误。</p>
</li>
<li><p>因此，在我们封装里（<code>contentType === &#39;formdata&#39;</code> 分支）会：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑上一行注释：FormData 让浏览器自动带 boundary，需移除手动设置的 Content-Type</span></span><br><span class="line"><span class="keyword">if</span> (cfg.<span class="property">headers</span>) <span class="title function_">delete</span> (cfg.<span class="property">headers</span> <span class="keyword">as</span> <span class="built_in">any</span>)[<span class="string">&quot;Content-Type&quot;</span>];</span><br><span class="line">cfg.<span class="property">data</span> = body <span class="keyword">instanceof</span> <span class="title class_">FormData</span> ? body : <span class="title function_">toFormData</span>(body <span class="keyword">as</span> <span class="built_in">any</span>);</span><br></pre></td></tr></table></figure>

<p>这么做是<strong>故意</strong>把 <code>Content-Type</code> 删除，让浏览器自己填上带 <code>boundary</code> 的正确值。</p>
</li>
</ul>
<blockquote>
<p>小结：</p>
<ul>
<li><strong>浏览器 + FormData</strong>：不要手写 <code>Content-Type</code>，让它自动带 boundary（我们代码里已处理）。</li>
<li><strong>Node.js 端（无浏览器）</strong>：若用 <code>form-data</code>&#x2F;<code>formdata-node</code> 等库，也应<strong>让库自己设置</strong>或通过库提供的方法拿到带 <code>boundary</code> 的 header，而不是手写。</li>
</ul>
</blockquote>
<hr>
<p>需要我把 <code>client.ts</code> 根据上面的片段<strong>整合成完整文件</strong>再贴一次，也可以说一声；但如果你已经在用我之前给的版本，只要按上面的 4 处小改即可完成 <code>cancel.ts</code> 的接入。</p>
<p>简短结论先给你：</p>
<ul>
<li><strong>Axios 封装没有“唯一正确解”</strong>，但大厂普遍遵循“<strong>分层 + 零破坏 + 渐进演进</strong>”三原则：<br>Core（http 客户端能力）→ Domain API（领域方法）→ View&#x2F;State（查询层）。</li>
<li><strong>TanStack Query（React Query &#x2F; Vue Query）不是必须</strong>。当你的页面需要<strong>缓存、并发去重、重试、后台刷新、预取、分页&#x2F;无限滚动、乐观更新</strong>中的多项时，它的价值非常高；否则可以先不用，等复杂度上来了再加。</li>
</ul>
<p>下面给你一套“可落地的选择题”，帮你快速拍板。</p>
<hr>
<h2 id="一、Axios-封装到底怎么选？"><a href="#一、Axios-封装到底怎么选？" class="headerlink" title="一、Axios 封装到底怎么选？"></a>一、Axios 封装到底怎么选？</h2><h3 id="方案-A：极简封装（Core-少量-Domain-API）"><a href="#方案-A：极简封装（Core-少量-Domain-API）" class="headerlink" title="方案 A：极简封装（Core + 少量 Domain API）"></a>方案 A：<strong>极简封装（Core + 少量 Domain API）</strong></h3><p>适用：后端接口简单、页面少、交互不复杂，或以 <strong>Server Actions&#x2F;Route Handlers（Next.js 14）</strong> 为主、客户端请求很少。<br>要点：</p>
<ul>
<li>Core 层：一个 <code>http</code> 实例（拦截器、取消池、统一错误、鉴权）、<code>http.call(options)</code> 对象式入口（你现在这版 ✅）。</li>
<li>Domain 层：在 <code>src/api/modules/*</code> 里写薄封装函数（避免在页面拼 URL&#x2F;方法）。<br>优点：学习&#x2F;维护成本最低；对现有代码<strong>零破坏</strong>。<br>缺点：项目一复杂，<strong>缓存&#x2F;并发&#x2F;重试</strong>容易重复造轮子。</li>
</ul>
<h3 id="方案-B：标准化封装（Core-Domain-API-代码生成）"><a href="#方案-B：标准化封装（Core-Domain-API-代码生成）" class="headerlink" title="方案 B：标准化封装（Core + Domain API + 代码生成）"></a>方案 B：<strong>标准化封装（Core + Domain API + 代码生成）</strong></h3><p>适用：接口较多、多人协作、需要<strong>强类型</strong>对齐后端（避免“文档&#x2F;实现漂移”）。<br>要点：</p>
<ul>
<li>在 A 的基础上加 <strong>OpenAPI 代码生成</strong>（orval&#x2F;openapi-typescript-codegen），产物放 <code>api/__generated__</code>，<strong>只读、不手改</strong>。</li>
<li>Domain 层再包一层“门面”，统一错误处理&#x2F;埋点&#x2F;灰度。<br>优点：类型和接口更新<strong>自动跟进</strong>；减少手抄 DTO。<br>缺点：引入生成链路，需要后端提供&#x2F;维护 OpenAPI。</li>
</ul>
<h3 id="方案-C：企业级（Core-Domain-代码生成-查询层-TanStack）"><a href="#方案-C：企业级（Core-Domain-代码生成-查询层-TanStack）" class="headerlink" title="方案 C：企业级（Core + Domain + 代码生成 + 查询层 TanStack）"></a>方案 C：<strong>企业级（Core + Domain + 代码生成 + 查询层 TanStack）</strong></h3><p>适用：<strong>列表&#x2F;详情很多</strong>、需要<strong>缓存&#x2F;失效&#x2F;后台刷新&#x2F;并发去重&#x2F;预取&#x2F;SSR</strong>等能力；或你已经遇到“重复请求、抖动、复杂 loading 状态”问题。<br>要点：</p>
<ul>
<li>在 B 的基础上引入 <strong>TanStack Query（React）&#x2F;Vue Query（Vue3）</strong> 做服务端状态管理。</li>
<li>页面里不直接 <code>http.call</code>，而是用 <code>useQuery/useMutation</code> 调你封装好的 Domain API。<br>优点：把“<strong>缓存&#x2F;并发&#x2F;重试&#x2F;错误边界&#x2F;重整化</strong>”交给成熟库，页面只管渲染。<br>缺点：学习成本 ↑，需要 Provider 初始化与查询键设计。</li>
</ul>
<hr>
<h2 id="二、到底要不要用-TanStack-Query？（自测-8-题）"><a href="#二、到底要不要用-TanStack-Query？（自测-8-题）" class="headerlink" title="二、到底要不要用 TanStack Query？（自测 8 题）"></a>二、到底要不要用 TanStack Query？（自测 8 题）</h2><p>请数一数你满足了多少条（≥3 条就<strong>建议上</strong>）：</p>
<ol>
<li>同一数据被<strong>多处页面&#x2F;组件复用</strong>，且你想要<strong>共享缓存</strong>。</li>
<li>同一接口在短时间内可能被<strong>多次触发</strong>（需要<strong>请求去重</strong>）。</li>
<li>希望<strong>失败自动重试</strong>、<strong>退避</strong>，或在<strong>网络恢复</strong>&#x2F;<strong>窗口聚焦</strong>时自动<strong>后台刷新</strong>。</li>
<li>有<strong>分页&#x2F;无限滚动</strong>，并且要处理<strong>下一页预取</strong>或<strong>乐观更新</strong>。</li>
<li>需要<strong>预取数据</strong>（用户悬停&#x2F;路由即将跳转时先打请求）。</li>
<li>你在做 <strong>Next.js 14</strong> 前端页面，既有 <strong>Server Components</strong> 也有 <strong>Client Components</strong>，客户端数据要<strong>SSR Hydration</strong> 或 <strong>延迟刷新</strong>。</li>
<li>想<strong>显式管理缓存过期（staleTime）</strong> 与 <strong>垃圾回收（gcTime）</strong>，防止反复打接口。</li>
<li>现在已经在手写“请求缓存&#x2F;合流&#x2F;状态机”，感觉<strong>心智负担</strong>上来了。</li>
</ol>
<blockquote>
<p>结合你的项目：有<strong>价格趋势</strong>、<strong>多商店选择</strong>、<strong>首页与详情复用价格数据</strong>、后续还要<strong>图表&#x2F;列表</strong>，我建议：</p>
<ul>
<li>在<strong>这些“读多写少”的模块</strong>上用 TanStack Query；</li>
<li>其他简单页面（一次性拉取、无复杂刷新），继续用现在的 <code>http.call</code> 即可。<br>这样“<strong>按需引入</strong>”，增量演进，不会一刀切。</li>
</ul>
</blockquote>
<hr>
<h2 id="三、你现在的最佳落地路线（最少折腾）"><a href="#三、你现在的最佳落地路线（最少折腾）" class="headerlink" title="三、你现在的最佳落地路线（最少折腾）"></a>三、你现在的最佳落地路线（最少折腾）</h2><ol>
<li><p><strong>保留现有 http 层（你已完成）</strong></p>
<ul>
<li><code>client.ts + cancel.ts + call.ts + types.ts + utils.ts</code>，不覆盖 <code>axios.request</code>，<strong>零破坏</strong>保留 <code>get/post</code>。</li>
</ul>
</li>
<li><p><strong>Domain API 薄封装</strong></p>
<ul>
<li>在 <code>src/api/modules/*</code> 暴露语义化函数（<code>priceApi.getTrend</code>等），页面不拼 URL。</li>
</ul>
</li>
<li><p><strong>对“需要缓存&#x2F;并发去重”的模块上 TanStack Query</strong></p>
<ul>
<li>只在“价格趋势、榜单、列表”这些位置用 Query，其它模块不强求。</li>
</ul>
</li>
<li><p><strong>后续再接 OpenAPI 代码生成</strong>（可选）</p>
<ul>
<li>先让 Query 跑顺，再把类型维护成本转移给生成器，逐步替换手写 DTO。</li>
</ul>
</li>
<li><p><strong>MSW 做联调与测试</strong>（可选）</p>
<ul>
<li>本地&#x2F;CI 统一拦截，减少后端不可用带来的卡点。</li>
</ul>
</li>
</ol>
<hr>
<h2 id="四、常见误区（避免踩坑）"><a href="#四、常见误区（避免踩坑）" class="headerlink" title="四、常见误区（避免踩坑）"></a>四、常见误区（避免踩坑）</h2><ul>
<li><strong>覆写 <code>axios.request</code></strong> → 破坏 <code>get/post</code> 的语义（你已经改成 <code>.call</code>，很对）。</li>
<li><strong>手写 <code>Content-Type: multipart/form-data</code></strong> → FormData 的 <code>boundary</code> 会丢（我们已在 <code>formdata</code> 分支删除该头，让浏览器自动带）。</li>
<li><strong>在组件里定义 DTO&#x2F;类型</strong> → 类型四散；建议集中到 <code>types/http/*</code> 与 <code>api/__generated__</code>。</li>
<li><strong>重复写缓存&#x2F;重试&#x2F;去重</strong> → 已有成熟轮子（TanStack Query）；自己写容易遗漏边角。</li>
<li><strong>取消控制器不释放</strong> → 造成内存泄漏；我们用 <code>releaseController</code> 在响应&#x2F;异常两侧都释放。</li>
</ul>
<hr>
<h2 id="五、如果暂时不用-TanStack-Query，也能稳住吗？"><a href="#五、如果暂时不用-TanStack-Query，也能稳住吗？" class="headerlink" title="五、如果暂时不用 TanStack Query，也能稳住吗？"></a>五、如果暂时不用 TanStack Query，也能稳住吗？</h2><p>可以。你的 <code>http.call + modules</code> 架构，配合**轻量的自定义缓存（Map + 过期时间）**也能顶一阵子。但一旦出现“<strong>相同查询在多处使用</strong>”、“<strong>滚动列表&#x2F;分页</strong>”、“<strong>需要重试与后台刷新</strong>”的需求，<strong>切到 TanStack Query 成本更低</strong>（只需把 Domain API 包进 <code>useQuery</code>），没必要造大轮子。</p>
<hr>
<h3 id="你现在可以怎么做（两步）："><a href="#你现在可以怎么做（两步）：" class="headerlink" title="你现在可以怎么做（两步）："></a>你现在可以怎么做（两步）：</h3><ul>
<li><strong>短期</strong>：继续用现有封装；把价格趋势这块接入 Query（仅此一处），体会收益。</li>
<li><strong>中期</strong>：如果感觉不错，再把“新闻列表&#x2F;攻略列表”等也迁到 Query；并考虑引入 OpenAPI 代码生成，降低类型维护成本。</li>
</ul>
<p>需要的话，我可以基于你现有的模块，直接给出<strong>一个最小的 TanStack Query 集成示例</strong>（包含 Provider、<code>useQuery</code> 的示例调用、SSR Hydration 的注意点），只贴<strong>必要的代码片段</strong>，不改你现有文件结构。</p>
<p>结论：<strong>你的“核心响应拦截器”（释放 AbortController + 401 跳转）先执行，<code>setGlobalParser</code> 里注册的“全局解析器”后执行</strong>。</p>
<p>原因（Axios 规则）：</p>
<ul>
<li><strong>response 拦截器是 FIFO</strong>：谁<strong>先注册</strong>，谁<strong>先执行</strong>。</li>
<li><strong>request 拦截器是 LIFO</strong>：谁<strong>后注册</strong>，谁<strong>先执行</strong>。（顺带一提）</li>
</ul>
<p>在你这份代码里：</p>
<ol>
<li><code>createAxiosHttp</code> 里先注册了“核心响应拦截器”。</li>
<li>应用启动时再调用 <code>http.setGlobalParser([...])</code>，此时<strong>追加</strong>一个响应拦截器。<br>→ 因为 response 是 FIFO，所以<strong>核心拦截器先跑</strong>，<strong>全局解析器后跑</strong>。</li>
</ol>
<p>执行顺序具体是：</p>
<ul>
<li><p><strong>成功响应路径 (<code>fulfilled</code>)</strong><br>① 核心响应拦截器：<code>releaseController(...)</code> → <code>return res</code><br>② 全局解析器：遍历 parsers，可能把 <code>AxiosResponse</code> 解包成你的业务数据（或继续返回原响应）</p>
</li>
<li><p><strong>失败响应路径 (<code>rejected</code>)</strong><br>① 核心响应拦截器：遇到 <code>401</code> 清 token + 跳登录；不管什么错误都先 <code>releaseController(...)</code>；<code>return Promise.reject(err)</code><br>② 全局解析器：拿到上一步抛出的 <code>err</code>，再做标准化&#x2F;改写错误对象（如果你这么实现）</p>
</li>
</ul>
<blockquote>
<p>小提示：如果你<strong>想让全局解析器先执行</strong>，就必须<strong>更早注册</strong>它（例如把 <code>setGlobalParser</code> 的安装逻辑挪到 <code>createAxiosHttp</code> 里、并放在核心拦截器之前），或者在核心拦截器内部先调用解析器再做释放&#x2F;跳转。但你当前这种“先释放&#x2F;401，再解析”的顺序其实更稳：能确保无论成功还是失败，<strong>先释放资源</strong>再做业务级处理，避免泄漏。</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/06/%E3%80%8C%E8%AF%B7%E6%B1%82%E5%B1%82%E5%A4%A7%E9%87%8D%E6%9E%84%E3%80%8D%E2%80%94%E2%80%94%E4%BB%8E%E6%95%A3%E4%B9%B1%E5%88%B0%E4%BC%81%E4%B8%9A%E7%BA%A7%EF%BC%9A%E7%B1%BB%E5%9E%8B%E3%80%81%E7%9B%AE%E5%BD%95%E4%B8%8E%E6%BC%94%E8%BF%9B%E8%B7%AF%E7%BA%BF/" data-id="cmf9bdhkm000oqq4z6x9244qt" data-title="「请求层大重构」——从散乱到企业级：类型、目录与演进路线" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Axios/" rel="tag">Axios</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MSW/" rel="tag">MSW</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenAPI/" rel="tag">OpenAPI</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TanStack-Query/" rel="tag">TanStack Query</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TypeScript/" rel="tag">TypeScript</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/web%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/">web应用开发</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/web%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E5%89%8D%E7%AB%AF/">前端</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/401/" rel="tag">401</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/AbortController/" rel="tag">AbortController</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Axios/" rel="tag">Axios</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Fetch/" rel="tag">Fetch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GitHub-Pages/" rel="tag">GitHub Pages</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MSW/" rel="tag">MSW</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NexT/" rel="tag">NexT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenAPI/" rel="tag">OpenAPI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Passkeys/" rel="tag">Passkeys</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pinia/" rel="tag">Pinia</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TanStack-Query/" rel="tag">TanStack Query</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript/" rel="tag">TypeScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UTS-%E6%8F%92%E4%BB%B6/" rel="tag">UTS 插件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vite/" rel="tag">Vite</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue-3/" rel="tag">Vue 3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue-Router/" rel="tag">Vue Router</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue3/" rel="tag">Vue3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebAuthn/" rel="tag">WebAuthn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/composable/" rel="tag">composable</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rollup-plugin-visualizer/" rel="tag">rollup-plugin-visualizer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/store%E8%AF%B7%E6%B1%82/" rel="tag">store请求</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uni-app-x/" rel="tag">uni-app x</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%80%E9%94%AE%E7%9B%B4%E7%99%BB/" rel="tag">一键直登</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%8B%E8%BD%BD/" rel="tag">下载</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E7%B1%BB/" rel="tag">分类</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%9D%E5%A7%8B%E5%8C%96/" rel="tag">初始化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF/" rel="tag">前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E6%9E%B6%E6%9E%84/" rel="tag">前端架构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%AF%E4%BD%9C%E7%94%A8%E6%8E%A7%E5%88%B6/" rel="tag">副作用控制</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%9A%E5%AE%A2/" rel="tag">博客</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%A7%E5%8E%82%E5%AE%9E%E8%B7%B5/" rel="tag">大厂实践</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%89%93%E5%8C%85%E5%88%86%E6%9E%90/" rel="tag">打包分析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%AA%E7%99%BB%E5%BD%95%E6%8B%A6%E6%88%AA/" rel="tag">未登录拦截</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%9B%AE%E5%BD%95/" rel="tag">目录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95/" rel="tag">退出登录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%89%B4%E6%9D%83/" rel="tag">鉴权</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/401/" style="font-size: 10px;">401</a> <a href="/tags/AbortController/" style="font-size: 10px;">AbortController</a> <a href="/tags/Axios/" style="font-size: 20px;">Axios</a> <a href="/tags/Fetch/" style="font-size: 10px;">Fetch</a> <a href="/tags/GitHub-Pages/" style="font-size: 15px;">GitHub Pages</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/MSW/" style="font-size: 10px;">MSW</a> <a href="/tags/NexT/" style="font-size: 10px;">NexT</a> <a href="/tags/OpenAPI/" style="font-size: 10px;">OpenAPI</a> <a href="/tags/Passkeys/" style="font-size: 10px;">Passkeys</a> <a href="/tags/Pinia/" style="font-size: 20px;">Pinia</a> <a href="/tags/TanStack-Query/" style="font-size: 10px;">TanStack Query</a> <a href="/tags/TypeScript/" style="font-size: 20px;">TypeScript</a> <a href="/tags/UTS-%E6%8F%92%E4%BB%B6/" style="font-size: 10px;">UTS 插件</a> <a href="/tags/Vite/" style="font-size: 10px;">Vite</a> <a href="/tags/Vue-3/" style="font-size: 10px;">Vue 3</a> <a href="/tags/Vue-Router/" style="font-size: 10px;">Vue Router</a> <a href="/tags/Vue3/" style="font-size: 15px;">Vue3</a> <a href="/tags/WebAuthn/" style="font-size: 10px;">WebAuthn</a> <a href="/tags/composable/" style="font-size: 10px;">composable</a> <a href="/tags/rollup-plugin-visualizer/" style="font-size: 10px;">rollup-plugin-visualizer</a> <a href="/tags/store%E8%AF%B7%E6%B1%82/" style="font-size: 10px;">store请求</a> <a href="/tags/uni-app-x/" style="font-size: 10px;">uni-app x</a> <a href="/tags/%E4%B8%80%E9%94%AE%E7%9B%B4%E7%99%BB/" style="font-size: 10px;">一键直登</a> <a href="/tags/%E4%B8%8B%E8%BD%BD/" style="font-size: 10px;">下载</a> <a href="/tags/%E5%88%86%E7%B1%BB/" style="font-size: 10px;">分类</a> <a href="/tags/%E5%88%9D%E5%A7%8B%E5%8C%96/" style="font-size: 10px;">初始化</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 10px;">前端</a> <a href="/tags/%E5%89%8D%E7%AB%AF%E6%9E%B6%E6%9E%84/" style="font-size: 10px;">前端架构</a> <a href="/tags/%E5%89%AF%E4%BD%9C%E7%94%A8%E6%8E%A7%E5%88%B6/" style="font-size: 10px;">副作用控制</a> <a href="/tags/%E5%8D%9A%E5%AE%A2/" style="font-size: 10px;">博客</a> <a href="/tags/%E5%A4%A7%E5%8E%82%E5%AE%9E%E8%B7%B5/" style="font-size: 10px;">大厂实践</a> <a href="/tags/%E6%89%93%E5%8C%85%E5%88%86%E6%9E%90/" style="font-size: 10px;">打包分析</a> <a href="/tags/%E6%9C%AA%E7%99%BB%E5%BD%95%E6%8B%A6%E6%88%AA/" style="font-size: 10px;">未登录拦截</a> <a href="/tags/%E7%9B%AE%E5%BD%95/" style="font-size: 10px;">目录</a> <a href="/tags/%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95/" style="font-size: 10px;">退出登录</a> <a href="/tags/%E9%89%B4%E6%9D%83/" style="font-size: 10px;">鉴权</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/09/">September 2025</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/09/07/id-kit%E5%BC%80%E5%8F%91/">id-kit开发</a>
          </li>
        
          <li>
            <a href="/2025/09/07/id-kit/">id-kit</a>
          </li>
        
          <li>
            <a href="/2025/09/07/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2025/09/06/%E7%99%BB%E5%BD%95%E5%90%8E%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E5%8F%8C%E9%98%B6%E6%AE%B5%E5%90%AF%E5%8A%A8%EF%BC%88%E5%A2%9E%E9%87%8F%E4%BF%AE%E6%94%B9%EF%BC%89/">在 composable 里“公共初始化 + 登录后初始化”的双阶段启动（增量修改）</a>
          </li>
        
          <li>
            <a href="/2025/09/06/%E4%BD%93%E7%A7%AF%E5%88%86%E5%B8%83%E5%88%86%E6%9E%90%E5%9B%BE/">Vite + Vue3 打包后如何查看“体积分布分析图”</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>