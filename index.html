<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://herongdev.github.io/blog/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/blog/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/blog/favicon.png">
  
  
  
<link rel="stylesheet" href="/blog/css/style.css">

  
    
<link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/blog/">Home</a>
        
          <a class="main-nav-link" href="/blog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/blog/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://herongdev.github.io/blog"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-hello-world" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2025/09/08/hello-world/" class="article-date">
  <time class="dt-published" datetime="2025-09-08T01:58:24.956Z" itemprop="datePublished">2025-09-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2025/09/08/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/08/hello-world/" data-id="cmfah3dpd000ao04zbuy4d6fc" data-title="Hello World" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-需求实现/登录鉴权/Passkeys：options" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2025/09/08/%E9%9C%80%E6%B1%82%E5%AE%9E%E7%8E%B0/%E7%99%BB%E5%BD%95%E9%89%B4%E6%9D%83/Passkeys%EF%BC%9Aoptions/" class="article-date">
  <time class="dt-published" datetime="2025-09-08T00:33:31.000Z" itemprop="datePublished">2025-09-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2025/09/08/%E9%9C%80%E6%B1%82%E5%AE%9E%E7%8E%B0/%E7%99%BB%E5%BD%95%E9%89%B4%E6%9D%83/Passkeys%EF%BC%9Aoptions/">WebAuthn Passkeys：options 全字段长啥样？取值有哪些？（simplewebauthn v11+ 实战）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>适用版本：<strong>@simplewebauthn&#x2F;server v11+</strong><br>重点变化：<code>pubKeyCredParams</code> ➜ <code>supportedAlgorithmIDs</code>；注册验证结果中的 <code>credentialID/credentialPublicKey</code> ➜ 移到 <code>registrationInfo.credential</code>。</p>
</blockquote>
<h1 id="一、两类-options-是什么？"><a href="#一、两类-options-是什么？" class="headerlink" title="一、两类 options 是什么？"></a>一、两类 options 是什么？</h1><ul>
<li><p><strong>注册（Creation）</strong>：发给前端 <code>navigator.credentials.create(&#123; publicKey &#125;)</code> 的参数</p>
<ul>
<li>服务器生成：<code>generateRegistrationOptions(opts)</code></li>
<li>前端收到的是 <strong>PublicKeyCredentialCreationOptions(JSON)</strong></li>
</ul>
</li>
<li><p><strong>登录（Request&#x2F;Assertion）</strong>：发给前端 <code>navigator.credentials.get(&#123; publicKey &#125;)</code> 的参数</p>
<ul>
<li>服务器生成：<code>generateAuthenticationOptions(opts)</code></li>
<li>前端收到的是 <strong>PublicKeyCredentialRequestOptions(JSON)</strong></li>
</ul>
</li>
</ul>
<blockquote>
<p>前端 JSON 里的 <code>challenge</code> &#x2F; <code>user.id</code> 等，通常是 <strong>base64url</strong> 字符串；服务端入参多数用 <strong>Buffer&#x2F;Uint8Array</strong>。</p>
</blockquote>
<h1 id="二、注册：服务端入参-前端-options-全量长相"><a href="#二、注册：服务端入参-前端-options-全量长相" class="headerlink" title="二、注册：服务端入参 &amp; 前端 options 全量长相"></a>二、注册：服务端入参 &amp; 前端 options 全量长相</h1><h2 id="2-1-服务端入参（generateRegistrationOptions-opts-）"><a href="#2-1-服务端入参（generateRegistrationOptions-opts-）" class="headerlink" title="2.1 服务端入参（generateRegistrationOptions(opts)）"></a>2.1 服务端入参（<code>generateRegistrationOptions(opts)</code>）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> options = <span class="keyword">await</span> <span class="title function_">generateRegistrationOptions</span>(&#123;</span><br><span class="line">  <span class="comment">// —— RP（你的站点） ——</span></span><br><span class="line">  <span class="attr">rpName</span>: <span class="string">&quot;Shop Thrive&quot;</span>, <span class="comment">// 展示名（弹窗可见）</span></span><br><span class="line">  <span class="attr">rpID</span>: <span class="string">&quot;example.com&quot;</span>, <span class="comment">// RP ID（域名，需与前端同源后缀匹配）</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// —— 用户信息（必须） ——</span></span><br><span class="line">  <span class="comment">// 注意：userID 必须是字节数组（Uint8Array/Buffer），不是 string</span></span><br><span class="line">  <span class="attr">userID</span>: <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;user-123&quot;</span>, <span class="string">&quot;utf8&quot;</span>),</span><br><span class="line">  <span class="attr">userName</span>: <span class="string">&quot;user-123&quot;</span>, <span class="comment">// 可读名（设备 UI 展示）</span></span><br><span class="line">  <span class="attr">userDisplayName</span>: <span class="string">&quot;Alice Zhang&quot;</span>, <span class="comment">// 可选；不传时库会处理</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// —— 安全策略 ——</span></span><br><span class="line">  <span class="comment">// v11+：用 supportedAlgorithmIDs 指定算法（替代 pubKeyCredParams）</span></span><br><span class="line">  <span class="comment">// 常用：-7=ES256；如需兼容更广，可加 -257=RS256/-8=EdDSA 等</span></span><br><span class="line">  <span class="attr">supportedAlgorithmIDs</span>: [-<span class="number">7</span>, -<span class="number">257</span>],</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 要求/偏好做本地用户验证（UV：指纹/人脸/PIN）</span></span><br><span class="line">  <span class="comment">// &#x27;required&#x27; | &#x27;preferred&#x27; | &#x27;discouraged&#x27;</span></span><br><span class="line">  <span class="attr">userVerification</span>: <span class="string">&quot;required&quot;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 选择哪类认证器与凭证形态</span></span><br><span class="line">  <span class="attr">authenticatorSelection</span>: &#123;</span><br><span class="line">    <span class="comment">// &#x27;platform&#x27;（本机/系统）| &#x27;cross-platform&#x27;（外接/钥匙）| 不填（都可）</span></span><br><span class="line">    <span class="attr">authenticatorAttachment</span>: <span class="string">&quot;platform&quot;</span>,</span><br><span class="line">    <span class="comment">// 要不要可发现凭证（resident key），用于“无用户名一键登录”</span></span><br><span class="line">    <span class="comment">// &#x27;required&#x27; | &#x27;preferred&#x27; | &#x27;discouraged&#x27;</span></span><br><span class="line">    <span class="attr">residentKey</span>: <span class="string">&quot;required&quot;</span>,</span><br><span class="line">    <span class="comment">// 旧字段（某些库还在）：requireResidentKey: true,</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 证明链/隐私：&#x27;none&#x27; | &#x27;indirect&#x27; | &#x27;direct&#x27; | &#x27;enterprise&#x27;</span></span><br><span class="line">  <span class="attr">attestationType</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// —— 体验/兼容 ——</span></span><br><span class="line">  <span class="attr">timeout</span>: <span class="number">60_000</span>, <span class="comment">// 毫秒</span></span><br><span class="line">  <span class="attr">excludeCredentials</span>: [</span><br><span class="line">    <span class="comment">// 防重复注册（可选）</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">id</span>: <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;...&quot;</span>, <span class="string">&quot;base64url&quot;</span>),</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&quot;public-key&quot;</span>,</span><br><span class="line">      <span class="attr">transports</span>: [<span class="string">&quot;internal&quot;</span>, <span class="string">&quot;usb&quot;</span>],</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  <span class="comment">// —— 扩展（按需） ——</span></span><br><span class="line">  <span class="attr">extensions</span>: &#123;</span><br><span class="line">    <span class="attr">credProps</span>: <span class="literal">true</span>, <span class="comment">// 要求返回“是否可发现凭证”等属性</span></span><br><span class="line">    <span class="comment">// largeBlob: &#123; support: &#x27;required&#x27; | &#x27;preferred&#x27; &#125;,</span></span><br><span class="line">    <span class="comment">// hmacCreateSecret: true,</span></span><br><span class="line">    <span class="comment">// // 老 FIDO 兼容场景：</span></span><br><span class="line">    <span class="comment">// appidExclude: &#x27;https://example.com&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="COSE-算法常用映射"><a href="#COSE-算法常用映射" class="headerlink" title="COSE 算法常用映射"></a>COSE 算法常用映射</h3><table>
<thead>
<tr>
<th>ID</th>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>-7</strong></td>
<td>ES256</td>
<td>ECDSA w&#x2F; SHA-256（最常用，passkey 默认）</td>
</tr>
<tr>
<td><strong>-257</strong></td>
<td>RS256</td>
<td>RSA w&#x2F; SHA-256（更广兼容）</td>
</tr>
<tr>
<td><strong>-8</strong></td>
<td>EdDSA</td>
<td>常见为 Ed25519（浏览器&#x2F;平台支持度差异较大）</td>
</tr>
<tr>
<td>-35 &#x2F; -36</td>
<td>ES384 &#x2F; ES512</td>
<td>更高位椭圆曲线</td>
</tr>
<tr>
<td>-38 &#x2F; -39 &#x2F; -40</td>
<td>PS256 &#x2F; PS384 &#x2F; PS512</td>
<td>RSA-PSS 系列</td>
</tr>
</tbody></table>
<blockquote>
<p>生产一般 <code>[-7]</code> 足够；如有老设备需求，可加 <code>-257</code>。</p>
</blockquote>
<hr>
<h2 id="2-2-前端收到的-注册-options（完整-JSON-示例）"><a href="#2-2-前端收到的-注册-options（完整-JSON-示例）" class="headerlink" title="2.2 前端收到的 注册 options（完整 JSON 示例）"></a>2.2 前端收到的 <strong>注册 options（完整 JSON 示例）</strong></h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;rp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Shop Thrive&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;example.com&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dXNlci0xMjM&quot;</span><span class="punctuation">,</span> <span class="comment">// base64url（服务端 userID 的 JSON 形式）</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user-123&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;displayName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Alice Zhang&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;challenge&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9P0mB1o0f1...Q&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pubKeyCredParams&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="comment">// 注意：这是浏览器原生结构；simplewebauthn 已根据 supportedAlgorithmIDs 生成</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;public-key&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;alg&quot;</span><span class="punctuation">:</span> <span class="number">-7</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;public-key&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;alg&quot;</span><span class="punctuation">:</span> <span class="number">-257</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timeout&quot;</span><span class="punctuation">:</span> <span class="number">60000</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;attestation&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;authenticatorSelection&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;authenticatorAttachment&quot;</span><span class="punctuation">:</span> <span class="string">&quot;platform&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;residentKey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;required&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;userVerification&quot;</span><span class="punctuation">:</span> <span class="string">&quot;required&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;excludeCredentials&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;public-key&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;...&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;transports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;internal&quot;</span><span class="punctuation">,</span> <span class="string">&quot;usb&quot;</span><span class="punctuation">]</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;extensions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;credProps&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>实际上浏览器可能省略部分可选字段；<strong>你看到的字段少，不代表“没生效”</strong>，很多值有默认行为。</p>
</blockquote>
<h1 id="三、登录：服务端入参-前端-options-全量长相"><a href="#三、登录：服务端入参-前端-options-全量长相" class="headerlink" title="三、登录：服务端入参 &amp; 前端 options 全量长相"></a>三、登录：服务端入参 &amp; 前端 options 全量长相</h1><h2 id="3-1-服务端入参（generateAuthenticationOptions-opts-）"><a href="#3-1-服务端入参（generateAuthenticationOptions-opts-）" class="headerlink" title="3.1 服务端入参（generateAuthenticationOptions(opts)）"></a>3.1 服务端入参（<code>generateAuthenticationOptions(opts)</code>）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> options = <span class="keyword">await</span> <span class="title function_">generateAuthenticationOptions</span>(&#123;</span><br><span class="line">  <span class="comment">// —— 基本项 ——</span></span><br><span class="line">  <span class="attr">rpID</span>: <span class="string">&quot;example.com&quot;</span>,</span><br><span class="line">  <span class="attr">timeout</span>: <span class="number">60_000</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// —— UV 要求 ——</span></span><br><span class="line">  <span class="comment">// &#x27;required&#x27; | &#x27;preferred&#x27; | &#x27;discouraged&#x27;</span></span><br><span class="line">  <span class="attr">userVerification</span>: <span class="string">&quot;preferred&quot;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// —— 可选：指定可用凭证（有用户名场景）</span></span><br><span class="line">  <span class="comment">// 省略则启用“可发现凭证”（一键直登：浏览器列出该站点可用 passkey）</span></span><br><span class="line">  <span class="attr">allowCredentials</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">id</span>: <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;credential-id-base64url&quot;</span>, <span class="string">&quot;base64url&quot;</span>),</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&quot;public-key&quot;</span>,</span><br><span class="line">      <span class="attr">transports</span>: [<span class="string">&quot;internal&quot;</span>, <span class="string">&quot;usb&quot;</span>, <span class="string">&quot;nfc&quot;</span>, <span class="string">&quot;ble&quot;</span>, <span class="string">&quot;hybrid&quot;</span>], <span class="comment">// 按需</span></span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  <span class="comment">// —— 扩展（按需） ——</span></span><br><span class="line">  <span class="attr">extensions</span>: &#123;</span><br><span class="line">    <span class="comment">// uvm: true,                    // 请求返回用户验证方式矩阵（支持时）</span></span><br><span class="line">    <span class="comment">// appid: &#x27;https://example.com&#x27; // 老 FIDO 兼容</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="transports-可能值"><a href="#transports-可能值" class="headerlink" title="transports 可能值"></a><code>transports</code> 可能值</h3><ul>
<li><code>usb</code> &#x2F; <code>nfc</code> &#x2F; <code>ble</code>：外接钥匙传输方式</li>
<li><code>internal</code>：平台认证器（如 iOS&#x2F;Android&#x2F;Windows 内置）</li>
<li><code>cable</code> &#x2F; <code>hybrid</code>：跨设备传输（手机帮电脑解锁的流程）</li>
</ul>
<hr>
<h2 id="3-2-前端收到的-登录-options（完整-JSON-示例）"><a href="#3-2-前端收到的-登录-options（完整-JSON-示例）" class="headerlink" title="3.2 前端收到的 登录 options（完整 JSON 示例）"></a>3.2 前端收到的 <strong>登录 options（完整 JSON 示例）</strong></h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;rpId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;example.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;challenge&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jOr8QL_ExSr_7xsD2WUG1Kp8eM2lMiWNx8fFMg5wLyg&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timeout&quot;</span><span class="punctuation">:</span> <span class="number">60000</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;userVerification&quot;</span><span class="punctuation">:</span> <span class="string">&quot;preferred&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;allowCredentials&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;public-key&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;...&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;transports&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;internal&quot;</span><span class="punctuation">,</span> <span class="string">&quot;hybrid&quot;</span><span class="punctuation">]</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;extensions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;uvm&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>条件式 UI（passkeys 一键直登）</strong>：这是 <code>navigator.credentials.get()</code> 的<strong>第二个参数</strong>里的 <code>mediation: &#39;conditional&#39;</code>，<strong>不在</strong> <code>publicKey</code> 这个 JSON 里。<br>形如：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">navigator.<span class="property">credentials</span>.<span class="title function_">get</span>(&#123; <span class="attr">publicKey</span>: options, <span class="attr">mediation</span>: <span class="string">&quot;conditional&quot;</span> &#125;);</span><br></pre></td></tr></table></figure></blockquote>
<hr>
<h1 id="四、关键字段取值解释（速查表）"><a href="#四、关键字段取值解释（速查表）" class="headerlink" title="四、关键字段取值解释（速查表）"></a>四、关键字段取值解释（速查表）</h1><h2 id="4-1-userVerification"><a href="#4-1-userVerification" class="headerlink" title="4.1 userVerification"></a>4.1 <code>userVerification</code></h2><table>
<thead>
<tr>
<th>值</th>
<th>含义</th>
<th>推荐</th>
</tr>
</thead>
<tbody><tr>
<td><code>required</code></td>
<td>必须进行本地用户验证（指纹&#x2F;人脸&#x2F;PIN）；不支持 UV 的认证器会被排除</td>
<td><strong>后台&#x2F;金融</strong> 强烈推荐</td>
</tr>
<tr>
<td><code>preferred</code></td>
<td>优先进行 UV；不支持也可继续</td>
<td><strong>通用登录</strong> 默认</td>
</tr>
<tr>
<td><code>discouraged</code></td>
<td>不鼓励 UV</td>
<td>不推荐用于登录</td>
</tr>
</tbody></table>
<blockquote>
<p><strong>服务端也要对应开启</strong>：<code>verifyRegistrationResponse/verifyAuthenticationResponse(&#123; requireUserVerification: true &#125;)</code> 才算真正强制。</p>
</blockquote>
<h2 id="4-2-authenticatorSelection"><a href="#4-2-authenticatorSelection" class="headerlink" title="4.2 authenticatorSelection"></a>4.2 <code>authenticatorSelection</code></h2><table>
<thead>
<tr>
<th>字段</th>
<th>值</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>authenticatorAttachment</code></td>
<td><code>platform</code> &#x2F; <code>cross-platform</code></td>
<td>本机认证器 vs 外接钥匙；不填&#x3D;都可</td>
</tr>
<tr>
<td><code>residentKey</code></td>
<td><code>required</code> &#x2F; <code>preferred</code> &#x2F; <code>discouraged</code></td>
<td>是否创建<strong>可发现凭证</strong>（一键直登的前提）</td>
</tr>
<tr>
<td><code>requireResidentKey</code></td>
<td><code>boolean</code></td>
<td>旧字段；等价于 <code>residentKey: &#39;required&#39;</code></td>
</tr>
</tbody></table>
<h2 id="4-3-attestationType（simplewebauthn）"><a href="#4-3-attestationType（simplewebauthn）" class="headerlink" title="4.3 attestationType（simplewebauthn）"></a>4.3 <code>attestationType</code>（simplewebauthn）</h2><table>
<thead>
<tr>
<th>值</th>
<th>说明</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><code>none</code></td>
<td>不收集证明链（隐私友好）</td>
<td><strong>最常用</strong></td>
</tr>
<tr>
<td><code>indirect</code> &#x2F; <code>direct</code></td>
<td>收集不同强度的证明链</td>
<td>较少用</td>
</tr>
<tr>
<td><code>enterprise</code></td>
<td>企业场景</td>
<td>需要配套策略</td>
</tr>
</tbody></table>
<h2 id="4-4-allowCredentials-excludeCredentials（描述符）"><a href="#4-4-allowCredentials-excludeCredentials（描述符）" class="headerlink" title="4.4 allowCredentials &#x2F; excludeCredentials（描述符）"></a>4.4 <code>allowCredentials</code> &#x2F; <code>excludeCredentials</code>（描述符）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="title class_">Uint8Array</span> | <span class="title class_">Buffer</span>,     <span class="comment">// 凭证ID（服务端存 base64url，生成时转回二进制）</span></span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;public-key&#x27;</span>,</span><br><span class="line">  <span class="attr">transports</span>?: (<span class="string">&#x27;usb&#x27;</span>|<span class="string">&#x27;nfc&#x27;</span>|<span class="string">&#x27;ble&#x27;</span>|<span class="string">&#x27;internal&#x27;</span>|<span class="string">&#x27;cable&#x27;</span>|<span class="string">&#x27;hybrid&#x27;</span>)[]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-5-supportedAlgorithmIDs（替代-pubKeyCredParams）"><a href="#4-5-supportedAlgorithmIDs（替代-pubKeyCredParams）" class="headerlink" title="4.5 supportedAlgorithmIDs（替代 pubKeyCredParams）"></a>4.5 <code>supportedAlgorithmIDs</code>（替代 <code>pubKeyCredParams</code>）</h2><ul>
<li>传 <strong>COSE 算法 ID</strong> 数组（见上表）。</li>
<li>浏览器最终在前端 JSON 里仍会以 <code>pubKeyCredParams</code> 形式出现（这是 WebAuthn 原生结构），不冲突。</li>
</ul>
<hr>
<h1 id="五、生产推荐模板"><a href="#五、生产推荐模板" class="headerlink" title="五、生产推荐模板"></a>五、生产推荐模板</h1><h3 id="注册（Creation）"><a href="#注册（Creation）" class="headerlink" title="注册（Creation）"></a>注册（Creation）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="title function_">generateRegistrationOptions</span>(&#123;</span><br><span class="line">  <span class="attr">rpName</span>: <span class="string">&quot;Your App&quot;</span>,</span><br><span class="line">  <span class="attr">rpID</span>: <span class="string">&quot;yourdomain.com&quot;</span>,</span><br><span class="line">  <span class="attr">userID</span>: <span class="title class_">Buffer</span>.<span class="title function_">from</span>(userId, <span class="string">&quot;utf8&quot;</span>),</span><br><span class="line">  <span class="attr">userName</span>: userNameOrEmail,</span><br><span class="line">  <span class="attr">supportedAlgorithmIDs</span>: [-<span class="number">7</span>], <span class="comment">// 如需更广：[-7, -257]</span></span><br><span class="line">  <span class="attr">userVerification</span>: <span class="string">&quot;required&quot;</span>,</span><br><span class="line">  <span class="attr">authenticatorSelection</span>: &#123;</span><br><span class="line">    <span class="attr">authenticatorAttachment</span>: <span class="string">&quot;platform&quot;</span>,</span><br><span class="line">    <span class="attr">residentKey</span>: <span class="string">&quot;required&quot;</span>,</span><br><span class="line">    <span class="attr">userVerification</span>: <span class="string">&quot;required&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">attestationType</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">  <span class="attr">timeout</span>: <span class="number">60_000</span>,</span><br><span class="line">  <span class="comment">// excludeCredentials: [...],      // 防重复注册（可选）</span></span><br><span class="line">  <span class="attr">extensions</span>: &#123; <span class="attr">credProps</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="登录（Request）"><a href="#登录（Request）" class="headerlink" title="登录（Request）"></a>登录（Request）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="title function_">generateAuthenticationOptions</span>(&#123;</span><br><span class="line">  <span class="attr">rpID</span>: <span class="string">&quot;yourdomain.com&quot;</span>,</span><br><span class="line">  <span class="attr">timeout</span>: <span class="number">60_000</span>,</span><br><span class="line">  <span class="attr">userVerification</span>: <span class="string">&quot;required&quot;</span>,</span><br><span class="line">  <span class="comment">// 省略 allowCredentials → 可发现凭证（推荐做“一键直登”）</span></span><br><span class="line">  <span class="comment">// allowCredentials: [...],       // 指定账号登录时使用</span></span><br><span class="line">  <span class="comment">// extensions: &#123; uvm: true &#125;,</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>核心校验与安全实践：</p>
<ol>
<li><strong>challenge</strong> 统一按 <strong>base64url 字符串</strong> 存&#x2F;比；用后删除；短 TTL（≤5 分钟）。</li>
<li><strong>requireUserVerification: true</strong>（服务端）与前端的 <code>userVerification: &#39;required&#39;</code> 配套。</li>
<li>注册时显式 <code>residentKey: &#39;required&#39;</code>，保证后面能做“无用户名一键登录（conditional UI）”。</li>
</ol>
</blockquote>
<hr>
<h1 id="六、常见疑问"><a href="#六、常见疑问" class="headerlink" title="六、常见疑问"></a>六、常见疑问</h1><ul>
<li><strong>为什么我的 <code>options</code> 字段很少？</strong><br>浏览器&#x2F;库会省略默认字段；只要关键项（<code>rpId</code>、<code>challenge</code>、用户&#x2F;算法&#x2F;策略）正确，功能完全等价。</li>
<li><strong><code>challenge</code> 看起来很短，安全吗？</strong><br>默认 32 字节随机数（base64url 后 ≈43 字符）已足够安全。</li>
<li><strong>字段大小写为何不一致？</strong><br>库的<strong>入参</strong>是 <code>rpID</code>、<code>userID</code>（TypeScript 结构）；前端 JSON 是 WebAuthn 原生的 <code>rpId</code>、<code>user.id</code>。库会正确映射。</li>
</ul>
<hr>
<p>如果你想把现有 NestJS 代码里的配置<strong>替换为上面的“生产推荐模板”</strong>，告诉我你文件里的具体几行；我只给“需要替换的片段”，并在复杂逻辑上一行加注释，符合你的改码规则。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/08/%E9%9C%80%E6%B1%82%E5%AE%9E%E7%8E%B0/%E7%99%BB%E5%BD%95%E9%89%B4%E6%9D%83/Passkeys%EF%BC%9Aoptions/" data-id="cmfah3dps001fo04zhpfjhfhu" data-title="WebAuthn Passkeys：options 全字段长啥样？取值有哪些？（simplewebauthn v11+ 实战）" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/NestJS/" rel="tag">NestJS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Passkeys/" rel="tag">Passkeys</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/WebAuthn/" rel="tag">WebAuthn</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/simplewebauthn/" rel="tag">simplewebauthn</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-需求实现/登录鉴权/test" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2025/09/08/%E9%9C%80%E6%B1%82%E5%AE%9E%E7%8E%B0/%E7%99%BB%E5%BD%95%E9%89%B4%E6%9D%83/test/" class="article-date">
  <time class="dt-published" datetime="2025-09-08T00:19:02.000Z" itemprop="datePublished">2025-09-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2025/09/08/%E9%9C%80%E6%B1%82%E5%AE%9E%E7%8E%B0/%E7%99%BB%E5%BD%95%E9%89%B4%E6%9D%83/test/">test</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/08/%E9%9C%80%E6%B1%82%E5%AE%9E%E7%8E%B0/%E7%99%BB%E5%BD%95%E9%89%B4%E6%9D%83/test/" data-id="cmfah3dpt001io04zfy4a407k" data-title="test" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-需求实现/登录鉴权/preferred是啥" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2025/09/08/%E9%9C%80%E6%B1%82%E5%AE%9E%E7%8E%B0/%E7%99%BB%E5%BD%95%E9%89%B4%E6%9D%83/preferred%E6%98%AF%E5%95%A5/" class="article-date">
  <time class="dt-published" datetime="2025-09-08T00:12:36.000Z" itemprop="datePublished">2025-09-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2025/09/08/%E9%9C%80%E6%B1%82%E5%AE%9E%E7%8E%B0/%E7%99%BB%E5%BD%95%E9%89%B4%E6%9D%83/preferred%E6%98%AF%E5%95%A5/">userVerification:</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>好，我逐条拆解你看到的这段响应，并把“该用什么值”“挑战长度”为啥看起来短、“大厂是不是也这样返回”讲清楚；最后给出<strong>只需改几行</strong>的建议（不贴整文件）。</p>
<hr>
<h1 id="1、-userVerification-preferred-是啥？"><a href="#1、-userVerification-preferred-是啥？" class="headerlink" title="1、&quot;userVerification&quot;: &quot;preferred&quot; 是啥？"></a>1、<code>&quot;userVerification&quot;: &quot;preferred&quot;</code> 是啥？</h1><p><strong>它告诉浏览器&#x2F;认证器：是否必须做“本地用户验证（UV）”</strong>（指纹&#x2F;人脸&#x2F;PIN）。可选值只有 3 个：</p>
<table>
<thead>
<tr>
<th>值</th>
<th>含义</th>
<th>常见效果&#x2F;场景</th>
</tr>
</thead>
<tbody><tr>
<td><strong><code>required</code></strong></td>
<td><strong>必须</strong>进行本地用户验证（没有 UV 能力的认证器会被排除）</td>
<td>金融、后台管理、提升安全性。旧 U2F 钥匙（无 PIN）会被拒。</td>
</tr>
<tr>
<td><strong><code>preferred</code></strong>（你现在的值）</td>
<td><strong>优先</strong>做 UV，如果设备支持就做；不支持也可以继续</td>
<td>一般网站登录、降低失败率。绝大多数“平台 passkey”（Android&#x2F;Apple）都会做 UV，所以体验和 <code>required</code> 基本一样。</td>
</tr>
<tr>
<td><strong><code>discouraged</code></strong></td>
<td><strong>不鼓励</strong>做 UV（允许仅“持有设备”就通过）</td>
<td>很少用；降低安全门槛，适合低风险二级操作（不建议用于登录）。</td>
</tr>
</tbody></table>
<blockquote>
<p>注意：这只是“<strong>意愿</strong>”。真正的<strong>强制</strong>要在<strong>服务端验证</strong>时也打开：<br><code>verifyRegistrationResponse/verifyAuthenticationResponse(&#123; requireUserVerification: true &#125;)</code>。<br>否则前端说 <code>required</code>，服务端放宽为 <code>false</code>，就<strong>没有被强制</strong>。</p>
</blockquote>
<p><strong>给你的建议：</strong></p>
<ul>
<li>如果这是<strong>员工后台</strong>或敏感操作：前端设 <code>userVerification: &#39;required&#39;</code>，服务端配套 <code>requireUserVerification: true</code>。</li>
<li>如果是<strong>大众登录</strong>：<code>preferred</code> + 风控&#x2F;设备指纹&#x2F;异常登录再二次验证。</li>
</ul>
<h1 id="2、这个-challenge-看起来“很短”，正常吗？"><a href="#2、这个-challenge-看起来“很短”，正常吗？" class="headerlink" title="2、这个 challenge 看起来“很短”，正常吗？"></a>2、这个 <code>challenge</code> 看起来“很短”，正常吗？</h1><p><strong>正常。</strong></p>
<ul>
<li>simplewebauthn 默认生成 <strong>32 字节</strong>随机挑战（≈ <strong>256 bit</strong>）。</li>
<li>32 字节用 <strong>base64url</strong> 表示通常是 <strong>43~44 个字符</strong>（无 <code>=</code> 填充）。</li>
<li>你看到的：<code>jOr8QL_ExSr_7xsD2WUG1Kp8eM2lMiWNx8fFMg5wLyg</code>，长度 43，很标准。</li>
<li>我们服务端已把 challenge 统一按 <strong>base64url</strong> 存&#x2F;比（你代码里已处理），与前端 <code>clientDataJSON.challenge</code> 能<strong>精确一致</strong>。</li>
</ul>
<blockquote>
<p>若你担心强度，也可以自定义更长挑战（例如 64 字节），但 32 字节已足够随机且是行业常见默认。</p>
</blockquote>
<h1 id="3、大厂实践里返回的也是这种结构吗？"><a href="#3、大厂实践里返回的也是这种结构吗？" class="headerlink" title="3、大厂实践里返回的也是这种结构吗？"></a>3、大厂实践里返回的也是这种结构吗？</h1><p><strong>是的。<strong>这就是 WebAuthn 规范的 <strong>PublicKeyCredentialRequestOptions(JSON)</strong> 的形态，各家（Google、Apple、微软、GitHub、PayPal…）都会返回类似结构。差异主要在</strong>有没有 <code>allowCredentials</code></strong> 和某些可选字段：</p>
<ul>
<li>一键直登&#x2F;可发现凭证：<strong>省略 <code>allowCredentials</code></strong>（你现在就是），浏览器会弹出该 RP 的可用 passkey 列表。</li>
<li>指定账号登录：会带 <code>allowCredentials: [&#123; id, type: &#39;public-key&#39; &#125;, ...]</code>。</li>
<li>其他常见字段：<code>rpId</code>、<code>challenge</code>、<code>timeout</code>、<code>userVerification</code>、有时 <code>extensions</code>。</li>
<li>前端会另外传 <code>mediation: &#39;conditional&#39;</code>（这不是 options 里的字段，而是 <code>navigator.credentials.get</code> 的参数，用于条件式 UI）。</li>
</ul>
<p>所以你这个响应：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;rpId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;challenge&quot;</span><span class="punctuation">:</span> <span class="string">&quot;…&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timeout&quot;</span><span class="punctuation">:</span> <span class="number">60000</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;userVerification&quot;</span><span class="punctuation">:</span> <span class="string">&quot;preferred&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>完全合理</strong>、符合规范，也符合大厂常见做法（本地开发把 <code>rpId</code> 设为 <code>localhost</code> 没问题，上线要换为你的主域）。</p>
<h1 id="4、如果你要“更安全”，只改这几行（前后端各一处）"><a href="#4、如果你要“更安全”，只改这几行（前后端各一处）" class="headerlink" title="4、如果你要“更安全”，只改这几行（前后端各一处）"></a>4、如果你要“更安全”，只改这几行（前后端各一处）</h1><p><strong>后端·验证时强制 UV（把 <code>false</code> 改为 <code>true</code>）</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂：强制需要本地用户验证（指纹/人脸/PIN）</span></span><br><span class="line"><span class="attr">requireUserVerification</span>: <span class="literal">true</span>,</span><br></pre></td></tr></table></figure>

<blockquote>
<p>出现位置：</p>
<ul>
<li><code>verifyRegistrationResponse(&#123;...&#125;)</code></li>
<li><code>verifyAuthenticationResponse(&#123;...&#125;)</code></li>
</ul>
</blockquote>
<p><strong>生成登录 options 时（可选）：把首选项也改为 required</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂：要求认证器执行 UV</span></span><br><span class="line"><span class="attr">userVerification</span>: <span class="string">&#x27;required&#x27;</span>,</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这两处配合使用，才能做到“名副其实的强制 UV”。</p>
</blockquote>
<hr>
<h1 id="5、小补充：别名-大小写别差异别担心"><a href="#5、小补充：别名-大小写别差异别担心" class="headerlink" title="5、小补充：别名&#x2F;大小写别差异别担心"></a>5、小补充：别名&#x2F;大小写别差异别担心</h1><ul>
<li>simplewebauthn（v11+）返回的 JSON 用 <code>rpId</code>（小写 d）；</li>
<li>你传入 <code>generateAuthenticationOptions(&#123; rpID: &#39;…&#39; &#125;)</code> 是库的入参写法；</li>
<li><strong>这是正常的</strong>：入参&#x2F;出参字段命名略有差异，但库会正确映射。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/08/%E9%9C%80%E6%B1%82%E5%AE%9E%E7%8E%B0/%E7%99%BB%E5%BD%95%E9%89%B4%E6%9D%83/preferred%E6%98%AF%E5%95%A5/" data-id="cmfah3dps001go04zb8rraeol" data-title="userVerification:" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-在-NestJS-中引入-Redis——从-0-到可用（ioredis-版）" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2025/09/07/%E5%9C%A8-NestJS-%E4%B8%AD%E5%BC%95%E5%85%A5-Redis%E2%80%94%E2%80%94%E4%BB%8E-0-%E5%88%B0%E5%8F%AF%E7%94%A8%EF%BC%88ioredis-%E7%89%88%EF%BC%89/" class="article-date">
  <time class="dt-published" datetime="2025-09-07T20:40:23.000Z" itemprop="datePublished">2025-09-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2025/09/07/%E5%9C%A8-NestJS-%E4%B8%AD%E5%BC%95%E5%85%A5-Redis%E2%80%94%E2%80%94%E4%BB%8E-0-%E5%88%B0%E5%8F%AF%E7%94%A8%EF%BC%88ioredis-%E7%89%88%EF%BC%89/">在 NestJS 中引入 Redis——从 0 到可用（ioredis 版）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <hr>
<p>title: 在 NestJS 中引入 Redis——从 0 到可用（ioredis 版）<br>date: 2025-09-07<br>tags:</p>
<ul>
<li>NestJS</li>
<li>Redis</li>
<li>ioredis</li>
<li>教程<br>categories:</li>
<li>后端<br>description: 手把手带你在 NestJS 中集成 Redis（基于 ioredis），涵盖安装、配置、Provider、全局模块封装、业务实践（限流&#x2F;一次性令牌）、Docker、本地调试与常见报错排查。</li>
</ul>
<hr>
<h1 id="目标与适用读者"><a href="#目标与适用读者" class="headerlink" title="目标与适用读者"></a>目标与适用读者</h1><ul>
<li>目标：在 <strong>NestJS</strong> 项目中稳定接入 <strong>Redis</strong>，通过 <strong>ioredis</strong> 驱动，提供可复用的 <code>RedisService</code>（封装 <code>set/get/del/incr/expire</code>、NX 写入等），并支持 <strong>全局模块</strong>、<strong>环境配置</strong>、<strong>本地&#x2F;生产</strong> 两套部署。</li>
<li>适用：会基本 NestJS 模块&#x2F;依赖注入的同学；数据库用 TypeORM&#x2F;Prisma 均可（与本教程无冲突）。</li>
</ul>
<hr>
<h1 id="技术栈选型"><a href="#技术栈选型" class="headerlink" title="技术栈选型"></a>技术栈选型</h1><ul>
<li>Redis 客户端：<strong>ioredis</strong>（成熟、支持集群&#x2F;哨兵、TypeScript 友好）。</li>
<li>Nest 集成方式：自定义 <strong>Provider + 全局模块</strong>，暴露 <code>REDIS_CLIENT</code> 与 <code>RedisService</code>。</li>
<li>配置：<code>.env</code> 中支持 <code>REDIS_URL</code> 或 <code>REDIS_HOST/PORT/PASSWORD/DB</code>。</li>
</ul>
<hr>
<h1 id="目录结构（建议）"><a href="#目录结构（建议）" class="headerlink" title="目录结构（建议）"></a>目录结构（建议）</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">src/</span><br><span class="line">  common/</span><br><span class="line">    redis/</span><br><span class="line">      redis.module.ts       # 全局模块（@Global）</span><br><span class="line">      redis.service.ts      # 业务友好封装（依赖 REDIS_CLIENT）</span><br><span class="line">  app.module.ts             # 或各业务模块，引入 RedisModule 一次即可</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="第一步：安装依赖"><a href="#第一步：安装依赖" class="headerlink" title="第一步：安装依赖"></a>第一步：安装依赖</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 pnpm（推荐）</span></span><br><span class="line">pnpm add ioredis</span><br><span class="line"><span class="comment"># 或者 npm</span></span><br><span class="line"><span class="comment"># npm i ioredis</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="第二步：准备环境变量"><a href="#第二步：准备环境变量" class="headerlink" title="第二步：准备环境变量"></a>第二步：准备环境变量</h1><p>建议在 <code>.env</code>（或 <code>.env.dev</code>）中添加 <strong>二选一</strong>：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方式 A：URL 一行式（含密码与 DB 索引，推荐）</span></span><br><span class="line"><span class="attr">REDIS_URL</span>=redis://:password@localhost:<span class="number">6379</span>/<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式 B：分散式</span></span><br><span class="line"><span class="attr">REDIS_HOST</span>=<span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">REDIS_PORT</span>=<span class="number">6379</span></span><br><span class="line"><span class="attr">REDIS_PASSWORD</span>=</span><br><span class="line"><span class="attr">REDIS_DB</span>=<span class="number">0</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="第三步：编写-RedisService"><a href="#第三步：编写-RedisService" class="headerlink" title="第三步：编写 RedisService"></a>第三步：编写 <code>RedisService</code></h1><blockquote>
<p>放在 <code>src/common/redis/redis.service.ts</code><br>命名<strong>清晰可读</strong>，复杂逻辑上方有中文注释。</p>
</blockquote>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span>, <span class="title class_">Inject</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">Redis</span> &#125; <span class="keyword">from</span> <span class="string">&quot;ioredis&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复杂：作为底层连接的注入令牌；项目全局唯一</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">REDIS_CLIENT</span> = <span class="string">&quot;REDIS_CLIENT&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">RedisService</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="meta">@Inject</span>(REDIS_CLIENT) <span class="keyword">private</span> <span class="keyword">readonly</span> <span class="attr">redisClient</span>: <span class="title class_">Redis</span></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 复杂：统一封装写入并设置过期时间，便于存挑战/一次性令牌</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">setWithTimeToLive</span>(</span><br><span class="line">    <span class="attr">key</span>: <span class="built_in">string</span>,</span><br><span class="line">    <span class="attr">value</span>: <span class="built_in">string</span>,</span><br><span class="line">    timeToLiveSeconds = <span class="number">300</span></span><br><span class="line">  ): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">redisClient</span>.<span class="title function_">set</span>(key, value, <span class="string">&quot;EX&quot;</span>, timeToLiveSeconds);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">getValue</span>(<span class="attr">key</span>: <span class="built_in">string</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span> | <span class="literal">null</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">redisClient</span>.<span class="title function_">get</span>(key);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">deleteKey</span>(<span class="attr">key</span>: <span class="built_in">string</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">redisClient</span>.<span class="title function_">del</span>(key);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 复杂：自增计数用于限流（第一次返回 1）</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">incrementKey</span>(<span class="attr">key</span>: <span class="built_in">string</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">number</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">redisClient</span>.<span class="title function_">incr</span>(key);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 复杂：给键设置过期时间，配合 incrementKey 实现简单窗口限流</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">expireKey</span>(<span class="attr">key</span>: <span class="built_in">string</span>, <span class="attr">seconds</span>: <span class="built_in">number</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">redisClient</span>.<span class="title function_">expire</span>(key, seconds);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 复杂：仅当键不存在时写入并设置 TTL（一次性令牌/幂等防重放）</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">setIfAbsentWithTimeToLive</span>(</span><br><span class="line">    <span class="attr">key</span>: <span class="built_in">string</span>,</span><br><span class="line">    <span class="attr">value</span>: <span class="built_in">string</span>,</span><br><span class="line">    <span class="attr">timeToLiveSeconds</span>: <span class="built_in">number</span></span><br><span class="line">  ): <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// 复杂：NX 确保不存在才写入；避免并发下的重复写入</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">redisClient</span>.<span class="title function_">set</span>(</span><br><span class="line">      key,</span><br><span class="line">      value,</span><br><span class="line">      <span class="string">&quot;NX&quot;</span>,</span><br><span class="line">      <span class="string">&quot;EX&quot;</span>,</span><br><span class="line">      timeToLiveSeconds</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> result === <span class="string">&quot;OK&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="第四步：编写-RedisModule（全局模块，一次引入处处可用）"><a href="#第四步：编写-RedisModule（全局模块，一次引入处处可用）" class="headerlink" title="第四步：编写 RedisModule（全局模块，一次引入处处可用）"></a>第四步：编写 <code>RedisModule</code>（全局模块，一次引入处处可用）</h1><blockquote>
<p>放在 <code>src/common/redis/redis.module.ts</code>，标记 <code>@Global()</code>，自动对全局开放。</p>
</blockquote>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Global</span>, <span class="title class_">Module</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">IORedis</span> <span class="keyword">from</span> <span class="string">&quot;ioredis&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">RedisService</span>, <span class="variable constant_">REDIS_CLIENT</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./redis.service&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Global</span>()</span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">providers</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">provide</span>: <span class="variable constant_">REDIS_CLIENT</span>,</span><br><span class="line">      <span class="comment">// 复杂：通过工厂读取 .env，创建 ioredis 客户端</span></span><br><span class="line">      <span class="attr">useFactory</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> url = process.<span class="property">env</span>.<span class="property">REDIS_URL</span>;</span><br><span class="line">        <span class="keyword">const</span> host = process.<span class="property">env</span>.<span class="property">REDIS_HOST</span> ?? <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">        <span class="keyword">const</span> port = <span class="built_in">parseInt</span>(process.<span class="property">env</span>.<span class="property">REDIS_PORT</span> ?? <span class="string">&quot;6379&quot;</span>, <span class="number">10</span>);</span><br><span class="line">        <span class="keyword">const</span> password = process.<span class="property">env</span>.<span class="property">REDIS_PASSWORD</span> || <span class="literal">undefined</span>;</span><br><span class="line">        <span class="keyword">const</span> db = <span class="built_in">parseInt</span>(process.<span class="property">env</span>.<span class="property">REDIS_DB</span> ?? <span class="string">&quot;0&quot;</span>, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="attr">client</span>: <span class="title class_">IORedis</span>.<span class="property">Redis</span> = url</span><br><span class="line">          ? <span class="title function_">new</span> (<span class="title class_">IORedis</span> <span class="keyword">as</span> <span class="built_in">any</span>)(url)</span><br><span class="line">          : <span class="title function_">new</span> (<span class="title class_">IORedis</span> <span class="keyword">as</span> <span class="built_in">any</span>)(&#123; host, port, password, db &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 复杂：记录连接错误，便于排查</span></span><br><span class="line">        client.<span class="title function_">on</span>(<span class="string">&quot;error&quot;</span>, <span class="function">(<span class="params"><span class="attr">err</span>: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// eslint-disable-next-line no-console</span></span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;[Redis] connection error:&quot;</span>, err?.<span class="property">message</span> || err);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title class_">RedisService</span>,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">exports</span>: [<span class="variable constant_">REDIS_CLIENT</span>, <span class="title class_">RedisService</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">RedisModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="第五步：在应用中引入-RedisModule"><a href="#第五步：在应用中引入-RedisModule" class="headerlink" title="第五步：在应用中引入 RedisModule"></a>第五步：在应用中引入 <code>RedisModule</code></h1><blockquote>
<p>只需在<strong>任意一个模块</strong>引入一次（例如 <code>AppModule</code>），因为它是 <code>@Global()</code>。</p>
</blockquote>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/app.module.ts（或你任一根模块）</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Module</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ConfigModule</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/config&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">RedisModule</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./common/redis/redis.module&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppController</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./app.controller&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppService</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./app.service&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    <span class="title class_">ConfigModule</span>.<span class="title function_">forRoot</span>(&#123; <span class="attr">isGlobal</span>: <span class="literal">true</span> &#125;),</span><br><span class="line">    <span class="title class_">RedisModule</span>, <span class="comment">// 复杂：全局模块，仅需引入一次</span></span><br><span class="line">    <span class="comment">// ... 你的其它模块</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">controllers</span>: [<span class="title class_">AppController</span>],</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">AppService</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="第六步：业务中使用示例"><a href="#第六步：业务中使用示例" class="headerlink" title="第六步：业务中使用示例"></a>第六步：业务中使用示例</h1><h3 id="6-1-限流（每分钟最多-10-次）"><a href="#6-1-限流（每分钟最多-10-次）" class="headerlink" title="6.1 限流（每分钟最多 10 次）"></a>6.1 限流（每分钟最多 10 次）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Injectable</span>, <span class="title class_">TooManyRequestsException</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">RedisService</span> &#125; <span class="keyword">from</span> <span class="string">&quot;src/common/redis/redis.service&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">LoginService</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="keyword">readonly</span> <span class="attr">redisService</span>: <span class="title class_">RedisService</span></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 复杂：按 IP 做 60 秒/10 次 限流</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">limitByIp</span>(<span class="params"><span class="attr">ipAddress</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> rateLimitKey = <span class="string">`rl:login:<span class="subst">$&#123;ipAddress&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">const</span> currentCount = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">redisService</span>.<span class="title function_">incrementKey</span>(rateLimitKey);</span><br><span class="line">    <span class="keyword">if</span> (currentCount === <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">redisService</span>.<span class="title function_">expireKey</span>(rateLimitKey, <span class="number">60</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (currentCount &gt; <span class="number">10</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TooManyRequestsException</span>(<span class="string">&quot;请求过于频繁，请稍后再试&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-一次性令牌（幂等-防重放）"><a href="#6-2-一次性令牌（幂等-防重放）" class="headerlink" title="6.2 一次性令牌（幂等&#x2F;防重放）"></a>6.2 一次性令牌（幂等&#x2F;防重放）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂：仅当 key 不存在时写入，5 分钟有效</span></span><br><span class="line"><span class="keyword">const</span> ok = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">redisService</span>.<span class="title function_">setIfAbsentWithTimeToLive</span>(</span><br><span class="line">  <span class="string">`once:<span class="subst">$&#123;token&#125;</span>`</span>,</span><br><span class="line">  <span class="string">&quot;1&quot;</span>,</span><br><span class="line">  <span class="number">300</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (!ok) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;令牌已使用或失效&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-短期会话-挑战值（例如-WebAuthn）"><a href="#6-3-短期会话-挑战值（例如-WebAuthn）" class="headerlink" title="6.3 短期会话&#x2F;挑战值（例如 WebAuthn）"></a>6.3 短期会话&#x2F;挑战值（例如 WebAuthn）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">redisService</span>.<span class="title function_">setWithTimeToLive</span>(</span><br><span class="line">  <span class="string">`webauthn:register:<span class="subst">$&#123;userId&#125;</span>`</span>,</span><br><span class="line">  challengeBase64Url,</span><br><span class="line">  <span class="number">300</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">const</span> cached = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">redisService</span>.<span class="title function_">getValue</span>(<span class="string">`webauthn:register:<span class="subst">$&#123;userId&#125;</span>`</span>);</span><br><span class="line"><span class="comment">// ... 验证后删除</span></span><br><span class="line"><span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">redisService</span>.<span class="title function_">deleteKey</span>(<span class="string">`webauthn:register:<span class="subst">$&#123;userId&#125;</span>`</span>);</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="第七步：Docker-Compose（本地起-Redis）"><a href="#第七步：Docker-Compose（本地起-Redis）" class="headerlink" title="第七步：Docker Compose（本地起 Redis）"></a>第七步：Docker Compose（本地起 Redis）</h1><blockquote>
<p><code>docker-compose.yml</code>（项目根目录）</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.9&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:7-alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">demo-redis</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;--appendonly&quot;</span>, <span class="string">&quot;yes&quot;</span>]</span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-data:/data</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">redis-data:</span></span><br></pre></td></tr></table></figure>

<p>启动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker compose up -d</span><br><span class="line"><span class="comment"># .env 示例</span></span><br><span class="line"><span class="comment"># REDIS_URL=redis://localhost:6379</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="第八步：生产环境注意事项"><a href="#第八步：生产环境注意事项" class="headerlink" title="第八步：生产环境注意事项"></a>第八步：生产环境注意事项</h1><ul>
<li><strong>连接池与超时</strong>：ioredis 默认复用单连接；高并发可根据需要创建多个客户端或使用 <code>cluster</code>&#x2F;<code>sentinel</code>。</li>
<li><strong>密码与 ACL</strong>：生产务必启用密码或 ACL；不要暴露无鉴权实例。</li>
<li><strong>键名规范</strong>：<code>&lt;领域&gt;:&lt;用途&gt;:&lt;实体&gt;</code>（如 <code>webauthn:auth:ch:&lt;challenge&gt;</code>），可读性与清理都更好。</li>
<li><strong>TTL 策略</strong>：短期挑战&#x2F;令牌务必设置 TTL，并在验证后删除，避免重放。</li>
<li><strong>监控</strong>：监控 <code>connected clients</code>、<code>keyspace hits/misses</code>、<code>latency</code>；必要时加慢日志。</li>
<li><strong>持久化</strong>：默认 RDB；根据业务考虑 AOF（<code>appendonly yes</code>）与混合持久化。</li>
</ul>
<hr>
<h1 id="第九步：常见报错与排查"><a href="#第九步：常见报错与排查" class="headerlink" title="第九步：常见报错与排查"></a>第九步：常见报错与排查</h1><ul>
<li><strong>Nest can’t resolve dependencies of the RedisService (REDIS_CLIENT)</strong><br>说明：未注册 <code>REDIS_CLIENT</code> Provider。<br>解决：确保 <code>RedisModule</code>（或 <code>AppModule</code> 的 <code>providers</code>）里 <strong>provide: REDIS_CLIENT</strong> 已配置，并且模块被应用引入。</li>
<li><strong>ECONNREFUSED &#x2F; getaddrinfo ENOTFOUND</strong><br>说明：Redis 未启动或地址错误。<br>解决：检查 <code>REDIS_URL/REDIS_HOST/REDIS_PORT</code>，本地起容器或服务端口是否 6379。</li>
<li><strong>WRONGPASS invalid username-password pair</strong><br>说明：密码有误或未配置。<br>解决：核对 <code>REDIS_URL</code> 中 <code>:password@</code> 或 <code>REDIS_PASSWORD</code>。</li>
<li><strong>Ready check failed</strong><br>说明：网络&#x2F;权限&#x2F;ACL 问题或连接尚未可用。<br>解决：检查安全组&#x2F;防火墙；对云服务需配置白名单。</li>
</ul>
<hr>
<h1 id="第十步：单元测试（Mock-Redis）"><a href="#第十步：单元测试（Mock-Redis）" class="headerlink" title="第十步：单元测试（Mock Redis）"></a>第十步：单元测试（Mock Redis）</h1><blockquote>
<p>不在测试中连真实 Redis，可用 <code>ioredis-mock</code> 或手写假对象。</p>
</blockquote>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Test</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@nestjs/testing&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">RedisService</span>, <span class="variable constant_">REDIS_CLIENT</span> &#125; <span class="keyword">from</span> <span class="string">&quot;src/common/redis/redis.service&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&quot;RedisService&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">it</span>(<span class="string">&quot;set/get works&quot;</span>, <span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="comment">// 复杂：用最小可用的假客户端满足接口</span></span><br><span class="line">    <span class="keyword">const</span> fakeClient = &#123;</span><br><span class="line">      <span class="attr">storage</span>: <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;(),</span><br><span class="line">      <span class="attr">set</span>: <span class="keyword">function</span> (<span class="params"><span class="attr">k</span>: <span class="built_in">string</span>, <span class="attr">v</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">storage</span>.<span class="title function_">set</span>(k, v);</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&quot;OK&quot;</span>);</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">get</span>: <span class="keyword">function</span> (<span class="params"><span class="attr">k</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="variable language_">this</span>.<span class="property">storage</span>.<span class="title function_">get</span>(k) ?? <span class="literal">null</span>);</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">del</span>: <span class="keyword">function</span> (<span class="params"><span class="attr">k</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">storage</span>.<span class="title function_">delete</span>(k);</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>();</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">incr</span>: <span class="keyword">function</span> (<span class="params"><span class="attr">k</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> next = <span class="title class_">Number</span>(<span class="variable language_">this</span>.<span class="property">storage</span>.<span class="title function_">get</span>(k) ?? <span class="string">&quot;0&quot;</span>) + <span class="number">1</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">storage</span>.<span class="title function_">set</span>(k, <span class="title class_">String</span>(next));</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(next);</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">expire</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>();</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125; <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> moduleRef = <span class="keyword">await</span> <span class="title class_">Test</span>.<span class="title function_">createTestingModule</span>(&#123;</span><br><span class="line">      <span class="attr">providers</span>: [</span><br><span class="line">        &#123; <span class="attr">provide</span>: <span class="variable constant_">REDIS_CLIENT</span>, <span class="attr">useValue</span>: fakeClient &#125;,</span><br><span class="line">        <span class="title class_">RedisService</span>,</span><br><span class="line">      ],</span><br><span class="line">    &#125;).<span class="title function_">compile</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> redis = moduleRef.<span class="title function_">get</span>(<span class="title class_">RedisService</span>);</span><br><span class="line">    <span class="keyword">await</span> redis.<span class="title function_">setWithTimeToLive</span>(<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>, <span class="number">60</span>);</span><br><span class="line">    <span class="title function_">expect</span>(<span class="keyword">await</span> redis.<span class="title function_">getValue</span>(<span class="string">&quot;foo&quot;</span>)).<span class="title function_">toBe</span>(<span class="string">&quot;bar&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>至此，你已经完成了 <strong>NestJS × Redis（ioredis）</strong> 的完整接入：</p>
<ul>
<li>全局模块提供底层连接与服务封装；</li>
<li>业务中可轻松完成 <strong>限流</strong>、<strong>一次性令牌</strong>、<strong>短期会话&#x2F;挑战</strong> 等高频需求；</li>
<li>本地用 Docker 起 Redis，生产注意密码、ACL、监控与 TTL 策略。</li>
</ul>
<p>需要我把你的现有项目改造为 <strong>全局 <code>RedisModule</code> 方案</strong> 或 <strong>在 <code>AppModule</code> 直接注册 Provider</strong> 的最小改动 <strong>完整文件</strong>，就把相关文件发我（或让我复用你上面的 <code>AppModule</code> 路径）。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/07/%E5%9C%A8-NestJS-%E4%B8%AD%E5%BC%95%E5%85%A5-Redis%E2%80%94%E2%80%94%E4%BB%8E-0-%E5%88%B0%E5%8F%AF%E7%94%A8%EF%BC%88ioredis-%E7%89%88%EF%BC%89/" data-id="cmfah3dpo0011o04z2swnbf7y" data-title="在 NestJS 中引入 Redis——从 0 到可用（ioredis 版）" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-OAID-库的初始化与获取" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2025/09/07/OAID-%E5%BA%93%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%8E%E8%8E%B7%E5%8F%96/" class="article-date">
  <time class="dt-published" datetime="2025-09-07T15:44:21.000Z" itemprop="datePublished">2025-09-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2025/09/07/OAID-%E5%BA%93%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%8E%E8%8E%B7%E5%8F%96/">OAID 库的初始化与获取</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="一、国内主流-OAID-获取的两条路线"><a href="#一、国内主流-OAID-获取的两条路线" class="headerlink" title="一、国内主流 OAID 获取的两条路线"></a>一、国内主流 OAID 获取的两条路线</h1><ol>
<li><strong>MSA 官方 SDK（闭源）</strong></li>
</ol>
<ul>
<li>由“移动安全联盟&#x2F;CAICT”提供。接入要放 <code>oaid_sdk_x.x.x.aar</code>（或早期 <code>miit_mdid_x.x.x.aar</code>）、<code>supplierconfig.json</code>、证书（<code>xxx.cert.pem</code>），并<strong>先加载安全库</strong>再 <code>MdidSdkHelper.InitSdk(...)</code> 获取 OAID。常见混淆与加载问题官方 FAQ 也有说明。(<a target="_blank" rel="noopener" href="https://mtj.baidu.com/static/userguide/book/android/oaid.html?utm_source=chatgpt.com" title="Android OAID 接入">百度移动统计</a>, <a target="_blank" rel="noopener" href="https://16054554.s21i.faiusr.com/61/ABUIABA9GAAgx5iGjgYo2_j-1AE.pdf?utm_source=chatgpt.com" title="常见问题问答F&amp;Q - 信息资源系统">网站名称</a>)</li>
</ul>
<ol start="2">
<li><strong>开源聚合库（Android_CN_OAID）</strong></li>
</ol>
<ul>
<li>由 gzu-liyujiang 提供，统一封装<strong>各厂商 OAID + 海外 AAID + 多种替代 ID</strong>（AndroidID&#x2F;WidevineID&#x2F;GUID 等），API 友好。常用入口：<code>DeviceIdentifier.register(app)</code> 预取，或者 <code>DeviceID.getOAID(context, IGetter)</code> 异步获取。(<a target="_blank" rel="noopener" href="https://gzu-liyujiang.github.io/Android_CN_OAID/?utm_source=chatgpt.com" title=":library">李宇江的个人网站</a>)</li>
</ul>
<blockquote>
<p>额外：<strong>华为设备</strong>可直接通过 <strong>HMS Ads Identifier</strong> 获取 OAID（<code>AdvertisingIdClient.getAdvertisingIdInfo(context).getId()</code>），不依赖 MSA（很多三方 SDK 文档也这样说明）。(<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/en/doc/hmscore-references/overview-0000001050066887?utm_source=chatgpt.com" title="Overview-com.huawei.hms.ads.identifier-Android-Java- ...">华为开发者</a>, <a target="_blank" rel="noopener" href="https://dev.adjust.com/zh/sdk/android/plugins/oaid-plugin/?utm_source=chatgpt.com" title="OAID">Adjust</a>)</p>
</blockquote>
<hr>
<h1 id="二、你的两个-UTS-插件实际做法（我已解包查看）"><a href="#二、你的两个-UTS-插件实际做法（我已解包查看）" class="headerlink" title="二、你的两个 UTS 插件实际做法（我已解包查看）"></a>二、你的两个 UTS 插件实际做法（我已解包查看）</h1><ul>
<li><p><strong><code>android-deviceid</code></strong>（UTS for Android）</p>
<ul>
<li>直接 <code>import com.github.gzuliyujiang.oaid.*</code>，调用 <code>DeviceIdentifier.register(UTSAndroid.getUniActivity()!!.getApplication()!!)</code> 进行预取；随后通过接口把结果回调出去。</li>
<li>插件内还自带 <strong>华为 HMS ads-identifier AAR</strong>（<code>ads-identifier-*.aar</code>），作为获取 OAID 的华为路径支撑。</li>
<li>这是一个**标准的“开源聚合库 + （可选）HMS”**实现范式。</li>
</ul>
<p>片段（来自 <code>utssdk/app-android/index.uts</code>）：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">DeviceIdentifier</span> <span class="keyword">from</span> <span class="string">&quot;com.github.gzuliyujiang.oaid.DeviceIdentifier&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> register = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title class_">DeviceIdentifier</span>.<span class="title function_">register</span>(<span class="title class_">UTSAndroid</span>.<span class="title function_">getUniActivity</span>()!!.<span class="title function_">getApplication</span>()!!);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>（随后通过自定义 <code>MyListener implements IDManger.OnIOAIDListener</code> 回传 JSON 结果）</p>
</li>
<li><p><strong><code>zws-uniqueid</code></strong></p>
<ul>
<li>不取 OAID，仅根据 <code>android.os.Build</code> 若干字段计算 <code>MD5</code> 作为<strong>伪标识</strong>（PseudoID），没有广告&#x2F;合规可重置特性，仅能用于弱追踪&#x2F;灰度分配等<strong>非广告</strong>用途。</li>
</ul>
</li>
</ul>
<hr>
<h1 id="三、初始化-获取：可直接抄的代码片段库"><a href="#三、初始化-获取：可直接抄的代码片段库" class="headerlink" title="三、初始化 &amp; 获取：可直接抄的代码片段库"></a>三、初始化 &amp; 获取：可直接抄的代码片段库</h1><h2 id="方案-A：开源-Android-CN-OAID（推荐起步用）"><a href="#方案-A：开源-Android-CN-OAID（推荐起步用）" class="headerlink" title="方案 A：开源 Android_CN_OAID（推荐起步用）"></a>方案 A：开源 Android_CN_OAID（推荐起步用）</h2><p><strong>初始化（建议在用户同意隐私后再调用）</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Application.onCreate 或隐私同意后</span></span><br><span class="line">DeviceIdentifier.register(application)  <span class="comment">// 预取 clientId/OAID</span></span><br></pre></td></tr></table></figure>

<p><strong>获取 OAID（两种）</strong></p>
<ul>
<li><p>同步拿预取结果（需先 register）：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> oaid = DeviceID.getOAID()  <span class="comment">// 若未预取会为空</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>异步获取（不需要 register）：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DeviceID.getOAID(context, <span class="keyword">object</span> : IGetter &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onOAIDGetComplete</span><span class="params">(result: <span class="type">String</span>)</span></span> &#123; <span class="comment">/* result 即 OAID */</span> &#125;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onOAIDGetError</span><span class="params">(error: <span class="type">Exception</span>)</span></span> &#123; <span class="comment">/* 失败或不支持 */</span> &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
</ul>
<p>这些方法签名、时机说明都在官方 javadoc 文档中有清晰描述：<code>register(...)</code> 预取、<code>getOAID(...)</code> 异步、<code>supportedOAID(context)</code> 判断支持性、以及 <code>getGUID</code>、<code>getAndroidID</code> 等替代项。(<a target="_blank" rel="noopener" href="https://gzu-liyujiang.github.io/Android_CN_OAID/com/github/gzuliyujiang/oaid/DeviceID.html" title="DeviceID ">李宇江的个人网站</a>)</p>
<blockquote>
<p><strong>优点</strong>：开源、快速落地；<strong>缺点</strong>：在个别厂商&#x2F;系统组合上获取率可能不如官方 MSA；不过开源库会优先尝试 HMS、厂商通道，整体覆盖度已较好。(<a target="_blank" rel="noopener" href="https://gzu-liyujiang.github.io/Android_CN_OAID/?utm_source=chatgpt.com" title=":library">李宇江的个人网站</a>)</p>
</blockquote>
<h2 id="方案-B：MSA-官方-SDK（企业-上量后建议切换或并行）"><a href="#方案-B：MSA-官方-SDK（企业-上量后建议切换或并行）" class="headerlink" title="方案 B：MSA 官方 SDK（企业&#x2F;上量后建议切换或并行）"></a>方案 B：MSA 官方 SDK（企业&#x2F;上量后建议切换或并行）</h2><p><strong>准备</strong></p>
<ul>
<li><code>oaid_sdk_x.x.x.aar</code> 放 <code>libs/</code></li>
<li><code>supplierconfig.json</code>、<code>&lt;package&gt;.cert.pem</code> 放 <code>assets/</code></li>
<li>Proguard：<code>-keep class com.bun.miitmdid.core.** &#123; *; &#125;</code></li>
<li><strong>在 Init 前加载安全库</strong>（不同版本库名可能不同，如 <code>msaoaidsec</code> 或文档示例里的 nllvm 加固库名），否则会出现 <code>No implementation found for ... InitCert</code> 之类错误。(<a target="_blank" rel="noopener" href="https://mtj.baidu.com/static/userguide/book/android/oaid.html?utm_source=chatgpt.com" title="Android OAID 接入">百度移动统计</a>, <a target="_blank" rel="noopener" href="https://16054554.s21i.faiusr.com/61/ABUIABA9GAAgx5iGjgYo2_j-1AE.pdf?utm_source=chatgpt.com" title="常见问题问答F&amp;Q - 信息资源系统">网站名称</a>)</li>
</ul>
<p><strong>初始化 &amp; 获取</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1) （可选但推荐）在 Application.onCreate 尝试加载安全库</span></span><br><span class="line"><span class="keyword">try</span> &#123; System.loadLibrary(<span class="string">&quot;msaoaidsec&quot;</span>); &#125; <span class="keyword">catch</span>(Throwable ignore) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2) 在合适时机发起初始化与获取（不要在主线程里做耗时 I/O）</span></span><br><span class="line">MdidSdkHelper.InitSdk(</span><br><span class="line">  context.getApplicationContext(),</span><br><span class="line">  <span class="comment">/* isCert = */</span> <span class="literal">true</span>,</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">IIdentifierListener</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSupport</span><span class="params">(IdSupplier supplier)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (supplier != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">oaid</span> <span class="operator">=</span> supplier.getOAID();</span><br><span class="line">        <span class="comment">// supplier.isSupported() / isLimited() 等也可读</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>上面这段 init 与回调写法，在各家第三方接入文档里都是类似范式（百度统计、Adjust、AppsFlyer 等均说明“MSA 或 HMS”两路径），并给出了混淆、AAR、<code>supplierconfig.json</code> 的标准放置方法。(<a target="_blank" rel="noopener" href="https://mtj.baidu.com/static/userguide/book/android/oaid.html?utm_source=chatgpt.com" title="Android OAID 接入">百度移动统计</a>, <a target="_blank" rel="noopener" href="https://dev.adjust.com/zh/sdk/android/plugins/oaid-plugin/?utm_source=chatgpt.com" title="OAID">Adjust</a>, <a target="_blank" rel="noopener" href="https://support.appsflyer.com/hc/en-us/articles/360006278797-Android-OAID-implementation-in-the-SDK?utm_source=chatgpt.com" title="Android OAID implementation in the SDK">AppsFlyer 支持中心</a>)</p>
<h2 id="方案-C：华为设备走-HMS（若接入了-HMS-Core）"><a href="#方案-C：华为设备走-HMS（若接入了-HMS-Core）" class="headerlink" title="方案 C：华为设备走 HMS（若接入了 HMS Core）"></a>方案 C：华为设备走 HMS（若接入了 HMS Core）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不依赖 MSA，在华为设备上直接拿 OAID</span></span><br><span class="line">AdvertisingIdClient.<span class="type">Info</span> <span class="variable">info</span> <span class="operator">=</span></span><br><span class="line">    com.huawei.hms.ads.identifier.AdvertisingIdClient.getAdvertisingIdInfo(context);</span><br><span class="line"><span class="type">String</span> <span class="variable">oaid</span> <span class="operator">=</span> info.getId();</span><br><span class="line"><span class="comment">// info.isLimitAdTrackingEnabled() 可读 “限制个性化广告” 状态</span></span><br></pre></td></tr></table></figure>

<p>HMS 文档对 OAID &#x2F; Identifier Service 的 API 有明确说明。(<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/en/doc/hmscore-references/overview-0000001050066887?utm_source=chatgpt.com" title="Overview-com.huawei.hms.ads.identifier-Android-Java- ...">华为开发者</a>)</p>
<hr>
<h1 id="四、UTS（uni-app-x）里的最佳实践总方案"><a href="#四、UTS（uni-app-x）里的最佳实践总方案" class="headerlink" title="四、UTS（uni-app x）里的最佳实践总方案"></a>四、UTS（uni-app x）里的<strong>最佳实践</strong>总方案</h1><blockquote>
<p>目标：<strong>一个 API 跨 H5 &#x2F; Android</strong>，Android 侧<strong>优先 MSA&#x2F;HMS</strong>，没有则回退到 <strong>Android_CN_OAID</strong>，最后再降级 <strong>AndroidID &#x2F; GUID</strong>；且<strong>必须在取得隐私同意后</strong>再初始化与获取。</p>
</blockquote>
<h3 id="1-API-设计（简洁且可扩展）"><a href="#1-API-设计（简洁且可扩展）" class="headerlink" title="1) API 设计（简洁且可扩展）"></a>1) API 设计（简洁且可扩展）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /uni_modules/uaid-kit/utssdk/index.uts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">UaidInfo</span> = &#123;</span><br><span class="line">  <span class="attr">oaid</span>: <span class="built_in">string</span> | <span class="literal">null</span>;</span><br><span class="line">  <span class="attr">source</span>: <span class="string">&quot;MSA&quot;</span> | <span class="string">&quot;HMS&quot;</span> | <span class="string">&quot;GZU&quot;</span> | <span class="string">&quot;NONE&quot;</span>;</span><br><span class="line">  <span class="attr">limitAdTracking</span>?: <span class="built_in">boolean</span> | <span class="literal">null</span>;</span><br><span class="line">  <span class="attr">aaid</span>?: <span class="built_in">string</span> | <span class="literal">null</span>; <span class="comment">// 海外广告标识，未来可补</span></span><br><span class="line">  <span class="attr">androidId</span>?: <span class="built_in">string</span> | <span class="literal">null</span>; <span class="comment">// 回退项</span></span><br><span class="line">  <span class="attr">guid</span>?: <span class="built_in">string</span> | <span class="literal">null</span>; <span class="comment">// 本地持久 GUID（Web/低版本回退）</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initAfterConsent</span>(<span class="params"></span>): <span class="built_in">void</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getUaid</span>(<span class="params"><span class="attr">callback</span>: (info: UaidInfo) =&gt; <span class="built_in">void</span></span>): <span class="built_in">void</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2-UTS-源码（可直接用；Android-Web-双端）"><a href="#2-UTS-源码（可直接用；Android-Web-双端）" class="headerlink" title="2) UTS 源码（可直接用；Android + Web 双端）"></a>2) UTS 源码（<strong>可直接用</strong>；Android + Web 双端）</h3><blockquote>
<p>说明：</p>
<ul>
<li><strong>MSA</strong> 部分需要你把 <code>oaid_sdk_x.x.x.aar</code> 放到 <code>utssdk/app-android/libs/</code>，并在 <code>manifest.json</code> 勾选 UTS 插件；否则请把 <code>// MSA 可选块</code> 注释掉再编译。</li>
<li><strong>HMS</strong> 部分需要 <code>ads-identifier</code> 依赖；没有就留开源库&#x2F;回退路径。</li>
<li>Web 端只能<strong>生成&#x2F;持久化 GUID</strong>，OAID 是 Android 概念。</li>
</ul>
</blockquote>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /uni_modules/uaid-kit/utssdk/app-android/index.uts</span></span><br><span class="line"><span class="comment">// #ifdef APP-ANDROID</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Context</span> <span class="keyword">from</span> <span class="string">&quot;android.content.Context&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Application</span> <span class="keyword">from</span> <span class="string">&quot;android.app.Application&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">System</span> <span class="keyword">from</span> <span class="string">&quot;java.lang.System&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 开源库（gzu-liyujiang）</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">DeviceIdentifier</span> <span class="keyword">from</span> <span class="string">&quot;com.github.gzuliyujiang.oaid.DeviceIdentifier&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">DeviceID</span> <span class="keyword">from</span> <span class="string">&quot;com.github.gzuliyujiang.oaid.DeviceID&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">IGetter</span> <span class="keyword">from</span> <span class="string">&quot;com.github.gzuliyujiang.oaid.IGetter&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HMS（若集成）</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">AdvertisingIdClient</span> <span class="keyword">from</span> <span class="string">&quot;com.huawei.hms.ads.identifier.AdvertisingIdClient&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MSA（若集成了 AAR，否则请注释下一行两行以及使用处）</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">MdidSdkHelper</span> <span class="keyword">from</span> <span class="string">&quot;com.bun.miitmdid.core.MdidSdkHelper&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">IIdentifierListener</span> <span class="keyword">from</span> <span class="string">&quot;com.bun.miitmdid.interfaces.IIdentifierListener&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">IdSupplier</span> <span class="keyword">from</span> <span class="string">&quot;com.bun.miitmdid.interfaces.IdSupplier&quot;</span>;</span><br><span class="line"><span class="comment">// #endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #ifdef H5</span></span><br><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"><span class="comment">// #endif</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">UaidInfo</span> = &#123;</span><br><span class="line">  <span class="attr">oaid</span>: <span class="built_in">string</span> | <span class="literal">null</span>;</span><br><span class="line">  <span class="attr">source</span>: <span class="string">&quot;MSA&quot;</span> | <span class="string">&quot;HMS&quot;</span> | <span class="string">&quot;GZU&quot;</span> | <span class="string">&quot;NONE&quot;</span>;</span><br><span class="line">  <span class="attr">limitAdTracking</span>?: <span class="built_in">boolean</span> | <span class="literal">null</span>;</span><br><span class="line">  <span class="attr">aaid</span>?: <span class="built_in">string</span> | <span class="literal">null</span>;</span><br><span class="line">  <span class="attr">androidId</span>?: <span class="built_in">string</span> | <span class="literal">null</span>;</span><br><span class="line">  <span class="attr">guid</span>?: <span class="built_in">string</span> | <span class="literal">null</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initAfterConsent</span>(<span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="comment">// #ifdef APP-ANDROID</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 优先预取开源库的 clientId/OAID</span></span><br><span class="line">    <span class="title class_">DeviceIdentifier</span>.<span class="title function_">register</span>(</span><br><span class="line">      <span class="title class_">UTSAndroid</span>.<span class="title function_">getUniActivity</span>()!!.<span class="title function_">getApplication</span>()!! <span class="keyword">as</span> <span class="title class_">Application</span></span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// （可选）若你计划走 MSA，尽早加载安全库，避免 InitCert 报错</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="title class_">System</span>.<span class="title function_">loadLibrary</span>(<span class="string">&quot;msaoaidsec&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;&#125;</span><br><span class="line">  <span class="comment">// #endif</span></span><br><span class="line">  <span class="comment">// #ifdef H5</span></span><br><span class="line">  <span class="comment">// nothing</span></span><br><span class="line">  <span class="comment">// #endif</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">buildGuid</span>(<span class="params"></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="comment">// 128bit GUID，H5/Android 均可用，H5 存 localStorage 即可</span></span><br><span class="line">  <span class="keyword">const</span> s = <span class="string">&quot;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&quot;</span>;</span><br><span class="line">  <span class="keyword">return</span> s.<span class="title function_">replace</span>(<span class="regexp">/[xy]/g</span>, <span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> r = (<span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">16</span>) <span class="keyword">as</span> <span class="built_in">number</span>) &amp; <span class="number">0xf</span>;</span><br><span class="line">    <span class="keyword">const</span> v = c === <span class="string">&quot;x&quot;</span> ? r : (r &amp; <span class="number">0x3</span>) | <span class="number">0x8</span>;</span><br><span class="line">    <span class="keyword">return</span> v.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getUaid</span>(<span class="params"><span class="attr">cb</span>: (info: UaidInfo) =&gt; <span class="built_in">void</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="comment">// #ifdef APP-ANDROID</span></span><br><span class="line">  <span class="keyword">const</span> ctx = <span class="title class_">UTSAndroid</span>.<span class="title function_">getUniActivity</span>()!! <span class="keyword">as</span> <span class="title class_">Context</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 1) 尝试 HMS（若集成）</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> info = <span class="title class_">AdvertisingIdClient</span>.<span class="title function_">getAdvertisingIdInfo</span>(ctx);</span><br><span class="line">    <span class="keyword">const</span> id = info.<span class="title function_">getId</span>();</span><br><span class="line">    <span class="keyword">if</span> (id) &#123;</span><br><span class="line">      <span class="title function_">cb</span>(&#123;</span><br><span class="line">        <span class="attr">oaid</span>: id,</span><br><span class="line">        <span class="attr">source</span>: <span class="string">&quot;HMS&quot;</span>,</span><br><span class="line">        <span class="attr">limitAdTracking</span>: info.<span class="title function_">isLimitAdTrackingEnabled</span>(),</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="comment">/* ignore */</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2) 尝试 MSA 官方（若集成了 AAR）</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="title class_">MdidSdkHelper</span>.<span class="title class_">InitSdk</span>(</span><br><span class="line">      ctx,</span><br><span class="line">      <span class="literal">true</span>,</span><br><span class="line">      <span class="title function_">new</span> (<span class="keyword">class</span> <span class="title class_">implements</span> <span class="title class_">IIdentifierListener</span> &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="title function_">onSupport</span>(<span class="params"><span class="attr">supplier</span>: <span class="title class_">IdSupplier</span> | <span class="literal">null</span></span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (supplier != <span class="literal">null</span> &amp;&amp; supplier.<span class="title function_">getOAID</span>() != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="title function_">cb</span>(&#123; <span class="attr">oaid</span>: supplier.<span class="title function_">getOAID</span>(), <span class="attr">source</span>: <span class="string">&quot;MSA&quot;</span> &#125;);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 3) 回退：开源库异步</span></span><br><span class="line">            <span class="title class_">DeviceID</span>.<span class="title function_">getOAID</span>(</span><br><span class="line">              ctx,</span><br><span class="line">              <span class="title function_">new</span> (<span class="keyword">class</span> <span class="title class_">implements</span> <span class="title class_">IGetter</span> &#123;</span><br><span class="line">                <span class="keyword">override</span> <span class="title function_">onOAIDGetComplete</span>(<span class="params"><span class="attr">result</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">                  <span class="title function_">cb</span>(&#123; <span class="attr">oaid</span>: result, <span class="attr">source</span>: <span class="string">&quot;GZU&quot;</span> &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">override</span> <span class="title function_">onOAIDGetError</span>(<span class="params"><span class="attr">err</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">                  <span class="keyword">const</span> androidId = <span class="title class_">DeviceID</span>.<span class="title function_">getAndroidID</span>(ctx);</span><br><span class="line">                  <span class="title function_">cb</span>(&#123; <span class="attr">oaid</span>: <span class="literal">null</span>, <span class="attr">source</span>: <span class="string">&quot;NONE&quot;</span>, androidId &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;)()</span><br><span class="line">            );</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)()</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="comment">// 没集成 MSA 或运行异常，继续走开源库回退</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3) 开源库异步（无预取也能用）</span></span><br><span class="line">  <span class="title class_">DeviceID</span>.<span class="title function_">getOAID</span>(</span><br><span class="line">    ctx,</span><br><span class="line">    <span class="title function_">new</span> (<span class="keyword">class</span> <span class="title class_">implements</span> <span class="title class_">IGetter</span> &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="title function_">onOAIDGetComplete</span>(<span class="params"><span class="attr">result</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">        <span class="title function_">cb</span>(&#123; <span class="attr">oaid</span>: result, <span class="attr">source</span>: <span class="string">&quot;GZU&quot;</span> &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">override</span> <span class="title function_">onOAIDGetError</span>(<span class="params"><span class="attr">err</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> androidId = <span class="title class_">DeviceID</span>.<span class="title function_">getAndroidID</span>(ctx);</span><br><span class="line">        <span class="title function_">cb</span>(&#123; <span class="attr">oaid</span>: <span class="literal">null</span>, <span class="attr">source</span>: <span class="string">&quot;NONE&quot;</span>, androidId &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)()</span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// #endif</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// #ifdef H5</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> guid = uni.<span class="title function_">getStorageSync</span>(<span class="string">&quot;UAID_GUID&quot;</span>) <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line">    <span class="keyword">if</span> (!guid) &#123;</span><br><span class="line">      guid = <span class="title function_">buildGuid</span>();</span><br><span class="line">      uni.<span class="title function_">setStorageSync</span>(<span class="string">&quot;UAID_GUID&quot;</span>, guid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">cb</span>(&#123; <span class="attr">oaid</span>: <span class="literal">null</span>, <span class="attr">source</span>: <span class="string">&quot;NONE&quot;</span>, guid &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="title function_">cb</span>(&#123; <span class="attr">oaid</span>: <span class="literal">null</span>, <span class="attr">source</span>: <span class="string">&quot;NONE&quot;</span>, <span class="attr">guid</span>: <span class="title function_">buildGuid</span>() &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// #endif</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>混淆&#x2F;配置建议（Android）</strong></p>
<ul>
<li><p>若启用 <strong>MSA</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-keep class com.bun.miitmdid.core.** &#123; *; &#125;</span><br></pre></td></tr></table></figure>

<p>同时把 <code>oaid_sdk_x.x.x.aar</code>、<code>supplierconfig.json</code>、<code>&lt;pkg&gt;.cert.pem</code> 放到对应目录（AAR: <code>libs/</code>，其余在 <code>assets/</code>）。初始化前加载安全库，避免 <code>InitCert</code> 报错。(<a target="_blank" rel="noopener" href="https://mtj.baidu.com/static/userguide/book/android/oaid.html?utm_source=chatgpt.com" title="Android OAID 接入">百度移动统计</a>, <a target="_blank" rel="noopener" href="https://16054554.s21i.faiusr.com/61/ABUIABA9GAAgx5iGjgYo2_j-1AE.pdf?utm_source=chatgpt.com" title="常见问题问答F&amp;Q - 信息资源系统">网站名称</a>)</p>
</li>
<li><p>若启用 <strong>HMS</strong>：确保引入 <code>com.huawei.hms:ads-identifier</code>（你现有 <code>android-deviceid</code> 插件已内置两个 ads-identifier AAR）。华为 OAID API 文档参考。(<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/en/doc/hmscore-references/overview-0000001050066887?utm_source=chatgpt.com" title="Overview-com.huawei.hms.ads.identifier-Android-Java- ...">华为开发者</a>)</p>
</li>
<li><p>若只用<strong>开源库</strong>：不需要证书，按上面 <code>DeviceID</code> &#x2F; <code>DeviceIdentifier</code> 的调用即可（方法签名见官方 javadoc）。(<a target="_blank" rel="noopener" href="https://gzu-liyujiang.github.io/Android_CN_OAID/com/github/gzuliyujiang/oaid/DeviceID.html" title="DeviceID ">李宇江的个人网站</a>)</p>
</li>
</ul>
<p><strong>隐私合规关键点</strong></p>
<ul>
<li><strong>必须在用户同意隐私政策后</strong>再 <code>initAfterConsent()</code>；开源库文档也特别提示 register&#x2F;获取前需获同意。(<a target="_blank" rel="noopener" href="https://gzu-liyujiang.github.io/Android_CN_OAID/com/github/gzuliyujiang/oaid/DeviceID.html" title="DeviceID ">李宇江的个人网站</a>)</li>
</ul>
<hr>
<h1 id="五、再回答你“原来的插件中如何实现”的要点"><a href="#五、再回答你“原来的插件中如何实现”的要点" class="headerlink" title="五、再回答你“原来的插件中如何实现”的要点"></a>五、再回答你“原来的插件中如何实现”的要点</h1><ul>
<li><p>你的 <strong><code>android-deviceid</code></strong> 正是采用<strong>开源库（Android_CN_OAID）+（可选）HMS</strong>的组合：</p>
<ul>
<li>预取：<code>DeviceIdentifier.register(...)</code></li>
<li>异步获取：<code>DeviceID.getOAID(context, IGetter)</code></li>
<li>附带 ad-identifier AAR，完善华为路径</li>
</ul>
<blockquote>
<p>这与文档推荐用法一致（register 预取、或异步获取；支持 <code>supportedOAID</code> 检查）。(<a target="_blank" rel="noopener" href="https://gzu-liyujiang.github.io/Android_CN_OAID/com/github/gzuliyujiang/oaid/DeviceID.html" title="DeviceID ">李宇江的个人网站</a>)</p>
</blockquote>
</li>
<li><p>你的 <strong><code>zws-uniqueid</code></strong> 只是<strong>伪 ID</strong>（基于 <code>Build.*</code> 拼接+MD5），<strong>不属于 OAID</strong>，适合作兜底标识，不可用于广告归因。</p>
</li>
</ul>
<hr>
<h1 id="六、为什么推荐“先开源库-→-再视需要加-MSA-HMS”"><a href="#六、为什么推荐“先开源库-→-再视需要加-MSA-HMS”" class="headerlink" title="六、为什么推荐“先开源库 → 再视需要加 MSA&#x2F;HMS”"></a>六、为什么推荐“先开源库 → 再视需要加 MSA&#x2F;HMS”</h1><ul>
<li><strong>落地速度</strong>：开源库无证书&#x2F;厂商注册门槛，上线快；API 稳定，文档完整（还有 <code>GUID/AndroidID</code> 兜底）。(<a target="_blank" rel="noopener" href="https://gzu-liyujiang.github.io/Android_CN_OAID/?utm_source=chatgpt.com" title=":library">李宇江的个人网站</a>)</li>
<li><strong>兼容与获取率</strong>：有华为设备时可直接走 <strong>HMS OAID</strong>；大盘上量&#x2F;商业化合规要求更高时，再<strong>并行接入 MSA</strong> 提升部分机型覆盖率。(<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/en/doc/hmscore-references/overview-0000001050066887?utm_source=chatgpt.com" title="Overview-com.huawei.hms.ads.identifier-Android-Java- ...">华为开发者</a>, <a target="_blank" rel="noopener" href="https://dev.adjust.com/zh/sdk/android/plugins/oaid-plugin/?utm_source=chatgpt.com" title="OAID">Adjust</a>)</li>
<li><strong>合规</strong>：始终把 OAID 获取放在<strong>隐私同意之后</strong>。(<a target="_blank" rel="noopener" href="https://gzu-liyujiang.github.io/Android_CN_OAID/com/github/gzuliyujiang/oaid/DeviceID.html" title="DeviceID ">李宇江的个人网站</a>)</li>
</ul>
<hr>
<h2 id="附：权威-一手资料（便于你对照）"><a href="#附：权威-一手资料（便于你对照）" class="headerlink" title="附：权威&#x2F;一手资料（便于你对照）"></a>附：权威&#x2F;一手资料（便于你对照）</h2><ul>
<li>Android_CN_OAID 文档（<code>DeviceID.register/getOAID/supportedOAID/...</code> 方法签名）(<a target="_blank" rel="noopener" href="https://gzu-liyujiang.github.io/Android_CN_OAID/com/github/gzuliyujiang/oaid/DeviceID.html" title="DeviceID ">李宇江的个人网站</a>)</li>
<li>Android_CN_OAID 项目主页&#x2F;文档导航（含包结构&#x2F;实现原理）(<a target="_blank" rel="noopener" href="https://gzu-liyujiang.github.io/Android_CN_OAID/?utm_source=chatgpt.com" title=":library">李宇江的个人网站</a>)</li>
<li>MSA 官方接入说明（AAR、<code>supplierconfig.json</code>、混淆、加载安全库&#x2F;InitCert 问题）(<a target="_blank" rel="noopener" href="https://mtj.baidu.com/static/userguide/book/android/oaid.html?utm_source=chatgpt.com" title="Android OAID 接入">百度移动统计</a>, <a target="_blank" rel="noopener" href="https://16054554.s21i.faiusr.com/61/ABUIABA9GAAgx5iGjgYo2_j-1AE.pdf?utm_source=chatgpt.com" title="常见问题问答F&amp;Q - 信息资源系统">网站名称</a>)</li>
<li>Adjust &#x2F; AppsFlyer 对 OAID 的总述与“MSA 或 HMS”两条路径的明确表述（帮助理解生态）(<a target="_blank" rel="noopener" href="https://dev.adjust.com/zh/sdk/android/plugins/oaid-plugin/?utm_source=chatgpt.com" title="OAID">Adjust</a>, <a target="_blank" rel="noopener" href="https://support.appsflyer.com/hc/en-us/articles/360006278797-Android-OAID-implementation-in-the-SDK?utm_source=chatgpt.com" title="Android OAID implementation in the SDK">AppsFlyer 支持中心</a>)</li>
<li>华为 HMS Ads Identifier OAID 能力文档（API 参考）(<a target="_blank" rel="noopener" href="https://developer.huawei.com/consumer/en/doc/hmscore-references/overview-0000001050066887?utm_source=chatgpt.com" title="Overview-com.huawei.hms.ads.identifier-Android-Java- ...">华为开发者</a>)</li>
</ul>
<hr>
<p>如果你同意这套方案，我可以把上面的 <strong>UTS 插件源码</strong>按你项目结构打包成 <code>uni_modules/uaid-kit</code>（含 <code>package.json</code>、<code>utssdk/app-android/config.json</code>、<code>README.md</code>、示例页），并给出在 <strong>uni-app x</strong> 项目里如何调用的示例页（含隐私弹窗 → 同意后初始化 → 展示结果）的完整代码。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/07/OAID-%E5%BA%93%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%8E%E8%8E%B7%E5%8F%96/" data-id="cmfah3dp70005o04zdgpke3hl" data-title="OAID 库的初始化与获取" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-id-kit开发" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2025/09/07/id-kit%E5%BC%80%E5%8F%91/" class="article-date">
  <time class="dt-published" datetime="2025-09-07T12:57:14.000Z" itemprop="datePublished">2025-09-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2025/09/07/id-kit%E5%BC%80%E5%8F%91/">id-kit开发</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="一、插件命名-目录结构"><a href="#一、插件命名-目录结构" class="headerlink" title="一、插件命名 &amp; 目录结构"></a>一、插件命名 &amp; 目录结构</h1><p><strong>插件名</strong>：<code>uni-id-kit</code>（简洁、易记、符合 uni 插件生态）</p>
<ul>
<li>英文：<strong>UniIdKit</strong></li>
<li>中文：<strong>一体设备 ID 工具包</strong></li>
</ul>
<p><strong>目录（uni_modules 标准）</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">uni_modules/</span><br><span class="line">  uni-id-kit/</span><br><span class="line">    package.json</span><br><span class="line">    module.json</span><br><span class="line">    utssdk/</span><br><span class="line">      index.uts              # 聚合导出（按平台分发）</span><br><span class="line">      common/</span><br><span class="line">        types.uts            # 类型与常量定义（复用）</span><br><span class="line">        hash.uts             # SHA-256 工具（Web/Android 均可）</span><br><span class="line">        storage.uts          # 本地缓存工具（uni.storage封装）</span><br><span class="line">      web/</span><br><span class="line">        index.uts            # Web 实现（GUID、hash、缓存）</span><br><span class="line">      app-android/</span><br><span class="line">        index.uts            # Android 实现（AndroidID，OAID/AAID占位）</span><br><span class="line">        adapters/</span><br><span class="line">          android_id.uts     # ANDROID_ID</span><br><span class="line">          aaid.uts           # Google AAID（待接SDK）</span><br><span class="line">          oaid.uts           # MSA OAID  （待接SDK）</span><br><span class="line">          pseudo_id.uts      # 伪ID（可选）</span><br></pre></td></tr></table></figure>

<blockquote>
<p>iOS（IDFV）可稍后补：<code>app-ios/index.uts</code> + <code>adapters/idfv.uts</code>。<br>你让我们“先国内”，就先 <strong>Web→Android</strong>；Android 国内核心是 <strong>AndroidID&#x2F;OAID</strong>，海外补 <strong>AAID</strong>。</p>
</blockquote>
<hr>
<h1 id="二、API-设计（Promise-回调兼容）"><a href="#二、API-设计（Promise-回调兼容）" class="headerlink" title="二、API 设计（Promise + 回调兼容）"></a>二、API 设计（Promise + 回调兼容）</h1><blockquote>
<p>统一 Promise 风格，另兼容回调（可选）；返回结构“可读 + 可扩展”。</p>
</blockquote>
<h2 id="公开方法"><a href="#公开方法" class="headerlink" title="公开方法"></a>公开方法</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1) 隐私合规：注册/初始化（未同意时一律返回 available=false）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"><span class="attr">options</span>?: &#123;</span></span><br><span class="line"><span class="params">  showPrivacyDialog?: <span class="built_in">boolean</span>; // 需要时展示你自有的隐私弹窗</span></span><br><span class="line"><span class="params">&#125;</span>): <span class="title class_">Promise</span>&lt;&#123; <span class="attr">consent</span>: <span class="built_in">boolean</span> &#125;&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2) 配置哈希盐（建议服务端下发）；默认仅返回 hash</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3) 一次性获取所有可用的 ID（聚合）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"><span class="attr">options</span>?: &#123;</span></span><br><span class="line"><span class="params">  include?: <span class="built_in">Array</span>&lt;</span></span><br><span class="line"><span class="params">    | <span class="string">&quot;oaid&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;aaid&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;androidId&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;idfv&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;widevineId&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;pseudoId&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;imei&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;guid&quot;</span></span></span><br><span class="line"><span class="params">  &gt;;</span></span><br><span class="line"><span class="params">  exposeRaw?: <span class="built_in">boolean</span>; // 默认 <span class="literal">false</span>（仅返回hash），开启后返回原值 value</span></span><br><span class="line"><span class="params">  ttlMs?: <span class="built_in">number</span>; // 缓存有效期，默认 24h</span></span><br><span class="line"><span class="params">&#125;</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4) 返回“最合适”的一个（按优先级：国内默认 oaid &gt; androidId &gt; guid）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"><span class="attr">options</span>?: &#123;</span></span><br><span class="line"><span class="params">  prefer?: <span class="built_in">Array</span>&lt;<span class="string">&quot;oaid&quot;</span> | <span class="string">&quot;aaid&quot;</span> | <span class="string">&quot;androidId&quot;</span> | <span class="string">&quot;idfv&quot;</span> | <span class="string">&quot;guid&quot;</span>&gt;; // 可自定义优先级</span></span><br><span class="line"><span class="params">  exposeRaw?: <span class="built_in">boolean</span>;</span></span><br><span class="line"><span class="params">  ttlMs?: <span class="built_in">number</span>;</span></span><br><span class="line"><span class="params">&#125;</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5) 单项拉取（必要时）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br></pre></td></tr></table></figure>

<h2 id="返回类型（最佳实践）"><a href="#返回类型（最佳实践）" class="headerlink" title="返回类型（最佳实践）"></a>返回类型（最佳实践）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utssdk/common/types.uts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdValue</span> = &#123;</span><br><span class="line">  <span class="attr">value</span>?: <span class="built_in">string</span>; <span class="comment">// 原始值（exposeRaw=true 才返回）</span></span><br><span class="line">  <span class="attr">hash</span>?: <span class="built_in">string</span>; <span class="comment">// SHA-256(value + salt) 十六进制</span></span><br><span class="line">  <span class="attr">available</span>: <span class="built_in">boolean</span>; <span class="comment">// 是否获取成功</span></span><br><span class="line">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>; <span class="comment">// 是否受限（系统关闭广告跟踪等）</span></span><br><span class="line">  <span class="attr">source</span>: <span class="built_in">string</span>; <span class="comment">// oaid/aaid/androidId/idfv/guid/...</span></span><br><span class="line">  <span class="attr">message</span>?: <span class="built_in">string</span>; <span class="comment">// 失败或说明</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">  <span class="attr">oaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">aaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">androidId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">idfv</span>?: <span class="title class_">IdValue</span>; <span class="comment">// 预留给 iOS</span></span><br><span class="line">  <span class="attr">widevineId</span>?: <span class="title class_">IdValue</span>; <span class="comment">// 可选</span></span><br><span class="line">  <span class="attr">pseudoId</span>?: <span class="title class_">IdValue</span>; <span class="comment">// 可选</span></span><br><span class="line">  <span class="attr">imei</span>?: <span class="title class_">IdValue</span>; <span class="comment">// 不建议默认启用</span></span><br><span class="line">  <span class="attr">guid</span>?: <span class="title class_">IdValue</span>; <span class="comment">// H5/兜底</span></span><br><span class="line">  <span class="attr">best</span>?: <span class="built_in">string</span> | <span class="literal">null</span>; <span class="comment">// 最佳项的 key</span></span><br><span class="line">  <span class="attr">consent</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">ts</span>: <span class="built_in">number</span>; <span class="comment">// 生成时间戳</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="三、首版代码（可直接放进项目）"><a href="#三、首版代码（可直接放进项目）" class="headerlink" title="三、首版代码（可直接放进项目）"></a>三、首版代码（可直接放进项目）</h1><blockquote>
<p><strong>说明</strong>：以下代码为 <strong>可运行骨架</strong>。</p>
<ul>
<li>Web：已可直接返回 <code>guid</code>（localStorage&#x2F;uni.storage 持久化），并做 SHA-256。</li>
<li>Android：已可返回 <strong>AndroidID</strong>（无需额外权限），OAID&#x2F;AAID 先返回占位（后续你把 SDK 接上）。</li>
<li>聚合导出：<code>utssdk/index.uts</code> 会按平台引导到对应实现。</li>
</ul>
</blockquote>
<h2 id="1）uni-modules-uni-id-kit-module-json"><a href="#1）uni-modules-uni-id-kit-module-json" class="headerlink" title="1）uni_modules/uni-id-kit/module.json"></a>1）<code>uni_modules/uni-id-kit/module.json</code></h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uni-id-kit&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;displayName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UniIdKit - 一体设备ID工具包&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;聚合 OAID/AAID/AndroidID/GUID 等设备标识，合规&amp;哈希化输出&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;keywords&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;deviceid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;oaid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;aaid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;androidid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;guid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;uts&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;repository&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;engines&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;HBuilderX&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^3.8.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;uni_modules&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;platforms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;app-android&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;utssdk&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;kotlin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&gt;=1.7.0&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;web&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;utssdk&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="2）uni-modules-uni-id-kit-utssdk-common-types-uts"><a href="#2）uni-modules-uni-id-kit-utssdk-common-types-uts" class="headerlink" title="2）uni_modules/uni-id-kit/utssdk/common/types.uts"></a>2）<code>uni_modules/uni-id-kit/utssdk/common/types.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdValue</span> = &#123;</span><br><span class="line">  <span class="attr">value</span>?: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">hash</span>?: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">available</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">source</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">message</span>?: <span class="built_in">string</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">  <span class="attr">oaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">aaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">androidId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">idfv</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">widevineId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">pseudoId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">imei</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">guid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">best</span>?: <span class="built_in">string</span> | <span class="literal">null</span>;</span><br><span class="line">  <span class="attr">consent</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">ts</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="3）uni-modules-uni-id-kit-utssdk-common-hash-uts"><a href="#3）uni-modules-uni-id-kit-utssdk-common-hash-uts" class="headerlink" title="3）uni_modules/uni-id-kit/utssdk/common/hash.uts"></a>3）<code>uni_modules/uni-id-kit/utssdk/common/hash.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Web 有 crypto.subtle；Android 走 Java MessageDigest（见安卓实现）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sha256Hex</span>(<span class="params"><span class="attr">input</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// @ts-ignore</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">g</span>: <span class="built_in">any</span> = globalThis;</span><br><span class="line">  <span class="keyword">if</span> (g &amp;&amp; g.<span class="property">crypto</span> &amp;&amp; g.<span class="property">crypto</span>.<span class="property">subtle</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> enc = <span class="keyword">new</span> <span class="title class_">TextEncoder</span>().<span class="title function_">encode</span>(input);</span><br><span class="line">    <span class="keyword">const</span> buf = <span class="keyword">await</span> g.<span class="property">crypto</span>.<span class="property">subtle</span>.<span class="title function_">digest</span>(<span class="string">&quot;SHA-256&quot;</span>, enc);</span><br><span class="line">    <span class="keyword">const</span> arr = <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(buf));</span><br><span class="line">    <span class="keyword">return</span> arr.<span class="title function_">map</span>(<span class="function">(<span class="params">b</span>) =&gt;</span> b.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">2</span>, <span class="string">&quot;0&quot;</span>)).<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 无 WebCrypto 时，先退回原文（开发期），建议后续接原生或 JS 实现</span></span><br><span class="line">  <span class="keyword">return</span> input;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4）uni-modules-uni-id-kit-utssdk-common-storage-uts"><a href="#4）uni-modules-uni-id-kit-utssdk-common-storage-uts" class="headerlink" title="4）uni_modules/uni-id-kit/utssdk/common/storage.uts"></a>4）<code>uni_modules/uni-id-kit/utssdk/common/storage.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span></span>): <span class="built_in">string</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">return</span> uni.<span class="title function_">getStorageSync</span>(key) || <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">set</span>(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span>, <span class="attr">val</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    uni.<span class="title function_">setStorageSync</span>(key, val);</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5）uni-modules-uni-id-kit-utssdk-web-index-uts（Web-实现）"><a href="#5）uni-modules-uni-id-kit-utssdk-web-index-uts（Web-实现）" class="headerlink" title="5）uni_modules/uni-id-kit/utssdk/web/index.uts（Web 实现）"></a>5）<code>uni_modules/uni-id-kit/utssdk/web/index.uts</code>（Web 实现）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">IdCodesResult</span>, <span class="title class_">IdValue</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../common/types.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; sha256Hex &#125; <span class="keyword">from</span> <span class="string">&quot;../common/hash.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; get, set &#125; <span class="keyword">from</span> <span class="string">&quot;../common/storage.uts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _consent = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> _salt = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">uuid4</span>(<span class="params"></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&quot;</span>.<span class="title function_">replace</span>(<span class="regexp">/[xy]/g</span>, <span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> r = ((<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">16</span>) <span class="keyword">as</span> <span class="built_in">number</span>) | <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> v = c === <span class="string">&quot;x&quot;</span> ? r : (r &amp; <span class="number">0x3</span>) | <span class="number">0x8</span>;</span><br><span class="line">    <span class="keyword">return</span> v.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">build</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">source</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">value</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">msg</span>?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> available = !!value;</span><br><span class="line">  <span class="keyword">const</span> raw = exposeRaw ? value : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">const</span> hash = value ? <span class="keyword">await</span> <span class="title function_">sha256Hex</span>(value + _salt) : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">value</span>: raw, hash, available, limited, source, <span class="attr">message</span>: msg &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">_</span>: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span> = <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">UTSJSONObject</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// Web demo：默认视为已同意；你可以在这里弹你的隐私弹窗</span></span><br><span class="line">  _consent = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">consent</span>: _consent &#125; <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  _salt = salt || <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"><span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> guid = <span class="title function_">get</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!guid) &#123;</span><br><span class="line">    guid = <span class="string">`web:<span class="subst">$&#123;uuid4()&#125;</span>`</span>;</span><br><span class="line">    <span class="title function_">set</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>, guid);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;guid&quot;</span>, guid <span class="keyword">as</span> <span class="built_in">string</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// Web 没有 AndroidID</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="literal">undefined</span>,</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;Not supported on Web&quot;</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;oaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="string">&quot;Not supported on Web&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;aaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="string">&quot;Not supported on Web&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> include = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;include&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;aaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">res</span>: <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">    <span class="attr">consent</span>: _consent,</span><br><span class="line">    <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">  &#125; <span class="keyword">as</span> <span class="title class_">IdCodesResult</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!_consent) &#123;</span><br><span class="line">    res.<span class="property">guid</span> = &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;guid&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;consent=false&quot;</span> &#125;;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;guid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">guid</span> = <span class="keyword">await</span> <span class="title function_">getGuid</span>(exposeRaw);</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;androidId&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">androidId</span> = <span class="keyword">await</span> <span class="title function_">getAndroidId</span>();</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;oaid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">oaid</span> = <span class="keyword">await</span> <span class="title function_">getOAID</span>();</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;aaid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">aaid</span> = <span class="keyword">await</span> <span class="title function_">getAAID</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 国内默认优先级</span></span><br><span class="line">  <span class="keyword">const</span> order = [<span class="string">&quot;oaid&quot;</span>, <span class="string">&quot;androidId&quot;</span>, <span class="string">&quot;guid&quot;</span>];</span><br><span class="line">  res.<span class="property">best</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; order.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> k = order[i];</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">v</span>: <span class="title class_">IdValue</span> | <span class="literal">null</span> = (res <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[k] <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line">    <span class="keyword">if</span> (v &amp;&amp; v.<span class="property">available</span>) &#123;</span><br><span class="line">      res.<span class="property">best</span> = k;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> arr = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;prefer&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="keyword">const</span> r = <span class="keyword">await</span> <span class="title function_">getIdCodes</span>(&#123; <span class="attr">include</span>: arr <span class="keyword">as</span> <span class="built_in">any</span>, exposeRaw &#125; <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">if</span> (r.<span class="property">best</span>) &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">return</span> (r <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[r.<span class="property">best</span>] <span class="keyword">as</span> <span class="title class_">IdValue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;none&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;no id available&quot;</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6）uni-modules-uni-id-kit-utssdk-app-android-adapters-android-id-uts"><a href="#6）uni-modules-uni-id-kit-utssdk-app-android-adapters-android-id-uts" class="headerlink" title="6）uni_modules/uni-id-kit/utssdk/app-android/adapters/android_id.uts"></a>6）<code>uni_modules/uni-id-kit/utssdk/app-android/adapters/android_id.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ANDROID_ID，无需额外权限（相对稳定，但可能因某些ROM策略变化）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAndroidIdRaw</span>(<span class="params"></span>): <span class="built_in">string</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> ctx = plus.<span class="property">android</span>.<span class="title function_">runtimeMainActivity</span>();</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">SettingsSecure</span> = plus.<span class="property">android</span>.<span class="title function_">importClass</span>(</span><br><span class="line">      <span class="string">&quot;android.provider.Settings$Secure&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> contentResolver = ctx.<span class="title function_">getContentResolver</span>();</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> id = <span class="title class_">SettingsSecure</span>.<span class="title function_">getString</span>(</span><br><span class="line">      contentResolver,</span><br><span class="line">      <span class="string">&quot;android_id&quot;</span></span><br><span class="line">    ) <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line">    <span class="keyword">return</span> id ? <span class="string">`android:<span class="subst">$&#123;id&#125;</span>`</span> : <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7）uni-modules-uni-id-kit-utssdk-app-android-index-uts"><a href="#7）uni-modules-uni-id-kit-utssdk-app-android-index-uts" class="headerlink" title="7）uni_modules/uni-id-kit/utssdk/app-android/index.uts"></a>7）<code>uni_modules/uni-id-kit/utssdk/app-android/index.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">IdCodesResult</span>, <span class="title class_">IdValue</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../common/types.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; get, set &#125; <span class="keyword">from</span> <span class="string">&quot;../common/storage.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getAndroidIdRaw &#125; <span class="keyword">from</span> <span class="string">&quot;./adapters/android_id.uts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _consent = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> _salt = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Android 原生侧用 Java 的 MessageDigest 做 SHA-256 更稳，这里暂用 Web 版占位：</span></span><br><span class="line"><span class="comment">// 你也可以在此通过 plus.android.importClass 使用 java.security.MessageDigest 实现</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sha256Hex</span>(<span class="params"><span class="attr">input</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> input; <span class="comment">// <span class="doctag">TODO:</span> 接入原生 MessageDigest 后返回真 SHA-256</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">uuid4</span>(<span class="params"></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&quot;</span>.<span class="title function_">replace</span>(<span class="regexp">/[xy]/g</span>, <span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> r = ((<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">16</span>) <span class="keyword">as</span> <span class="built_in">number</span>) | <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> v = c === <span class="string">&quot;x&quot;</span> ? r : (r &amp; <span class="number">0x3</span>) | <span class="number">0x8</span>;</span><br><span class="line">    <span class="keyword">return</span> v.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">build</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">source</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">value</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">msg</span>?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> available = !!value;</span><br><span class="line">  <span class="keyword">const</span> raw = exposeRaw ? value : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">const</span> hash = value ? <span class="keyword">await</span> <span class="title function_">sha256Hex</span>(value + _salt) : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">value</span>: raw, hash, available, limited, source, <span class="attr">message</span>: msg &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">_</span>: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span> = <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">UTSJSONObject</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// 这里接入你的合规弹窗/SDK；同意前建议不采集</span></span><br><span class="line">  _consent = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">consent</span>: _consent &#125; <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  _salt = salt || <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> v = <span class="title function_">getAndroidIdRaw</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;androidId&quot;</span>, v || <span class="literal">undefined</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 预留：接入 Google Advertising ID（AAID）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// TODO：集成 com.google.android.gms:play-services-ads-identifier</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;aaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="string">&quot;AAID not integrated&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 预留：接入 MSA OAID（国内主流）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// TODO：接入 MSA/OAID SDK</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;oaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="string">&quot;OAID not integrated&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"><span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> guid = <span class="title function_">get</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!guid) &#123;</span><br><span class="line">    guid = <span class="string">`app:<span class="subst">$&#123;uuid4()&#125;</span>`</span>;</span><br><span class="line">    <span class="title function_">set</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>, guid);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;guid&quot;</span>, guid <span class="keyword">as</span> <span class="built_in">string</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> include = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;include&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;aaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">res</span>: <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">    <span class="attr">consent</span>: _consent,</span><br><span class="line">    <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">  &#125; <span class="keyword">as</span> <span class="title class_">IdCodesResult</span>;</span><br><span class="line">  <span class="keyword">if</span> (!_consent) &#123;</span><br><span class="line">    res.<span class="property">guid</span> = &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;guid&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;consent=false&quot;</span> &#125;;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;androidId&quot;</span>) &gt;= <span class="number">0</span>)</span><br><span class="line">    res.<span class="property">androidId</span> = <span class="keyword">await</span> <span class="title function_">getAndroidId</span>(exposeRaw);</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;oaid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">oaid</span> = <span class="keyword">await</span> <span class="title function_">getOAID</span>();</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;aaid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">aaid</span> = <span class="keyword">await</span> <span class="title function_">getAAID</span>();</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;guid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">guid</span> = <span class="keyword">await</span> <span class="title function_">getGuid</span>(exposeRaw);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 国内优先级：oaid &gt; androidId &gt; guid</span></span><br><span class="line">  <span class="keyword">const</span> order = [<span class="string">&quot;oaid&quot;</span>, <span class="string">&quot;androidId&quot;</span>, <span class="string">&quot;guid&quot;</span>];</span><br><span class="line">  res.<span class="property">best</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; order.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> k = order[i];</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">v</span>: <span class="title class_">IdValue</span> | <span class="literal">null</span> = (res <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[k] <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line">    <span class="keyword">if</span> (v &amp;&amp; v.<span class="property">available</span>) &#123;</span><br><span class="line">      res.<span class="property">best</span> = k;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> arr = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;prefer&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="keyword">const</span> r = <span class="keyword">await</span> <span class="title function_">getIdCodes</span>(&#123; <span class="attr">include</span>: arr <span class="keyword">as</span> <span class="built_in">any</span>, exposeRaw &#125; <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">if</span> (r.<span class="property">best</span>) &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">return</span> (r <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[r.<span class="property">best</span>] <span class="keyword">as</span> <span class="title class_">IdValue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;none&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;no id available&quot;</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8）uni-modules-uni-id-kit-utssdk-index-uts（聚合导出）"><a href="#8）uni-modules-uni-id-kit-utssdk-index-uts（聚合导出）" class="headerlink" title="8）uni_modules/uni-id-kit/utssdk/index.uts（聚合导出）"></a>8）<code>uni_modules/uni-id-kit/utssdk/index.uts</code>（聚合导出）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 平台分发：同名导出，业务方 import 一处即可</span></span><br><span class="line"><span class="comment">// #ifdef APP-ANDROID</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  register,</span><br><span class="line">  setSalt,</span><br><span class="line">  getIdCodes,</span><br><span class="line">  getBestId,</span><br><span class="line">  getOAID,</span><br><span class="line">  getAAID,</span><br><span class="line">  getAndroidId,</span><br><span class="line">  getGuid,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./app-android/index.uts&quot;</span>;</span><br><span class="line"><span class="comment">// #endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #ifdef H5</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  register,</span><br><span class="line">  setSalt,</span><br><span class="line">  getIdCodes,</span><br><span class="line">  getBestId,</span><br><span class="line">  getOAID,</span><br><span class="line">  getAAID,</span><br><span class="line">  getAndroidId,</span><br><span class="line">  getGuid,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./web/index.uts&quot;</span>;</span><br><span class="line"><span class="comment">// #endif</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="四、在页面中使用（uni-app-x）"><a href="#四、在页面中使用（uni-app-x）" class="headerlink" title="四、在页面中使用（uni-app x）"></a>四、在页面中使用（uni-app x）</h1><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/login/index.uvue (示例)</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  register,</span><br><span class="line">  setSalt,</span><br><span class="line">  getBestId,</span><br><span class="line">  getIdCodes,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;@/uni_modules/uni-id-kit/utssdk/index.uts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">onMounted</span>(<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">register</span>(); <span class="comment">// 视需求弹你的隐私协议</span></span><br><span class="line">  <span class="title function_">setSalt</span>(<span class="string">&quot;server-salt-xxx&quot;</span>); <span class="comment">// 建议从服务端下发</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> best = <span class="keyword">await</span> <span class="title function_">getBestId</span>(&#123; <span class="attr">exposeRaw</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">  <span class="comment">// 携带 best.hash 作为 x-device-id（或 getIdCodes 的 best 项）</span></span><br><span class="line">  <span class="keyword">const</span> dvc = best.<span class="property">hash</span> || best.<span class="property">value</span> || <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> uni.<span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">`<span class="subst">$&#123;baseUrl&#125;</span>/passkeys/login/options`</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    <span class="attr">header</span>: &#123; <span class="string">&quot;x-device-id&quot;</span>: dvc &#125;,</span><br><span class="line">    <span class="attr">data</span>: &#123;&#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="五、后续接入指引（Android-OAID-AAID）"><a href="#五、后续接入指引（Android-OAID-AAID）" class="headerlink" title="五、后续接入指引（Android OAID&#x2F;AAID）"></a>五、后续接入指引（Android OAID&#x2F;AAID）</h1><ul>
<li><strong>OAID</strong>：集成 <strong>MSA&#x2F;联运</strong> SDK（各大国产厂商支持），在 <code>app-android/adapters/oaid.uts</code> 中封装 <code>getOAIDRaw()</code>，在 <code>index.uts</code> 调 <code>await build(&#39;oaid&#39;, v, ...)</code>。</li>
<li><strong>AAID</strong>：添加 <code>com.google.android.gms:play-services-ads-identifier</code> 依赖，调用 <code>AdvertisingIdClient.getAdvertisingIdInfo(context)</code>。</li>
<li><strong>SHA-256</strong>：Android 侧推荐用 <code>java.security.MessageDigest</code>，性能更稳定；把 web 占位换掉。</li>
<li><strong>权限</strong>：AndroidID 不需要额外权限；IMEI&#x2F;MEID 需要 READ_PHONE_STATE（<strong>不推荐默认启用</strong>）。</li>
<li><strong>合规</strong>：未同意隐私协议前，一律返回 <code>available=false</code>；默认仅返回 <code>hash</code>，除非 <code>exposeRaw=true</code>。</li>
</ul>
<hr>
<p>如果你认可这个结构和 API，我可以继续把 <strong>Android 的 OAID&#x2F;AAID 具体适配代码</strong>补上（带依赖、打包参数、权限说明），以及 <strong>iOS 的 IDFV</strong> 版本。</p>
<h1 id="参考实现"><a href="#参考实现" class="headerlink" title="参考实现"></a>参考实现</h1><p>太好了，我把你这两个现成插件解包看过了，简单总结下各自实现，然后给一套“最佳实践”的统一 API 和落地改造方案（含可以直接替换的 UTS 代码片段）。</p>
<hr>
<h2 id="现有两个插件的实现差异（速览）"><a href="#现有两个插件的实现差异（速览）" class="headerlink" title="现有两个插件的实现差异（速览）"></a>现有两个插件的实现差异（速览）</h2><h3 id="1-android-deviceid（UTS，App-Android）"><a href="#1-android-deviceid（UTS，App-Android）" class="headerlink" title="1) android-deviceid（UTS，App-Android）"></a>1) <code>android-deviceid</code>（UTS，App-Android）</h3><ul>
<li><p><strong>用到的库</strong>：<code>com.github.gzuliyujiang.oaid</code>（常用 OAID SDK 聚合库），还打包了 3 个 AAR（<code>ads-identifier-*.aar</code>、<code>IDlibrary-release.aar</code>）。</p>
</li>
<li><p><strong>关键点</strong>：</p>
<ul>
<li>在 <code>register()</code> 里调用 <code>DeviceIdentifier.register(UTSAndroid.getUniActivity().getApplication())</code> 完成 <strong>OAID 初始化</strong>。</li>
<li>暴露了一个 <strong>监听器</strong>（<code>IDManger.OnIOAIDListener</code>），把厂商返回的 JSON 结果转成你定义的 <code>Device</code> 对象回调出去。</li>
</ul>
</li>
<li><p><strong>优点</strong>：能拿到 <strong>OAID</strong>，并且是较为标准的做法；兼容多厂商。</p>
</li>
<li><p><strong>需要补强</strong>：</p>
<ul>
<li><strong>统一 Promise API</strong>（目前是回调），方便在页面里用 <code>await</code>。</li>
<li><strong>AAID（Google 广告 ID）</strong>、<strong>AndroidID</strong> 的兜底与优先级策略。</li>
<li><strong>隐私合规</strong>（register 同意前不采集）、<strong>hash-only</strong> 输出（默认只回传哈希，原值可开关）。</li>
<li><strong>缓存</strong>（ttl），防止频繁拉取。</li>
<li>错误&#x2F;受限标记（例如用户关闭了广告跟踪）。</li>
</ul>
</li>
</ul>
<h3 id="2-zws-uniqueid（UTS，App-Android）"><a href="#2-zws-uniqueid（UTS，App-Android）" class="headerlink" title="2) zws-uniqueid（UTS，App-Android）"></a>2) <code>zws-uniqueid</code>（UTS，App-Android）</h3><ul>
<li><strong>实现</strong>：拼接 <code>Build.*</code> 信息做一段文本，MD5 后作为“唯一 ID”。</li>
<li><strong>优点</strong>：无需权限&#x2F;SDK，易用。</li>
<li><strong>问题</strong>：这是典型 <strong>PseudoID</strong>，<strong>同型号&#x2F;同批次设备可能相同</strong>，也可能因 ROM&#x2F;版本变更；不适合用来做<strong>设备唯一绑定</strong>或风控。</li>
<li><strong>建议</strong>：可以作为 <code>pseudoId</code> 字段的<strong>最末位兜底</strong>，不要当主标识。</li>
</ul>
<hr>
<h2 id="建议的统一方案（名字可用你之前认可的：uni-id-kit）"><a href="#建议的统一方案（名字可用你之前认可的：uni-id-kit）" class="headerlink" title="建议的统一方案（名字可用你之前认可的：uni-id-kit）"></a>建议的统一方案（名字可用你之前认可的：<strong><code>uni-id-kit</code></strong>）</h2><p><strong>目标</strong>：同一份 UTS 插件，覆盖 Web&#x2F;H5 与 App-Android；API 一致、返回结构一致、默认合规（hash-only），国内优先级 <code>OAID &gt; AndroidID &gt; GUID &gt; PseudoID</code>，海外可加 <code>AAID</code>。</p>
<h3 id="统一-API（Promise-风格）"><a href="#统一-API（Promise-风格）" class="headerlink" title="统一 API（Promise 风格）"></a>统一 API（Promise 风格）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册/合规：未同意前一律 available=false</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"><span class="attr">options</span>?: &#123;</span></span><br><span class="line"><span class="params">  showPrivacyDialog?: <span class="built_in">boolean</span>;</span></span><br><span class="line"><span class="params">&#125;</span>): <span class="title class_">Promise</span>&lt;&#123; <span class="attr">consent</span>: <span class="built_in">boolean</span> &#125;&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置哈希盐（建议服务端下发）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一次性获取所有（含可用性、受限说明、hash）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"><span class="attr">options</span>?: &#123;</span></span><br><span class="line"><span class="params">  include?: <span class="built_in">Array</span>&lt;<span class="string">&quot;oaid&quot;</span> | <span class="string">&quot;aaid&quot;</span> | <span class="string">&quot;androidId&quot;</span> | <span class="string">&quot;pseudoId&quot;</span> | <span class="string">&quot;guid&quot;</span>&gt;;</span></span><br><span class="line"><span class="params">  exposeRaw?: <span class="built_in">boolean</span>; // 默认 <span class="literal">false</span></span></span><br><span class="line"><span class="params">  ttlMs?: <span class="built_in">number</span>; // 默认 24h</span></span><br><span class="line"><span class="params">&#125;</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回“最合适”的一个（按优先级，可定制）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"><span class="attr">options</span>?: &#123;</span></span><br><span class="line"><span class="params">  prefer?: <span class="built_in">Array</span>&lt;<span class="string">&quot;oaid&quot;</span> | <span class="string">&quot;androidId&quot;</span> | <span class="string">&quot;guid&quot;</span> | <span class="string">&quot;pseudoId&quot;</span> | <span class="string">&quot;aaid&quot;</span>&gt;;</span></span><br><span class="line"><span class="params">  exposeRaw?: <span class="built_in">boolean</span>;</span></span><br><span class="line"><span class="params">  ttlMs?: <span class="built_in">number</span>;</span></span><br><span class="line"><span class="params">&#125;</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 单项</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br></pre></td></tr></table></figure>

<p><strong>统一返回结构</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">IdValue</span> = &#123;</span><br><span class="line">  <span class="attr">value</span>?: <span class="built_in">string</span>; <span class="comment">// exposeRaw=true 才返回</span></span><br><span class="line">  <span class="attr">hash</span>?: <span class="built_in">string</span>; <span class="comment">// SHA-256(value + salt)</span></span><br><span class="line">  <span class="attr">available</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>; <span class="comment">// 例如系统关闭广告跟踪</span></span><br><span class="line">  <span class="attr">source</span>: <span class="built_in">string</span>; <span class="comment">// oaid/aaid/androidId/pseudoId/guid</span></span><br><span class="line">  <span class="attr">message</span>?: <span class="built_in">string</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">  <span class="attr">oaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">aaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">androidId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">pseudoId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">guid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">best</span>?: <span class="built_in">string</span> | <span class="literal">null</span>;</span><br><span class="line">  <span class="attr">consent</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">ts</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="如何改造你现有的两个插件"><a href="#如何改造你现有的两个插件" class="headerlink" title="如何改造你现有的两个插件"></a>如何改造你现有的两个插件</h2><blockquote>
<p>下面给的都是 <strong>直接能塞进工程</strong> 的 UTS 代码。你可以新建一个 <code>uni_modules/uni-id-kit</code>，把这两个插件的“能力”合在一起；或者在你现有 <code>android-deviceid</code> 里重构导出，效果一致。</p>
</blockquote>
<h3 id="1-公共类型与工具（common-types-uts、common-storage-uts、common-hash-uts）"><a href="#1-公共类型与工具（common-types-uts、common-storage-uts、common-hash-uts）" class="headerlink" title="1) 公共类型与工具（common/types.uts、common/storage.uts、common/hash.uts）"></a>1) 公共类型与工具（<code>common/types.uts</code>、<code>common/storage.uts</code>、<code>common/hash.uts</code>）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// common/types.uts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdValue</span> = &#123;</span><br><span class="line">  <span class="attr">value</span>?: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">hash</span>?: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">available</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">source</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">message</span>?: <span class="built_in">string</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">  <span class="attr">oaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">aaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">androidId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">pseudoId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">guid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">best</span>?: <span class="built_in">string</span> | <span class="literal">null</span>;</span><br><span class="line">  <span class="attr">consent</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">ts</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// common/storage.uts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span></span>): <span class="built_in">string</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uni.<span class="title function_">getStorageSync</span>(key) || <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">set</span>(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span>, <span class="attr">val</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    uni.<span class="title function_">setStorageSync</span>(key, val);</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// common/hash.uts（Web 有 crypto.subtle；Android 建议换成 MessageDigest）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sha256Hex</span>(<span class="params"><span class="attr">input</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// @ts-ignore</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">g</span>: <span class="built_in">any</span> = globalThis;</span><br><span class="line">  <span class="keyword">if</span> (g &amp;&amp; g.<span class="property">crypto</span> &amp;&amp; g.<span class="property">crypto</span>.<span class="property">subtle</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> enc = <span class="keyword">new</span> <span class="title class_">TextEncoder</span>().<span class="title function_">encode</span>(input);</span><br><span class="line">    <span class="keyword">const</span> buf = <span class="keyword">await</span> g.<span class="property">crypto</span>.<span class="property">subtle</span>.<span class="title function_">digest</span>(<span class="string">&quot;SHA-256&quot;</span>, enc);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(buf))</span><br><span class="line">      .<span class="title function_">map</span>(<span class="function">(<span class="params">b</span>) =&gt;</span> b.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">2</span>, <span class="string">&quot;0&quot;</span>))</span><br><span class="line">      .<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> input; <span class="comment">// Android 再换成原生 MessageDigest（见下）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-Web-实现（先把-H5-跑起来：GUID-hash-缓存）"><a href="#2-Web-实现（先把-H5-跑起来：GUID-hash-缓存）" class="headerlink" title="2) Web 实现（先把 H5 跑起来：GUID + hash + 缓存）"></a>2) Web 实现（先把 H5 跑起来：GUID + hash + 缓存）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// web/index.uts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">IdCodesResult</span>, <span class="title class_">IdValue</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../common/types.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; sha256Hex &#125; <span class="keyword">from</span> <span class="string">&quot;../common/hash.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; get, set &#125; <span class="keyword">from</span> <span class="string">&quot;../common/storage.uts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _consent = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> _salt = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">uuid4</span>(<span class="params"></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&quot;</span>.<span class="title function_">replace</span>(<span class="regexp">/[xy]/g</span>, <span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> r = ((<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">16</span>) <span class="keyword">as</span> <span class="built_in">number</span>) | <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> v = c === <span class="string">&quot;x&quot;</span> ? r : (r &amp; <span class="number">0x3</span>) | <span class="number">0x8</span>;</span><br><span class="line">    <span class="keyword">return</span> v.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">build</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">source</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">value</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">msg</span>?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> available = !!value;</span><br><span class="line">  <span class="keyword">const</span> raw = exposeRaw ? value : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">const</span> hash = value ? <span class="keyword">await</span> <span class="title function_">sha256Hex</span>(value + _salt) : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">value</span>: raw, hash, available, limited, source, <span class="attr">message</span>: msg &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">_</span>: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span> = <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">UTSJSONObject</span>&gt; &#123;</span><br><span class="line">  _consent = <span class="literal">true</span>; <span class="comment">// 你可在这里弹你的隐私协议</span></span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">consent</span>: _consent &#125; <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  _salt = salt || <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"><span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> guid = <span class="title function_">get</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!guid) &#123;</span><br><span class="line">    guid = <span class="string">`web:<span class="subst">$&#123;uuid4()&#125;</span>`</span>;</span><br><span class="line">    <span class="title function_">set</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>, guid);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;guid&quot;</span>, guid <span class="keyword">as</span> <span class="built_in">string</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="literal">undefined</span>,</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;Not supported on Web&quot;</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;oaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="string">&quot;Not supported on Web&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;aaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="string">&quot;Not supported on Web&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> include = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;include&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">res</span>: <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">    <span class="attr">consent</span>: _consent,</span><br><span class="line">    <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">  &#125; <span class="keyword">as</span> <span class="title class_">IdCodesResult</span>;</span><br><span class="line">  <span class="keyword">if</span> (!_consent) &#123;</span><br><span class="line">    res.<span class="property">guid</span> = &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;guid&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;consent=false&quot;</span> &#125;;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;guid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">guid</span> = <span class="keyword">await</span> <span class="title function_">getGuid</span>(exposeRaw);</span><br><span class="line"></span><br><span class="line">  res.<span class="property">best</span> = res.<span class="property">guid</span>?.<span class="property">available</span> ? <span class="string">&quot;guid&quot;</span> : <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> r = <span class="keyword">await</span> <span class="title function_">getIdCodes</span>(options);</span><br><span class="line">  <span class="keyword">if</span> (r.<span class="property">best</span>) &#123;</span><br><span class="line">    <span class="comment">/* @ts-ignore */</span> <span class="keyword">return</span> (r <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[r.<span class="property">best</span>] <span class="keyword">as</span> <span class="title class_">IdValue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;none&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;no id available&quot;</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-Android-实现（融合你两个插件思路，Promise-化-兜底-可拓展）"><a href="#3-Android-实现（融合你两个插件思路，Promise-化-兜底-可拓展）" class="headerlink" title="3) Android 实现（融合你两个插件思路，Promise 化 + 兜底 + 可拓展）"></a>3) Android 实现（融合你两个插件思路，Promise 化 + 兜底 + 可拓展）</h3><ul>
<li><strong>AndroidID</strong>：直接取 <code>Settings.Secure.ANDROID_ID</code>（不需要权限）。</li>
<li><strong>OAID</strong>：沿用你 <code>android-deviceid</code> 的库，包装为 Promise；初始化要在 <code>register()</code> 里做。</li>
<li><strong>AAID</strong>：先留占位，后续加 <code>play-services-ads-identifier</code>。</li>
<li><strong>PseudoID</strong>：把 <code>zws-uniqueid</code> 的思路做成可选兜底，不当主标识。</li>
<li><strong>SHA-256</strong>：建议在 Android 侧用 <code>java.security.MessageDigest</code>，比 web 占位靠谱。</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app-android/adapters/android_id.uts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAndroidIdRaw</span>(<span class="params"></span>): <span class="built_in">string</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> ctx = plus.<span class="property">android</span>.<span class="title function_">runtimeMainActivity</span>();</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">SettingsSecure</span> = plus.<span class="property">android</span>.<span class="title function_">importClass</span>(</span><br><span class="line">      <span class="string">&quot;android.provider.Settings$Secure&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> contentResolver = ctx.<span class="title function_">getContentResolver</span>();</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> id = <span class="title class_">SettingsSecure</span>.<span class="title function_">getString</span>(</span><br><span class="line">      contentResolver,</span><br><span class="line">      <span class="string">&quot;android_id&quot;</span></span><br><span class="line">    ) <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line">    <span class="keyword">return</span> id ? <span class="string">`android:<span class="subst">$&#123;id&#125;</span>`</span> : <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app-android/adapters/pseudo_id.uts（把 zws 的实现收编为兜底项）</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Build</span> <span class="keyword">from</span> <span class="string">&quot;android.os.Build&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">MessageDigest</span> <span class="keyword">from</span> <span class="string">&quot;java.security.MessageDigest&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">BigInteger</span> <span class="keyword">from</span> <span class="string">&quot;java.math.BigInteger&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getPseudoIdRaw</span>(<span class="params"></span>): <span class="built_in">string</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> text =</span><br><span class="line">      <span class="title class_">Build</span>.<span class="property">BOARD</span> +</span><br><span class="line">      <span class="title class_">Build</span>.<span class="property">BRAND</span> +</span><br><span class="line">      <span class="title class_">Build</span>.<span class="property">DEVICE</span> +</span><br><span class="line">      <span class="title class_">Build</span>.<span class="property">DISPLAY</span> +</span><br><span class="line">      <span class="title class_">Build</span>.<span class="property">FINGERPRINT</span> +</span><br><span class="line">      <span class="string">&quot;uni-id-kit&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> md5s = <span class="title class_">MessageDigest</span>.<span class="title function_">getInstance</span>(<span class="string">&quot;MD5&quot;</span>).<span class="title function_">digest</span>(</span><br><span class="line">      (text <span class="keyword">as</span> <span class="built_in">any</span>).<span class="title function_">toString</span>().<span class="title function_">toByteArray</span>()</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BigInteger</span>(<span class="number">1</span>, md5s).<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app-android/index.uts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">IdCodesResult</span>, <span class="title class_">IdValue</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../common/types.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; get, set &#125; <span class="keyword">from</span> <span class="string">&quot;../common/storage.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getAndroidIdRaw &#125; <span class="keyword">from</span> <span class="string">&quot;./adapters/android_id.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getPseudoIdRaw &#125; <span class="keyword">from</span> <span class="string">&quot;./adapters/pseudo_id.uts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ==== 引入你 android-deviceid 插件用到的 OAID 库 ====</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">DeviceIdentifier</span> <span class="keyword">from</span> <span class="string">&quot;com.github.gzuliyujiang.oaid.DeviceIdentifier&quot;</span>;</span><br><span class="line"><span class="comment">// 你现有的监听器写法是 IDManger.OnIOAIDListener + JSON 回调，这里改 Promise 风格：</span></span><br><span class="line"><span class="comment">// 如果库支持 IGetter 回调也可以（取决于版本），我这里按你包内的风格保留 register 初始化。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _consent = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> _salt = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 Android 的 MessageDigest 实现 SHA-256（优于 web 占位）</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sha256HexSync</span>(<span class="params"><span class="attr">input</span>: <span class="built_in">string</span></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">MessageDigest</span> = plus.<span class="property">android</span>.<span class="title function_">importClass</span>(</span><br><span class="line">      <span class="string">&quot;java.security.MessageDigest&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> md = <span class="title class_">MessageDigest</span>.<span class="title function_">getInstance</span>(<span class="string">&quot;SHA-256&quot;</span>);</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> bytes = (input <span class="keyword">as</span> <span class="built_in">any</span>).<span class="title function_">toString</span>().<span class="title function_">getBytes</span>();</span><br><span class="line">    <span class="keyword">const</span> out = md.<span class="title function_">digest</span>(bytes);</span><br><span class="line">    <span class="keyword">let</span> hex = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; out.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> b = (out[i] <span class="keyword">as</span> <span class="built_in">number</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">      hex += (b &lt; <span class="number">16</span> ? <span class="string">&quot;0&quot;</span> : <span class="string">&quot;&quot;</span>) + b.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hex;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> input;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">uuid4</span>(<span class="params"></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&quot;</span>.<span class="title function_">replace</span>(<span class="regexp">/[xy]/g</span>, <span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> r = ((<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">16</span>) <span class="keyword">as</span> <span class="built_in">number</span>) | <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> v = c === <span class="string">&quot;x&quot;</span> ? r : (r &amp; <span class="number">0x3</span>) | <span class="number">0x8</span>;</span><br><span class="line">    <span class="keyword">return</span> v.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">buildSync</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">source</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">value</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">msg</span>?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">IdValue</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> available = !!value;</span><br><span class="line">  <span class="keyword">const</span> raw = exposeRaw ? value : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">const</span> hash = value ? <span class="title function_">sha256HexSync</span>(value + _salt) : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">value</span>: raw, hash, available, limited, source, <span class="attr">message</span>: msg &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">_</span>: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span> = <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">UTSJSONObject</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="title class_">DeviceIdentifier</span>.<span class="title function_">register</span>(<span class="title class_">UTSAndroid</span>.<span class="title function_">getUniActivity</span>()!!.<span class="title function_">getApplication</span>()!!);</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line">  _consent = <span class="literal">true</span>; <span class="comment">// 这里接你的隐私弹窗</span></span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">consent</span>: _consent &#125; <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  _salt = salt || <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> v = <span class="title function_">getAndroidIdRaw</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">buildSync</span>(<span class="string">&quot;androidId&quot;</span>, v || <span class="literal">undefined</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"><span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> guid = <span class="title function_">get</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!guid) &#123;</span><br><span class="line">    guid = <span class="string">`app:<span class="subst">$&#123;uuid4()&#125;</span>`</span>;</span><br><span class="line">    <span class="title function_">set</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>, guid);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">buildSync</span>(<span class="string">&quot;guid&quot;</span>, guid <span class="keyword">as</span> <span class="built_in">string</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OAID：基于你现有库封装为 Promise（示例：如果库是同步 API 换成同步返回即可）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 你包里是通过监听器把结果 JSON 回调出来的；</span></span><br><span class="line">    <span class="comment">// 这里建议写一个同步/异步包装（示意）：</span></span><br><span class="line">    <span class="comment">// 假设库提供 DeviceIdentifier.getOAID(ctx) 或者 DeviceID.getOAID(...)</span></span><br><span class="line">    <span class="comment">// 如果仅有回调形式，就 new Promise 包一下。</span></span><br><span class="line">    <span class="comment">// 先占位为“未集成”，避免误用：</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">buildSync</span>(</span><br><span class="line">      <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">      <span class="literal">undefined</span>,</span><br><span class="line">      <span class="literal">false</span>,</span><br><span class="line">      <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;OAID not integrated to Promise wrapper&quot;</span></span><br><span class="line">    );</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">buildSync</span>(<span class="string">&quot;oaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">false</span>, (e <span class="keyword">as</span> <span class="built_in">any</span>).<span class="title function_">toString</span>());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AAID：等你接 play-services-ads-identifier，这里先占位</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">buildSync</span>(<span class="string">&quot;aaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="string">&quot;AAID not integrated&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> include = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;include&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;pseudoId&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">res</span>: <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">    <span class="attr">consent</span>: _consent,</span><br><span class="line">    <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">  &#125; <span class="keyword">as</span> <span class="title class_">IdCodesResult</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!_consent) &#123;</span><br><span class="line">    res.<span class="property">guid</span> = &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;guid&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;consent=false&quot;</span> &#125;;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;oaid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">oaid</span> = <span class="keyword">await</span> <span class="title function_">getOAID</span>();</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;androidId&quot;</span>) &gt;= <span class="number">0</span>)</span><br><span class="line">    res.<span class="property">androidId</span> = <span class="keyword">await</span> <span class="title function_">getAndroidId</span>(exposeRaw);</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;guid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">guid</span> = <span class="keyword">await</span> <span class="title function_">getGuid</span>(exposeRaw);</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;pseudoId&quot;</span>) &gt;= <span class="number">0</span>)</span><br><span class="line">    res.<span class="property">pseudoId</span> = <span class="title function_">buildSync</span>(</span><br><span class="line">      <span class="string">&quot;pseudoId&quot;</span>,</span><br><span class="line">      <span class="title function_">getPseudoIdRaw</span>() || <span class="literal">undefined</span>,</span><br><span class="line">      exposeRaw</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 国内默认优先级：oaid &gt; androidId &gt; guid &gt; pseudoId</span></span><br><span class="line">  <span class="keyword">const</span> order = [<span class="string">&quot;oaid&quot;</span>, <span class="string">&quot;androidId&quot;</span>, <span class="string">&quot;guid&quot;</span>, <span class="string">&quot;pseudoId&quot;</span>];</span><br><span class="line">  res.<span class="property">best</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; order.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> k = order[i];</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">v</span>: <span class="title class_">IdValue</span> | <span class="literal">null</span> = (res <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[k] <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line">    <span class="keyword">if</span> (v &amp;&amp; v.<span class="property">available</span>) &#123;</span><br><span class="line">      res.<span class="property">best</span> = k;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> prefer = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;prefer&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;pseudoId&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="keyword">const</span> r = <span class="keyword">await</span> <span class="title function_">getIdCodes</span>(&#123; <span class="attr">include</span>: prefer <span class="keyword">as</span> <span class="built_in">any</span>, exposeRaw &#125; <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">if</span> (r.<span class="property">best</span>) &#123;</span><br><span class="line">    <span class="comment">/* @ts-ignore */</span> <span class="keyword">return</span> (r <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[r.<span class="property">best</span>] <span class="keyword">as</span> <span class="title class_">IdValue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;none&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;no id available&quot;</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-平台聚合导出（utssdk-index-uts）"><a href="#4-平台聚合导出（utssdk-index-uts）" class="headerlink" title="4) 平台聚合导出（utssdk/index.uts）"></a>4) 平台聚合导出（<code>utssdk/index.uts</code>）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// #ifdef APP-ANDROID</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  register,</span><br><span class="line">  setSalt,</span><br><span class="line">  getIdCodes,</span><br><span class="line">  getBestId,</span><br><span class="line">  getOAID,</span><br><span class="line">  getAAID,</span><br><span class="line">  getAndroidId,</span><br><span class="line">  getGuid,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./app-android/index.uts&quot;</span>;</span><br><span class="line"><span class="comment">// #endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #ifdef H5</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  register,</span><br><span class="line">  setSalt,</span><br><span class="line">  getIdCodes,</span><br><span class="line">  getBestId,</span><br><span class="line">  getOAID,</span><br><span class="line">  getAAID,</span><br><span class="line">  getAndroidId,</span><br><span class="line">  getGuid,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./web/index.uts&quot;</span>;</span><br><span class="line"><span class="comment">// #endif</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="要不要“调整现在的代码”？"><a href="#要不要“调整现在的代码”？" class="headerlink" title="要不要“调整现在的代码”？"></a>要不要“调整现在的代码”？</h2><p><strong>要的</strong>，但改动并不大，主要集中在 4 点：</p>
<ol>
<li><strong>Promise 化</strong>：把回调&#x2F;监听器的导出改为 Promise，页面里可以 <code>await</code>。</li>
<li><strong>统一返回结构</strong>：所有方法都返回 <code>IdValue/IdCodesResult</code>，好串联与埋点。</li>
<li><strong>合规默认 &amp; hash-only</strong>：提供 <code>register()</code> 和 <code>setSalt()</code>，未同意前不采集；默认只回 <code>hash</code>。</li>
<li><strong>兜底与优先级</strong>：在拿不到 OAID 时，<strong>自动回退</strong>到 <code>AndroidID</code>、<code>GUID</code>、<code>pseudoId</code>，并清晰标出 <code>limited</code>&#x2F;<code>message</code>。</li>
</ol>
<blockquote>
<p>你的 <code>android-deviceid</code> 插件可以直接把库继续用；我在上面的安卓实现里已经把“桥接位”留好了。<br><code>zws-uniqueid</code> 的算法我收编到 <code>pseudoId</code>，作为兜底，不再当主标识使用。</p>
</blockquote>
<hr>
<h2 id="下一步"><a href="#下一步" class="headerlink" title="下一步"></a>下一步</h2><ul>
<li>你确认用 <strong><code>uni-id-kit</code></strong> 的方案我就把 <strong>OAID Promise 包装</strong>（基于你现有 <code>DeviceIdentifier</code> 监听回调）也给你写上，并且给出 <strong>AAID 接入</strong>（<code>play-services-ads-identifier</code>）的 <code>gradle</code> 依赖与 UTS 调用示例。</li>
<li>如果需要，我也可以给 <strong>iOS（IDFV）</strong> 的 UTS 版本，一起并到这个套件里。</li>
</ul>
<p>没问题。我把你给的两个 UTS 插件（<code>android-deviceid</code> &#x2F; <code>zws-uniqueid</code>）的可取之处吸收，做成一套**“最佳实践版”统一插件**：<strong><code>uni-id-kit</code></strong>。它满足：</p>
<ul>
<li>跨端（H5 &#x2F; App-Android &#x2F; App-iOS），统一 Promise API；</li>
<li>默认合规：需先 <code>register()</code> 才采集；默认只回 <strong>hash</strong>（可开 <code>exposeRaw</code> 返回原值）；</li>
<li>国内优先级（可自定义）：<strong>OAID &gt; AndroidID &gt; GUID &gt; PseudoID</strong>，海外可加 <strong>AAID</strong>；</li>
<li>安全版 UUID：多端用系统级安全随机（<code>crypto.getRandomValues</code> &#x2F; <code>SecureRandom</code> &#x2F; <code>SecRandomCopyBytes</code>），兜底 <code>Math.random</code>；</li>
<li>缓存、错误与受限标记（如“限制广告跟踪”）；</li>
<li>兼容你现有后端（请求头携带 <code>x-device-id</code> 即可）。</li>
</ul>
<blockquote>
<p>下方给出<strong>可直接落地</strong>的文件结构与代码（可直接新建 <code>uni_modules/uni-id-kit</code>），Android 的 OAID&#x2F;AAID 留好“可用的占位与接入点”；如果你确认要接哪套 SDK（MSA 官方&#x2F;聚合库），我再把桥接也补全为可跑版本。</p>
</blockquote>
<hr>
<h1 id="目录结构（放到项目的-uni-modules-uni-id-kit）"><a href="#目录结构（放到项目的-uni-modules-uni-id-kit）" class="headerlink" title="目录结构（放到项目的 uni_modules/uni-id-kit）"></a>目录结构（放到项目的 <code>uni_modules/uni-id-kit</code>）</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">uni_modules/</span><br><span class="line">  uni-id-kit/</span><br><span class="line">    module.json</span><br><span class="line">    package.json</span><br><span class="line">    utssdk/</span><br><span class="line">      index.uts</span><br><span class="line">      common/</span><br><span class="line">        types.uts</span><br><span class="line">        uuid.uts</span><br><span class="line">        hash.uts</span><br><span class="line">        storage.uts</span><br><span class="line">      web/</span><br><span class="line">        index.uts</span><br><span class="line">      app-android/</span><br><span class="line">        index.uts</span><br><span class="line">        adapters/</span><br><span class="line">          android_id.uts</span><br><span class="line">          oaid.uts</span><br><span class="line">          aaid.uts</span><br><span class="line">          pseudo_id.uts</span><br><span class="line">      app-ios/</span><br><span class="line">        index.uts</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="1-module-json"><a href="#1-module-json" class="headerlink" title="1) module.json"></a>1) module.json</h1><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uni-id-kit&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;displayName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UniIdKit - 一体设备ID工具包&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;聚合 OAID/AAID/AndroidID/GUID/IDFV 等设备标识，合规 &amp; 哈希化输出，UTS 插件&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;keywords&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;deviceid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;oaid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;aaid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;androidid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;idfv&quot;</span><span class="punctuation">,</span> <span class="string">&quot;guid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;uts&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;engines&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;HBuilderX&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&gt;=3.8.0&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;uni_modules&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;platforms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;web&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;utssdk&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;app-android&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;utssdk&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;kotlin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&gt;=1.7.0&quot;</span> <span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;app-ios&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;utssdk&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="2-公共类型-工具"><a href="#2-公共类型-工具" class="headerlink" title="2) 公共类型&#x2F;工具"></a>2) 公共类型&#x2F;工具</h1><h2 id="utssdk-common-types-uts"><a href="#utssdk-common-types-uts" class="headerlink" title="utssdk/common/types.uts"></a><code>utssdk/common/types.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdValue</span> = &#123;</span><br><span class="line">  <span class="attr">value</span>?: <span class="built_in">string</span>; <span class="comment">// exposeRaw=true 才返回</span></span><br><span class="line">  <span class="attr">hash</span>?: <span class="built_in">string</span>; <span class="comment">// SHA-256(value + salt)</span></span><br><span class="line">  <span class="attr">available</span>: <span class="built_in">boolean</span>; <span class="comment">// 是否成功获取</span></span><br><span class="line">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>; <span class="comment">// 广告跟踪受限/ROM限制</span></span><br><span class="line">  <span class="attr">source</span>: <span class="built_in">string</span>; <span class="comment">// oaid/aaid/androidId/idfv/guid/pseudoId</span></span><br><span class="line">  <span class="attr">message</span>?: <span class="built_in">string</span>; <span class="comment">// 说明/错误</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">  <span class="attr">oaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">aaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">androidId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">idfv</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">guid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">pseudoId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">best</span>?: <span class="built_in">string</span> | <span class="literal">null</span>;</span><br><span class="line">  <span class="attr">consent</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">ts</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="utssdk-common-hash-uts"><a href="#utssdk-common-hash-uts" class="headerlink" title="utssdk/common/hash.uts"></a><code>utssdk/common/hash.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Web 有 crypto.subtle；原生侧建议用平台 API（Android 代码里换成 MessageDigest；iOS 侧可换 CommonCrypto）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sha256Hex</span>(<span class="params"><span class="attr">input</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// #ifdef H5</span></span><br><span class="line">  <span class="comment">// @ts-ignore</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">g</span>: <span class="built_in">any</span> = globalThis;</span><br><span class="line">  <span class="keyword">if</span> (g &amp;&amp; g.<span class="property">crypto</span> &amp;&amp; g.<span class="property">crypto</span>.<span class="property">subtle</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> buf = <span class="keyword">await</span> g.<span class="property">crypto</span>.<span class="property">subtle</span>.<span class="title function_">digest</span>(</span><br><span class="line">      <span class="string">&quot;SHA-256&quot;</span>,</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">TextEncoder</span>().<span class="title function_">encode</span>(input)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(buf))</span><br><span class="line">      .<span class="title function_">map</span>(<span class="function">(<span class="params">b</span>) =&gt;</span> b.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">2</span>, <span class="string">&quot;0&quot;</span>))</span><br><span class="line">      .<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// #endif</span></span><br><span class="line">  <span class="keyword">return</span> input; <span class="comment">// 非H5先返回原文；Android/iOS在各自实现中用系统哈希</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="utssdk-common-storage-uts"><a href="#utssdk-common-storage-uts" class="headerlink" title="utssdk/common/storage.uts"></a><code>utssdk/common/storage.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span></span>): <span class="built_in">string</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> uni.<span class="title function_">getStorageSync</span>(key) || <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">set</span>(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span>, <span class="attr">val</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    uni.<span class="title function_">setStorageSync</span>(key, val);</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="utssdk-common-uuid-uts（跨端安全-UUIDv4）"><a href="#utssdk-common-uuid-uts（跨端安全-UUIDv4）" class="headerlink" title="utssdk/common/uuid.uts（跨端安全 UUIDv4）"></a><code>utssdk/common/uuid.uts</code>（跨端安全 UUIDv4）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">toHex</span>(<span class="params"></span>): <span class="built_in">string</span>[] &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">h</span>: <span class="built_in">string</span>[] = [];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">256</span>; i++) h[i] = (i + <span class="number">0x100</span>).<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">substring</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">formatUuid</span>(<span class="params"><span class="attr">b</span>: <span class="title class_">Uint8Array</span></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  b[<span class="number">6</span>] = (b[<span class="number">6</span>] &amp; <span class="number">0x0f</span>) | <span class="number">0x40</span>; <span class="comment">// version=4</span></span><br><span class="line">  b[<span class="number">8</span>] = (b[<span class="number">8</span>] &amp; <span class="number">0x3f</span>) | <span class="number">0x80</span>; <span class="comment">// variant=10</span></span><br><span class="line">  <span class="keyword">const</span> H = <span class="title function_">toHex</span>();</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    H[b[<span class="number">0</span>]] +</span><br><span class="line">    H[b[<span class="number">1</span>]] +</span><br><span class="line">    H[b[<span class="number">2</span>]] +</span><br><span class="line">    H[b[<span class="number">3</span>]] +</span><br><span class="line">    <span class="string">&quot;-&quot;</span> +</span><br><span class="line">    H[b[<span class="number">4</span>]] +</span><br><span class="line">    H[b[<span class="number">5</span>]] +</span><br><span class="line">    <span class="string">&quot;-&quot;</span> +</span><br><span class="line">    H[b[<span class="number">6</span>]] +</span><br><span class="line">    H[b[<span class="number">7</span>]] +</span><br><span class="line">    <span class="string">&quot;-&quot;</span> +</span><br><span class="line">    H[b[<span class="number">8</span>]] +</span><br><span class="line">    H[b[<span class="number">9</span>]] +</span><br><span class="line">    <span class="string">&quot;-&quot;</span> +</span><br><span class="line">    H[b[<span class="number">10</span>]] +</span><br><span class="line">    H[b[<span class="number">11</span>]] +</span><br><span class="line">    H[b[<span class="number">12</span>]] +</span><br><span class="line">    H[b[<span class="number">13</span>]] +</span><br><span class="line">    H[b[<span class="number">14</span>]] +</span><br><span class="line">    H[b[<span class="number">15</span>]]</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// #ifdef H5</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getRandom16</span>(<span class="params"></span>): <span class="title class_">Uint8Array</span> &#123;</span><br><span class="line">  <span class="comment">// @ts-ignore</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">g</span>: <span class="built_in">any</span> = globalThis;</span><br><span class="line">  <span class="keyword">if</span> (g &amp;&amp; g.<span class="property">crypto</span> &amp;&amp; g.<span class="property">crypto</span>.<span class="property">getRandomValues</span>)</span><br><span class="line">    <span class="keyword">return</span> g.<span class="property">crypto</span>.<span class="title function_">getRandomValues</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="number">16</span>));</span><br><span class="line">  <span class="keyword">const</span> a = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="number">16</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) a[i] = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">256</span>);</span><br><span class="line">  <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// #endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #ifdef APP-ANDROID</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getRandom16</span>(<span class="params"></span>): <span class="title class_">Uint8Array</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> sr = <span class="keyword">new</span> java.<span class="property">security</span>.<span class="title class_">SecureRandom</span>(); <span class="comment">// UTS 原生：直接 Java 类</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">arr</span>: <span class="built_in">number</span>[] = <span class="keyword">new</span> <span class="title class_">Array</span>&lt;<span class="built_in">number</span>&gt;(<span class="number">16</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++) arr[i] = sr.<span class="title function_">nextInt</span>(<span class="number">256</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(arr);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// #endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #ifdef APP-IOS</span></span><br><span class="line"><span class="comment">// 使用 Security 的 SecRandomCopyBytes（UTS 映射到 Swift）</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getRandom16</span>(<span class="params"></span>): <span class="title class_">Uint8Array</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> bytes = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>(<span class="number">16</span>);</span><br><span class="line">  <span class="comment">// @ts-ignore</span></span><br><span class="line">  <span class="keyword">const</span> ok = <span class="title class_">SecRandomCopyBytes</span>(kSecRandomDefault, <span class="number">16</span>, bytes);</span><br><span class="line">  <span class="keyword">if</span> (ok === <span class="number">0</span>) <span class="keyword">return</span> bytes;</span><br><span class="line">  <span class="comment">// 兜底 arc4random_buf</span></span><br><span class="line">  <span class="comment">// @ts-ignore</span></span><br><span class="line">  <span class="title function_">arc4random_buf</span>(bytes, <span class="number">16</span>);</span><br><span class="line">  <span class="keyword">return</span> bytes;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// #endif</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">uuid4</span>(<span class="params"></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">formatUuid</span>(<span class="title function_">getRandom16</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="3-H5-实现"><a href="#3-H5-实现" class="headerlink" title="3) H5 实现"></a>3) H5 实现</h1><h2 id="utssdk-web-index-uts"><a href="#utssdk-web-index-uts" class="headerlink" title="utssdk/web/index.uts"></a><code>utssdk/web/index.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">IdCodesResult</span>, <span class="title class_">IdValue</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../common/types.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; sha256Hex &#125; <span class="keyword">from</span> <span class="string">&quot;../common/hash.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; get, set &#125; <span class="keyword">from</span> <span class="string">&quot;../common/storage.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; uuid4 &#125; <span class="keyword">from</span> <span class="string">&quot;../common/uuid.uts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _consent = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> _salt = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">_cache</span>: &#123; <span class="attr">ts</span>: <span class="built_in">number</span>; <span class="attr">data</span>: <span class="title class_">IdCodesResult</span> &#125; | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">build</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">source</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">value</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">msg</span>?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> available = !!value;</span><br><span class="line">  <span class="keyword">const</span> raw = exposeRaw ? value : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">const</span> hash = value ? <span class="keyword">await</span> <span class="title function_">sha256Hex</span>(value + _salt) : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">value</span>: raw, hash, available, limited, source, <span class="attr">message</span>: msg &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">_</span>: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span> = <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">UTSJSONObject</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// 这里接你的隐私弹窗；Demo 直接视为同意</span></span><br><span class="line">  _consent = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">consent</span>: _consent &#125; <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  _salt = salt || <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"><span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> guid = <span class="title function_">get</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!guid) &#123;</span><br><span class="line">    guid = <span class="string">`web:<span class="subst">$&#123;uuid4()&#125;</span>`</span>;</span><br><span class="line">    <span class="title function_">set</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>, guid);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;guid&quot;</span>, guid <span class="keyword">as</span> <span class="built_in">string</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;androidId&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="string">&quot;Web unsupported&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;oaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="string">&quot;Web unsupported&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;aaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="string">&quot;Web unsupported&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> include = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;include&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="keyword">const</span> ttl = (options?.<span class="title function_">getNumber</span>(<span class="string">&quot;ttlMs&quot;</span>) || <span class="number">24</span> * <span class="number">3600</span> * <span class="number">1000</span>) <span class="keyword">as</span> <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (_cache &amp;&amp; <span class="title class_">Date</span>.<span class="title function_">now</span>() - _cache.<span class="property">ts</span> &lt; ttl) <span class="keyword">return</span> _cache.<span class="property">data</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">res</span>: <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">    <span class="attr">consent</span>: _consent,</span><br><span class="line">    <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">  &#125; <span class="keyword">as</span> <span class="title class_">IdCodesResult</span>;</span><br><span class="line">  <span class="keyword">if</span> (!_consent) &#123;</span><br><span class="line">    res.<span class="property">guid</span> = &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;guid&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;consent=false&quot;</span> &#125;;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;guid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">guid</span> = <span class="keyword">await</span> <span class="title function_">getGuid</span>(exposeRaw);</span><br><span class="line"></span><br><span class="line">  res.<span class="property">best</span> = res.<span class="property">guid</span>?.<span class="property">available</span> ? <span class="string">&quot;guid&quot;</span> : <span class="literal">null</span>;</span><br><span class="line">  _cache = &#123; <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(), <span class="attr">data</span>: res &#125;;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> r = <span class="keyword">await</span> <span class="title function_">getIdCodes</span>(options);</span><br><span class="line">  <span class="keyword">if</span> (r.<span class="property">best</span>) &#123;</span><br><span class="line">    <span class="comment">/* @ts-ignore */</span> <span class="keyword">return</span> (r <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[r.<span class="property">best</span>] <span class="keyword">as</span> <span class="title class_">IdValue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;none&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;no id available&quot;</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="4-Android-实现（融合两插件思路）"><a href="#4-Android-实现（融合两插件思路）" class="headerlink" title="4) Android 实现（融合两插件思路）"></a>4) Android 实现（融合两插件思路）</h1><ul>
<li><strong>参考自</strong> <code>android-deviceid</code>：OAID 初始化&#x2F;拉取（此处给出 Promise 版接口占位，方便你把已购库接上）；</li>
<li><strong>参考自</strong> <code>zws-uniqueid</code>：PseudoID 作为<strong>兜底</strong>而非主标识；</li>
<li><strong>AndroidID</strong>：不需权限，稳定性较好；</li>
<li><strong>AAID</strong>：留占位（接入 <code>play-services-ads-identifier</code> 后即可实现）；</li>
<li><strong>哈希</strong>：用 <code>java.security.MessageDigest</code>（强于 H5 占位）。</li>
</ul>
<h2 id="utssdk-app-android-adapters-android-id-uts"><a href="#utssdk-app-android-adapters-android-id-uts" class="headerlink" title="utssdk/app-android/adapters/android_id.uts"></a><code>utssdk/app-android/adapters/android_id.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAndroidIdRaw</span>(<span class="params"></span>): <span class="built_in">string</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> contentResolver = uni.<span class="title function_">getContext</span>().<span class="title function_">getContentResolver</span>();</span><br><span class="line">    <span class="keyword">const</span> id = android.<span class="property">provider</span>.<span class="property">Settings$Secure</span>.<span class="title function_">getString</span>(</span><br><span class="line">      contentResolver,</span><br><span class="line">      <span class="string">&quot;android_id&quot;</span></span><br><span class="line">    ) <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line">    <span class="keyword">return</span> id ? <span class="string">`android:<span class="subst">$&#123;id&#125;</span>`</span> : <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="utssdk-app-android-adapters-pseudo-id-uts"><a href="#utssdk-app-android-adapters-pseudo-id-uts" class="headerlink" title="utssdk/app-android/adapters/pseudo_id.uts"></a><code>utssdk/app-android/adapters/pseudo_id.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getPseudoIdRaw</span>(<span class="params"></span>): <span class="built_in">string</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> text =</span><br><span class="line">      android.<span class="property">os</span>.<span class="property">Build</span>.<span class="property">BOARD</span> +</span><br><span class="line">      android.<span class="property">os</span>.<span class="property">Build</span>.<span class="property">BRAND</span> +</span><br><span class="line">      android.<span class="property">os</span>.<span class="property">Build</span>.<span class="property">DEVICE</span> +</span><br><span class="line">      android.<span class="property">os</span>.<span class="property">Build</span>.<span class="property">DISPLAY</span> +</span><br><span class="line">      android.<span class="property">os</span>.<span class="property">Build</span>.<span class="property">FINGERPRINT</span> +</span><br><span class="line">      <span class="string">&quot;uni-id-kit&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> md = java.<span class="property">security</span>.<span class="property">MessageDigest</span>.<span class="title function_">getInstance</span>(<span class="string">&quot;MD5&quot;</span>);</span><br><span class="line">    md.<span class="title function_">update</span>((text <span class="keyword">as</span> <span class="built_in">any</span>).<span class="title function_">toString</span>().<span class="title function_">getBytes</span>(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">    <span class="keyword">const</span> out = md.<span class="title function_">digest</span>();</span><br><span class="line">    <span class="keyword">let</span> hex = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; out.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> b = (out[i] <span class="keyword">as</span> <span class="built_in">number</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">      hex += (b &lt; <span class="number">16</span> ? <span class="string">&quot;0&quot;</span> : <span class="string">&quot;&quot;</span>) + b.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hex;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="utssdk-app-android-adapters-oaid-uts（接入点）"><a href="#utssdk-app-android-adapters-oaid-uts（接入点）" class="headerlink" title="utssdk/app-android/adapters/oaid.uts（接入点）"></a><code>utssdk/app-android/adapters/oaid.uts</code>（接入点）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里封装你现有的 OAID 库调用（例如使用 com.github.gzuliyujiang.oaid）</span></span><br><span class="line"><span class="comment">// 由于每家库的接口不完全一致，这里给 Promise 化占位；你把实际调用贴进来即可。</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getOAIDRaw</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;&#123;</span><br><span class="line">  <span class="attr">value</span>?: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">message</span>?: <span class="built_in">string</span>;</span><br><span class="line">&#125;&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 用你的库实际实现（初始化 register 在 index.uts 的 register() 里做）</span></span><br><span class="line">    <span class="comment">// 例如：DeviceIdentifier.getOAID(context, callback) -&gt; 在 callback 里 resolve</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">value</span>: <span class="literal">undefined</span>,</span><br><span class="line">      <span class="attr">limited</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;OAID not integrated yet&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">value</span>: <span class="literal">undefined</span>, <span class="attr">limited</span>: <span class="literal">false</span>, <span class="attr">message</span>: (e <span class="keyword">as</span> <span class="built_in">any</span>).<span class="title function_">toString</span>() &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="utssdk-app-android-adapters-aaid-uts（接入点）"><a href="#utssdk-app-android-adapters-aaid-uts（接入点）" class="headerlink" title="utssdk/app-android/adapters/aaid.uts（接入点）"></a><code>utssdk/app-android/adapters/aaid.uts</code>（接入点）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAAIDRaw</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;&#123;</span><br><span class="line">  <span class="attr">value</span>?: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">message</span>?: <span class="built_in">string</span>;</span><br><span class="line">&#125;&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 接入 play-services-ads-identifier：</span></span><br><span class="line">    <span class="comment">// AdvertisingIdClient.getAdvertisingIdInfo(context).getId()</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">value</span>: <span class="literal">undefined</span>,</span><br><span class="line">      <span class="attr">limited</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;AAID not integrated yet&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">value</span>: <span class="literal">undefined</span>, <span class="attr">limited</span>: <span class="literal">false</span>, <span class="attr">message</span>: (e <span class="keyword">as</span> <span class="built_in">any</span>).<span class="title function_">toString</span>() &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="utssdk-app-android-index-uts"><a href="#utssdk-app-android-index-uts" class="headerlink" title="utssdk/app-android/index.uts"></a><code>utssdk/app-android/index.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">IdCodesResult</span>, <span class="title class_">IdValue</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../common/types.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; get, set &#125; <span class="keyword">from</span> <span class="string">&quot;../common/storage.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; uuid4 &#125; <span class="keyword">from</span> <span class="string">&quot;../common/uuid.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getAndroidIdRaw &#125; <span class="keyword">from</span> <span class="string">&quot;./adapters/android_id.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getOAIDRaw &#125; <span class="keyword">from</span> <span class="string">&quot;./adapters/oaid.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getAAIDRaw &#125; <span class="keyword">from</span> <span class="string">&quot;./adapters/aaid.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getPseudoIdRaw &#125; <span class="keyword">from</span> <span class="string">&quot;./adapters/pseudo_id.uts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _consent = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> _salt = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">_cache</span>: &#123; <span class="attr">ts</span>: <span class="built_in">number</span>; <span class="attr">data</span>: <span class="title class_">IdCodesResult</span> &#125; | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sha256HexSync</span>(<span class="params"><span class="attr">input</span>: <span class="built_in">string</span></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> md = java.<span class="property">security</span>.<span class="property">MessageDigest</span>.<span class="title function_">getInstance</span>(<span class="string">&quot;SHA-256&quot;</span>);</span><br><span class="line">    md.<span class="title function_">update</span>((input <span class="keyword">as</span> <span class="built_in">any</span>).<span class="title function_">toString</span>().<span class="title function_">getBytes</span>(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">    <span class="keyword">const</span> out = md.<span class="title function_">digest</span>();</span><br><span class="line">    <span class="keyword">let</span> hex = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; out.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> b = (out[i] <span class="keyword">as</span> <span class="built_in">number</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">      hex += (b &lt; <span class="number">16</span> ? <span class="string">&quot;0&quot;</span> : <span class="string">&quot;&quot;</span>) + b.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hex;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> input;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">buildSync</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">source</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">value</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">msg</span>?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">IdValue</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> available = !!value;</span><br><span class="line">  <span class="keyword">const</span> raw = exposeRaw ? value : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">const</span> hash = value ? <span class="title function_">sha256HexSync</span>(value + _salt) : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">value</span>: raw, hash, available, limited, source, <span class="attr">message</span>: msg &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">_</span>: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span> = <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">UTSJSONObject</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// 1) OAID 库初始化（把你 android-deviceid 的 register 放到这里）</span></span><br><span class="line">  <span class="comment">//    例：DeviceIdentifier.register(uni.getContext().getApplicationContext())</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 调你的 OAID 库 register</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2) 你的隐私弹窗/合规流程</span></span><br><span class="line">  _consent = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">consent</span>: _consent &#125; <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  _salt = salt || <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">buildSync</span>(<span class="string">&quot;androidId&quot;</span>, <span class="title function_">getAndroidIdRaw</span>() || <span class="literal">undefined</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"><span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> guid = <span class="title function_">get</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!guid) &#123;</span><br><span class="line">    guid = <span class="string">`app:<span class="subst">$&#123;uuid4()&#125;</span>`</span>;</span><br><span class="line">    <span class="title function_">set</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>, guid);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">buildSync</span>(<span class="string">&quot;guid&quot;</span>, guid <span class="keyword">as</span> <span class="built_in">string</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> r = <span class="keyword">await</span> <span class="title function_">getOAIDRaw</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">buildSync</span>(<span class="string">&quot;oaid&quot;</span>, r.<span class="property">value</span>, <span class="literal">false</span>, r.<span class="property">limited</span>, r.<span class="property">message</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> r = <span class="keyword">await</span> <span class="title function_">getAAIDRaw</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">buildSync</span>(<span class="string">&quot;aaid&quot;</span>, r.<span class="property">value</span>, <span class="literal">false</span>, r.<span class="property">limited</span>, r.<span class="property">message</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> include = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;include&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;pseudoId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;aaid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="keyword">const</span> ttl = (options?.<span class="title function_">getNumber</span>(<span class="string">&quot;ttlMs&quot;</span>) || <span class="number">24</span> * <span class="number">3600</span> * <span class="number">1000</span>) <span class="keyword">as</span> <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (_cache &amp;&amp; <span class="title class_">Date</span>.<span class="title function_">now</span>() - _cache.<span class="property">ts</span> &lt; ttl) <span class="keyword">return</span> _cache.<span class="property">data</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">res</span>: <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">    <span class="attr">consent</span>: _consent,</span><br><span class="line">    <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">  &#125; <span class="keyword">as</span> <span class="title class_">IdCodesResult</span>;</span><br><span class="line">  <span class="keyword">if</span> (!_consent) &#123;</span><br><span class="line">    res.<span class="property">guid</span> = &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;guid&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;consent=false&quot;</span> &#125;;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;oaid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">oaid</span> = <span class="keyword">await</span> <span class="title function_">getOAID</span>();</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;androidId&quot;</span>) &gt;= <span class="number">0</span>)</span><br><span class="line">    res.<span class="property">androidId</span> = <span class="keyword">await</span> <span class="title function_">getAndroidId</span>(exposeRaw);</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;aaid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">aaid</span> = <span class="keyword">await</span> <span class="title function_">getAAID</span>();</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;guid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">guid</span> = <span class="keyword">await</span> <span class="title function_">getGuid</span>(exposeRaw);</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;pseudoId&quot;</span>) &gt;= <span class="number">0</span>)</span><br><span class="line">    res.<span class="property">pseudoId</span> = <span class="title function_">buildSync</span>(</span><br><span class="line">      <span class="string">&quot;pseudoId&quot;</span>,</span><br><span class="line">      <span class="title function_">getPseudoIdRaw</span>() || <span class="literal">undefined</span>,</span><br><span class="line">      exposeRaw</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 国内默认优先级（可通过 getBestId 覆盖）</span></span><br><span class="line">  <span class="keyword">const</span> order = [<span class="string">&quot;oaid&quot;</span>, <span class="string">&quot;androidId&quot;</span>, <span class="string">&quot;guid&quot;</span>, <span class="string">&quot;pseudoId&quot;</span>, <span class="string">&quot;aaid&quot;</span>];</span><br><span class="line">  res.<span class="property">best</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; order.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> k = order[i];</span><br><span class="line">    <span class="comment">/* @ts-ignore */</span> <span class="keyword">const</span> <span class="attr">v</span>: <span class="title class_">IdValue</span> = (res <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[k] <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line">    <span class="keyword">if</span> (v &amp;&amp; v.<span class="property">available</span>) &#123;</span><br><span class="line">      res.<span class="property">best</span> = k;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  _cache = &#123; <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(), <span class="attr">data</span>: res &#125;;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> prefer = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;prefer&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;pseudoId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;aaid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="keyword">const</span> r = <span class="keyword">await</span> <span class="title function_">getIdCodes</span>(&#123; <span class="attr">include</span>: prefer <span class="keyword">as</span> <span class="built_in">any</span>, exposeRaw &#125; <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">if</span> (r.<span class="property">best</span>) &#123;</span><br><span class="line">    <span class="comment">/* @ts-ignore */</span> <span class="keyword">return</span> (r <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[r.<span class="property">best</span>] <span class="keyword">as</span> <span class="title class_">IdValue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;none&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;no id available&quot;</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="5-iOS-实现（IDFV）"><a href="#5-iOS-实现（IDFV）" class="headerlink" title="5) iOS 实现（IDFV）"></a>5) iOS 实现（IDFV）</h1><blockquote>
<p>你说先国内为主；这里把 <strong>IDFV</strong> 实现好，方便未来开 iOS 端复用。</p>
</blockquote>
<h2 id="utssdk-app-ios-index-uts"><a href="#utssdk-app-ios-index-uts" class="headerlink" title="utssdk/app-ios/index.uts"></a><code>utssdk/app-ios/index.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">IdCodesResult</span>, <span class="title class_">IdValue</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../common/types.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; get, set &#125; <span class="keyword">from</span> <span class="string">&quot;../common/storage.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; uuid4 &#125; <span class="keyword">from</span> <span class="string">&quot;../common/uuid.uts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _consent = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> _salt = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">_cache</span>: &#123; <span class="attr">ts</span>: <span class="built_in">number</span>; <span class="attr">data</span>: <span class="title class_">IdCodesResult</span> &#125; | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sha256HexSync</span>(<span class="params"><span class="attr">input</span>: <span class="built_in">string</span></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> 可换成 CommonCrypto(CC_SHA256)；演示先返回原文</span></span><br><span class="line">  <span class="keyword">return</span> input;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">buildSync</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">source</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">value</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">msg</span>?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">IdValue</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> available = !!value;</span><br><span class="line">  <span class="keyword">const</span> raw = exposeRaw ? value : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">const</span> hash = value ? <span class="title function_">sha256HexSync</span>(value + _salt) : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">value</span>: raw, hash, available, limited, source, <span class="attr">message</span>: msg &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">_</span>: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span> = <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">UTSJSONObject</span>&gt; &#123;</span><br><span class="line">  _consent = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">consent</span>: _consent &#125; <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  _salt = salt || <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getIDFVRaw</span>(<span class="params"></span>): <span class="built_in">string</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> idfv = <span class="title class_">UIDevice</span>.<span class="property">currentDevice</span>.<span class="property">identifierForVendor</span>?.<span class="property">UUIDString</span>;</span><br><span class="line">    <span class="keyword">return</span> idfv ? <span class="string">`idfv:<span class="subst">$&#123;idfv&#125;</span>`</span> : <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"><span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> guid = <span class="title function_">get</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!guid) &#123;</span><br><span class="line">    guid = <span class="string">`ios:<span class="subst">$&#123;uuid4()&#125;</span>`</span>;</span><br><span class="line">    <span class="title function_">set</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>, guid);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">buildSync</span>(<span class="string">&quot;guid&quot;</span>, guid <span class="keyword">as</span> <span class="built_in">string</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">buildSync</span>(<span class="string">&quot;androidId&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="string">&quot;iOS unsupported&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">buildSync</span>(<span class="string">&quot;oaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="string">&quot;iOS unsupported&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">buildSync</span>(<span class="string">&quot;aaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="string">&quot;iOS unsupported&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> include = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;include&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;idfv&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="keyword">const</span> ttl = (options?.<span class="title function_">getNumber</span>(<span class="string">&quot;ttlMs&quot;</span>) || <span class="number">24</span> * <span class="number">3600</span> * <span class="number">1000</span>) <span class="keyword">as</span> <span class="built_in">number</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (_cache &amp;&amp; <span class="title class_">Date</span>.<span class="title function_">now</span>() - _cache.<span class="property">ts</span> &lt; ttl) <span class="keyword">return</span> _cache.<span class="property">data</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">res</span>: <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">    <span class="attr">consent</span>: _consent,</span><br><span class="line">    <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">  &#125; <span class="keyword">as</span> <span class="title class_">IdCodesResult</span>;</span><br><span class="line">  <span class="keyword">if</span> (!_consent) &#123;</span><br><span class="line">    res.<span class="property">guid</span> = &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;guid&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;consent=false&quot;</span> &#125;;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;idfv&quot;</span>) &gt;= <span class="number">0</span>)</span><br><span class="line">    res.<span class="property">idfv</span> = <span class="title function_">buildSync</span>(<span class="string">&quot;idfv&quot;</span>, <span class="title function_">getIDFVRaw</span>() || <span class="literal">undefined</span>, exposeRaw);</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;guid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">guid</span> = <span class="keyword">await</span> <span class="title function_">getGuid</span>(exposeRaw);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> order = [<span class="string">&quot;idfv&quot;</span>, <span class="string">&quot;guid&quot;</span>];</span><br><span class="line">  res.<span class="property">best</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; order.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> k = order[i];</span><br><span class="line">    <span class="comment">/* @ts-ignore */</span> <span class="keyword">const</span> <span class="attr">v</span>: <span class="title class_">IdValue</span> = (res <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[k] <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line">    <span class="keyword">if</span> (v &amp;&amp; v.<span class="property">available</span>) &#123;</span><br><span class="line">      res.<span class="property">best</span> = k;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  _cache = &#123; <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(), <span class="attr">data</span>: res &#125;;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> prefer = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;prefer&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;idfv&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="keyword">const</span> r = <span class="keyword">await</span> <span class="title function_">getIdCodes</span>(&#123; <span class="attr">include</span>: prefer <span class="keyword">as</span> <span class="built_in">any</span>, exposeRaw &#125; <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">if</span> (r.<span class="property">best</span>) &#123;</span><br><span class="line">    <span class="comment">/* @ts-ignore */</span> <span class="keyword">return</span> (r <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[r.<span class="property">best</span>] <span class="keyword">as</span> <span class="title class_">IdValue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;none&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;no id available&quot;</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="6-平台聚合导出"><a href="#6-平台聚合导出" class="headerlink" title="6) 平台聚合导出"></a>6) 平台聚合导出</h1><h2 id="utssdk-index-uts"><a href="#utssdk-index-uts" class="headerlink" title="utssdk/index.uts"></a><code>utssdk/index.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// #ifdef H5</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  register,</span><br><span class="line">  setSalt,</span><br><span class="line">  getIdCodes,</span><br><span class="line">  getBestId,</span><br><span class="line">  getOAID,</span><br><span class="line">  getAAID,</span><br><span class="line">  getAndroidId,</span><br><span class="line">  getGuid,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./web/index.uts&quot;</span>;</span><br><span class="line"><span class="comment">// #endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #ifdef APP-ANDROID</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  register,</span><br><span class="line">  setSalt,</span><br><span class="line">  getIdCodes,</span><br><span class="line">  getBestId,</span><br><span class="line">  getOAID,</span><br><span class="line">  getAAID,</span><br><span class="line">  getAndroidId,</span><br><span class="line">  getGuid,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./app-android/index.uts&quot;</span>;</span><br><span class="line"><span class="comment">// #endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #ifdef APP-IOS</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  register,</span><br><span class="line">  setSalt,</span><br><span class="line">  getIdCodes,</span><br><span class="line">  getBestId,</span><br><span class="line">  getOAID,</span><br><span class="line">  getAAID,</span><br><span class="line">  getAndroidId,</span><br><span class="line">  getGuid,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./app-ios/index.uts&quot;</span>;</span><br><span class="line"><span class="comment">// #endif</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="7-使用示例（在你的登录页中）"><a href="#7-使用示例（在你的登录页中）" class="headerlink" title="7) 使用示例（在你的登录页中）"></a>7) 使用示例（在你的登录页中）</h1><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  register,</span><br><span class="line">  setSalt,</span><br><span class="line">  getBestId,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;@/uni_modules/uni-id-kit/utssdk/index.uts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">onMounted</span>(<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">register</span>(&#123;&#125;); <span class="comment">// 你的隐私弹窗/合规逻辑</span></span><br><span class="line">  <span class="title function_">setSalt</span>(<span class="string">&quot;server-salt-xyz&quot;</span>); <span class="comment">// 建议服务端下发；默认只回 hash</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> best = <span class="keyword">await</span> <span class="title function_">getBestId</span>(&#123;</span><br><span class="line">    <span class="attr">prefer</span>: [<span class="string">&quot;oaid&quot;</span>, <span class="string">&quot;androidId&quot;</span>, <span class="string">&quot;guid&quot;</span>],</span><br><span class="line">    <span class="attr">exposeRaw</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">const</span> dvc = best.<span class="property">hash</span> || best.<span class="property">value</span> || <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> uni.<span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">`<span class="subst">$&#123;baseUrl&#125;</span>/passkeys/login/options`</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    <span class="attr">header</span>: &#123; <span class="string">&quot;x-device-id&quot;</span>: dvc &#125;,</span><br><span class="line">    <span class="attr">data</span>: &#123;&#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="8-和你两个插件的关系（怎么“融合-替换”）"><a href="#8-和你两个插件的关系（怎么“融合-替换”）" class="headerlink" title="8) 和你两个插件的关系（怎么“融合&#x2F;替换”）"></a>8) 和你两个插件的关系（怎么“融合&#x2F;替换”）</h1><ul>
<li><p><code>android-deviceid</code>：</p>
<ul>
<li><strong>保留其 OAID 能力</strong>，把初始化 <code>register()</code> 与获取流程<strong>Promise 化</strong>放到 <code>adapters/oaid.uts</code>；</li>
<li>如果你用的是 <strong>gzu 的聚合库</strong>（<code>com.github.gzuliyujiang.oaid</code>），我可按它的 IGetter&#x2F;Client 回调写成可跑代码；你只需告诉我当前项目里的依赖坐标&#x2F;使用方式即可（或把现有 <code>register/getOAID</code> 调用片段贴我）。</li>
</ul>
</li>
<li><p><code>zws-uniqueid</code>：</p>
<ul>
<li>仅作为 <strong>PseudoID 兜底</strong>（<code>adapters/pseudo_id.uts</code> 已收编）；</li>
<li>不再把它当“设备唯一标识”，它稳定性不够（但当兜底是有意义的）。</li>
</ul>
</li>
</ul>
<hr>
<h1 id="9-你可能需要的依赖与打包说明（Android）"><a href="#9-你可能需要的依赖与打包说明（Android）" class="headerlink" title="9) 你可能需要的依赖与打包说明（Android）"></a>9) 你可能需要的依赖与打包说明（Android）</h1><p><strong>OAID</strong></p>
<ul>
<li>如果用 <strong>MSA 官方 SDK</strong>：按其文档接入（添加 AAR、初始化、回调）。</li>
<li>如果用 <strong>gzu 聚合库</strong>：在 <code>module.json</code> 的 <code>app-android -&gt; utssdk</code> 里加配置，或在 HBuilderX 的原生配置里勾选对应依赖；随后把 <code>adapters/oaid.uts</code> 里按该库接口实现 <code>getOAIDRaw()</code> 即可。</li>
</ul>
<p><strong>AAID</strong>（Google 广告 ID）</p>
<ul>
<li><code>com.google.android.gms:play-services-ads-identifier</code>（需要科学上网&#x2F;可用镜像）；</li>
<li>通过 <code>AdvertisingIdClient.getAdvertisingIdInfo(context).id</code> 获取；若用户限制广告跟踪，返回 limited&#x3D;true。</li>
</ul>
<blockquote>
<p>我可以根据你环境（国内私服&#x2F;镜像）给出具体 Gradle 依赖配置方式。</p>
</blockquote>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>这套 <strong><code>uni-id-kit</code></strong> 是把你两个 UTS 插件做了<strong>统一封装、Promise 化、合规默认与安全加强（哈希&#x2F;安全随机）</strong>，并提供<strong>清晰可扩展</strong>的适配层。</li>
<li>你现在就可以把上述文件落地，H5 和 Android 的 <strong>AndroidID&#x2F;GUID&#x2F;PseudoID</strong> 已可用；<strong>OAID&#x2F;AAID</strong> 只需在 <code>adapters/*.uts</code> 里按你现有库补上调用即可（导出接口已经定好）。</li>
<li>一旦接上 OAID，你就能在国内端得到优先使用的稳定设备标识；其余平台自动回退到 AndroidID&#x2F;IDFV&#x2F;GUID。</li>
</ul>
<p>需要的话，你把你现在 OAID 库的 <strong>初始化 &amp; 获取代码片段</strong>贴我，我直接把 <code>adapters/oaid.uts</code> 写成可用实现版（不再占位）。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/07/id-kit%E5%BC%80%E5%8F%91/" data-id="cmfah3dph000go04zgbg89s52" data-title="id-kit开发" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-id-kit" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2025/09/07/id-kit/" class="article-date">
  <time class="dt-published" datetime="2025-09-07T12:35:03.000Z" itemprop="datePublished">2025-09-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2025/09/07/id-kit/">id-kit</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>棒～这个方向很实用。按你的节奏来：<strong>先取名 → 再讲实现思路 → 之后我们再一步步落地</strong>。</p>
<hr>
<h2 id="先取个名字（我给你几个风格不同的备选）"><a href="#先取个名字（我给你几个风格不同的备选）" class="headerlink" title="先取个名字（我给你几个风格不同的备选）"></a>先取个名字（我给你几个风格不同的备选）</h2><p><strong>强推：<code>UniIdKit</code>（中文：一体设备 ID 工具包）</strong></p>
<ul>
<li>简洁、易记、和 uni-app 生态贴合（Uni 前缀）。</li>
<li>“Kit” 体现工具集合的定位（OAID&#x2F;AAID&#x2F;AndroidID&#x2F;GUID…聚合）。</li>
</ul>
<p>其它好选项（任选其一也行）：</p>
<ul>
<li><code>UniDeviceID</code>（直白、上手即懂）</li>
<li><code>IdFusion</code> &#x2F; 中文：ID 融合（强调多源融合）</li>
<li><code>OmniIdKit</code> &#x2F; 中文：全域 ID 工具包（强调覆盖广泛）</li>
<li><code>SignalID</code> &#x2F; 中文：设备信标（更“概念化”，偏品牌感）</li>
</ul>
<blockquote>
<p>没有特别诉求的话，我后续以 <strong><code>UniIdKit</code></strong> 为默认名继续讲实现与代码。</p>
</blockquote>
<hr>
<h2 id="实现思路（先把“大图”画清楚）"><a href="#实现思路（先把“大图”画清楚）" class="headerlink" title="实现思路（先把“大图”画清楚）"></a>实现思路（先把“大图”画清楚）</h2><h3 id="1-目标与边界"><a href="#1-目标与边界" class="headerlink" title="1) 目标与边界"></a>1) 目标与边界</h3><ul>
<li><p><strong>平台覆盖</strong>：Android（App-Plus 原生）、iOS（可选：IDFV）、H5（本地持久 GUID）。</p>
</li>
<li><p><strong>能力聚合</strong>：OAID、AAID、AndroidID、（可选）IMEI&#x2F;MEID、WidevineID、PseudoID、GUID。</p>
</li>
<li><p><strong>合规优先</strong>：</p>
<ul>
<li>默认<strong>不采集强隐私</strong>（如 IMEI），需<strong>显式同意</strong>与<strong>动态权限</strong>才允许。</li>
<li>提供<strong>哈希化输出</strong>（SHA-256）选项，避免直传原始标识。</li>
<li>尊重系统&#x2F;用户“广告追踪限制”（AAID&#x2F;OAID 可能返回空或受限标志）。</li>
</ul>
</li>
</ul>
<h3 id="2-能力分层（便于维护与扩展）"><a href="#2-能力分层（便于维护与扩展）" class="headerlink" title="2) 能力分层（便于维护与扩展）"></a>2) 能力分层（便于维护与扩展）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">UniIdKit（JS/TS 封装与 API ）</span><br><span class="line"> ├─ ConsentManager（隐私同意、选项管理、状态缓存）</span><br><span class="line"> ├─ CacheLayer（本地缓存：uni.storage / iOS Keychain / Android MMKV）</span><br><span class="line"> ├─ Aggregator（聚合各 Adapter 的结果、去重、优先级策略、哈希化）</span><br><span class="line"> └─ Adapters</span><br><span class="line">     ├─ Android:</span><br><span class="line">     │   ├─ OAIDAdapter（MSA SDK）</span><br><span class="line">     │   ├─ AAIDAdapter（Google Play 服务）</span><br><span class="line">     │   ├─ AndroidIdAdapter（SSAID）</span><br><span class="line">     │   ├─ WidevineIdAdapter（DRM ID，有些机型/ROM可能不可用）</span><br><span class="line">     │   ├─ PseudoIdAdapter（Build 信息拼接的伪 ID，稳定性一般）</span><br><span class="line">     │   └─ IMEI/MEIDAdapter（需权限；默认关闭）</span><br><span class="line">     ├─ iOS:</span><br><span class="line">     │   └─ IDFVAdapter（IdentifierForVendor）</span><br><span class="line">     └─ H5:</span><br><span class="line">         └─ GuidAdapter（首访生成 UUID，localStorage/IndexedDB/Cookie 持久化）</span><br></pre></td></tr></table></figure>

<h3 id="3-API-设计（兼容回调，也提供-Promise-风格）"><a href="#3-API-设计（兼容回调，也提供-Promise-风格）" class="headerlink" title="3) API 设计（兼容回调，也提供 Promise 风格）"></a>3) API 设计（兼容回调，也提供 Promise 风格）</h3><p>与 Ba-IdCode 的 API 兼容，但<strong>统一返回结构</strong>、并补充 Promise 版本：</p>
<ul>
<li><code>register(options?)</code>：完成 SDK 初始化&#x2F;权限请求&#x2F;合规弹窗接入（<strong>只有用户同意后才能继续</strong>）。</li>
<li><code>getIdCodes(options?)</code>：一次性返回所有可用标识（含哈希&#x2F;明文二选一），并标出可用性&#x2F;限制信息。</li>
<li><code>getOAID()</code> &#x2F; <code>getAAID()</code> &#x2F; <code>getAndroidId()</code> &#x2F; <code>getGuid()</code>：单项拉取。</li>
<li><code>getBestId(options?)</code>：按优先级策略返回“一个最合适的设备标识”（例如：<code>OAID &gt; AAID &gt; AndroidID &gt; IDFV &gt; GUID</code>）。</li>
<li><code>setSalt(salt: string)</code>：设置服务端协商的哈希盐（建议）；前端仅输出 hash 以降低风险。</li>
</ul>
<p><strong>统一返回结构（示例）</strong>：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">IdValue</span> = &#123;</span><br><span class="line">  <span class="attr">value</span>?: <span class="built_in">string</span>; <span class="comment">// 原始值（默认可关闭）</span></span><br><span class="line">  <span class="attr">hash</span>?: <span class="built_in">string</span>; <span class="comment">// SHA-256(value + salt) 的十六进制</span></span><br><span class="line">  <span class="attr">available</span>: <span class="built_in">boolean</span>; <span class="comment">// 是否成功获取</span></span><br><span class="line">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>; <span class="comment">// 是否受限制（如关闭广告标识、受 ROM 策略限制）</span></span><br><span class="line">  <span class="attr">source</span>?: <span class="built_in">string</span>; <span class="comment">// 具体来源：oaid/aaid/androidId/idfv/guid/...</span></span><br><span class="line">  <span class="attr">message</span>?: <span class="built_in">string</span>; <span class="comment">// 失败/限制说明</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">  <span class="attr">oaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">aaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">androidId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">idfv</span>?: <span class="title class_">IdValue</span>; <span class="comment">// iOS</span></span><br><span class="line">  <span class="attr">widevineId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">pseudoId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">imei</span>?: <span class="title class_">IdValue</span>; <span class="comment">// 默认不返回，需开启 &amp; 权限通过</span></span><br><span class="line">  <span class="attr">guid</span>?: <span class="title class_">IdValue</span>; <span class="comment">// H5/兜底</span></span><br><span class="line">  <span class="attr">ts</span>: <span class="built_in">number</span>; <span class="comment">// 时间戳</span></span><br><span class="line">  <span class="attr">consent</span>: <span class="built_in">boolean</span>; <span class="comment">// 是否已取得用户隐私同意</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>调用风格</strong>：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回调</span></span><br><span class="line">idKit.<span class="title function_">getIdCodes</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">/* ... */</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Promise（推荐）</span></span><br><span class="line"><span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title class_">UniIdKit</span>.<span class="title function_">getIdCodes</span>(&#123;</span><br><span class="line">  <span class="attr">hashOnly</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">include</span>: [<span class="string">&quot;oaid&quot;</span>, <span class="string">&quot;aaid&quot;</span>, <span class="string">&quot;androidId&quot;</span>, <span class="string">&quot;guid&quot;</span>],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="4-平台实现要点"><a href="#4-平台实现要点" class="headerlink" title="4) 平台实现要点"></a>4) 平台实现要点</h3><ul>
<li><p><strong>Android</strong>：</p>
<ul>
<li>OAID：集成 <strong>MSA (移动安全联盟) SDK</strong> 或厂商合规通道（插件市场常用做法）。</li>
<li>AAID：Google Play 服务 <code>AdvertisingIdClient</code>（需处理“限制广告跟踪”返回）。</li>
<li>AndroidID：<code>Settings.Secure.ANDROID_ID</code>。</li>
<li>IMEI&#x2F;MEID：<code>READ_PHONE_STATE</code> 动态权限 + Play 政策；<strong>默认关闭</strong>、强提醒不建议依赖。</li>
<li>缓存：优先使用 MMKV&#x2F;SharedPreferences，配合有效期（如 24 小时）避免频繁拉取。</li>
</ul>
</li>
<li><p><strong>iOS</strong>：</p>
<ul>
<li>IDFV：<code>UIDevice.current.identifierForVendor</code>；卸载所有同一 Vendor 应用后可能变。</li>
<li>不建议用 IDFA（需要 ATT 授权且涉广告用途，与你目标不匹配）。</li>
</ul>
</li>
<li><p><strong>H5</strong>：</p>
<ul>
<li>生成 <code>uuid</code>，持久化在 <code>localStorage</code> + <code>cookie</code> 双存；被清理会变，属于“弱设备 ID”。</li>
<li>返回 <code>guid</code> 字段；可选加“服务端长 Cookie dvc&#x3D;xxx”作为辅助。</li>
</ul>
</li>
</ul>
<h3 id="5-合规与配置"><a href="#5-合规与配置" class="headerlink" title="5) 合规与配置"></a>5) 合规与配置</h3><ul>
<li>插件默认只返回 <strong>hash</strong>；要返回原值需显式 <code>exposeRaw: true</code>。</li>
<li>提供 <code>register()</code> 用于展示你的隐私弹窗（或与现有弹窗 SDK 对接），<strong>未同意</strong>则所有采集接口返回 <code>available=false</code>。</li>
<li>允许配置 <code>include/exclude</code> 字段（避免不必要的请求&#x2F;权限）。</li>
<li>提供 <code>fallback: &#39;guid&#39; | &#39;none&#39;</code> 选项控制 H5 的兜底行为。</li>
</ul>
<hr>
<h2 id="3-先给你一份可直接用的-JS-封装（跨端-可渐进增强）"><a href="#3-先给你一份可直接用的-JS-封装（跨端-可渐进增强）" class="headerlink" title="3) 先给你一份可直接用的 JS 封装（跨端 &amp; 可渐进增强）"></a>3) 先给你一份可直接用的 JS 封装（跨端 &amp; 可渐进增强）</h2><blockquote>
<p>先从 JS 层开始（不依赖原生插件也可工作），App 端等你绑定好原生插件后，再把 <code>native</code> 分支接上即可。</p>
</blockquote>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/utils/uni-id-kit.ts  —— 先做纯JS壳子，后续接原生</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">uuid4</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&quot;</span>.<span class="title function_">replace</span>(<span class="regexp">/[xy]/g</span>, <span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> r = (<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">16</span>) | <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> v = c === <span class="string">&quot;x&quot;</span> ? r : (r &amp; <span class="number">0x3</span>) | <span class="number">0x8</span>;</span><br><span class="line">    <span class="keyword">return</span> v.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sha256Hex</span>(<span class="params"><span class="attr">msg</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">window</span> !== <span class="string">&quot;undefined&quot;</span> &amp;&amp; <span class="variable language_">window</span>.<span class="property">crypto</span>?.<span class="property">subtle</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> enc = <span class="keyword">new</span> <span class="title class_">TextEncoder</span>().<span class="title function_">encode</span>(msg);</span><br><span class="line">    <span class="keyword">const</span> buf = <span class="keyword">await</span> <span class="variable language_">window</span>.<span class="property">crypto</span>.<span class="property">subtle</span>.<span class="title function_">digest</span>(<span class="string">&quot;SHA-256&quot;</span>, enc);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(buf))</span><br><span class="line">      .<span class="title function_">map</span>(<span class="function">(<span class="params">b</span>) =&gt;</span> b.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">2</span>, <span class="string">&quot;0&quot;</span>))</span><br><span class="line">      .<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 非 H5（App 小程序）用简易实现或交给原生</span></span><br><span class="line">  <span class="comment">// 这里先用最简单的占位：直接返回 msg（上线前请接真 SHA-256，如 plus.crypto / 原生）</span></span><br><span class="line">  <span class="keyword">return</span> msg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">GetIdOptions</span> = &#123;</span><br><span class="line">  <span class="attr">include</span>?: <span class="title class_">Array</span>&lt;</span><br><span class="line">    | <span class="string">&quot;oaid&quot;</span></span><br><span class="line">    | <span class="string">&quot;aaid&quot;</span></span><br><span class="line">    | <span class="string">&quot;androidId&quot;</span></span><br><span class="line">    | <span class="string">&quot;idfv&quot;</span></span><br><span class="line">    | <span class="string">&quot;widevineId&quot;</span></span><br><span class="line">    | <span class="string">&quot;pseudoId&quot;</span></span><br><span class="line">    | <span class="string">&quot;imei&quot;</span></span><br><span class="line">    | <span class="string">&quot;guid&quot;</span></span><br><span class="line">  &gt;;</span><br><span class="line">  <span class="attr">exposeRaw</span>?: <span class="built_in">boolean</span>; <span class="comment">// 默认 false，默认仅返回 hash</span></span><br><span class="line">  <span class="attr">salt</span>?: <span class="built_in">string</span>; <span class="comment">// 建议传服务端下发的盐</span></span><br><span class="line">  <span class="attr">fallback</span>?: <span class="string">&quot;guid&quot;</span> | <span class="string">&quot;none&quot;</span>;</span><br><span class="line">  <span class="attr">ttlMs</span>?: <span class="built_in">number</span>; <span class="comment">// 缓存有效期，默认 1 天</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _consent = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> _salt = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">_cache</span>: &#123; <span class="attr">ts</span>: <span class="built_in">number</span>; <span class="attr">data</span>: <span class="built_in">any</span> &#125; | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">UniIdKit</span> = &#123;</span><br><span class="line">  <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    _salt = salt || <span class="string">&quot;&quot;</span>;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">register</span>(): <span class="title class_">Promise</span>&lt;&#123; <span class="attr">consent</span>: <span class="built_in">boolean</span> &#125;&gt; &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> 这里接你的隐私弹窗或第三方隐私 SDK</span></span><br><span class="line">    _consent = <span class="literal">true</span>; <span class="comment">// 演示先直接同意</span></span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">consent</span>: _consent &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">getIdCodes</span>(<span class="params"><span class="attr">opts</span>: <span class="title class_">GetIdOptions</span> = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> include = opts.<span class="property">include</span> || [</span><br><span class="line">      <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">      <span class="string">&quot;aaid&quot;</span>,</span><br><span class="line">      <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">      <span class="string">&quot;idfv&quot;</span>,</span><br><span class="line">      <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">    ]; <span class="comment">// 先常用</span></span><br><span class="line">    <span class="keyword">const</span> ttl = opts.<span class="property">ttlMs</span> ?? <span class="number">24</span> * <span class="number">3600</span> * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 简单缓存</span></span><br><span class="line">    <span class="keyword">if</span> (_cache &amp;&amp; <span class="title class_">Date</span>.<span class="title function_">now</span>() - _cache.<span class="property">ts</span> &lt; ttl) &#123;</span><br><span class="line">      <span class="keyword">return</span> _cache.<span class="property">data</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">data</span>: <span class="built_in">any</span> = &#123; <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(), <span class="attr">consent</span>: _consent &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// App 原生插件（占位），后续把 requireNativePlugin 接上</span></span><br><span class="line">    <span class="keyword">let</span> <span class="attr">native</span>: <span class="built_in">any</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// @ts-ignore</span></span><br><span class="line">      native = uni.<span class="property">requireNativePlugin</span> &amp;&amp; uni.<span class="title function_">requireNativePlugin</span>(<span class="string">&quot;Uni-IdKit&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 工具：组装返回（含 hash）</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">build</span> = <span class="keyword">async</span> (<span class="params"></span></span><br><span class="line"><span class="params">      <span class="attr">source</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">      <span class="attr">value</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">      <span class="attr">limited</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">      <span class="attr">msg</span>?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params">    </span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> available = !!value;</span><br><span class="line">      <span class="keyword">const</span> raw = opts.<span class="property">exposeRaw</span> ? value : <span class="literal">undefined</span>;</span><br><span class="line">      <span class="keyword">const</span> hash = value ? <span class="keyword">await</span> <span class="title function_">sha256Hex</span>(value + (_salt || <span class="string">&quot;&quot;</span>)) : <span class="literal">undefined</span>;</span><br><span class="line">      <span class="keyword">return</span> &#123; <span class="attr">value</span>: raw, hash, available, limited, source, <span class="attr">message</span>: msg &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Android / iOS / H5 分支（先写 H5 + 纯 JS 兜底，原生等你接上）</span></span><br><span class="line">    <span class="keyword">const</span> isH5 =</span><br><span class="line">      <span class="keyword">typeof</span> <span class="variable language_">window</span> !== <span class="string">&quot;undefined&quot;</span> &amp;&amp; <span class="keyword">typeof</span> <span class="variable language_">document</span> !== <span class="string">&quot;undefined&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// OAID / AAID / AndroidID / IDFV —— 占位：若未接原生，返回不可用</span></span><br><span class="line">    <span class="keyword">if</span> (include.<span class="title function_">includes</span>(<span class="string">&quot;oaid&quot;</span>))</span><br><span class="line">      data.<span class="property">oaid</span> = <span class="keyword">await</span> <span class="title function_">build</span>(</span><br><span class="line">        <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">        native?.<span class="property">getOAID</span> ? <span class="keyword">await</span> native.<span class="title function_">getOAID</span>() : <span class="literal">undefined</span></span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">if</span> (include.<span class="title function_">includes</span>(<span class="string">&quot;aaid&quot;</span>))</span><br><span class="line">      data.<span class="property">aaid</span> = <span class="keyword">await</span> <span class="title function_">build</span>(</span><br><span class="line">        <span class="string">&quot;aaid&quot;</span>,</span><br><span class="line">        native?.<span class="property">getAAID</span> ? <span class="keyword">await</span> native.<span class="title function_">getAAID</span>() : <span class="literal">undefined</span></span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">if</span> (include.<span class="title function_">includes</span>(<span class="string">&quot;androidId&quot;</span>))</span><br><span class="line">      data.<span class="property">androidId</span> = <span class="keyword">await</span> <span class="title function_">build</span>(</span><br><span class="line">        <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">        native?.<span class="property">getAndroidID</span> ? <span class="keyword">await</span> native.<span class="title function_">getAndroidID</span>() : <span class="literal">undefined</span></span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">if</span> (include.<span class="title function_">includes</span>(<span class="string">&quot;idfv&quot;</span>))</span><br><span class="line">      data.<span class="property">idfv</span> = <span class="keyword">await</span> <span class="title function_">build</span>(</span><br><span class="line">        <span class="string">&quot;idfv&quot;</span>,</span><br><span class="line">        native?.<span class="property">getIDFV</span> ? <span class="keyword">await</span> native.<span class="title function_">getIDFV</span>() : <span class="literal">undefined</span></span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">if</span> (include.<span class="title function_">includes</span>(<span class="string">&quot;widevineId&quot;</span>))</span><br><span class="line">      data.<span class="property">widevineId</span> = <span class="keyword">await</span> <span class="title function_">build</span>(</span><br><span class="line">        <span class="string">&quot;widevineId&quot;</span>,</span><br><span class="line">        native?.<span class="property">getWidevineID</span> ? <span class="keyword">await</span> native.<span class="title function_">getWidevineID</span>() : <span class="literal">undefined</span></span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">if</span> (include.<span class="title function_">includes</span>(<span class="string">&quot;pseudoId&quot;</span>))</span><br><span class="line">      data.<span class="property">pseudoId</span> = <span class="keyword">await</span> <span class="title function_">build</span>(</span><br><span class="line">        <span class="string">&quot;pseudoId&quot;</span>,</span><br><span class="line">        native?.<span class="property">getPseudoID</span> ? <span class="keyword">await</span> native.<span class="title function_">getPseudoID</span>() : <span class="literal">undefined</span></span><br><span class="line">      );</span><br><span class="line">    <span class="keyword">if</span> (include.<span class="title function_">includes</span>(<span class="string">&quot;imei&quot;</span>))</span><br><span class="line">      data.<span class="property">imei</span> = <span class="keyword">await</span> <span class="title function_">build</span>(</span><br><span class="line">        <span class="string">&quot;imei&quot;</span>,</span><br><span class="line">        native?.<span class="property">getIMEI</span> ? <span class="keyword">await</span> native.<span class="title function_">getIMEI</span>() : <span class="literal">undefined</span></span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// H5 / 兜底 GUID</span></span><br><span class="line">    <span class="keyword">if</span> (include.<span class="title function_">includes</span>(<span class="string">&quot;guid&quot;</span>)) &#123;</span><br><span class="line">      <span class="keyword">let</span> guid = uni.<span class="title function_">getStorageSync</span>(<span class="string">&quot;UNI_ID_KIT_GUID&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (!guid) &#123;</span><br><span class="line">        guid = <span class="string">`web:<span class="subst">$&#123;uuid4()&#125;</span>`</span>;</span><br><span class="line">        uni.<span class="title function_">setStorageSync</span>(<span class="string">&quot;UNI_ID_KIT_GUID&quot;</span>, guid);</span><br><span class="line">      &#125;</span><br><span class="line">      data.<span class="property">guid</span> = <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;guid&quot;</span>, guid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果要求有“最佳 ID”</span></span><br><span class="line">    data.<span class="property">best</span> = (<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> order = [<span class="string">&quot;oaid&quot;</span>, <span class="string">&quot;aaid&quot;</span>, <span class="string">&quot;androidId&quot;</span>, <span class="string">&quot;idfv&quot;</span>, <span class="string">&quot;guid&quot;</span>];</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> k <span class="keyword">of</span> order) &#123;</span><br><span class="line">        <span class="keyword">if</span> (data[k]?.<span class="property">available</span>) <span class="keyword">return</span> k;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;)();</span><br><span class="line"></span><br><span class="line">    _cache = &#123; <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(), data &#125;;</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">getBestId</span>(<span class="params"><span class="attr">opts</span>: <span class="title class_">GetIdOptions</span> = &#123;&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">getIdCodes</span>(opts);</span><br><span class="line">    <span class="keyword">const</span> key = res.<span class="property">best</span>;</span><br><span class="line">    <span class="keyword">return</span> key ? res[key] : &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;none&quot;</span> &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这份 JS 壳子<strong>现在就能在 H5 返回一个稳定的 GUID</strong>；等你把 Android&#x2F;iOS 原生侧接上 <code>Uni-IdKit</code> 插件，就能自动获得 OAID&#x2F;AAID&#x2F;AndroidID&#x2F;IDFV 等真实值，API 不变。</p>
</blockquote>
<hr>
<h2 id="下一步怎么干？"><a href="#下一步怎么干？" class="headerlink" title="下一步怎么干？"></a>下一步怎么干？</h2><ol>
<li><p><strong>确定名字</strong>（默认我用 <code>UniIdKit</code> 继续）。</p>
</li>
<li><p>我给你 <strong>Android 原生插件最小实现骨架（Kotlin）</strong>：</p>
<ul>
<li>暴露 <code>getOAID/getAAID/getAndroidID/...</code> 方法；</li>
<li>可先不接 MSA&#x2F;AAID，返回占位，跑通桥接；</li>
<li>再逐个接入 MSA SDK、Google Play Advertising ID。</li>
</ul>
</li>
<li><p>同步给 <strong>iOS 原生插件（Swift）</strong> 获取 IDFV；</p>
</li>
<li><p>最后在你的登录流程里，把 <code>const dvc = await UniIdKit.getBestId(&#123; hashOnly: true &#125;)</code> 接上，作为 <code>x-device-id</code> 传后端。</p>
</li>
</ol>
<p>要不要我直接开始贴 <strong>Android 插件骨架（可云打包）</strong>？你点个头我就开写。</p>
<p>太好了，我们就按 <strong>UTS 插件</strong>来落地。下面我先给出<strong>项目结构 &amp; API 设计（最佳实践版）</strong>，然后直接给你<strong>可运行的首版代码骨架</strong>（先支持 Web；Android 提供可运行的基础实现 + OAID&#x2F;AAID 预留点），后续你把 MSA&#x2F;GP 的 SDK 接上即可。</p>
<hr>
<h1 id="一、插件命名-目录结构"><a href="#一、插件命名-目录结构" class="headerlink" title="一、插件命名 &amp; 目录结构"></a>一、插件命名 &amp; 目录结构</h1><p><strong>插件名</strong>：<code>uni-id-kit</code>（简洁、易记、符合 uni 插件生态）</p>
<ul>
<li>英文：<strong>UniIdKit</strong></li>
<li>中文：<strong>一体设备 ID 工具包</strong></li>
</ul>
<p><strong>目录（uni_modules 标准）</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">uni_modules/</span><br><span class="line">  uni-id-kit/</span><br><span class="line">    package.json</span><br><span class="line">    module.json</span><br><span class="line">    utssdk/</span><br><span class="line">      index.uts              # 聚合导出（按平台分发）</span><br><span class="line">      common/</span><br><span class="line">        types.uts            # 类型与常量定义（复用）</span><br><span class="line">        hash.uts             # SHA-256 工具（Web/Android 均可）</span><br><span class="line">        storage.uts          # 本地缓存工具（uni.storage封装）</span><br><span class="line">      web/</span><br><span class="line">        index.uts            # Web 实现（GUID、hash、缓存）</span><br><span class="line">      app-android/</span><br><span class="line">        index.uts            # Android 实现（AndroidID，OAID/AAID占位）</span><br><span class="line">        adapters/</span><br><span class="line">          android_id.uts     # ANDROID_ID</span><br><span class="line">          aaid.uts           # Google AAID（待接SDK）</span><br><span class="line">          oaid.uts           # MSA OAID  （待接SDK）</span><br><span class="line">          pseudo_id.uts      # 伪ID（可选）</span><br></pre></td></tr></table></figure>

<blockquote>
<p>iOS（IDFV）可稍后补：<code>app-ios/index.uts</code> + <code>adapters/idfv.uts</code>。<br>你让我们“先国内”，就先 <strong>Web→Android</strong>；Android 国内核心是 <strong>AndroidID&#x2F;OAID</strong>，海外补 <strong>AAID</strong>。</p>
</blockquote>
<hr>
<h1 id="二、API-设计（Promise-回调兼容）"><a href="#二、API-设计（Promise-回调兼容）" class="headerlink" title="二、API 设计（Promise + 回调兼容）"></a>二、API 设计（Promise + 回调兼容）</h1><blockquote>
<p>统一 Promise 风格，另兼容回调（可选）；返回结构“可读 + 可扩展”。</p>
</blockquote>
<h2 id="公开方法"><a href="#公开方法" class="headerlink" title="公开方法"></a>公开方法</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1) 隐私合规：注册/初始化（未同意时一律返回 available=false）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"><span class="attr">options</span>?: &#123;</span></span><br><span class="line"><span class="params">  showPrivacyDialog?: <span class="built_in">boolean</span>; // 需要时展示你自有的隐私弹窗</span></span><br><span class="line"><span class="params">&#125;</span>): <span class="title class_">Promise</span>&lt;&#123; <span class="attr">consent</span>: <span class="built_in">boolean</span> &#125;&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2) 配置哈希盐（建议服务端下发）；默认仅返回 hash</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3) 一次性获取所有可用的 ID（聚合）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"><span class="attr">options</span>?: &#123;</span></span><br><span class="line"><span class="params">  include?: <span class="built_in">Array</span>&lt;</span></span><br><span class="line"><span class="params">    | <span class="string">&quot;oaid&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;aaid&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;androidId&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;idfv&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;widevineId&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;pseudoId&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;imei&quot;</span></span></span><br><span class="line"><span class="params">    | <span class="string">&quot;guid&quot;</span></span></span><br><span class="line"><span class="params">  &gt;;</span></span><br><span class="line"><span class="params">  exposeRaw?: <span class="built_in">boolean</span>; // 默认 <span class="literal">false</span>（仅返回hash），开启后返回原值 value</span></span><br><span class="line"><span class="params">  ttlMs?: <span class="built_in">number</span>; // 缓存有效期，默认 24h</span></span><br><span class="line"><span class="params">&#125;</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4) 返回“最合适”的一个（按优先级：国内默认 oaid &gt; androidId &gt; guid）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"><span class="attr">options</span>?: &#123;</span></span><br><span class="line"><span class="params">  prefer?: <span class="built_in">Array</span>&lt;<span class="string">&quot;oaid&quot;</span> | <span class="string">&quot;aaid&quot;</span> | <span class="string">&quot;androidId&quot;</span> | <span class="string">&quot;idfv&quot;</span> | <span class="string">&quot;guid&quot;</span>&gt;; // 可自定义优先级</span></span><br><span class="line"><span class="params">  exposeRaw?: <span class="built_in">boolean</span>;</span></span><br><span class="line"><span class="params">  ttlMs?: <span class="built_in">number</span>;</span></span><br><span class="line"><span class="params">&#125;</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5) 单项拉取（必要时）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt;;</span><br></pre></td></tr></table></figure>

<h2 id="返回类型（最佳实践）"><a href="#返回类型（最佳实践）" class="headerlink" title="返回类型（最佳实践）"></a>返回类型（最佳实践）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utssdk/common/types.uts</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdValue</span> = &#123;</span><br><span class="line">  <span class="attr">value</span>?: <span class="built_in">string</span>; <span class="comment">// 原始值（exposeRaw=true 才返回）</span></span><br><span class="line">  <span class="attr">hash</span>?: <span class="built_in">string</span>; <span class="comment">// SHA-256(value + salt) 十六进制</span></span><br><span class="line">  <span class="attr">available</span>: <span class="built_in">boolean</span>; <span class="comment">// 是否获取成功</span></span><br><span class="line">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>; <span class="comment">// 是否受限（系统关闭广告跟踪等）</span></span><br><span class="line">  <span class="attr">source</span>: <span class="built_in">string</span>; <span class="comment">// oaid/aaid/androidId/idfv/guid/...</span></span><br><span class="line">  <span class="attr">message</span>?: <span class="built_in">string</span>; <span class="comment">// 失败或说明</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">  <span class="attr">oaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">aaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">androidId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">idfv</span>?: <span class="title class_">IdValue</span>; <span class="comment">// 预留给 iOS</span></span><br><span class="line">  <span class="attr">widevineId</span>?: <span class="title class_">IdValue</span>; <span class="comment">// 可选</span></span><br><span class="line">  <span class="attr">pseudoId</span>?: <span class="title class_">IdValue</span>; <span class="comment">// 可选</span></span><br><span class="line">  <span class="attr">imei</span>?: <span class="title class_">IdValue</span>; <span class="comment">// 不建议默认启用</span></span><br><span class="line">  <span class="attr">guid</span>?: <span class="title class_">IdValue</span>; <span class="comment">// H5/兜底</span></span><br><span class="line">  <span class="attr">best</span>?: <span class="built_in">string</span> | <span class="literal">null</span>; <span class="comment">// 最佳项的 key</span></span><br><span class="line">  <span class="attr">consent</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">ts</span>: <span class="built_in">number</span>; <span class="comment">// 生成时间戳</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="三、首版代码（可直接放进项目）"><a href="#三、首版代码（可直接放进项目）" class="headerlink" title="三、首版代码（可直接放进项目）"></a>三、首版代码（可直接放进项目）</h1><blockquote>
<p><strong>说明</strong>：以下代码为 <strong>可运行骨架</strong>。</p>
<ul>
<li>Web：已可直接返回 <code>guid</code>（localStorage&#x2F;uni.storage 持久化），并做 SHA-256。</li>
<li>Android：已可返回 <strong>AndroidID</strong>（无需额外权限），OAID&#x2F;AAID 先返回占位（后续你把 SDK 接上）。</li>
<li>聚合导出：<code>utssdk/index.uts</code> 会按平台引导到对应实现。</li>
</ul>
</blockquote>
<h2 id="1）uni-modules-uni-id-kit-module-json"><a href="#1）uni-modules-uni-id-kit-module-json" class="headerlink" title="1）uni_modules/uni-id-kit/module.json"></a>1）<code>uni_modules/uni-id-kit/module.json</code></h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uni-id-kit&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;displayName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;UniIdKit - 一体设备ID工具包&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.1.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;聚合 OAID/AAID/AndroidID/GUID 等设备标识，合规&amp;哈希化输出&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;keywords&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;deviceid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;oaid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;aaid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;androidid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;guid&quot;</span><span class="punctuation">,</span> <span class="string">&quot;uts&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;repository&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;engines&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;HBuilderX&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^3.8.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;uni_modules&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;platforms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;app-android&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;utssdk&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;kotlin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&gt;=1.7.0&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;web&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;utssdk&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="2）uni-modules-uni-id-kit-utssdk-common-types-uts"><a href="#2）uni-modules-uni-id-kit-utssdk-common-types-uts" class="headerlink" title="2）uni_modules/uni-id-kit/utssdk/common/types.uts"></a>2）<code>uni_modules/uni-id-kit/utssdk/common/types.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdValue</span> = &#123;</span><br><span class="line">  <span class="attr">value</span>?: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">hash</span>?: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">available</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">source</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">message</span>?: <span class="built_in">string</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">  <span class="attr">oaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">aaid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">androidId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">idfv</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">widevineId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">pseudoId</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">imei</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">guid</span>?: <span class="title class_">IdValue</span>;</span><br><span class="line">  <span class="attr">best</span>?: <span class="built_in">string</span> | <span class="literal">null</span>;</span><br><span class="line">  <span class="attr">consent</span>: <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="attr">ts</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="3）uni-modules-uni-id-kit-utssdk-common-hash-uts"><a href="#3）uni-modules-uni-id-kit-utssdk-common-hash-uts" class="headerlink" title="3）uni_modules/uni-id-kit/utssdk/common/hash.uts"></a>3）<code>uni_modules/uni-id-kit/utssdk/common/hash.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Web 有 crypto.subtle；Android 走 Java MessageDigest（见安卓实现）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sha256Hex</span>(<span class="params"><span class="attr">input</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// @ts-ignore</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">g</span>: <span class="built_in">any</span> = globalThis;</span><br><span class="line">  <span class="keyword">if</span> (g &amp;&amp; g.<span class="property">crypto</span> &amp;&amp; g.<span class="property">crypto</span>.<span class="property">subtle</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> enc = <span class="keyword">new</span> <span class="title class_">TextEncoder</span>().<span class="title function_">encode</span>(input);</span><br><span class="line">    <span class="keyword">const</span> buf = <span class="keyword">await</span> g.<span class="property">crypto</span>.<span class="property">subtle</span>.<span class="title function_">digest</span>(<span class="string">&quot;SHA-256&quot;</span>, enc);</span><br><span class="line">    <span class="keyword">const</span> arr = <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(buf));</span><br><span class="line">    <span class="keyword">return</span> arr.<span class="title function_">map</span>(<span class="function">(<span class="params">b</span>) =&gt;</span> b.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">2</span>, <span class="string">&quot;0&quot;</span>)).<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 无 WebCrypto 时，先退回原文（开发期），建议后续接原生或 JS 实现</span></span><br><span class="line">  <span class="keyword">return</span> input;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4）uni-modules-uni-id-kit-utssdk-common-storage-uts"><a href="#4）uni-modules-uni-id-kit-utssdk-common-storage-uts" class="headerlink" title="4）uni_modules/uni-id-kit/utssdk/common/storage.uts"></a>4）<code>uni_modules/uni-id-kit/utssdk/common/storage.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">get</span>(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span></span>): <span class="built_in">string</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">return</span> uni.<span class="title function_">getStorageSync</span>(key) || <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">set</span>(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span>, <span class="attr">val</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    uni.<span class="title function_">setStorageSync</span>(key, val);</span><br><span class="line">  &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5）uni-modules-uni-id-kit-utssdk-web-index-uts（Web-实现）"><a href="#5）uni-modules-uni-id-kit-utssdk-web-index-uts（Web-实现）" class="headerlink" title="5）uni_modules/uni-id-kit/utssdk/web/index.uts（Web 实现）"></a>5）<code>uni_modules/uni-id-kit/utssdk/web/index.uts</code>（Web 实现）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">IdCodesResult</span>, <span class="title class_">IdValue</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../common/types.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; sha256Hex &#125; <span class="keyword">from</span> <span class="string">&quot;../common/hash.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; get, set &#125; <span class="keyword">from</span> <span class="string">&quot;../common/storage.uts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _consent = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> _salt = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">uuid4</span>(<span class="params"></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&quot;</span>.<span class="title function_">replace</span>(<span class="regexp">/[xy]/g</span>, <span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> r = ((<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">16</span>) <span class="keyword">as</span> <span class="built_in">number</span>) | <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> v = c === <span class="string">&quot;x&quot;</span> ? r : (r &amp; <span class="number">0x3</span>) | <span class="number">0x8</span>;</span><br><span class="line">    <span class="keyword">return</span> v.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">build</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">source</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">value</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">msg</span>?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> available = !!value;</span><br><span class="line">  <span class="keyword">const</span> raw = exposeRaw ? value : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">const</span> hash = value ? <span class="keyword">await</span> <span class="title function_">sha256Hex</span>(value + _salt) : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">value</span>: raw, hash, available, limited, source, <span class="attr">message</span>: msg &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">_</span>: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span> = <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">UTSJSONObject</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// Web demo：默认视为已同意；你可以在这里弹你的隐私弹窗</span></span><br><span class="line">  _consent = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">consent</span>: _consent &#125; <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  _salt = salt || <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"><span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> guid = <span class="title function_">get</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!guid) &#123;</span><br><span class="line">    guid = <span class="string">`web:<span class="subst">$&#123;uuid4()&#125;</span>`</span>;</span><br><span class="line">    <span class="title function_">set</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>, guid);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;guid&quot;</span>, guid <span class="keyword">as</span> <span class="built_in">string</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// Web 没有 AndroidID</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="literal">undefined</span>,</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;Not supported on Web&quot;</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;oaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="string">&quot;Not supported on Web&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;aaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="string">&quot;Not supported on Web&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> include = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;include&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;aaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">res</span>: <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">    <span class="attr">consent</span>: _consent,</span><br><span class="line">    <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">  &#125; <span class="keyword">as</span> <span class="title class_">IdCodesResult</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!_consent) &#123;</span><br><span class="line">    res.<span class="property">guid</span> = &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;guid&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;consent=false&quot;</span> &#125;;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;guid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">guid</span> = <span class="keyword">await</span> <span class="title function_">getGuid</span>(exposeRaw);</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;androidId&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">androidId</span> = <span class="keyword">await</span> <span class="title function_">getAndroidId</span>();</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;oaid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">oaid</span> = <span class="keyword">await</span> <span class="title function_">getOAID</span>();</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;aaid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">aaid</span> = <span class="keyword">await</span> <span class="title function_">getAAID</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 国内默认优先级</span></span><br><span class="line">  <span class="keyword">const</span> order = [<span class="string">&quot;oaid&quot;</span>, <span class="string">&quot;androidId&quot;</span>, <span class="string">&quot;guid&quot;</span>];</span><br><span class="line">  res.<span class="property">best</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; order.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> k = order[i];</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">v</span>: <span class="title class_">IdValue</span> | <span class="literal">null</span> = (res <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[k] <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line">    <span class="keyword">if</span> (v &amp;&amp; v.<span class="property">available</span>) &#123;</span><br><span class="line">      res.<span class="property">best</span> = k;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> arr = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;prefer&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="keyword">const</span> r = <span class="keyword">await</span> <span class="title function_">getIdCodes</span>(&#123; <span class="attr">include</span>: arr <span class="keyword">as</span> <span class="built_in">any</span>, exposeRaw &#125; <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">if</span> (r.<span class="property">best</span>) &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">return</span> (r <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[r.<span class="property">best</span>] <span class="keyword">as</span> <span class="title class_">IdValue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;none&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;no id available&quot;</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6）uni-modules-uni-id-kit-utssdk-app-android-adapters-android-id-uts"><a href="#6）uni-modules-uni-id-kit-utssdk-app-android-adapters-android-id-uts" class="headerlink" title="6）uni_modules/uni-id-kit/utssdk/app-android/adapters/android_id.uts"></a>6）<code>uni_modules/uni-id-kit/utssdk/app-android/adapters/android_id.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ANDROID_ID，无需额外权限（相对稳定，但可能因某些ROM策略变化）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getAndroidIdRaw</span>(<span class="params"></span>): <span class="built_in">string</span> | <span class="literal">null</span> &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> ctx = plus.<span class="property">android</span>.<span class="title function_">runtimeMainActivity</span>();</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">SettingsSecure</span> = plus.<span class="property">android</span>.<span class="title function_">importClass</span>(</span><br><span class="line">      <span class="string">&quot;android.provider.Settings$Secure&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> contentResolver = ctx.<span class="title function_">getContentResolver</span>();</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> id = <span class="title class_">SettingsSecure</span>.<span class="title function_">getString</span>(</span><br><span class="line">      contentResolver,</span><br><span class="line">      <span class="string">&quot;android_id&quot;</span></span><br><span class="line">    ) <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line">    <span class="keyword">return</span> id ? <span class="string">`android:<span class="subst">$&#123;id&#125;</span>`</span> : <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7）uni-modules-uni-id-kit-utssdk-app-android-index-uts"><a href="#7）uni-modules-uni-id-kit-utssdk-app-android-index-uts" class="headerlink" title="7）uni_modules/uni-id-kit/utssdk/app-android/index.uts"></a>7）<code>uni_modules/uni-id-kit/utssdk/app-android/index.uts</code></h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">IdCodesResult</span>, <span class="title class_">IdValue</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../common/types.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; get, set &#125; <span class="keyword">from</span> <span class="string">&quot;../common/storage.uts&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getAndroidIdRaw &#125; <span class="keyword">from</span> <span class="string">&quot;./adapters/android_id.uts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> _consent = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> _salt = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Android 原生侧用 Java 的 MessageDigest 做 SHA-256 更稳，这里暂用 Web 版占位：</span></span><br><span class="line"><span class="comment">// 你也可以在此通过 plus.android.importClass 使用 java.security.MessageDigest 实现</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sha256Hex</span>(<span class="params"><span class="attr">input</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">string</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> input; <span class="comment">// <span class="doctag">TODO:</span> 接入原生 MessageDigest 后返回真 SHA-256</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">uuid4</span>(<span class="params"></span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&quot;</span>.<span class="title function_">replace</span>(<span class="regexp">/[xy]/g</span>, <span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> r = ((<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">16</span>) <span class="keyword">as</span> <span class="built_in">number</span>) | <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> v = c === <span class="string">&quot;x&quot;</span> ? r : (r &amp; <span class="number">0x3</span>) | <span class="number">0x8</span>;</span><br><span class="line">    <span class="keyword">return</span> v.<span class="title function_">toString</span>(<span class="number">16</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">build</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">source</span>: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">value</span>?: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">limited</span>?: <span class="built_in">boolean</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">msg</span>?: <span class="built_in">string</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> available = !!value;</span><br><span class="line">  <span class="keyword">const</span> raw = exposeRaw ? value : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">const</span> hash = value ? <span class="keyword">await</span> <span class="title function_">sha256Hex</span>(value + _salt) : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">value</span>: raw, hash, available, limited, source, <span class="attr">message</span>: msg &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">register</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">_</span>: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span> = <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">UTSJSONObject</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// 这里接入你的合规弹窗/SDK；同意前建议不采集</span></span><br><span class="line">  _consent = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">consent</span>: _consent &#125; <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setSalt</span>(<span class="params"><span class="attr">salt</span>: <span class="built_in">string</span></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  _salt = salt || <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAndroidId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> v = <span class="title function_">getAndroidIdRaw</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;androidId&quot;</span>, v || <span class="literal">undefined</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 预留：接入 Google Advertising ID（AAID）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getAAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// TODO：集成 com.google.android.gms:play-services-ads-identifier</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;aaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="string">&quot;AAID not integrated&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 预留：接入 MSA OAID（国内主流）</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getOAID</span>(<span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// TODO：接入 MSA/OAID SDK</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;oaid&quot;</span>, <span class="literal">undefined</span>, <span class="literal">false</span>, <span class="literal">true</span>, <span class="string">&quot;OAID not integrated&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getGuid</span>(<span class="params"><span class="attr">exposeRaw</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> guid = <span class="title function_">get</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!guid) &#123;</span><br><span class="line">    guid = <span class="string">`app:<span class="subst">$&#123;uuid4()&#125;</span>`</span>;</span><br><span class="line">    <span class="title function_">set</span>(<span class="string">&quot;UNIIDKIT_GUID&quot;</span>, guid);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">await</span> <span class="title function_">build</span>(<span class="string">&quot;guid&quot;</span>, guid <span class="keyword">as</span> <span class="built_in">string</span>, exposeRaw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getIdCodes</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdCodesResult</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> include = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;include&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;aaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">res</span>: <span class="title class_">IdCodesResult</span> = &#123;</span><br><span class="line">    <span class="attr">consent</span>: _consent,</span><br><span class="line">    <span class="attr">ts</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">  &#125; <span class="keyword">as</span> <span class="title class_">IdCodesResult</span>;</span><br><span class="line">  <span class="keyword">if</span> (!_consent) &#123;</span><br><span class="line">    res.<span class="property">guid</span> = &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;guid&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;consent=false&quot;</span> &#125;;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;androidId&quot;</span>) &gt;= <span class="number">0</span>)</span><br><span class="line">    res.<span class="property">androidId</span> = <span class="keyword">await</span> <span class="title function_">getAndroidId</span>(exposeRaw);</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;oaid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">oaid</span> = <span class="keyword">await</span> <span class="title function_">getOAID</span>();</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;aaid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">aaid</span> = <span class="keyword">await</span> <span class="title function_">getAAID</span>();</span><br><span class="line">  <span class="keyword">if</span> (include.<span class="title function_">indexOf</span>(<span class="string">&quot;guid&quot;</span>) &gt;= <span class="number">0</span>) res.<span class="property">guid</span> = <span class="keyword">await</span> <span class="title function_">getGuid</span>(exposeRaw);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 国内优先级：oaid &gt; androidId &gt; guid</span></span><br><span class="line">  <span class="keyword">const</span> order = [<span class="string">&quot;oaid&quot;</span>, <span class="string">&quot;androidId&quot;</span>, <span class="string">&quot;guid&quot;</span>];</span><br><span class="line">  res.<span class="property">best</span> = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; order.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> k = order[i];</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">v</span>: <span class="title class_">IdValue</span> | <span class="literal">null</span> = (res <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[k] <span class="keyword">as</span> <span class="built_in">any</span>;</span><br><span class="line">    <span class="keyword">if</span> (v &amp;&amp; v.<span class="property">available</span>) &#123;</span><br><span class="line">      res.<span class="property">best</span> = k;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getBestId</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">options</span>?: <span class="title class_">UTSJSONObject</span> | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>): <span class="title class_">Promise</span>&lt;<span class="title class_">IdValue</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> arr = (options?.<span class="property">getArray</span>&lt;<span class="built_in">string</span>&gt;(<span class="string">&quot;prefer&quot;</span>) || [</span><br><span class="line">    <span class="string">&quot;oaid&quot;</span>,</span><br><span class="line">    <span class="string">&quot;androidId&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guid&quot;</span>,</span><br><span class="line">  ]) <span class="keyword">as</span> <span class="built_in">string</span>[];</span><br><span class="line">  <span class="keyword">const</span> exposeRaw = (options?.<span class="title function_">getBoolean</span>(<span class="string">&quot;exposeRaw&quot;</span>) || <span class="literal">false</span>) <span class="keyword">as</span> <span class="built_in">boolean</span>;</span><br><span class="line">  <span class="keyword">const</span> r = <span class="keyword">await</span> <span class="title function_">getIdCodes</span>(&#123; <span class="attr">include</span>: arr <span class="keyword">as</span> <span class="built_in">any</span>, exposeRaw &#125; <span class="keyword">as</span> <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">if</span> (r.<span class="property">best</span>) &#123;</span><br><span class="line">    <span class="comment">// @ts-ignore</span></span><br><span class="line">    <span class="keyword">return</span> (r <span class="keyword">as</span> <span class="title class_">UTSJSONObject</span>)[r.<span class="property">best</span>] <span class="keyword">as</span> <span class="title class_">IdValue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">available</span>: <span class="literal">false</span>, <span class="attr">source</span>: <span class="string">&quot;none&quot;</span>, <span class="attr">message</span>: <span class="string">&quot;no id available&quot;</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="8）uni-modules-uni-id-kit-utssdk-index-uts（聚合导出）"><a href="#8）uni-modules-uni-id-kit-utssdk-index-uts（聚合导出）" class="headerlink" title="8）uni_modules/uni-id-kit/utssdk/index.uts（聚合导出）"></a>8）<code>uni_modules/uni-id-kit/utssdk/index.uts</code>（聚合导出）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 平台分发：同名导出，业务方 import 一处即可</span></span><br><span class="line"><span class="comment">// #ifdef APP-ANDROID</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  register,</span><br><span class="line">  setSalt,</span><br><span class="line">  getIdCodes,</span><br><span class="line">  getBestId,</span><br><span class="line">  getOAID,</span><br><span class="line">  getAAID,</span><br><span class="line">  getAndroidId,</span><br><span class="line">  getGuid,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./app-android/index.uts&quot;</span>;</span><br><span class="line"><span class="comment">// #endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// #ifdef H5</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  register,</span><br><span class="line">  setSalt,</span><br><span class="line">  getIdCodes,</span><br><span class="line">  getBestId,</span><br><span class="line">  getOAID,</span><br><span class="line">  getAAID,</span><br><span class="line">  getAndroidId,</span><br><span class="line">  getGuid,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;./web/index.uts&quot;</span>;</span><br><span class="line"><span class="comment">// #endif</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="四、在页面中使用（uni-app-x）"><a href="#四、在页面中使用（uni-app-x）" class="headerlink" title="四、在页面中使用（uni-app x）"></a>四、在页面中使用（uni-app x）</h1><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pages/login/index.uvue (示例)</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  register,</span><br><span class="line">  setSalt,</span><br><span class="line">  getBestId,</span><br><span class="line">  getIdCodes,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;@/uni_modules/uni-id-kit/utssdk/index.uts&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">onMounted</span>(<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">register</span>(); <span class="comment">// 视需求弹你的隐私协议</span></span><br><span class="line">  <span class="title function_">setSalt</span>(<span class="string">&quot;server-salt-xxx&quot;</span>); <span class="comment">// 建议从服务端下发</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> best = <span class="keyword">await</span> <span class="title function_">getBestId</span>(&#123; <span class="attr">exposeRaw</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">  <span class="comment">// 携带 best.hash 作为 x-device-id（或 getIdCodes 的 best 项）</span></span><br><span class="line">  <span class="keyword">const</span> dvc = best.<span class="property">hash</span> || best.<span class="property">value</span> || <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> uni.<span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">url</span>: <span class="string">`<span class="subst">$&#123;baseUrl&#125;</span>/passkeys/login/options`</span>,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    <span class="attr">header</span>: &#123; <span class="string">&quot;x-device-id&quot;</span>: dvc &#125;,</span><br><span class="line">    <span class="attr">data</span>: &#123;&#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="五、后续接入指引（Android-OAID-AAID）"><a href="#五、后续接入指引（Android-OAID-AAID）" class="headerlink" title="五、后续接入指引（Android OAID&#x2F;AAID）"></a>五、后续接入指引（Android OAID&#x2F;AAID）</h1><ul>
<li><strong>OAID</strong>：集成 <strong>MSA&#x2F;联运</strong> SDK（各大国产厂商支持），在 <code>app-android/adapters/oaid.uts</code> 中封装 <code>getOAIDRaw()</code>，在 <code>index.uts</code> 调 <code>await build(&#39;oaid&#39;, v, ...)</code>。</li>
<li><strong>AAID</strong>：添加 <code>com.google.android.gms:play-services-ads-identifier</code> 依赖，调用 <code>AdvertisingIdClient.getAdvertisingIdInfo(context)</code>。</li>
<li><strong>SHA-256</strong>：Android 侧推荐用 <code>java.security.MessageDigest</code>，性能更稳定；把 web 占位换掉。</li>
<li><strong>权限</strong>：AndroidID 不需要额外权限；IMEI&#x2F;MEID 需要 READ_PHONE_STATE（<strong>不推荐默认启用</strong>）。</li>
<li><strong>合规</strong>：未同意隐私协议前，一律返回 <code>available=false</code>；默认仅返回 <code>hash</code>，除非 <code>exposeRaw=true</code>。</li>
</ul>
<hr>
<p>如果你认可这个结构和 API，我可以继续把 <strong>Android 的 OAID&#x2F;AAID 具体适配代码</strong>补上（带依赖、打包参数、权限说明），以及 <strong>iOS 的 IDFV</strong> 版本。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/07/id-kit/" data-id="cmfah3dpf000co04zc1ah3z1g" data-title="id-kit" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-登录后初始化的双阶段启动（增量修改）" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2025/09/06/%E7%99%BB%E5%BD%95%E5%90%8E%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E5%8F%8C%E9%98%B6%E6%AE%B5%E5%90%AF%E5%8A%A8%EF%BC%88%E5%A2%9E%E9%87%8F%E4%BF%AE%E6%94%B9%EF%BC%89/" class="article-date">
  <time class="dt-published" datetime="2025-09-06T18:30:01.000Z" itemprop="datePublished">2025-09-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2025/09/06/%E7%99%BB%E5%BD%95%E5%90%8E%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E5%8F%8C%E9%98%B6%E6%AE%B5%E5%90%AF%E5%8A%A8%EF%BC%88%E5%A2%9E%E9%87%8F%E4%BF%AE%E6%94%B9%EF%BC%89/">在 composable 里“公共初始化 + 登录后初始化”的双阶段启动（增量修改）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ul>
<li>把<strong>不需要登录</strong>的请求抽成“公共初始化（public bootstrap）”，在应用进入时就触发（只触发一次）。</li>
<li>把<strong>需要登录</strong>且<strong>命中鉴权路由</strong>时才需要的数据，保留在你现有的 <code>watch</code> 分支里，但也确保只跑一次。</li>
<li>用<strong>模块级 once 标记</strong>避免多组件重复调用；必要时可加 <code>online</code> 事件进行弱网重试（可选）。</li>
</ul>
<hr>
<h2 id="需要调整的代码（仅片段）"><a href="#需要调整的代码（仅片段）" class="headerlink" title="需要调整的代码（仅片段）"></a>需要调整的代码（仅片段）</h2><blockquote>
<p>放在你这个 composable 文件里，<strong>按位置插入</strong>即可；复杂逻辑我已在上一行加中文注释。</p>
</blockquote>
<h3 id="1）导入（在文件顶部补充）"><a href="#1）导入（在文件顶部补充）" class="headerlink" title="1）导入（在文件顶部补充）"></a>1）导入（在文件顶部补充）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：公私两段初始化需要生命周期/事件</span></span><br><span class="line"><span class="keyword">import</span> &#123; watch, onMounted &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="2）模块级-once-标记（在文件顶部、export-function-useAppBootstrap-外面）"><a href="#2）模块级-once-标记（在文件顶部、export-function-useAppBootstrap-外面）" class="headerlink" title="2）模块级 once 标记（在文件顶部、export function useAppBootstrap 外面）"></a>2）模块级 once 标记（在文件顶部、<code>export function useAppBootstrap</code> 外面）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：模块级“只执行一次”标记，防止多组件重复初始化</span></span><br><span class="line"><span class="keyword">let</span> __BOOT_PUBLIC_ONCE__ = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> __BOOT_PRIVATE_ONCE__ = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>

<h3 id="3）在-useAppBootstrap-内部新增“公共初始化”方法与调用（建议贴在你定义完各个-store-之后）"><a href="#3）在-useAppBootstrap-内部新增“公共初始化”方法与调用（建议贴在你定义完各个-store-之后）" class="headerlink" title="3）在 useAppBootstrap 内部新增“公共初始化”方法与调用（建议贴在你定义完各个 store 之后）"></a>3）在 <code>useAppBootstrap</code> 内部新增“公共初始化”方法与调用（建议贴在你定义完各个 store 之后）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：公共初始化——无需登录的数据，进入站点即预取，且只执行一次</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">bootstrapPublic</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (__BOOT_PUBLIC_ONCE__) <span class="keyword">return</span>;</span><br><span class="line">  __BOOT_PUBLIC_ONCE__ = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">    <span class="comment">// ⬇️ 把“无需 token 的初始化”放这里；按你项目实际取舍</span></span><br><span class="line">    country.<span class="title function_">init</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">    exchange.<span class="title function_">init</span>(&#123; <span class="attr">keyword</span>: <span class="string">&quot;&quot;</span> &#125;).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">    marketCalendar.<span class="title function_">init</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">    <span class="comment">// 如果 server.init() 不依赖用户态，也可放到公共初始化</span></span><br><span class="line">    server.<span class="title function_">init</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">    <span class="comment">// …你还有其它完全公开的数据，也可加进来</span></span><br><span class="line">  ]);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：进入应用即触发公共初始化（SSR/CSR 兼容性考虑，放到 onMounted 最稳妥）</span></span><br><span class="line"><span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">bootstrapPublic</span>();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="4）给你原来的-watch-回调加“私有初始化只跑一次”的保护"><a href="#4）给你原来的-watch-回调加“私有初始化只跑一次”的保护" class="headerlink" title="4）给你原来的 watch 回调加“私有初始化只跑一次”的保护"></a>4）给你原来的 <code>watch</code> 回调加“私有初始化只跑一次”的保护</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：仅在“已登录 &amp;&amp; 路由需要鉴权 &amp;&amp; 未跑过私有初始化”时执行</span></span><br><span class="line"><span class="keyword">if</span> (ok &amp;&amp; need &amp;&amp; !__BOOT_PRIVATE_ONCE__) &#123;</span><br><span class="line">  __BOOT_PRIVATE_ONCE__ = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">    user.<span class="title function_">fetchUserInfo</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">    account.<span class="title function_">init</span>(&#123; <span class="attr">withCategory</span>: <span class="literal">true</span>, <span class="attr">withExternal</span>: <span class="literal">true</span> &#125;).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">    leverage.<span class="title function_">init</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">    accountCurrency.<span class="title function_">init</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">    externalServer.<span class="title function_">init</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">    payChannel.<span class="title function_">init</span>(&#123; <span class="attr">opt_type</span>: <span class="string">&quot;deposit&quot;</span> &#125;).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">    verifyStore.<span class="title function_">initVerifyInfo</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">    inviteStore.<span class="title function_">getInviteGroupOptions</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">    <span class="comment">// ⚠️ server.init()/country/exchange/marketCalendar 已在公共初始化里跑过的可移除，避免重复</span></span><br><span class="line">  ]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="可选增强"><a href="#可选增强" class="headerlink" title="可选增强"></a>可选增强</h2><h3 id="A-弱网场景“上线即补跑”"><a href="#A-弱网场景“上线即补跑”" class="headerlink" title="A. 弱网场景“上线即补跑”"></a>A. 弱网场景“上线即补跑”</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：若用户初次进入时离线，恢复网络后自动补跑公共初始化（最多触发一次）</span></span><br><span class="line"><span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handler</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">bootstrapPublic</span>();</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;online&quot;</span>, handler, &#123; <span class="attr">once</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="B-Store-级幂等（示例片段，放到各自的-Pinia-store-里）"><a href="#B-Store-级幂等（示例片段，放到各自的-Pinia-store-里）" class="headerlink" title="B. Store 级幂等（示例片段，放到各自的 Pinia store 里）"></a>B. Store 级幂等（示例片段，放到各自的 Pinia store 里）</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：在每个 init() 入口加幂等保护，彻底避免重复请求</span></span><br><span class="line"><span class="keyword">if</span> ((<span class="variable language_">this</span> <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">_inited</span>) <span class="keyword">return</span>;</span><br><span class="line">(<span class="variable language_">this</span> <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">_inited</span> = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><ul>
<li>公共数据：<code>onMounted</code> 里 <strong>立刻预取一次</strong>，全站可复用。</li>
<li>私有数据：沿用你的 <code>watch</code>，但加一次性保护，避免路由&#x2F;状态抖动造成的重复请求。</li>
<li>若存在弱网：监听 <code>online</code> 事件，<strong>一次性</strong>补跑公共初始化即可。</li>
</ul>
<hr>
<p>title: useAppBootstrap 放在哪？给你一份可直接复制的完整文件（含用法）<br>date: 2025-09-06<br>tags:</p>
<ul>
<li>Vue3</li>
<li>Vite</li>
<li>Pinia</li>
<li>composable<br>categories:</li>
<li>前端工程化</li>
</ul>
<hr>
<h2 id="位置推荐"><a href="#位置推荐" class="headerlink" title="位置推荐"></a>位置推荐</h2><p>把文件放到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src/composables/useAppBootstrap.ts</span><br></pre></td></tr></table></figure>

<p>理由：可复用的启动逻辑属于“组合式函数（composable）”，与业务无关的初始化也方便在这里统一管理。</p>
<hr>
<h2 id="完整代码（可直接替换-src-composables-useAppBootstrap-ts）"><a href="#完整代码（可直接替换-src-composables-useAppBootstrap-ts）" class="headerlink" title="完整代码（可直接替换 src/composables/useAppBootstrap.ts）"></a>完整代码（可直接替换 <code>src/composables/useAppBootstrap.ts</code>）</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/composables/useAppBootstrap.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; onMounted, watch &#125; <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useRouter &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  useAuthStore,</span><br><span class="line">  useUserStore,</span><br><span class="line">  useAccountStore,</span><br><span class="line">  useServerStore,</span><br><span class="line">  useLeverageStore,</span><br><span class="line">  useAccountCurrencyStore,</span><br><span class="line">  useCountryStore,</span><br><span class="line">  useExchangeStore,</span><br><span class="line">  useExternalServerStore,</span><br><span class="line">  useMarketCalendarStore,</span><br><span class="line">  usePayChannelStore,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;@/store&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useVerifyStore &#125; <span class="keyword">from</span> <span class="string">&quot;@/store/verify&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useInviteStore &#125; <span class="keyword">from</span> <span class="string">&quot;@/store/invite&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复杂逻辑：模块级“只执行一次”标记，避免多组件/多次进入页面重复请求</span></span><br><span class="line"><span class="keyword">let</span> __BOOT_PUBLIC_ONCE__ = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> __BOOT_PRIVATE_ONCE__ = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">useAppBootstrap</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> router = <span class="title function_">useRouter</span>();</span><br><span class="line">  <span class="keyword">const</span> auth = <span class="title function_">useAuthStore</span>();</span><br><span class="line">  <span class="keyword">const</span> user = <span class="title function_">useUserStore</span>();</span><br><span class="line">  <span class="keyword">const</span> account = <span class="title function_">useAccountStore</span>();</span><br><span class="line">  <span class="keyword">const</span> server = <span class="title function_">useServerStore</span>();</span><br><span class="line">  <span class="keyword">const</span> leverage = <span class="title function_">useLeverageStore</span>();</span><br><span class="line">  <span class="keyword">const</span> accountCurrency = <span class="title function_">useAccountCurrencyStore</span>();</span><br><span class="line">  <span class="keyword">const</span> country = <span class="title function_">useCountryStore</span>();</span><br><span class="line">  <span class="keyword">const</span> exchange = <span class="title function_">useExchangeStore</span>();</span><br><span class="line">  <span class="keyword">const</span> externalServer = <span class="title function_">useExternalServerStore</span>();</span><br><span class="line">  <span class="keyword">const</span> marketCalendar = <span class="title function_">useMarketCalendarStore</span>();</span><br><span class="line">  <span class="keyword">const</span> payChannel = <span class="title function_">usePayChannelStore</span>();</span><br><span class="line">  <span class="keyword">const</span> verifyStore = <span class="title function_">useVerifyStore</span>();</span><br><span class="line">  <span class="keyword">const</span> inviteStore = <span class="title function_">useInviteStore</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 复杂逻辑：公共初始化——无需登录可获取的数据，进入站点即预取，且只执行一次</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">bootstrapPublic</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (__BOOT_PUBLIC_ONCE__) <span class="keyword">return</span>;</span><br><span class="line">    __BOOT_PUBLIC_ONCE__ = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">      <span class="comment">// ⬇️ 放“无需 token”的初始化</span></span><br><span class="line">      country.<span class="title function_">init</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">      exchange.<span class="title function_">init</span>(&#123; <span class="attr">keyword</span>: <span class="string">&quot;&quot;</span> &#125;).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">      marketCalendar.<span class="title function_">init</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">      server.<span class="title function_">init</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">      <span class="comment">// 如有其它公开数据，也可加在这里</span></span><br><span class="line">    ]);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 复杂逻辑：进入应用即触发公共初始化；若首次访问时离线，恢复网络后补跑一次（仅一次）</span></span><br><span class="line">  <span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">bootstrapPublic</span>();</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handler</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="title function_">bootstrapPublic</span>();</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;online&quot;</span>, handler, &#123; <span class="attr">once</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 复杂逻辑：仅在“已登录 &amp;&amp; 目标路由需要鉴权 &amp;&amp; 未跑过私有初始化”时执行一次性私有初始化</span></span><br><span class="line">  <span class="title function_">watch</span>(</span><br><span class="line">    [</span><br><span class="line">      <span class="function">() =&gt;</span> auth.<span class="property">isAuthenticated</span>,</span><br><span class="line">      <span class="function">() =&gt;</span> router.<span class="property">currentRoute</span>.<span class="property">value</span>.<span class="property">meta</span>?.<span class="property">requiresAuth</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="title function_">async</span> ([ok, need]) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (ok &amp;&amp; need &amp;&amp; !__BOOT_PRIVATE_ONCE__) &#123;</span><br><span class="line">        __BOOT_PRIVATE_ONCE__ = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">          user.<span class="title function_">fetchUserInfo</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">          account</span><br><span class="line">            .<span class="title function_">init</span>(&#123; <span class="attr">withCategory</span>: <span class="literal">true</span>, <span class="attr">withExternal</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">            .<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">          leverage.<span class="title function_">init</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">          accountCurrency.<span class="title function_">init</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">          externalServer.<span class="title function_">init</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">          payChannel.<span class="title function_">init</span>(&#123; <span class="attr">opt_type</span>: <span class="string">&quot;deposit&quot;</span> &#125;).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">          verifyStore.<span class="title function_">initVerifyInfo</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">          inviteStore.<span class="title function_">getInviteGroupOptions</span>().<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;&#125;),</span><br><span class="line">          <span class="comment">// ⚠️ 已在公共初始化中完成的 server/country/exchange/marketCalendar 无需重复</span></span><br><span class="line">        ]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="attr">immediate</span>: <span class="literal">true</span> &#125;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// （可选）测试/登出时重置标记</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">__resetBootstrapFlagsForTestOnly</span>(<span class="params"></span>) &#123;</span><br><span class="line">  __BOOT_PUBLIC_ONCE__ = <span class="literal">false</span>;</span><br><span class="line">  __BOOT_PRIVATE_ONCE__ = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="如何使用（最小改动）"><a href="#如何使用（最小改动）" class="headerlink" title="如何使用（最小改动）"></a>如何使用（最小改动）</h2><blockquote>
<p>你<strong>不需要</strong>在每个页面手动调用，只需在 <strong>App.vue</strong> 顶层调用一次即可。</p>
</blockquote>
<p>在 <code>src/App.vue</code> 的 <code>&lt;script setup&gt;</code> 里加入一行（<strong>增量修改</strong>）：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：顶层调用一次，注册 watch + onMounted，即可全局生效</span></span><br><span class="line"><span class="keyword">import</span> &#123; useAppBootstrap &#125; <span class="keyword">from</span> <span class="string">&quot;@/composables/useAppBootstrap&quot;</span>;</span><br><span class="line"><span class="title function_">useAppBootstrap</span>();</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果你的项目还没在 <code>main.ts</code> 里安装 Pinia&#x2F;Router，请确认已安装（一般你已经有了）：</p>
</blockquote>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 仅供核对：main.ts 应该已包含这些</span></span><br><span class="line"><span class="comment">// import &#123; createApp &#125; from &#x27;vue&#x27;</span></span><br><span class="line"><span class="comment">// import &#123; createPinia &#125; from &#x27;pinia&#x27;</span></span><br><span class="line"><span class="comment">// import router from &#x27;./router&#x27;</span></span><br><span class="line"><span class="comment">// import App from &#x27;./App.vue&#x27;</span></span><br><span class="line"><span class="comment">// createApp(App).use(createPinia()).use(router).mount(&#x27;#app&#x27;)</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h2><ul>
<li>文件放在：<code>src/composables/useAppBootstrap.ts</code>。</li>
<li>在 <code>App.vue</code> 顶层调用一次 <code>useAppBootstrap()</code> 即全局生效。</li>
<li>公共初始化：站点进入即跑；私有初始化：登录且命中鉴权路由时只跑一次。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/06/%E7%99%BB%E5%BD%95%E5%90%8E%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E5%8F%8C%E9%98%B6%E6%AE%B5%E5%90%AF%E5%8A%A8%EF%BC%88%E5%A2%9E%E9%87%8F%E4%BF%AE%E6%94%B9%EF%BC%89/" data-id="cmfah3dpq0018o04zdzgy5bi7" data-title="在 composable 里“公共初始化 + 登录后初始化”的双阶段启动（增量修改）" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Pinia/" rel="tag">Pinia</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Vue3/" rel="tag">Vue3</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/composable/" rel="tag">composable</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/%E5%88%9D%E5%A7%8B%E5%8C%96/" rel="tag">初始化</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-体积分布分析图" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blog/2025/09/06/%E4%BD%93%E7%A7%AF%E5%88%86%E5%B8%83%E5%88%86%E6%9E%90%E5%9B%BE/" class="article-date">
  <time class="dt-published" datetime="2025-09-06T16:59:20.000Z" itemprop="datePublished">2025-09-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blog/2025/09/06/%E4%BD%93%E7%A7%AF%E5%88%86%E5%B8%83%E5%88%86%E6%9E%90%E5%9B%BE/">Vite + Vue3 打包后如何查看“体积分布分析图”</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h2><p>想在 <strong>Vite + Vue3</strong> 打包后看到类似 Webpack Bundle Analyzer 的交互式“依赖体积分布图”，最简单稳妥的方法是接入 <code>rollup-plugin-visualizer</code>。本文给出<strong>最小改动</strong>方案：按需启用分析模式、构建、自动打开 <code>stats.html</code>。</p>
<hr>
<h2 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h2><ul>
<li>使用 Rollup 可视化插件（Vite 打包底层是 Rollup）。</li>
<li>仅在“分析模式”挂载插件，避免影响日常构建速度。</li>
<li>构建完成自动生成并打开 <code>stats.html</code>（Treemap&#x2F;Sunburst 可选）。</li>
<li>可选：开启 <code>sourcemap</code> 便于二次分析。</li>
</ul>
<hr>
<h2 id="分步操作"><a href="#分步操作" class="headerlink" title="分步操作"></a>分步操作</h2><h3 id="1）安装依赖"><a href="#1）安装依赖" class="headerlink" title="1）安装依赖"></a>1）安装依赖</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 任选包管理器</span></span><br><span class="line">pnpm add -D rollup-plugin-visualizer</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">npm i -D rollup-plugin-visualizer</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">yarn add -D rollup-plugin-visualizer</span><br></pre></td></tr></table></figure>

<h3 id="2）修改-vite-config-ts（只给需要改的片段）"><a href="#2）修改-vite-config-ts（只给需要改的片段）" class="headerlink" title="2）修改 vite.config.ts（只给需要改的片段）"></a>2）修改 <code>vite.config.ts</code>（只给需要改的片段）</h3><blockquote>
<p>说明：以下片段为<strong>增量修改</strong>，请在你的 <code>vite.config.ts</code> 里按位置插入即可。</p>
</blockquote>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ① 顶部新增一行：导入可视化插件</span></span><br><span class="line"><span class="keyword">import</span> &#123; visualizer &#125; <span class="keyword">from</span> <span class="string">&quot;rollup-plugin-visualizer&quot;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ② 在 defineConfig 回调里按需启用（若你当前不是回调形式，可改为回调：defineConfig((&#123; mode &#125;) =&gt; (&#123; ... &#125;))）</span></span><br><span class="line"><span class="keyword">const</span> enableAnalyze = process.<span class="property">env</span>.<span class="property">ANALYZE</span> === <span class="string">&quot;true&quot;</span> || mode === <span class="string">&quot;analyze&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 复杂逻辑：仅在分析模式下挂载插件，避免常规构建受影响</span></span><br><span class="line">enableAnalyze &amp;&amp;</span><br><span class="line">  plugins.<span class="title function_">push</span>(</span><br><span class="line">    <span class="title function_">visualizer</span>(&#123;</span><br><span class="line">      <span class="comment">// 复杂逻辑：输出 treemap 到项目根目录，并在构建结束自动打开</span></span><br><span class="line">      <span class="attr">filename</span>: <span class="string">&quot;stats.html&quot;</span>,</span><br><span class="line">      <span class="attr">template</span>: <span class="string">&quot;treemap&quot;</span>, <span class="comment">// 可选：&#x27;treemap&#x27; | &#x27;sunburst&#x27; | &#x27;network&#x27;</span></span><br><span class="line">      <span class="attr">open</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">gzipSize</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">brotliSize</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ③（可选）为了配合二次分析或排查问题，开启源码映射</span></span><br><span class="line"><span class="attr">build</span>: &#123;</span><br><span class="line">  <span class="comment">// 复杂逻辑：仅在分析模式下开启 sourcemap（若你已有 build 配置，请合并到其中）</span></span><br><span class="line">  <span class="attr">sourcemap</span>: enableAnalyze;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>小贴士：若你的 <code>plugins</code> 是直接字面量数组，改成先声明 <code>const plugins = [vue(/*...*/)]</code> 再 <code>.push(...)</code>，最后 <code>return &#123; plugins &#125;</code>。不想改结构也行：<code>plugins: [vue(), enableAnalyze &amp;&amp; visualizer(&#123;...&#125;)].filter(Boolean)</code>。</p>
</blockquote>
<h3 id="3）新增构建脚本（二选一）"><a href="#3）新增构建脚本（二选一）" class="headerlink" title="3）新增构建脚本（二选一）"></a>3）新增构建脚本（二选一）</h3><p><strong>方案 A（推荐，跨平台零依赖）：用 <code>--mode analyze</code> 触发</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vite build&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;build:analyze&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vite build --mode analyze&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;build-analyze&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cross-env NODE_OPTIONS=--max-old-space-size=16384 vite build --mode analyze&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>方案 B：用环境变量触发（类 Unix 系统方便）</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vite build&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// 复杂逻辑：通过环境变量开启分析模式；Windows 可用 cross-env 做兼容</span></span><br><span class="line">    <span class="attr">&quot;build:analyze&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ANALYZE=true vite build&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 触发分析构建（使用你选择的方案）</span></span><br><span class="line">pnpm run build:analyze</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建完成后会自动打开 stats.html</span></span><br><span class="line"><span class="comment"># 若未自动打开，可手动在项目根目录双击/用浏览器打开 stats.html</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="进阶玩法（可选）"><a href="#进阶玩法（可选）" class="headerlink" title="进阶玩法（可选）"></a>进阶玩法（可选）</h2><h3 id="A-自定义输出位置-图表类型"><a href="#A-自定义输出位置-图表类型" class="headerlink" title="A. 自定义输出位置&#x2F;图表类型"></a>A. 自定义输出位置&#x2F;图表类型</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：将报告输出到 dist 目录下并改为 sunburst 风格</span></span><br><span class="line"><span class="title function_">visualizer</span>(&#123;</span><br><span class="line">  <span class="attr">filename</span>: <span class="string">&quot;dist/bundle-report.html&quot;</span>,</span><br><span class="line">  <span class="attr">template</span>: <span class="string">&quot;sunburst&quot;</span>,</span><br><span class="line">  <span class="attr">open</span>: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="B-快速“拆包”以便观察效果"><a href="#B-快速“拆包”以便观察效果" class="headerlink" title="B. 快速“拆包”以便观察效果"></a>B. 快速“拆包”以便观察效果</h3><blockquote>
<p>仅示例，按你实际依赖调整：</p>
</blockquote>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 复杂逻辑：演示常见手动分包，便于在图里更清晰地区分</span></span><br><span class="line"><span class="attr">build</span>: &#123;</span><br><span class="line">  <span class="attr">rollupOptions</span>: &#123;</span><br><span class="line">    <span class="attr">output</span>: &#123;</span><br><span class="line">      <span class="attr">manualChunks</span>: &#123;</span><br><span class="line">        <span class="attr">vue</span>: [<span class="string">&#x27;vue&#x27;</span>, <span class="string">&#x27;vue-router&#x27;</span>, <span class="string">&#x27;pinia&#x27;</span>],</span><br><span class="line">        <span class="comment">// 如果你用到 Ant Design Vue / ECharts / AntV 等，可分别拆</span></span><br><span class="line">        <span class="comment">// antdv: [&#x27;ant-design-vue&#x27;],</span></span><br><span class="line">        <span class="comment">// echarts: [&#x27;echarts&#x27;],</span></span><br><span class="line">        <span class="comment">// antv: [&#x27;@antv/g2&#x27;, &#x27;@antv/g2plot&#x27;],</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="C-二次分析（Source-Map）"><a href="#C-二次分析（Source-Map）" class="headerlink" title="C. 二次分析（Source Map）"></a>C. 二次分析（Source Map）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可选：安装 source-map-explorer 做“按文件”体积分析</span></span><br><span class="line">pnpm add -D source-map-explorer</span><br><span class="line"><span class="comment"># 构建（确保 sourcemap 已开启）</span></span><br><span class="line">pnpm run build:analyze</span><br><span class="line"><span class="comment"># 生成 HTML 报告（路径按你的 dist 实际文件调整）</span></span><br><span class="line">npx source-map-explorer <span class="string">&quot;dist/assets/*.js&quot;</span> --html dist/sme.html</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><ul>
<li><p><strong>stats.html 是空白&#x2F;打不开？</strong><br>多半是构建被缓存或浏览器拦截了本地文件。先清理 <code>dist</code> 再构建；或换个浏览器打开，必要时关闭浏览器的本地文件限制。</p>
</li>
<li><p><strong>报告没自动打开？</strong><br>CI&#x2F;无头环境不会自动打开。把 <code>open: false</code>，直接到输出目录找报告 HTML 即可。</p>
</li>
<li><p><strong>Windows 下 <code>ANALYZE=true</code> 不生效？</strong><br>用方案 A（<code>--mode analyze</code>），或安装 <code>cross-env</code>：<br><code>cross-env ANALYZE=true vite build</code>。</p>
</li>
<li><p><strong>体积异常大但定位不到模块？</strong><br>开启 <code>sourcemap</code> 后再看 <code>stats.html</code>；若仍不清晰，配合 <code>source-map-explorer</code> 交叉验证。</p>
</li>
</ul>
<hr>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><ul>
<li>装一个 <code>rollup-plugin-visualizer</code>，按需启用分析模式，构建即得可交互分析图。</li>
<li>报告默认 <code>stats.html</code>，Treemap&#x2F;Sunburst 随选。</li>
<li>需要更深入排查时，打开 <code>sourcemap</code> + <code>source-map-explorer</code> 双管齐下。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://herongdev.github.io/blog/2025/09/06/%E4%BD%93%E7%A7%AF%E5%88%86%E5%B8%83%E5%88%86%E6%9E%90%E5%9B%BE/" data-id="cmfah3dpm000wo04z0j5x9i2v" data-title="Vite + Vue3 打包后如何查看“体积分布分析图”" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Vite/" rel="tag">Vite</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/Vue3/" rel="tag">Vue3</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/rollup-plugin-visualizer/" rel="tag">rollup-plugin-visualizer</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/%E6%89%93%E5%8C%85%E5%88%86%E6%9E%90/" rel="tag">打包分析</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/blog/page/2/">2</a><a class="page-number" href="/blog/page/3/">3</a><a class="page-number" href="/blog/page/4/">4</a><a class="extend next" rel="next" href="/blog/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/web%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/">web应用开发</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/blog/categories/web%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91/%E5%89%8D%E7%AB%AF/">前端</a></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/401/" rel="tag">401</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/AbortController/" rel="tag">AbortController</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Axios/" rel="tag">Axios</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Fetch/" rel="tag">Fetch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/GitHub-Pages/" rel="tag">GitHub Pages</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Hexo/" rel="tag">Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/MSW/" rel="tag">MSW</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/NestJS/" rel="tag">NestJS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/NexT/" rel="tag">NexT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/OpenAPI/" rel="tag">OpenAPI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Passkeys/" rel="tag">Passkeys</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Pinia/" rel="tag">Pinia</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/TanStack-Query/" rel="tag">TanStack Query</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/TypeScript/" rel="tag">TypeScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/UTS-%E6%8F%92%E4%BB%B6/" rel="tag">UTS 插件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Vite/" rel="tag">Vite</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Vue-3/" rel="tag">Vue 3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Vue-Router/" rel="tag">Vue Router</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/Vue3/" rel="tag">Vue3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/WebAuthn/" rel="tag">WebAuthn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/composable/" rel="tag">composable</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/rollup-plugin-visualizer/" rel="tag">rollup-plugin-visualizer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/simplewebauthn/" rel="tag">simplewebauthn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/store%E8%AF%B7%E6%B1%82/" rel="tag">store请求</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/uni-app-x/" rel="tag">uni-app x</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E4%B8%80%E9%94%AE%E7%9B%B4%E7%99%BB/" rel="tag">一键直登</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E4%B8%8B%E8%BD%BD/" rel="tag">下载</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E5%88%86%E7%B1%BB/" rel="tag">分类</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E5%88%9D%E5%A7%8B%E5%8C%96/" rel="tag">初始化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E5%89%8D%E7%AB%AF/" rel="tag">前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E5%89%8D%E7%AB%AF%E6%9E%B6%E6%9E%84/" rel="tag">前端架构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E5%89%AF%E4%BD%9C%E7%94%A8%E6%8E%A7%E5%88%B6/" rel="tag">副作用控制</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E5%8D%9A%E5%AE%A2/" rel="tag">博客</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E5%A4%A7%E5%8E%82%E5%AE%9E%E8%B7%B5/" rel="tag">大厂实践</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E6%89%93%E5%8C%85%E5%88%86%E6%9E%90/" rel="tag">打包分析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E6%9C%AA%E7%99%BB%E5%BD%95%E6%8B%A6%E6%88%AA/" rel="tag">未登录拦截</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E7%9B%AE%E5%BD%95/" rel="tag">目录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95/" rel="tag">退出登录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/%E9%89%B4%E6%9D%83/" rel="tag">鉴权</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/blog/tags/401/" style="font-size: 10px;">401</a> <a href="/blog/tags/AbortController/" style="font-size: 10px;">AbortController</a> <a href="/blog/tags/Axios/" style="font-size: 20px;">Axios</a> <a href="/blog/tags/Fetch/" style="font-size: 10px;">Fetch</a> <a href="/blog/tags/GitHub-Pages/" style="font-size: 15px;">GitHub Pages</a> <a href="/blog/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/blog/tags/MSW/" style="font-size: 10px;">MSW</a> <a href="/blog/tags/NestJS/" style="font-size: 10px;">NestJS</a> <a href="/blog/tags/NexT/" style="font-size: 10px;">NexT</a> <a href="/blog/tags/OpenAPI/" style="font-size: 10px;">OpenAPI</a> <a href="/blog/tags/Passkeys/" style="font-size: 15px;">Passkeys</a> <a href="/blog/tags/Pinia/" style="font-size: 20px;">Pinia</a> <a href="/blog/tags/TanStack-Query/" style="font-size: 10px;">TanStack Query</a> <a href="/blog/tags/TypeScript/" style="font-size: 20px;">TypeScript</a> <a href="/blog/tags/UTS-%E6%8F%92%E4%BB%B6/" style="font-size: 10px;">UTS 插件</a> <a href="/blog/tags/Vite/" style="font-size: 10px;">Vite</a> <a href="/blog/tags/Vue-3/" style="font-size: 10px;">Vue 3</a> <a href="/blog/tags/Vue-Router/" style="font-size: 10px;">Vue Router</a> <a href="/blog/tags/Vue3/" style="font-size: 15px;">Vue3</a> <a href="/blog/tags/WebAuthn/" style="font-size: 15px;">WebAuthn</a> <a href="/blog/tags/composable/" style="font-size: 10px;">composable</a> <a href="/blog/tags/rollup-plugin-visualizer/" style="font-size: 10px;">rollup-plugin-visualizer</a> <a href="/blog/tags/simplewebauthn/" style="font-size: 10px;">simplewebauthn</a> <a href="/blog/tags/store%E8%AF%B7%E6%B1%82/" style="font-size: 10px;">store请求</a> <a href="/blog/tags/uni-app-x/" style="font-size: 10px;">uni-app x</a> <a href="/blog/tags/%E4%B8%80%E9%94%AE%E7%9B%B4%E7%99%BB/" style="font-size: 10px;">一键直登</a> <a href="/blog/tags/%E4%B8%8B%E8%BD%BD/" style="font-size: 10px;">下载</a> <a href="/blog/tags/%E5%88%86%E7%B1%BB/" style="font-size: 10px;">分类</a> <a href="/blog/tags/%E5%88%9D%E5%A7%8B%E5%8C%96/" style="font-size: 10px;">初始化</a> <a href="/blog/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 10px;">前端</a> <a href="/blog/tags/%E5%89%8D%E7%AB%AF%E6%9E%B6%E6%9E%84/" style="font-size: 10px;">前端架构</a> <a href="/blog/tags/%E5%89%AF%E4%BD%9C%E7%94%A8%E6%8E%A7%E5%88%B6/" style="font-size: 10px;">副作用控制</a> <a href="/blog/tags/%E5%8D%9A%E5%AE%A2/" style="font-size: 10px;">博客</a> <a href="/blog/tags/%E5%A4%A7%E5%8E%82%E5%AE%9E%E8%B7%B5/" style="font-size: 10px;">大厂实践</a> <a href="/blog/tags/%E6%89%93%E5%8C%85%E5%88%86%E6%9E%90/" style="font-size: 10px;">打包分析</a> <a href="/blog/tags/%E6%9C%AA%E7%99%BB%E5%BD%95%E6%8B%A6%E6%88%AA/" style="font-size: 10px;">未登录拦截</a> <a href="/blog/tags/%E7%9B%AE%E5%BD%95/" style="font-size: 10px;">目录</a> <a href="/blog/tags/%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95/" style="font-size: 10px;">退出登录</a> <a href="/blog/tags/%E9%89%B4%E6%9D%83/" style="font-size: 10px;">鉴权</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2025/09/">September 2025</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2025/09/08/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/blog/2025/09/08/%E9%9C%80%E6%B1%82%E5%AE%9E%E7%8E%B0/%E7%99%BB%E5%BD%95%E9%89%B4%E6%9D%83/Passkeys%EF%BC%9Aoptions/">WebAuthn Passkeys：options 全字段长啥样？取值有哪些？（simplewebauthn v11+ 实战）</a>
          </li>
        
          <li>
            <a href="/blog/2025/09/08/%E9%9C%80%E6%B1%82%E5%AE%9E%E7%8E%B0/%E7%99%BB%E5%BD%95%E9%89%B4%E6%9D%83/test/">test</a>
          </li>
        
          <li>
            <a href="/blog/2025/09/08/%E9%9C%80%E6%B1%82%E5%AE%9E%E7%8E%B0/%E7%99%BB%E5%BD%95%E9%89%B4%E6%9D%83/preferred%E6%98%AF%E5%95%A5/">userVerification:</a>
          </li>
        
          <li>
            <a href="/blog/2025/09/07/%E5%9C%A8-NestJS-%E4%B8%AD%E5%BC%95%E5%85%A5-Redis%E2%80%94%E2%80%94%E4%BB%8E-0-%E5%88%B0%E5%8F%AF%E7%94%A8%EF%BC%88ioredis-%E7%89%88%EF%BC%89/">在 NestJS 中引入 Redis——从 0 到可用（ioredis 版）</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">Home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/blog/js/jquery-3.6.4.min.js"></script>



  
<script src="/blog/fancybox/jquery.fancybox.min.js"></script>




<script src="/blog/js/script.js"></script>





  </div>
</body>
</html>