import{_ as i,c as a,o as t,ag as e}from"./chunks/framework.oqSrIbQK.js";const F=JSON.parse('{"title":"NestJS + TypeORM + Docker 迁移（Part 3）— 等待数据库与 TLS 参数","description":"在容器启动阶段可靠等待 DB，并用兼容参数禁用 TLS 验证，避免本地/自签证书报错。","frontmatter":{"title":"NestJS + TypeORM + Docker 迁移（Part 3）— 等待数据库与 TLS 参数","date":"2025-11-17T00:00:00.000Z","tags":["Docker","NestJS","TypeORM","MySQL"],"categories":["后端"],"description":"在容器启动阶段可靠等待 DB，并用兼容参数禁用 TLS 验证，避免本地/自签证书报错。"},"headers":[],"relativePath":"posts/后端/NestJS/NestJS-TypeORM-Docker-迁移-Part3-等待数据库与TLS参数.md","filePath":"posts/后端/NestJS/NestJS-TypeORM-Docker-迁移-Part3-等待数据库与TLS参数.md","lastUpdated":1764331727000}'),h={name:"posts/后端/NestJS/NestJS-TypeORM-Docker-迁移-Part3-等待数据库与TLS参数.md"};function n(l,s,p,k,r,d){return t(),a("div",null,[...s[0]||(s[0]=[e('<h2 id="症状与根因" tabindex="-1">症状与根因 <a class="header-anchor" href="#症状与根因" aria-label="Permalink to &quot;症状与根因&quot;">​</a></h2><ul><li>mysql TLS 连接报错（Certificate verification failure） <ul><li>根因：等待 DB 阶段使用的客户端默认启用 TLS，自签证书校验失败。</li></ul></li></ul><hr><h2 id="固定模板-entrypoint-sh-节选" tabindex="-1">固定模板（entrypoint.sh 节选） <a class="header-anchor" href="#固定模板-entrypoint-sh-节选" aria-label="Permalink to &quot;固定模板（entrypoint.sh 节选）&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 等待 DB（兼容 mariadb 客户端）</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">until</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> mysql</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --ssl=FALSE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --ssl-verify-server-cert=OFF</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -h</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$DB_HOST</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -P</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$DB_PORT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -u</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$DB_USER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$DB_PASS</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>\n<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;SELECT 1&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> 2&gt;&amp;1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span></span>\n<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  sleep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>\n<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">done</span></span></code></pre></div><ul><li>使用 <code>--ssl=FALSE --ssl-verify-server-cert=OFF</code> 禁用 TLS 与服务端证书校验（本地/自签场景）。</li><li>保持循环静默输出，避免日志刷屏；退出码为 0 后再继续迁移。</li></ul><hr><h2 id="日志输出建议" tabindex="-1">日志输出建议 <a class="header-anchor" href="#日志输出建议" aria-label="Permalink to &quot;日志输出建议&quot;">​</a></h2><p>在探活成功后补充打印目标信息，便于排查：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Migrations target DB → host=${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DB_HOST</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">} port=${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DB_PORT</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">} user=${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DB_USER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">} db=${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DB_NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">} (NODE_ENV=${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">NODE_ENV</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">})&quot;</span></span></code></pre></div><p>确保后续看到：Waiting for database → Database is ready → Running migrations … → Nest application started。</p>',11)])])}const E=i(h,[["render",n]]);export{F as __pageData,E as default};
