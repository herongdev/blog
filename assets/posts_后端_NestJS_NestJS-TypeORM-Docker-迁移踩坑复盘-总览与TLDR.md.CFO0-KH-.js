import{_ as o,c as t,o as s,ag as l}from"./chunks/framework.oqSrIbQK.js";const p=JSON.parse('{"title":"NestJS + TypeORM + Docker 迁移踩坑复盘（总览与 TL;DR）","description":"迁移长期不生效的根因与一次性修复要点，提供后续文章导航。","frontmatter":{"title":"NestJS + TypeORM + Docker 迁移踩坑复盘（总览与 TL;DR）","date":"2025-11-17T00:00:00.000Z","tags":["Docker","NestJS","TypeORM","MySQL","ts-node"],"categories":["后端"],"description":"迁移长期不生效的根因与一次性修复要点，提供后续文章导航。"},"headers":[],"relativePath":"posts/后端/NestJS/NestJS-TypeORM-Docker-迁移踩坑复盘-总览与TLDR.md","filePath":"posts/后端/NestJS/NestJS-TypeORM-Docker-迁移踩坑复盘-总览与TLDR.md","lastUpdated":1764331727000}'),c={name:"posts/后端/NestJS/NestJS-TypeORM-Docker-迁移踩坑复盘-总览与TLDR.md"};function a(i,e,r,d,n,_){return s(),t("div",null,[...e[0]||(e[0]=[l('<h3 id="结论-tl-dr" tabindex="-1">结论（TL;DR） <a class="header-anchor" href="#结论-tl-dr" aria-label="Permalink to &quot;结论（TL;DR）&quot;">​</a></h3><ul><li>迁移长期不生效的根因是多点叠加：环境变量未注入、Docker ENTRYPOINT 覆盖/丢失、CLI 调用方式与 TypeORM 版本不匹配、路径别名未加载、TS 严格编译阻断 CLI 执行、等待 DB 的 TLS 客户端参数不兼容等。</li><li>现已全部修复：容器启动 → 等待 DB→ 自动预览并执行迁移 →Nest 启动；后续无需手动敲命令。</li></ul><hr><h2 id="本系列导航" tabindex="-1">本系列导航 <a class="header-anchor" href="#本系列导航" aria-label="Permalink to &quot;本系列导航&quot;">​</a></h2><ul><li>Part 1（本文）：总览与 TL;DR</li><li>Part 2：Docker ENTRYPOINT、CRLF、<code>.env</code> 注入与 Compose 健康检查</li><li>Part 3：等待数据库与 TLS 客户端参数（<code>mysql --ssl=FALSE</code>）</li><li>Part 4：TypeORM CLI 正确姿势（<code>npx typeorm-ts-node-commonjs</code> + <code>tsconfig-paths</code> + <code>TRANSPILE_ONLY</code>）</li><li>Part 5：<code>data-source.ts</code> 的日志类型与迁移路径（ts/js 双环境）</li></ul><hr><h2 id="主要问题与对应修复-摘要" tabindex="-1">主要问题与对应修复（摘要） <a class="header-anchor" href="#主要问题与对应修复-摘要" aria-label="Permalink to &quot;主要问题与对应修复（摘要）&quot;">​</a></h2><ul><li>Unknown column &#39;session.last_ping_at&#39; → 强制在容器启动时自动执行迁移（固定模板）</li><li>容器重启未迁移 → <code>.env.dev</code> 未注入 DB_PASS；Compose 健康检查变量插值警告</li><li>入口脚本报错 → Windows CRLF + 直接 exec 导致解析异常；镜像内统一行尾并用 <code>sh</code> 启动</li><li>mysql TLS 报错 → 探活阶段禁用 TLS 验证：<code>--ssl=FALSE --ssl-verify-server-cert=OFF</code></li><li>TypeORM CLI 路径不匹配 → 使用 <code>npx typeorm-ts-node-commonjs ...</code></li><li>别名 <code>@</code> 解析失败 → 预加载 <code>-r ts-node/register -r tsconfig-paths/register</code></li><li>TS 严格编译阻断迁移 → <code>TS_NODE_TRANSPILE_ONLY=1</code>，并设定 <code>TS_NODE_PROJECT</code></li><li>迁移路径 ts/js 不兼容 → 运行时判断 <code>__filename</code> 后切换 glob</li><li>LoggerOptions 类型不匹配 → 使用 <code>LoggerOptions</code> 正确联合类型（或 <code>false</code>）</li></ul><hr><p>后续各篇会给出可直接复制的固定模板与详细注释，确保“容器每次启动自动、幂等地完成迁移”。</p>',10)])])}const S=o(c,[["render",a]]);export{p as __pageData,S as default};
