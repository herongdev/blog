import{_ as i,c as a,o as t,ag as n}from"./chunks/framework.oqSrIbQK.js";const g=JSON.parse('{"title":"自动上传 & 文件必填：业界最佳校验实践全案（Ant Design Upload 适用）","description":"","frontmatter":{"title":"自动上传 & 文件必填：业界最佳校验实践全案（Ant Design Upload 适用）","date":"2025-09-28T00:00:00.000Z","tags":[]},"headers":[],"relativePath":"posts/前端/下载与文件/自动上传 & 文件必填：业界最佳校验实践全案（Ant Design Upload 适用）.md","filePath":"posts/前端/下载与文件/自动上传 & 文件必填：业界最佳校验实践全案（Ant Design Upload 适用）.md","lastUpdated":1764331727000}'),l={name:"posts/前端/下载与文件/自动上传 & 文件必填：业界最佳校验实践全案（Ant Design Upload 适用）.md"};function h(k,s,e,p,r,d){return t(),a("div",null,[...s[0]||(s[0]=[n(`<h2 id="总体目标-tl-dr" tabindex="-1">总体目标（TL;DR） <a class="header-anchor" href="#总体目标-tl-dr" aria-label="Permalink to &quot;总体目标（TL;DR）&quot;">​</a></h2><ul><li><strong>用户心智一致</strong>：界面显式告诉用户“必须成功上传至少 1 个文件”。</li><li><strong>状态可见</strong>：进度、失败、成功三类状态清晰分层；错误总是可定位到<strong>具体文件</strong>。</li><li><strong>提交可控</strong>：<strong>禁止在“无成功文件”时提交</strong>；存在失败文件时提供“一键清除失败并重传”。</li><li><strong>工程稳健</strong>：以**<code>status===&#39;done&#39;</code>** 为唯一成功标准；忽略 <code>percent=100</code>；容错后端返回结构。</li></ul><hr><h2 id="设计原则" tabindex="-1">设计原则 <a class="header-anchor" href="#设计原则" aria-label="Permalink to &quot;设计原则&quot;">​</a></h2><ol><li><strong>成功定义唯一化</strong>：只认 <code>status===&#39;done&#39;</code>（拿到后端响应且解析成功）。</li><li><strong>错误优先级高于必填</strong>：只要列表中存在 <code>error</code>，先报“上传失败”；没有错误再判断“必填”。</li><li><strong>校验与 UI 同步</strong>：错误既体现在表单校验红框，也体现在文件项的错误提示（<code>file.response</code>/<code>file.error?.message</code>）。</li><li><strong>异步一致性</strong>：上传中（<code>uploading</code>）不视为满足必填；禁止提交按钮或通过表单校验。</li><li><strong>可恢复性</strong>：提供“<strong>清除失败文件</strong>”与“<strong>重试</strong>”操作；支持批量重试。</li><li><strong>可配置语义</strong>：必填语义明确为“<strong>至少成功上传 1 个</strong>”，不等价于“已选择”。</li></ol><hr><h2 id="状态机与用户路径" tabindex="-1">状态机与用户路径 <a class="header-anchor" href="#状态机与用户路径" aria-label="Permalink to &quot;状态机与用户路径&quot;">​</a></h2><ul><li><code>empty</code>（初始无文件）</li><li><code>uploading(n)</code>（n 个文件上传中）</li><li><code>done(k)</code>（k≥1 成功）</li><li><code>error(m)</code>（m≥1 失败，可与 <code>done</code> 并存）</li><li><code>mixed</code>（同时有 <code>done</code> 与 <code>error</code>）</li></ul><p><strong>提交按钮启用条件</strong>：</p><ul><li><code>done(k≥1)</code>：✅ 允许</li><li><code>mixed</code>：⚠️ 建议 <strong>允许提交但警告</strong> 或 <strong>不允许提交并提示清理失败</strong>（按业务定）</li><li>其他：❌ 禁止（无成功文件）</li></ul><hr><h2 id="校验策略矩阵" tabindex="-1">校验策略矩阵 <a class="header-anchor" href="#校验策略矩阵" aria-label="Permalink to &quot;校验策略矩阵&quot;">​</a></h2><table tabindex="0"><thead><tr><th>列表状态</th><th style="text-align:right;">是否有 error</th><th style="text-align:right;">是否有 done</th><th>校验结果</th><th>提示文案建议</th></tr></thead><tbody><tr><td>空</td><td style="text-align:right;">否</td><td style="text-align:right;">否</td><td>未通过</td><td>“请至少成功上传 1 个文件”</td></tr><tr><td>全部上传中</td><td style="text-align:right;">否</td><td style="text-align:right;">否</td><td>未通过（阻止提交）</td><td>“正在上传，请稍候或取消上传”</td></tr><tr><td>存在失败且无成功</td><td style="text-align:right;">是</td><td style="text-align:right;">否</td><td>未通过</td><td>“上传失败，请重新选择或重试”</td></tr><tr><td>存在失败且也有成功</td><td style="text-align:right;">是</td><td style="text-align:right;">是</td><td><strong>按业务</strong>：通常通过；或要求先清理失败</td><td>“部分文件上传失败，是否重试或移除失败项？”</td></tr><tr><td>无失败但无成功（可能全在上传中）</td><td style="text-align:right;">否</td><td style="text-align:right;">否</td><td>未通过</td><td>“请等待上传完成或重试”</td></tr><tr><td>至少一个成功且无失败</td><td style="text-align:right;">否</td><td style="text-align:right;">是</td><td>通过</td><td>—</td></tr></tbody></table><blockquote><p><strong>推荐默认</strong>：存在成功即可通过；失败项给黄色警告而非红色报错，但“提交后端”只取成功文件。</p></blockquote><hr><h2 id="交互与文案-推荐" tabindex="-1">交互与文案（推荐） <a class="header-anchor" href="#交互与文案-推荐" aria-label="Permalink to &quot;交互与文案（推荐）&quot;">​</a></h2><ul><li><p><strong>失败项</strong>：在文件卡片内显示 <code>失败原因</code> + <code>重试</code> + <code>移除失败</code>。</p></li><li><p><strong>全局表单提示</strong>：</p><ul><li>失败优先：“{label} 上传失败，请重新选择或重试”。</li><li>必填不足：“请至少成功上传 1 个 {label}”。</li></ul></li><li><p><strong>提交按钮</strong>：在“无成功文件”时置灰，并在 hover/点击时给出 tooltip：“需要至少 1 个成功上传的文件”。</p></li></ul><hr><h2 id="技术实现建议-antd-upload-form" tabindex="-1">技术实现建议（AntD Upload + Form） <a class="header-anchor" href="#技术实现建议-antd-upload-form" aria-label="Permalink to &quot;技术实现建议（AntD Upload + Form）&quot;">​</a></h2><ol><li><strong>仅使用 <code>change</code> 触发校验</strong>：<code>blur</code> 不稳定。</li><li><strong>过滤参与校验的文件</strong>：排除 <code>removed</code>。</li><li><strong>统一解析响应</strong>：兼容 <code>{ data.file_path }</code> / <code>{ url }</code> 等，解析失败视为 <code>error</code>。</li><li><strong>在 <code>onChange</code> 的 <code>done</code> 分支写回 <code>url/thumbUrl</code></strong>，不要在 <code>uploading</code> 阶段写业务字段。</li><li><strong>避免以 <code>percent=100</code> 判断成功</strong>。</li><li><strong>支持“清除失败”快捷动作</strong>：将 <code>fileList</code> 中 <code>status===&#39;error&#39;</code> 的项移除。</li></ol><hr><h2 id="最小校验器-仅需粘贴-替换的片段" tabindex="-1">最小校验器（仅需粘贴/替换的片段） <a class="header-anchor" href="#最小校验器-仅需粘贴-替换的片段" aria-label="Permalink to &quot;最小校验器（仅需粘贴/替换的片段）&quot;">​</a></h2><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 复杂逻辑：自动上传最佳实践校验器——失败优先，其次必填（至少一个 done）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> uploadRequiredValidator</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">label</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">required</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">_</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">v</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[]) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 参与校验的有效文件（排除已移除）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> list</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (v </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">??</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">f</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> f?.status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;removed&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 复杂逻辑：若存在 error，优先报错（引导重试/重选）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (list.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">some</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">f</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> f?.status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;error&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;files.form.rule.uploadError&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, { label }));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 复杂逻辑：成功定义唯一化——必须至少有一个 done</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> hasDone</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> list.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">some</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">f</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> f?.status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;done&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 必填语义：至少成功上传 1 个</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (required </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">hasDone) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;files.form.rule.uploadInvalid&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, { label }));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">resolve</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span></code></pre></div><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 复杂逻辑：把上面的校验器挂到你的规则上（只给需要的改动）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ([</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;image&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;file&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">includes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(field.controlType </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">??</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  rules.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">push</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    validator: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uploadRequiredValidator</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(field.label, field.required </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    trigger: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;change&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h2 id="辅助增强-可选但强烈建议" tabindex="-1">辅助增强（可选但强烈建议） <a class="header-anchor" href="#辅助增强-可选但强烈建议" aria-label="Permalink to &quot;辅助增强（可选但强烈建议）&quot;">​</a></h2><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 复杂逻辑：提供“一键清除失败文件”的工具方法，便于引导用户快速恢复</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> clearFailedFiles</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">list</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[]) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (list </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">??</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []).</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">f</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> f?.status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;error&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 复杂逻辑：统一解析服务端响应为可预览的 URL，解析失败则把文件标记为 error</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> extractUrl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">resp</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> unknown</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> string</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> undefined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> url</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (resp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)?.data?.file_path </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">??</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (resp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)?.url;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> typeof</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> url </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;string&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> url </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> undefined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 复杂逻辑：在 onChange 中仅在 done 分支写回 url/thumbUrl，并在解析失败时回退为 error</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (file.status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;done&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> rawUrl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> extractUrl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(file.response);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (rawUrl) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> url</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> props.transformResponse</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> props.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">transformResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(rawUrl)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rawUrl;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    _fileList.value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fileList.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">f</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      f.uid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> file.uid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">f, url, thumbUrl: url } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> f</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    _fileList.value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fileList.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">f</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      f.uid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> file.uid</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">f, status: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;error&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, response: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Invalid response format&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> f</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h2 id="边界情况建议" tabindex="-1">边界情况建议 <a class="header-anchor" href="#边界情况建议" aria-label="Permalink to &quot;边界情况建议&quot;">​</a></h2><ul><li><strong>用户快速反复选择/删除</strong>：以 <code>uid</code> 为准同步 <code>fileList</code>，避免重复项；必要时做<strong>节流</strong>。</li><li><strong>断网/超时</strong>：前端设置合理超时；把超时统一映射为 <code>error</code>，附可读消息。</li><li><strong>文件过大/类型不符</strong>：在 <code>beforeUpload</code> 前置拦截（大小/类型校验），避免无谓流量。</li><li><strong>多文件与部分失败</strong>：推荐<strong>通过校验</strong>（已有成功）+ <strong>橙色警告</strong>（存在失败），后端只接收成功文件的 <code>url</code>。</li></ul><hr><h2 id="可观测性与日志" tabindex="-1">可观测性与日志 <a class="header-anchor" href="#可观测性与日志" aria-label="Permalink to &quot;可观测性与日志&quot;">​</a></h2><ul><li>记录：用户选择、开始上传、进度 100%、完成/失败、重试/清理失败次数。</li><li>产物：埋点区分“因必填失败阻止提交”和“因上传失败阻止提交”，利于后续优化。</li></ul><hr><h2 id="易错点清单" tabindex="-1">易错点清单 <a class="header-anchor" href="#易错点清单" aria-label="Permalink to &quot;易错点清单&quot;">​</a></h2><ul><li>❌ 把 <code>percent=100</code> 误当作成功。</li><li>❌ 在 <code>uploading</code> 阶段就写回业务字段（<code>url</code>）。</li><li>❌ 把“选择了文件”当作“满足必填”。</li><li>❌ 遇到 <code>error</code> 仍允许提交但后端又依赖失败文件。</li><li>✅ 以 <code>done</code> 为准；失败优先；空或仅上传中均视为未满足必填。</li></ul><hr><h2 id="小结" tabindex="-1">小结 <a class="header-anchor" href="#小结" aria-label="Permalink to &quot;小结&quot;">​</a></h2><ul><li><strong>原则</strong>：失败优先 → 成功至少一项 → 其余忽略。</li><li><strong>实现</strong>：<code>status===&#39;done&#39;</code> 唯一成功判定；<code>error</code> 直接校验失败；<code>change</code> 触发足够。</li><li><strong>体验</strong>：给“清除失败/重试”的快速入口，保证从错误态到可提交态的“最短路径”。</li></ul>`,41)])])}const o=i(l,[["render",h]]);export{g as __pageData,o as default};
