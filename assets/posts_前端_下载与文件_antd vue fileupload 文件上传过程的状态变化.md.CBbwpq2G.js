import{_ as i,c as a,o as n,ag as e}from"./chunks/framework.oqSrIbQK.js";const g=JSON.parse('{"title":"Ant Design Upload：beforeUpload 与 onChange 的先后顺序、影响时机与三次触发全梳理","description":"","frontmatter":{"title":"Ant Design Upload：beforeUpload 与 onChange 的先后顺序、影响时机与三次触发全梳理","date":"2025-09-28T00:00:00.000Z","tags":["Ant Design","Upload","文件上传","前端实践"]},"headers":[],"relativePath":"posts/前端/下载与文件/antd vue fileupload 文件上传过程的状态变化.md","filePath":"posts/前端/下载与文件/antd vue fileupload 文件上传过程的状态变化.md","lastUpdated":1764331727000}'),l={name:"posts/前端/下载与文件/antd vue fileupload 文件上传过程的状态变化.md"};function t(h,s,p,o,r,k){return n(),a("div",null,[...s[0]||(s[0]=[e(`<h2 id="总览结论-tl-dr" tabindex="-1">总览结论（TL;DR） <a class="header-anchor" href="#总览结论-tl-dr" aria-label="Permalink to &quot;总览结论（TL;DR）&quot;">​</a></h2><ul><li><p><strong>时序</strong>（自动上传场景）： ① 用户选文件 → ② <code>beforeUpload</code>（可返回 false/Promise） → ③ <code>transformFile</code>（若配置）→ ④ 发起请求（或 <code>customRequest</code>）→ ⑤ <code>onChange</code>（<code>uploading/0%</code>）→ ⑥ <code>onChange</code>（进度多次，含 <code>100%</code>）→ ⑦ <code>onChange</code>（<code>done</code>/<code>error</code>，含 <code>response</code>）。</p></li><li><p><strong>第二次 <code>onChange</code></strong>（你看到的 100% 但尚未 <code>done</code>）是 <strong>XHR 进度事件</strong>触发； 文件的 <strong>类型/体积变化</strong> 来自 <strong><code>beforeUpload/transformFile</code> 的压缩或转码</strong>，通常在<strong>发请求前</strong>就已发生，因此第二次日志里会看到“已被替换后的文件信息”。</p></li><li><p><strong>影响时机</strong>：</p><ul><li><strong>阻止上传</strong>：<code>beforeUpload</code> 返回 <code>false</code>（仍可进文件列表，需手动上传）。</li><li><strong>替换文件</strong>：<code>beforeUpload</code> 返回 <code>Promise&lt;File|Blob&gt;</code> 或配置 <code>transformFile</code>，在<strong>请求前</strong>完成替换；后续 <code>onChange</code> 里拿到的就是<strong>替换后的文件</strong>。</li></ul></li></ul><hr><h2 id="事件顺序与分支详解" tabindex="-1">事件顺序与分支详解 <a class="header-anchor" href="#事件顺序与分支详解" aria-label="Permalink to &quot;事件顺序与分支详解&quot;">​</a></h2><h3 id="_1-选择文件" tabindex="-1">1) 选择文件 <a class="header-anchor" href="#_1-选择文件" aria-label="Permalink to &quot;1) 选择文件&quot;">​</a></h3><ul><li>组件捕获到文件对象，准备进入上传管线。</li></ul><h3 id="_2-beforeupload-file-filelist" tabindex="-1">2) <code>beforeUpload(file, fileList)</code> <a class="header-anchor" href="#_2-beforeupload-file-filelist" aria-label="Permalink to &quot;2) \`beforeUpload(file, fileList)\`&quot;">​</a></h3><ul><li><p><strong>调用时机</strong>：<strong>在任何网络请求发送前</strong>。</p></li><li><p><strong>用途</strong>：校验、拦截、改名、异步压缩/转码（也可放到 <code>transformFile</code>）。</p></li><li><p><strong>返回值语义</strong>：</p><ul><li><code>false</code>：<strong>阻止自动上传</strong>。文件通常仍会进列表（取决于框架/版本配置），你需要自行触发上传。</li><li><code>Promise&lt;File|Blob&gt;</code>：<strong>用返回值替换原文件</strong>（常用于压缩、改格式）。</li><li><code>true | void</code>：继续后续流程（保持原文件或交由 <code>transformFile</code> 处理）。</li></ul></li></ul><h3 id="_3-transformfile-file-若配置" tabindex="-1">3) <code>transformFile(file)</code>（若配置） <a class="header-anchor" href="#_3-transformfile-file-若配置" aria-label="Permalink to &quot;3) \`transformFile(file)\`（若配置）&quot;">​</a></h3><ul><li><strong>调用时机</strong>：<code>beforeUpload</code> 之后、请求之前。</li><li><strong>典型用途</strong>：<strong>统一处理二次转换</strong>（如图片压缩、EXIF 纠正、格式转换）。</li><li><strong>返回值</strong>：<code>File|Blob|Promise&lt;...&gt;</code>，<strong>最终进入请求体</strong>的就是这里的返回值。</li><li><strong>与 <code>beforeUpload</code> 的关系</strong>：可二选一或同时使用；<strong>先前的替换会成为这里的入参</strong>。</li></ul><h3 id="_4-发起请求-或-customrequest" tabindex="-1">4) 发起请求（或 <code>customRequest</code>） <a class="header-anchor" href="#_4-发起请求-或-customrequest" aria-label="Permalink to &quot;4) 发起请求（或 \`customRequest\`）&quot;">​</a></h3><ul><li>由组件内部或你的 <code>customRequest</code> 完成实际的 XHR/Fetch 上传。</li></ul><h3 id="_5-onchange-——-初始入列" tabindex="-1">5) <code>onChange</code> —— 初始入列 <a class="header-anchor" href="#_5-onchange-——-初始入列" aria-label="Permalink to &quot;5) \`onChange\` —— 初始入列&quot;">​</a></h3><ul><li><strong>状态</strong>：<code>status: &#39;uploading&#39;</code>，<code>percent: 0</code>（或极低）。</li><li><strong>文件对象</strong>：此时<strong>已是替换后的文件</strong>（若前面有压缩/转码）。</li><li><strong>作用</strong>：你可同步 <code>fileList</code>，轻量更新 UI。</li></ul><h3 id="_6-onchange-——-进度更新-多次" tabindex="-1">6) <code>onChange</code> —— 进度更新（多次） <a class="header-anchor" href="#_6-onchange-——-进度更新-多次" aria-label="Permalink to &quot;6) \`onChange\` —— 进度更新（多次）&quot;">​</a></h3><ul><li><strong>状态</strong>：<code>status: &#39;uploading&#39;</code>，<code>percent</code> 逐步变化，<strong>可能到 <code>100%</code></strong>。</li><li><strong>触发源</strong>：XHR 的 <code>progress</code> 事件；<strong>100% 仅代表字节发完</strong>，不等于服务端完成处理。</li><li><strong>你此前的场景</strong>：<strong>第二次日志</strong>就是这一类（<code>percent: 100</code>，仍是 <code>&#39;uploading&#39;</code>）。</li></ul><h3 id="_7-onchange-——-完成-失败" tabindex="-1">7) <code>onChange</code> —— 完成/失败 <a class="header-anchor" href="#_7-onchange-——-完成-失败" aria-label="Permalink to &quot;7) \`onChange\` —— 完成/失败&quot;">​</a></h3><ul><li><strong>状态</strong>：<code>status: &#39;done&#39;</code>（成功，带 <code>response</code>）或 <code>status: &#39;error&#39;</code>。</li><li><strong>操作</strong>：解析返回结构、写回 <code>url/thumbUrl</code>、提示成功；失败则统一错误提示。</li></ul><hr><h2 id="与你上次问题的-合并总结" tabindex="-1">与你上次问题的“合并总结” <a class="header-anchor" href="#与你上次问题的-合并总结" aria-label="Permalink to &quot;与你上次问题的“合并总结”&quot;">​</a></h2><ul><li><strong>为什么三次日志？</strong> 入列（<code>uploading/0%</code>）→ 进度（<code>uploading/100%</code>）→ 完成（<code>done</code>）。</li><li><strong>第二次到底是谁触发？</strong><strong>XHR 进度</strong>；<strong>压缩只改变文件属性</strong>，不直接触发 <code>onChange</code>，但会影响你在第二次日志里看到的 <code>type/size</code>。</li><li><strong><code>png → jpeg</code> 与体积骤降</strong>？ 来自 <strong><code>beforeUpload/transformFile</code> 的替换</strong>。</li><li><strong>链接后缀与真实 MIME 不一致</strong>？ 多由后端命名策略导致，功能不受影响；如需一致性，与服务端约定统一策略。</li></ul><hr><h2 id="最小代码补强-仅给-需要修改-的片段" tabindex="-1">最小代码补强（仅给“需要修改”的片段） <a class="header-anchor" href="#最小代码补强-仅给-需要修改-的片段" aria-label="Permalink to &quot;最小代码补强（仅给“需要修改”的片段）&quot;">​</a></h2><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 复杂逻辑：在 transform/beforeUpload 阶段给替换后的文件打标，便于 onChange 溯源</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> transformFile</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> async</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">origin</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> File</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> out</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> maybeCompressToJPEG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(origin); </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 你的压缩逻辑</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (out </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).__fromTransform </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> out;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 复杂逻辑：在 onChange 顶部增加一行调试，区分来源与阶段</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;[trace]&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  uid: file.uid,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  status: file.status,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  percent: file.percent,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  type: (file </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).type,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  size: (file </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).size,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  replaced: (file </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).__fromTransform </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 是否被替换</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  hasResponse: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(file </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).response, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 是否已有服务端响应</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 复杂逻辑：完成态才做业务写回，避免在进度阶段反复抖动 UI</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (file.status </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;done&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> rawUrl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    (file.response </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)?.data?.file_path </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">??</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (file.response </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)?.url;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (rawUrl) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> url</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> props.transformResponse</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> props.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">transformResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(rawUrl)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> rawUrl;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    _fileList.value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fileList.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">f</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      f.uid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> file.uid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">f, url, thumbUrl: url } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> f</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    window.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GtcNotification</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &quot;success&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;components.fileUpload.upload-success&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, { fileName: file.name })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    _fileList.value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fileList.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">f</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      f.uid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> file.uid</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        ?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">f, status: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;error&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, response: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Invalid response format&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> f</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    window.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">GtcNotification</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">      &quot;error&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;components.fileUpload.upload-failed&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        fileName: file.name,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        error: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;components.fileUpload.invalid-response-format&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    );</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h2 id="常见陷阱与建议" tabindex="-1">常见陷阱与建议 <a class="header-anchor" href="#常见陷阱与建议" aria-label="Permalink to &quot;常见陷阱与建议&quot;">​</a></h2><ul><li><strong>陷阱 1：在 <code>uploading</code> 阶段做重业务</strong> → UI 抖动/多次覆盖。 <strong>建议</strong>：进度阶段只做轻量同步；<strong>完成态</strong>（<code>done</code>）再写业务字段。</li><li><strong>陷阱 2：混淆“进度 100%”与“完成”</strong>。 <strong>建议</strong>：以 <code>status</code> 判定阶段；<code>percent=100</code> 仍是 <code>uploading</code>。</li><li><strong>陷阱 3：不知道替换发生了没</strong>。 <strong>建议</strong>：对替换后的文件<strong>打标</strong>（如 <code>__fromTransform</code>），在 <code>onChange</code> 打印查看。</li><li><strong>陷阱 4：服务端返回结构不稳</strong>。 <strong>建议</strong>：抽取统一的 <code>extractUrl</code> 方法，兼容 <code>data.file_path</code>/<code>url</code> 等不同格式。</li></ul><hr><h2 id="调试清单-checklist" tabindex="-1">调试清单（Checklist） <a class="header-anchor" href="#调试清单-checklist" aria-label="Permalink to &quot;调试清单（Checklist）&quot;">​</a></h2><ul><li>在 <code>beforeUpload/transformFile</code> 里为返回文件加 <code>__fromTransform=true</code>。</li><li>在 <code>onChange</code> 打印：<code>status/percent/type/size/response/replaced</code>。</li><li>仅在 <code>done</code> 分支解析 <code>response</code> 并更新 <code>url/thumbUrl</code>。</li><li>若使用 <code>customRequest</code>，确保也按上述时序调用 <code>onProgress/onSuccess/onError</code>。</li></ul><hr><h2 id="参考时序-可打印验证" tabindex="-1">参考时序（可打印验证） <a class="header-anchor" href="#参考时序-可打印验证" aria-label="Permalink to &quot;参考时序（可打印验证）&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>选择文件</span></span>
<span class="line"><span>  ↳ beforeUpload (可返回 false / Promise)</span></span>
<span class="line"><span>  ↳ transformFile (如配置)</span></span>
<span class="line"><span>  ↳ 发起请求（或 customRequest）</span></span>
<span class="line"><span>      ↳ onChange: uploading, 0%</span></span>
<span class="line"><span>      ↳ onChange: uploading, ...%, 100%</span></span>
<span class="line"><span>      ↳ onChange: done / error（含 response）</span></span></code></pre></div><blockquote><p>如果 <code>beforeUpload</code> 返回 <code>false</code>：<strong>不会自动发请求</strong>；文件可进列表但<strong>不会进入后续进度与完成态</strong>，需要你手动触发上传（方式依框架/版本而异）。</p></blockquote>`,36)])])}const E=i(l,[["render",t]]);export{g as __pageData,E as default};
