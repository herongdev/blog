import{_ as i,c as a,o as h,ag as n}from"./chunks/framework.oqSrIbQK.js";const g=JSON.parse('{"title":"SSH 公钥私钥原理与部署脚本实战","description":"深入解析 SSH 公钥私钥的加密原理，结合实际的 Jenkins + Gitee + 远程服务器部署脚本，详细说明密钥在通信过程中的加解密流程。","frontmatter":{"title":"SSH 公钥私钥原理与部署脚本实战","date":"2024-01-15T10:00:00.000Z","categories":["云开发","运维部署"],"tags":["SSH","密钥认证","自动化部署","Jenkins","Bash"],"description":"深入解析 SSH 公钥私钥的加密原理，结合实际的 Jenkins + Gitee + 远程服务器部署脚本，详细说明密钥在通信过程中的加解密流程。"},"headers":[],"relativePath":"posts/前端/云开发/SSH公钥私钥原理与部署脚本实战.md","filePath":"posts/前端/云开发/SSH公钥私钥原理与部署脚本实战.md","lastUpdated":1764331727000}'),t={name:"posts/前端/云开发/SSH公钥私钥原理与部署脚本实战.md"};function e(l,s,p,k,r,d){return h(),a("div",null,[...s[0]||(s[0]=[n(`<h2 id="_1-公钥和私钥的生成" tabindex="-1">1. 公钥和私钥的生成 <a class="header-anchor" href="#_1-公钥和私钥的生成" aria-label="Permalink to &quot;1. 公钥和私钥的生成&quot;">​</a></h2><p>当你生成一对 SSH 密钥时，会得到一个公钥和一个私钥：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ssh-keygen</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rsa</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -b</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4096</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -C</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;your_email@example.com&quot;</span></span></code></pre></div><ul><li><strong>公钥 (Public Key)</strong>：这是你可以公开分享的部分，通常存放在 <code>id_rsa.pub</code> 文件中。</li><li><strong>私钥 (Private Key)</strong>：这是你需要保密的部分，通常存放在 <code>id_rsa</code> 文件中。</li></ul><hr><h2 id="_2-加密数据" tabindex="-1">2. 加密数据 <a class="header-anchor" href="#_2-加密数据" aria-label="Permalink to &quot;2. 加密数据&quot;">​</a></h2><h3 id="发送数据到服务器" tabindex="-1">发送数据到服务器 <a class="header-anchor" href="#发送数据到服务器" aria-label="Permalink to &quot;发送数据到服务器&quot;">​</a></h3><p>当你向服务器发送数据时，服务器会使用你的公钥加密数据。只有持有与你公钥匹配的私钥的人才能解密这些数据。</p><h3 id="完整流程" tabindex="-1">完整流程： <a class="header-anchor" href="#完整流程" aria-label="Permalink to &quot;完整流程：&quot;">​</a></h3><h4 id="_1-客户端-你-生成密钥对" tabindex="-1">1. <strong>客户端 (你) 生成密钥对</strong> <a class="header-anchor" href="#_1-客户端-你-生成密钥对" aria-label="Permalink to &quot;1. **客户端 (你) 生成密钥对**&quot;">​</a></h4><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ssh-keygen</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rsa</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -b</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4096</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -C</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;your_email@example.com&quot;</span></span></code></pre></div><h4 id="_2-客户端将公钥上传到服务器" tabindex="-1">2. <strong>客户端将公钥上传到服务器</strong> <a class="header-anchor" href="#_2-客户端将公钥上传到服务器" aria-label="Permalink to &quot;2. **客户端将公钥上传到服务器**&quot;">​</a></h4><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/.ssh/id_rsa.pub</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ssh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> user@server</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;mkdir -p ~/.ssh &amp;&amp; cat &gt;&gt; ~/.ssh/authorized_keys&quot;</span></span></code></pre></div><h4 id="_3-服务器使用你的公钥加密数据" tabindex="-1">3. <strong>服务器使用你的公钥加密数据</strong> <a class="header-anchor" href="#_3-服务器使用你的公钥加密数据" aria-label="Permalink to &quot;3. **服务器使用你的公钥加密数据**&quot;">​</a></h4><ul><li>服务器用公钥加密一段信息，比如一个会话密钥。</li><li>加密过程大致如下（伪代码表示）：</li></ul><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">encrypted_data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> encrypt_with_public_key(public_key, data)</span></span></code></pre></div><h4 id="_4-客户端使用私钥解密数据" tabindex="-1">4. <strong>客户端使用私钥解密数据</strong> <a class="header-anchor" href="#_4-客户端使用私钥解密数据" aria-label="Permalink to &quot;4. **客户端使用私钥解密数据**&quot;">​</a></h4><ul><li>客户端收到加密数据后，用私钥解密：</li></ul><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">decrypted_data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> decrypt_with_private_key(private_key, encrypted_data)</span></span></code></pre></div><hr><h2 id="_3-解密数据" tabindex="-1">3. 解密数据 <a class="header-anchor" href="#_3-解密数据" aria-label="Permalink to &quot;3. 解密数据&quot;">​</a></h2><h3 id="验证服务器身份" tabindex="-1">验证服务器身份 <a class="header-anchor" href="#验证服务器身份" aria-label="Permalink to &quot;验证服务器身份&quot;">​</a></h3><p>当你连接到服务器时，服务器会向你发送一个加密的信息，你用你的私钥解密并返回结果以证明你是密钥的拥有者。</p><h4 id="_1-服务器生成加密挑战" tabindex="-1">1. <strong>服务器生成加密挑战</strong> <a class="header-anchor" href="#_1-服务器生成加密挑战" aria-label="Permalink to &quot;1. **服务器生成加密挑战**&quot;">​</a></h4><ul><li>服务器生成一个随机数或消息，并用你的公钥加密：</li></ul><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">challenge </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> generate_random_challenge()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">encrypted_challenge </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> encrypt_with_public_key(public_key, challenge)</span></span></code></pre></div><h4 id="_2-客户端解密挑战" tabindex="-1">2. <strong>客户端解密挑战</strong> <a class="header-anchor" href="#_2-客户端解密挑战" aria-label="Permalink to &quot;2. **客户端解密挑战**&quot;">​</a></h4><ul><li>客户端收到加密挑战，用私钥解密：</li></ul><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">decrypted_challenge </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> decrypt_with_private_key(private_key, encrypted_challenge)</span></span></code></pre></div><h4 id="_3-客户端返回解密结果" tabindex="-1">3. <strong>客户端返回解密结果</strong> <a class="header-anchor" href="#_3-客户端返回解密结果" aria-label="Permalink to &quot;3. **客户端返回解密结果**&quot;">​</a></h4><ul><li>客户端将解密后的挑战返回服务器以验证身份：</li></ul><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">send_to_server(decrypted_challenge)</span></span></code></pre></div><h4 id="_4-服务器验证挑战结果" tabindex="-1">4. <strong>服务器验证挑战结果</strong> <a class="header-anchor" href="#_4-服务器验证挑战结果" aria-label="Permalink to &quot;4. **服务器验证挑战结果**&quot;">​</a></h4><ul><li>服务器验证收到的解密结果是否正确：</li></ul><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> decrypted_challenge </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> original_challenge:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    authenticate_client()</span></span></code></pre></div><hr><h2 id="_4-安全通信" tabindex="-1">4. 安全通信 <a class="header-anchor" href="#_4-安全通信" aria-label="Permalink to &quot;4. 安全通信&quot;">​</a></h2><ul><li><strong>公钥加密</strong>：只能用公钥加密，私钥解密。保证了只有持有私钥的人才能读取数据。</li><li><strong>私钥签名</strong>：用私钥生成签名，公钥验证签名。保证了数据确实由持有私钥的人发送。</li></ul><hr><h2 id="_5-详细过程举例" tabindex="-1">5. 详细过程举例 <a class="header-anchor" href="#_5-详细过程举例" aria-label="Permalink to &quot;5. 详细过程举例&quot;">​</a></h2><p>假设你要通过 SSH 连接到一个远程服务器：</p><h3 id="_1-生成密钥对" tabindex="-1">1. <strong>生成密钥对</strong> <a class="header-anchor" href="#_1-生成密钥对" aria-label="Permalink to &quot;1. **生成密钥对**&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ssh-keygen</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rsa</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -b</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4096</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -C</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;your_email@example.com&quot;</span></span></code></pre></div><h3 id="_2-将公钥添加到服务器的-authorized-keys" tabindex="-1">2. <strong>将公钥添加到服务器的 <code>authorized_keys</code></strong> <a class="header-anchor" href="#_2-将公钥添加到服务器的-authorized-keys" aria-label="Permalink to &quot;2. **将公钥添加到服务器的 \`authorized_keys\`**&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/.ssh/id_rsa.pub</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ssh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> user@server</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;mkdir -p ~/.ssh &amp;&amp; cat &gt;&gt; ~/.ssh/authorized_keys&quot;</span></span></code></pre></div><h3 id="_3-连接服务器" tabindex="-1">3. <strong>连接服务器</strong> <a class="header-anchor" href="#_3-连接服务器" aria-label="Permalink to &quot;3. **连接服务器**&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ssh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> user@server</span></span></code></pre></div><h3 id="_4-身份验证过程" tabindex="-1">4. <strong>身份验证过程</strong> <a class="header-anchor" href="#_4-身份验证过程" aria-label="Permalink to &quot;4. **身份验证过程**&quot;">​</a></h3><ul><li>服务器发送加密挑战。</li><li>客户端用私钥解密挑战并返回。</li><li>服务器验证解密结果，确认客户端身份。</li></ul><hr><h2 id="_6-公钥和私钥管理最佳实践" tabindex="-1">6. 公钥和私钥管理最佳实践 <a class="header-anchor" href="#_6-公钥和私钥管理最佳实践" aria-label="Permalink to &quot;6. 公钥和私钥管理最佳实践&quot;">​</a></h2><ul><li><strong>私钥保密</strong>：私钥必须保密，不能与任何人分享。</li><li><strong>权限设置</strong>：设置私钥文件权限，使只有拥有者可读写：</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">chmod</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 600</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/.ssh/id_rsa</span></span></code></pre></div><ul><li><strong>定期更换密钥</strong>：定期更换 SSH 密钥，确保安全性。</li><li><strong>公钥只读</strong>：确保公钥可以公开访问，但不会泄露私钥信息。</li></ul><hr><h2 id="小结" tabindex="-1">小结 <a class="header-anchor" href="#小结" aria-label="Permalink to &quot;小结&quot;">​</a></h2><p>SSH 公钥和私钥通过非对称加密机制保障了数据传输的安全性。公钥用于加密和验证签名，私钥用于解密和生成签名。这种机制确保了数据在传输过程中的机密性和完整性。</p><hr><h2 id="实战-jenkins-自动部署脚本" tabindex="-1">实战：Jenkins 自动部署脚本 <a class="header-anchor" href="#实战-jenkins-自动部署脚本" aria-label="Permalink to &quot;实战：Jenkins 自动部署脚本&quot;">​</a></h2><p>以下是一个完整的 Bash 部署脚本示例，演示如何使用 SSH 密钥进行自动化部署：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#!/bin/bash</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 设置环境变量</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">REMOTE_SERVER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">172.18.6.250</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">REMOTE_USER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">root</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 通用的部署目录</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DEPLOY_DIR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/usr/local/deployment</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TEMP_DIR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/usr/local/temp_deployment</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Jenkins 环境变量</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">REPO_URL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">git@gitee.com:herongxhr/mianshiti.git</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SSH_KEY_PATH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/var/lib/jenkins/.ssh/id_rsa</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 打印操作步骤</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;开始部署脚本...&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;使用的仓库地址: </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$REPO_URL</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;使用的SSH密钥路径: </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$SSH_KEY_PATH</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 创建临时目录</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;创建临时目录...&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $TEMP_DIR</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 克隆代码仓库到临时目录</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;正在克隆代码仓库...&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clone</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $REPO_URL $TEMP_DIR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/mianshiti</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Git 克隆失败&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 压缩代码</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;压缩代码...&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tar</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -czf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $TEMP_DIR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/mianshiti.tar.gz</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -C</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $TEMP_DIR </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">mianshiti</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;创建压缩包失败&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 确保远程服务器上的部署目录存在</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;确保远程服务器上的部署目录存在...&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ssh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $SSH_KEY_PATH $REMOTE_USER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">@</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$REMOTE_SERVER </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;mkdir -p </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$DEPLOY_DIR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;远程服务器上创建目录失败&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 上传代码到远程服务器</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;上传代码到远程服务器...&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">scp</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $SSH_KEY_PATH $TEMP_DIR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/mianshiti.tar.gz</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $REMOTE_USER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">@</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$REMOTE_SERVER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$DEPLOY_DIR </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;上传失败&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># SSH到远程服务器进行部署</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;在远程服务器上进行部署...&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ssh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $SSH_KEY_PATH $REMOTE_USER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">@</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$REMOTE_SERVER </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    set -e</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    echo &quot;解压代码...&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    cd </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$DEPLOY_DIR</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    tar -xzf mianshiti.tar.gz || { echo &quot;解压失败&quot;; exit 1; }</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    cd mianshiti || { echo &quot;目录 &#39;mianshiti&#39; 未找到&quot;; exit 1; }</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    echo &quot;构建Docker镜像...&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    docker-compose build web || { echo &quot;Docker 构建失败&quot;; exit 1; }</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    echo &quot;启动所有服务...&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    docker-compose up -d || { echo &quot;Docker 启动失败&quot;; exit 1; }</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;部署完成。&quot;</span></span></code></pre></div><hr><h2 id="脚本中的-ssh-通信过程详解" tabindex="-1">脚本中的 SSH 通信过程详解 <a class="header-anchor" href="#脚本中的-ssh-通信过程详解" aria-label="Permalink to &quot;脚本中的 SSH 通信过程详解&quot;">​</a></h2><h3 id="_1-ssh-公钥和私钥的生成" tabindex="-1">1. SSH 公钥和私钥的生成 <a class="header-anchor" href="#_1-ssh-公钥和私钥的生成" aria-label="Permalink to &quot;1. SSH 公钥和私钥的生成&quot;">​</a></h3><p>当你生成一对 SSH 密钥时，会得到一个公钥和一个私钥：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ssh-keygen</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rsa</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -b</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4096</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -C</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;your_email@example.com&quot;</span></span></code></pre></div><ul><li><strong>公钥 (Public Key)</strong>：这是你可以公开分享的部分，通常存放在 <code>id_rsa.pub</code> 文件中。</li><li><strong>私钥 (Private Key)</strong>：这是你需要保密的部分，通常存放在 <code>id_rsa</code> 文件中。</li></ul><h3 id="_2-上传公钥到服务器" tabindex="-1">2. 上传公钥到服务器 <a class="header-anchor" href="#_2-上传公钥到服务器" aria-label="Permalink to &quot;2. 上传公钥到服务器&quot;">​</a></h3><p>在你的脚本中，<code>REPO_URL</code> 是 Gitee 仓库的地址，<code>SSH_KEY_PATH</code> 是 Jenkins 使用的私钥文件路径。</p><p>你需要确保公钥已经上传到远程服务器的 <code>~/.ssh/authorized_keys</code> 文件中：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ssh-copy-id</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/.ssh/id_rsa.pub</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> user@server</span></span></code></pre></div><h3 id="_3-ssh-通信过程中的加解密" tabindex="-1">3. SSH 通信过程中的加解密 <a class="header-anchor" href="#_3-ssh-通信过程中的加解密" aria-label="Permalink to &quot;3. SSH 通信过程中的加解密&quot;">​</a></h3><h4 id="客户端连接服务器" tabindex="-1">客户端连接服务器 <a class="header-anchor" href="#客户端连接服务器" aria-label="Permalink to &quot;客户端连接服务器&quot;">​</a></h4><p>当你在 Jenkins 中执行脚本时，使用 SSH 连接到远程服务器。具体过程如下：</p><h4 id="_1-客户端发起连接" tabindex="-1">1. <strong>客户端发起连接</strong> <a class="header-anchor" href="#_1-客户端发起连接" aria-label="Permalink to &quot;1. **客户端发起连接**&quot;">​</a></h4><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ssh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/lib/jenkins/.ssh/id_rsa</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $REMOTE_USER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">@</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$REMOTE_SERVER</span></span></code></pre></div><h4 id="_2-服务器发送公钥加密的挑战信息" tabindex="-1">2. <strong>服务器发送公钥加密的挑战信息</strong> <a class="header-anchor" href="#_2-服务器发送公钥加密的挑战信息" aria-label="Permalink to &quot;2. **服务器发送公钥加密的挑战信息**&quot;">​</a></h4><p>服务器使用存储在 <code>~/.ssh/authorized_keys</code> 文件中的公钥加密一个随机生成的挑战信息，并将其发送给客户端。</p><h4 id="_3-客户端使用私钥解密挑战信息" tabindex="-1">3. <strong>客户端使用私钥解密挑战信息</strong> <a class="header-anchor" href="#_3-客户端使用私钥解密挑战信息" aria-label="Permalink to &quot;3. **客户端使用私钥解密挑战信息**&quot;">​</a></h4><p>客户端使用私钥解密挑战信息：</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">decrypted_challenge </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> decrypt_with_private_key(private_key, encrypted_challenge)</span></span></code></pre></div><h4 id="_4-客户端返回解密后的挑战信息" tabindex="-1">4. <strong>客户端返回解密后的挑战信息</strong> <a class="header-anchor" href="#_4-客户端返回解密后的挑战信息" aria-label="Permalink to &quot;4. **客户端返回解密后的挑战信息**&quot;">​</a></h4><p>客户端将解密后的挑战信息发送回服务器，以证明其拥有私钥。</p><h4 id="_5-服务器验证解密结果" tabindex="-1">5. <strong>服务器验证解密结果</strong> <a class="header-anchor" href="#_5-服务器验证解密结果" aria-label="Permalink to &quot;5. **服务器验证解密结果**&quot;">​</a></h4><p>服务器验证解密结果，如果匹配，则允许客户端连接。</p><hr><h2 id="使用密钥进行通信的完整过程" tabindex="-1">使用密钥进行通信的完整过程 <a class="header-anchor" href="#使用密钥进行通信的完整过程" aria-label="Permalink to &quot;使用密钥进行通信的完整过程&quot;">​</a></h2><p>结合你的脚本，以下是 SSH 和密钥通信的加解密过程的完整解释：</p><h3 id="创建和设置环境变量" tabindex="-1">创建和设置环境变量 <a class="header-anchor" href="#创建和设置环境变量" aria-label="Permalink to &quot;创建和设置环境变量&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">REMOTE_SERVER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">172.18.6.250</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">REMOTE_USER</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">root</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">DEPLOY_DIR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/usr/local/deployment</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TEMP_DIR</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/usr/local/temp_deployment</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">REPO_URL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">git@gitee.com:herongxhr/mianshiti.git</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SSH_KEY_PATH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/var/lib/jenkins/.ssh/id_rsa</span></span></code></pre></div><h3 id="打印操作步骤" tabindex="-1">打印操作步骤 <a class="header-anchor" href="#打印操作步骤" aria-label="Permalink to &quot;打印操作步骤&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;开始部署脚本...&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;使用的仓库地址: </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$REPO_URL</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;使用的SSH密钥路径: </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$SSH_KEY_PATH</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span></code></pre></div><h3 id="创建临时目录" tabindex="-1">创建临时目录 <a class="header-anchor" href="#创建临时目录" aria-label="Permalink to &quot;创建临时目录&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mkdir</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $TEMP_DIR</span></span></code></pre></div><h3 id="克隆代码仓库到临时目录" tabindex="-1">克隆代码仓库到临时目录 <a class="header-anchor" href="#克隆代码仓库到临时目录" aria-label="Permalink to &quot;克隆代码仓库到临时目录&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clone</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $REPO_URL $TEMP_DIR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/mianshiti</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Git 克隆失败&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; }</span></span></code></pre></div><h3 id="压缩代码" tabindex="-1">压缩代码 <a class="header-anchor" href="#压缩代码" aria-label="Permalink to &quot;压缩代码&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tar</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -czf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $TEMP_DIR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/mianshiti.tar.gz</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -C</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $TEMP_DIR </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">mianshiti</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;创建压缩包失败&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; }</span></span></code></pre></div><h3 id="确保远程服务器上的部署目录存在" tabindex="-1">确保远程服务器上的部署目录存在 <a class="header-anchor" href="#确保远程服务器上的部署目录存在" aria-label="Permalink to &quot;确保远程服务器上的部署目录存在&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ssh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $SSH_KEY_PATH $REMOTE_USER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">@</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$REMOTE_SERVER </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;mkdir -p </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$DEPLOY_DIR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;远程服务器上创建目录失败&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; }</span></span></code></pre></div><h3 id="上传代码到远程服务器" tabindex="-1">上传代码到远程服务器 <a class="header-anchor" href="#上传代码到远程服务器" aria-label="Permalink to &quot;上传代码到远程服务器&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">scp</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $SSH_KEY_PATH $TEMP_DIR</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/mianshiti.tar.gz</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $REMOTE_USER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">@</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$REMOTE_SERVER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$DEPLOY_DIR </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;上传失败&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; }</span></span></code></pre></div><h3 id="在远程服务器上进行部署" tabindex="-1">在远程服务器上进行部署 <a class="header-anchor" href="#在远程服务器上进行部署" aria-label="Permalink to &quot;在远程服务器上进行部署&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ssh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $SSH_KEY_PATH $REMOTE_USER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">@</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$REMOTE_SERVER </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> EOF</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    set -e</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    echo &quot;解压代码...&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    cd </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$DEPLOY_DIR</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    tar -xzf mianshiti.tar.gz || { echo &quot;解压失败&quot;; exit 1; }</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    cd mianshiti || { echo &quot;目录 &#39;mianshiti&#39; 未找到&quot;; exit 1; }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    echo &quot;构建Docker镜像...&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    docker-compose build web || { echo &quot;Docker 构建失败&quot;; exit 1; }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    echo &quot;启动所有服务...&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    docker-compose up -d || { echo &quot;Docker 启动失败&quot;; exit 1; }</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">echo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;部署完成。&quot;</span></span></code></pre></div><hr><h2 id="两种场景的-ssh-通信详解" tabindex="-1">两种场景的 SSH 通信详解 <a class="header-anchor" href="#两种场景的-ssh-通信详解" aria-label="Permalink to &quot;两种场景的 SSH 通信详解&quot;">​</a></h2><p>在你的脚本中，你使用了 SSH 密钥对与 Gitee 和远程部署服务器进行通信。以下是详细解释如何在这两个场景中通过 SSH 和密钥进行安全通信的完整过程。</p><h3 id="场景一-与-gitee-的-ssh-通信过程" tabindex="-1">场景一：与 Gitee 的 SSH 通信过程 <a class="header-anchor" href="#场景一-与-gitee-的-ssh-通信过程" aria-label="Permalink to &quot;场景一：与 Gitee 的 SSH 通信过程&quot;">​</a></h3><h4 id="_1-1-生成-ssh-密钥对" tabindex="-1">1.1 生成 SSH 密钥对 <a class="header-anchor" href="#_1-1-生成-ssh-密钥对" aria-label="Permalink to &quot;1.1 生成 SSH 密钥对&quot;">​</a></h4><p>你需要先生成 SSH 密钥对：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ssh-keygen</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rsa</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -b</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4096</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -C</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;your_email@example.com&quot;</span></span></code></pre></div><ul><li><strong>公钥 (Public Key)</strong>：存储在 <code>~/.ssh/id_rsa.pub</code> 文件中。这个公钥会被上传到 Gitee。</li><li><strong>私钥 (Private Key)</strong>：存储在 <code>~/.ssh/id_rsa</code> 文件中。这个私钥会保存在 Jenkins 服务器上。</li></ul><h4 id="_1-2-上传公钥到-gitee" tabindex="-1">1.2 上传公钥到 Gitee <a class="header-anchor" href="#_1-2-上传公钥到-gitee" aria-label="Permalink to &quot;1.2 上传公钥到 Gitee&quot;">​</a></h4><p>在 Gitee 的设置页面，将生成的公钥 <code>id_rsa.pub</code> 添加到 Gitee 的 SSH 公钥列表中。</p><h4 id="_1-3-在-jenkins-上使用私钥" tabindex="-1">1.3 在 Jenkins 上使用私钥 <a class="header-anchor" href="#_1-3-在-jenkins-上使用私钥" aria-label="Permalink to &quot;1.3 在 Jenkins 上使用私钥&quot;">​</a></h4><p>在 Jenkins 上，确保私钥文件存在并且 Jenkins 用户有权限读取这个私钥：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> cp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/.ssh/id_rsa</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/lib/jenkins/.ssh/id_rsa</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> chown</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> jenkins:jenkins</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/lib/jenkins/.ssh/id_rsa</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> chmod</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 600</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /var/lib/jenkins/.ssh/id_rsa</span></span></code></pre></div><h3 id="场景二-与远程部署服务器的-ssh-通信过程" tabindex="-1">场景二：与远程部署服务器的 SSH 通信过程 <a class="header-anchor" href="#场景二-与远程部署服务器的-ssh-通信过程" aria-label="Permalink to &quot;场景二：与远程部署服务器的 SSH 通信过程&quot;">​</a></h3><h4 id="_2-1-生成-ssh-密钥对" tabindex="-1">2.1 生成 SSH 密钥对 <a class="header-anchor" href="#_2-1-生成-ssh-密钥对" aria-label="Permalink to &quot;2.1 生成 SSH 密钥对&quot;">​</a></h4><p>这与上述过程相同，你可以使用同一对密钥对。</p><h4 id="_2-2-上传公钥到远程服务器" tabindex="-1">2.2 上传公钥到远程服务器 <a class="header-anchor" href="#_2-2-上传公钥到远程服务器" aria-label="Permalink to &quot;2.2 上传公钥到远程服务器&quot;">​</a></h4><p>将生成的公钥 <code>id_rsa.pub</code> 添加到远程服务器的 <code>~/.ssh/authorized_keys</code> 文件中：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ssh-copy-id</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/.ssh/id_rsa.pub</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root@172.18.6.250</span></span></code></pre></div><h4 id="_2-3-在脚本中使用私钥" tabindex="-1">2.3 在脚本中使用私钥 <a class="header-anchor" href="#_2-3-在脚本中使用私钥" aria-label="Permalink to &quot;2.3 在脚本中使用私钥&quot;">​</a></h4><p>确保在脚本中使用正确的私钥路径：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SSH_KEY_PATH</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/var/lib/jenkins/.ssh/id_rsa</span></span></code></pre></div><hr><h2 id="详细的-ssh-通信流程" tabindex="-1">详细的 SSH 通信流程 <a class="header-anchor" href="#详细的-ssh-通信流程" aria-label="Permalink to &quot;详细的 SSH 通信流程&quot;">​</a></h2><h3 id="_1-ssh-通信与-gitee" tabindex="-1">1. SSH 通信与 Gitee <a class="header-anchor" href="#_1-ssh-通信与-gitee" aria-label="Permalink to &quot;1. SSH 通信与 Gitee&quot;">​</a></h3><ul><li><strong>发起连接</strong>：Jenkins 使用私钥 <code>/var/lib/jenkins/.ssh/id_rsa</code> 发起与 Gitee 的 SSH 连接。</li><li><strong>Gitee 发送公钥加密的挑战</strong>：Gitee 使用你上传的公钥加密一个挑战信息并发送给 Jenkins。</li><li><strong>Jenkins 解密挑战</strong>：Jenkins 使用私钥解密挑战信息。</li><li><strong>验证</strong>：Jenkins 将解密后的信息发送回 Gitee，Gitee 验证解密信息正确性，允许连接。</li></ul><h3 id="_2-ssh-通信与远程服务器" tabindex="-1">2. SSH 通信与远程服务器 <a class="header-anchor" href="#_2-ssh-通信与远程服务器" aria-label="Permalink to &quot;2. SSH 通信与远程服务器&quot;">​</a></h3><ul><li><strong>发起连接</strong>：Jenkins 使用相同的私钥发起与远程服务器的 SSH 连接。</li><li><strong>远程服务器发送公钥加密的挑战</strong>：远程服务器使用 <code>~/.ssh/authorized_keys</code> 文件中的公钥加密一个挑战信息并发送给 Jenkins。</li><li><strong>Jenkins 解密挑战</strong>：Jenkins 使用私钥解密挑战信息。</li><li><strong>验证</strong>：Jenkins 将解密后的信息发送回远程服务器，远程服务器验证解密信息正确性，允许连接。</li></ul><hr><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h2><p>通过 SSH 公钥私钥机制，我们可以实现安全、自动化的代码部署流程。关键要点：</p><ol><li><strong>密钥对生成</strong>：使用 <code>ssh-keygen</code> 生成公钥和私钥</li><li><strong>公钥分发</strong>：将公钥上传到 Gitee 和远程服务器</li><li><strong>私钥保护</strong>：妥善保管私钥，设置正确的文件权限</li><li><strong>自动化认证</strong>：在脚本中使用 <code>-i</code> 参数指定私钥路径</li><li><strong>安全通信</strong>：通过挑战-响应机制验证身份，确保通信安全</li></ol><p>这种方式避免了在脚本中硬编码密码，大大提升了自动化部署的安全性和便利性。</p>`,137)])])}const c=i(t,[["render",e]]);export{g as __pageData,c as default};
