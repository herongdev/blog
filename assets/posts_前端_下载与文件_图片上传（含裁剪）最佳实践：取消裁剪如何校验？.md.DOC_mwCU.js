import{_ as i,c as a,o as n,ag as l}from"./chunks/framework.oqSrIbQK.js";const o=JSON.parse('{"title":"图片上传（含裁剪）最佳实践：取消裁剪如何校验？","description":"","frontmatter":{"title":"图片上传（含裁剪）最佳实践：取消裁剪如何校验？","date":"2025-09-28T00:00:00.000Z","tags":[]},"headers":[],"relativePath":"posts/前端/下载与文件/图片上传（含裁剪）最佳实践：取消裁剪如何校验？.md","filePath":"posts/前端/下载与文件/图片上传（含裁剪）最佳实践：取消裁剪如何校验？.md","lastUpdated":1764331727000}'),t={name:"posts/前端/下载与文件/图片上传（含裁剪）最佳实践：取消裁剪如何校验？.md"};function h(e,s,k,p,r,d){return n(),a("div",null,[...s[0]||(s[0]=[l(`<h2 id="tl-dr" tabindex="-1">TL;DR <a class="header-anchor" href="#tl-dr" aria-label="Permalink to &quot;TL;DR&quot;">​</a></h2><ul><li><strong>取消裁剪 ≠ 失败</strong>：用户放弃本次选择，应视为<strong>未选择</strong>，而不是上传失败。</li><li><strong>占位项策略</strong>：选择文件时先写入一条 <code>uploading</code> 占位；<strong>确认</strong>时就地改为 <code>done</code>，<strong>失败</strong>改为 <code>error</code>，<strong>取消</strong>则<strong>移除占位</strong>。</li><li><strong>校验触发</strong>：取消或完成后调用表单 <code>onFieldChange()</code>，让必填/失败规则即时生效。</li><li><strong>规则分治</strong>：<code>change</code> 阶段只提示（warning），<code>submit</code> 阶段严格拦截（error）。</li></ul><hr><h2 id="交互流转-状态机" tabindex="-1">交互流转（状态机） <a class="header-anchor" href="#交互流转-状态机" aria-label="Permalink to &quot;交互流转（状态机）&quot;">​</a></h2><ol><li><strong>选择文件</strong> → 写入占位：<code>{ uid, name, status:&#39;uploading&#39;, percent:0 }</code></li><li><strong>弹出裁剪框</strong></li><li><strong>确认裁剪</strong> → 压缩 → 上传成功：占位 <strong>就地更新</strong> <code>status:&#39;done&#39;, url/thumbUrl, percent:100</code></li><li><strong>上传失败</strong>：占位 <strong>就地更新</strong> <code>status:&#39;error&#39;, response</code></li><li><strong>取消裁剪</strong>：<strong>移除占位</strong>，并触发表单校验（若必填则提示“请至少上传 1 张”）</li></ol><hr><h2 id="校验最佳实践" tabindex="-1">校验最佳实践 <a class="header-anchor" href="#校验最佳实践" aria-label="Permalink to &quot;校验最佳实践&quot;">​</a></h2><p><strong>目标</strong>：用户行为清晰，错误信息不重复、不误导。</p><ul><li><p><strong>变更阶段（<code>change</code>）</strong>：</p><ul><li>仅对明确失败 <code>error</code> 做 <strong>warning</strong>（不置红，不阻断）。</li><li>对 <code>uploading</code>（即便 <code>percent=100</code>）不报错。</li></ul></li><li><p><strong>提交阶段（<code>submit</code>）</strong>：</p><ol><li>若存在 <code>error</code>：报“上传失败”；</li><li>若存在 <code>uploading</code>：报“仍在上传，请稍候”；</li><li>若必填但无 <code>done</code>：报“请至少成功上传 1 张图片”。</li></ol></li></ul><blockquote><p>配置上可在 <code>Form.Item</code> 开启 <code>validateFirst</code>，避免同周期多条错误叠加。</p></blockquote><hr><h2 id="仅需调整的关键代码片段" tabindex="-1">仅需调整的关键代码片段 <a class="header-anchor" href="#仅需调整的关键代码片段" aria-label="Permalink to &quot;仅需调整的关键代码片段&quot;">​</a></h2><h3 id="_1-打开裁剪框前写入占位项" tabindex="-1">1) 打开裁剪框前写入占位项 <a class="header-anchor" href="#_1-打开裁剪框前写入占位项" aria-label="Permalink to &quot;1) 打开裁剪框前写入占位项&quot;">​</a></h3><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 复杂逻辑：写入 uploading 占位，UI/校验均能感知到“已选择”</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">_fileList.value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  ...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">_fileList.value.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">f</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> f.uid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> file.uid),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    uid: file.uid,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    name: file.name,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    status: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;uploading&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    percent: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    originFileObj: file,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    url: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    thumbUrl: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];</span></span></code></pre></div><h3 id="_2-确认裁剪成功后就地更新" tabindex="-1">2) 确认裁剪成功后就地更新 <a class="header-anchor" href="#_2-确认裁剪成功后就地更新" aria-label="Permalink to &quot;2) 确认裁剪成功后就地更新&quot;">​</a></h3><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 复杂逻辑：占位就地变更为成功</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">_fileList.value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _fileList.value.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">f</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  f.uid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> uid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">f, status: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;done&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, url, thumbUrl: url, percent: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> f</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nextTick</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onFieldChange</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span></code></pre></div><h3 id="_3-上传失败就地更新" tabindex="-1">3) 上传失败就地更新 <a class="header-anchor" href="#_3-上传失败就地更新" aria-label="Permalink to &quot;3) 上传失败就地更新&quot;">​</a></h3><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 复杂逻辑：占位就地变更为失败（供 submit 阶段拦截）</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">_fileList.value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _fileList.value.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">f</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  f.uid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> uid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">f, status: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;error&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, response: e.message } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> f</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nextTick</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onFieldChange</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span></code></pre></div><h3 id="_4-取消裁剪时移除占位并校验" tabindex="-1">4) 取消裁剪时移除占位并校验 <a class="header-anchor" href="#_4-取消裁剪时移除占位并校验" aria-label="Permalink to &quot;4) 取消裁剪时移除占位并校验&quot;">​</a></h3><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 复杂逻辑：取消裁剪=放弃本次选择，移除占位，触发必填校验</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">_fileList.value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _fileList.value.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">f</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> f.uid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> selectedFile.value?.uid</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">URL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">revokeObjectURL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(imageUrl.value);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">open.value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">selectedFile.value </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nextTick</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">onFieldChange</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">());</span></span></code></pre></div><h3 id="_5-modal-右上角关闭也走取消逻辑" tabindex="-1">5) Modal 右上角关闭也走取消逻辑 <a class="header-anchor" href="#_5-modal-右上角关闭也走取消逻辑" aria-label="Permalink to &quot;5) Modal 右上角关闭也走取消逻辑&quot;">​</a></h3><div class="language-vue vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">vue</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">&lt;!-- 复杂逻辑：任意关闭动作都归一到 cancel --&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">a-modal</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> v-model</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">open</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">open</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> @</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cancel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cancelCrop</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /&gt;</span></span></code></pre></div><hr><h2 id="文案与可用性建议" tabindex="-1">文案与可用性建议 <a class="header-anchor" href="#文案与可用性建议" aria-label="Permalink to &quot;文案与可用性建议&quot;">​</a></h2><ul><li><p><strong>取消</strong>不弹红色错误，最多给信息提示（如“已取消裁剪”）。</p></li><li><p><strong>失败</strong>要可读：来源（网络/格式/大小）+ 重试建议。</p></li><li><p><strong>体验细节</strong>：</p><ul><li>始终 <code>revokeObjectURL</code>，避免内存泄漏；</li><li>压缩失败可回退原图上传；</li><li>占位项上显示微进度/Loading，让用户感知状态。</li></ul></li></ul><hr><h2 id="适配多文件-并发" tabindex="-1">适配多文件/并发 <a class="header-anchor" href="#适配多文件-并发" aria-label="Permalink to &quot;适配多文件/并发&quot;">​</a></h2><ul><li>多文件独立 <code>uid</code> 管理，占位与就地更新一一对应；</li><li>压缩/上传并发时，仍以 <code>uid</code> 精确更新，不互相污染；</li><li>可加“清除失败项”入口（移除所有 <code>status:&#39;error&#39;</code> 的项）。</li></ul><hr><h2 id="快速检查清单-checklist" tabindex="-1">快速检查清单（Checklist） <a class="header-anchor" href="#快速检查清单-checklist" aria-label="Permalink to &quot;快速检查清单（Checklist）&quot;">​</a></h2><ul><li>[ ] 选择后立刻写入 <code>uploading</code> 占位</li><li>[ ] 确认/失败 <strong>就地更新</strong>，不新建条目</li><li>[ ] 取消 <strong>移除占位</strong>，并 <code>onFieldChange()</code></li><li>[ ] <code>change=warningOnly</code>，<code>submit=error</code></li><li>[ ] <code>validateFirst=true</code></li><li>[ ] <code>revokeObjectURL</code> 在 <code>finally/取消</code> 中调用</li></ul><hr><h2 id="小结" tabindex="-1">小结 <a class="header-anchor" href="#小结" aria-label="Permalink to &quot;小结&quot;">​</a></h2><p>这套方案把<strong>取消</strong>与<strong>失败</strong>严格区分，既避免“误报失败”，又能在<strong>提交时</strong>可靠拦截未完成/未满足的情况；配合占位项与表单钩子，整体体验顺滑、实现简单、可维护性高。</p>`,34)])])}const g=i(t,[["render",h]]);export{o as __pageData,g as default};
