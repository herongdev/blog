import{_ as i,c as a,o as n,ag as e}from"./chunks/framework.oqSrIbQK.js";const c=JSON.parse('{"title":"TLS 证书校验与 SAN 配置实战指南","description":"","frontmatter":{"title":"TLS 证书校验与 SAN 配置实战指南","date":"2025-09-23T00:00:00.000Z","tags":"\\\\[Hexo, TLS, HTTPS, WebSocket, SAN, 证书配置]"},"headers":[],"relativePath":"posts/需求实现/socket/TLS 证书校验与 SAN 配置实战指南.md","filePath":"posts/需求实现/socket/TLS 证书校验与 SAN 配置实战指南.md","lastUpdated":1758634537000}'),l={name:"posts/需求实现/socket/TLS 证书校验与 SAN 配置实战指南.md"};function t(h,s,p,k,r,o){return n(),a("div",null,[...s[0]||(s[0]=[e(`<h2 id="前言" tabindex="-1">前言 <a class="header-anchor" href="#前言" aria-label="Permalink to &quot;前言&quot;">​</a></h2><p>在配置 <code>https://</code> 或 <code>wss://</code> 服务时，最常见的坑就是 <strong>证书域名不匹配</strong>。 浏览器会严格校验证书里的 <strong>Subject Alternative Name (SAN)</strong> 字段，如果访问的域名不在里面，就会直接拒绝连接。 本文专门讲解 SAN 的作用、配置方式，以及实战中的几种证书选择。</p><hr><h2 id="证书校验规则" tabindex="-1">证书校验规则 <a class="header-anchor" href="#证书校验规则" aria-label="Permalink to &quot;证书校验规则&quot;">​</a></h2><h3 id="_1-域名校验" tabindex="-1">1. 域名校验 <a class="header-anchor" href="#_1-域名校验" aria-label="Permalink to &quot;1. 域名校验&quot;">​</a></h3><ul><li>浏览器验证访问的域名是否出现在证书的 <strong>SAN</strong> 列表中。</li><li>早期证书使用 <code>CN=commonName</code>，但现在必须依赖 <strong>SAN</strong>。</li></ul><h3 id="_2-常见报错" tabindex="-1">2. 常见报错 <a class="header-anchor" href="#_2-常见报错" aria-label="Permalink to &quot;2. 常见报错&quot;">​</a></h3><ul><li><code>NET::ERR_CERT_COMMON_NAME_INVALID</code> → 域名不在 SAN 中。</li><li><code>Hostname/IP does not match certificate&#39;s altnames</code> → 证书和访问的主机名不匹配。</li><li><code>NET::ERR_CERT_AUTHORITY_INVALID</code> → 证书不是受信任的 CA 签发。</li></ul><h3 id="_3-san-支持多域名" tabindex="-1">3. SAN 支持多域名 <a class="header-anchor" href="#_3-san-支持多域名" aria-label="Permalink to &quot;3. SAN 支持多域名&quot;">​</a></h3><ul><li><p>一个证书可以包含多个域名：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>DNS:example.com</span></span>
<span class="line"><span>DNS:www.example.com</span></span>
<span class="line"><span>DNS:api.example.com</span></span></code></pre></div></li><li><p>访问这些域名时，浏览器都会信任。</p></li></ul><hr><h2 id="证书类型对比" tabindex="-1">证书类型对比 <a class="header-anchor" href="#证书类型对比" aria-label="Permalink to &quot;证书类型对比&quot;">​</a></h2><h3 id="单域名证书" tabindex="-1">单域名证书 <a class="header-anchor" href="#单域名证书" aria-label="Permalink to &quot;单域名证书&quot;">​</a></h3><ul><li>只包含一个域名（如 <code>www.example.com</code>）。</li><li>访问 <code>api.example.com</code> 会报错。</li></ul><h3 id="多域名证书-san-证书" tabindex="-1">多域名证书（SAN 证书） <a class="header-anchor" href="#多域名证书-san-证书" aria-label="Permalink to &quot;多域名证书（SAN 证书）&quot;">​</a></h3><ul><li>支持多个完全不同的域名。</li><li>适合同一机构有多个子服务。</li></ul><h3 id="泛域名证书" tabindex="-1">泛域名证书 <a class="header-anchor" href="#泛域名证书" aria-label="Permalink to &quot;泛域名证书&quot;">​</a></h3><ul><li>格式：<code>*.example.com</code></li><li>可以匹配 <code>a.example.com</code>、<code>b.example.com</code>，但<strong>不包括二级子域名</strong>（例如 <code>a.b.example.com</code>）。</li></ul><hr><h2 id="openssl-查看-san" tabindex="-1">OpenSSL 查看 SAN <a class="header-anchor" href="#openssl-查看-san" aria-label="Permalink to &quot;OpenSSL 查看 SAN&quot;">​</a></h2><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> s_client</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -connect</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> example.com:443</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -servername</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> example.com</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/dev/null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> 2&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/dev/null</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> x509</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -noout</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -text</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -A1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Subject Alternative Name&quot;</span></span></code></pre></div><p>输出示例：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>X509v3 Subject Alternative Name:</span></span>
<span class="line"><span>    DNS:example.com, DNS:www.example.com, DNS:api.example.com</span></span></code></pre></div><hr><h2 id="实战-证书配置方法" tabindex="-1">实战：证书配置方法 <a class="header-anchor" href="#实战-证书配置方法" aria-label="Permalink to &quot;实战：证书配置方法&quot;">​</a></h2><h3 id="_1-使用-let-s-encrypt-推荐" tabindex="-1">1. 使用 Let’s Encrypt（推荐） <a class="header-anchor" href="#_1-使用-let-s-encrypt-推荐" aria-label="Permalink to &quot;1. 使用 Let’s Encrypt（推荐）&quot;">​</a></h3><p>借助 <strong>certbot</strong> 自动申请和续期：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sudo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> certbot</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> certonly</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --nginx</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> example.com</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> www.example.com</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> api.example.com</span></span></code></pre></div><ul><li>自动生成包含多个域名的 SAN 证书。</li><li>自动续期。</li></ul><h3 id="_2-自签证书-测试环境" tabindex="-1">2. 自签证书（测试环境） <a class="header-anchor" href="#_2-自签证书-测试环境" aria-label="Permalink to &quot;2. 自签证书（测试环境）&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> req</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -new</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -newkey</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rsa:2048</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -nodes</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -keyout</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test.key</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -out</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test.csr</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -subj</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;/CN=test.local&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 在 openssl.cnf 中手动添加 SAN</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[req]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">distinguished_name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> req_distinguished_name</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">req_extensions</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> v3_req</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">prompt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> no</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[req_distinguished_name]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">CN</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test.local</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[v3_req]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">subjectAltName</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> @alt_names</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[alt_names]</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">DNS.1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test.local</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">DNS.2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> localhost</span></span></code></pre></div><p>然后签发：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">openssl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> x509</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -req</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -in</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test.csr</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -signkey</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test.key</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -out</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test.crt</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -days</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 365</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -extensions</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> v3_req</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -extfile</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> openssl.cnf</span></span></code></pre></div><hr><h2 id="nginx-中的证书配置" tabindex="-1">Nginx 中的证书配置 <a class="header-anchor" href="#nginx-中的证书配置" aria-label="Permalink to &quot;Nginx 中的证书配置&quot;">​</a></h2><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  listen </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">443</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ssl http2;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  server_name </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">example.com www.example.com api.example.com;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  ssl_certificate </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    /etc/nginx/ssl/example.com/fullchain.pem;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  ssl_certificate_key </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/etc/nginx/ssl/example.com/privkey.pem;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  location</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> / </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    proxy_pass </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">http://127.0.0.1:8080;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li><code>server_name</code> 可以列出多个域名。</li><li>证书必须覆盖这些域名，否则会校验失败。</li></ul><hr><h2 id="常见坑与解决方案" tabindex="-1">常见坑与解决方案 <a class="header-anchor" href="#常见坑与解决方案" aria-label="Permalink to &quot;常见坑与解决方案&quot;">​</a></h2><ol><li><p><strong>证书只签了一个域名</strong> → 访问二级域名时报错，需要申请 SAN 或泛域名证书。</p></li><li><p><strong>使用 CDN（如 Cloudflare）</strong></p><ul><li>CDN 前端证书正常，但 <strong>源站证书</strong> 也必须正确，否则 “Full SSL” 模式会报错。</li></ul></li><li><p><strong>测试环境本地域名</strong></p><ul><li>使用 <code>mkcert</code> 或自签证书，加上 <code>localhost</code>、<code>127.0.0.1</code> 到 SAN。</li></ul></li><li><p><strong>多项目共用一台服务器</strong></p><ul><li>使用 SNI（Server Name Indication），不同域名返回不同证书。</li></ul></li></ol><hr><h2 id="工具推荐" tabindex="-1">工具推荐 <a class="header-anchor" href="#工具推荐" aria-label="Permalink to &quot;工具推荐&quot;">​</a></h2><ul><li><strong>openssl</strong>：查看证书链与 SAN。</li><li><strong>mkcert</strong>：本地快速签发受信任证书。</li><li><strong>ssllabs.com</strong>：在线检测证书配置与兼容性。</li><li><strong>certbot</strong>：自动申请/续期 Let’s Encrypt 证书。</li></ul><hr><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h2><ul><li><strong>SAN 是现代证书的核心</strong>，必须包含访问的所有域名。</li><li>本地测试推荐 <strong>mkcert</strong>，线上推荐 <strong>Let’s Encrypt</strong>。</li><li>Nginx/Apache/CDN 配置时要确保证书和 <code>server_name</code> 对齐。</li><li>遇到 <code>Hostname/IP does not match certificate&#39;s altnames</code>，第一步就是 <code>openssl s_client</code> 看证书里的 SAN。</li></ul><hr><p>要不要我再写一篇 <strong>“多环境开发下证书最佳实践（本地/测试/生产统一方案）”</strong>，结合 mkcert + Let’s Encrypt + CI/CD 自动化续期？</p>`,48)])])}const F=i(l,[["render",t]]);export{c as __pageData,F as default};
