import{_ as i,c as a,o as n,ag as l}from"./chunks/framework.oqSrIbQK.js";const o=JSON.parse('{"title":"NestJS + TypeORM + Docker 迁移（Part 2）— ENTRYPOINT、CRLF 与 env/健康检查","description":"统一入口脚本到镜像、修复 CRLF、正确注入 env 与健康检查，保证容器自启动迁移。","frontmatter":{"title":"NestJS + TypeORM + Docker 迁移（Part 2）— ENTRYPOINT、CRLF 与 env/健康检查","date":"2025-11-17T00:00:00.000Z","tags":["Docker","NestJS","TypeORM","MySQL"],"categories":["后端"],"description":"统一入口脚本到镜像、修复 CRLF、正确注入 env 与健康检查，保证容器自启动迁移。"},"headers":[],"relativePath":"posts/后端/NestJS/NestJS-TypeORM-Docker-迁移-Part2-ENTRYPOINT-CRLF-与-env-健康检查.md","filePath":"posts/后端/NestJS/NestJS-TypeORM-Docker-迁移-Part2-ENTRYPOINT-CRLF-与-env-健康检查.md","lastUpdated":1764331727000}'),e={name:"posts/后端/NestJS/NestJS-TypeORM-Docker-迁移-Part2-ENTRYPOINT-CRLF-与-env-健康检查.md"};function t(p,s,h,k,E,r){return n(),a("div",null,[...s[0]||(s[0]=[l(`<h2 id="症状与根因" tabindex="-1">症状与根因 <a class="header-anchor" href="#症状与根因" aria-label="Permalink to &quot;症状与根因&quot;">​</a></h2><ul><li>exec /docker-entrypoint.sh: no such file or directory、set: illegal option - <ul><li>根因：Windows CRLF 行尾 + 直接 exec 导致脚本解析异常。</li></ul></li><li>容器重启后仍未迁移 <ul><li>根因 1：后端容器未拿到 DB 密码（DB_PASS 未注入），探活循环一直失败。</li><li>根因 2：<code>docker-compose.dev.yaml</code> 的 healthcheck 在宿主侧使用了 <code>\${DB_PASS}</code>，未读取 <code>.env.dev</code>，同时产生干扰警告。</li></ul></li></ul><hr><h2 id="固定模板-可直接复用" tabindex="-1">固定模板（可直接复用） <a class="header-anchor" href="#固定模板-可直接复用" aria-label="Permalink to &quot;固定模板（可直接复用）&quot;">​</a></h2><ul><li>Dockerfile.dev（镜像内 ENTRYPOINT，统一 CRLF）</li></ul><div class="language-dockerfile vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">dockerfile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">WORKDIR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /workspace</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">COPY</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ./entrypoint.sh /docker-entrypoint.sh</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">RUN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sed -i </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;s/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\r</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$//&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /docker-entrypoint.sh &amp;&amp; chmod +x /docker-entrypoint.sh</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">ENTRYPOINT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sh&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;/docker-entrypoint.sh&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">CMD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;npm&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;run&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;start:dev&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></div><ul><li>docker-compose.dev.yaml（env 注入与健康检查）</li></ul><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">services</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  db</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    env_file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.env.dev</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    healthcheck</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          &quot;CMD&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          &quot;mysqladmin&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          &quot;ping&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          &quot;-h&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          &quot;localhost&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          &quot;-u&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          &quot;root&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">          &quot;-p\${MYSQL_ROOT_PASSWORD}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  backend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    env_file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.env.dev</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # ENTRYPOINT/CMD 由镜像控制（Dockerfile）</span></span></code></pre></div><ul><li>.env.dev（提供两套变量且一致）</li></ul><div class="language-ini vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 应用连接（Nest）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DB_HOST</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=localhost</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DB_PORT</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=3306</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DB_USER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=root</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DB_PASS</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=secret</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">DB_NAME</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=app</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># DB 容器初始化/healthcheck</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">MYSQL_ROOT_PASSWORD</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=secret</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">MYSQL_DATABASE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=app</span></span></code></pre></div><hr><h2 id="要点" tabindex="-1">要点 <a class="header-anchor" href="#要点" aria-label="Permalink to &quot;要点&quot;">​</a></h2><ul><li>入口脚本放进镜像（不要用 Compose 覆盖），避免跨平台行尾/解释器差异。</li><li>复制脚本后统一行尾：<code>sed -i &#39;s/\\r$//&#39; /docker-entrypoint.sh</code>。</li><li>Compose 健康检查尽量使用 DB 容器可用变量（如 <code>MYSQL_ROOT_PASSWORD</code>），避免宿主解析失败。</li><li>所有应用侧必需的 <code>DB_*</code> 变量通过 <code>env_file</code> 注入后端容器。</li></ul>`,13)])])}const c=i(e,[["render",t]]);export{o as __pageData,c as default};
